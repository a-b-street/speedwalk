function u5(n,e){for(var t=0;t<e.length;t++){const i=e[t];if(typeof i!="string"&&!Array.isArray(i)){for(const r in i)if(r!=="default"&&!(r in n)){const o=Object.getOwnPropertyDescriptor(i,r);o&&Object.defineProperty(n,r,o.get?o:{enumerable:!0,get:()=>i[r]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const AM=!1;var F2=Array.isArray,h5=Array.prototype.indexOf,qw=Array.from,Dk=Object.defineProperty,Sg=Object.getOwnPropertyDescriptor,Fk=Object.getOwnPropertyDescriptors,d5=Object.prototype,f5=Array.prototype,O2=Object.getPrototypeOf,kP=Object.isExtensible;const is=()=>{};function p5(n){return n()}function PM(n){for(var e=0;e<n.length;e++)n[e]()}function Ok(){var n,e,t=new Promise((i,r)=>{n=i,e=r});return{promise:t,resolve:n,reject:e}}function xc(n,e){if(Array.isArray(n))return n;if(!(Symbol.iterator in n))return Array.from(n);const t=[];for(const i of n)if(t.push(i),t.length===e)break;return t}const bo=2,z2=4,Ww=8,m5=1<<24,Lh=16,kh=32,xp=64,Hw=128,Ec=512,ko=1024,Sa=2048,mu=4096,ol=8192,gh=16384,B2=32768,dp=65536,DP=1<<17,N2=1<<18,i_=1<<19,zk=1<<20,ph=1<<25,fp=32768,IM=1<<21,$2=1<<22,Ad=1<<23,_h=Symbol("$state"),g5=Symbol("legacy props"),_5=Symbol(""),_g=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"};function V2(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function v5(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function y5(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function b5(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function x5(n){throw new Error("https://svelte.dev/e/effect_orphan")}function w5(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function S5(n){throw new Error("https://svelte.dev/e/props_invalid_value")}function T5(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function M5(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function C5(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function E5(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const A5=1,P5=2,Bk=4,I5=8,R5=16,L5=1,k5=2,D5=4,F5=8,O5=16,z5=1,B5=2,Ro=Symbol(),N5="http://www.w3.org/1999/xhtml";function $5(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function V5(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function Nk(n){return n===this.v}function $k(n,e){return n!=n?e==e:n!==e||n!==null&&typeof n=="object"||typeof n=="function"}function Vk(n){return!$k(n,this.v)}let n_=!1,U5=!1;function j5(){n_=!0}let Ur=null;function Dg(n){Ur=n}function r_(n){return Uk().get(n)}function s_(n,e){return Uk().set(n,e),e}function en(n,e=!1,t){Ur={p:Ur,i:!1,c:null,e:null,s:n,x:null,l:n_&&!e?{s:null,u:null,$:[]}:null}}function tn(n){var e=Ur,t=e.e;if(t!==null){e.e=null;for(var i of t)sD(i)}return n!==void 0&&(e.x=n),e.i=!0,Ur=e.p,n??{}}function o_(){return!n_||Ur!==null&&Ur.l===null}function Uk(n){return Ur===null&&V2(),Ur.c??=new Map(G5(Ur)||void 0)}function G5(n){let e=n.p;for(;e!==null;){const t=e.c;if(t!==null)return t;e=e.p}return null}let Jf=[];function jk(){var n=Jf;Jf=[],PM(n)}function Od(n){if(Jf.length===0&&!ry){var e=Jf;queueMicrotask(()=>{e===Jf&&jk()})}Jf.push(n)}function q5(){for(;Jf.length>0;)jk()}function Gk(n){var e=nr;if(e===null)return Fn.f|=Ad,n;if((e.f&B2)===0){if((e.f&Hw)===0)throw n;e.b.error(n)}else Fg(n,e)}function Fg(n,e){for(;e!==null;){if((e.f&Hw)!==0)try{e.b.error(n);return}catch(t){n=t}e=e.parent}throw n}const Mb=new Set;let $n=null,ny=null,zl=null,Dl=[],Zw=null,RM=!1,ry=!1;class au{committed=!1;current=new Map;previous=new Map;#t=new Set;#e=new Set;#i=0;#n=0;#s=null;#r=new Set;#o=new Set;skipped_effects=new Set;is_fork=!1;is_deferred(){return this.is_fork||this.#n>0}process(e){Dl=[],ny=null,this.apply();var t={parent:null,effect:null,effects:[],render_effects:[]};for(const i of e)this.#a(i,t);this.is_fork||this.#u(),this.is_deferred()?(this.#l(t.effects),this.#l(t.render_effects)):(ny=this,$n=null,FP(t.render_effects),FP(t.effects),ny=null,this.#s?.resolve()),zl=null}#a(e,t){e.f^=ko;for(var i=e.first;i!==null;){var r=i.f,o=(r&(kh|xp))!==0,c=o&&(r&ko)!==0,s=c||(r&ol)!==0||this.skipped_effects.has(i);if((i.f&Hw)!==0&&i.b?.is_pending()&&(t={parent:t,effect:i,effects:[],render_effects:[]}),!s&&i.fn!==null){o?i.f^=ko:(r&z2)!==0?t.effects.push(i):o0(i)&&((i.f&Lh)!==0&&this.#r.add(i),My(i));var d=i.first;if(d!==null){i=d;continue}}var p=i.parent;for(i=i.next;i===null&&p!==null;)p===t.effect&&(this.#l(t.effects),this.#l(t.render_effects),t=t.parent),i=p.next,p=p.parent}}#l(e){for(const t of e)(t.f&Sa)!==0?this.#r.add(t):(t.f&mu)!==0&&this.#o.add(t),this.#c(t.deps),Oo(t,ko)}#c(e){if(e!==null)for(const t of e)(t.f&bo)===0||(t.f&fp)===0||(t.f^=fp,this.#c(t.deps))}capture(e,t){this.previous.has(e)||this.previous.set(e,t),(e.f&Ad)===0&&(this.current.set(e,e.v),zl?.set(e,e.v))}activate(){$n=this,this.apply()}deactivate(){$n===this&&($n=null,zl=null)}flush(){if(this.activate(),Dl.length>0){if(qk(),$n!==null&&$n!==this)return}else this.#i===0&&this.process([]);this.deactivate()}discard(){for(const e of this.#e)e(this);this.#e.clear()}#u(){if(this.#n===0){for(const e of this.#t)e();this.#t.clear()}this.#i===0&&this.#h()}#h(){if(Mb.size>1){this.previous.clear();var e=zl,t=!0,i={parent:null,effect:null,effects:[],render_effects:[]};for(const o of Mb){if(o===this){t=!1;continue}const c=[];for(const[d,p]of this.current){if(o.current.has(d))if(t&&p!==o.current.get(d))o.current.set(d,p);else continue;c.push(d)}if(c.length===0)continue;const s=[...o.current.keys()].filter(d=>!this.current.has(d));if(s.length>0){var r=Dl;Dl=[];const d=new Set,p=new Map;for(const g of c)Wk(g,s,d,p);if(Dl.length>0){$n=o,o.apply();for(const g of Dl)o.#a(g,i);o.deactivate()}Dl=r}}$n=null,zl=e}this.committed=!0,Mb.delete(this)}increment(e){this.#i+=1,e&&(this.#n+=1)}decrement(e){this.#i-=1,e&&(this.#n-=1),this.revive()}revive(){for(const e of this.#r)this.#o.delete(e),Oo(e,Sa),pp(e);for(const e of this.#o)Oo(e,mu),pp(e);this.flush()}oncommit(e){this.#t.add(e)}ondiscard(e){this.#e.add(e)}settled(){return(this.#s??=Ok()).promise}static ensure(){if($n===null){const e=$n=new au;Mb.add($n),ry||au.enqueue(()=>{$n===e&&e.flush()})}return $n}static enqueue(e){Od(e)}apply(){}}function W5(n){var e=ry;ry=!0;try{for(var t;;){if(q5(),Dl.length===0&&($n?.flush(),Dl.length===0))return Zw=null,t;qk()}}finally{ry=e}}function qk(){var n=np;RM=!0;var e=null;try{var t=0;for(nw(!0);Dl.length>0;){var i=au.ensure();if(t++>1e3){var r,o;H5()}i.process(Dl),Pd.clear()}}finally{RM=!1,nw(n),Zw=null}}function H5(){try{w5()}catch(n){Fg(n,Zw)}}let hh=null;function FP(n){var e=n.length;if(e!==0){for(var t=0;t<e;){var i=n[t++];if((i.f&(gh|ol))===0&&o0(i)&&(hh=new Set,My(i),i.deps===null&&i.first===null&&i.nodes===null&&(i.teardown===null&&i.ac===null?lD(i):i.fn=null),hh?.size>0)){Pd.clear();for(const r of hh){if((r.f&(gh|ol))!==0)continue;const o=[r];let c=r.parent;for(;c!==null;)hh.has(c)&&(hh.delete(c),o.push(c)),c=c.parent;for(let s=o.length-1;s>=0;s--){const d=o[s];(d.f&(gh|ol))===0&&My(d)}}hh.clear()}}hh=null}}function Wk(n,e,t,i){if(!t.has(n)&&(t.add(n),n.reactions!==null))for(const r of n.reactions){const o=r.f;(o&bo)!==0?Wk(r,e,t,i):(o&($2|Lh))!==0&&(o&Sa)===0&&Hk(r,e,i)&&(Oo(r,Sa),pp(r))}}function Hk(n,e,t){const i=t.get(n);if(i!==void 0)return i;if(n.deps!==null)for(const r of n.deps){if(e.includes(r))return!0;if((r.f&bo)!==0&&Hk(r,e,t))return t.set(r,!0),!0}return t.set(n,!1),!1}function pp(n){for(var e=Zw=n;e.parent!==null;){e=e.parent;var t=e.f;if(RM&&e===nr&&(t&Lh)!==0&&(t&N2)===0)return;if((t&(xp|kh))!==0){if((t&ko)===0)return;e.f^=ko}}Dl.push(e)}function Z5(n){let e=0,t=Sh(0),i;return()=>{Sy()&&(ee(t),s0(()=>(e===0&&(i=bs(()=>n(()=>el(t)))),e+=1,()=>{Od(()=>{e-=1,e===0&&(i?.(),i=void 0,el(t))})})))}}var X5=dp|i_|Hw;function Y5(n,e,t){new K5(n,e,t)}class K5{parent;#t=!1;#e;#i=null;#n;#s;#r;#o=null;#a=null;#l=null;#c=null;#u=null;#h=0;#d=0;#p=!1;#f=null;#y=Z5(()=>(this.#f=Sh(this.#h),()=>{this.#f=null}));constructor(e,t,i){this.#e=e,this.#n=t,this.#s=i,this.parent=nr.b,this.#t=!!this.#n.pending,this.#r=a_(()=>{nr.b=this;{var r=this.#_();try{this.#o=Fl(()=>i(r))}catch(o){this.error(o)}this.#d>0?this.#g():this.#t=!1}return()=>{this.#u?.remove()}},X5)}#b(){try{this.#o=Fl(()=>this.#s(this.#e))}catch(e){this.error(e)}this.#t=!1}#x(){const e=this.#n.pending;e&&(this.#a=Fl(()=>e(this.#e)),au.enqueue(()=>{var t=this.#_();this.#o=this.#m(()=>(au.ensure(),Fl(()=>this.#s(t)))),this.#d>0?this.#g():(ip(this.#a,()=>{this.#a=null}),this.#t=!1)}))}#_(){var e=this.#e;return this.#t&&(this.#u=du(),this.#e.before(this.#u),e=this.#u),e}is_pending(){return this.#t||!!this.parent&&this.parent.is_pending()}has_pending_snippet(){return!!this.#n.pending}#m(e){var t=nr,i=Fn,r=Ur;gu(this.#r),xa(this.#r),Dg(this.#r.ctx);try{return e()}catch(o){return Gk(o),null}finally{gu(t),xa(i),Dg(r)}}#g(){const e=this.#n.pending;this.#o!==null&&(this.#c=document.createDocumentFragment(),this.#c.append(this.#u),hD(this.#o,this.#c)),this.#a===null&&(this.#a=Fl(()=>e(this.#e)))}#v(e){if(!this.has_pending_snippet()){this.parent&&this.parent.#v(e);return}this.#d+=e,this.#d===0&&(this.#t=!1,this.#a&&ip(this.#a,()=>{this.#a=null}),this.#c&&(this.#e.before(this.#c),this.#c=null))}update_pending_count(e){this.#v(e),this.#h+=e,this.#f&&Og(this.#f,this.#h)}get_effect_pending(){return this.#y(),ee(this.#f)}error(e){var t=this.#n.onerror;let i=this.#n.failed;if(this.#p||!t&&!i)throw e;this.#o&&(wa(this.#o),this.#o=null),this.#a&&(wa(this.#a),this.#a=null),this.#l&&(wa(this.#l),this.#l=null);var r=!1,o=!1;const c=()=>{if(r){V5();return}r=!0,o&&E5(),au.ensure(),this.#h=0,this.#l!==null&&ip(this.#l,()=>{this.#l=null}),this.#t=this.has_pending_snippet(),this.#o=this.#m(()=>(this.#p=!1,Fl(()=>this.#s(this.#e)))),this.#d>0?this.#g():this.#t=!1};var s=Fn;try{xa(null),o=!0,t?.(e,c),o=!1}catch(d){Fg(d,this.#r&&this.#r.parent)}finally{xa(s)}i&&Od(()=>{this.#l=this.#m(()=>{au.ensure(),this.#p=!0;try{return Fl(()=>{i(this.#e,()=>e,()=>c)})}catch(d){return Fg(d,this.#r.parent),null}finally{this.#p=!1}})})}}function J5(n,e,t,i){const r=o_()?i0:U2;if(t.length===0&&n.length===0){i(e.map(r));return}var o=$n,c=nr,s=Q5();function d(){Promise.all(t.map(p=>e6(p))).then(p=>{s();try{i([...e.map(r),...p])}catch(g){(c.f&gh)===0&&Fg(g,c)}o?.deactivate(),tw()}).catch(p=>{Fg(p,c)})}n.length>0?Promise.all(n).then(()=>{s();try{return d()}finally{o?.deactivate(),tw()}}):d()}function Q5(){var n=nr,e=Fn,t=Ur,i=$n;return function(o=!0){gu(n),xa(e),Dg(t),o&&i?.activate()}}function tw(){gu(null),xa(null),Dg(null)}function i0(n){var e=bo|Sa,t=Fn!==null&&(Fn.f&bo)!==0?Fn:null;return nr!==null&&(nr.f|=i_),{ctx:Ur,deps:null,effects:null,equals:Nk,f:e,fn:n,reactions:null,rv:0,v:Ro,wv:0,parent:t??nr,ac:null}}function e6(n,e){let t=nr;t===null&&v5();var i=t.b,r=void 0,o=Sh(Ro),c=!Fn,s=new Map;return l6(()=>{var d=Ok();r=d.promise;try{Promise.resolve(n()).then(d.resolve,d.reject).then(()=>{p===$n&&p.committed&&p.deactivate(),tw()})}catch(x){d.reject(x),tw()}var p=$n;if(c){var g=!i.is_pending();i.update_pending_count(1),p.increment(g),s.get(p)?.reject(_g),s.delete(p),s.set(p,d)}const _=(x,b=void 0)=>{if(p.activate(),b)b!==_g&&(o.f|=Ad,Og(o,b));else{(o.f&Ad)!==0&&(o.f^=Ad),Og(o,x);for(const[S,P]of s){if(s.delete(S),S===p)break;P.reject(_g)}}c&&(i.update_pending_count(-1),p.decrement(g))};d.promise.then(_,x=>_(null,x||"unknown"))}),r0(()=>{for(const d of s.values())d.reject(_g)}),new Promise(d=>{function p(g){function _(){g===r?d(o):p(r)}g.then(_,_)}p(r)})}function Kt(n){const e=i0(n);return dD(e),e}function U2(n){const e=i0(n);return e.equals=Vk,e}function Zk(n){var e=n.effects;if(e!==null){n.effects=null;for(var t=0;t<e.length;t+=1)wa(e[t])}}function t6(n){for(var e=n.parent;e!==null;){if((e.f&bo)===0)return(e.f&gh)===0?e:null;e=e.parent}return null}function j2(n){var e,t=nr;gu(t6(n));try{n.f&=~fp,Zk(n),e=gD(n)}finally{gu(t)}return e}function Xk(n){var e=j2(n);if(n.equals(e)||($n?.is_fork||(n.v=e),n.wv=pD()),!wp)if(zl!==null)(Sy()||$n?.is_fork)&&zl.set(n,e);else{var t=(n.f&Ec)===0?mu:ko;Oo(n,t)}}let LM=new Set;const Pd=new Map;let Yk=!1;function Sh(n,e){var t={f:0,v:n,reactions:null,equals:Nk,rv:0,wv:0};return t}function ii(n,e){const t=Sh(n);return dD(t),t}function Kk(n,e=!1,t=!0){const i=Sh(n);return e||(i.equals=Vk),n_&&t&&Ur!==null&&Ur.l!==null&&(Ur.l.s??=[]).push(i),i}function Et(n,e,t=!1){Fn!==null&&(!lu||(Fn.f&DP)!==0)&&o_()&&(Fn.f&(bo|Lh|$2|DP))!==0&&!vh?.includes(n)&&C5();let i=t?xs(e):e;return Og(n,i)}function Og(n,e){if(!n.equals(e)){var t=n.v;wp?Pd.set(n,e):Pd.set(n,t),n.v=e;var i=au.ensure();i.capture(n,t),(n.f&bo)!==0&&((n.f&Sa)!==0&&j2(n),Oo(n,(n.f&Ec)!==0?ko:mu)),n.wv=pD(),Jk(n,Sa),o_()&&nr!==null&&(nr.f&ko)!==0&&(nr.f&(kh|xp))===0&&(kl===null?h6([n]):kl.push(n)),!i.is_fork&&LM.size>0&&!Yk&&i6()}return e}function i6(){Yk=!1;var n=np;nw(!0);const e=Array.from(LM);try{for(const t of e)(t.f&ko)!==0&&Oo(t,mu),o0(t)&&My(t)}finally{nw(n)}LM.clear()}function el(n){Et(n,n.v+1)}function Jk(n,e){var t=n.reactions;if(t!==null)for(var i=o_(),r=t.length,o=0;o<r;o++){var c=t[o],s=c.f;if(!(!i&&c===nr)){var d=(s&Sa)===0;if(d&&Oo(c,e),(s&bo)!==0){var p=c;zl?.delete(p),(s&fp)===0&&(s&Ec&&(c.f|=fp),Jk(p,mu))}else d&&((s&Lh)!==0&&hh!==null&&hh.add(c),pp(c))}}}function xs(n){if(typeof n!="object"||n===null||_h in n)return n;const e=O2(n);if(e!==d5&&e!==f5)return n;var t=new Map,i=F2(n),r=ii(0),o=wc,c=s=>{if(wc===o)return s();var d=Fn,p=wc;xa(null),NP(o);var g=s();return xa(d),NP(p),g};return i&&t.set("length",ii(n.length)),new Proxy(n,{defineProperty(s,d,p){(!("value"in p)||p.configurable===!1||p.enumerable===!1||p.writable===!1)&&T5();var g=t.get(d);return g===void 0?g=c(()=>{var _=ii(p.value);return t.set(d,_),_}):Et(g,p.value,!0),!0},deleteProperty(s,d){var p=t.get(d);if(p===void 0){if(d in s){const g=c(()=>ii(Ro));t.set(d,g),el(r)}}else Et(p,Ro),el(r);return!0},get(s,d,p){if(d===_h)return n;var g=t.get(d),_=d in s;if(g===void 0&&(!_||Sg(s,d)?.writable)&&(g=c(()=>{var b=xs(_?s[d]:Ro),S=ii(b);return S}),t.set(d,g)),g!==void 0){var x=ee(g);return x===Ro?void 0:x}return Reflect.get(s,d,p)},getOwnPropertyDescriptor(s,d){var p=Reflect.getOwnPropertyDescriptor(s,d);if(p&&"value"in p){var g=t.get(d);g&&(p.value=ee(g))}else if(p===void 0){var _=t.get(d),x=_?.v;if(_!==void 0&&x!==Ro)return{enumerable:!0,configurable:!0,value:x,writable:!0}}return p},has(s,d){if(d===_h)return!0;var p=t.get(d),g=p!==void 0&&p.v!==Ro||Reflect.has(s,d);if(p!==void 0||nr!==null&&(!g||Sg(s,d)?.writable)){p===void 0&&(p=c(()=>{var x=g?xs(s[d]):Ro,b=ii(x);return b}),t.set(d,p));var _=ee(p);if(_===Ro)return!1}return g},set(s,d,p,g){var _=t.get(d),x=d in s;if(i&&d==="length")for(var b=p;b<_.v;b+=1){var S=t.get(b+"");S!==void 0?Et(S,Ro):b in s&&(S=c(()=>ii(Ro)),t.set(b+"",S))}if(_===void 0)(!x||Sg(s,d)?.writable)&&(_=c(()=>ii(void 0)),Et(_,xs(p)),t.set(d,_));else{x=_.v!==Ro;var P=c(()=>xs(p));Et(_,P)}var L=Reflect.getOwnPropertyDescriptor(s,d);if(L?.set&&L.set.call(g,p),!x){if(i&&typeof d=="string"){var E=t.get("length"),C=Number(d);Number.isInteger(C)&&C>=E.v&&Et(E,C+1)}el(r)}return!0},ownKeys(s){ee(r);var d=Reflect.ownKeys(s).filter(_=>{var x=t.get(_);return x===void 0||x.v!==Ro});for(var[p,g]of t)g.v!==Ro&&!(p in s)&&d.push(p);return d},setPrototypeOf(){M5()}})}function OP(n){try{if(n!==null&&typeof n=="object"&&_h in n)return n[_h]}catch{}return n}function Qk(n,e){return Object.is(OP(n),OP(e))}var wy,eD,tD,iD;function n6(){if(wy===void 0){wy=window,eD=/Firefox/.test(navigator.userAgent);var n=Element.prototype,e=Node.prototype,t=Text.prototype;tD=Sg(e,"firstChild").get,iD=Sg(e,"nextSibling").get,kP(n)&&(n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__style=void 0,n.__e=void 0),kP(t)&&(t.__t=void 0)}}function du(n=""){return document.createTextNode(n)}function iw(n){return tD.call(n)}function n0(n){return iD.call(n)}function Ft(n,e){return iw(n)}function ci(n,e=!1){{var t=iw(n);return t instanceof Comment&&t.data===""?n0(t):t}}function gt(n,e=1,t=!1){let i=n;for(;e--;)i=n0(i);return i}function r6(n){n.textContent=""}function nD(){return!1}let zP=!1;function s6(){zP||(zP=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{if(!n.defaultPrevented)for(const e of n.target.elements)e.__on_r?.()})},{capture:!0}))}function Xw(n){var e=Fn,t=nr;xa(null),gu(null);try{return n()}finally{xa(e),gu(t)}}function Yw(n,e,t,i=t){n.addEventListener(e,()=>Xw(t));const r=n.__on_r;r?n.__on_r=()=>{r(),i(!0)}:n.__on_r=()=>i(!0),s6()}function rD(n){nr===null&&(Fn===null&&x5(),b5()),wp&&y5()}function o6(n,e){var t=e.last;t===null?e.last=e.first=n:(t.next=n,n.prev=t,e.last=n)}function xu(n,e,t){var i=nr;i!==null&&(i.f&ol)!==0&&(n|=ol);var r={ctx:Ur,deps:null,nodes:null,f:n|Sa|Ec,first:null,fn:e,last:null,next:null,parent:i,b:i&&i.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{My(r),r.f|=B2}catch(s){throw wa(r),s}else e!==null&&pp(r);var o=r;if(t&&o.deps===null&&o.teardown===null&&o.nodes===null&&o.first===o.last&&(o.f&i_)===0&&(o=o.first,(n&Lh)!==0&&(n&dp)!==0&&o!==null&&(o.f|=dp)),o!==null&&(o.parent=i,i!==null&&o6(o,i),Fn!==null&&(Fn.f&bo)!==0&&(n&xp)===0)){var c=Fn;(c.effects??=[]).push(o)}return r}function Sy(){return Fn!==null&&!lu}function r0(n){const e=xu(Ww,null,!1);return Oo(e,ko),e.teardown=n,e}function cn(n){rD();var e=nr.f,t=!Fn&&(e&kh)!==0&&(e&B2)===0;if(t){var i=Ur;(i.e??=[]).push(n)}else return sD(n)}function sD(n){return xu(z2|zk,n,!1)}function G2(n){return rD(),xu(Ww|zk,n,!0)}function a6(n){au.ensure();const e=xu(xp|i_,n,!0);return(t={})=>new Promise(i=>{t.outro?ip(e,()=>{wa(e),i(void 0)}):(wa(e),i(void 0))})}function q2(n){return xu(z2,n,!1)}function l6(n){return xu($2|i_,n,!0)}function s0(n,e=0){return xu(Ww|e,n,!0)}function Zi(n,e=[],t=[],i=[]){J5(i,e,t,r=>{xu(Ww,()=>n(...r.map(ee)),!0)})}function a_(n,e=0){var t=xu(Lh|e,n,!0);return t}function Fl(n){return xu(kh|i_,n,!0)}function oD(n){var e=n.teardown;if(e!==null){const t=wp,i=Fn;BP(!0),xa(null);try{e.call(null)}finally{BP(t),xa(i)}}}function aD(n,e=!1){var t=n.first;for(n.first=n.last=null;t!==null;){const r=t.ac;r!==null&&Xw(()=>{r.abort(_g)});var i=t.next;(t.f&xp)!==0?t.parent=null:wa(t,e),t=i}}function c6(n){for(var e=n.first;e!==null;){var t=e.next;(e.f&kh)===0&&wa(e),e=t}}function wa(n,e=!0){var t=!1;(e||(n.f&N2)!==0)&&n.nodes!==null&&n.nodes.end!==null&&(u6(n.nodes.start,n.nodes.end),t=!0),aD(n,e&&!t),rw(n,0),Oo(n,gh);var i=n.nodes&&n.nodes.t;if(i!==null)for(const o of i)o.stop();oD(n);var r=n.parent;r!==null&&r.first!==null&&lD(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes=n.ac=null}function u6(n,e){for(;n!==null;){var t=n===e?null:n0(n);n.remove(),n=t}}function lD(n){var e=n.parent,t=n.prev,i=n.next;t!==null&&(t.next=i),i!==null&&(i.prev=t),e!==null&&(e.first===n&&(e.first=i),e.last===n&&(e.last=t))}function ip(n,e,t=!0){var i=[];cD(n,i,!0);var r=()=>{t&&wa(n),e&&e()},o=i.length;if(o>0){var c=()=>--o||r();for(var s of i)s.out(c)}else r()}function cD(n,e,t){if((n.f&ol)===0){n.f^=ol;var i=n.nodes&&n.nodes.t;if(i!==null)for(const s of i)(s.is_global||t)&&e.push(s);for(var r=n.first;r!==null;){var o=r.next,c=(r.f&dp)!==0||(r.f&kh)!==0&&(n.f&Lh)!==0;cD(r,e,c?t:!1),r=o}}}function W2(n){uD(n,!0)}function uD(n,e){if((n.f&ol)!==0){n.f^=ol,(n.f&ko)===0&&(Oo(n,Sa),pp(n));for(var t=n.first;t!==null;){var i=t.next,r=(t.f&dp)!==0||(t.f&kh)!==0;uD(t,r?e:!1),t=i}var o=n.nodes&&n.nodes.t;if(o!==null)for(const c of o)(c.is_global||e)&&c.in()}}function hD(n,e){if(n.nodes)for(var t=n.nodes.start,i=n.nodes.end;t!==null;){var r=t===i?null:n0(t);e.append(t),t=r}}let np=!1;function nw(n){np=n}let wp=!1;function BP(n){wp=n}let Fn=null,lu=!1;function xa(n){Fn=n}let nr=null;function gu(n){nr=n}let vh=null;function dD(n){Fn!==null&&(vh===null?vh=[n]:vh.push(n))}let Qo=null,Ya=0,kl=null;function h6(n){kl=n}let fD=1,Ty=0,wc=Ty;function NP(n){wc=n}function pD(){return++fD}function o0(n){var e=n.f;if((e&Sa)!==0)return!0;if(e&bo&&(n.f&=~fp),(e&mu)!==0){var t=n.deps;if(t!==null)for(var i=t.length,r=0;r<i;r++){var o=t[r];if(o0(o)&&Xk(o),o.wv>n.wv)return!0}(e&Ec)!==0&&zl===null&&Oo(n,ko)}return!1}function mD(n,e,t=!0){var i=n.reactions;if(i!==null&&!vh?.includes(n))for(var r=0;r<i.length;r++){var o=i[r];(o.f&bo)!==0?mD(o,e,!1):e===o&&(t?Oo(o,Sa):(o.f&ko)!==0&&Oo(o,mu),pp(o))}}function gD(n){var e=Qo,t=Ya,i=kl,r=Fn,o=vh,c=Ur,s=lu,d=wc,p=n.f;Qo=null,Ya=0,kl=null,Fn=(p&(kh|xp))===0?n:null,vh=null,Dg(n.ctx),lu=!1,wc=++Ty,n.ac!==null&&(Xw(()=>{n.ac.abort(_g)}),n.ac=null);try{n.f|=IM;var g=n.fn,_=g(),x=n.deps;if(Qo!==null){var b;if(rw(n,Ya),x!==null&&Ya>0)for(x.length=Ya+Qo.length,b=0;b<Qo.length;b++)x[Ya+b]=Qo[b];else n.deps=x=Qo;if(Sy()&&(n.f&Ec)!==0)for(b=Ya;b<x.length;b++)(x[b].reactions??=[]).push(n)}else x!==null&&Ya<x.length&&(rw(n,Ya),x.length=Ya);if(o_()&&kl!==null&&!lu&&x!==null&&(n.f&(bo|mu|Sa))===0)for(b=0;b<kl.length;b++)mD(kl[b],n);return r!==null&&r!==n&&(Ty++,kl!==null&&(i===null?i=kl:i.push(...kl))),(n.f&Ad)!==0&&(n.f^=Ad),_}catch(S){return Gk(S)}finally{n.f^=IM,Qo=e,Ya=t,kl=i,Fn=r,vh=o,Dg(c),lu=s,wc=d}}function d6(n,e){let t=e.reactions;if(t!==null){var i=h5.call(t,n);if(i!==-1){var r=t.length-1;r===0?t=e.reactions=null:(t[i]=t[r],t.pop())}}t===null&&(e.f&bo)!==0&&(Qo===null||!Qo.includes(e))&&(Oo(e,mu),(e.f&Ec)!==0&&(e.f^=Ec,e.f&=~fp),Zk(e),rw(e,0))}function rw(n,e){var t=n.deps;if(t!==null)for(var i=e;i<t.length;i++)d6(n,t[i])}function My(n){var e=n.f;if((e&gh)===0){Oo(n,ko);var t=nr,i=np;nr=n,np=!0;try{(e&(Lh|m5))!==0?c6(n):aD(n),oD(n);var r=gD(n);n.teardown=typeof r=="function"?r:null,n.wv=fD;var o;AM&&U5&&(n.f&Sa)!==0&&n.deps}finally{np=i,nr=t}}}async function _D(){await Promise.resolve(),W5()}function ee(n){var e=n.f,t=(e&bo)!==0;if(Fn!==null&&!lu){var i=nr!==null&&(nr.f&gh)!==0;if(!i&&!vh?.includes(n)){var r=Fn.deps;if((Fn.f&IM)!==0)n.rv<Ty&&(n.rv=Ty,Qo===null&&r!==null&&r[Ya]===n?Ya++:Qo===null?Qo=[n]:Qo.includes(n)||Qo.push(n));else{(Fn.deps??=[]).push(n);var o=n.reactions;o===null?n.reactions=[Fn]:o.includes(Fn)||o.push(Fn)}}}if(wp){if(Pd.has(n))return Pd.get(n);if(t){var c=n,s=c.v;return((c.f&ko)===0&&c.reactions!==null||yD(c))&&(s=j2(c)),Pd.set(c,s),s}}else t&&(!zl?.has(n)||$n?.is_fork&&!Sy())&&(c=n,o0(c)&&Xk(c),np&&Sy()&&(c.f&Ec)===0&&vD(c));if(zl?.has(n))return zl.get(n);if((n.f&Ad)!==0)throw n.v;return n.v}function vD(n){if(n.deps!==null){n.f^=Ec;for(const e of n.deps)(e.reactions??=[]).push(n),(e.f&bo)!==0&&(e.f&Ec)===0&&vD(e)}}function yD(n){if(n.v===Ro)return!0;if(n.deps===null)return!1;for(const e of n.deps)if(Pd.has(e)||(e.f&bo)!==0&&yD(e))return!0;return!1}function bs(n){var e=lu;try{return lu=!0,n()}finally{lu=e}}const f6=-7169;function Oo(n,e){n.f=n.f&f6|e}function p6(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(_h in n)kM(n);else if(!Array.isArray(n))for(let e in n){const t=n[e];typeof t=="object"&&t&&_h in t&&kM(t)}}}function kM(n,e=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!e.has(n)){e.add(n),n instanceof Date&&n.getTime();for(let i in n)try{kM(n[i],e)}catch{}const t=O2(n);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const i=Fk(t);for(let r in i){const o=i[r].get;if(o)try{o.call(n)}catch{}}}}}const m6=["touchstart","touchmove"];function g6(n){return m6.includes(n)}const bD=new Set,DM=new Set;function _6(n,e,t,i={}){function r(o){if(i.capture||Nv.call(e,o),!o.cancelBubble)return Xw(()=>t?.call(this,o))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?Od(()=>{e.addEventListener(n,r,i)}):e.addEventListener(n,r,i),r}function Kw(n,e,t,i,r){var o={capture:i,passive:r},c=_6(n,e,t,o);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&r0(()=>{e.removeEventListener(n,c,o)})}function ds(n){for(var e=0;e<n.length;e++)bD.add(n[e]);for(var t of DM)t(n)}let $P=null;function Nv(n){var e=this,t=e.ownerDocument,i=n.type,r=n.composedPath?.()||[],o=r[0]||n.target;$P=n;var c=0,s=$P===n&&n.__root;if(s){var d=r.indexOf(s);if(d!==-1&&(e===document||e===window)){n.__root=e;return}var p=r.indexOf(e);if(p===-1)return;d<=p&&(c=d)}if(o=r[c]||n.target,o!==e){Dk(n,"currentTarget",{configurable:!0,get(){return o||t}});var g=Fn,_=nr;xa(null),gu(null);try{for(var x,b=[];o!==null;){var S=o.assignedSlot||o.parentNode||o.host||null;try{var P=o["__"+i];P!=null&&(!o.disabled||n.target===o)&&P.call(o,n)}catch(L){x?b.push(L):x=L}if(n.cancelBubble||S===e||S===null)break;o=S}if(x){for(let L of b)queueMicrotask(()=>{throw L});throw x}}finally{n.__root=e,delete n.currentTarget,xa(g),gu(_)}}}function v6(n){var e=document.createElement("template");return e.innerHTML=n.replaceAll("<!>","<!---->"),e.content}function sw(n,e){var t=nr;t.nodes===null&&(t.nodes={start:n,end:e,a:null,t:null})}function Wt(n,e){var t=(e&z5)!==0,i=(e&B5)!==0,r,o=!n.startsWith("<!>");return()=>{r===void 0&&(r=v6(o?n:"<!>"+n),t||(r=iw(r)));var c=i||eD?document.importNode(r,!0):r.cloneNode(!0);if(t){var s=iw(c),d=c.lastChild;sw(s,d)}else sw(c,c);return c}}function Vn(n=""){{var e=du(n+"");return sw(e,e),e}}function ir(){var n=document.createDocumentFragment(),e=document.createComment(""),t=du();return n.append(e,t),sw(e,t),n}function xt(n,e){n!==null&&n.before(e)}function ln(n,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(n.__t??=n.nodeValue)&&(n.__t=t,n.nodeValue=t+"")}function y6(n,e){return b6(n,e)}const zm=new Map;function b6(n,{target:e,anchor:t,props:i={},events:r,context:o,intro:c=!0}){n6();var s=new Set,d=_=>{for(var x=0;x<_.length;x++){var b=_[x];if(!s.has(b)){s.add(b);var S=g6(b);e.addEventListener(b,Nv,{passive:S});var P=zm.get(b);P===void 0?(document.addEventListener(b,Nv,{passive:S}),zm.set(b,1)):zm.set(b,P+1)}}};d(qw(bD)),DM.add(d);var p=void 0,g=a6(()=>{var _=t??e.appendChild(du());return Y5(_,{pending:()=>{}},x=>{if(o){en({});var b=Ur;b.c=o}r&&(i.$$events=r),p=n(x,i)||{},o&&tn()}),()=>{for(var x of s){e.removeEventListener(x,Nv);var b=zm.get(x);--b===0?(document.removeEventListener(x,Nv),zm.delete(x)):zm.set(x,b)}DM.delete(d),_!==t&&_.parentNode?.removeChild(_)}});return x6.set(p,g),p}let x6=new WeakMap;class H2{anchor;#t=new Map;#e=new Map;#i=new Map;#n=new Set;#s=!0;constructor(e,t=!0){this.anchor=e,this.#s=t}#r=()=>{var e=$n;if(this.#t.has(e)){var t=this.#t.get(e),i=this.#e.get(t);if(i)W2(i),this.#n.delete(t);else{var r=this.#i.get(t);r&&(this.#e.set(t,r.effect),this.#i.delete(t),r.fragment.lastChild.remove(),this.anchor.before(r.fragment),i=r.effect)}for(const[o,c]of this.#t){if(this.#t.delete(o),o===e)break;const s=this.#i.get(c);s&&(wa(s.effect),this.#i.delete(c))}for(const[o,c]of this.#e){if(o===t||this.#n.has(o))continue;const s=()=>{if(Array.from(this.#t.values()).includes(o)){var p=document.createDocumentFragment();hD(c,p),p.append(du()),this.#i.set(o,{effect:c,fragment:p})}else wa(c);this.#n.delete(o),this.#e.delete(o)};this.#s||!i?(this.#n.add(o),ip(c,s,!1)):s()}}};#o=e=>{this.#t.delete(e);const t=Array.from(this.#t.values());for(const[i,r]of this.#i)t.includes(i)||(wa(r.effect),this.#i.delete(i))};ensure(e,t){var i=$n,r=nD();if(t&&!this.#e.has(e)&&!this.#i.has(e))if(r){var o=document.createDocumentFragment(),c=du();o.append(c),this.#i.set(e,{effect:Fl(()=>t(c)),fragment:o})}else this.#e.set(e,Fl(()=>t(this.anchor)));if(this.#t.set(i,e),r){for(const[s,d]of this.#e)s===e?i.skipped_effects.delete(d):i.skipped_effects.add(d);for(const[s,d]of this.#i)s===e?i.skipped_effects.delete(d.effect):i.skipped_effects.add(d.effect);i.oncommit(this.#r),i.ondiscard(this.#o)}else this.#r()}}function Ki(n,e,t=!1){var i=new H2(n),r=t?dp:0;function o(c,s){i.ensure(c,s)}a_(()=>{var c=!1;e((s,d=!0)=>{c=!0,o(d,s)}),c||o(!1,null)},r)}function a0(n,e,t){var i=new H2(n),r=!o_();a_(()=>{var o=e();r&&o!==null&&typeof o=="object"&&(o={}),i.ensure(o,t)})}function Xs(n,e){return e}function w6(n,e,t){for(var i=[],r=e.length,o,c=e.length,s=0;s<r;s++){let _=e[s];ip(_,()=>{if(o){if(o.pending.delete(_),o.done.add(_),o.pending.size===0){var x=n.outrogroups;FM(qw(o.done)),x.delete(o),x.size===0&&(n.outrogroups=null)}}else c-=1},!1)}if(c===0){var d=i.length===0&&t!==null;if(d){var p=t,g=p.parentNode;r6(g),g.append(p),n.items.clear()}FM(e,!d)}else o={pending:new Set(e),done:new Set},(n.outrogroups??=new Set).add(o)}function FM(n,e=!0){for(var t=0;t<n.length;t++)wa(n[t],e)}var VP;function Ys(n,e,t,i,r,o=null){var c=n,s=new Map,d=(e&Bk)!==0;if(d){var p=n;c=p.appendChild(du())}var g=null,_=U2(()=>{var E=t();return F2(E)?E:E==null?[]:qw(E)}),x,b=!0;function S(){L.fallback=g,S6(L,x,c,e,i),g!==null&&(x.length===0?(g.f&ph)===0?W2(g):(g.f^=ph,$v(g,null,c)):ip(g,()=>{g=null}))}var P=a_(()=>{x=ee(_);for(var E=x.length,C=new Set,D=$n,O=nD(),U=0;U<E;U+=1){var j=x[U],G=i(j,U),N=b?null:s.get(G);N?(N.v&&Og(N.v,j),N.i&&Og(N.i,U),O&&D.skipped_effects.delete(N.e)):(N=T6(s,b?c:VP??=du(),j,G,U,r,e,t),b||(N.e.f|=ph),s.set(G,N)),C.add(G)}if(E===0&&o&&!g&&(b?g=Fl(()=>o(c)):(g=Fl(()=>o(VP??=du())),g.f|=ph)),!b)if(O){for(const[V,q]of s)C.has(V)||D.skipped_effects.add(q.e);D.oncommit(S),D.ondiscard(()=>{})}else S();ee(_)}),L={effect:P,items:s,outrogroups:null,fallback:g};b=!1}function S6(n,e,t,i,r){var o=(i&I5)!==0,c=e.length,s=n.items,d=n.effect.first,p,g=null,_,x=[],b=[],S,P,L,E;if(o)for(E=0;E<c;E+=1)S=e[E],P=r(S,E),L=s.get(P).e,(L.f&ph)===0&&(L.nodes?.a?.measure(),(_??=new Set).add(L));for(E=0;E<c;E+=1){if(S=e[E],P=r(S,E),L=s.get(P).e,n.outrogroups!==null)for(const q of n.outrogroups)q.pending.delete(L),q.done.delete(L);if((L.f&ph)!==0)if(L.f^=ph,L===d)$v(L,null,t);else{var C=g?g.next:d;L===n.effect.last&&(n.effect.last=L.prev),L.prev&&(L.prev.next=L.next),L.next&&(L.next.prev=L.prev),cd(n,g,L),cd(n,L,C),$v(L,C,t),g=L,x=[],b=[],d=g.next;continue}if((L.f&ol)!==0&&(W2(L),o&&(L.nodes?.a?.unfix(),(_??=new Set).delete(L))),L!==d){if(p!==void 0&&p.has(L)){if(x.length<b.length){var D=b[0],O;g=D.prev;var U=x[0],j=x[x.length-1];for(O=0;O<x.length;O+=1)$v(x[O],D,t);for(O=0;O<b.length;O+=1)p.delete(b[O]);cd(n,U.prev,j.next),cd(n,g,U),cd(n,j,D),d=D,g=j,E-=1,x=[],b=[]}else p.delete(L),$v(L,d,t),cd(n,L.prev,L.next),cd(n,L,g===null?n.effect.first:g.next),cd(n,g,L),g=L;continue}for(x=[],b=[];d!==null&&d!==L;)(p??=new Set).add(d),b.push(d),d=d.next;if(d===null)continue}(L.f&ph)===0&&x.push(L),g=L,d=L.next}if(n.outrogroups!==null){for(const q of n.outrogroups)q.pending.size===0&&(FM(qw(q.done)),n.outrogroups?.delete(q));n.outrogroups.size===0&&(n.outrogroups=null)}if(d!==null||p!==void 0){var G=[];if(p!==void 0)for(L of p)(L.f&ol)===0&&G.push(L);for(;d!==null;)(d.f&ol)===0&&d!==n.fallback&&G.push(d),d=d.next;var N=G.length;if(N>0){var V=(i&Bk)!==0&&c===0?t:null;if(o){for(E=0;E<N;E+=1)G[E].nodes?.a?.measure();for(E=0;E<N;E+=1)G[E].nodes?.a?.fix()}w6(n,G,V)}}o&&Od(()=>{if(_!==void 0)for(L of _)L.nodes?.a?.apply()})}function T6(n,e,t,i,r,o,c,s){var d=(c&A5)!==0?(c&R5)===0?Kk(t,!1,!1):Sh(t):null,p=(c&P5)!==0?Sh(r):null;return{v:d,i:p,e:Fl(()=>(o(e,d??t,p??r,s),()=>{n.delete(i)}))}}function $v(n,e,t){if(n.nodes)for(var i=n.nodes.start,r=n.nodes.end,o=e&&(e.f&ph)===0?e.nodes.start:t;i!==null;){var c=n0(i);if(o.before(i),i===r)return;i=c}}function cd(n,e,t){e===null?n.effect.first=t:e.next=t,t===null?n.effect.last=e:t.prev=e}function hs(n,e,...t){var i=new H2(n);a_(()=>{const r=e()??null;i.ensure(r,r&&(o=>r(o,...t)))},dp)}function M6(n,e){var t;t=document.head.appendChild(du()),a_(()=>e(t),N2)}function C6(n,e,t){q2(()=>{var i=bs(()=>e(n,t?.())||{});if(i?.destroy)return()=>i.destroy()})}function xD(n){var e,t,i="";if(typeof n=="string"||typeof n=="number")i+=n;else if(typeof n=="object")if(Array.isArray(n)){var r=n.length;for(e=0;e<r;e++)n[e]&&(t=xD(n[e]))&&(i&&(i+=" "),i+=t)}else for(t in n)n[t]&&(i&&(i+=" "),i+=t);return i}function E6(){for(var n,e,t=0,i="",r=arguments.length;t<r;t++)(n=arguments[t])&&(e=xD(n))&&(i&&(i+=" "),i+=e);return i}function wD(n){return typeof n=="object"?E6(n):n??""}const UP=[...` 	
\r\fÂ \v\uFEFF`];function A6(n,e,t){var i=n==null?"":""+n;if(e&&(i=i?i+" "+e:e),t){for(var r in t)if(t[r])i=i?i+" "+r:r;else if(i.length)for(var o=r.length,c=0;(c=i.indexOf(r,c))>=0;){var s=c+o;(c===0||UP.includes(i[c-1]))&&(s===i.length||UP.includes(i[s]))?i=(c===0?"":i.substring(0,c))+i.substring(s+1):c=s}}return i===""?null:i}function jP(n,e=!1){var t=e?" !important;":";",i="";for(var r in n){var o=n[r];o!=null&&o!==""&&(i+=" "+r+": "+o+t)}return i}function NS(n){return n[0]!=="-"||n[1]!=="-"?n.toLowerCase():n}function P6(n,e){if(e){var t="",i,r;if(Array.isArray(e)?(i=e[0],r=e[1]):i=e,n){n=String(n).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var o=!1,c=0,s=!1,d=[];i&&d.push(...Object.keys(i).map(NS)),r&&d.push(...Object.keys(r).map(NS));var p=0,g=-1;const P=n.length;for(var _=0;_<P;_++){var x=n[_];if(s?x==="/"&&n[_-1]==="*"&&(s=!1):o?o===x&&(o=!1):x==="/"&&n[_+1]==="*"?s=!0:x==='"'||x==="'"?o=x:x==="("?c++:x===")"&&c--,!s&&o===!1&&c===0){if(x===":"&&g===-1)g=_;else if(x===";"||_===P-1){if(g!==-1){var b=NS(n.substring(p,g).trim());if(!d.includes(b)){x!==";"&&_++;var S=n.substring(p,_).trim();t+=" "+S+";"}}p=_+1,g=-1}}}}return i&&(t+=jP(i)),r&&(t+=jP(r,!0)),t=t.trim(),t===""?null:t}return n==null?null:String(n)}function Ds(n,e,t,i,r,o){var c=n.__className;if(c!==t||c===void 0){var s=A6(t,i,o);s==null?n.removeAttribute("class"):n.className=s,n.__className=t}else if(o&&r!==o)for(var d in o){var p=!!o[d];(r==null||p!==!!r[d])&&n.classList.toggle(d,p)}return o}function $S(n,e={},t,i){for(var r in t){var o=t[r];e[r]!==o&&(t[r]==null?n.style.removeProperty(r):n.style.setProperty(r,o,i))}}function go(n,e,t,i){var r=n.__style;if(r!==e){var o=P6(e,i);o==null?n.removeAttribute("style"):n.style.cssText=o,n.__style=e}else i&&(Array.isArray(i)?($S(n,t?.[0],i[0]),$S(n,t?.[1],i[1],"important")):$S(n,t,i));return i}function SD(n,e,t=!1){if(n.multiple){if(e==null)return;if(!F2(e))return $5();for(var i of n.options)i.selected=e.includes(sy(i));return}for(i of n.options){var r=sy(i);if(Qk(r,e)){i.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function I6(n){var e=new MutationObserver(()=>{SD(n,n.__value)});e.observe(n,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),r0(()=>{e.disconnect()})}function R6(n,e,t=e){var i=new WeakSet,r=!0;Yw(n,"change",o=>{var c=o?"[selected]":":checked",s;if(n.multiple)s=[].map.call(n.querySelectorAll(c),sy);else{var d=n.querySelector(c)??n.querySelector("option:not([disabled])");s=d&&sy(d)}t(s),$n!==null&&i.add($n)}),q2(()=>{var o=e();if(n===document.activeElement){var c=ny??$n;if(i.has(c))return}if(SD(n,o,r),r&&o===void 0){var s=n.querySelector(":checked");s!==null&&(o=sy(s),t(o))}n.__value=o,r=!1}),I6(n)}function sy(n){return"__value"in n?n.__value:n.value}const L6=Symbol("is custom element"),k6=Symbol("is html");function D6(n,e){var t=TD(n);t.value===(t.value=e??void 0)||n.value===e&&(e!==0||n.nodeName!=="PROGRESS")||(n.value=e??"")}function Nl(n,e,t,i){var r=TD(n);r[e]!==(r[e]=t)&&(e==="loading"&&(n[_5]=t),t==null?n.removeAttribute(e):typeof t!="string"&&F6(n).includes(e)?n[e]=t:n.setAttribute(e,t))}function TD(n){return n.__attributes??={[L6]:n.nodeName.includes("-"),[k6]:n.namespaceURI===N5}}var GP=new Map;function F6(n){var e=n.getAttribute("is")||n.nodeName,t=GP.get(e);if(t)return t;GP.set(e,t=[]);for(var i,r=n,o=Element.prototype;o!==r;){i=Fk(r);for(var c in i)i[c].set&&t.push(c);r=O2(r)}return t}function Tg(n,e,t=e){var i=new WeakSet;Yw(n,"input",async r=>{var o=r?n.defaultValue:n.value;if(o=US(n)?jS(o):o,t(o),$n!==null&&i.add($n),await _D(),o!==(o=e())){var c=n.selectionStart,s=n.selectionEnd,d=n.value.length;if(n.value=o??"",s!==null){var p=n.value.length;c===s&&s===d&&p>d?(n.selectionStart=p,n.selectionEnd=p):(n.selectionStart=c,n.selectionEnd=Math.min(s,p))}}}),bs(e)==null&&n.value&&(t(US(n)?jS(n.value):n.value),$n!==null&&i.add($n)),s0(()=>{var r=e();if(n===document.activeElement){var o=ny??$n;if(i.has(o))return}US(n)&&r===jS(n.value)||n.type==="date"&&!r&&!n.value||r!==n.value&&(n.value=r??"")})}const VS=new Set;function Bx(n,e,t,i,r=i){var o=t.getAttribute("type")==="checkbox",c=n;if(e!==null)for(var s of e)c=c[s]??=[];c.push(t),Yw(t,"change",()=>{var d=t.__value;o&&(d=z6(c,d,t.checked)),r(d)},()=>r(o?[]:null)),s0(()=>{var d=i();o?(d=d||[],t.checked=d.includes(t.__value)):t.checked=Qk(t.__value,d)}),r0(()=>{var d=c.indexOf(t);d!==-1&&c.splice(d,1)}),VS.has(c)||(VS.add(c),Od(()=>{c.sort((d,p)=>d.compareDocumentPosition(p)===4?-1:1),VS.delete(c)})),Od(()=>{})}function O6(n,e,t=e){Yw(n,"change",i=>{var r=i?n.defaultChecked:n.checked;t(r)}),bs(e)==null&&t(n.checked),s0(()=>{var i=e();n.checked=!!i})}function z6(n,e,t){for(var i=new Set,r=0;r<n.length;r+=1)n[r].checked&&i.add(n[r].__value);return t||i.delete(e),Array.from(i)}function US(n){var e=n.type;return e==="number"||e==="range"}function jS(n){return n===""?null:+n}function qP(n,e){return n===e||n?.[_h]===e}function Sc(n={},e,t,i){return q2(()=>{var r,o;return s0(()=>{r=o,o=[],bs(()=>{n!==t(...o)&&(e(n,...o),r&&qP(t(...r),n)&&e(null,...r))})}),()=>{Od(()=>{o&&qP(t(...o),n)&&e(null,...o)})}}),n}function Jw(n=!1){const e=Ur,t=e.l.u;if(!t)return;let i=()=>p6(e.s);if(n){let r=0,o={};const c=i0(()=>{let s=!1;const d=e.s;for(const p in d)d[p]!==o[p]&&(o[p]=d[p],s=!0);return s&&r++,r});i=()=>ee(c)}t.b.length&&G2(()=>{WP(e,i),PM(t.b)}),cn(()=>{const r=bs(()=>t.m.map(p5));return()=>{for(const o of r)typeof o=="function"&&o()}}),t.a.length&&cn(()=>{WP(e,i),PM(t.a)})}function WP(n,e){if(n.l.s)for(const t of n.l.s)ee(t);e()}function MD(n,e,t){if(n==null)return e(void 0),is;const i=bs(()=>n.subscribe(e,t));return i.unsubscribe?()=>i.unsubscribe():i}const Bm=[];function Ic(n,e=is){let t=null;const i=new Set;function r(s){if($k(n,s)&&(n=s,t)){const d=!Bm.length;for(const p of i)p[1](),Bm.push(p,n);if(d){for(let p=0;p<Bm.length;p+=2)Bm[p][0](Bm[p+1]);Bm.length=0}}}function o(s){r(s(n))}function c(s,d=is){const p=[s,d];return i.add(p),i.size===1&&(t=e(r,o)||is),s(n),()=>{i.delete(p),i.size===0&&t&&(t(),t=null)}}return{set:r,update:o,subscribe:c}}function Z2(n){let e;return MD(n,t=>e=t)(),e}let Vv=!1,OM=Symbol();function Qi(n,e,t){const i=t[e]??={store:null,source:Kk(void 0),unsubscribe:is};if(i.store!==n&&!(OM in t))if(i.unsubscribe(),i.store=n??null,n==null)i.source.v=void 0,i.unsubscribe=is;else{var r=!0;i.unsubscribe=MD(n,o=>{r?i.source.v=o:Et(i.source,o)}),r=!1}return n&&OM in t?Z2(n):ee(i.source)}function Do(n,e){return n.set(e),e}function qr(){const n={};function e(){r0(()=>{for(var t in n)n[t].unsubscribe();Dk(n,OM,{enumerable:!1,value:!0})})}return[n,e]}function Cb(n,e,t){return n.set(t),e}function rp(n,e,t=1){return n.set(e+t),e}function X2(){Vv=!0}function B6(n){var e=Vv;try{return Vv=!1,[n(),Vv]}finally{Vv=e}}const N6={get(n,e){if(!n.exclude.includes(e))return n.props[e]},set(n,e){return!1},getOwnPropertyDescriptor(n,e){if(!n.exclude.includes(e)&&e in n.props)return{enumerable:!0,configurable:!0,value:n.props[e]}},has(n,e){return n.exclude.includes(e)?!1:e in n.props},ownKeys(n){return Reflect.ownKeys(n.props).filter(e=>!n.exclude.includes(e))}};function $6(n,e,t){return new Proxy({props:n,exclude:e},N6)}function ft(n,e,t,i){var r=!n_||(t&k5)!==0,o=(t&F5)!==0,c=(t&O5)!==0,s=i,d=!0,p=()=>(d&&(d=!1,s=c?bs(i):i),s),g;if(o){var _=_h in n||g5 in n;g=Sg(n,e)?.set??(_&&e in n?D=>n[e]=D:void 0)}var x,b=!1;o?[x,b]=B6(()=>n[e]):x=n[e],x===void 0&&i!==void 0&&(x=p(),g&&(r&&S5(),g(x)));var S;if(r?S=()=>{var D=n[e];return D===void 0?p():(d=!0,D)}:S=()=>{var D=n[e];return D!==void 0&&(s=void 0),D===void 0?s:D},r&&(t&D5)===0)return S;if(g){var P=n.$$legacy;return(function(D,O){return arguments.length>0?((!r||!O||P||b)&&g(O?S():D),D):S()})}var L=!1,E=((t&L5)!==0?i0:U2)(()=>(L=!1,S()));o&&ee(E);var C=nr;return(function(D,O){if(arguments.length>0){const U=O?ee(E):r&&o?xs(D):D;return Et(E,U),L=!0,s!==void 0&&(s=U),D}return wp&&L||(C.f&gh)!==0?E.v:ee(E)})}function Y2(n){Ur===null&&V2(),n_&&Ur.l!==null?V6(Ur).m.push(n):cn(()=>{const e=bs(n);if(typeof e=="function")return e})}function Ta(n){Ur===null&&V2(),Y2(()=>()=>bs(n))}function V6(n){var e=n.l;return e.u??={a:[],b:[],m:[]}}const U6="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(U6);var zg=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function CD(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function K2(n){if(Object.prototype.hasOwnProperty.call(n,"__esModule"))return n;var e=n.default;if(typeof e=="function"){var t=function i(){var r=!1;try{r=this instanceof i}catch{}return r?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(i){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,r.get?r:{enumerable:!0,get:function(){return n[i]}})}),t}var Nx={exports:{}},aa="top",ll="bottom",cl="right",la="left",Qw="auto",l_=[aa,ll,cl,la],mp="start",Bg="end",ED="clippingParents",J2="viewport",hg="popper",AD="reference",zM=l_.reduce(function(n,e){return n.concat([e+"-"+mp,e+"-"+Bg])},[]),Q2=[].concat(l_,[Qw]).reduce(function(n,e){return n.concat([e,e+"-"+mp,e+"-"+Bg])},[]),PD="beforeRead",ID="read",RD="afterRead",LD="beforeMain",kD="main",DD="afterMain",FD="beforeWrite",OD="write",zD="afterWrite",BD=[PD,ID,RD,LD,kD,DD,FD,OD,zD];function _u(n){return n?(n.nodeName||"").toLowerCase():null}function ul(n){if(n==null)return window;if(n.toString()!=="[object Window]"){var e=n.ownerDocument;return e&&e.defaultView||window}return n}function gp(n){var e=ul(n).Element;return n instanceof e||n instanceof Element}function $l(n){var e=ul(n).HTMLElement;return n instanceof e||n instanceof HTMLElement}function eC(n){if(typeof ShadowRoot>"u")return!1;var e=ul(n).ShadowRoot;return n instanceof e||n instanceof ShadowRoot}function j6(n){var e=n.state;Object.keys(e.elements).forEach(function(t){var i=e.styles[t]||{},r=e.attributes[t]||{},o=e.elements[t];!$l(o)||!_u(o)||(Object.assign(o.style,i),Object.keys(r).forEach(function(c){var s=r[c];s===!1?o.removeAttribute(c):o.setAttribute(c,s===!0?"":s)}))})}function G6(n){var e=n.state,t={popper:{position:e.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(e.elements.popper.style,t.popper),e.styles=t,e.elements.arrow&&Object.assign(e.elements.arrow.style,t.arrow),function(){Object.keys(e.elements).forEach(function(i){var r=e.elements[i],o=e.attributes[i]||{},c=Object.keys(e.styles.hasOwnProperty(i)?e.styles[i]:t[i]),s=c.reduce(function(d,p){return d[p]="",d},{});!$l(r)||!_u(r)||(Object.assign(r.style,s),Object.keys(o).forEach(function(d){r.removeAttribute(d)}))})}}const tC={name:"applyStyles",enabled:!0,phase:"write",fn:j6,effect:G6,requires:["computeStyles"]};function fu(n){return n.split("-")[0]}var sp=Math.max,ow=Math.min,Ng=Math.round;function BM(){var n=navigator.userAgentData;return n!=null&&n.brands&&Array.isArray(n.brands)?n.brands.map(function(e){return e.brand+"/"+e.version}).join(" "):navigator.userAgent}function ND(){return!/^((?!chrome|android).)*safari/i.test(BM())}function $g(n,e,t){e===void 0&&(e=!1),t===void 0&&(t=!1);var i=n.getBoundingClientRect(),r=1,o=1;e&&$l(n)&&(r=n.offsetWidth>0&&Ng(i.width)/n.offsetWidth||1,o=n.offsetHeight>0&&Ng(i.height)/n.offsetHeight||1);var c=gp(n)?ul(n):window,s=c.visualViewport,d=!ND()&&t,p=(i.left+(d&&s?s.offsetLeft:0))/r,g=(i.top+(d&&s?s.offsetTop:0))/o,_=i.width/r,x=i.height/o;return{width:_,height:x,top:g,right:p+_,bottom:g+x,left:p,x:p,y:g}}function iC(n){var e=$g(n),t=n.offsetWidth,i=n.offsetHeight;return Math.abs(e.width-t)<=1&&(t=e.width),Math.abs(e.height-i)<=1&&(i=e.height),{x:n.offsetLeft,y:n.offsetTop,width:t,height:i}}function $D(n,e){var t=e.getRootNode&&e.getRootNode();if(n.contains(e))return!0;if(t&&eC(t)){var i=e;do{if(i&&n.isSameNode(i))return!0;i=i.parentNode||i.host}while(i)}return!1}function Th(n){return ul(n).getComputedStyle(n)}function q6(n){return["table","td","th"].indexOf(_u(n))>=0}function Zd(n){return((gp(n)?n.ownerDocument:n.document)||window.document).documentElement}function e1(n){return _u(n)==="html"?n:n.assignedSlot||n.parentNode||(eC(n)?n.host:null)||Zd(n)}function HP(n){return!$l(n)||Th(n).position==="fixed"?null:n.offsetParent}function W6(n){var e=/firefox/i.test(BM()),t=/Trident/i.test(BM());if(t&&$l(n)){var i=Th(n);if(i.position==="fixed")return null}var r=e1(n);for(eC(r)&&(r=r.host);$l(r)&&["html","body"].indexOf(_u(r))<0;){var o=Th(r);if(o.transform!=="none"||o.perspective!=="none"||o.contain==="paint"||["transform","perspective"].indexOf(o.willChange)!==-1||e&&o.willChange==="filter"||e&&o.filter&&o.filter!=="none")return r;r=r.parentNode}return null}function l0(n){for(var e=ul(n),t=HP(n);t&&q6(t)&&Th(t).position==="static";)t=HP(t);return t&&(_u(t)==="html"||_u(t)==="body"&&Th(t).position==="static")?e:t||W6(n)||e}function nC(n){return["top","bottom"].indexOf(n)>=0?"x":"y"}function oy(n,e,t){return sp(n,ow(e,t))}function H6(n,e,t){var i=oy(n,e,t);return i>t?t:i}function VD(){return{top:0,right:0,bottom:0,left:0}}function UD(n){return Object.assign({},VD(),n)}function jD(n,e){return e.reduce(function(t,i){return t[i]=n,t},{})}var Z6=function(e,t){return e=typeof e=="function"?e(Object.assign({},t.rects,{placement:t.placement})):e,UD(typeof e!="number"?e:jD(e,l_))};function X6(n){var e,t=n.state,i=n.name,r=n.options,o=t.elements.arrow,c=t.modifiersData.popperOffsets,s=fu(t.placement),d=nC(s),p=[la,cl].indexOf(s)>=0,g=p?"height":"width";if(!(!o||!c)){var _=Z6(r.padding,t),x=iC(o),b=d==="y"?aa:la,S=d==="y"?ll:cl,P=t.rects.reference[g]+t.rects.reference[d]-c[d]-t.rects.popper[g],L=c[d]-t.rects.reference[d],E=l0(o),C=E?d==="y"?E.clientHeight||0:E.clientWidth||0:0,D=P/2-L/2,O=_[b],U=C-x[g]-_[S],j=C/2-x[g]/2+D,G=oy(O,j,U),N=d;t.modifiersData[i]=(e={},e[N]=G,e.centerOffset=G-j,e)}}function Y6(n){var e=n.state,t=n.options,i=t.element,r=i===void 0?"[data-popper-arrow]":i;r!=null&&(typeof r=="string"&&(r=e.elements.popper.querySelector(r),!r)||$D(e.elements.popper,r)&&(e.elements.arrow=r))}const GD={name:"arrow",enabled:!0,phase:"main",fn:X6,effect:Y6,requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function Vg(n){return n.split("-")[1]}var K6={top:"auto",right:"auto",bottom:"auto",left:"auto"};function J6(n,e){var t=n.x,i=n.y,r=e.devicePixelRatio||1;return{x:Ng(t*r)/r||0,y:Ng(i*r)/r||0}}function ZP(n){var e,t=n.popper,i=n.popperRect,r=n.placement,o=n.variation,c=n.offsets,s=n.position,d=n.gpuAcceleration,p=n.adaptive,g=n.roundOffsets,_=n.isFixed,x=c.x,b=x===void 0?0:x,S=c.y,P=S===void 0?0:S,L=typeof g=="function"?g({x:b,y:P}):{x:b,y:P};b=L.x,P=L.y;var E=c.hasOwnProperty("x"),C=c.hasOwnProperty("y"),D=la,O=aa,U=window;if(p){var j=l0(t),G="clientHeight",N="clientWidth";if(j===ul(t)&&(j=Zd(t),Th(j).position!=="static"&&s==="absolute"&&(G="scrollHeight",N="scrollWidth")),j=j,r===aa||(r===la||r===cl)&&o===Bg){O=ll;var V=_&&j===U&&U.visualViewport?U.visualViewport.height:j[G];P-=V-i.height,P*=d?1:-1}if(r===la||(r===aa||r===ll)&&o===Bg){D=cl;var q=_&&j===U&&U.visualViewport?U.visualViewport.width:j[N];b-=q-i.width,b*=d?1:-1}}var z=Object.assign({position:s},p&&K6),Q=g===!0?J6({x:b,y:P},ul(t)):{x:b,y:P};if(b=Q.x,P=Q.y,d){var X;return Object.assign({},z,(X={},X[O]=C?"0":"",X[D]=E?"0":"",X.transform=(U.devicePixelRatio||1)<=1?"translate("+b+"px, "+P+"px)":"translate3d("+b+"px, "+P+"px, 0)",X))}return Object.assign({},z,(e={},e[O]=C?P+"px":"",e[D]=E?b+"px":"",e.transform="",e))}function Q6(n){var e=n.state,t=n.options,i=t.gpuAcceleration,r=i===void 0?!0:i,o=t.adaptive,c=o===void 0?!0:o,s=t.roundOffsets,d=s===void 0?!0:s,p={placement:fu(e.placement),variation:Vg(e.placement),popper:e.elements.popper,popperRect:e.rects.popper,gpuAcceleration:r,isFixed:e.options.strategy==="fixed"};e.modifiersData.popperOffsets!=null&&(e.styles.popper=Object.assign({},e.styles.popper,ZP(Object.assign({},p,{offsets:e.modifiersData.popperOffsets,position:e.options.strategy,adaptive:c,roundOffsets:d})))),e.modifiersData.arrow!=null&&(e.styles.arrow=Object.assign({},e.styles.arrow,ZP(Object.assign({},p,{offsets:e.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:d})))),e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-placement":e.placement})}const rC={name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:Q6,data:{}};var Eb={passive:!0};function eV(n){var e=n.state,t=n.instance,i=n.options,r=i.scroll,o=r===void 0?!0:r,c=i.resize,s=c===void 0?!0:c,d=ul(e.elements.popper),p=[].concat(e.scrollParents.reference,e.scrollParents.popper);return o&&p.forEach(function(g){g.addEventListener("scroll",t.update,Eb)}),s&&d.addEventListener("resize",t.update,Eb),function(){o&&p.forEach(function(g){g.removeEventListener("scroll",t.update,Eb)}),s&&d.removeEventListener("resize",t.update,Eb)}}const sC={name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:eV,data:{}};var tV={left:"right",right:"left",bottom:"top",top:"bottom"};function $x(n){return n.replace(/left|right|bottom|top/g,function(e){return tV[e]})}var iV={start:"end",end:"start"};function XP(n){return n.replace(/start|end/g,function(e){return iV[e]})}function oC(n){var e=ul(n),t=e.pageXOffset,i=e.pageYOffset;return{scrollLeft:t,scrollTop:i}}function aC(n){return $g(Zd(n)).left+oC(n).scrollLeft}function nV(n,e){var t=ul(n),i=Zd(n),r=t.visualViewport,o=i.clientWidth,c=i.clientHeight,s=0,d=0;if(r){o=r.width,c=r.height;var p=ND();(p||!p&&e==="fixed")&&(s=r.offsetLeft,d=r.offsetTop)}return{width:o,height:c,x:s+aC(n),y:d}}function rV(n){var e,t=Zd(n),i=oC(n),r=(e=n.ownerDocument)==null?void 0:e.body,o=sp(t.scrollWidth,t.clientWidth,r?r.scrollWidth:0,r?r.clientWidth:0),c=sp(t.scrollHeight,t.clientHeight,r?r.scrollHeight:0,r?r.clientHeight:0),s=-i.scrollLeft+aC(n),d=-i.scrollTop;return Th(r||t).direction==="rtl"&&(s+=sp(t.clientWidth,r?r.clientWidth:0)-o),{width:o,height:c,x:s,y:d}}function lC(n){var e=Th(n),t=e.overflow,i=e.overflowX,r=e.overflowY;return/auto|scroll|overlay|hidden/.test(t+r+i)}function qD(n){return["html","body","#document"].indexOf(_u(n))>=0?n.ownerDocument.body:$l(n)&&lC(n)?n:qD(e1(n))}function ay(n,e){var t;e===void 0&&(e=[]);var i=qD(n),r=i===((t=n.ownerDocument)==null?void 0:t.body),o=ul(i),c=r?[o].concat(o.visualViewport||[],lC(i)?i:[]):i,s=e.concat(c);return r?s:s.concat(ay(e1(c)))}function NM(n){return Object.assign({},n,{left:n.x,top:n.y,right:n.x+n.width,bottom:n.y+n.height})}function sV(n,e){var t=$g(n,!1,e==="fixed");return t.top=t.top+n.clientTop,t.left=t.left+n.clientLeft,t.bottom=t.top+n.clientHeight,t.right=t.left+n.clientWidth,t.width=n.clientWidth,t.height=n.clientHeight,t.x=t.left,t.y=t.top,t}function YP(n,e,t){return e===J2?NM(nV(n,t)):gp(e)?sV(e,t):NM(rV(Zd(n)))}function oV(n){var e=ay(e1(n)),t=["absolute","fixed"].indexOf(Th(n).position)>=0,i=t&&$l(n)?l0(n):n;return gp(i)?e.filter(function(r){return gp(r)&&$D(r,i)&&_u(r)!=="body"}):[]}function aV(n,e,t,i){var r=e==="clippingParents"?oV(n):[].concat(e),o=[].concat(r,[t]),c=o[0],s=o.reduce(function(d,p){var g=YP(n,p,i);return d.top=sp(g.top,d.top),d.right=ow(g.right,d.right),d.bottom=ow(g.bottom,d.bottom),d.left=sp(g.left,d.left),d},YP(n,c,i));return s.width=s.right-s.left,s.height=s.bottom-s.top,s.x=s.left,s.y=s.top,s}function WD(n){var e=n.reference,t=n.element,i=n.placement,r=i?fu(i):null,o=i?Vg(i):null,c=e.x+e.width/2-t.width/2,s=e.y+e.height/2-t.height/2,d;switch(r){case aa:d={x:c,y:e.y-t.height};break;case ll:d={x:c,y:e.y+e.height};break;case cl:d={x:e.x+e.width,y:s};break;case la:d={x:e.x-t.width,y:s};break;default:d={x:e.x,y:e.y}}var p=r?nC(r):null;if(p!=null){var g=p==="y"?"height":"width";switch(o){case mp:d[p]=d[p]-(e[g]/2-t[g]/2);break;case Bg:d[p]=d[p]+(e[g]/2-t[g]/2);break}}return d}function Ug(n,e){e===void 0&&(e={});var t=e,i=t.placement,r=i===void 0?n.placement:i,o=t.strategy,c=o===void 0?n.strategy:o,s=t.boundary,d=s===void 0?ED:s,p=t.rootBoundary,g=p===void 0?J2:p,_=t.elementContext,x=_===void 0?hg:_,b=t.altBoundary,S=b===void 0?!1:b,P=t.padding,L=P===void 0?0:P,E=UD(typeof L!="number"?L:jD(L,l_)),C=x===hg?AD:hg,D=n.rects.popper,O=n.elements[S?C:x],U=aV(gp(O)?O:O.contextElement||Zd(n.elements.popper),d,g,c),j=$g(n.elements.reference),G=WD({reference:j,element:D,placement:r}),N=NM(Object.assign({},D,G)),V=x===hg?N:j,q={top:U.top-V.top+E.top,bottom:V.bottom-U.bottom+E.bottom,left:U.left-V.left+E.left,right:V.right-U.right+E.right},z=n.modifiersData.offset;if(x===hg&&z){var Q=z[r];Object.keys(q).forEach(function(X){var re=[cl,ll].indexOf(X)>=0?1:-1,oe=[aa,ll].indexOf(X)>=0?"y":"x";q[X]+=Q[oe]*re})}return q}function lV(n,e){e===void 0&&(e={});var t=e,i=t.placement,r=t.boundary,o=t.rootBoundary,c=t.padding,s=t.flipVariations,d=t.allowedAutoPlacements,p=d===void 0?Q2:d,g=Vg(i),_=g?s?zM:zM.filter(function(S){return Vg(S)===g}):l_,x=_.filter(function(S){return p.indexOf(S)>=0});x.length===0&&(x=_);var b=x.reduce(function(S,P){return S[P]=Ug(n,{placement:P,boundary:r,rootBoundary:o,padding:c})[fu(P)],S},{});return Object.keys(b).sort(function(S,P){return b[S]-b[P]})}function cV(n){if(fu(n)===Qw)return[];var e=$x(n);return[XP(n),e,XP(e)]}function uV(n){var e=n.state,t=n.options,i=n.name;if(!e.modifiersData[i]._skip){for(var r=t.mainAxis,o=r===void 0?!0:r,c=t.altAxis,s=c===void 0?!0:c,d=t.fallbackPlacements,p=t.padding,g=t.boundary,_=t.rootBoundary,x=t.altBoundary,b=t.flipVariations,S=b===void 0?!0:b,P=t.allowedAutoPlacements,L=e.options.placement,E=fu(L),C=E===L,D=d||(C||!S?[$x(L)]:cV(L)),O=[L].concat(D).reduce(function(ke,et){return ke.concat(fu(et)===Qw?lV(e,{placement:et,boundary:g,rootBoundary:_,padding:p,flipVariations:S,allowedAutoPlacements:P}):et)},[]),U=e.rects.reference,j=e.rects.popper,G=new Map,N=!0,V=O[0],q=0;q<O.length;q++){var z=O[q],Q=fu(z),X=Vg(z)===mp,re=[aa,ll].indexOf(Q)>=0,oe=re?"width":"height",de=Ug(e,{placement:z,boundary:g,rootBoundary:_,altBoundary:x,padding:p}),ce=re?X?cl:la:X?ll:aa;U[oe]>j[oe]&&(ce=$x(ce));var Se=$x(ce),Pe=[];if(o&&Pe.push(de[Q]<=0),s&&Pe.push(de[ce]<=0,de[Se]<=0),Pe.every(function(ke){return ke})){V=z,N=!1;break}G.set(z,Pe)}if(N)for(var je=S?3:1,Fe=function(et){var ye=O.find(function(Be){var Je=G.get(Be);if(Je)return Je.slice(0,et).every(function(ct){return ct})});if(ye)return V=ye,"break"},qe=je;qe>0;qe--){var Ue=Fe(qe);if(Ue==="break")break}e.placement!==V&&(e.modifiersData[i]._skip=!0,e.placement=V,e.reset=!0)}}const HD={name:"flip",enabled:!0,phase:"main",fn:uV,requiresIfExists:["offset"],data:{_skip:!1}};function KP(n,e,t){return t===void 0&&(t={x:0,y:0}),{top:n.top-e.height-t.y,right:n.right-e.width+t.x,bottom:n.bottom-e.height+t.y,left:n.left-e.width-t.x}}function JP(n){return[aa,cl,ll,la].some(function(e){return n[e]>=0})}function hV(n){var e=n.state,t=n.name,i=e.rects.reference,r=e.rects.popper,o=e.modifiersData.preventOverflow,c=Ug(e,{elementContext:"reference"}),s=Ug(e,{altBoundary:!0}),d=KP(c,i),p=KP(s,r,o),g=JP(d),_=JP(p);e.modifiersData[t]={referenceClippingOffsets:d,popperEscapeOffsets:p,isReferenceHidden:g,hasPopperEscaped:_},e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-reference-hidden":g,"data-popper-escaped":_})}const ZD={name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:hV};function dV(n,e,t){var i=fu(n),r=[la,aa].indexOf(i)>=0?-1:1,o=typeof t=="function"?t(Object.assign({},e,{placement:n})):t,c=o[0],s=o[1];return c=c||0,s=(s||0)*r,[la,cl].indexOf(i)>=0?{x:s,y:c}:{x:c,y:s}}function fV(n){var e=n.state,t=n.options,i=n.name,r=t.offset,o=r===void 0?[0,0]:r,c=Q2.reduce(function(g,_){return g[_]=dV(_,e.rects,o),g},{}),s=c[e.placement],d=s.x,p=s.y;e.modifiersData.popperOffsets!=null&&(e.modifiersData.popperOffsets.x+=d,e.modifiersData.popperOffsets.y+=p),e.modifiersData[i]=c}const XD={name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:fV};function pV(n){var e=n.state,t=n.name;e.modifiersData[t]=WD({reference:e.rects.reference,element:e.rects.popper,placement:e.placement})}const cC={name:"popperOffsets",enabled:!0,phase:"read",fn:pV,data:{}};function mV(n){return n==="x"?"y":"x"}function gV(n){var e=n.state,t=n.options,i=n.name,r=t.mainAxis,o=r===void 0?!0:r,c=t.altAxis,s=c===void 0?!1:c,d=t.boundary,p=t.rootBoundary,g=t.altBoundary,_=t.padding,x=t.tether,b=x===void 0?!0:x,S=t.tetherOffset,P=S===void 0?0:S,L=Ug(e,{boundary:d,rootBoundary:p,padding:_,altBoundary:g}),E=fu(e.placement),C=Vg(e.placement),D=!C,O=nC(E),U=mV(O),j=e.modifiersData.popperOffsets,G=e.rects.reference,N=e.rects.popper,V=typeof P=="function"?P(Object.assign({},e.rects,{placement:e.placement})):P,q=typeof V=="number"?{mainAxis:V,altAxis:V}:Object.assign({mainAxis:0,altAxis:0},V),z=e.modifiersData.offset?e.modifiersData.offset[e.placement]:null,Q={x:0,y:0};if(j){if(o){var X,re=O==="y"?aa:la,oe=O==="y"?ll:cl,de=O==="y"?"height":"width",ce=j[O],Se=ce+L[re],Pe=ce-L[oe],je=b?-N[de]/2:0,Fe=C===mp?G[de]:N[de],qe=C===mp?-N[de]:-G[de],Ue=e.elements.arrow,ke=b&&Ue?iC(Ue):{width:0,height:0},et=e.modifiersData["arrow#persistent"]?e.modifiersData["arrow#persistent"].padding:VD(),ye=et[re],Be=et[oe],Je=oy(0,G[de],ke[de]),ct=D?G[de]/2-je-Je-ye-q.mainAxis:Fe-Je-ye-q.mainAxis,yt=D?-G[de]/2+je+Je+Be+q.mainAxis:qe+Je+Be+q.mainAxis,we=e.elements.arrow&&l0(e.elements.arrow),fe=we?O==="y"?we.clientTop||0:we.clientLeft||0:0,Ve=(X=z?.[O])!=null?X:0,tt=ce+ct-Ve-fe,Mt=ce+yt-Ve,mt=oy(b?ow(Se,tt):Se,ce,b?sp(Pe,Mt):Pe);j[O]=mt,Q[O]=mt-ce}if(s){var Ce,xe=O==="x"?aa:la,vt=O==="x"?ll:cl,be=j[U],ie=U==="y"?"height":"width",ae=be+L[xe],De=be-L[vt],Xe=[aa,la].indexOf(E)!==-1,bt=(Ce=z?.[U])!=null?Ce:0,Te=Xe?ae:be-G[ie]-N[ie]-bt+q.altAxis,te=Xe?be+G[ie]+N[ie]-bt-q.altAxis:De,he=b&&Xe?H6(Te,be,te):oy(b?Te:ae,be,b?te:De);j[U]=he,Q[U]=he-be}e.modifiersData[i]=Q}}const YD={name:"preventOverflow",enabled:!0,phase:"main",fn:gV,requiresIfExists:["offset"]};function _V(n){return{scrollLeft:n.scrollLeft,scrollTop:n.scrollTop}}function vV(n){return n===ul(n)||!$l(n)?oC(n):_V(n)}function yV(n){var e=n.getBoundingClientRect(),t=Ng(e.width)/n.offsetWidth||1,i=Ng(e.height)/n.offsetHeight||1;return t!==1||i!==1}function bV(n,e,t){t===void 0&&(t=!1);var i=$l(e),r=$l(e)&&yV(e),o=Zd(e),c=$g(n,r,t),s={scrollLeft:0,scrollTop:0},d={x:0,y:0};return(i||!i&&!t)&&((_u(e)!=="body"||lC(o))&&(s=vV(e)),$l(e)?(d=$g(e,!0),d.x+=e.clientLeft,d.y+=e.clientTop):o&&(d.x=aC(o))),{x:c.left+s.scrollLeft-d.x,y:c.top+s.scrollTop-d.y,width:c.width,height:c.height}}function xV(n){var e=new Map,t=new Set,i=[];n.forEach(function(o){e.set(o.name,o)});function r(o){t.add(o.name);var c=[].concat(o.requires||[],o.requiresIfExists||[]);c.forEach(function(s){if(!t.has(s)){var d=e.get(s);d&&r(d)}}),i.push(o)}return n.forEach(function(o){t.has(o.name)||r(o)}),i}function wV(n){var e=xV(n);return BD.reduce(function(t,i){return t.concat(e.filter(function(r){return r.phase===i}))},[])}function SV(n){var e;return function(){return e||(e=new Promise(function(t){Promise.resolve().then(function(){e=void 0,t(n())})})),e}}function TV(n){var e=n.reduce(function(t,i){var r=t[i.name];return t[i.name]=r?Object.assign({},r,i,{options:Object.assign({},r.options,i.options),data:Object.assign({},r.data,i.data)}):i,t},{});return Object.keys(e).map(function(t){return e[t]})}var QP={placement:"bottom",modifiers:[],strategy:"absolute"};function eI(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return!e.some(function(i){return!(i&&typeof i.getBoundingClientRect=="function")})}function t1(n){n===void 0&&(n={});var e=n,t=e.defaultModifiers,i=t===void 0?[]:t,r=e.defaultOptions,o=r===void 0?QP:r;return function(s,d,p){p===void 0&&(p=o);var g={placement:"bottom",orderedModifiers:[],options:Object.assign({},QP,o),modifiersData:{},elements:{reference:s,popper:d},attributes:{},styles:{}},_=[],x=!1,b={state:g,setOptions:function(E){var C=typeof E=="function"?E(g.options):E;P(),g.options=Object.assign({},o,g.options,C),g.scrollParents={reference:gp(s)?ay(s):s.contextElement?ay(s.contextElement):[],popper:ay(d)};var D=wV(TV([].concat(i,g.options.modifiers)));return g.orderedModifiers=D.filter(function(O){return O.enabled}),S(),b.update()},forceUpdate:function(){if(!x){var E=g.elements,C=E.reference,D=E.popper;if(eI(C,D)){g.rects={reference:bV(C,l0(D),g.options.strategy==="fixed"),popper:iC(D)},g.reset=!1,g.placement=g.options.placement,g.orderedModifiers.forEach(function(q){return g.modifiersData[q.name]=Object.assign({},q.data)});for(var O=0;O<g.orderedModifiers.length;O++){if(g.reset===!0){g.reset=!1,O=-1;continue}var U=g.orderedModifiers[O],j=U.fn,G=U.options,N=G===void 0?{}:G,V=U.name;typeof j=="function"&&(g=j({state:g,options:N,name:V,instance:b})||g)}}}},update:SV(function(){return new Promise(function(L){b.forceUpdate(),L(g)})}),destroy:function(){P(),x=!0}};if(!eI(s,d))return b;b.setOptions(p).then(function(L){!x&&p.onFirstUpdate&&p.onFirstUpdate(L)});function S(){g.orderedModifiers.forEach(function(L){var E=L.name,C=L.options,D=C===void 0?{}:C,O=L.effect;if(typeof O=="function"){var U=O({state:g,name:E,instance:b,options:D}),j=function(){};_.push(U||j)}})}function P(){_.forEach(function(L){return L()}),_=[]}return b}}var MV=t1(),CV=[sC,cC,rC,tC],EV=t1({defaultModifiers:CV}),AV=[sC,cC,rC,tC,XD,HD,YD,GD,ZD],PV=t1({defaultModifiers:AV});const IV=Object.freeze(Object.defineProperty({__proto__:null,afterMain:DD,afterRead:RD,afterWrite:zD,applyStyles:tC,arrow:GD,auto:Qw,basePlacements:l_,beforeMain:LD,beforeRead:PD,beforeWrite:FD,bottom:ll,clippingParents:ED,computeStyles:rC,createPopper:PV,createPopperBase:MV,createPopperLite:EV,detectOverflow:Ug,end:Bg,eventListeners:sC,flip:HD,hide:ZD,left:la,main:kD,modifierPhases:BD,offset:XD,placements:Q2,popper:hg,popperGenerator:t1,popperOffsets:cC,preventOverflow:YD,read:ID,reference:AD,right:cl,start:mp,top:aa,variationPlacements:zM,viewport:J2,write:OD},Symbol.toStringTag,{value:"Module"})),RV=K2(IV);var LV=Nx.exports,tI;function kV(){return tI||(tI=1,(function(n,e){(function(t,i){n.exports=i(RV)})(LV,function(t){function i(ut){const Y=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(ut){for(const Me in ut)if(Me!=="default"){const dt=Object.getOwnPropertyDescriptor(ut,Me);Object.defineProperty(Y,Me,dt.get?dt:{enumerable:!0,get:()=>ut[Me]})}}return Y.default=ut,Object.freeze(Y)}const r=i(t),o=new Map,c={set(ut,Y,Me){o.has(ut)||o.set(ut,new Map);const dt=o.get(ut);dt.has(Y)||dt.size===0?dt.set(Y,Me):console.error(`Bootstrap doesn't allow more than one instance per element. Bound instance: ${Array.from(dt.keys())[0]}.`)},get:(ut,Y)=>o.has(ut)&&o.get(ut).get(Y)||null,remove(ut,Y){if(!o.has(ut))return;const Me=o.get(ut);Me.delete(Y),Me.size===0&&o.delete(ut)}},s="transitionend",d=ut=>(ut&&window.CSS&&window.CSS.escape&&(ut=ut.replace(/#([^\s"#']+)/g,(Y,Me)=>`#${CSS.escape(Me)}`)),ut),p=ut=>ut==null?`${ut}`:Object.prototype.toString.call(ut).match(/\s([a-z]+)/i)[1].toLowerCase(),g=ut=>{ut.dispatchEvent(new Event(s))},_=ut=>!(!ut||typeof ut!="object")&&(ut.jquery!==void 0&&(ut=ut[0]),ut.nodeType!==void 0),x=ut=>_(ut)?ut.jquery?ut[0]:ut:typeof ut=="string"&&ut.length>0?document.querySelector(d(ut)):null,b=ut=>{if(!_(ut)||ut.getClientRects().length===0)return!1;const Y=getComputedStyle(ut).getPropertyValue("visibility")==="visible",Me=ut.closest("details:not([open])");if(!Me)return Y;if(Me!==ut){const dt=ut.closest("summary");if(dt&&dt.parentNode!==Me||dt===null)return!1}return Y},S=ut=>!ut||ut.nodeType!==Node.ELEMENT_NODE||!!ut.classList.contains("disabled")||(ut.disabled!==void 0?ut.disabled:ut.hasAttribute("disabled")&&ut.getAttribute("disabled")!=="false"),P=ut=>{if(!document.documentElement.attachShadow)return null;if(typeof ut.getRootNode=="function"){const Y=ut.getRootNode();return Y instanceof ShadowRoot?Y:null}return ut instanceof ShadowRoot?ut:ut.parentNode?P(ut.parentNode):null},L=()=>{},E=ut=>{ut.offsetHeight},C=()=>window.jQuery&&!document.body.hasAttribute("data-bs-no-jquery")?window.jQuery:null,D=[],O=()=>document.documentElement.dir==="rtl",U=ut=>{var Y;Y=()=>{const Me=C();if(Me){const dt=ut.NAME,Ht=Me.fn[dt];Me.fn[dt]=ut.jQueryInterface,Me.fn[dt].Constructor=ut,Me.fn[dt].noConflict=()=>(Me.fn[dt]=Ht,ut.jQueryInterface)}},document.readyState==="loading"?(D.length||document.addEventListener("DOMContentLoaded",()=>{for(const Me of D)Me()}),D.push(Y)):Y()},j=(ut,Y=[],Me=ut)=>typeof ut=="function"?ut.call(...Y):Me,G=(ut,Y,Me=!0)=>{if(!Me)return void j(ut);const dt=(Ti=>{if(!Ti)return 0;let{transitionDuration:yn,transitionDelay:pr}=window.getComputedStyle(Ti);const Ms=Number.parseFloat(yn),ji=Number.parseFloat(pr);return Ms||ji?(yn=yn.split(",")[0],pr=pr.split(",")[0],1e3*(Number.parseFloat(yn)+Number.parseFloat(pr))):0})(Y)+5;let Ht=!1;const di=({target:Ti})=>{Ti===Y&&(Ht=!0,Y.removeEventListener(s,di),j(ut))};Y.addEventListener(s,di),setTimeout(()=>{Ht||g(Y)},dt)},N=(ut,Y,Me,dt)=>{const Ht=ut.length;let di=ut.indexOf(Y);return di===-1?!Me&&dt?ut[Ht-1]:ut[0]:(di+=Me?1:-1,dt&&(di=(di+Ht)%Ht),ut[Math.max(0,Math.min(di,Ht-1))])},V=/[^.]*(?=\..*)\.|.*/,q=/\..*/,z=/::\d+$/,Q={};let X=1;const re={mouseenter:"mouseover",mouseleave:"mouseout"},oe=new Set(["click","dblclick","mouseup","mousedown","contextmenu","mousewheel","DOMMouseScroll","mouseover","mouseout","mousemove","selectstart","selectend","keydown","keypress","keyup","orientationchange","touchstart","touchmove","touchend","touchcancel","pointerdown","pointermove","pointerup","pointerleave","pointercancel","gesturestart","gesturechange","gestureend","focus","blur","change","reset","select","submit","focusin","focusout","load","unload","beforeunload","resize","move","DOMContentLoaded","readystatechange","error","abort","scroll"]);function de(ut,Y){return Y&&`${Y}::${X++}`||ut.uidEvent||X++}function ce(ut){const Y=de(ut);return ut.uidEvent=Y,Q[Y]=Q[Y]||{},Q[Y]}function Se(ut,Y,Me=null){return Object.values(ut).find(dt=>dt.callable===Y&&dt.delegationSelector===Me)}function Pe(ut,Y,Me){const dt=typeof Y=="string",Ht=dt?Me:Y||Me;let di=Ue(ut);return oe.has(di)||(di=ut),[dt,Ht,di]}function je(ut,Y,Me,dt,Ht){if(typeof Y!="string"||!ut)return;let[di,Ti,yn]=Pe(Y,Me,dt);Y in re&&(Ti=(Wo=>function(Ho){if(!Ho.relatedTarget||Ho.relatedTarget!==Ho.delegateTarget&&!Ho.delegateTarget.contains(Ho.relatedTarget))return Wo.call(this,Ho)})(Ti));const pr=ce(ut),Ms=pr[yn]||(pr[yn]={}),ji=Se(Ms,Ti,di?Me:null);if(ji)return void(ji.oneOff=ji.oneOff&&Ht);const Js=de(Ti,Y.replace(V,"")),Fa=di?(function(ha,Wo,Ho){return function Nu($u){const C_=ha.querySelectorAll(Wo);for(let{target:Oa}=$u;Oa&&Oa!==this;Oa=Oa.parentNode)for(const Uc of C_)if(Uc===Oa)return et($u,{delegateTarget:Oa}),Nu.oneOff&&ke.off(ha,$u.type,Wo,Ho),Ho.apply(Oa,[$u])}})(ut,Me,Ti):(function(ha,Wo){return function Ho(Nu){return et(Nu,{delegateTarget:ha}),Ho.oneOff&&ke.off(ha,Nu.type,Wo),Wo.apply(ha,[Nu])}})(ut,Ti);Fa.delegationSelector=di?Me:null,Fa.callable=Ti,Fa.oneOff=Ht,Fa.uidEvent=Js,Ms[Js]=Fa,ut.addEventListener(yn,Fa,di)}function Fe(ut,Y,Me,dt,Ht){const di=Se(Y[Me],dt,Ht);di&&(ut.removeEventListener(Me,di,!!Ht),delete Y[Me][di.uidEvent])}function qe(ut,Y,Me,dt){const Ht=Y[Me]||{};for(const[di,Ti]of Object.entries(Ht))di.includes(dt)&&Fe(ut,Y,Me,Ti.callable,Ti.delegationSelector)}function Ue(ut){return ut=ut.replace(q,""),re[ut]||ut}const ke={on(ut,Y,Me,dt){je(ut,Y,Me,dt,!1)},one(ut,Y,Me,dt){je(ut,Y,Me,dt,!0)},off(ut,Y,Me,dt){if(typeof Y!="string"||!ut)return;const[Ht,di,Ti]=Pe(Y,Me,dt),yn=Ti!==Y,pr=ce(ut),Ms=pr[Ti]||{},ji=Y.startsWith(".");if(di===void 0){if(ji)for(const Js of Object.keys(pr))qe(ut,pr,Js,Y.slice(1));for(const[Js,Fa]of Object.entries(Ms)){const ha=Js.replace(z,"");yn&&!Y.includes(ha)||Fe(ut,pr,Ti,Fa.callable,Fa.delegationSelector)}}else{if(!Object.keys(Ms).length)return;Fe(ut,pr,Ti,di,Ht?Me:null)}},trigger(ut,Y,Me){if(typeof Y!="string"||!ut)return null;const dt=C();let Ht=null,di=!0,Ti=!0,yn=!1;Y!==Ue(Y)&&dt&&(Ht=dt.Event(Y,Me),dt(ut).trigger(Ht),di=!Ht.isPropagationStopped(),Ti=!Ht.isImmediatePropagationStopped(),yn=Ht.isDefaultPrevented());const pr=et(new Event(Y,{bubbles:di,cancelable:!0}),Me);return yn&&pr.preventDefault(),Ti&&ut.dispatchEvent(pr),pr.defaultPrevented&&Ht&&Ht.preventDefault(),pr}};function et(ut,Y={}){for(const[Me,dt]of Object.entries(Y))try{ut[Me]=dt}catch{Object.defineProperty(ut,Me,{configurable:!0,get:()=>dt})}return ut}function ye(ut){if(ut==="true")return!0;if(ut==="false")return!1;if(ut===Number(ut).toString())return Number(ut);if(ut===""||ut==="null")return null;if(typeof ut!="string")return ut;try{return JSON.parse(decodeURIComponent(ut))}catch{return ut}}function Be(ut){return ut.replace(/[A-Z]/g,Y=>`-${Y.toLowerCase()}`)}const Je={setDataAttribute(ut,Y,Me){ut.setAttribute(`data-bs-${Be(Y)}`,Me)},removeDataAttribute(ut,Y){ut.removeAttribute(`data-bs-${Be(Y)}`)},getDataAttributes(ut){if(!ut)return{};const Y={},Me=Object.keys(ut.dataset).filter(dt=>dt.startsWith("bs")&&!dt.startsWith("bsConfig"));for(const dt of Me){let Ht=dt.replace(/^bs/,"");Ht=Ht.charAt(0).toLowerCase()+Ht.slice(1),Y[Ht]=ye(ut.dataset[dt])}return Y},getDataAttribute:(ut,Y)=>ye(ut.getAttribute(`data-bs-${Be(Y)}`))};class ct{static get Default(){return{}}static get DefaultType(){return{}}static get NAME(){throw new Error('You have to implement the static method "NAME", for each component!')}_getConfig(Y){return Y=this._mergeConfigObj(Y),Y=this._configAfterMerge(Y),this._typeCheckConfig(Y),Y}_configAfterMerge(Y){return Y}_mergeConfigObj(Y,Me){const dt=_(Me)?Je.getDataAttribute(Me,"config"):{};return{...this.constructor.Default,...typeof dt=="object"?dt:{},..._(Me)?Je.getDataAttributes(Me):{},...typeof Y=="object"?Y:{}}}_typeCheckConfig(Y,Me=this.constructor.DefaultType){for(const[dt,Ht]of Object.entries(Me)){const di=Y[dt],Ti=_(di)?"element":p(di);if(!new RegExp(Ht).test(Ti))throw new TypeError(`${this.constructor.NAME.toUpperCase()}: Option "${dt}" provided type "${Ti}" but expected type "${Ht}".`)}}}class yt extends ct{constructor(Y,Me){super(),(Y=x(Y))&&(this._element=Y,this._config=this._getConfig(Me),c.set(this._element,this.constructor.DATA_KEY,this))}dispose(){c.remove(this._element,this.constructor.DATA_KEY),ke.off(this._element,this.constructor.EVENT_KEY);for(const Y of Object.getOwnPropertyNames(this))this[Y]=null}_queueCallback(Y,Me,dt=!0){G(Y,Me,dt)}_getConfig(Y){return Y=this._mergeConfigObj(Y,this._element),Y=this._configAfterMerge(Y),this._typeCheckConfig(Y),Y}static getInstance(Y){return c.get(x(Y),this.DATA_KEY)}static getOrCreateInstance(Y,Me={}){return this.getInstance(Y)||new this(Y,typeof Me=="object"?Me:null)}static get VERSION(){return"5.3.8"}static get DATA_KEY(){return`bs.${this.NAME}`}static get EVENT_KEY(){return`.${this.DATA_KEY}`}static eventName(Y){return`${Y}${this.EVENT_KEY}`}}const we=ut=>{let Y=ut.getAttribute("data-bs-target");if(!Y||Y==="#"){let Me=ut.getAttribute("href");if(!Me||!Me.includes("#")&&!Me.startsWith("."))return null;Me.includes("#")&&!Me.startsWith("#")&&(Me=`#${Me.split("#")[1]}`),Y=Me&&Me!=="#"?Me.trim():null}return Y?Y.split(",").map(Me=>d(Me)).join(","):null},fe={find:(ut,Y=document.documentElement)=>[].concat(...Element.prototype.querySelectorAll.call(Y,ut)),findOne:(ut,Y=document.documentElement)=>Element.prototype.querySelector.call(Y,ut),children:(ut,Y)=>[].concat(...ut.children).filter(Me=>Me.matches(Y)),parents(ut,Y){const Me=[];let dt=ut.parentNode.closest(Y);for(;dt;)Me.push(dt),dt=dt.parentNode.closest(Y);return Me},prev(ut,Y){let Me=ut.previousElementSibling;for(;Me;){if(Me.matches(Y))return[Me];Me=Me.previousElementSibling}return[]},next(ut,Y){let Me=ut.nextElementSibling;for(;Me;){if(Me.matches(Y))return[Me];Me=Me.nextElementSibling}return[]},focusableChildren(ut){const Y=["a","button","input","textarea","select","details","[tabindex]",'[contenteditable="true"]'].map(Me=>`${Me}:not([tabindex^="-"])`).join(",");return this.find(Y,ut).filter(Me=>!S(Me)&&b(Me))},getSelectorFromElement(ut){const Y=we(ut);return Y&&fe.findOne(Y)?Y:null},getElementFromSelector(ut){const Y=we(ut);return Y?fe.findOne(Y):null},getMultipleElementsFromSelector(ut){const Y=we(ut);return Y?fe.find(Y):[]}},Ve=(ut,Y="hide")=>{const Me=`click.dismiss${ut.EVENT_KEY}`,dt=ut.NAME;ke.on(document,Me,`[data-bs-dismiss="${dt}"]`,function(Ht){if(["A","AREA"].includes(this.tagName)&&Ht.preventDefault(),S(this))return;const di=fe.getElementFromSelector(this)||this.closest(`.${dt}`);ut.getOrCreateInstance(di)[Y]()})},tt=".bs.alert",Mt=`close${tt}`,mt=`closed${tt}`;class Ce extends yt{static get NAME(){return"alert"}close(){if(ke.trigger(this._element,Mt).defaultPrevented)return;this._element.classList.remove("show");const Y=this._element.classList.contains("fade");this._queueCallback(()=>this._destroyElement(),this._element,Y)}_destroyElement(){this._element.remove(),ke.trigger(this._element,mt),this.dispose()}static jQueryInterface(Y){return this.each(function(){const Me=Ce.getOrCreateInstance(this);if(typeof Y=="string"){if(Me[Y]===void 0||Y.startsWith("_")||Y==="constructor")throw new TypeError(`No method named "${Y}"`);Me[Y](this)}})}}Ve(Ce,"close"),U(Ce);const xe='[data-bs-toggle="button"]';class vt extends yt{static get NAME(){return"button"}toggle(){this._element.setAttribute("aria-pressed",this._element.classList.toggle("active"))}static jQueryInterface(Y){return this.each(function(){const Me=vt.getOrCreateInstance(this);Y==="toggle"&&Me[Y]()})}}ke.on(document,"click.bs.button.data-api",xe,ut=>{ut.preventDefault();const Y=ut.target.closest(xe);vt.getOrCreateInstance(Y).toggle()}),U(vt);const be=".bs.swipe",ie=`touchstart${be}`,ae=`touchmove${be}`,De=`touchend${be}`,Xe=`pointerdown${be}`,bt=`pointerup${be}`,Te={endCallback:null,leftCallback:null,rightCallback:null},te={endCallback:"(function|null)",leftCallback:"(function|null)",rightCallback:"(function|null)"};class he extends ct{constructor(Y,Me){super(),this._element=Y,Y&&he.isSupported()&&(this._config=this._getConfig(Me),this._deltaX=0,this._supportPointerEvents=!!window.PointerEvent,this._initEvents())}static get Default(){return Te}static get DefaultType(){return te}static get NAME(){return"swipe"}dispose(){ke.off(this._element,be)}_start(Y){this._supportPointerEvents?this._eventIsPointerPenTouch(Y)&&(this._deltaX=Y.clientX):this._deltaX=Y.touches[0].clientX}_end(Y){this._eventIsPointerPenTouch(Y)&&(this._deltaX=Y.clientX-this._deltaX),this._handleSwipe(),j(this._config.endCallback)}_move(Y){this._deltaX=Y.touches&&Y.touches.length>1?0:Y.touches[0].clientX-this._deltaX}_handleSwipe(){const Y=Math.abs(this._deltaX);if(Y<=40)return;const Me=Y/this._deltaX;this._deltaX=0,Me&&j(Me>0?this._config.rightCallback:this._config.leftCallback)}_initEvents(){this._supportPointerEvents?(ke.on(this._element,Xe,Y=>this._start(Y)),ke.on(this._element,bt,Y=>this._end(Y)),this._element.classList.add("pointer-event")):(ke.on(this._element,ie,Y=>this._start(Y)),ke.on(this._element,ae,Y=>this._move(Y)),ke.on(this._element,De,Y=>this._end(Y)))}_eventIsPointerPenTouch(Y){return this._supportPointerEvents&&(Y.pointerType==="pen"||Y.pointerType==="touch")}static isSupported(){return"ontouchstart"in document.documentElement||navigator.maxTouchPoints>0}}const pe=".bs.carousel",Re=".data-api",Oe="ArrowLeft",ht="ArrowRight",pt="next",ot="prev",St="left",Lt="right",zt=`slide${pe}`,Jt=`slid${pe}`,gi=`keydown${pe}`,Fi=`mouseenter${pe}`,un=`mouseleave${pe}`,nn=`dragstart${pe}`,Tt=`load${pe}${Re}`,hn=`click${pe}${Re}`,fr="carousel",Li="active",gn=".active",zn=".carousel-item",wn=gn+zn,kn={[Oe]:Lt,[ht]:St},Sn={interval:5e3,keyboard:!0,pause:"hover",ride:!1,touch:!0,wrap:!0},Kn={interval:"(number|boolean)",keyboard:"boolean",pause:"(string|boolean)",ride:"(boolean|string)",touch:"boolean",wrap:"boolean"};class Ye extends yt{constructor(Y,Me){super(Y,Me),this._interval=null,this._activeElement=null,this._isSliding=!1,this.touchTimeout=null,this._swipeHelper=null,this._indicatorsElement=fe.findOne(".carousel-indicators",this._element),this._addEventListeners(),this._config.ride===fr&&this.cycle()}static get Default(){return Sn}static get DefaultType(){return Kn}static get NAME(){return"carousel"}next(){this._slide(pt)}nextWhenVisible(){!document.hidden&&b(this._element)&&this.next()}prev(){this._slide(ot)}pause(){this._isSliding&&g(this._element),this._clearInterval()}cycle(){this._clearInterval(),this._updateInterval(),this._interval=setInterval(()=>this.nextWhenVisible(),this._config.interval)}_maybeEnableCycle(){this._config.ride&&(this._isSliding?ke.one(this._element,Jt,()=>this.cycle()):this.cycle())}to(Y){const Me=this._getItems();if(Y>Me.length-1||Y<0)return;if(this._isSliding)return void ke.one(this._element,Jt,()=>this.to(Y));const dt=this._getItemIndex(this._getActive());if(dt===Y)return;const Ht=Y>dt?pt:ot;this._slide(Ht,Me[Y])}dispose(){this._swipeHelper&&this._swipeHelper.dispose(),super.dispose()}_configAfterMerge(Y){return Y.defaultInterval=Y.interval,Y}_addEventListeners(){this._config.keyboard&&ke.on(this._element,gi,Y=>this._keydown(Y)),this._config.pause==="hover"&&(ke.on(this._element,Fi,()=>this.pause()),ke.on(this._element,un,()=>this._maybeEnableCycle())),this._config.touch&&he.isSupported()&&this._addTouchEventListeners()}_addTouchEventListeners(){for(const Me of fe.find(".carousel-item img",this._element))ke.on(Me,nn,dt=>dt.preventDefault());const Y={leftCallback:()=>this._slide(this._directionToOrder(St)),rightCallback:()=>this._slide(this._directionToOrder(Lt)),endCallback:()=>{this._config.pause==="hover"&&(this.pause(),this.touchTimeout&&clearTimeout(this.touchTimeout),this.touchTimeout=setTimeout(()=>this._maybeEnableCycle(),500+this._config.interval))}};this._swipeHelper=new he(this._element,Y)}_keydown(Y){if(/input|textarea/i.test(Y.target.tagName))return;const Me=kn[Y.key];Me&&(Y.preventDefault(),this._slide(this._directionToOrder(Me)))}_getItemIndex(Y){return this._getItems().indexOf(Y)}_setActiveIndicatorElement(Y){if(!this._indicatorsElement)return;const Me=fe.findOne(gn,this._indicatorsElement);Me.classList.remove(Li),Me.removeAttribute("aria-current");const dt=fe.findOne(`[data-bs-slide-to="${Y}"]`,this._indicatorsElement);dt&&(dt.classList.add(Li),dt.setAttribute("aria-current","true"))}_updateInterval(){const Y=this._activeElement||this._getActive();if(!Y)return;const Me=Number.parseInt(Y.getAttribute("data-bs-interval"),10);this._config.interval=Me||this._config.defaultInterval}_slide(Y,Me=null){if(this._isSliding)return;const dt=this._getActive(),Ht=Y===pt,di=Me||N(this._getItems(),dt,Ht,this._config.wrap);if(di===dt)return;const Ti=this._getItemIndex(di),yn=Js=>ke.trigger(this._element,Js,{relatedTarget:di,direction:this._orderToDirection(Y),from:this._getItemIndex(dt),to:Ti});if(yn(zt).defaultPrevented||!dt||!di)return;const pr=!!this._interval;this.pause(),this._isSliding=!0,this._setActiveIndicatorElement(Ti),this._activeElement=di;const Ms=Ht?"carousel-item-start":"carousel-item-end",ji=Ht?"carousel-item-next":"carousel-item-prev";di.classList.add(ji),E(di),dt.classList.add(Ms),di.classList.add(Ms),this._queueCallback(()=>{di.classList.remove(Ms,ji),di.classList.add(Li),dt.classList.remove(Li,ji,Ms),this._isSliding=!1,yn(Jt)},dt,this._isAnimated()),pr&&this.cycle()}_isAnimated(){return this._element.classList.contains("slide")}_getActive(){return fe.findOne(wn,this._element)}_getItems(){return fe.find(zn,this._element)}_clearInterval(){this._interval&&(clearInterval(this._interval),this._interval=null)}_directionToOrder(Y){return O()?Y===St?ot:pt:Y===St?pt:ot}_orderToDirection(Y){return O()?Y===ot?St:Lt:Y===ot?Lt:St}static jQueryInterface(Y){return this.each(function(){const Me=Ye.getOrCreateInstance(this,Y);if(typeof Y!="number"){if(typeof Y=="string"){if(Me[Y]===void 0||Y.startsWith("_")||Y==="constructor")throw new TypeError(`No method named "${Y}"`);Me[Y]()}}else Me.to(Y)})}}ke.on(document,hn,"[data-bs-slide], [data-bs-slide-to]",function(ut){const Y=fe.getElementFromSelector(this);if(!Y||!Y.classList.contains(fr))return;ut.preventDefault();const Me=Ye.getOrCreateInstance(Y),dt=this.getAttribute("data-bs-slide-to");return dt?(Me.to(dt),void Me._maybeEnableCycle()):Je.getDataAttribute(this,"slide")==="next"?(Me.next(),void Me._maybeEnableCycle()):(Me.prev(),void Me._maybeEnableCycle())}),ke.on(window,Tt,()=>{const ut=fe.find('[data-bs-ride="carousel"]');for(const Y of ut)Ye.getOrCreateInstance(Y)}),U(Ye);const kt=".bs.collapse",at=`show${kt}`,Ot=`shown${kt}`,Gt=`hide${kt}`,Gi=`hidden${kt}`,Ci=`click${kt}.data-api`,Nt="show",si="collapse",pi="collapsing",Wi=`:scope .${si} .${si}`,wt='[data-bs-toggle="collapse"]',Ri={parent:null,toggle:!0},bi={parent:"(null|element)",toggle:"boolean"};class Vi extends yt{constructor(Y,Me){super(Y,Me),this._isTransitioning=!1,this._triggerArray=[];const dt=fe.find(wt);for(const Ht of dt){const di=fe.getSelectorFromElement(Ht),Ti=fe.find(di).filter(yn=>yn===this._element);di!==null&&Ti.length&&this._triggerArray.push(Ht)}this._initializeChildren(),this._config.parent||this._addAriaAndCollapsedClass(this._triggerArray,this._isShown()),this._config.toggle&&this.toggle()}static get Default(){return Ri}static get DefaultType(){return bi}static get NAME(){return"collapse"}toggle(){this._isShown()?this.hide():this.show()}show(){if(this._isTransitioning||this._isShown())return;let Y=[];if(this._config.parent&&(Y=this._getFirstLevelChildren(".collapse.show, .collapse.collapsing").filter(Ht=>Ht!==this._element).map(Ht=>Vi.getOrCreateInstance(Ht,{toggle:!1}))),Y.length&&Y[0]._isTransitioning||ke.trigger(this._element,at).defaultPrevented)return;for(const Ht of Y)Ht.hide();const Me=this._getDimension();this._element.classList.remove(si),this._element.classList.add(pi),this._element.style[Me]=0,this._addAriaAndCollapsedClass(this._triggerArray,!0),this._isTransitioning=!0;const dt=`scroll${Me[0].toUpperCase()+Me.slice(1)}`;this._queueCallback(()=>{this._isTransitioning=!1,this._element.classList.remove(pi),this._element.classList.add(si,Nt),this._element.style[Me]="",ke.trigger(this._element,Ot)},this._element,!0),this._element.style[Me]=`${this._element[dt]}px`}hide(){if(this._isTransitioning||!this._isShown()||ke.trigger(this._element,Gt).defaultPrevented)return;const Y=this._getDimension();this._element.style[Y]=`${this._element.getBoundingClientRect()[Y]}px`,E(this._element),this._element.classList.add(pi),this._element.classList.remove(si,Nt);for(const Me of this._triggerArray){const dt=fe.getElementFromSelector(Me);dt&&!this._isShown(dt)&&this._addAriaAndCollapsedClass([Me],!1)}this._isTransitioning=!0,this._element.style[Y]="",this._queueCallback(()=>{this._isTransitioning=!1,this._element.classList.remove(pi),this._element.classList.add(si),ke.trigger(this._element,Gi)},this._element,!0)}_isShown(Y=this._element){return Y.classList.contains(Nt)}_configAfterMerge(Y){return Y.toggle=!!Y.toggle,Y.parent=x(Y.parent),Y}_getDimension(){return this._element.classList.contains("collapse-horizontal")?"width":"height"}_initializeChildren(){if(!this._config.parent)return;const Y=this._getFirstLevelChildren(wt);for(const Me of Y){const dt=fe.getElementFromSelector(Me);dt&&this._addAriaAndCollapsedClass([Me],this._isShown(dt))}}_getFirstLevelChildren(Y){const Me=fe.find(Wi,this._config.parent);return fe.find(Y,this._config.parent).filter(dt=>!Me.includes(dt))}_addAriaAndCollapsedClass(Y,Me){if(Y.length)for(const dt of Y)dt.classList.toggle("collapsed",!Me),dt.setAttribute("aria-expanded",Me)}static jQueryInterface(Y){const Me={};return typeof Y=="string"&&/show|hide/.test(Y)&&(Me.toggle=!1),this.each(function(){const dt=Vi.getOrCreateInstance(this,Me);if(typeof Y=="string"){if(dt[Y]===void 0)throw new TypeError(`No method named "${Y}"`);dt[Y]()}})}}ke.on(document,Ci,wt,function(ut){(ut.target.tagName==="A"||ut.delegateTarget&&ut.delegateTarget.tagName==="A")&&ut.preventDefault();for(const Y of fe.getMultipleElementsFromSelector(this))Vi.getOrCreateInstance(Y,{toggle:!1}).toggle()}),U(Vi);const Jn="dropdown",Xi=".bs.dropdown",Gn=".data-api",on="ArrowUp",zr="ArrowDown",qn=`hide${Xi}`,an=`hidden${Xi}`,rn=`show${Xi}`,ns=`shown${Xi}`,so=`click${Xi}${Gn}`,pl=`keydown${Xi}${Gn}`,To=`keyup${Xi}${Gn}`,Ar="show",rr='[data-bs-toggle="dropdown"]:not(.disabled):not(:disabled)',Hl=`${rr}.${Ar}`,Zl=".dropdown-menu",vr=O()?"top-end":"top-start",Ip=O()?"top-start":"top-end",Rp=O()?"bottom-end":"bottom-start",Mu=O()?"bottom-start":"bottom-end",Lp=O()?"left-start":"right-start",kp=O()?"right-start":"left-start",Dp={autoClose:!0,boundary:"clippingParents",display:"dynamic",offset:[0,2],popperConfig:null,reference:"toggle"},Oh={autoClose:"(boolean|string)",boundary:"(string|element)",display:"string",offset:"(array|string|function)",popperConfig:"(null|object|function)",reference:"(string|element|object)"};class oo extends yt{constructor(Y,Me){super(Y,Me),this._popper=null,this._parent=this._element.parentNode,this._menu=fe.next(this._element,Zl)[0]||fe.prev(this._element,Zl)[0]||fe.findOne(Zl,this._parent),this._inNavbar=this._detectNavbar()}static get Default(){return Dp}static get DefaultType(){return Oh}static get NAME(){return Jn}toggle(){return this._isShown()?this.hide():this.show()}show(){if(S(this._element)||this._isShown())return;const Y={relatedTarget:this._element};if(!ke.trigger(this._element,rn,Y).defaultPrevented){if(this._createPopper(),"ontouchstart"in document.documentElement&&!this._parent.closest(".navbar-nav"))for(const Me of[].concat(...document.body.children))ke.on(Me,"mouseover",L);this._element.focus(),this._element.setAttribute("aria-expanded",!0),this._menu.classList.add(Ar),this._element.classList.add(Ar),ke.trigger(this._element,ns,Y)}}hide(){if(S(this._element)||!this._isShown())return;const Y={relatedTarget:this._element};this._completeHide(Y)}dispose(){this._popper&&this._popper.destroy(),super.dispose()}update(){this._inNavbar=this._detectNavbar(),this._popper&&this._popper.update()}_completeHide(Y){if(!ke.trigger(this._element,qn,Y).defaultPrevented){if("ontouchstart"in document.documentElement)for(const Me of[].concat(...document.body.children))ke.off(Me,"mouseover",L);this._popper&&this._popper.destroy(),this._menu.classList.remove(Ar),this._element.classList.remove(Ar),this._element.setAttribute("aria-expanded","false"),Je.removeDataAttribute(this._menu,"popper"),ke.trigger(this._element,an,Y)}}_getConfig(Y){if(typeof(Y=super._getConfig(Y)).reference=="object"&&!_(Y.reference)&&typeof Y.reference.getBoundingClientRect!="function")throw new TypeError(`${Jn.toUpperCase()}: Option "reference" provided type "object" without a required "getBoundingClientRect" method.`);return Y}_createPopper(){if(r===void 0)throw new TypeError("Bootstrap's dropdowns require Popper (https://popper.js.org/docs/v2/)");let Y=this._element;this._config.reference==="parent"?Y=this._parent:_(this._config.reference)?Y=x(this._config.reference):typeof this._config.reference=="object"&&(Y=this._config.reference);const Me=this._getPopperConfig();this._popper=r.createPopper(Y,this._menu,Me)}_isShown(){return this._menu.classList.contains(Ar)}_getPlacement(){const Y=this._parent;if(Y.classList.contains("dropend"))return Lp;if(Y.classList.contains("dropstart"))return kp;if(Y.classList.contains("dropup-center"))return"top";if(Y.classList.contains("dropdown-center"))return"bottom";const Me=getComputedStyle(this._menu).getPropertyValue("--bs-position").trim()==="end";return Y.classList.contains("dropup")?Me?Ip:vr:Me?Mu:Rp}_detectNavbar(){return this._element.closest(".navbar")!==null}_getOffset(){const{offset:Y}=this._config;return typeof Y=="string"?Y.split(",").map(Me=>Number.parseInt(Me,10)):typeof Y=="function"?Me=>Y(Me,this._element):Y}_getPopperConfig(){const Y={placement:this._getPlacement(),modifiers:[{name:"preventOverflow",options:{boundary:this._config.boundary}},{name:"offset",options:{offset:this._getOffset()}}]};return(this._inNavbar||this._config.display==="static")&&(Je.setDataAttribute(this._menu,"popper","static"),Y.modifiers=[{name:"applyStyles",enabled:!1}]),{...Y,...j(this._config.popperConfig,[void 0,Y])}}_selectMenuItem({key:Y,target:Me}){const dt=fe.find(".dropdown-menu .dropdown-item:not(.disabled):not(:disabled)",this._menu).filter(Ht=>b(Ht));dt.length&&N(dt,Me,Y===zr,!dt.includes(Me)).focus()}static jQueryInterface(Y){return this.each(function(){const Me=oo.getOrCreateInstance(this,Y);if(typeof Y=="string"){if(Me[Y]===void 0)throw new TypeError(`No method named "${Y}"`);Me[Y]()}})}static clearMenus(Y){if(Y.button===2||Y.type==="keyup"&&Y.key!=="Tab")return;const Me=fe.find(Hl);for(const dt of Me){const Ht=oo.getInstance(dt);if(!Ht||Ht._config.autoClose===!1)continue;const di=Y.composedPath(),Ti=di.includes(Ht._menu);if(di.includes(Ht._element)||Ht._config.autoClose==="inside"&&!Ti||Ht._config.autoClose==="outside"&&Ti||Ht._menu.contains(Y.target)&&(Y.type==="keyup"&&Y.key==="Tab"||/input|select|option|textarea|form/i.test(Y.target.tagName)))continue;const yn={relatedTarget:Ht._element};Y.type==="click"&&(yn.clickEvent=Y),Ht._completeHide(yn)}}static dataApiKeydownHandler(Y){const Me=/input|textarea/i.test(Y.target.tagName),dt=Y.key==="Escape",Ht=[on,zr].includes(Y.key);if(!Ht&&!dt||Me&&!dt)return;Y.preventDefault();const di=this.matches(rr)?this:fe.prev(this,rr)[0]||fe.next(this,rr)[0]||fe.findOne(rr,Y.delegateTarget.parentNode),Ti=oo.getOrCreateInstance(di);if(Ht)return Y.stopPropagation(),Ti.show(),void Ti._selectMenuItem(Y);Ti._isShown()&&(Y.stopPropagation(),Ti.hide(),di.focus())}}ke.on(document,pl,rr,oo.dataApiKeydownHandler),ke.on(document,pl,Zl,oo.dataApiKeydownHandler),ke.on(document,so,oo.clearMenus),ke.on(document,To,oo.clearMenus),ke.on(document,so,rr,function(ut){ut.preventDefault(),oo.getOrCreateInstance(this).toggle()}),U(oo);const zh="backdrop",Bh="show",Nh=`mousedown.bs.${zh}`,y_={className:"modal-backdrop",clickCallback:null,isAnimated:!1,isVisible:!0,rootElement:"body"},Cu={className:"string",clickCallback:"(function|null)",isAnimated:"boolean",isVisible:"boolean",rootElement:"(element|string)"};class Eu extends ct{constructor(Y){super(),this._config=this._getConfig(Y),this._isAppended=!1,this._element=null}static get Default(){return y_}static get DefaultType(){return Cu}static get NAME(){return zh}show(Y){if(!this._config.isVisible)return void j(Y);this._append();const Me=this._getElement();this._config.isAnimated&&E(Me),Me.classList.add(Bh),this._emulateAnimation(()=>{j(Y)})}hide(Y){this._config.isVisible?(this._getElement().classList.remove(Bh),this._emulateAnimation(()=>{this.dispose(),j(Y)})):j(Y)}dispose(){this._isAppended&&(ke.off(this._element,Nh),this._element.remove(),this._isAppended=!1)}_getElement(){if(!this._element){const Y=document.createElement("div");Y.className=this._config.className,this._config.isAnimated&&Y.classList.add("fade"),this._element=Y}return this._element}_configAfterMerge(Y){return Y.rootElement=x(Y.rootElement),Y}_append(){if(this._isAppended)return;const Y=this._getElement();this._config.rootElement.append(Y),ke.on(Y,Nh,()=>{j(this._config.clickCallback)}),this._isAppended=!0}_emulateAnimation(Y){G(Y,this._getElement(),this._config.isAnimated)}}const Au=".bs.focustrap",Lc=`focusin${Au}`,ef=`keydown.tab${Au}`,kc="backward",ml={autofocus:!0,trapElement:null},Dc={autofocus:"boolean",trapElement:"element"};class sn extends ct{constructor(Y){super(),this._config=this._getConfig(Y),this._isActive=!1,this._lastTabNavDirection=null}static get Default(){return ml}static get DefaultType(){return Dc}static get NAME(){return"focustrap"}activate(){this._isActive||(this._config.autofocus&&this._config.trapElement.focus(),ke.off(document,Au),ke.on(document,Lc,Y=>this._handleFocusin(Y)),ke.on(document,ef,Y=>this._handleKeydown(Y)),this._isActive=!0)}deactivate(){this._isActive&&(this._isActive=!1,ke.off(document,Au))}_handleFocusin(Y){const{trapElement:Me}=this._config;if(Y.target===document||Y.target===Me||Me.contains(Y.target))return;const dt=fe.focusableChildren(Me);dt.length===0?Me.focus():this._lastTabNavDirection===kc?dt[dt.length-1].focus():dt[0].focus()}_handleKeydown(Y){Y.key==="Tab"&&(this._lastTabNavDirection=Y.shiftKey?kc:"forward")}}const $h=".fixed-top, .fixed-bottom, .is-fixed, .sticky-top",Fp=".sticky-top",Fc="padding-right",Ns="margin-right";class fs{constructor(){this._element=document.body}getWidth(){const Y=document.documentElement.clientWidth;return Math.abs(window.innerWidth-Y)}hide(){const Y=this.getWidth();this._disableOverFlow(),this._setElementAttributes(this._element,Fc,Me=>Me+Y),this._setElementAttributes($h,Fc,Me=>Me+Y),this._setElementAttributes(Fp,Ns,Me=>Me-Y)}reset(){this._resetElementAttributes(this._element,"overflow"),this._resetElementAttributes(this._element,Fc),this._resetElementAttributes($h,Fc),this._resetElementAttributes(Fp,Ns)}isOverflowing(){return this.getWidth()>0}_disableOverFlow(){this._saveInitialAttribute(this._element,"overflow"),this._element.style.overflow="hidden"}_setElementAttributes(Y,Me,dt){const Ht=this.getWidth();this._applyManipulationCallback(Y,di=>{if(di!==this._element&&window.innerWidth>di.clientWidth+Ht)return;this._saveInitialAttribute(di,Me);const Ti=window.getComputedStyle(di).getPropertyValue(Me);di.style.setProperty(Me,`${dt(Number.parseFloat(Ti))}px`)})}_saveInitialAttribute(Y,Me){const dt=Y.style.getPropertyValue(Me);dt&&Je.setDataAttribute(Y,Me,dt)}_resetElementAttributes(Y,Me){this._applyManipulationCallback(Y,dt=>{const Ht=Je.getDataAttribute(dt,Me);Ht!==null?(Je.removeDataAttribute(dt,Me),dt.style.setProperty(Me,Ht)):dt.style.removeProperty(Me)})}_applyManipulationCallback(Y,Me){if(_(Y))Me(Y);else for(const dt of fe.find(Y,this._element))Me(dt)}}const xn=".bs.modal",qi=`hide${xn}`,Bn=`hidePrevented${xn}`,Ma=`hidden${xn}`,Ss=`show${xn}`,ao=`shown${xn}`,$s=`resize${xn}`,Oc=`click.dismiss${xn}`,gl=`mousedown.dismiss${xn}`,Pr=`keydown.dismiss${xn}`,Xl=`click${xn}.data-api`,Uo="modal-open",Pu="show",Ts="modal-static",Yl={backdrop:!0,focus:!0,keyboard:!0},Ca={backdrop:"(boolean|string)",focus:"boolean",keyboard:"boolean"};class _l extends yt{constructor(Y,Me){super(Y,Me),this._dialog=fe.findOne(".modal-dialog",this._element),this._backdrop=this._initializeBackDrop(),this._focustrap=this._initializeFocusTrap(),this._isShown=!1,this._isTransitioning=!1,this._scrollBar=new fs,this._addEventListeners()}static get Default(){return Yl}static get DefaultType(){return Ca}static get NAME(){return"modal"}toggle(Y){return this._isShown?this.hide():this.show(Y)}show(Y){this._isShown||this._isTransitioning||ke.trigger(this._element,Ss,{relatedTarget:Y}).defaultPrevented||(this._isShown=!0,this._isTransitioning=!0,this._scrollBar.hide(),document.body.classList.add(Uo),this._adjustDialog(),this._backdrop.show(()=>this._showElement(Y)))}hide(){this._isShown&&!this._isTransitioning&&(ke.trigger(this._element,qi).defaultPrevented||(this._isShown=!1,this._isTransitioning=!0,this._focustrap.deactivate(),this._element.classList.remove(Pu),this._queueCallback(()=>this._hideModal(),this._element,this._isAnimated())))}dispose(){ke.off(window,xn),ke.off(this._dialog,xn),this._backdrop.dispose(),this._focustrap.deactivate(),super.dispose()}handleUpdate(){this._adjustDialog()}_initializeBackDrop(){return new Eu({isVisible:!!this._config.backdrop,isAnimated:this._isAnimated()})}_initializeFocusTrap(){return new sn({trapElement:this._element})}_showElement(Y){document.body.contains(this._element)||document.body.append(this._element),this._element.style.display="block",this._element.removeAttribute("aria-hidden"),this._element.setAttribute("aria-modal",!0),this._element.setAttribute("role","dialog"),this._element.scrollTop=0;const Me=fe.findOne(".modal-body",this._dialog);Me&&(Me.scrollTop=0),E(this._element),this._element.classList.add(Pu),this._queueCallback(()=>{this._config.focus&&this._focustrap.activate(),this._isTransitioning=!1,ke.trigger(this._element,ao,{relatedTarget:Y})},this._dialog,this._isAnimated())}_addEventListeners(){ke.on(this._element,Pr,Y=>{Y.key==="Escape"&&(this._config.keyboard?this.hide():this._triggerBackdropTransition())}),ke.on(window,$s,()=>{this._isShown&&!this._isTransitioning&&this._adjustDialog()}),ke.on(this._element,gl,Y=>{ke.one(this._element,Oc,Me=>{this._element===Y.target&&this._element===Me.target&&(this._config.backdrop!=="static"?this._config.backdrop&&this.hide():this._triggerBackdropTransition())})})}_hideModal(){this._element.style.display="none",this._element.setAttribute("aria-hidden",!0),this._element.removeAttribute("aria-modal"),this._element.removeAttribute("role"),this._isTransitioning=!1,this._backdrop.hide(()=>{document.body.classList.remove(Uo),this._resetAdjustments(),this._scrollBar.reset(),ke.trigger(this._element,Ma)})}_isAnimated(){return this._element.classList.contains("fade")}_triggerBackdropTransition(){if(ke.trigger(this._element,Bn).defaultPrevented)return;const Y=this._element.scrollHeight>document.documentElement.clientHeight,Me=this._element.style.overflowY;Me==="hidden"||this._element.classList.contains(Ts)||(Y||(this._element.style.overflowY="hidden"),this._element.classList.add(Ts),this._queueCallback(()=>{this._element.classList.remove(Ts),this._queueCallback(()=>{this._element.style.overflowY=Me},this._dialog)},this._dialog),this._element.focus())}_adjustDialog(){const Y=this._element.scrollHeight>document.documentElement.clientHeight,Me=this._scrollBar.getWidth(),dt=Me>0;if(dt&&!Y){const Ht=O()?"paddingLeft":"paddingRight";this._element.style[Ht]=`${Me}px`}if(!dt&&Y){const Ht=O()?"paddingRight":"paddingLeft";this._element.style[Ht]=`${Me}px`}}_resetAdjustments(){this._element.style.paddingLeft="",this._element.style.paddingRight=""}static jQueryInterface(Y,Me){return this.each(function(){const dt=_l.getOrCreateInstance(this,Y);if(typeof Y=="string"){if(dt[Y]===void 0)throw new TypeError(`No method named "${Y}"`);dt[Y](Me)}})}}ke.on(document,Xl,'[data-bs-toggle="modal"]',function(ut){const Y=fe.getElementFromSelector(this);["A","AREA"].includes(this.tagName)&&ut.preventDefault(),ke.one(Y,Ss,dt=>{dt.defaultPrevented||ke.one(Y,Ma,()=>{b(this)&&this.focus()})});const Me=fe.findOne(".modal.show");Me&&_l.getInstance(Me).hide(),_l.getOrCreateInstance(Y).toggle(this)}),Ve(_l),U(_l);const jo=".bs.offcanvas",vl=".data-api",Nn=`load${jo}${vl}`,Kl="show",_n="showing",Ji="hiding",Jl=".offcanvas.show",bn=`show${jo}`,Iu=`shown${jo}`,Mo=`hide${jo}`,Ql=`hidePrevented${jo}`,Ea=`hidden${jo}`,Op=`resize${jo}`,Ru=`click${jo}${vl}`,tf=`keydown.dismiss${jo}`,b_={backdrop:!0,keyboard:!0,scroll:!1},zp={backdrop:"(boolean|string)",keyboard:"boolean",scroll:"boolean"};class yr extends yt{constructor(Y,Me){super(Y,Me),this._isShown=!1,this._backdrop=this._initializeBackDrop(),this._focustrap=this._initializeFocusTrap(),this._addEventListeners()}static get Default(){return b_}static get DefaultType(){return zp}static get NAME(){return"offcanvas"}toggle(Y){return this._isShown?this.hide():this.show(Y)}show(Y){this._isShown||ke.trigger(this._element,bn,{relatedTarget:Y}).defaultPrevented||(this._isShown=!0,this._backdrop.show(),this._config.scroll||new fs().hide(),this._element.setAttribute("aria-modal",!0),this._element.setAttribute("role","dialog"),this._element.classList.add(_n),this._queueCallback(()=>{this._config.scroll&&!this._config.backdrop||this._focustrap.activate(),this._element.classList.add(Kl),this._element.classList.remove(_n),ke.trigger(this._element,Iu,{relatedTarget:Y})},this._element,!0))}hide(){this._isShown&&(ke.trigger(this._element,Mo).defaultPrevented||(this._focustrap.deactivate(),this._element.blur(),this._isShown=!1,this._element.classList.add(Ji),this._backdrop.hide(),this._queueCallback(()=>{this._element.classList.remove(Kl,Ji),this._element.removeAttribute("aria-modal"),this._element.removeAttribute("role"),this._config.scroll||new fs().reset(),ke.trigger(this._element,Ea)},this._element,!0)))}dispose(){this._backdrop.dispose(),this._focustrap.deactivate(),super.dispose()}_initializeBackDrop(){const Y=!!this._config.backdrop;return new Eu({className:"offcanvas-backdrop",isVisible:Y,isAnimated:!0,rootElement:this._element.parentNode,clickCallback:Y?()=>{this._config.backdrop!=="static"?this.hide():ke.trigger(this._element,Ql)}:null})}_initializeFocusTrap(){return new sn({trapElement:this._element})}_addEventListeners(){ke.on(this._element,tf,Y=>{Y.key==="Escape"&&(this._config.keyboard?this.hide():ke.trigger(this._element,Ql))})}static jQueryInterface(Y){return this.each(function(){const Me=yr.getOrCreateInstance(this,Y);if(typeof Y=="string"){if(Me[Y]===void 0||Y.startsWith("_")||Y==="constructor")throw new TypeError(`No method named "${Y}"`);Me[Y](this)}})}}ke.on(document,Ru,'[data-bs-toggle="offcanvas"]',function(ut){const Y=fe.getElementFromSelector(this);if(["A","AREA"].includes(this.tagName)&&ut.preventDefault(),S(this))return;ke.one(Y,Ea,()=>{b(this)&&this.focus()});const Me=fe.findOne(Jl);Me&&Me!==Y&&yr.getInstance(Me).hide(),yr.getOrCreateInstance(Y).toggle(this)}),ke.on(window,Nn,()=>{for(const ut of fe.find(Jl))yr.getOrCreateInstance(ut).show()}),ke.on(window,Op,()=>{for(const ut of fe.find("[aria-modal][class*=show][class*=offcanvas-]"))getComputedStyle(ut).position!=="fixed"&&yr.getOrCreateInstance(ut).hide()}),Ve(yr),U(yr);const Go={"*":["class","dir","id","lang","role",/^aria-[\w-]*$/i],a:["target","href","title","rel"],area:[],b:[],br:[],col:[],code:[],dd:[],div:[],dl:[],dt:[],em:[],hr:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],i:[],img:["src","srcset","alt","title","width","height"],li:[],ol:[],p:[],pre:[],s:[],small:[],span:[],sub:[],sup:[],strong:[],u:[],ul:[]},sr=new Set(["background","cite","href","itemtype","longdesc","poster","src","xlink:href"]),ec=/^(?!javascript:)(?:[a-z0-9+.-]+:|[^&:/?#]*(?:[/?#]|$))/i,nf=(ut,Y)=>{const Me=ut.nodeName.toLowerCase();return Y.includes(Me)?!sr.has(Me)||!!ec.test(ut.nodeValue):Y.filter(dt=>dt instanceof RegExp).some(dt=>dt.test(Me))},Lu={allowList:Go,content:{},extraClass:"",html:!1,sanitize:!0,sanitizeFn:null,template:"<div></div>"},br={allowList:"object",content:"object",extraClass:"(string|function)",html:"boolean",sanitize:"boolean",sanitizeFn:"(null|function)",template:"string"},Bp={entry:"(string|element|function|null)",selector:"(string|element)"};class rf extends ct{constructor(Y){super(),this._config=this._getConfig(Y)}static get Default(){return Lu}static get DefaultType(){return br}static get NAME(){return"TemplateFactory"}getContent(){return Object.values(this._config.content).map(Y=>this._resolvePossibleFunction(Y)).filter(Boolean)}hasContent(){return this.getContent().length>0}changeContent(Y){return this._checkContent(Y),this._config.content={...this._config.content,...Y},this}toHtml(){const Y=document.createElement("div");Y.innerHTML=this._maybeSanitize(this._config.template);for(const[Ht,di]of Object.entries(this._config.content))this._setContent(Y,di,Ht);const Me=Y.children[0],dt=this._resolvePossibleFunction(this._config.extraClass);return dt&&Me.classList.add(...dt.split(" ")),Me}_typeCheckConfig(Y){super._typeCheckConfig(Y),this._checkContent(Y.content)}_checkContent(Y){for(const[Me,dt]of Object.entries(Y))super._typeCheckConfig({selector:Me,entry:dt},Bp)}_setContent(Y,Me,dt){const Ht=fe.findOne(dt,Y);Ht&&((Me=this._resolvePossibleFunction(Me))?_(Me)?this._putElementInTemplate(x(Me),Ht):this._config.html?Ht.innerHTML=this._maybeSanitize(Me):Ht.textContent=Me:Ht.remove())}_maybeSanitize(Y){return this._config.sanitize?(function(Me,dt,Ht){if(!Me.length)return Me;if(Ht&&typeof Ht=="function")return Ht(Me);const di=new window.DOMParser().parseFromString(Me,"text/html"),Ti=[].concat(...di.body.querySelectorAll("*"));for(const yn of Ti){const pr=yn.nodeName.toLowerCase();if(!Object.keys(dt).includes(pr)){yn.remove();continue}const Ms=[].concat(...yn.attributes),ji=[].concat(dt["*"]||[],dt[pr]||[]);for(const Js of Ms)nf(Js,ji)||yn.removeAttribute(Js.nodeName)}return di.body.innerHTML})(Y,this._config.allowList,this._config.sanitizeFn):Y}_resolvePossibleFunction(Y){return j(Y,[void 0,this])}_putElementInTemplate(Y,Me){if(this._config.html)return Me.innerHTML="",void Me.append(Y);Me.textContent=Y.textContent}}const Np=new Set(["sanitize","allowList","sanitizeFn"]),sf="fade",Aa="show",Vh=".tooltip-inner",tc=".modal",Uh="hide.bs.modal",Pa="hover",yl="focus",bl="click",Wr={AUTO:"auto",TOP:"top",RIGHT:O()?"left":"right",BOTTOM:"bottom",LEFT:O()?"right":"left"},$p={allowList:Go,animation:!0,boundary:"clippingParents",container:!1,customClass:"",delay:0,fallbackPlacements:["top","right","bottom","left"],html:!1,offset:[0,6],placement:"top",popperConfig:null,sanitize:!0,sanitizeFn:null,selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',title:"",trigger:"hover focus"},zc={allowList:"object",animation:"boolean",boundary:"(string|element)",container:"(string|element|boolean)",customClass:"(string|function)",delay:"(number|object)",fallbackPlacements:"array",html:"boolean",offset:"(array|string|function)",placement:"(string|function)",popperConfig:"(null|object|function)",sanitize:"boolean",sanitizeFn:"(null|function)",selector:"(string|boolean)",template:"string",title:"(string|element|function)",trigger:"string"};class qo extends yt{constructor(Y,Me){if(r===void 0)throw new TypeError("Bootstrap's tooltips require Popper (https://popper.js.org/docs/v2/)");super(Y,Me),this._isEnabled=!0,this._timeout=0,this._isHovered=null,this._activeTrigger={},this._popper=null,this._templateFactory=null,this._newContent=null,this.tip=null,this._setListeners(),this._config.selector||this._fixTitle()}static get Default(){return $p}static get DefaultType(){return zc}static get NAME(){return"tooltip"}enable(){this._isEnabled=!0}disable(){this._isEnabled=!1}toggleEnabled(){this._isEnabled=!this._isEnabled}toggle(){this._isEnabled&&(this._isShown()?this._leave():this._enter())}dispose(){clearTimeout(this._timeout),ke.off(this._element.closest(tc),Uh,this._hideModalHandler),this._element.getAttribute("data-bs-original-title")&&this._element.setAttribute("title",this._element.getAttribute("data-bs-original-title")),this._disposePopper(),super.dispose()}show(){if(this._element.style.display==="none")throw new Error("Please use show on visible elements");if(!this._isWithContent()||!this._isEnabled)return;const Y=ke.trigger(this._element,this.constructor.eventName("show")),Me=(P(this._element)||this._element.ownerDocument.documentElement).contains(this._element);if(Y.defaultPrevented||!Me)return;this._disposePopper();const dt=this._getTipElement();this._element.setAttribute("aria-describedby",dt.getAttribute("id"));const{container:Ht}=this._config;if(this._element.ownerDocument.documentElement.contains(this.tip)||(Ht.append(dt),ke.trigger(this._element,this.constructor.eventName("inserted"))),this._popper=this._createPopper(dt),dt.classList.add(Aa),"ontouchstart"in document.documentElement)for(const di of[].concat(...document.body.children))ke.on(di,"mouseover",L);this._queueCallback(()=>{ke.trigger(this._element,this.constructor.eventName("shown")),this._isHovered===!1&&this._leave(),this._isHovered=!1},this.tip,this._isAnimated())}hide(){if(this._isShown()&&!ke.trigger(this._element,this.constructor.eventName("hide")).defaultPrevented){if(this._getTipElement().classList.remove(Aa),"ontouchstart"in document.documentElement)for(const Y of[].concat(...document.body.children))ke.off(Y,"mouseover",L);this._activeTrigger[bl]=!1,this._activeTrigger[yl]=!1,this._activeTrigger[Pa]=!1,this._isHovered=null,this._queueCallback(()=>{this._isWithActiveTrigger()||(this._isHovered||this._disposePopper(),this._element.removeAttribute("aria-describedby"),ke.trigger(this._element,this.constructor.eventName("hidden")))},this.tip,this._isAnimated())}}update(){this._popper&&this._popper.update()}_isWithContent(){return!!this._getTitle()}_getTipElement(){return this.tip||(this.tip=this._createTipElement(this._newContent||this._getContentForTemplate())),this.tip}_createTipElement(Y){const Me=this._getTemplateFactory(Y).toHtml();if(!Me)return null;Me.classList.remove(sf,Aa),Me.classList.add(`bs-${this.constructor.NAME}-auto`);const dt=(Ht=>{do Ht+=Math.floor(1e6*Math.random());while(document.getElementById(Ht));return Ht})(this.constructor.NAME).toString();return Me.setAttribute("id",dt),this._isAnimated()&&Me.classList.add(sf),Me}setContent(Y){this._newContent=Y,this._isShown()&&(this._disposePopper(),this.show())}_getTemplateFactory(Y){return this._templateFactory?this._templateFactory.changeContent(Y):this._templateFactory=new rf({...this._config,content:Y,extraClass:this._resolvePossibleFunction(this._config.customClass)}),this._templateFactory}_getContentForTemplate(){return{[Vh]:this._getTitle()}}_getTitle(){return this._resolvePossibleFunction(this._config.title)||this._element.getAttribute("data-bs-original-title")}_initializeOnDelegatedTarget(Y){return this.constructor.getOrCreateInstance(Y.delegateTarget,this._getDelegateConfig())}_isAnimated(){return this._config.animation||this.tip&&this.tip.classList.contains(sf)}_isShown(){return this.tip&&this.tip.classList.contains(Aa)}_createPopper(Y){const Me=j(this._config.placement,[this,Y,this._element]),dt=Wr[Me.toUpperCase()];return r.createPopper(this._element,Y,this._getPopperConfig(dt))}_getOffset(){const{offset:Y}=this._config;return typeof Y=="string"?Y.split(",").map(Me=>Number.parseInt(Me,10)):typeof Y=="function"?Me=>Y(Me,this._element):Y}_resolvePossibleFunction(Y){return j(Y,[this._element,this._element])}_getPopperConfig(Y){const Me={placement:Y,modifiers:[{name:"flip",options:{fallbackPlacements:this._config.fallbackPlacements}},{name:"offset",options:{offset:this._getOffset()}},{name:"preventOverflow",options:{boundary:this._config.boundary}},{name:"arrow",options:{element:`.${this.constructor.NAME}-arrow`}},{name:"preSetPlacement",enabled:!0,phase:"beforeMain",fn:dt=>{this._getTipElement().setAttribute("data-popper-placement",dt.state.placement)}}]};return{...Me,...j(this._config.popperConfig,[void 0,Me])}}_setListeners(){const Y=this._config.trigger.split(" ");for(const Me of Y)if(Me==="click")ke.on(this._element,this.constructor.eventName("click"),this._config.selector,dt=>{const Ht=this._initializeOnDelegatedTarget(dt);Ht._activeTrigger[bl]=!(Ht._isShown()&&Ht._activeTrigger[bl]),Ht.toggle()});else if(Me!=="manual"){const dt=Me===Pa?this.constructor.eventName("mouseenter"):this.constructor.eventName("focusin"),Ht=Me===Pa?this.constructor.eventName("mouseleave"):this.constructor.eventName("focusout");ke.on(this._element,dt,this._config.selector,di=>{const Ti=this._initializeOnDelegatedTarget(di);Ti._activeTrigger[di.type==="focusin"?yl:Pa]=!0,Ti._enter()}),ke.on(this._element,Ht,this._config.selector,di=>{const Ti=this._initializeOnDelegatedTarget(di);Ti._activeTrigger[di.type==="focusout"?yl:Pa]=Ti._element.contains(di.relatedTarget),Ti._leave()})}this._hideModalHandler=()=>{this._element&&this.hide()},ke.on(this._element.closest(tc),Uh,this._hideModalHandler)}_fixTitle(){const Y=this._element.getAttribute("title");Y&&(this._element.getAttribute("aria-label")||this._element.textContent.trim()||this._element.setAttribute("aria-label",Y),this._element.setAttribute("data-bs-original-title",Y),this._element.removeAttribute("title"))}_enter(){this._isShown()||this._isHovered?this._isHovered=!0:(this._isHovered=!0,this._setTimeout(()=>{this._isHovered&&this.show()},this._config.delay.show))}_leave(){this._isWithActiveTrigger()||(this._isHovered=!1,this._setTimeout(()=>{this._isHovered||this.hide()},this._config.delay.hide))}_setTimeout(Y,Me){clearTimeout(this._timeout),this._timeout=setTimeout(Y,Me)}_isWithActiveTrigger(){return Object.values(this._activeTrigger).includes(!0)}_getConfig(Y){const Me=Je.getDataAttributes(this._element);for(const dt of Object.keys(Me))Np.has(dt)&&delete Me[dt];return Y={...Me,...typeof Y=="object"&&Y?Y:{}},Y=this._mergeConfigObj(Y),Y=this._configAfterMerge(Y),this._typeCheckConfig(Y),Y}_configAfterMerge(Y){return Y.container=Y.container===!1?document.body:x(Y.container),typeof Y.delay=="number"&&(Y.delay={show:Y.delay,hide:Y.delay}),typeof Y.title=="number"&&(Y.title=Y.title.toString()),typeof Y.content=="number"&&(Y.content=Y.content.toString()),Y}_getDelegateConfig(){const Y={};for(const[Me,dt]of Object.entries(this._config))this.constructor.Default[Me]!==dt&&(Y[Me]=dt);return Y.selector=!1,Y.trigger="manual",Y}_disposePopper(){this._popper&&(this._popper.destroy(),this._popper=null),this.tip&&(this.tip.remove(),this.tip=null)}static jQueryInterface(Y){return this.each(function(){const Me=qo.getOrCreateInstance(this,Y);if(typeof Y=="string"){if(Me[Y]===void 0)throw new TypeError(`No method named "${Y}"`);Me[Y]()}})}}U(qo);const ic=".popover-header",x_=".popover-body",jh={...qo.Default,content:"",offset:[0,8],placement:"right",template:'<div class="popover" role="tooltip"><div class="popover-arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',trigger:"click"},w_={...qo.DefaultType,content:"(null|string|element|function)"};class Ia extends qo{static get Default(){return jh}static get DefaultType(){return w_}static get NAME(){return"popover"}_isWithContent(){return this._getTitle()||this._getContent()}_getContentForTemplate(){return{[ic]:this._getTitle(),[x_]:this._getContent()}}_getContent(){return this._resolvePossibleFunction(this._config.content)}static jQueryInterface(Y){return this.each(function(){const Me=Ia.getOrCreateInstance(this,Y);if(typeof Y=="string"){if(Me[Y]===void 0)throw new TypeError(`No method named "${Y}"`);Me[Y]()}})}}U(Ia);const Bc=".bs.scrollspy",Vp=`activate${Bc}`,of=`click${Bc}`,af=`load${Bc}.data-api`,xl="active",ku="[href]",lf=".nav-link",Up=`${lf}, .nav-item > ${lf}, .list-group-item`,jp={offset:null,rootMargin:"0px 0px -25%",smoothScroll:!1,target:null,threshold:[.1,.5,1]},nc={offset:"(number|null)",rootMargin:"string",smoothScroll:"boolean",target:"element",threshold:"array"};class Nc extends yt{constructor(Y,Me){super(Y,Me),this._targetLinks=new Map,this._observableSections=new Map,this._rootElement=getComputedStyle(this._element).overflowY==="visible"?null:this._element,this._activeTarget=null,this._observer=null,this._previousScrollData={visibleEntryTop:0,parentScrollTop:0},this.refresh()}static get Default(){return jp}static get DefaultType(){return nc}static get NAME(){return"scrollspy"}refresh(){this._initializeTargetsAndObservables(),this._maybeEnableSmoothScroll(),this._observer?this._observer.disconnect():this._observer=this._getNewObserver();for(const Y of this._observableSections.values())this._observer.observe(Y)}dispose(){this._observer.disconnect(),super.dispose()}_configAfterMerge(Y){return Y.target=x(Y.target)||document.body,Y.rootMargin=Y.offset?`${Y.offset}px 0px -30%`:Y.rootMargin,typeof Y.threshold=="string"&&(Y.threshold=Y.threshold.split(",").map(Me=>Number.parseFloat(Me))),Y}_maybeEnableSmoothScroll(){this._config.smoothScroll&&(ke.off(this._config.target,of),ke.on(this._config.target,of,ku,Y=>{const Me=this._observableSections.get(Y.target.hash);if(Me){Y.preventDefault();const dt=this._rootElement||window,Ht=Me.offsetTop-this._element.offsetTop;if(dt.scrollTo)return void dt.scrollTo({top:Ht,behavior:"smooth"});dt.scrollTop=Ht}}))}_getNewObserver(){const Y={root:this._rootElement,threshold:this._config.threshold,rootMargin:this._config.rootMargin};return new IntersectionObserver(Me=>this._observerCallback(Me),Y)}_observerCallback(Y){const Me=Ti=>this._targetLinks.get(`#${Ti.target.id}`),dt=Ti=>{this._previousScrollData.visibleEntryTop=Ti.target.offsetTop,this._process(Me(Ti))},Ht=(this._rootElement||document.documentElement).scrollTop,di=Ht>=this._previousScrollData.parentScrollTop;this._previousScrollData.parentScrollTop=Ht;for(const Ti of Y){if(!Ti.isIntersecting){this._activeTarget=null,this._clearActiveClass(Me(Ti));continue}const yn=Ti.target.offsetTop>=this._previousScrollData.visibleEntryTop;if(di&&yn){if(dt(Ti),!Ht)return}else di||yn||dt(Ti)}}_initializeTargetsAndObservables(){this._targetLinks=new Map,this._observableSections=new Map;const Y=fe.find(ku,this._config.target);for(const Me of Y){if(!Me.hash||S(Me))continue;const dt=fe.findOne(decodeURI(Me.hash),this._element);b(dt)&&(this._targetLinks.set(decodeURI(Me.hash),Me),this._observableSections.set(Me.hash,dt))}}_process(Y){this._activeTarget!==Y&&(this._clearActiveClass(this._config.target),this._activeTarget=Y,Y.classList.add(xl),this._activateParents(Y),ke.trigger(this._element,Vp,{relatedTarget:Y}))}_activateParents(Y){if(Y.classList.contains("dropdown-item"))fe.findOne(".dropdown-toggle",Y.closest(".dropdown")).classList.add(xl);else for(const Me of fe.parents(Y,".nav, .list-group"))for(const dt of fe.prev(Me,Up))dt.classList.add(xl)}_clearActiveClass(Y){Y.classList.remove(xl);const Me=fe.find(`${ku}.${xl}`,Y);for(const dt of Me)dt.classList.remove(xl)}static jQueryInterface(Y){return this.each(function(){const Me=Nc.getOrCreateInstance(this,Y);if(typeof Y=="string"){if(Me[Y]===void 0||Y.startsWith("_")||Y==="constructor")throw new TypeError(`No method named "${Y}"`);Me[Y]()}})}}ke.on(window,af,()=>{for(const ut of fe.find('[data-bs-spy="scroll"]'))Nc.getOrCreateInstance(ut)}),U(Nc);const Ra=".bs.tab",$c=`hide${Ra}`,Gp=`hidden${Ra}`,Gh=`show${Ra}`,S_=`shown${Ra}`,T_=`click${Ra}`,qp=`keydown${Ra}`,Du=`load${Ra}`,Wp="ArrowLeft",qh="ArrowRight",Hp="ArrowUp",Fu="ArrowDown",lo="Home",Ou="End",La="active",Wh="fade",zu="show",Bu=".dropdown-toggle",ka=`:not(${Bu})`,Hh='[data-bs-toggle="tab"], [data-bs-toggle="pill"], [data-bs-toggle="list"]',cf=`.nav-link${ka}, .list-group-item${ka}, [role="tab"]${ka}, ${Hh}`,Zp=`.${La}[data-bs-toggle="tab"], .${La}[data-bs-toggle="pill"], .${La}[data-bs-toggle="list"]`;class rc extends yt{constructor(Y){super(Y),this._parent=this._element.closest('.list-group, .nav, [role="tablist"]'),this._parent&&(this._setInitialAttributes(this._parent,this._getChildren()),ke.on(this._element,qp,Me=>this._keydown(Me)))}static get NAME(){return"tab"}show(){const Y=this._element;if(this._elemIsActive(Y))return;const Me=this._getActiveElem(),dt=Me?ke.trigger(Me,$c,{relatedTarget:Y}):null;ke.trigger(Y,Gh,{relatedTarget:Me}).defaultPrevented||dt&&dt.defaultPrevented||(this._deactivate(Me,Y),this._activate(Y,Me))}_activate(Y,Me){Y&&(Y.classList.add(La),this._activate(fe.getElementFromSelector(Y)),this._queueCallback(()=>{Y.getAttribute("role")==="tab"?(Y.removeAttribute("tabindex"),Y.setAttribute("aria-selected",!0),this._toggleDropDown(Y,!0),ke.trigger(Y,S_,{relatedTarget:Me})):Y.classList.add(zu)},Y,Y.classList.contains(Wh)))}_deactivate(Y,Me){Y&&(Y.classList.remove(La),Y.blur(),this._deactivate(fe.getElementFromSelector(Y)),this._queueCallback(()=>{Y.getAttribute("role")==="tab"?(Y.setAttribute("aria-selected",!1),Y.setAttribute("tabindex","-1"),this._toggleDropDown(Y,!1),ke.trigger(Y,Gp,{relatedTarget:Me})):Y.classList.remove(zu)},Y,Y.classList.contains(Wh)))}_keydown(Y){if(![Wp,qh,Hp,Fu,lo,Ou].includes(Y.key))return;Y.stopPropagation(),Y.preventDefault();const Me=this._getChildren().filter(Ht=>!S(Ht));let dt;if([lo,Ou].includes(Y.key))dt=Me[Y.key===lo?0:Me.length-1];else{const Ht=[qh,Fu].includes(Y.key);dt=N(Me,Y.target,Ht,!0)}dt&&(dt.focus({preventScroll:!0}),rc.getOrCreateInstance(dt).show())}_getChildren(){return fe.find(cf,this._parent)}_getActiveElem(){return this._getChildren().find(Y=>this._elemIsActive(Y))||null}_setInitialAttributes(Y,Me){this._setAttributeIfNotExists(Y,"role","tablist");for(const dt of Me)this._setInitialAttributesOnChild(dt)}_setInitialAttributesOnChild(Y){Y=this._getInnerElement(Y);const Me=this._elemIsActive(Y),dt=this._getOuterElement(Y);Y.setAttribute("aria-selected",Me),dt!==Y&&this._setAttributeIfNotExists(dt,"role","presentation"),Me||Y.setAttribute("tabindex","-1"),this._setAttributeIfNotExists(Y,"role","tab"),this._setInitialAttributesOnTargetPanel(Y)}_setInitialAttributesOnTargetPanel(Y){const Me=fe.getElementFromSelector(Y);Me&&(this._setAttributeIfNotExists(Me,"role","tabpanel"),Y.id&&this._setAttributeIfNotExists(Me,"aria-labelledby",`${Y.id}`))}_toggleDropDown(Y,Me){const dt=this._getOuterElement(Y);if(!dt.classList.contains("dropdown"))return;const Ht=(di,Ti)=>{const yn=fe.findOne(di,dt);yn&&yn.classList.toggle(Ti,Me)};Ht(Bu,La),Ht(".dropdown-menu",zu),dt.setAttribute("aria-expanded",Me)}_setAttributeIfNotExists(Y,Me,dt){Y.hasAttribute(Me)||Y.setAttribute(Me,dt)}_elemIsActive(Y){return Y.classList.contains(La)}_getInnerElement(Y){return Y.matches(cf)?Y:fe.findOne(cf,Y)}_getOuterElement(Y){return Y.closest(".nav-item, .list-group-item")||Y}static jQueryInterface(Y){return this.each(function(){const Me=rc.getOrCreateInstance(this);if(typeof Y=="string"){if(Me[Y]===void 0||Y.startsWith("_")||Y==="constructor")throw new TypeError(`No method named "${Y}"`);Me[Y]()}})}}ke.on(document,T_,Hh,function(ut){["A","AREA"].includes(this.tagName)&&ut.preventDefault(),S(this)||rc.getOrCreateInstance(this).show()}),ke.on(window,Du,()=>{for(const ut of fe.find(Zp))rc.getOrCreateInstance(ut)}),U(rc);const wl=".bs.toast",Xp=`mouseover${wl}`,M_=`mouseout${wl}`,Mn=`focusin${wl}`,Zh=`focusout${wl}`,Xh=`hide${wl}`,Yh=`hidden${wl}`,uf=`show${wl}`,sc=`shown${wl}`,Vc="hide",Da="show",Vs="showing",Yp={animation:"boolean",autohide:"boolean",delay:"number"},Kp={animation:!0,autohide:!0,delay:5e3};class oc extends yt{constructor(Y,Me){super(Y,Me),this._timeout=null,this._hasMouseInteraction=!1,this._hasKeyboardInteraction=!1,this._setListeners()}static get Default(){return Kp}static get DefaultType(){return Yp}static get NAME(){return"toast"}show(){ke.trigger(this._element,uf).defaultPrevented||(this._clearTimeout(),this._config.animation&&this._element.classList.add("fade"),this._element.classList.remove(Vc),E(this._element),this._element.classList.add(Da,Vs),this._queueCallback(()=>{this._element.classList.remove(Vs),ke.trigger(this._element,sc),this._maybeScheduleHide()},this._element,this._config.animation))}hide(){this.isShown()&&(ke.trigger(this._element,Xh).defaultPrevented||(this._element.classList.add(Vs),this._queueCallback(()=>{this._element.classList.add(Vc),this._element.classList.remove(Vs,Da),ke.trigger(this._element,Yh)},this._element,this._config.animation)))}dispose(){this._clearTimeout(),this.isShown()&&this._element.classList.remove(Da),super.dispose()}isShown(){return this._element.classList.contains(Da)}_maybeScheduleHide(){this._config.autohide&&(this._hasMouseInteraction||this._hasKeyboardInteraction||(this._timeout=setTimeout(()=>{this.hide()},this._config.delay)))}_onInteraction(Y,Me){switch(Y.type){case"mouseover":case"mouseout":this._hasMouseInteraction=Me;break;case"focusin":case"focusout":this._hasKeyboardInteraction=Me}if(Me)return void this._clearTimeout();const dt=Y.relatedTarget;this._element===dt||this._element.contains(dt)||this._maybeScheduleHide()}_setListeners(){ke.on(this._element,Xp,Y=>this._onInteraction(Y,!0)),ke.on(this._element,M_,Y=>this._onInteraction(Y,!1)),ke.on(this._element,Mn,Y=>this._onInteraction(Y,!0)),ke.on(this._element,Zh,Y=>this._onInteraction(Y,!1))}_clearTimeout(){clearTimeout(this._timeout),this._timeout=null}static jQueryInterface(Y){return this.each(function(){const Me=oc.getOrCreateInstance(this,Y);if(typeof Y=="string"){if(Me[Y]===void 0)throw new TypeError(`No method named "${Y}"`);Me[Y](this)}})}}return Ve(oc),U(oc),{Alert:Ce,Button:vt,Carousel:Ye,Collapse:Vi,Dropdown:oo,Modal:_l,Offcanvas:yr,Popover:Ia,ScrollSpy:Nc,Tab:rc,Toast:oc,Tooltip:qo}})})(Nx)),Nx.exports}kV();var Wa=63710088e-1,KD={centimeters:Wa*100,centimetres:Wa*100,degrees:360/(2*Math.PI),feet:Wa*3.28084,inches:Wa*39.37,kilometers:Wa/1e3,kilometres:Wa/1e3,meters:Wa,metres:Wa,miles:Wa/1609.344,millimeters:Wa*1e3,millimetres:Wa*1e3,nauticalmiles:Wa/1852,radians:1,yards:Wa*1.0936};function jg(n,e,t={}){const i={type:"Feature"};return(t.id===0||t.id)&&(i.id=t.id),t.bbox&&(i.bbox=t.bbox),i.properties=e||{},i.geometry=n,i}function Qf(n,e,t={}){if(!n)throw new Error("coordinates is required");if(!Array.isArray(n))throw new Error("coordinates must be an Array");if(n.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!nI(n[0])||!nI(n[1]))throw new Error("coordinates must contain numbers");return jg({type:"Point",coordinates:n},e,t)}function DV(n,e,t={}){for(const r of n){if(r.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(r[r.length-1].length!==r[0].length)throw new Error("First and last Position are not equivalent.");for(let o=0;o<r[r.length-1].length;o++)if(r[r.length-1][o]!==r[0][o])throw new Error("First and last Position are not equivalent.")}return jg({type:"Polygon",coordinates:n},e,t)}function iI(n,e,t={}){if(n.length<2)throw new Error("coordinates must be an array of two or more positions");return jg({type:"LineString",coordinates:n},e,t)}function FV(n,e="kilometers"){const t=KD[e];if(!t)throw new Error(e+" units is invalid");return n*t}function OV(n,e="kilometers"){const t=KD[e];if(!t)throw new Error(e+" units is invalid");return n/t}function aw(n){return n%(2*Math.PI)*180/Math.PI}function mh(n){return n%360*Math.PI/180}function nI(n){return!isNaN(n)&&n!==null&&!Array.isArray(n)}function Mg(n){if(!n)throw new Error("coord is required");if(!Array.isArray(n)){if(n.type==="Feature"&&n.geometry!==null&&n.geometry.type==="Point")return[...n.geometry.coordinates];if(n.type==="Point")return[...n.coordinates]}if(Array.isArray(n)&&n.length>=2&&!Array.isArray(n[0])&&!Array.isArray(n[1]))return[...n];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function zV(n){if(Array.isArray(n))return n;if(n.type==="Feature"){if(n.geometry!==null)return n.geometry.coordinates}else if(n.coordinates)return n.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function GS(n,e,t={}){var i=Mg(n),r=Mg(e),o=mh(r[1]-i[1]),c=mh(r[0]-i[0]),s=mh(i[1]),d=mh(r[1]),p=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(c/2),2)*Math.cos(s)*Math.cos(d);return FV(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)),t.units)}function JD(n,e,t){if(n!==null)for(var i,r,o,c,s,d,p,g=0,_=0,x,b=n.type,S=b==="FeatureCollection",P=b==="Feature",L=S?n.features.length:1,E=0;E<L;E++){p=S?n.features[E].geometry:P?n.geometry:n,x=p?p.type==="GeometryCollection":!1,s=x?p.geometries.length:1;for(var C=0;C<s;C++){var D=0,O=0;if(c=x?p.geometries[C]:p,c!==null){d=c.coordinates;var U=c.type;switch(g=0,U){case null:break;case"Point":if(e(d,_,E,D,O)===!1)return!1;_++,D++;break;case"LineString":case"MultiPoint":for(i=0;i<d.length;i++){if(e(d[i],_,E,D,O)===!1)return!1;_++,U==="MultiPoint"&&D++}U==="LineString"&&D++;break;case"Polygon":case"MultiLineString":for(i=0;i<d.length;i++){for(r=0;r<d[i].length-g;r++){if(e(d[i][r],_,E,D,O)===!1)return!1;_++}U==="MultiLineString"&&D++,U==="Polygon"&&O++}U==="Polygon"&&D++;break;case"MultiPolygon":for(i=0;i<d.length;i++){for(O=0,r=0;r<d[i].length;r++){for(o=0;o<d[i][r].length-g;o++){if(e(d[i][r][o],_,E,D,O)===!1)return!1;_++}O++}D++}break;case"GeometryCollection":for(i=0;i<c.geometries.length;i++)if(JD(c.geometries[i],e)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function BV(n,e){var t,i,r,o,c,s,d,p,g,_,x=0,b=n.type==="FeatureCollection",S=n.type==="Feature",P=b?n.features.length:1;for(t=0;t<P;t++){for(s=b?n.features[t].geometry:S?n.geometry:n,p=b?n.features[t].properties:S?n.properties:{},g=b?n.features[t].bbox:S?n.bbox:void 0,_=b?n.features[t].id:S?n.id:void 0,d=s?s.type==="GeometryCollection":!1,c=d?s.geometries.length:1,r=0;r<c;r++){if(o=d?s.geometries[r]:s,o===null){if(e(null,x,p,g,_)===!1)return!1;continue}switch(o.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(e(o,x,p,g,_)===!1)return!1;break}case"GeometryCollection":{for(i=0;i<o.geometries.length;i++)if(e(o.geometries[i],x,p,g,_)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}x++}}function NV(n,e){BV(n,function(t,i,r,o,c){var s=t===null?null:t.type;switch(s){case null:case"Point":case"LineString":case"Polygon":return e(jg(t,r,{bbox:o,id:c}),i,0)===!1?!1:void 0}var d;switch(s){case"MultiPoint":d="Point";break;case"MultiLineString":d="LineString";break;case"MultiPolygon":d="Polygon";break}for(var p=0;p<t.coordinates.length;p++){var g=t.coordinates[p],_={type:d,coordinates:g};if(e(jg(_,r),i,p)===!1)return!1}})}var $V=Object.defineProperty,VV=Object.defineProperties,UV=Object.getOwnPropertyDescriptors,rI=Object.getOwnPropertySymbols,jV=Object.prototype.hasOwnProperty,GV=Object.prototype.propertyIsEnumerable,sI=(n,e,t)=>e in n?$V(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,oI=(n,e)=>{for(var t in e||(e={}))jV.call(e,t)&&sI(n,t,e[t]);if(rI)for(var t of rI(e))GV.call(e,t)&&sI(n,t,e[t]);return n},aI=(n,e)=>VV(n,UV(e));function qV(n,e,t={}){if(!n||!e)throw new Error("lines and pt are required arguments");const i=Mg(e);let r=Qf([1/0,1/0],{dist:1/0,index:-1,multiFeatureIndex:-1,location:-1}),o=0;return NV(n,function(c,s,d){const p=zV(c);for(let g=0;g<p.length-1;g++){const _=Qf(p[g]),x=Mg(_),b=Qf(p[g+1]),S=Mg(b),P=GS(_,b,t);let L,E;S[0]===i[0]&&S[1]===i[1]?[L,E]=[S,!0]:x[0]===i[0]&&x[1]===i[1]?[L,E]=[x,!1]:[L,E]=ZV(x,S,i);const C=Qf(L,{dist:GS(e,L,t),multiFeatureIndex:d,location:o+GS(_,L,t)});C.properties.dist<r.properties.dist&&(r=aI(oI({},C),{properties:aI(oI({},C.properties),{index:E?g+1:g})})),o+=P}}),r}function Uf(n,e){const[t,i,r]=n,[o,c,s]=e;return t*o+i*c+r*s}function _v(n,e){const[t,i,r]=n,[o,c,s]=e;return[i*s-r*c,r*o-t*s,t*c-i*o]}function WV(n){return Math.sqrt(Math.pow(n[0],2)+Math.pow(n[1],2)+Math.pow(n[2],2))}function lI(n){const e=WV(n);return[n[0]/e,n[1]/e,n[2]/e]}function qS(n){const e=mh(n[1]),t=mh(n[0]);return[Math.cos(e)*Math.cos(t),Math.cos(e)*Math.sin(t),Math.sin(e)]}function HV(n){const[e,t,i]=n,r=Math.min(Math.max(i,-1),1),o=aw(Math.asin(r));return[aw(Math.atan2(t,e)),o]}function ZV(n,e,t){const i=qS(n),r=qS(e),o=qS(t),c=_v(i,r);if(c[0]===0&&c[1]===0&&c[2]===0)return Uf(i,r)>0?[[...e],!0]:[[...t],!1];const s=_v(c,o);if(s[0]===0&&s[1]===0&&s[2]===0)return[[...e],!0];const d=_v(s,c),p=lI(d),g=[-p[0],-p[1],-p[2]],_=Uf(o,p)>Uf(o,g)?p:g,x=lI(c),b=Uf(_v(i,_),x),S=Uf(_v(_,r),x);return b>=0&&S>=0?[HV(_),!1]:Uf(i,o)>Uf(r,o)?[[...n],!1]:[[...e],!0]}var XV=qV;const YV=["==",["geometry-type"],"Polygon"],KV=["==",["geometry-type"],"LineString"],JV=["==",["geometry-type"],"Point"];function QD(){return{type:"FeatureCollection",features:[]}}function WS(n){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:eF(n)}}}function eF(n){return[Math.round(n[0]*1e7)/1e7,Math.round(n[1]*1e7)/1e7]}const tF=Ic(QD()),iF=Ic(0),QV=100;class e8{map;active;eventListenersSuccess;eventListenersUpdated;eventListenersFailure;points;cursor;hover;dragFrom;previousStates;constructor(e){this.map=e,this.active=!1,this.eventListenersSuccess=[],this.eventListenersUpdated=[],this.eventListenersFailure=[],this.points=[],this.cursor=null,this.hover=null,this.dragFrom=null,this.previousStates=[],this.map.on("mousemove",this.onMouseMove),this.map.on("click",this.onClick),this.map.on("dblclick",this.onDoubleClick),this.map.on("mousedown",this.onMouseDown),this.map.on("mouseup",this.onMouseUp),document.addEventListener("keypress",this.onKeypress),document.addEventListener("keydown",this.onKeyDown)}tearDown(){this.map.off("mousemove",this.onMouseMove),this.map.off("click",this.onClick),this.map.off("dblclick",this.onDoubleClick),this.map.off("mousedown",this.onMouseDown),this.map.off("mouseup",this.onMouseUp),document.removeEventListener("keypress",this.onKeypress),document.removeEventListener("keydown",this.onKeyDown)}finish(){let e=this.polygonFeature();if(e)for(let t of this.eventListenersSuccess)t(e);else for(let t of this.eventListenersFailure)t();this.stop()}cancel(){for(let e of this.eventListenersFailure)e();this.stop()}onMouseMove=e=>{if(this.active&&!this.dragFrom)this.recalculateHovering(e);else if(this.active&&this.dragFrom){if(this.hover=="polygon"){let t=this.dragFrom[0]-e.lngLat.lng,i=this.dragFrom[1]-e.lngLat.lat;for(let r of this.points)r[0]-=t,r[1]-=i}else this.points[this.hover]=e.lngLat.toArray();this.dragFrom=e.lngLat.toArray(),this.redraw()}};onClick=e=>{if(this.beforeUpdate(),this.active&&this.cursor){let t=[];if(cI(this.points).forEach((i,r)=>{t.push([r+1,XV(i,this.cursor).properties.dist])}),t.sort((i,r)=>i[1]-r[1]),t.length>0){let i=t[0][0];this.points.splice(i,0,this.cursor.geometry.coordinates),this.hover=i}else this.points.push(this.cursor.geometry.coordinates),this.hover=this.points.length-1;this.redraw(),this.pointsUpdated()}else this.active&&typeof this.hover=="number"&&(this.points.splice(this.hover,1),this.hover=null,this.redraw(),this.pointsUpdated(),this.recalculateHovering(e))};onDoubleClick=e=>{this.active&&(e.preventDefault(),this.cursor=WS(e.lngLat.toArray()),this.onClick(e),this.finish())};onMouseDown=e=>{this.active&&!this.dragFrom&&this.hover!=null&&(e.preventDefault(),this.cursor=null,this.dragFrom=e.lngLat.toArray(),this.beforeUpdate(),this.redraw())};onMouseUp=()=>{this.active&&this.dragFrom&&(this.dragFrom=null,this.redraw(),this.pointsUpdated())};onKeypress=e=>{if(!this.active)return;let t=e.target.tagName;t=="INPUT"||t=="TEXTAREA"||(e.key=="Enter"?(e.stopPropagation(),this.finish()):e.key=="z"&&e.ctrlKey&&this.undo())};onKeyDown=e=>{if(!this.active)return;let t=e.target.tagName;t=="INPUT"||t=="TEXTAREA"||e.key=="Escape"&&(e.stopPropagation(),this.cancel())};addEventListenerSuccess(e){this.eventListenersSuccess.push(e)}addEventListenerUpdated(e){this.eventListenersUpdated.push(e)}addEventListenerFailure(e){this.eventListenersFailure.push(e)}clearEventListeners(){this.eventListenersSuccess=[],this.eventListenersUpdated=[],this.eventListenersFailure=[]}startNew(){this.active=!0,this.map.doubleClickZoom.disable()}editExisting(e){this.active=!0,this.map.doubleClickZoom.disable(),this.points=JSON.parse(JSON.stringify(e.geometry.coordinates[0])),this.points.pop(),this.redraw()}stop(){this.map.doubleClickZoom.enable(),this.points=[],this.cursor=null,this.active=!1,this.hover=null,this.dragFrom=null,this.previousStates=[],this.redraw(),this.map.getCanvas().style.cursor="inherit"}undo(){this.dragFrom!=null||this.previousStates.length==0||(this.points=this.previousStates.pop(),this.hover=null,this.redraw())}redraw(){let e=QD();this.points.forEach((r,o)=>{let c=WS(r);c.properties.hover=this.hover==o,c.properties.idx=o,e.features.push(c)}),e.features=e.features.concat(cI(this.points));let t=this.polygonFeature();t&&(t.properties.hover=this.hover=="polygon",e.features.push(t)),tF.set(e);let i="crosshair";this.hover!=null&&(i=this.dragFrom?"grabbing":"pointer"),this.map.getCanvas().style.cursor=i,iF.set(this.previousStates.length)}pointsUpdated(){let e=this.polygonFeature();if(e)for(let t of this.eventListenersUpdated)t(e)}recalculateHovering(e){this.cursor=null,this.hover=null;for(let t of this.map.queryRenderedFeatures(e.point,{layers:["edit-polygon-fill","edit-polygon-vertices"]}))if(t.geometry.type=="Polygon"){this.hover="polygon";break}else if(t.geometry.type=="Point"&&Object.hasOwn(t.properties,"idx")){this.hover=t.properties.idx;break}this.hover==null&&(this.cursor=WS(e.lngLat.toArray())),this.redraw()}polygonFeature(){if(this.points.length<3)return null;let e=this.points.map(eF),t=[JSON.parse(JSON.stringify(e))];return t[0].push(JSON.parse(JSON.stringify(t[0][0]))),{type:"Feature",geometry:{type:"Polygon",coordinates:t},properties:{}}}beforeUpdate(){this.previousStates.push(JSON.parse(JSON.stringify(this.points))),this.previousStates.length>QV&&this.previousStates.shift()}}function cI(n){let e=[];for(let t=0;t<n.length-1;t++)e.push({type:"Feature",geometry:{type:"LineString",coordinates:[n[t],n[t+1]]},properties:{}});return n.length>=3&&e.push({type:"Feature",geometry:{type:"LineString",coordinates:[n[n.length-1],n[0]]},properties:{}}),e}var t8=Wt('<div style="display: flex; justify-content: space-between;"><button>Finish</button> <button>Cancel</button> <button><!></button></div> <ul><li><b>Click</b> the map to add a vertex</li> <li><b>Click</b> a vertex to delete it</li> <li><b>Drag</b> a vertex or the polygon to move it</li> <li>Press <b>Control+Z</b> to undo your last change</li> <li>Press <b>Enter</b> or <b>double click</b> to finish</li> <li>Press <b>Escape</b> to cancel</li></ul>',1);function i8(n,e){en(e,!0);const t=()=>Qi(iF,"$undoLength",i),[i,r]=qr();var o=t8(),c=ci(o),s=Ft(c);s.__click=()=>e.polygonTool.finish();var d=gt(s,2);d.__click=()=>e.polygonTool.cancel();var p=gt(d,2);p.__click=()=>e.polygonTool.undo();var g=Ft(p);{var _=b=>{var S=Vn("Undo");xt(b,S)},x=b=>{var S=Vn();Zi(()=>ln(S,`Undo (${t()??""})`)),xt(b,S)};Ki(g,b=>{t()==0?b(_):b(x,!1)})}Zi(()=>p.disabled=t()==0),xt(n,o),tn(),r()}ds(["click"]);j5();var n8=["forEach","isDisjointFrom","isSubsetOf","isSupersetOf"],r8=["difference","intersection","symmetricDifference","union"],uI=!1;class lw extends Set{#t=new Map;#e=ii(0);#i=ii(0);#n=wc||-1;constructor(e){if(super(),e){for(var t of e)super.add(t);this.#i.v=super.size}uI||this.#r()}#s(e){return wc===this.#n?ii(e):Sh(e)}#r(){uI=!0;var e=lw.prototype,t=Set.prototype;for(const i of n8)e[i]=function(...r){return ee(this.#e),t[i].apply(this,r)};for(const i of r8)e[i]=function(...r){ee(this.#e);var o=t[i].apply(this,r);return new lw(o)}}has(e){var t=super.has(e),i=this.#t,r=i.get(e);if(r===void 0){if(!t)return ee(this.#e),!1;r=this.#s(!0),i.set(e,r)}return ee(r),t}add(e){return super.has(e)||(super.add(e),Et(this.#i,super.size),el(this.#e)),this}delete(e){var t=super.delete(e),i=this.#t,r=i.get(e);return r!==void 0&&(i.delete(e),Et(r,!1)),t&&(Et(this.#i,super.size),el(this.#e)),t}clear(){if(super.size!==0){super.clear();var e=this.#t;for(var t of e.values())Et(t,!1);e.clear(),Et(this.#i,0),el(this.#e)}}keys(){return this.values()}values(){return ee(this.#e),super.values()}entries(){return ee(this.#e),super.entries()}[Symbol.iterator](){return this.keys()}get size(){return ee(this.#i)}}class s8 extends Map{#t=new Map;#e=ii(0);#i=ii(0);#n=wc||-1;constructor(e){if(super(),e){for(var[t,i]of e)super.set(t,i);this.#i.v=super.size}}#s(e){return wc===this.#n?ii(e):Sh(e)}has(e){var t=this.#t,i=t.get(e);if(i===void 0){var r=super.get(e);if(r!==void 0)i=this.#s(0),t.set(e,i);else return ee(this.#e),!1}return ee(i),!0}forEach(e,t){this.#r(),super.forEach(e,t)}get(e){var t=this.#t,i=t.get(e);if(i===void 0){var r=super.get(e);if(r!==void 0)i=this.#s(0),t.set(e,i);else{ee(this.#e);return}}return ee(i),super.get(e)}set(e,t){var i=this.#t,r=i.get(e),o=super.get(e),c=super.set(e,t),s=this.#e;if(r===void 0)r=this.#s(0),i.set(e,r),Et(this.#i,super.size),el(s);else if(o!==t){el(r);var d=s.reactions===null?null:new Set(s.reactions),p=d===null||!r.reactions?.every(g=>d.has(g));p&&el(s)}return c}delete(e){var t=this.#t,i=t.get(e),r=super.delete(e);return i!==void 0&&(t.delete(e),Et(this.#i,super.size),Et(i,-1),el(this.#e)),r}clear(){if(super.size!==0){super.clear();var e=this.#t;Et(this.#i,0);for(var t of e.values())Et(t,-1);el(this.#e),e.clear()}}#r(){ee(this.#e);var e=this.#t;if(this.#i.v!==e.size){for(var t of super.keys())if(!e.has(t)){var i=this.#s(0);e.set(t,i)}}for([,i]of this.#t)ee(i)}keys(){return ee(this.#e),super.keys()}values(){return this.#r(),super.values()}entries(){return this.#r(),super.entries()}[Symbol.iterator](){return this.entries()}get size(){return ee(this.#i),super.size}}let o8=Date.now();function Sp(n){return`${n}-${o8++}`}class Cy{#t=ii();get value(){return ee(this.#t)}set value(e){Et(this.#t,e,!0)}constructor(e){this.value=e}}class a8{#t=ii();get map(){return ee(this.#t)}set map(e){Et(this.#t,e,!0)}#e=ii(!1);get loaded(){return ee(this.#e)}set loaded(e){Et(this.#e,e,!0)}loadedImages=new lw;#i=ii(0);get minzoom(){return ee(this.#i)}set minzoom(e){Et(this.#i,e,!0)}#n=ii(24);get maxzoom(){return ee(this.#n)}set maxzoom(e){Et(this.#n,e,!0)}layerInfo=new Map;eventTracker=new WeakMap;_eventTopMost(e){let t=this.eventTracker.get(e.originalEvent);if(t!==void 0)return t;let r=e.target.queryRenderedFeatures(e.point).find(o=>this.layerInfo.get(o.layer.id)?.interactive)?.layer.id;return this.eventTracker.set(e.originalEvent,r),r}eventTopMost;markerClickManager=new w8;constructor(){this.eventTopMost=this._eventTopMost.bind(this)}}function l8(n){s_(oF,n)}function c8(){return r_(oF)}function u8(n){s_(aF,n)}function h8(){return r_(aF)}function d8(n){s_(sF,n)}function f8(){return r_(sF)}function p8(n){s_(_8,n)}function m8(){return r_(lF)}function nF(n){s_(lF,n)}function g8(){return r_(v8)}const rF=Symbol.for("svelte-maplibre"),sF=Symbol.for("svelte-maplibre.popup-target"),oF=Symbol.for("svelte-maplibre.layer"),aF=Symbol.for("svelte-maplibre.source"),_8=Symbol.for("svelte-maplibre.cluster"),lF=Symbol.for("svelte-maplibre.layer-event"),v8=Symbol.for("svelte-maplibre.lng-lat");function Ac(){return r_(rF)}function y8(){return s_(rF,new a8)}function cF(){const n=new Cy(void 0),e=new Cy(void 0);return u8(n),p8(e),{source:n,cluster:e}}function b8(n=!0){const e=new Cy(void 0),t=new Cy(void 0);return l8(e),n&&(d8(e),nF(t)),{layer:e,layerEvent:t}}function x8(n){return"layerType"in n&&n.layerType==="deckgl"}class w8{_handlers=new Set;add(e){this._handlers.add(e)}remove(e){this._handlers.delete(e)}handleClick(e){for(const t of this._handlers)t(e)}}var Vx={exports:{}};var S8=Vx.exports,hI;function T8(){return hI||(hI=1,(function(n,e){(function(t,i){n.exports=i()})(S8,(function(){var t={},i={};function r(c,s,d){if(i[c]=d,c==="index"){var p="var sharedModule = {}; ("+i.shared+")(sharedModule); ("+i.worker+")(sharedModule);",g={};return i.shared(g),i.index(t,g),typeof window<"u"&&t.setWorkerUrl(window.URL.createObjectURL(new Blob([p],{type:"text/javascript"}))),t}}r("shared",["exports"],(function(c){function s(h,a,u,m){return new(u||(u=Promise))((function(y,T){function M($){try{F(m.next($))}catch(H){T(H)}}function R($){try{F(m.throw($))}catch(H){T(H)}}function F($){var H;$.done?y($.value):(H=$.value,H instanceof u?H:new u((function(K){K(H)}))).then(M,R)}F((m=m.apply(h,a||[])).next())}))}function d(h,a){this.x=h,this.y=a}function p(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var g,_;typeof SuppressedError=="function"&&SuppressedError,d.prototype={clone(){return new d(this.x,this.y)},add(h){return this.clone()._add(h)},sub(h){return this.clone()._sub(h)},multByPoint(h){return this.clone()._multByPoint(h)},divByPoint(h){return this.clone()._divByPoint(h)},mult(h){return this.clone()._mult(h)},div(h){return this.clone()._div(h)},rotate(h){return this.clone()._rotate(h)},rotateAround(h,a){return this.clone()._rotateAround(h,a)},matMult(h){return this.clone()._matMult(h)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(h){return this.x===h.x&&this.y===h.y},dist(h){return Math.sqrt(this.distSqr(h))},distSqr(h){const a=h.x-this.x,u=h.y-this.y;return a*a+u*u},angle(){return Math.atan2(this.y,this.x)},angleTo(h){return Math.atan2(this.y-h.y,this.x-h.x)},angleWith(h){return this.angleWithSep(h.x,h.y)},angleWithSep(h,a){return Math.atan2(this.x*a-this.y*h,this.x*h+this.y*a)},_matMult(h){const a=h[2]*this.x+h[3]*this.y;return this.x=h[0]*this.x+h[1]*this.y,this.y=a,this},_add(h){return this.x+=h.x,this.y+=h.y,this},_sub(h){return this.x-=h.x,this.y-=h.y,this},_mult(h){return this.x*=h,this.y*=h,this},_div(h){return this.x/=h,this.y/=h,this},_multByPoint(h){return this.x*=h.x,this.y*=h.y,this},_divByPoint(h){return this.x/=h.x,this.y/=h.y,this},_unit(){return this._div(this.mag()),this},_perp(){const h=this.y;return this.y=this.x,this.x=-h,this},_rotate(h){const a=Math.cos(h),u=Math.sin(h),m=u*this.x+a*this.y;return this.x=a*this.x-u*this.y,this.y=m,this},_rotateAround(h,a){const u=Math.cos(h),m=Math.sin(h),y=a.y+m*(this.x-a.x)+u*(this.y-a.y);return this.x=a.x+u*(this.x-a.x)-m*(this.y-a.y),this.y=y,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:d},d.convert=function(h){if(h instanceof d)return h;if(Array.isArray(h))return new d(+h[0],+h[1]);if(h.x!==void 0&&h.y!==void 0)return new d(+h.x,+h.y);throw new Error("Expected [x, y] or {x, y} point format")};var x=(function(){if(_)return g;function h(a,u,m,y){this.cx=3*a,this.bx=3*(m-a)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*u,this.by=3*(y-u)-this.cy,this.ay=1-this.cy-this.by,this.p1x=a,this.p1y=u,this.p2x=m,this.p2y=y}return _=1,g=h,h.prototype={sampleCurveX:function(a){return((this.ax*a+this.bx)*a+this.cx)*a},sampleCurveY:function(a){return((this.ay*a+this.by)*a+this.cy)*a},sampleCurveDerivativeX:function(a){return(3*this.ax*a+2*this.bx)*a+this.cx},solveCurveX:function(a,u){if(u===void 0&&(u=1e-6),a<0)return 0;if(a>1)return 1;for(var m=a,y=0;y<8;y++){var T=this.sampleCurveX(m)-a;if(Math.abs(T)<u)return m;var M=this.sampleCurveDerivativeX(m);if(Math.abs(M)<1e-6)break;m-=T/M}var R=0,F=1;for(m=a,y=0;y<20&&(T=this.sampleCurveX(m),!(Math.abs(T-a)<u));y++)a>T?R=m:F=m,m=.5*(F-R)+R;return m},solve:function(a,u){return this.sampleCurveY(this.solveCurveX(a,u))}},g})(),b=p(x);let S,P;function L(){return S==null&&(S=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),S}function E(){if(P==null&&(P=!1,L())){const a=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(a){for(let m=0;m<25;m++){const y=4*m;a.fillStyle=`rgb(${y},${y+1},${y+2})`,a.fillRect(m%5,Math.floor(m/5),1,1)}const u=a.getImageData(0,0,5,5).data;for(let m=0;m<100;m++)if(m%4!=3&&u[m]!==m){P=!0;break}}}return P||!1}var C=1e-6,D=typeof Float32Array<"u"?Float32Array:Array;function O(){var h=new D(9);return D!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[5]=0,h[6]=0,h[7]=0),h[0]=1,h[4]=1,h[8]=1,h}function U(h){return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}function j(){var h=new D(3);return D!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h}function G(h){var a=h[0],u=h[1],m=h[2];return Math.sqrt(a*a+u*u+m*m)}function N(h,a,u){var m=new D(3);return m[0]=h,m[1]=a,m[2]=u,m}function V(h,a,u){return h[0]=a[0]+u[0],h[1]=a[1]+u[1],h[2]=a[2]+u[2],h}function q(h,a,u){return h[0]=a[0]*u,h[1]=a[1]*u,h[2]=a[2]*u,h}function z(h,a,u){var m=a[0],y=a[1],T=a[2],M=u[0],R=u[1],F=u[2];return h[0]=y*F-T*R,h[1]=T*M-m*F,h[2]=m*R-y*M,h}var Q,X=G;function re(h,a,u){var m=a[0],y=a[1],T=a[2],M=a[3];return h[0]=u[0]*m+u[4]*y+u[8]*T+u[12]*M,h[1]=u[1]*m+u[5]*y+u[9]*T+u[13]*M,h[2]=u[2]*m+u[6]*y+u[10]*T+u[14]*M,h[3]=u[3]*m+u[7]*y+u[11]*T+u[15]*M,h}function oe(){var h=new D(4);return D!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h[3]=1,h}function de(h,a,u,m){var y=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"zyx",T=Math.PI/360;a*=T,m*=T,u*=T;var M=Math.sin(a),R=Math.cos(a),F=Math.sin(u),$=Math.cos(u),H=Math.sin(m),K=Math.cos(m);switch(y){case"xyz":h[0]=M*$*K+R*F*H,h[1]=R*F*K-M*$*H,h[2]=R*$*H+M*F*K,h[3]=R*$*K-M*F*H;break;case"xzy":h[0]=M*$*K-R*F*H,h[1]=R*F*K-M*$*H,h[2]=R*$*H+M*F*K,h[3]=R*$*K+M*F*H;break;case"yxz":h[0]=M*$*K+R*F*H,h[1]=R*F*K-M*$*H,h[2]=R*$*H-M*F*K,h[3]=R*$*K+M*F*H;break;case"yzx":h[0]=M*$*K+R*F*H,h[1]=R*F*K+M*$*H,h[2]=R*$*H-M*F*K,h[3]=R*$*K-M*F*H;break;case"zxy":h[0]=M*$*K-R*F*H,h[1]=R*F*K+M*$*H,h[2]=R*$*H+M*F*K,h[3]=R*$*K-M*F*H;break;case"zyx":h[0]=M*$*K-R*F*H,h[1]=R*F*K+M*$*H,h[2]=R*$*H-M*F*K,h[3]=R*$*K+M*F*H;break;default:throw new Error("Unknown angle order "+y)}return h}function ce(){var h=new D(2);return D!=Float32Array&&(h[0]=0,h[1]=0),h}function Se(h,a){var u=new D(2);return u[0]=h,u[1]=a,u}j(),Q=new D(4),D!=Float32Array&&(Q[0]=0,Q[1]=0,Q[2]=0,Q[3]=0),j(),N(1,0,0),N(0,1,0),oe(),oe(),O(),ce();const Pe=8192;function je(h,a,u){return a*(Pe/(h.tileSize*Math.pow(2,u-h.tileID.overscaledZ)))}function Fe(h,a){return(h%a+a)%a}function qe(h,a,u){return h*(1-u)+a*u}function Ue(h){if(h<=0)return 0;if(h>=1)return 1;const a=h*h,u=a*h;return 4*(h<.5?u:3*(h-a)+u-.75)}function ke(h,a,u,m){const y=new b(h,a,u,m);return T=>y.solve(T)}const et=ke(.25,.1,.25,1);function ye(h,a,u){return Math.min(u,Math.max(a,h))}function Be(h,a,u){const m=u-a,y=((h-a)%m+m)%m+a;return y===a?u:y}function Je(h,...a){for(const u of a)for(const m in u)h[m]=u[m];return h}let ct=1;function yt(h,a,u){const m={};for(const y in h)m[y]=a.call(this,h[y],y,h);return m}function we(h,a,u){const m={};for(const y in h)a.call(this,h[y],y,h)&&(m[y]=h[y]);return m}function fe(h){return Array.isArray(h)?h.map(fe):typeof h=="object"&&h?yt(h,fe):h}const Ve={};function tt(h){Ve[h]||(typeof console<"u"&&console.warn(h),Ve[h]=!0)}function Mt(h,a,u){return(u.y-h.y)*(a.x-h.x)>(a.y-h.y)*(u.x-h.x)}function mt(h){return typeof WorkerGlobalScope<"u"&&h!==void 0&&h instanceof WorkerGlobalScope}let Ce=null;function xe(h){return typeof ImageBitmap<"u"&&h instanceof ImageBitmap}const vt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function be(h,a,u,m,y){return s(this,void 0,void 0,(function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const T=new VideoFrame(h,{timestamp:0});try{const M=T?.format;if(!M||!M.startsWith("BGR")&&!M.startsWith("RGB"))throw new Error(`Unrecognized format ${M}`);const R=M.startsWith("BGR"),F=new Uint8ClampedArray(m*y*4);if(yield T.copyTo(F,(function($,H,K,ne,se){const me=4*Math.max(-H,0),ge=(Math.max(0,K)-K)*ne*4+me,ve=4*ne,Ae=Math.max(0,H),He=Math.max(0,K);return{rect:{x:Ae,y:He,width:Math.min($.width,H+ne)-Ae,height:Math.min($.height,K+se)-He},layout:[{offset:ge,stride:ve}]}})(h,a,u,m,y)),R)for(let $=0;$<F.length;$+=4){const H=F[$];F[$]=F[$+2],F[$+2]=H}return F}finally{T.close()}}))}let ie,ae;function De(h,a,u,m){return h.addEventListener(a,u,m),{unsubscribe:()=>{h.removeEventListener(a,u,m)}}}function Xe(h){return h*Math.PI/180}function bt(h){return h/Math.PI*180}const Te={touchstart:!0,touchmove:!0,touchmoveWindow:!0,touchend:!0,touchcancel:!0},te={dblclick:!0,click:!0,mouseover:!0,mouseout:!0,mousedown:!0,mousemove:!0,mousemoveWindow:!0,mouseup:!0,mouseupWindow:!0,contextmenu:!0,wheel:!0},he="AbortError";class pe extends Error{constructor(a=he){super(a instanceof Error?a.message:a),this.name=he,a instanceof Error&&a.stack&&(this.stack=a.stack)}}function Re(h){return h.name===he}const Oe={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function ht(h){return Oe.REGISTERED_PROTOCOLS[h.substring(0,h.indexOf("://"))]}const pt="global-dispatcher";class ot extends Error{constructor(a,u,m,y){super(`AJAXError: ${u} (${a}): ${m}`),this.status=a,this.statusText=u,this.url=m,this.body=y}}const St=()=>mt(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Lt=function(h,a){if(/:\/\//.test(h.url)&&!/^https?:|^file:/.test(h.url)){const m=ht(h.url);if(m)return m(h,a);if(mt(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:h,targetMapId:pt},a)}if(!(/^file:/.test(u=h.url)||/^file:/.test(St())&&!/^\w+:/.test(u))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return(function(m,y){return s(this,void 0,void 0,(function*(){const T=new Request(m.url,{method:m.method||"GET",body:m.body,credentials:m.credentials,headers:m.headers,cache:m.cache,referrer:St(),signal:y.signal});let M,R;m.type!=="json"||T.headers.has("Accept")||T.headers.set("Accept","application/json");try{M=yield fetch(T)}catch($){throw Re($)?$:new ot(0,$.message,m.url,new Blob)}if(!M.ok){const $=yield M.blob();throw new ot(M.status,M.statusText,m.url,$)}R=m.type==="arrayBuffer"||m.type==="image"?M.arrayBuffer():m.type==="json"?M.json():M.text();const F=yield R;return y.signal.throwIfAborted(),{data:F,cacheControl:M.headers.get("Cache-Control"),expires:M.headers.get("Expires")}}))})(h,a);if(mt(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:h,mustQueue:!0,targetMapId:pt},a)}var u;return(function(m,y){return new Promise(((T,M)=>{var R;const F=new XMLHttpRequest;F.open(m.method||"GET",m.url,!0),m.type!=="arrayBuffer"&&m.type!=="image"||(F.responseType="arraybuffer");for(const $ in m.headers)F.setRequestHeader($,m.headers[$]);m.type==="json"&&(F.responseType="text",!((R=m.headers)===null||R===void 0)&&R.Accept||F.setRequestHeader("Accept","application/json")),F.withCredentials=m.credentials==="include",F.onerror=()=>{M(new Error(F.statusText))},F.onload=()=>{if(!y.signal.aborted)if((F.status>=200&&F.status<300||F.status===0)&&F.response!==null){let $=F.response;if(m.type==="json")try{$=JSON.parse(F.response)}catch(H){return void M(H)}T({data:$,cacheControl:F.getResponseHeader("Cache-Control"),expires:F.getResponseHeader("Expires")})}else{const $=new Blob([F.response],{type:F.getResponseHeader("Content-Type")});M(new ot(F.status,F.statusText,m.url,$))}},y.signal.addEventListener("abort",(()=>{F.abort(),M(new pe(y.signal.reason))})),F.send(m.body)}))})(h,a)};function zt(h){if(!h||h.indexOf("://")<=0||h.indexOf("data:image/")===0||h.indexOf("blob:")===0)return!0;const a=new URL(h),u=window.location;return a.protocol===u.protocol&&a.host===u.host}function Jt(h,a,u){u[h]&&u[h].indexOf(a)!==-1||(u[h]=u[h]||[],u[h].push(a))}function gi(h,a,u){if(u&&u[h]){const m=u[h].indexOf(a);m!==-1&&u[h].splice(m,1)}}class Fi{constructor(a,u={}){Je(this,u),this.type=a}}class un extends Fi{constructor(a,u={}){super("error",Je({error:a},u))}}class nn{on(a,u){return this._listeners=this._listeners||{},Jt(a,u,this._listeners),{unsubscribe:()=>{this.off(a,u)}}}off(a,u){return gi(a,u,this._listeners),gi(a,u,this._oneTimeListeners),this}once(a,u){return u?(this._oneTimeListeners=this._oneTimeListeners||{},Jt(a,u,this._oneTimeListeners),this):new Promise((m=>this.once(a,m)))}fire(a,u){typeof a=="string"&&(a=new Fi(a,u||{}));const m=a.type;if(this.listens(m)){a.target=this;const y=this._listeners&&this._listeners[m]?this._listeners[m].slice():[];for(const R of y)R.call(this,a);const T=this._oneTimeListeners&&this._oneTimeListeners[m]?this._oneTimeListeners[m].slice():[];for(const R of T)gi(m,R,this._oneTimeListeners),R.call(this,a);const M=this._eventedParent;M&&(Je(a,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),M.fire(a))}else a instanceof un&&console.error(a.error);return this}listens(a){return this._listeners&&this._listeners[a]&&this._listeners[a].length>0||this._oneTimeListeners&&this._oneTimeListeners[a]&&this._oneTimeListeners[a].length>0||this._eventedParent&&this._eventedParent.listens(a)}setEventedParent(a,u){return this._eventedParent=a,this._eventedParentData=u,this}}var Tt={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number",length:2},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},state:{type:"state",default:{}},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},"font-faces":{type:"fontFaces"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},encoding:{type:"enum",values:{mvt:{},mlt:{}},default:"mvt"},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"filter"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},"color-relief":{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_color-relief","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},"layout_color-relief":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},filter:{type:"boolean",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"expression_name",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_color-relief","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"numberArray",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-altitude":{type:"numberArray",default:45,minimum:0,maximum:90,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"colorArray",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"colorArray",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-method":{type:"enum",values:{standard:{},basic:{},combined:{},igor:{},multidirectional:{}},default:"standard",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},"paint_color-relief":{"color-relief-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"color-relief-color":{type:"color",transition:!1,expression:{interpolated:!0,parameters:["elevation"]},"property-type":"color-ramp"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}},interpolation:{type:"array",value:"interpolation_name",minimum:1},interpolation_name:{type:"enum",values:{linear:{syntax:{overloads:[{parameters:[],"output-type":"interpolation"}],parameters:[]}},exponential:{syntax:{overloads:[{parameters:["base"],"output-type":"interpolation"}],parameters:[{name:"base",type:"number literal"}]}},"cubic-bezier":{syntax:{overloads:[{parameters:["x1","y1","x2","y2"],"output-type":"interpolation"}],parameters:[{name:"x1",type:"number literal"},{name:"y1",type:"number literal"},{name:"x2",type:"number literal"},{name:"y2",type:"number literal"}]}}}}};const hn=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function fr(h,a){const u={};for(const m in h)m!=="ref"&&(u[m]=h[m]);return hn.forEach((m=>{m in a&&(u[m]=a[m])})),u}function Li(h,a){if(Array.isArray(h)){if(!Array.isArray(a)||h.length!==a.length)return!1;for(let u=0;u<h.length;u++)if(!Li(h[u],a[u]))return!1;return!0}if(typeof h=="object"&&h!==null&&a!==null){if(typeof a!="object"||Object.keys(h).length!==Object.keys(a).length)return!1;for(const u in h)if(!Li(h[u],a[u]))return!1;return!0}return h===a}function gn(h,a){h.push(a)}function zn(h,a,u){gn(u,{command:"addSource",args:[h,a[h]]})}function wn(h,a,u){gn(a,{command:"removeSource",args:[h]}),u[h]=!0}function kn(h,a,u,m){wn(h,u,m),zn(h,a,u)}function Sn(h,a,u){let m;for(m in h[u])if(Object.prototype.hasOwnProperty.call(h[u],m)&&m!=="data"&&!Li(h[u][m],a[u][m]))return!1;for(m in a[u])if(Object.prototype.hasOwnProperty.call(a[u],m)&&m!=="data"&&!Li(h[u][m],a[u][m]))return!1;return!0}function Kn(h,a,u,m,y,T){h=h||{},a=a||{};for(const M in h)Object.prototype.hasOwnProperty.call(h,M)&&(Li(h[M],a[M])||u.push({command:T,args:[m,M,a[M],y]}));for(const M in a)Object.prototype.hasOwnProperty.call(a,M)&&!Object.prototype.hasOwnProperty.call(h,M)&&(Li(h[M],a[M])||u.push({command:T,args:[m,M,a[M],y]}))}function Ye(h){return h.id}function kt(h,a){return h[a.id]=a,h}class at{constructor(a,u,m,y){this.message=(a?`${a}: `:"")+m,y&&(this.identifier=y),u!=null&&u.__line__&&(this.line=u.__line__)}}function Ot(h,...a){for(const u of a)for(const m in u)h[m]=u[m];return h}class Gt extends Error{constructor(a,u){super(u),this.message=u,this.key=a}}class Gi{constructor(a,u=[]){this.parent=a,this.bindings={};for(const[m,y]of u)this.bindings[m]=y}concat(a){return new Gi(this,a)}get(a){if(this.bindings[a])return this.bindings[a];if(this.parent)return this.parent.get(a);throw new Error(`${a} not found in scope.`)}has(a){return!!this.bindings[a]||!!this.parent&&this.parent.has(a)}}const Ci={kind:"null"},Nt={kind:"number"},si={kind:"string"},pi={kind:"boolean"},Wi={kind:"color"},wt={kind:"projectionDefinition"},Ri={kind:"object"},bi={kind:"value"},Vi={kind:"collator"},Jn={kind:"formatted"},Xi={kind:"padding"},Gn={kind:"colorArray"},on={kind:"numberArray"},zr={kind:"resolvedImage"},qn={kind:"variableAnchorOffsetCollection"};function an(h,a){return{kind:"array",itemType:h,N:a}}function rn(h){if(h.kind==="array"){const a=rn(h.itemType);return typeof h.N=="number"?`array<${a}, ${h.N}>`:h.itemType.kind==="value"?"array":`array<${a}>`}return h.kind}const ns=[Ci,Nt,si,pi,Wi,wt,Jn,Ri,an(bi),Xi,on,Gn,zr,qn];function so(h,a){if(a.kind==="error")return null;if(h.kind==="array"){if(a.kind==="array"&&(a.N===0&&a.itemType.kind==="value"||!so(h.itemType,a.itemType))&&(typeof h.N!="number"||h.N===a.N))return null}else{if(h.kind===a.kind)return null;if(h.kind==="value"){for(const u of ns)if(!so(u,a))return null}}return`Expected ${rn(h)} but found ${rn(a)} instead.`}function pl(h,a){return a.some((u=>u.kind===h.kind))}function To(h,a){return a.some((u=>u==="null"?h===null:u==="array"?Array.isArray(h):u==="object"?h&&!Array.isArray(h)&&typeof h=="object":u===typeof h))}function Ar(h,a){return h.kind==="array"&&a.kind==="array"?h.itemType.kind===a.itemType.kind&&typeof h.N=="number":h.kind===a.kind}const rr=.96422,Hl=.82521,Zl=4/29,vr=6/29,Ip=3*vr*vr,Rp=vr*vr*vr,Mu=Math.PI/180,Lp=180/Math.PI;function kp(h){return(h%=360)<0&&(h+=360),h}function Dp([h,a,u,m]){let y,T;const M=oo((.2225045*(h=Oh(h))+.7168786*(a=Oh(a))+.0606169*(u=Oh(u)))/1);h===a&&a===u?y=T=M:(y=oo((.4360747*h+.3850649*a+.1430804*u)/rr),T=oo((.0139322*h+.0971045*a+.7141733*u)/Hl));const R=116*M-16;return[R<0?0:R,500*(y-M),200*(M-T),m]}function Oh(h){return h<=.04045?h/12.92:Math.pow((h+.055)/1.055,2.4)}function oo(h){return h>Rp?Math.pow(h,1/3):h/Ip+Zl}function zh([h,a,u,m]){let y=(h+16)/116,T=isNaN(a)?y:y+a/500,M=isNaN(u)?y:y-u/200;return y=1*Nh(y),T=rr*Nh(T),M=Hl*Nh(M),[Bh(3.1338561*T-1.6168667*y-.4906146*M),Bh(-.9787684*T+1.9161415*y+.033454*M),Bh(.0719453*T-.2289914*y+1.4052427*M),m]}function Bh(h){return(h=h<=.00304?12.92*h:1.055*Math.pow(h,1/2.4)-.055)<0?0:h>1?1:h}function Nh(h){return h>vr?h*h*h:Ip*(h-Zl)}const y_=Object.hasOwn||function(h,a){return Object.prototype.hasOwnProperty.call(h,a)};function Cu(h,a){return y_(h,a)?h[a]:void 0}function Eu(h){return parseInt(h.padEnd(2,h),16)/255}function Au(h,a){return Lc(a?h/100:h,0,1)}function Lc(h,a,u){return Math.min(Math.max(a,h),u)}function ef(h){return!h.some(Number.isNaN)}const kc={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function ml(h,a,u){return h+u*(a-h)}function Dc(h,a,u){return h.map(((m,y)=>ml(m,a[y],u)))}class sn{constructor(a,u,m,y=1,T=!0){this.r=a,this.g=u,this.b=m,this.a=y,T||(this.r*=y,this.g*=y,this.b*=y,y||this.overwriteGetter("rgb",[a,u,m,y]))}static parse(a){if(a instanceof sn)return a;if(typeof a!="string")return;const u=(function(m){if((m=m.toLowerCase().trim())==="transparent")return[0,0,0,0];const y=Cu(kc,m);if(y){const[M,R,F]=y;return[M/255,R/255,F/255,1]}if(m.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(m)){const M=m.length<6?1:2;let R=1;return[Eu(m.slice(R,R+=M)),Eu(m.slice(R,R+=M)),Eu(m.slice(R,R+=M)),Eu(m.slice(R,R+M)||"ff")]}if(m.startsWith("rgb")){const M=m.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(M){const[R,F,$,H,K,ne,se,me,ge,ve,Ae,He]=M,Ie=[H||" ",se||" ",ve].join("");if(Ie==="  "||Ie==="  /"||Ie===",,"||Ie===",,,"){const Le=[$,ne,ge].join(""),Ke=Le==="%%%"?100:Le===""?255:0;if(Ke){const nt=[Lc(+F/Ke,0,1),Lc(+K/Ke,0,1),Lc(+me/Ke,0,1),Ae?Au(+Ae,He):1];if(ef(nt))return nt}}return}}const T=m.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(T){const[M,R,F,$,H,K,ne,se,me]=T,ge=[F||" ",H||" ",ne].join("");if(ge==="  "||ge==="  /"||ge===",,"||ge===",,,"){const ve=[+R,Lc(+$,0,100),Lc(+K,0,100),se?Au(+se,me):1];if(ef(ve))return(function([Ae,He,Ie,Le]){function Ke(nt){const Ct=(nt+Ae/30)%12,Ut=He*Math.min(Ie,1-Ie);return Ie-Ut*Math.max(-1,Math.min(Ct-3,9-Ct,1))}return Ae=kp(Ae),He/=100,Ie/=100,[Ke(0),Ke(8),Ke(4),Le]})(ve)}}})(a);return u?new sn(...u,!1):void 0}get rgb(){const{r:a,g:u,b:m,a:y}=this,T=y||1/0;return this.overwriteGetter("rgb",[a/T,u/T,m/T,y])}get hcl(){return this.overwriteGetter("hcl",(function(a){const[u,m,y,T]=Dp(a),M=Math.sqrt(m*m+y*y);return[Math.round(1e4*M)?kp(Math.atan2(y,m)*Lp):NaN,M,u,T]})(this.rgb))}get lab(){return this.overwriteGetter("lab",Dp(this.rgb))}overwriteGetter(a,u){return Object.defineProperty(this,a,{value:u}),u}toString(){const[a,u,m,y]=this.rgb;return`rgba(${[a,u,m].map((T=>Math.round(255*T))).join(",")},${y})`}static interpolate(a,u,m,y="rgb"){switch(y){case"rgb":{const[T,M,R,F]=Dc(a.rgb,u.rgb,m);return new sn(T,M,R,F,!1)}case"hcl":{const[T,M,R,F]=a.hcl,[$,H,K,ne]=u.hcl;let se,me;if(isNaN(T)||isNaN($))isNaN(T)?isNaN($)?se=NaN:(se=$,R!==1&&R!==0||(me=H)):(se=T,K!==1&&K!==0||(me=M));else{let Ie=$-T;$>T&&Ie>180?Ie-=360:$<T&&T-$>180&&(Ie+=360),se=T+m*Ie}const[ge,ve,Ae,He]=(function([Ie,Le,Ke,nt]){return Ie=isNaN(Ie)?0:Ie*Mu,zh([Ke,Math.cos(Ie)*Le,Math.sin(Ie)*Le,nt])})([se,me??ml(M,H,m),ml(R,K,m),ml(F,ne,m)]);return new sn(ge,ve,Ae,He,!1)}case"lab":{const[T,M,R,F]=zh(Dc(a.lab,u.lab,m));return new sn(T,M,R,F,!1)}}}}sn.black=new sn(0,0,0,1),sn.white=new sn(1,1,1,1),sn.transparent=new sn(0,0,0,0),sn.red=new sn(1,0,0,1);class $h{constructor(a,u,m){this.sensitivity=a?u?"variant":"case":u?"accent":"base",this.locale=m,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(a,u){return this.collator.compare(a,u)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const Fp=["bottom","center","top"];class Fc{constructor(a,u,m,y,T,M){this.text=a,this.image=u,this.scale=m,this.fontStack=y,this.textColor=T,this.verticalAlign=M}}class Ns{constructor(a){this.sections=a}static fromString(a){return new Ns([new Fc(a,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some((a=>a.text.length!==0||a.image&&a.image.name.length!==0))}static factory(a){return a instanceof Ns?a:Ns.fromString(a)}toString(){return this.sections.length===0?"":this.sections.map((a=>a.text)).join("")}}class fs{constructor(a){this.values=a.slice()}static parse(a){if(a instanceof fs)return a;if(typeof a=="number")return new fs([a,a,a,a]);if(Array.isArray(a)&&!(a.length<1||a.length>4)){for(const u of a)if(typeof u!="number")return;switch(a.length){case 1:a=[a[0],a[0],a[0],a[0]];break;case 2:a=[a[0],a[1],a[0],a[1]];break;case 3:a=[a[0],a[1],a[2],a[1]]}return new fs(a)}}toString(){return JSON.stringify(this.values)}static interpolate(a,u,m){return new fs(Dc(a.values,u.values,m))}}class xn{constructor(a){this.values=a.slice()}static parse(a){if(a instanceof xn)return a;if(typeof a=="number")return new xn([a]);if(Array.isArray(a)){for(const u of a)if(typeof u!="number")return;return new xn(a)}}toString(){return JSON.stringify(this.values)}static interpolate(a,u,m){return new xn(Dc(a.values,u.values,m))}}class qi{constructor(a){this.values=a.slice()}static parse(a){if(a instanceof qi)return a;if(typeof a=="string"){const m=sn.parse(a);return m?new qi([m]):void 0}if(!Array.isArray(a))return;const u=[];for(const m of a){if(typeof m!="string")return;const y=sn.parse(m);if(!y)return;u.push(y)}return new qi(u)}toString(){return JSON.stringify(this.values)}static interpolate(a,u,m,y="rgb"){const T=[];if(a.values.length!=u.values.length)throw new Error(`colorArray: Arrays have mismatched length (${a.values.length} vs. ${u.values.length}), cannot interpolate.`);for(let M=0;M<a.values.length;M++)T.push(sn.interpolate(a.values[M],u.values[M],m,y));return new qi(T)}}class Bn extends Error{constructor(a){super(a),this.name="RuntimeError"}toJSON(){return this.message}}const Ma=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Ss{constructor(a){this.values=a.slice()}static parse(a){if(a instanceof Ss)return a;if(Array.isArray(a)&&!(a.length<1)&&a.length%2==0){for(let u=0;u<a.length;u+=2){const m=a[u],y=a[u+1];if(typeof m!="string"||!Ma.has(m)||!Array.isArray(y)||y.length!==2||typeof y[0]!="number"||typeof y[1]!="number")return}return new Ss(a)}}toString(){return JSON.stringify(this.values)}static interpolate(a,u,m){const y=a.values,T=u.values;if(y.length!==T.length)throw new Bn(`Cannot interpolate values of different length. from: ${a.toString()}, to: ${u.toString()}`);const M=[];for(let R=0;R<y.length;R+=2){if(y[R]!==T[R])throw new Bn(`Cannot interpolate values containing mismatched anchors. from[${R}]: ${y[R]}, to[${R}]: ${T[R]}`);M.push(y[R]);const[F,$]=y[R+1],[H,K]=T[R+1];M.push([ml(F,H,m),ml($,K,m)])}return new Ss(M)}}class ao{constructor(a){this.name=a.name,this.available=a.available}toString(){return this.name}static fromString(a){return a?new ao({name:a,available:!1}):null}}class $s{constructor(a,u,m){this.from=a,this.to=u,this.transition=m}static interpolate(a,u,m){return new $s(a,u,m)}static parse(a){return a instanceof $s?a:Array.isArray(a)&&a.length===3&&typeof a[0]=="string"&&typeof a[1]=="string"&&typeof a[2]=="number"?new $s(a[0],a[1],a[2]):typeof a=="object"&&typeof a.from=="string"&&typeof a.to=="string"&&typeof a.transition=="number"?new $s(a.from,a.to,a.transition):typeof a=="string"?new $s(a,a,1):void 0}}function Oc(h,a,u,m){return typeof h=="number"&&h>=0&&h<=255&&typeof a=="number"&&a>=0&&a<=255&&typeof u=="number"&&u>=0&&u<=255?m===void 0||typeof m=="number"&&m>=0&&m<=1?null:`Invalid rgba value [${[h,a,u,m].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof m=="number"?[h,a,u,m]:[h,a,u]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function gl(h){if(h===null||typeof h=="string"||typeof h=="boolean"||typeof h=="number"||h instanceof $s||h instanceof sn||h instanceof $h||h instanceof Ns||h instanceof fs||h instanceof xn||h instanceof qi||h instanceof Ss||h instanceof ao)return!0;if(Array.isArray(h)){for(const a of h)if(!gl(a))return!1;return!0}if(typeof h=="object"){for(const a in h)if(!gl(h[a]))return!1;return!0}return!1}function Pr(h){if(h===null)return Ci;if(typeof h=="string")return si;if(typeof h=="boolean")return pi;if(typeof h=="number")return Nt;if(h instanceof sn)return Wi;if(h instanceof $s)return wt;if(h instanceof $h)return Vi;if(h instanceof Ns)return Jn;if(h instanceof fs)return Xi;if(h instanceof xn)return on;if(h instanceof qi)return Gn;if(h instanceof Ss)return qn;if(h instanceof ao)return zr;if(Array.isArray(h)){const a=h.length;let u;for(const m of h){const y=Pr(m);if(u){if(u===y)continue;u=bi;break}u=y}return an(u||bi,a)}return Ri}function Xl(h){const a=typeof h;return h===null?"":a==="string"||a==="number"||a==="boolean"?String(h):h instanceof sn||h instanceof $s||h instanceof Ns||h instanceof fs||h instanceof xn||h instanceof qi||h instanceof Ss||h instanceof ao?h.toString():JSON.stringify(h)}class Uo{constructor(a,u){this.type=a,this.value=u}static parse(a,u){if(a.length!==2)return u.error(`'literal' expression requires exactly one argument, but found ${a.length-1} instead.`);if(!gl(a[1]))return u.error("invalid value");const m=a[1];let y=Pr(m);const T=u.expectedType;return y.kind!=="array"||y.N!==0||!T||T.kind!=="array"||typeof T.N=="number"&&T.N!==0||(y=T),new Uo(y,m)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const Pu={string:si,number:Nt,boolean:pi,object:Ri};class Ts{constructor(a,u){this.type=a,this.args=u}static parse(a,u){if(a.length<2)return u.error("Expected at least one argument.");let m,y=1;const T=a[0];if(T==="array"){let R,F;if(a.length>2){const $=a[1];if(typeof $!="string"||!($ in Pu)||$==="object")return u.error('The item type argument of "array" must be one of string, number, boolean',1);R=Pu[$],y++}else R=bi;if(a.length>3){if(a[2]!==null&&(typeof a[2]!="number"||a[2]<0||a[2]!==Math.floor(a[2])))return u.error('The length argument to "array" must be a positive integer literal',2);F=a[2],y++}m=an(R,F)}else{if(!Pu[T])throw new Error(`Types doesn't contain name = ${T}`);m=Pu[T]}const M=[];for(;y<a.length;y++){const R=u.parse(a[y],y,bi);if(!R)return null;M.push(R)}return new Ts(m,M)}evaluate(a){for(let u=0;u<this.args.length;u++){const m=this.args[u].evaluate(a);if(!so(this.type,Pr(m)))return m;if(u===this.args.length-1)throw new Bn(`Expected value to be of type ${rn(this.type)}, but found ${rn(Pr(m))} instead.`)}throw new Error}eachChild(a){this.args.forEach(a)}outputDefined(){return this.args.every((a=>a.outputDefined()))}}const Yl={"to-boolean":pi,"to-color":Wi,"to-number":Nt,"to-string":si};class Ca{constructor(a,u){this.type=a,this.args=u}static parse(a,u){if(a.length<2)return u.error("Expected at least one argument.");const m=a[0];if(!Yl[m])throw new Error(`Can't parse ${m} as it is not part of the known types`);if((m==="to-boolean"||m==="to-string")&&a.length!==2)return u.error("Expected one argument.");const y=Yl[m],T=[];for(let M=1;M<a.length;M++){const R=u.parse(a[M],M,bi);if(!R)return null;T.push(R)}return new Ca(y,T)}evaluate(a){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(a);case"color":{let u,m;for(const y of this.args){if(u=y.evaluate(a),m=null,u instanceof sn)return u;if(typeof u=="string"){const T=a.parseColor(u);if(T)return T}else if(Array.isArray(u)&&(m=u.length<3||u.length>4?`Invalid rgba value ${JSON.stringify(u)}: expected an array containing either three or four numeric values.`:Oc(u[0],u[1],u[2],u[3]),!m))return new sn(u[0]/255,u[1]/255,u[2]/255,u[3])}throw new Bn(m||`Could not parse color from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"padding":{let u;for(const m of this.args){u=m.evaluate(a);const y=fs.parse(u);if(y)return y}throw new Bn(`Could not parse padding from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"numberArray":{let u;for(const m of this.args){u=m.evaluate(a);const y=xn.parse(u);if(y)return y}throw new Bn(`Could not parse numberArray from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"colorArray":{let u;for(const m of this.args){u=m.evaluate(a);const y=qi.parse(u);if(y)return y}throw new Bn(`Could not parse colorArray from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"variableAnchorOffsetCollection":{let u;for(const m of this.args){u=m.evaluate(a);const y=Ss.parse(u);if(y)return y}throw new Bn(`Could not parse variableAnchorOffsetCollection from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"number":{let u=null;for(const m of this.args){if(u=m.evaluate(a),u===null)return 0;const y=Number(u);if(!isNaN(y))return y}throw new Bn(`Could not convert ${JSON.stringify(u)} to number.`)}case"formatted":return Ns.fromString(Xl(this.args[0].evaluate(a)));case"resolvedImage":return ao.fromString(Xl(this.args[0].evaluate(a)));case"projectionDefinition":return this.args[0].evaluate(a);default:return Xl(this.args[0].evaluate(a))}}eachChild(a){this.args.forEach(a)}outputDefined(){return this.args.every((a=>a.outputDefined()))}}const _l=["Unknown","Point","LineString","Polygon"];class jo{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache=new Map,this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?_l[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(a){let u=this._parseColorCache.get(a);return u||(u=sn.parse(a),this._parseColorCache.set(a,u)),u}}class vl{constructor(a,u,m=[],y,T=new Gi,M=[]){this.registry=a,this.path=m,this.key=m.map((R=>`[${R}]`)).join(""),this.scope=T,this.errors=M,this.expectedType=y,this._isConstant=u}parse(a,u,m,y,T={}){return u?this.concat(u,m,y)._parse(a,T):this._parse(a,T)}_parse(a,u){function m(y,T,M){return M==="assert"?new Ts(T,[y]):M==="coerce"?new Ca(T,[y]):y}if(a!==null&&typeof a!="string"&&typeof a!="boolean"&&typeof a!="number"||(a=["literal",a]),Array.isArray(a)){if(a.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const y=a[0];if(typeof y!="string")return this.error(`Expression name must be a string, but found ${typeof y} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const T=this.registry[y];if(T){let M=T.parse(a,this);if(!M)return null;if(this.expectedType){const R=this.expectedType,F=M.type;if(R.kind!=="string"&&R.kind!=="number"&&R.kind!=="boolean"&&R.kind!=="object"&&R.kind!=="array"||F.kind!=="value"){if(R.kind==="projectionDefinition"&&["string","array"].includes(F.kind)||["color","formatted","resolvedImage"].includes(R.kind)&&["value","string"].includes(F.kind)||["padding","numberArray"].includes(R.kind)&&["value","number","array"].includes(F.kind)||R.kind==="colorArray"&&["value","string","array"].includes(F.kind)||R.kind==="variableAnchorOffsetCollection"&&["value","array"].includes(F.kind))M=m(M,R,u.typeAnnotation||"coerce");else if(this.checkSubtype(R,F))return null}else M=m(M,R,u.typeAnnotation||"assert")}if(!(M instanceof Uo)&&M.type.kind!=="resolvedImage"&&this._isConstant(M)){const R=new jo;try{M=new Uo(M.type,M.evaluate(R))}catch(F){return this.error(F.message),null}}return M}return this.error(`Unknown expression "${y}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(a===void 0?"'undefined' value invalid. Use null instead.":typeof a=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof a} instead.`)}concat(a,u,m){const y=typeof a=="number"?this.path.concat(a):this.path,T=m?this.scope.concat(m):this.scope;return new vl(this.registry,this._isConstant,y,u||null,T,this.errors)}error(a,...u){const m=`${this.key}${u.map((y=>`[${y}]`)).join("")}`;this.errors.push(new Gt(m,a))}checkSubtype(a,u){const m=so(a,u);return m&&this.error(m),m}}class Nn{constructor(a,u){this.type=u.type,this.bindings=[].concat(a),this.result=u}evaluate(a){return this.result.evaluate(a)}eachChild(a){for(const u of this.bindings)a(u[1]);a(this.result)}static parse(a,u){if(a.length<4)return u.error(`Expected at least 3 arguments, but found ${a.length-1} instead.`);const m=[];for(let T=1;T<a.length-1;T+=2){const M=a[T];if(typeof M!="string")return u.error(`Expected string, but found ${typeof M} instead.`,T);if(/[^a-zA-Z0-9_]/.test(M))return u.error("Variable names must contain only alphanumeric characters or '_'.",T);const R=u.parse(a[T+1],T+1);if(!R)return null;m.push([M,R])}const y=u.parse(a[a.length-1],a.length-1,u.expectedType,m);return y?new Nn(m,y):null}outputDefined(){return this.result.outputDefined()}}class Kl{constructor(a,u){this.type=u.type,this.name=a,this.boundExpression=u}static parse(a,u){if(a.length!==2||typeof a[1]!="string")return u.error("'var' expression requires exactly one string literal argument.");const m=a[1];return u.scope.has(m)?new Kl(m,u.scope.get(m)):u.error(`Unknown variable "${m}". Make sure "${m}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(a){return this.boundExpression.evaluate(a)}eachChild(){}outputDefined(){return!1}}class _n{constructor(a,u,m){this.type=a,this.index=u,this.input=m}static parse(a,u){if(a.length!==3)return u.error(`Expected 2 arguments, but found ${a.length-1} instead.`);const m=u.parse(a[1],1,Nt),y=u.parse(a[2],2,an(u.expectedType||bi));return m&&y?new _n(y.type.itemType,m,y):null}evaluate(a){const u=this.index.evaluate(a),m=this.input.evaluate(a);if(u<0)throw new Bn(`Array index out of bounds: ${u} < 0.`);if(u>=m.length)throw new Bn(`Array index out of bounds: ${u} > ${m.length-1}.`);if(u!==Math.floor(u))throw new Bn(`Array index must be an integer, but found ${u} instead.`);return m[u]}eachChild(a){a(this.index),a(this.input)}outputDefined(){return!1}}class Ji{constructor(a,u){this.type=pi,this.needle=a,this.haystack=u}static parse(a,u){if(a.length!==3)return u.error(`Expected 2 arguments, but found ${a.length-1} instead.`);const m=u.parse(a[1],1,bi),y=u.parse(a[2],2,bi);return m&&y?pl(m.type,[pi,si,Nt,Ci,bi])?new Ji(m,y):u.error(`Expected first argument to be of type boolean, string, number or null, but found ${rn(m.type)} instead`):null}evaluate(a){const u=this.needle.evaluate(a),m=this.haystack.evaluate(a);if(!m)return!1;if(!To(u,["boolean","string","number","null"]))throw new Bn(`Expected first argument to be of type boolean, string, number or null, but found ${rn(Pr(u))} instead.`);if(!To(m,["string","array"]))throw new Bn(`Expected second argument to be of type array or string, but found ${rn(Pr(m))} instead.`);return m.indexOf(u)>=0}eachChild(a){a(this.needle),a(this.haystack)}outputDefined(){return!0}}class Jl{constructor(a,u,m){this.type=Nt,this.needle=a,this.haystack=u,this.fromIndex=m}static parse(a,u){if(a.length<=2||a.length>=5)return u.error(`Expected 2 or 3 arguments, but found ${a.length-1} instead.`);const m=u.parse(a[1],1,bi),y=u.parse(a[2],2,bi);if(!m||!y)return null;if(!pl(m.type,[pi,si,Nt,Ci,bi]))return u.error(`Expected first argument to be of type boolean, string, number or null, but found ${rn(m.type)} instead`);if(a.length===4){const T=u.parse(a[3],3,Nt);return T?new Jl(m,y,T):null}return new Jl(m,y)}evaluate(a){const u=this.needle.evaluate(a),m=this.haystack.evaluate(a);if(!To(u,["boolean","string","number","null"]))throw new Bn(`Expected first argument to be of type boolean, string, number or null, but found ${rn(Pr(u))} instead.`);let y;if(this.fromIndex&&(y=this.fromIndex.evaluate(a)),To(m,["string"])){const T=m.indexOf(u,y);return T===-1?-1:[...m.slice(0,T)].length}if(To(m,["array"]))return m.indexOf(u,y);throw new Bn(`Expected second argument to be of type array or string, but found ${rn(Pr(m))} instead.`)}eachChild(a){a(this.needle),a(this.haystack),this.fromIndex&&a(this.fromIndex)}outputDefined(){return!1}}class bn{constructor(a,u,m,y,T,M){this.inputType=a,this.type=u,this.input=m,this.cases=y,this.outputs=T,this.otherwise=M}static parse(a,u){if(a.length<5)return u.error(`Expected at least 4 arguments, but found only ${a.length-1}.`);if(a.length%2!=1)return u.error("Expected an even number of arguments.");let m,y;u.expectedType&&u.expectedType.kind!=="value"&&(y=u.expectedType);const T={},M=[];for(let $=2;$<a.length-1;$+=2){let H=a[$];const K=a[$+1];Array.isArray(H)||(H=[H]);const ne=u.concat($);if(H.length===0)return ne.error("Expected at least one branch label.");for(const me of H){if(typeof me!="number"&&typeof me!="string")return ne.error("Branch labels must be numbers or strings.");if(typeof me=="number"&&Math.abs(me)>Number.MAX_SAFE_INTEGER)return ne.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof me=="number"&&Math.floor(me)!==me)return ne.error("Numeric branch labels must be integer values.");if(m){if(ne.checkSubtype(m,Pr(me)))return null}else m=Pr(me);if(T[String(me)]!==void 0)return ne.error("Branch labels must be unique.");T[String(me)]=M.length}const se=u.parse(K,$,y);if(!se)return null;y=y||se.type,M.push(se)}const R=u.parse(a[1],1,bi);if(!R)return null;const F=u.parse(a[a.length-1],a.length-1,y);return F?R.type.kind!=="value"&&u.concat(1).checkSubtype(m,R.type)?null:new bn(m,y,R,T,M,F):null}evaluate(a){const u=this.input.evaluate(a);return(Pr(u)===this.inputType&&this.outputs[this.cases[u]]||this.otherwise).evaluate(a)}eachChild(a){a(this.input),this.outputs.forEach(a),a(this.otherwise)}outputDefined(){return this.outputs.every((a=>a.outputDefined()))&&this.otherwise.outputDefined()}}class Iu{constructor(a,u,m){this.type=a,this.branches=u,this.otherwise=m}static parse(a,u){if(a.length<4)return u.error(`Expected at least 3 arguments, but found only ${a.length-1}.`);if(a.length%2!=0)return u.error("Expected an odd number of arguments.");let m;u.expectedType&&u.expectedType.kind!=="value"&&(m=u.expectedType);const y=[];for(let M=1;M<a.length-1;M+=2){const R=u.parse(a[M],M,pi);if(!R)return null;const F=u.parse(a[M+1],M+1,m);if(!F)return null;y.push([R,F]),m=m||F.type}const T=u.parse(a[a.length-1],a.length-1,m);if(!T)return null;if(!m)throw new Error("Can't infer output type");return new Iu(m,y,T)}evaluate(a){for(const[u,m]of this.branches)if(u.evaluate(a))return m.evaluate(a);return this.otherwise.evaluate(a)}eachChild(a){for(const[u,m]of this.branches)a(u),a(m);a(this.otherwise)}outputDefined(){return this.branches.every((([a,u])=>u.outputDefined()))&&this.otherwise.outputDefined()}}class Mo{constructor(a,u,m,y){this.type=a,this.input=u,this.beginIndex=m,this.endIndex=y}static parse(a,u){if(a.length<=2||a.length>=5)return u.error(`Expected 2 or 3 arguments, but found ${a.length-1} instead.`);const m=u.parse(a[1],1,bi),y=u.parse(a[2],2,Nt);if(!m||!y)return null;if(!pl(m.type,[an(bi),si,bi]))return u.error(`Expected first argument to be of type array or string, but found ${rn(m.type)} instead`);if(a.length===4){const T=u.parse(a[3],3,Nt);return T?new Mo(m.type,m,y,T):null}return new Mo(m.type,m,y)}evaluate(a){const u=this.input.evaluate(a),m=this.beginIndex.evaluate(a);let y;if(this.endIndex&&(y=this.endIndex.evaluate(a)),To(u,["string"]))return[...u].slice(m,y).join("");if(To(u,["array"]))return u.slice(m,y);throw new Bn(`Expected first argument to be of type array or string, but found ${rn(Pr(u))} instead.`)}eachChild(a){a(this.input),a(this.beginIndex),this.endIndex&&a(this.endIndex)}outputDefined(){return!1}}function Ql(h,a){const u=h.length-1;let m,y,T=0,M=u,R=0;for(;T<=M;)if(R=Math.floor((T+M)/2),m=h[R],y=h[R+1],m<=a){if(R===u||a<y)return R;T=R+1}else{if(!(m>a))throw new Bn("Input is not a number.");M=R-1}return 0}class Ea{constructor(a,u,m){this.type=a,this.input=u,this.labels=[],this.outputs=[];for(const[y,T]of m)this.labels.push(y),this.outputs.push(T)}static parse(a,u){if(a.length-1<4)return u.error(`Expected at least 4 arguments, but found only ${a.length-1}.`);if((a.length-1)%2!=0)return u.error("Expected an even number of arguments.");const m=u.parse(a[1],1,Nt);if(!m)return null;const y=[];let T=null;u.expectedType&&u.expectedType.kind!=="value"&&(T=u.expectedType);for(let M=1;M<a.length;M+=2){const R=M===1?-1/0:a[M],F=a[M+1],$=M,H=M+1;if(typeof R!="number")return u.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',$);if(y.length&&y[y.length-1][0]>=R)return u.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',$);const K=u.parse(F,H,T);if(!K)return null;T=T||K.type,y.push([R,K])}return new Ea(T,m,y)}evaluate(a){const u=this.labels,m=this.outputs;if(u.length===1)return m[0].evaluate(a);const y=this.input.evaluate(a);if(y<=u[0])return m[0].evaluate(a);const T=u.length;return y>=u[T-1]?m[T-1].evaluate(a):m[Ql(u,y)].evaluate(a)}eachChild(a){a(this.input);for(const u of this.outputs)a(u)}outputDefined(){return this.outputs.every((a=>a.outputDefined()))}}function Op(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var Ru,tf,b_=(function(){if(tf)return Ru;function h(a,u,m,y){this.cx=3*a,this.bx=3*(m-a)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*u,this.by=3*(y-u)-this.cy,this.ay=1-this.cy-this.by,this.p1x=a,this.p1y=u,this.p2x=m,this.p2y=y}return tf=1,Ru=h,h.prototype={sampleCurveX:function(a){return((this.ax*a+this.bx)*a+this.cx)*a},sampleCurveY:function(a){return((this.ay*a+this.by)*a+this.cy)*a},sampleCurveDerivativeX:function(a){return(3*this.ax*a+2*this.bx)*a+this.cx},solveCurveX:function(a,u){if(u===void 0&&(u=1e-6),a<0)return 0;if(a>1)return 1;for(var m=a,y=0;y<8;y++){var T=this.sampleCurveX(m)-a;if(Math.abs(T)<u)return m;var M=this.sampleCurveDerivativeX(m);if(Math.abs(M)<1e-6)break;m-=T/M}var R=0,F=1;for(m=a,y=0;y<20&&(T=this.sampleCurveX(m),!(Math.abs(T-a)<u));y++)a>T?R=m:F=m,m=.5*(F-R)+R;return m},solve:function(a,u){return this.sampleCurveY(this.solveCurveX(a,u))}},Ru})(),zp=Op(b_);class yr{constructor(a,u,m,y,T){this.type=a,this.operator=u,this.interpolation=m,this.input=y,this.labels=[],this.outputs=[];for(const[M,R]of T)this.labels.push(M),this.outputs.push(R)}static interpolationFactor(a,u,m,y){let T=0;if(a.name==="exponential")T=Go(u,a.base,m,y);else if(a.name==="linear")T=Go(u,1,m,y);else if(a.name==="cubic-bezier"){const M=a.controlPoints;T=new zp(M[0],M[1],M[2],M[3]).solve(Go(u,1,m,y))}return T}static parse(a,u){let[m,y,T,...M]=a;if(!Array.isArray(y)||y.length===0)return u.error("Expected an interpolation type expression.",1);if(y[0]==="linear")y={name:"linear"};else if(y[0]==="exponential"){const $=y[1];if(typeof $!="number")return u.error("Exponential interpolation requires a numeric base.",1,1);y={name:"exponential",base:$}}else{if(y[0]!=="cubic-bezier")return u.error(`Unknown interpolation type ${String(y[0])}`,1,0);{const $=y.slice(1);if($.length!==4||$.some((H=>typeof H!="number"||H<0||H>1)))return u.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);y={name:"cubic-bezier",controlPoints:$}}}if(a.length-1<4)return u.error(`Expected at least 4 arguments, but found only ${a.length-1}.`);if((a.length-1)%2!=0)return u.error("Expected an even number of arguments.");if(T=u.parse(T,2,Nt),!T)return null;const R=[];let F=null;m!=="interpolate-hcl"&&m!=="interpolate-lab"||u.expectedType==Gn?u.expectedType&&u.expectedType.kind!=="value"&&(F=u.expectedType):F=Wi;for(let $=0;$<M.length;$+=2){const H=M[$],K=M[$+1],ne=$+3,se=$+4;if(typeof H!="number")return u.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',ne);if(R.length&&R[R.length-1][0]>=H)return u.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',ne);const me=u.parse(K,se,F);if(!me)return null;F=F||me.type,R.push([H,me])}return Ar(F,Nt)||Ar(F,wt)||Ar(F,Wi)||Ar(F,Xi)||Ar(F,on)||Ar(F,Gn)||Ar(F,qn)||Ar(F,an(Nt))?new yr(F,m,y,T,R):u.error(`Type ${rn(F)} is not interpolatable.`)}evaluate(a){const u=this.labels,m=this.outputs;if(u.length===1)return m[0].evaluate(a);const y=this.input.evaluate(a);if(y<=u[0])return m[0].evaluate(a);const T=u.length;if(y>=u[T-1])return m[T-1].evaluate(a);const M=Ql(u,y),R=yr.interpolationFactor(this.interpolation,y,u[M],u[M+1]),F=m[M].evaluate(a),$=m[M+1].evaluate(a);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return ml(F,$,R);case"color":return sn.interpolate(F,$,R);case"padding":return fs.interpolate(F,$,R);case"colorArray":return qi.interpolate(F,$,R);case"numberArray":return xn.interpolate(F,$,R);case"variableAnchorOffsetCollection":return Ss.interpolate(F,$,R);case"array":return Dc(F,$,R);case"projectionDefinition":return $s.interpolate(F,$,R)}case"interpolate-hcl":switch(this.type.kind){case"color":return sn.interpolate(F,$,R,"hcl");case"colorArray":return qi.interpolate(F,$,R,"hcl")}case"interpolate-lab":switch(this.type.kind){case"color":return sn.interpolate(F,$,R,"lab");case"colorArray":return qi.interpolate(F,$,R,"lab")}}}eachChild(a){a(this.input);for(const u of this.outputs)a(u)}outputDefined(){return this.outputs.every((a=>a.outputDefined()))}}function Go(h,a,u,m){const y=m-u,T=h-u;return y===0?0:a===1?T/y:(Math.pow(a,T)-1)/(Math.pow(a,y)-1)}const sr={color:sn.interpolate,number:ml,padding:fs.interpolate,numberArray:xn.interpolate,colorArray:qi.interpolate,variableAnchorOffsetCollection:Ss.interpolate,array:Dc};class ec{constructor(a,u){this.type=a,this.args=u}static parse(a,u){if(a.length<2)return u.error("Expected at least one argument.");let m=null;const y=u.expectedType;y&&y.kind!=="value"&&(m=y);const T=[];for(const R of a.slice(1)){const F=u.parse(R,1+T.length,m,void 0,{typeAnnotation:"omit"});if(!F)return null;m=m||F.type,T.push(F)}if(!m)throw new Error("No output type");const M=y&&T.some((R=>so(y,R.type)));return new ec(M?bi:m,T)}evaluate(a){let u,m=null,y=0;for(const T of this.args)if(y++,m=T.evaluate(a),m&&m instanceof ao&&!m.available&&(u||(u=m.name),m=null,y===this.args.length&&(m=u)),m!==null)break;return m}eachChild(a){this.args.forEach(a)}outputDefined(){return this.args.every((a=>a.outputDefined()))}}function nf(h,a){return h==="=="||h==="!="?a.kind==="boolean"||a.kind==="string"||a.kind==="number"||a.kind==="null"||a.kind==="value":a.kind==="string"||a.kind==="number"||a.kind==="value"}function Lu(h,a,u,m){return m.compare(a,u)===0}function br(h,a,u){const m=h!=="=="&&h!=="!=";return class uF{constructor(T,M,R){this.type=pi,this.lhs=T,this.rhs=M,this.collator=R,this.hasUntypedArgument=T.type.kind==="value"||M.type.kind==="value"}static parse(T,M){if(T.length!==3&&T.length!==4)return M.error("Expected two or three arguments.");const R=T[0];let F=M.parse(T[1],1,bi);if(!F)return null;if(!nf(R,F.type))return M.concat(1).error(`"${R}" comparisons are not supported for type '${rn(F.type)}'.`);let $=M.parse(T[2],2,bi);if(!$)return null;if(!nf(R,$.type))return M.concat(2).error(`"${R}" comparisons are not supported for type '${rn($.type)}'.`);if(F.type.kind!==$.type.kind&&F.type.kind!=="value"&&$.type.kind!=="value")return M.error(`Cannot compare types '${rn(F.type)}' and '${rn($.type)}'.`);m&&(F.type.kind==="value"&&$.type.kind!=="value"?F=new Ts($.type,[F]):F.type.kind!=="value"&&$.type.kind==="value"&&($=new Ts(F.type,[$])));let H=null;if(T.length===4){if(F.type.kind!=="string"&&$.type.kind!=="string"&&F.type.kind!=="value"&&$.type.kind!=="value")return M.error("Cannot use collator to compare non-string types.");if(H=M.parse(T[3],3,Vi),!H)return null}return new uF(F,$,H)}evaluate(T){const M=this.lhs.evaluate(T),R=this.rhs.evaluate(T);if(m&&this.hasUntypedArgument){const F=Pr(M),$=Pr(R);if(F.kind!==$.kind||F.kind!=="string"&&F.kind!=="number")throw new Bn(`Expected arguments for "${h}" to be (string, string) or (number, number), but found (${F.kind}, ${$.kind}) instead.`)}if(this.collator&&!m&&this.hasUntypedArgument){const F=Pr(M),$=Pr(R);if(F.kind!=="string"||$.kind!=="string")return a(T,M,R)}return this.collator?u(T,M,R,this.collator.evaluate(T)):a(T,M,R)}eachChild(T){T(this.lhs),T(this.rhs),this.collator&&T(this.collator)}outputDefined(){return!0}}}const Bp=br("==",(function(h,a,u){return a===u}),Lu),rf=br("!=",(function(h,a,u){return a!==u}),(function(h,a,u,m){return!Lu(0,a,u,m)})),Np=br("<",(function(h,a,u){return a<u}),(function(h,a,u,m){return m.compare(a,u)<0})),sf=br(">",(function(h,a,u){return a>u}),(function(h,a,u,m){return m.compare(a,u)>0})),Aa=br("<=",(function(h,a,u){return a<=u}),(function(h,a,u,m){return m.compare(a,u)<=0})),Vh=br(">=",(function(h,a,u){return a>=u}),(function(h,a,u,m){return m.compare(a,u)>=0}));class tc{constructor(a,u,m){this.type=Vi,this.locale=m,this.caseSensitive=a,this.diacriticSensitive=u}static parse(a,u){if(a.length!==2)return u.error("Expected one argument.");const m=a[1];if(typeof m!="object"||Array.isArray(m))return u.error("Collator options argument must be an object.");const y=u.parse(m["case-sensitive"]!==void 0&&m["case-sensitive"],1,pi);if(!y)return null;const T=u.parse(m["diacritic-sensitive"]!==void 0&&m["diacritic-sensitive"],1,pi);if(!T)return null;let M=null;return m.locale&&(M=u.parse(m.locale,1,si),!M)?null:new tc(y,T,M)}evaluate(a){return new $h(this.caseSensitive.evaluate(a),this.diacriticSensitive.evaluate(a),this.locale?this.locale.evaluate(a):null)}eachChild(a){a(this.caseSensitive),a(this.diacriticSensitive),this.locale&&a(this.locale)}outputDefined(){return!1}}class Uh{constructor(a,u,m,y,T){this.type=si,this.number=a,this.locale=u,this.currency=m,this.minFractionDigits=y,this.maxFractionDigits=T}static parse(a,u){if(a.length!==3)return u.error("Expected two arguments.");const m=u.parse(a[1],1,Nt);if(!m)return null;const y=a[2];if(typeof y!="object"||Array.isArray(y))return u.error("NumberFormat options argument must be an object.");let T=null;if(y.locale&&(T=u.parse(y.locale,1,si),!T))return null;let M=null;if(y.currency&&(M=u.parse(y.currency,1,si),!M))return null;let R=null;if(y["min-fraction-digits"]&&(R=u.parse(y["min-fraction-digits"],1,Nt),!R))return null;let F=null;return y["max-fraction-digits"]&&(F=u.parse(y["max-fraction-digits"],1,Nt),!F)?null:new Uh(m,T,M,R,F)}evaluate(a){return new Intl.NumberFormat(this.locale?this.locale.evaluate(a):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(a):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(a):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(a):void 0}).format(this.number.evaluate(a))}eachChild(a){a(this.number),this.locale&&a(this.locale),this.currency&&a(this.currency),this.minFractionDigits&&a(this.minFractionDigits),this.maxFractionDigits&&a(this.maxFractionDigits)}outputDefined(){return!1}}class Pa{constructor(a){this.type=Jn,this.sections=a}static parse(a,u){if(a.length<2)return u.error("Expected at least one argument.");const m=a[1];if(!Array.isArray(m)&&typeof m=="object")return u.error("First argument must be an image or text section.");const y=[];let T=!1;for(let M=1;M<=a.length-1;++M){const R=a[M];if(T&&typeof R=="object"&&!Array.isArray(R)){T=!1;let F=null;if(R["font-scale"]&&(F=u.parse(R["font-scale"],1,Nt),!F))return null;let $=null;if(R["text-font"]&&($=u.parse(R["text-font"],1,an(si)),!$))return null;let H=null;if(R["text-color"]&&(H=u.parse(R["text-color"],1,Wi),!H))return null;let K=null;if(R["vertical-align"]){if(typeof R["vertical-align"]=="string"&&!Fp.includes(R["vertical-align"]))return u.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${R["vertical-align"]}' instead.`);if(K=u.parse(R["vertical-align"],1,si),!K)return null}const ne=y[y.length-1];ne.scale=F,ne.font=$,ne.textColor=H,ne.verticalAlign=K}else{const F=u.parse(a[M],1,bi);if(!F)return null;const $=F.type.kind;if($!=="string"&&$!=="value"&&$!=="null"&&$!=="resolvedImage")return u.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");T=!0,y.push({content:F,scale:null,font:null,textColor:null,verticalAlign:null})}}return new Pa(y)}evaluate(a){return new Ns(this.sections.map((u=>{const m=u.content.evaluate(a);return Pr(m)===zr?new Fc("",m,null,null,null,u.verticalAlign?u.verticalAlign.evaluate(a):null):new Fc(Xl(m),null,u.scale?u.scale.evaluate(a):null,u.font?u.font.evaluate(a).join(","):null,u.textColor?u.textColor.evaluate(a):null,u.verticalAlign?u.verticalAlign.evaluate(a):null)})))}eachChild(a){for(const u of this.sections)a(u.content),u.scale&&a(u.scale),u.font&&a(u.font),u.textColor&&a(u.textColor),u.verticalAlign&&a(u.verticalAlign)}outputDefined(){return!1}}class yl{constructor(a){this.type=zr,this.input=a}static parse(a,u){if(a.length!==2)return u.error("Expected two arguments.");const m=u.parse(a[1],1,si);return m?new yl(m):u.error("No image name provided.")}evaluate(a){const u=this.input.evaluate(a),m=ao.fromString(u);return m&&a.availableImages&&(m.available=a.availableImages.indexOf(u)>-1),m}eachChild(a){a(this.input)}outputDefined(){return!1}}class bl{constructor(a){this.type=Nt,this.input=a}static parse(a,u){if(a.length!==2)return u.error(`Expected 1 argument, but found ${a.length-1} instead.`);const m=u.parse(a[1],1);return m?m.type.kind!=="array"&&m.type.kind!=="string"&&m.type.kind!=="value"?u.error(`Expected argument of type string or array, but found ${rn(m.type)} instead.`):new bl(m):null}evaluate(a){const u=this.input.evaluate(a);if(typeof u=="string")return[...u].length;if(Array.isArray(u))return u.length;throw new Bn(`Expected value to be of type string or array, but found ${rn(Pr(u))} instead.`)}eachChild(a){a(this.input)}outputDefined(){return!1}}const Wr=8192;function $p(h,a){const u=(180+h[0])/360,m=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+h[1]*Math.PI/360)))/360,y=Math.pow(2,a.z);return[Math.round(u*y*Wr),Math.round(m*y*Wr)]}function zc(h,a){const u=Math.pow(2,a.z);return[(y=(h[0]/Wr+a.x)/u,360*y-180),(m=(h[1]/Wr+a.y)/u,360/Math.PI*Math.atan(Math.exp((180-360*m)*Math.PI/180))-90)];var m,y}function qo(h,a){h[0]=Math.min(h[0],a[0]),h[1]=Math.min(h[1],a[1]),h[2]=Math.max(h[2],a[0]),h[3]=Math.max(h[3],a[1])}function ic(h,a){return!(h[0]<=a[0]||h[2]>=a[2]||h[1]<=a[1]||h[3]>=a[3])}function x_(h,a,u){const m=h[0]-a[0],y=h[1]-a[1],T=h[0]-u[0],M=h[1]-u[1];return m*M-T*y==0&&m*T<=0&&y*M<=0}function jh(h,a,u,m){return(y=[m[0]-u[0],m[1]-u[1]])[0]*(T=[a[0]-h[0],a[1]-h[1]])[1]-y[1]*T[0]!=0&&!(!af(h,a,u,m)||!af(u,m,h,a));var y,T}function w_(h,a,u){for(const m of u)for(let y=0;y<m.length-1;++y)if(jh(h,a,m[y],m[y+1]))return!0;return!1}function Ia(h,a,u=!1){let m=!1;for(const R of a)for(let F=0;F<R.length-1;F++){if(x_(h,R[F],R[F+1]))return u;(T=R[F])[1]>(y=h)[1]!=(M=R[F+1])[1]>y[1]&&y[0]<(M[0]-T[0])*(y[1]-T[1])/(M[1]-T[1])+T[0]&&(m=!m)}var y,T,M;return m}function Bc(h,a){for(const u of a)if(Ia(h,u))return!0;return!1}function Vp(h,a){for(const u of h)if(!Ia(u,a))return!1;for(let u=0;u<h.length-1;++u)if(w_(h[u],h[u+1],a))return!1;return!0}function of(h,a){for(const u of a)if(Vp(h,u))return!0;return!1}function af(h,a,u,m){const y=m[0]-u[0],T=m[1]-u[1],M=(h[0]-u[0])*T-y*(h[1]-u[1]),R=(a[0]-u[0])*T-y*(a[1]-u[1]);return M>0&&R<0||M<0&&R>0}function xl(h,a,u){const m=[];for(let y=0;y<h.length;y++){const T=[];for(let M=0;M<h[y].length;M++){const R=$p(h[y][M],u);qo(a,R),T.push(R)}m.push(T)}return m}function ku(h,a,u){const m=[];for(let y=0;y<h.length;y++){const T=xl(h[y],a,u);m.push(T)}return m}function lf(h,a,u,m){if(h[0]<u[0]||h[0]>u[2]){const y=.5*m;let T=h[0]-u[0]>y?-m:u[0]-h[0]>y?m:0;T===0&&(T=h[0]-u[2]>y?-m:u[2]-h[0]>y?m:0),h[0]+=T}qo(a,h)}function Up(h,a,u,m){const y=Math.pow(2,m.z)*Wr,T=[m.x*Wr,m.y*Wr],M=[];for(const R of h)for(const F of R){const $=[F.x+T[0],F.y+T[1]];lf($,a,u,y),M.push($)}return M}function jp(h,a,u,m){const y=Math.pow(2,m.z)*Wr,T=[m.x*Wr,m.y*Wr],M=[];for(const F of h){const $=[];for(const H of F){const K=[H.x+T[0],H.y+T[1]];qo(a,K),$.push(K)}M.push($)}if(a[2]-a[0]<=y/2){(R=a)[0]=R[1]=1/0,R[2]=R[3]=-1/0;for(const F of M)for(const $ of F)lf($,a,u,y)}var R;return M}class nc{constructor(a,u){this.type=pi,this.geojson=a,this.geometries=u}static parse(a,u){if(a.length!==2)return u.error(`'within' expression requires exactly one argument, but found ${a.length-1} instead.`);if(gl(a[1])){const m=a[1];if(m.type==="FeatureCollection"){const y=[];for(const T of m.features){const{type:M,coordinates:R}=T.geometry;M==="Polygon"&&y.push(R),M==="MultiPolygon"&&y.push(...R)}if(y.length)return new nc(m,{type:"MultiPolygon",coordinates:y})}else if(m.type==="Feature"){const y=m.geometry.type;if(y==="Polygon"||y==="MultiPolygon")return new nc(m,m.geometry)}else if(m.type==="Polygon"||m.type==="MultiPolygon")return new nc(m,m)}return u.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(a){if(a.geometry()!=null&&a.canonicalID()!=null){if(a.geometryType()==="Point")return(function(u,m){const y=[1/0,1/0,-1/0,-1/0],T=[1/0,1/0,-1/0,-1/0],M=u.canonicalID();if(m.type==="Polygon"){const R=xl(m.coordinates,T,M),F=Up(u.geometry(),y,T,M);if(!ic(y,T))return!1;for(const $ of F)if(!Ia($,R))return!1}if(m.type==="MultiPolygon"){const R=ku(m.coordinates,T,M),F=Up(u.geometry(),y,T,M);if(!ic(y,T))return!1;for(const $ of F)if(!Bc($,R))return!1}return!0})(a,this.geometries);if(a.geometryType()==="LineString")return(function(u,m){const y=[1/0,1/0,-1/0,-1/0],T=[1/0,1/0,-1/0,-1/0],M=u.canonicalID();if(m.type==="Polygon"){const R=xl(m.coordinates,T,M),F=jp(u.geometry(),y,T,M);if(!ic(y,T))return!1;for(const $ of F)if(!Vp($,R))return!1}if(m.type==="MultiPolygon"){const R=ku(m.coordinates,T,M),F=jp(u.geometry(),y,T,M);if(!ic(y,T))return!1;for(const $ of F)if(!of($,R))return!1}return!0})(a,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let Nc=class{constructor(h=[],a=(u,m)=>u<m?-1:u>m?1:0){if(this.data=h,this.length=this.data.length,this.compare=a,this.length>0)for(let u=(this.length>>1)-1;u>=0;u--)this._down(u)}push(h){this.data.push(h),this._up(this.length++)}pop(){if(this.length===0)return;const h=this.data[0],a=this.data.pop();return--this.length>0&&(this.data[0]=a,this._down(0)),h}peek(){return this.data[0]}_up(h){const{data:a,compare:u}=this,m=a[h];for(;h>0;){const y=h-1>>1,T=a[y];if(u(m,T)>=0)break;a[h]=T,h=y}a[h]=m}_down(h){const{data:a,compare:u}=this,m=this.length>>1,y=a[h];for(;h<m;){let T=1+(h<<1);const M=T+1;if(M<this.length&&u(a[M],a[T])<0&&(T=M),u(a[T],y)>=0)break;a[h]=a[T],h=T}a[h]=y}};function Ra(h,a,u=0,m=h.length-1,y=Gp){for(;m>u;){if(m-u>600){const F=m-u+1,$=a-u+1,H=Math.log(F),K=.5*Math.exp(2*H/3),ne=.5*Math.sqrt(H*K*(F-K)/F)*($-F/2<0?-1:1);Ra(h,a,Math.max(u,Math.floor(a-$*K/F+ne)),Math.min(m,Math.floor(a+(F-$)*K/F+ne)),y)}const T=h[a];let M=u,R=m;for($c(h,u,a),y(h[m],T)>0&&$c(h,u,m);M<R;){for($c(h,M,R),M++,R--;y(h[M],T)<0;)M++;for(;y(h[R],T)>0;)R--}y(h[u],T)===0?$c(h,u,R):(R++,$c(h,R,m)),R<=a&&(u=R+1),a<=R&&(m=R-1)}}function $c(h,a,u){const m=h[a];h[a]=h[u],h[u]=m}function Gp(h,a){return h<a?-1:h>a?1:0}function Gh(h,a){if(h.length<=1)return[h];const u=[];let m,y;for(const T of h){const M=T_(T);M!==0&&(T.area=Math.abs(M),y===void 0&&(y=M<0),y===M<0?(m&&u.push(m),m=[T]):m.push(T))}if(m&&u.push(m),a>1)for(let T=0;T<u.length;T++)u[T].length<=a||(Ra(u[T],a,1,u[T].length-1,S_),u[T]=u[T].slice(0,a));return u}function S_(h,a){return a.area-h.area}function T_(h){let a=0;for(let u,m,y=0,T=h.length,M=T-1;y<T;M=y++)u=h[y],m=h[M],a+=(m.x-u.x)*(u.y+m.y);return a}const qp=1/298.257223563,Du=qp*(2-qp),Wp=Math.PI/180;class qh{constructor(a){const u=6378.137*Wp*1e3,m=Math.cos(a*Wp),y=1/(1-Du*(1-m*m)),T=Math.sqrt(y);this.kx=u*T*m,this.ky=u*T*y*(1-Du)}distance(a,u){const m=this.wrap(a[0]-u[0])*this.kx,y=(a[1]-u[1])*this.ky;return Math.sqrt(m*m+y*y)}pointOnLine(a,u){let m,y,T,M,R=1/0;for(let F=0;F<a.length-1;F++){let $=a[F][0],H=a[F][1],K=this.wrap(a[F+1][0]-$)*this.kx,ne=(a[F+1][1]-H)*this.ky,se=0;K===0&&ne===0||(se=(this.wrap(u[0]-$)*this.kx*K+(u[1]-H)*this.ky*ne)/(K*K+ne*ne),se>1?($=a[F+1][0],H=a[F+1][1]):se>0&&($+=K/this.kx*se,H+=ne/this.ky*se)),K=this.wrap(u[0]-$)*this.kx,ne=(u[1]-H)*this.ky;const me=K*K+ne*ne;me<R&&(R=me,m=$,y=H,T=F,M=se)}return{point:[m,y],index:T,t:Math.max(0,Math.min(1,M))}}wrap(a){for(;a<-180;)a+=360;for(;a>180;)a-=360;return a}}function Hp(h,a){return a[0]-h[0]}function Fu(h){return h[1]-h[0]+1}function lo(h,a){return h[1]>=h[0]&&h[1]<a}function Ou(h,a){if(h[0]>h[1])return[null,null];const u=Fu(h);if(a){if(u===2)return[h,null];const y=Math.floor(u/2);return[[h[0],h[0]+y],[h[0]+y,h[1]]]}if(u===1)return[h,null];const m=Math.floor(u/2)-1;return[[h[0],h[0]+m],[h[0]+m+1,h[1]]]}function La(h,a){if(!lo(a,h.length))return[1/0,1/0,-1/0,-1/0];const u=[1/0,1/0,-1/0,-1/0];for(let m=a[0];m<=a[1];++m)qo(u,h[m]);return u}function Wh(h){const a=[1/0,1/0,-1/0,-1/0];for(const u of h)for(const m of u)qo(a,m);return a}function zu(h){return h[0]!==-1/0&&h[1]!==-1/0&&h[2]!==1/0&&h[3]!==1/0}function Bu(h,a,u){if(!zu(h)||!zu(a))return NaN;let m=0,y=0;return h[2]<a[0]&&(m=a[0]-h[2]),h[0]>a[2]&&(m=h[0]-a[2]),h[1]>a[3]&&(y=h[1]-a[3]),h[3]<a[1]&&(y=a[1]-h[3]),u.distance([0,0],[m,y])}function ka(h,a,u){const m=u.pointOnLine(a,h);return u.distance(h,m.point)}function Hh(h,a,u,m,y){const T=Math.min(ka(h,[u,m],y),ka(a,[u,m],y)),M=Math.min(ka(u,[h,a],y),ka(m,[h,a],y));return Math.min(T,M)}function cf(h,a,u,m,y){if(!lo(a,h.length)||!lo(m,u.length))return 1/0;let T=1/0;for(let M=a[0];M<a[1];++M){const R=h[M],F=h[M+1];for(let $=m[0];$<m[1];++$){const H=u[$],K=u[$+1];if(jh(R,F,H,K))return 0;T=Math.min(T,Hh(R,F,H,K,y))}}return T}function Zp(h,a,u,m,y){if(!lo(a,h.length)||!lo(m,u.length))return NaN;let T=1/0;for(let M=a[0];M<=a[1];++M)for(let R=m[0];R<=m[1];++R)if(T=Math.min(T,y.distance(h[M],u[R])),T===0)return T;return T}function rc(h,a,u){if(Ia(h,a,!0))return 0;let m=1/0;for(const y of a){const T=y[0],M=y[y.length-1];if(T!==M&&(m=Math.min(m,ka(h,[M,T],u)),m===0))return m;const R=u.pointOnLine(y,h);if(m=Math.min(m,u.distance(h,R.point)),m===0)return m}return m}function wl(h,a,u,m){if(!lo(a,h.length))return NaN;for(let T=a[0];T<=a[1];++T)if(Ia(h[T],u,!0))return 0;let y=1/0;for(let T=a[0];T<a[1];++T){const M=h[T],R=h[T+1];for(const F of u)for(let $=0,H=F.length,K=H-1;$<H;K=$++){const ne=F[K],se=F[$];if(jh(M,R,ne,se))return 0;y=Math.min(y,Hh(M,R,ne,se,m))}}return y}function Xp(h,a){for(const u of h)for(const m of u)if(Ia(m,a,!0))return!0;return!1}function M_(h,a,u,m=1/0){const y=Wh(h),T=Wh(a);if(m!==1/0&&Bu(y,T,u)>=m)return m;if(ic(y,T)){if(Xp(h,a))return 0}else if(Xp(a,h))return 0;let M=1/0;for(const R of h)for(let F=0,$=R.length,H=$-1;F<$;H=F++){const K=R[H],ne=R[F];for(const se of a)for(let me=0,ge=se.length,ve=ge-1;me<ge;ve=me++){const Ae=se[ve],He=se[me];if(jh(K,ne,Ae,He))return 0;M=Math.min(M,Hh(K,ne,Ae,He,u))}}return M}function Mn(h,a,u,m,y,T){if(!T)return;const M=Bu(La(m,T),y,u);M<a&&h.push([M,T,[0,0]])}function Zh(h,a,u,m,y,T,M){if(!T||!M)return;const R=Bu(La(m,T),La(y,M),u);R<a&&h.push([R,T,M])}function Xh(h,a,u,m,y=1/0){let T=Math.min(m.distance(h[0],u[0][0]),y);if(T===0)return T;const M=new Nc([[0,[0,h.length-1],[0,0]]],Hp),R=Wh(u);for(;M.length>0;){const F=M.pop();if(F[0]>=T)continue;const $=F[1],H=a?50:100;if(Fu($)<=H){if(!lo($,h.length))return NaN;if(a){const K=wl(h,$,u,m);if(isNaN(K)||K===0)return K;T=Math.min(T,K)}else for(let K=$[0];K<=$[1];++K){const ne=rc(h[K],u,m);if(T=Math.min(T,ne),T===0)return 0}}else{const K=Ou($,a);Mn(M,T,m,h,R,K[0]),Mn(M,T,m,h,R,K[1])}}return T}function Yh(h,a,u,m,y,T=1/0){let M=Math.min(T,y.distance(h[0],u[0]));if(M===0)return M;const R=new Nc([[0,[0,h.length-1],[0,u.length-1]]],Hp);for(;R.length>0;){const F=R.pop();if(F[0]>=M)continue;const $=F[1],H=F[2],K=a?50:100,ne=m?50:100;if(Fu($)<=K&&Fu(H)<=ne){if(!lo($,h.length)&&lo(H,u.length))return NaN;let se;if(a&&m)se=cf(h,$,u,H,y),M=Math.min(M,se);else if(a&&!m){const me=h.slice($[0],$[1]+1);for(let ge=H[0];ge<=H[1];++ge)if(se=ka(u[ge],me,y),M=Math.min(M,se),M===0)return M}else if(!a&&m){const me=u.slice(H[0],H[1]+1);for(let ge=$[0];ge<=$[1];++ge)if(se=ka(h[ge],me,y),M=Math.min(M,se),M===0)return M}else se=Zp(h,$,u,H,y),M=Math.min(M,se)}else{const se=Ou($,a),me=Ou(H,m);Zh(R,M,y,h,u,se[0],me[0]),Zh(R,M,y,h,u,se[0],me[1]),Zh(R,M,y,h,u,se[1],me[0]),Zh(R,M,y,h,u,se[1],me[1])}}return M}function uf(h){return h.type==="MultiPolygon"?h.coordinates.map((a=>({type:"Polygon",coordinates:a}))):h.type==="MultiLineString"?h.coordinates.map((a=>({type:"LineString",coordinates:a}))):h.type==="MultiPoint"?h.coordinates.map((a=>({type:"Point",coordinates:a}))):[h]}class sc{constructor(a,u){this.type=Nt,this.geojson=a,this.geometries=u}static parse(a,u){if(a.length!==2)return u.error(`'distance' expression requires exactly one argument, but found ${a.length-1} instead.`);if(gl(a[1])){const m=a[1];if(m.type==="FeatureCollection")return new sc(m,m.features.map((y=>uf(y.geometry))).flat());if(m.type==="Feature")return new sc(m,uf(m.geometry));if("type"in m&&"coordinates"in m)return new sc(m,uf(m))}return u.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(a){if(a.geometry()!=null&&a.canonicalID()!=null){if(a.geometryType()==="Point")return(function(u,m){const y=u.geometry(),T=y.flat().map((F=>zc([F.x,F.y],u.canonical)));if(y.length===0)return NaN;const M=new qh(T[0][1]);let R=1/0;for(const F of m){switch(F.type){case"Point":R=Math.min(R,Yh(T,!1,[F.coordinates],!1,M,R));break;case"LineString":R=Math.min(R,Yh(T,!1,F.coordinates,!0,M,R));break;case"Polygon":R=Math.min(R,Xh(T,!1,F.coordinates,M,R))}if(R===0)return R}return R})(a,this.geometries);if(a.geometryType()==="LineString")return(function(u,m){const y=u.geometry(),T=y.flat().map((F=>zc([F.x,F.y],u.canonical)));if(y.length===0)return NaN;const M=new qh(T[0][1]);let R=1/0;for(const F of m){switch(F.type){case"Point":R=Math.min(R,Yh(T,!0,[F.coordinates],!1,M,R));break;case"LineString":R=Math.min(R,Yh(T,!0,F.coordinates,!0,M,R));break;case"Polygon":R=Math.min(R,Xh(T,!0,F.coordinates,M,R))}if(R===0)return R}return R})(a,this.geometries);if(a.geometryType()==="Polygon")return(function(u,m){const y=u.geometry();if(y.length===0||y[0].length===0)return NaN;const T=Gh(y,0).map((F=>F.map(($=>$.map((H=>zc([H.x,H.y],u.canonical))))))),M=new qh(T[0][0][0][1]);let R=1/0;for(const F of m)for(const $ of T){switch(F.type){case"Point":R=Math.min(R,Xh([F.coordinates],!1,$,M,R));break;case"LineString":R=Math.min(R,Xh(F.coordinates,!0,$,M,R));break;case"Polygon":R=Math.min(R,M_($,F.coordinates,M,R))}if(R===0)return R}return R})(a,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}class Vc{constructor(a){this.type=bi,this.key=a}static parse(a,u){if(a.length!==2)return u.error(`Expected 1 argument, but found ${a.length-1} instead.`);const m=a[1];return m==null?u.error("Global state property must be defined."):typeof m!="string"?u.error(`Global state property must be string, but found ${typeof a[1]} instead.`):new Vc(m)}evaluate(a){var u;const m=(u=a.globals)===null||u===void 0?void 0:u.globalState;return m&&Object.keys(m).length!==0?Cu(m,this.key):null}eachChild(){}outputDefined(){return!1}}const Da={"==":Bp,"!=":rf,">":sf,"<":Np,">=":Vh,"<=":Aa,array:Ts,at:_n,boolean:Ts,case:Iu,coalesce:ec,collator:tc,format:Pa,image:yl,in:Ji,"index-of":Jl,interpolate:yr,"interpolate-hcl":yr,"interpolate-lab":yr,length:bl,let:Nn,literal:Uo,match:bn,number:Ts,"number-format":Uh,object:Ts,slice:Mo,step:Ea,string:Ts,"to-boolean":Ca,"to-color":Ca,"to-number":Ca,"to-string":Ca,var:Kl,within:nc,distance:sc,"global-state":Vc};class Vs{constructor(a,u,m,y){this.name=a,this.type=u,this._evaluate=m,this.args=y}evaluate(a){return this._evaluate(a,this.args)}eachChild(a){this.args.forEach(a)}outputDefined(){return!1}static parse(a,u){const m=a[0],y=Vs.definitions[m];if(!y)return u.error(`Unknown expression "${m}". If you wanted a literal array, use ["literal", [...]].`,0);const T=Array.isArray(y)?y[0]:y.type,M=Array.isArray(y)?[[y[1],y[2]]]:y.overloads,R=M.filter((([$])=>!Array.isArray($)||$.length===a.length-1));let F=null;for(const[$,H]of R){F=new vl(u.registry,Y,u.path,null,u.scope);const K=[];let ne=!1;for(let se=1;se<a.length;se++){const me=a[se],ge=Array.isArray($)?$[se-1]:$.type,ve=F.parse(me,1+K.length,ge);if(!ve){ne=!0;break}K.push(ve)}if(!ne)if(Array.isArray($)&&$.length!==K.length)F.error(`Expected ${$.length} arguments, but found ${K.length} instead.`);else{for(let se=0;se<K.length;se++){const me=Array.isArray($)?$[se]:$.type,ge=K[se];F.concat(se+1).checkSubtype(me,ge.type)}if(F.errors.length===0)return new Vs(m,T,H,K)}}if(R.length===1)u.errors.push(...F.errors);else{const $=(R.length?R:M).map((([K])=>{return ne=K,Array.isArray(ne)?`(${ne.map(rn).join(", ")})`:`(${rn(ne.type)}...)`;var ne})).join(" | "),H=[];for(let K=1;K<a.length;K++){const ne=u.parse(a[K],1+H.length);if(!ne)return null;H.push(rn(ne.type))}u.error(`Expected arguments of type ${$}, but found (${H.join(", ")}) instead.`)}return null}static register(a,u){Vs.definitions=u;for(const m in u)a[m]=Vs}}function Yp(h,[a,u,m,y]){a=a.evaluate(h),u=u.evaluate(h),m=m.evaluate(h);const T=y?y.evaluate(h):1,M=Oc(a,u,m,T);if(M)throw new Bn(M);return new sn(a/255,u/255,m/255,T,!1)}function Kp(h,a){return h in a}function oc(h,a){const u=a[h];return u===void 0?null:u}function ut(h){return{type:h}}function Y(h){if(h instanceof Kl)return Y(h.boundExpression);if(h instanceof Vs&&h.name==="error"||h instanceof tc||h instanceof nc||h instanceof sc||h instanceof Vc)return!1;const a=h instanceof Ca||h instanceof Ts;let u=!0;return h.eachChild((m=>{u=a?u&&Y(m):u&&m instanceof Uo})),!!u&&Me(h)&&Ht(h,["zoom","heatmap-density","elevation","line-progress","accumulated","is-supported-script"])}function Me(h){if(h instanceof Vs&&(h.name==="get"&&h.args.length===1||h.name==="feature-state"||h.name==="has"&&h.args.length===1||h.name==="properties"||h.name==="geometry-type"||h.name==="id"||/^filter-/.test(h.name))||h instanceof nc||h instanceof sc)return!1;let a=!0;return h.eachChild((u=>{a&&!Me(u)&&(a=!1)})),a}function dt(h){if(h instanceof Vs&&h.name==="feature-state")return!1;let a=!0;return h.eachChild((u=>{a&&!dt(u)&&(a=!1)})),a}function Ht(h,a){if(h instanceof Vs&&a.indexOf(h.name)>=0)return!1;let u=!0;return h.eachChild((m=>{u&&!Ht(m,a)&&(u=!1)})),u}function di(h){return{result:"success",value:h}}function Ti(h){return{result:"error",value:h}}function yn(h){return h["property-type"]==="data-driven"||h["property-type"]==="cross-faded-data-driven"}function pr(h){return!!h.expression&&h.expression.parameters.indexOf("zoom")>-1}function Ms(h){return!!h.expression&&h.expression.interpolated}function ji(h){return h instanceof Number?"number":h instanceof String?"string":h instanceof Boolean?"boolean":Array.isArray(h)?"array":h===null?"null":typeof h}function Js(h){return typeof h=="object"&&h!==null&&!Array.isArray(h)&&Pr(h)===Ri}function Fa(h){return h}function ha(h,a){const u=h.stops&&typeof h.stops[0][0]=="object",m=u||!(u||h.property!==void 0),y=h.type||(Ms(a)?"exponential":"interval"),T=(function(H){switch(H.type){case"color":return sn.parse;case"padding":return fs.parse;case"numberArray":return xn.parse;case"colorArray":return qi.parse;default:return null}})(a);if(T&&((h=Ot({},h)).stops&&(h.stops=h.stops.map((H=>[H[0],T(H[1])]))),h.default=T(h.default?h.default:a.default)),h.colorSpace&&(M=h.colorSpace)!=="rgb"&&M!=="hcl"&&M!=="lab")throw new Error(`Unknown color space: "${h.colorSpace}"`);var M;const R=(function(H){switch(H){case"exponential":return $u;case"interval":return Nu;case"categorical":return Ho;case"identity":return C_;default:throw new Error(`Unknown function type "${H}"`)}})(y);let F,$;if(y==="categorical"){F=Object.create(null);for(const H of h.stops)F[H[0]]=H[1];$=typeof h.stops[0][0]}if(u){const H={},K=[];for(let me=0;me<h.stops.length;me++){const ge=h.stops[me],ve=ge[0].zoom;H[ve]===void 0&&(H[ve]={zoom:ve,type:h.type,property:h.property,default:h.default,stops:[]},K.push(ve)),H[ve].stops.push([ge[0].value,ge[1]])}const ne=[];for(const me of K)ne.push([H[me].zoom,ha(H[me],a)]);const se={name:"linear"};return{kind:"composite",interpolationType:se,interpolationFactor:yr.interpolationFactor.bind(void 0,se),zoomStops:ne.map((me=>me[0])),evaluate:({zoom:me},ge)=>$u({stops:ne,base:h.base},a,me).evaluate(me,ge)}}if(m){const H=y==="exponential"?{name:"exponential",base:h.base!==void 0?h.base:1}:null;return{kind:"camera",interpolationType:H,interpolationFactor:yr.interpolationFactor.bind(void 0,H),zoomStops:h.stops.map((K=>K[0])),evaluate:({zoom:K})=>R(h,a,K,F,$)}}return{kind:"source",evaluate(H,K){const ne=K&&K.properties?K.properties[h.property]:void 0;return ne===void 0?Wo(h.default,a.default):R(h,a,ne,F,$)}}}function Wo(h,a,u){return h!==void 0?h:a!==void 0?a:u!==void 0?u:void 0}function Ho(h,a,u,m,y){return Wo(typeof u===y?m[u]:void 0,h.default,a.default)}function Nu(h,a,u){if(ji(u)!=="number")return Wo(h.default,a.default);const m=h.stops.length;if(m===1||u<=h.stops[0][0])return h.stops[0][1];if(u>=h.stops[m-1][0])return h.stops[m-1][1];const y=Ql(h.stops.map((T=>T[0])),u);return h.stops[y][1]}function $u(h,a,u){const m=h.base!==void 0?h.base:1;if(ji(u)!=="number")return Wo(h.default,a.default);const y=h.stops.length;if(y===1||u<=h.stops[0][0])return h.stops[0][1];if(u>=h.stops[y-1][0])return h.stops[y-1][1];const T=Ql(h.stops.map((H=>H[0])),u),M=(function(H,K,ne,se){const me=se-ne,ge=H-ne;return me===0?0:K===1?ge/me:(Math.pow(K,ge)-1)/(Math.pow(K,me)-1)})(u,m,h.stops[T][0],h.stops[T+1][0]),R=h.stops[T][1],F=h.stops[T+1][1],$=sr[a.type]||Fa;return typeof R.evaluate=="function"?{evaluate(...H){const K=R.evaluate.apply(void 0,H),ne=F.evaluate.apply(void 0,H);if(K!==void 0&&ne!==void 0)return $(K,ne,M,h.colorSpace)}}:$(R,F,M,h.colorSpace)}function C_(h,a,u){switch(a.type){case"color":u=sn.parse(u);break;case"formatted":u=Ns.fromString(u.toString());break;case"resolvedImage":u=ao.fromString(u.toString());break;case"padding":u=fs.parse(u);break;case"colorArray":u=qi.parse(u);break;case"numberArray":u=xn.parse(u);break;default:ji(u)===a.type||a.type==="enum"&&a.values[u]||(u=void 0)}return Wo(u,h.default,a.default)}Vs.register(Da,{error:[{kind:"error"},[si],(h,[a])=>{throw new Bn(a.evaluate(h))}],typeof:[si,[bi],(h,[a])=>rn(Pr(a.evaluate(h)))],"to-rgba":[an(Nt,4),[Wi],(h,[a])=>{const[u,m,y,T]=a.evaluate(h).rgb;return[255*u,255*m,255*y,T]}],rgb:[Wi,[Nt,Nt,Nt],Yp],rgba:[Wi,[Nt,Nt,Nt,Nt],Yp],has:{type:pi,overloads:[[[si],(h,[a])=>Kp(a.evaluate(h),h.properties())],[[si,Ri],(h,[a,u])=>Kp(a.evaluate(h),u.evaluate(h))]]},get:{type:bi,overloads:[[[si],(h,[a])=>oc(a.evaluate(h),h.properties())],[[si,Ri],(h,[a,u])=>oc(a.evaluate(h),u.evaluate(h))]]},"feature-state":[bi,[si],(h,[a])=>oc(a.evaluate(h),h.featureState||{})],properties:[Ri,[],h=>h.properties()],"geometry-type":[si,[],h=>h.geometryType()],id:[bi,[],h=>h.id()],zoom:[Nt,[],h=>h.globals.zoom],"heatmap-density":[Nt,[],h=>h.globals.heatmapDensity||0],elevation:[Nt,[],h=>h.globals.elevation||0],"line-progress":[Nt,[],h=>h.globals.lineProgress||0],accumulated:[bi,[],h=>h.globals.accumulated===void 0?null:h.globals.accumulated],"+":[Nt,ut(Nt),(h,a)=>{let u=0;for(const m of a)u+=m.evaluate(h);return u}],"*":[Nt,ut(Nt),(h,a)=>{let u=1;for(const m of a)u*=m.evaluate(h);return u}],"-":{type:Nt,overloads:[[[Nt,Nt],(h,[a,u])=>a.evaluate(h)-u.evaluate(h)],[[Nt],(h,[a])=>-a.evaluate(h)]]},"/":[Nt,[Nt,Nt],(h,[a,u])=>a.evaluate(h)/u.evaluate(h)],"%":[Nt,[Nt,Nt],(h,[a,u])=>a.evaluate(h)%u.evaluate(h)],ln2:[Nt,[],()=>Math.LN2],pi:[Nt,[],()=>Math.PI],e:[Nt,[],()=>Math.E],"^":[Nt,[Nt,Nt],(h,[a,u])=>Math.pow(a.evaluate(h),u.evaluate(h))],sqrt:[Nt,[Nt],(h,[a])=>Math.sqrt(a.evaluate(h))],log10:[Nt,[Nt],(h,[a])=>Math.log(a.evaluate(h))/Math.LN10],ln:[Nt,[Nt],(h,[a])=>Math.log(a.evaluate(h))],log2:[Nt,[Nt],(h,[a])=>Math.log(a.evaluate(h))/Math.LN2],sin:[Nt,[Nt],(h,[a])=>Math.sin(a.evaluate(h))],cos:[Nt,[Nt],(h,[a])=>Math.cos(a.evaluate(h))],tan:[Nt,[Nt],(h,[a])=>Math.tan(a.evaluate(h))],asin:[Nt,[Nt],(h,[a])=>Math.asin(a.evaluate(h))],acos:[Nt,[Nt],(h,[a])=>Math.acos(a.evaluate(h))],atan:[Nt,[Nt],(h,[a])=>Math.atan(a.evaluate(h))],min:[Nt,ut(Nt),(h,a)=>Math.min(...a.map((u=>u.evaluate(h))))],max:[Nt,ut(Nt),(h,a)=>Math.max(...a.map((u=>u.evaluate(h))))],abs:[Nt,[Nt],(h,[a])=>Math.abs(a.evaluate(h))],round:[Nt,[Nt],(h,[a])=>{const u=a.evaluate(h);return u<0?-Math.round(-u):Math.round(u)}],floor:[Nt,[Nt],(h,[a])=>Math.floor(a.evaluate(h))],ceil:[Nt,[Nt],(h,[a])=>Math.ceil(a.evaluate(h))],"filter-==":[pi,[si,bi],(h,[a,u])=>h.properties()[a.value]===u.value],"filter-id-==":[pi,[bi],(h,[a])=>h.id()===a.value],"filter-type-==":[pi,[si],(h,[a])=>h.geometryType()===a.value],"filter-<":[pi,[si,bi],(h,[a,u])=>{const m=h.properties()[a.value],y=u.value;return typeof m==typeof y&&m<y}],"filter-id-<":[pi,[bi],(h,[a])=>{const u=h.id(),m=a.value;return typeof u==typeof m&&u<m}],"filter->":[pi,[si,bi],(h,[a,u])=>{const m=h.properties()[a.value],y=u.value;return typeof m==typeof y&&m>y}],"filter-id->":[pi,[bi],(h,[a])=>{const u=h.id(),m=a.value;return typeof u==typeof m&&u>m}],"filter-<=":[pi,[si,bi],(h,[a,u])=>{const m=h.properties()[a.value],y=u.value;return typeof m==typeof y&&m<=y}],"filter-id-<=":[pi,[bi],(h,[a])=>{const u=h.id(),m=a.value;return typeof u==typeof m&&u<=m}],"filter->=":[pi,[si,bi],(h,[a,u])=>{const m=h.properties()[a.value],y=u.value;return typeof m==typeof y&&m>=y}],"filter-id->=":[pi,[bi],(h,[a])=>{const u=h.id(),m=a.value;return typeof u==typeof m&&u>=m}],"filter-has":[pi,[bi],(h,[a])=>a.value in h.properties()],"filter-has-id":[pi,[],h=>h.id()!==null&&h.id()!==void 0],"filter-type-in":[pi,[an(si)],(h,[a])=>a.value.indexOf(h.geometryType())>=0],"filter-id-in":[pi,[an(bi)],(h,[a])=>a.value.indexOf(h.id())>=0],"filter-in-small":[pi,[si,an(bi)],(h,[a,u])=>u.value.indexOf(h.properties()[a.value])>=0],"filter-in-large":[pi,[si,an(bi)],(h,[a,u])=>(function(m,y,T,M){for(;T<=M;){const R=T+M>>1;if(y[R]===m)return!0;y[R]>m?M=R-1:T=R+1}return!1})(h.properties()[a.value],u.value,0,u.value.length-1)],all:{type:pi,overloads:[[[pi,pi],(h,[a,u])=>a.evaluate(h)&&u.evaluate(h)],[ut(pi),(h,a)=>{for(const u of a)if(!u.evaluate(h))return!1;return!0}]]},any:{type:pi,overloads:[[[pi,pi],(h,[a,u])=>a.evaluate(h)||u.evaluate(h)],[ut(pi),(h,a)=>{for(const u of a)if(u.evaluate(h))return!0;return!1}]]},"!":[pi,[pi],(h,[a])=>!a.evaluate(h)],"is-supported-script":[pi,[si],(h,[a])=>{const u=h.globals&&h.globals.isSupportedScript;return!u||u(a.evaluate(h))}],upcase:[si,[si],(h,[a])=>a.evaluate(h).toUpperCase()],downcase:[si,[si],(h,[a])=>a.evaluate(h).toLowerCase()],concat:[si,ut(bi),(h,a)=>a.map((u=>Xl(u.evaluate(h)))).join("")],"resolved-locale":[si,[Vi],(h,[a])=>a.evaluate(h).resolvedLocale()]});class Oa{constructor(a,u,m){this.expression=a,this._warningHistory={},this._evaluator=new jo,this._defaultValue=u?(function(y){if(y.type==="color"&&Js(y.default))return new sn(0,0,0,0);switch(y.type){case"color":return sn.parse(y.default)||null;case"padding":return fs.parse(y.default)||null;case"numberArray":return xn.parse(y.default)||null;case"colorArray":return qi.parse(y.default)||null;case"variableAnchorOffsetCollection":return Ss.parse(y.default)||null;case"projectionDefinition":return $s.parse(y.default)||null;default:return y.default===void 0?null:y.default}})(u):null,this._enumValues=u&&u.type==="enum"?u.values:null,this._globalState=m}evaluateWithoutErrorHandling(a,u,m,y,T,M){return this._globalState&&(a=Vu(a,this._globalState)),this._evaluator.globals=a,this._evaluator.feature=u,this._evaluator.featureState=m,this._evaluator.canonical=y,this._evaluator.availableImages=T||null,this._evaluator.formattedSection=M,this.expression.evaluate(this._evaluator)}evaluate(a,u,m,y,T,M){this._globalState&&(a=Vu(a,this._globalState)),this._evaluator.globals=a,this._evaluator.feature=u||null,this._evaluator.featureState=m||null,this._evaluator.canonical=y,this._evaluator.availableImages=T||null,this._evaluator.formattedSection=M||null;try{const R=this.expression.evaluate(this._evaluator);if(R==null||typeof R=="number"&&R!=R)return this._defaultValue;if(this._enumValues&&!(R in this._enumValues))throw new Bn(`Expected value to be one of ${Object.keys(this._enumValues).map((F=>JSON.stringify(F))).join(", ")}, but found ${JSON.stringify(R)} instead.`);return R}catch(R){return this._warningHistory[R.message]||(this._warningHistory[R.message]=!0,typeof console<"u"&&console.warn(R.message)),this._defaultValue}}}function Uc(h){return Array.isArray(h)&&h.length>0&&typeof h[0]=="string"&&h[0]in Da}function hf(h,a,u){const m=new vl(Da,Y,[],a?(function(T){const M={color:Wi,string:si,number:Nt,enum:si,boolean:pi,formatted:Jn,padding:Xi,numberArray:on,colorArray:Gn,projectionDefinition:wt,resolvedImage:zr,variableAnchorOffsetCollection:qn};return T.type==="array"?an(M[T.value]||bi,T.length):M[T.type]})(a):void 0),y=m.parse(h,void 0,void 0,void 0,a&&a.type==="string"?{typeAnnotation:"coerce"}:void 0);return y?di(new Oa(y,a,u)):Ti(m.errors)}class Jp{constructor(a,u,m){this.kind=a,this._styleExpression=u,this.isStateDependent=a!=="constant"&&!dt(u.expression),this.globalStateRefs=jc(u.expression),this._globalState=m}evaluateWithoutErrorHandling(a,u,m,y,T,M){return this._globalState&&(a=Vu(a,this._globalState)),this._styleExpression.evaluateWithoutErrorHandling(a,u,m,y,T,M)}evaluate(a,u,m,y,T,M){return this._globalState&&(a=Vu(a,this._globalState)),this._styleExpression.evaluate(a,u,m,y,T,M)}}class E_{constructor(a,u,m,y,T){this.kind=a,this.zoomStops=m,this._styleExpression=u,this.isStateDependent=a!=="camera"&&!dt(u.expression),this.globalStateRefs=jc(u.expression),this.interpolationType=y,this._globalState=T}evaluateWithoutErrorHandling(a,u,m,y,T,M){return this._globalState&&(a=Vu(a,this._globalState)),this._styleExpression.evaluateWithoutErrorHandling(a,u,m,y,T,M)}evaluate(a,u,m,y,T,M){return this._globalState&&(a=Vu(a,this._globalState)),this._styleExpression.evaluate(a,u,m,y,T,M)}interpolationFactor(a,u,m){return this.interpolationType?yr.interpolationFactor(this.interpolationType,a,u,m):0}}function A_(h,a,u){const m=hf(h,a,u);if(m.result==="error")return m;const y=m.value.expression,T=Me(y);if(!T&&!yn(a))return Ti([new Gt("","data expressions not supported")]);const M=Ht(y,["zoom"]);if(!M&&!pr(a))return Ti([new Gt("","zoom expressions not supported")]);const R=em(y);return R||M?R instanceof Gt?Ti([R]):R instanceof yr&&!Ms(a)?Ti([new Gt("",'"interpolate" expressions cannot be used with this property')]):di(R?new E_(T?"camera":"composite",m.value,R.labels,R instanceof yr?R.interpolation:void 0,u):new Jp(T?"constant":"source",m.value,u)):Ti([new Gt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Qp{constructor(a,u){this._parameters=a,this._specification=u,Ot(this,ha(this._parameters,this._specification))}static deserialize(a){return new Qp(a._parameters,a._specification)}static serialize(a){return{_parameters:a._parameters,_specification:a._specification}}}function em(h){let a=null;if(h instanceof Nn)a=em(h.result);else if(h instanceof ec){for(const u of h.args)if(a=em(u),a)break}else(h instanceof Ea||h instanceof yr)&&h.input instanceof Vs&&h.input.name==="zoom"&&(a=h);return a instanceof Gt||h.eachChild((u=>{const m=em(u);m instanceof Gt?a=m:!a&&m?a=new Gt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):a&&m&&a!==m&&(a=new Gt("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),a}function jc(h,a=new Set){return h instanceof Vc&&a.add(h.key),h.eachChild((u=>{jc(u,a)})),a}function Vu(h,a){const{zoom:u,heatmapDensity:m,elevation:y,lineProgress:T,isSupportedScript:M,accumulated:R}=h??{};return{zoom:u,heatmapDensity:m,elevation:y,lineProgress:T,isSupportedScript:M,accumulated:R,globalState:a}}function P_(h){if(h===!0||h===!1)return!0;if(!Array.isArray(h)||h.length===0)return!1;switch(h[0]){case"has":return h.length>=2&&h[1]!=="$id"&&h[1]!=="$type";case"in":return h.length>=3&&(typeof h[1]!="string"||Array.isArray(h[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return h.length!==3||Array.isArray(h[1])||Array.isArray(h[2]);case"any":case"all":for(const a of h.slice(1))if(!P_(a)&&typeof a!="boolean")return!1;return!0;default:return!0}}const R1={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function df(h,a){if(h==null)return{filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set};P_(h)||(h=ff(h));const u=hf(h,R1,a);if(u.result==="error")throw new Error(u.value.map((m=>`${m.key}: ${m.message}`)).join(", "));return{filter:(m,y,T)=>u.value.evaluate(m,y,{},T),needGeometry:E0(h),getGlobalStateRefs:()=>jc(u.value.expression)}}function L1(h,a){return h<a?-1:h>a?1:0}function E0(h){if(!Array.isArray(h))return!1;if(h[0]==="within"||h[0]==="distance")return!0;for(let a=1;a<h.length;a++)if(E0(h[a]))return!0;return!1}function ff(h){if(!h)return!0;const a=h[0];return h.length<=1?a!=="any":a==="=="?tm(h[1],h[2],"=="):a==="!="?pf(tm(h[1],h[2],"==")):a==="<"||a===">"||a==="<="||a===">="?tm(h[1],h[2],a):a==="any"?(u=h.slice(1),["any"].concat(u.map(ff))):a==="all"?["all"].concat(h.slice(1).map(ff)):a==="none"?["all"].concat(h.slice(1).map(ff).map(pf)):a==="in"?A0(h[1],h.slice(2)):a==="!in"?pf(A0(h[1],h.slice(2))):a==="has"?P0(h[1]):a!=="!has"||pf(P0(h[1]));var u}function tm(h,a,u){switch(h){case"$type":return[`filter-type-${u}`,a];case"$id":return[`filter-id-${u}`,a];default:return[`filter-${u}`,h,a]}}function A0(h,a){if(a.length===0)return!1;switch(h){case"$type":return["filter-type-in",["literal",a]];case"$id":return["filter-id-in",["literal",a]];default:return a.length>200&&!a.some((u=>typeof u!=typeof a[0]))?["filter-in-large",h,["literal",a.sort(L1)]]:["filter-in-small",h,["literal",a]]}}function P0(h){switch(h){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",h]}}function pf(h){return["!",h]}function im(h){const a=typeof h;if(a==="number"||a==="boolean"||a==="string"||h==null)return JSON.stringify(h);if(Array.isArray(h)){let y="[";for(const T of h)y+=`${im(T)},`;return`${y}]`}const u=Object.keys(h).sort();let m="{";for(let y=0;y<u.length;y++)m+=`${JSON.stringify(u[y])}:${im(h[u[y]])},`;return`${m}}`}function I0(h){let a="";for(const u of hn)a+=`/${im(h[u])}`;return a}function R0(h){const a=h.value;return a?[new at(h.key,a,"constants have been deprecated as of v8")]:[]}function Hr(h){return h instanceof Number||h instanceof String||h instanceof Boolean?h.valueOf():h}function Uu(h){if(Array.isArray(h))return h.map(Uu);if(h instanceof Object&&!(h instanceof Number||h instanceof String||h instanceof Boolean)){const a={};for(const u in h)a[u]=Uu(h[u]);return a}return Hr(h)}function Zo(h){const a=h.key,u=h.value,m=h.valueSpec||{},y=h.objectElementValidators||{},T=h.style,M=h.styleSpec,R=h.validateSpec;let F=[];const $=ji(u);if($!=="object")return[new at(a,u,`object expected, ${$} found`)];for(const H in u){const K=H.split(".")[0],ne=Cu(m,K)||m["*"];let se;if(Cu(y,K))se=y[K];else if(Cu(m,K)){if(u[H]===void 0)continue;se=R}else if(y["*"])se=y["*"];else{if(!m["*"]){F.push(new at(a,u[H],`unknown property "${H}"`));continue}se=R}F=F.concat(se({key:(a&&`${a}.`)+H,value:u[H],valueSpec:ne,style:T,styleSpec:M,object:u,objectKey:H,validateSpec:R},u))}for(const H in m)y[H]||m[H].required&&m[H].default===void 0&&u[H]===void 0&&F.push(new at(a,u,`missing required property "${H}"`));return F}function nm(h){const a=h.value,u=h.valueSpec,m=h.style,y=h.styleSpec,T=h.key,M=h.arrayElementValidator||h.validateSpec;if(ji(a)!=="array")return[new at(T,a,`array expected, ${ji(a)} found`)];if(u.length&&a.length!==u.length)return[new at(T,a,`array length ${u.length} expected, length ${a.length} found`)];let R={type:u.value,values:u.values};y.$version<7&&(R.function=u.function),ji(u.value)==="object"&&(R=u.value);let F=[];for(let $=0;$<a.length;$++)F=F.concat(M({array:a,arrayIndex:$,value:a[$],valueSpec:R,validateSpec:h.validateSpec,style:m,styleSpec:y,key:`${T}[${$}]`}));return F}function mf(h){const a=h.key,u=h.value,m=h.valueSpec;let y=ji(u);return y==="number"&&u!=u&&(y="NaN"),y!=="number"?[new at(a,u,`number expected, ${y} found`)]:"minimum"in m&&u<m.minimum?[new at(a,u,`${u} is less than the minimum value ${m.minimum}`)]:"maximum"in m&&u>m.maximum?[new at(a,u,`${u} is greater than the maximum value ${m.maximum}`)]:[]}function rm(h){const a=h.valueSpec,u=Hr(h.value.type);let m,y,T,M={};const R=u!=="categorical"&&h.value.property===void 0,F=!R,$=ji(h.value.stops)==="array"&&ji(h.value.stops[0])==="array"&&ji(h.value.stops[0][0])==="object",H=Zo({key:h.key,value:h.value,valueSpec:h.styleSpec.function,validateSpec:h.validateSpec,style:h.style,styleSpec:h.styleSpec,objectElementValidators:{stops:function(se){if(u==="identity")return[new at(se.key,se.value,'identity function may not have a "stops" property')];let me=[];const ge=se.value;return me=me.concat(nm({key:se.key,value:ge,valueSpec:se.valueSpec,validateSpec:se.validateSpec,style:se.style,styleSpec:se.styleSpec,arrayElementValidator:K})),ji(ge)==="array"&&ge.length===0&&me.push(new at(se.key,ge,"array must have at least one stop")),me},default:function(se){return se.validateSpec({key:se.key,value:se.value,valueSpec:a,validateSpec:se.validateSpec,style:se.style,styleSpec:se.styleSpec})}}});return u==="identity"&&R&&H.push(new at(h.key,h.value,'missing required property "property"')),u==="identity"||h.value.stops||H.push(new at(h.key,h.value,'missing required property "stops"')),u==="exponential"&&h.valueSpec.expression&&!Ms(h.valueSpec)&&H.push(new at(h.key,h.value,"exponential functions not supported")),h.styleSpec.$version>=8&&(F&&!yn(h.valueSpec)?H.push(new at(h.key,h.value,"property functions not supported")):R&&!pr(h.valueSpec)&&H.push(new at(h.key,h.value,"zoom functions not supported"))),u!=="categorical"&&!$||h.value.property!==void 0||H.push(new at(h.key,h.value,'"property" property is required')),H;function K(se){let me=[];const ge=se.value,ve=se.key;if(ji(ge)!=="array")return[new at(ve,ge,`array expected, ${ji(ge)} found`)];if(ge.length!==2)return[new at(ve,ge,`array length 2 expected, length ${ge.length} found`)];if($){if(ji(ge[0])!=="object")return[new at(ve,ge,`object expected, ${ji(ge[0])} found`)];if(ge[0].zoom===void 0)return[new at(ve,ge,"object stop key must have zoom")];if(ge[0].value===void 0)return[new at(ve,ge,"object stop key must have value")];if(T&&T>Hr(ge[0].zoom))return[new at(ve,ge[0].zoom,"stop zoom values must appear in ascending order")];Hr(ge[0].zoom)!==T&&(T=Hr(ge[0].zoom),y=void 0,M={}),me=me.concat(Zo({key:`${ve}[0]`,value:ge[0],valueSpec:{zoom:{}},validateSpec:se.validateSpec,style:se.style,styleSpec:se.styleSpec,objectElementValidators:{zoom:mf,value:ne}}))}else me=me.concat(ne({key:`${ve}[0]`,value:ge[0],validateSpec:se.validateSpec,style:se.style,styleSpec:se.styleSpec},ge));return Uc(Uu(ge[1]))?me.concat([new at(`${ve}[1]`,ge[1],"expressions are not allowed in function stops.")]):me.concat(se.validateSpec({key:`${ve}[1]`,value:ge[1],valueSpec:a,validateSpec:se.validateSpec,style:se.style,styleSpec:se.styleSpec}))}function ne(se,me){const ge=ji(se.value),ve=Hr(se.value),Ae=se.value!==null?se.value:me;if(m){if(ge!==m)return[new at(se.key,Ae,`${ge} stop domain type must match previous stop domain type ${m}`)]}else m=ge;if(ge!=="number"&&ge!=="string"&&ge!=="boolean")return[new at(se.key,Ae,"stop domain value must be a number, string, or boolean")];if(ge!=="number"&&u!=="categorical"){let He=`number expected, ${ge} found`;return yn(a)&&u===void 0&&(He+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new at(se.key,Ae,He)]}return u!=="categorical"||ge!=="number"||isFinite(ve)&&Math.floor(ve)===ve?u!=="categorical"&&ge==="number"&&y!==void 0&&ve<y?[new at(se.key,Ae,"stop domain values must appear in ascending order")]:(y=ve,u==="categorical"&&ve in M?[new at(se.key,Ae,"stop domain values must be unique")]:(M[ve]=!0,[])):[new at(se.key,Ae,`integer expected, found ${ve}`)]}}function Gc(h){const a=(h.expressionContext==="property"?A_:hf)(Uu(h.value),h.valueSpec);if(a.result==="error")return a.value.map((m=>new at(`${h.key}${m.key}`,h.value,m.message)));const u=a.value.expression||a.value._styleExpression.expression;if(h.expressionContext==="property"&&h.propertyKey==="text-font"&&!u.outputDefined())return[new at(h.key,h.value,`Invalid data expression for "${h.propertyKey}". Output values must be contained as literals within the expression.`)];if(h.expressionContext==="property"&&h.propertyType==="layout"&&!dt(u))return[new at(h.key,h.value,'"feature-state" data expressions are not supported with layout properties.')];if(h.expressionContext==="filter"&&!dt(u))return[new at(h.key,h.value,'"feature-state" data expressions are not supported with filters.')];if(h.expressionContext&&h.expressionContext.indexOf("cluster")===0){if(!Ht(u,["zoom","feature-state"]))return[new at(h.key,h.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(h.expressionContext==="cluster-initial"&&!Me(u))return[new at(h.key,h.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function gf(h){const a=h.key,u=h.value,m=ji(u);return m!=="string"?[new at(a,u,`color expected, ${m} found`)]:sn.parse(String(u))?[]:[new at(a,u,`color expected, "${u}" found`)]}function ju(h){const a=h.key,u=h.value,m=h.valueSpec,y=[];return Array.isArray(m.values)?m.values.indexOf(Hr(u))===-1&&y.push(new at(a,u,`expected one of [${m.values.join(", ")}], ${JSON.stringify(u)} found`)):Object.keys(m.values).indexOf(Hr(u))===-1&&y.push(new at(a,u,`expected one of [${Object.keys(m.values).join(", ")}], ${JSON.stringify(u)} found`)),y}function Kh(h){return P_(Uu(h.value))?Gc(Ot({},h,{expressionContext:"filter",valueSpec:{value:"boolean"}})):L0(h)}function L0(h){const a=h.value,u=h.key;if(ji(a)!=="array")return[new at(u,a,`array expected, ${ji(a)} found`)];const m=h.styleSpec;let y,T=[];if(a.length<1)return[new at(u,a,"filter array must have at least 1 element")];switch(T=T.concat(ju({key:`${u}[0]`,value:a[0],valueSpec:m.filter_operator,style:h.style,styleSpec:h.styleSpec})),Hr(a[0])){case"<":case"<=":case">":case">=":a.length>=2&&Hr(a[1])==="$type"&&T.push(new at(u,a,`"$type" cannot be use with operator "${a[0]}"`));case"==":case"!=":a.length!==3&&T.push(new at(u,a,`filter array for operator "${a[0]}" must have 3 elements`));case"in":case"!in":a.length>=2&&(y=ji(a[1]),y!=="string"&&T.push(new at(`${u}[1]`,a[1],`string expected, ${y} found`)));for(let M=2;M<a.length;M++)y=ji(a[M]),Hr(a[1])==="$type"?T=T.concat(ju({key:`${u}[${M}]`,value:a[M],valueSpec:m.geometry_type,style:h.style,styleSpec:h.styleSpec})):y!=="string"&&y!=="number"&&y!=="boolean"&&T.push(new at(`${u}[${M}]`,a[M],`string, number, or boolean expected, ${y} found`));break;case"any":case"all":case"none":for(let M=1;M<a.length;M++)T=T.concat(L0({key:`${u}[${M}]`,value:a[M],style:h.style,styleSpec:h.styleSpec}));break;case"has":case"!has":y=ji(a[1]),a.length!==2?T.push(new at(u,a,`filter array for "${a[0]}" operator must have 2 elements`)):y!=="string"&&T.push(new at(`${u}[1]`,a[1],`string expected, ${y} found`))}return T}function k0(h,a){const u=h.key,m=h.validateSpec,y=h.style,T=h.styleSpec,M=h.value,R=h.objectKey,F=T[`${a}_${h.layerType}`];if(!F)return[];const $=R.match(/^(.*)-transition$/);if(a==="paint"&&$&&F[$[1]]&&F[$[1]].transition)return m({key:u,value:M,valueSpec:T.transition,style:y,styleSpec:T});const H=h.valueSpec||F[R];if(!H)return[new at(u,M,`unknown property "${R}"`)];let K;if(ji(M)==="string"&&yn(H)&&!H.tokens&&(K=/^{([^}]+)}$/.exec(M)))return[new at(u,M,`"${R}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(K[1])} }\`.`)];const ne=[];return h.layerType==="symbol"&&R==="text-font"&&Js(Uu(M))&&Hr(M.type)==="identity"&&ne.push(new at(u,M,'"text-font" does not support identity functions')),ne.concat(m({key:h.key,value:M,valueSpec:H,style:y,styleSpec:T,expressionContext:"property",propertyType:a,propertyKey:R}))}function D0(h){return k0(h,"paint")}function F0(h){return k0(h,"layout")}function O0(h){let a=[];const u=h.value,m=h.key,y=h.style,T=h.styleSpec;if(ji(u)!=="object")return[new at(m,u,`object expected, ${ji(u)} found`)];u.type||u.ref||a.push(new at(m,u,'either "type" or "ref" is required'));let M=Hr(u.type);const R=Hr(u.ref);if(u.id){const F=Hr(u.id);for(let $=0;$<h.arrayIndex;$++){const H=y.layers[$];Hr(H.id)===F&&a.push(new at(m,u.id,`duplicate layer id "${u.id}", previously used at line ${H.id.__line__}`))}}if("ref"in u){let F;["type","source","source-layer","filter","layout"].forEach(($=>{$ in u&&a.push(new at(m,u[$],`"${$}" is prohibited for ref layers`))})),y.layers.forEach(($=>{Hr($.id)===R&&(F=$)})),F?F.ref?a.push(new at(m,u.ref,"ref cannot reference another ref layer")):M=Hr(F.type):a.push(new at(m,u.ref,`ref layer "${R}" not found`))}else if(M!=="background")if(u.source){const F=y.sources&&y.sources[u.source],$=F&&Hr(F.type);F?$==="vector"&&M==="raster"?a.push(new at(m,u.source,`layer "${u.id}" requires a raster source`)):$!=="raster-dem"&&M==="hillshade"||$!=="raster-dem"&&M==="color-relief"?a.push(new at(m,u.source,`layer "${u.id}" requires a raster-dem source`)):$==="raster"&&M!=="raster"?a.push(new at(m,u.source,`layer "${u.id}" requires a vector source`)):$!=="vector"||u["source-layer"]?$==="raster-dem"&&M!=="hillshade"&&M!=="color-relief"?a.push(new at(m,u.source,"raster-dem source can only be used with layer type 'hillshade' or 'color-relief'.")):M!=="line"||!u.paint||!u.paint["line-gradient"]||$==="geojson"&&F.lineMetrics||a.push(new at(m,u,`layer "${u.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):a.push(new at(m,u,`layer "${u.id}" must specify a "source-layer"`)):a.push(new at(m,u.source,`source "${u.source}" not found`))}else a.push(new at(m,u,'missing required property "source"'));return a=a.concat(Zo({key:m,value:u,valueSpec:T.layer,style:h.style,styleSpec:h.styleSpec,validateSpec:h.validateSpec,objectElementValidators:{"*":()=>[],type:()=>h.validateSpec({key:`${m}.type`,value:u.type,valueSpec:T.layer.type,style:h.style,styleSpec:h.styleSpec,validateSpec:h.validateSpec,object:u,objectKey:"type"}),filter:Kh,layout:F=>Zo({layer:u,key:F.key,value:F.value,style:F.style,styleSpec:F.styleSpec,validateSpec:F.validateSpec,objectElementValidators:{"*":$=>F0(Ot({layerType:M},$))}}),paint:F=>Zo({layer:u,key:F.key,value:F.value,style:F.style,styleSpec:F.styleSpec,validateSpec:F.validateSpec,objectElementValidators:{"*":$=>D0(Ot({layerType:M},$))}})}})),a}function qc(h){const a=h.value,u=h.key,m=ji(a);return m!=="string"?[new at(u,a,`string expected, ${m} found`)]:[]}const I_={promoteId:function({key:h,value:a}){if(ji(a)==="string")return qc({key:h,value:a});{const u=[];for(const m in a)u.push(...qc({key:`${h}.${m}`,value:a[m]}));return u}}};function R_(h){const a=h.value,u=h.key,m=h.styleSpec,y=h.style,T=h.validateSpec;if(!a.type)return[new at(u,a,'"type" is required')];const M=Hr(a.type);let R;switch(M){case"vector":case"raster":return R=Zo({key:u,value:a,valueSpec:m[`source_${M.replace("-","_")}`],style:h.style,styleSpec:m,objectElementValidators:I_,validateSpec:T}),R;case"raster-dem":return R=(function(F){var $;const H=($=F.sourceName)!==null&&$!==void 0?$:"",K=F.value,ne=F.styleSpec,se=ne.source_raster_dem,me=F.style;let ge=[];const ve=ji(K);if(K===void 0)return ge;if(ve!=="object")return ge.push(new at("source_raster_dem",K,`object expected, ${ve} found`)),ge;const Ae=Hr(K.encoding)==="custom",He=["redFactor","greenFactor","blueFactor","baseShift"],Ie=F.value.encoding?`"${F.value.encoding}"`:"Default";for(const Le in K)!Ae&&He.includes(Le)?ge.push(new at(Le,K[Le],`In "${H}": "${Le}" is only valid when "encoding" is set to "custom". ${Ie} encoding found`)):se[Le]?ge=ge.concat(F.validateSpec({key:Le,value:K[Le],valueSpec:se[Le],validateSpec:F.validateSpec,style:me,styleSpec:ne})):ge.push(new at(Le,K[Le],`unknown property "${Le}"`));return ge})({sourceName:u,value:a,style:h.style,styleSpec:m,validateSpec:T}),R;case"geojson":if(R=Zo({key:u,value:a,valueSpec:m.source_geojson,style:y,styleSpec:m,validateSpec:T,objectElementValidators:I_}),a.cluster)for(const F in a.clusterProperties){const[$,H]=a.clusterProperties[F],K=typeof $=="string"?[$,["accumulated"],["get",F]]:$;R.push(...Gc({key:`${u}.${F}.map`,value:H,expressionContext:"cluster-map"})),R.push(...Gc({key:`${u}.${F}.reduce`,value:K,expressionContext:"cluster-reduce"}))}return R;case"video":return Zo({key:u,value:a,valueSpec:m.source_video,style:y,validateSpec:T,styleSpec:m});case"image":return Zo({key:u,value:a,valueSpec:m.source_image,style:y,validateSpec:T,styleSpec:m});case"canvas":return[new at(u,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ju({key:`${u}.type`,value:a.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function _f(h){const a=h.value,u=h.styleSpec,m=u.light,y=h.style;let T=[];const M=ji(a);if(a===void 0)return T;if(M!=="object")return T=T.concat([new at("light",a,`object expected, ${M} found`)]),T;for(const R in a){const F=R.match(/^(.*)-transition$/);T=T.concat(F&&m[F[1]]&&m[F[1]].transition?h.validateSpec({key:R,value:a[R],valueSpec:u.transition,validateSpec:h.validateSpec,style:y,styleSpec:u}):m[R]?h.validateSpec({key:R,value:a[R],valueSpec:m[R],validateSpec:h.validateSpec,style:y,styleSpec:u}):[new at(R,a[R],`unknown property "${R}"`)])}return T}function z0(h){const a=h.value,u=h.styleSpec,m=u.sky,y=h.style,T=ji(a);if(a===void 0)return[];if(T!=="object")return[new at("sky",a,`object expected, ${T} found`)];let M=[];for(const R in a)M=M.concat(m[R]?h.validateSpec({key:R,value:a[R],valueSpec:m[R],style:y,styleSpec:u}):[new at(R,a[R],`unknown property "${R}"`)]);return M}function L_(h){const a=h.value,u=h.styleSpec,m=u.terrain,y=h.style;let T=[];const M=ji(a);if(a===void 0)return T;if(M!=="object")return T=T.concat([new at("terrain",a,`object expected, ${M} found`)]),T;for(const R in a)T=T.concat(m[R]?h.validateSpec({key:R,value:a[R],valueSpec:m[R],validateSpec:h.validateSpec,style:y,styleSpec:u}):[new at(R,a[R],`unknown property "${R}"`)]);return T}function k_(h){let a=[];const u=h.value,m=h.key;if(Array.isArray(u)){const y=[],T=[];for(const M in u)u[M].id&&y.includes(u[M].id)&&a.push(new at(m,u,`all the sprites' ids must be unique, but ${u[M].id} is duplicated`)),y.push(u[M].id),u[M].url&&T.includes(u[M].url)&&a.push(new at(m,u,`all the sprites' URLs must be unique, but ${u[M].url} is duplicated`)),T.push(u[M].url),a=a.concat(Zo({key:`${m}[${M}]`,value:u[M],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:h.validateSpec}));return a}return qc({key:m,value:u})}function B0(h){return!!h&&h.constructor===Object}function D_(h){return B0(h.value)?[]:[new at(h.key,h.value,`object expected, ${ji(h.value)} found`)]}const F_={"*":()=>[],array:nm,boolean:function(h){const a=h.value,u=h.key,m=ji(a);return m!=="boolean"?[new at(u,a,`boolean expected, ${m} found`)]:[]},number:mf,color:gf,constants:R0,enum:ju,filter:Kh,function:rm,layer:O0,object:Zo,source:R_,light:_f,sky:z0,terrain:L_,projection:function(h){const a=h.value,u=h.styleSpec,m=u.projection,y=h.style,T=ji(a);if(a===void 0)return[];if(T!=="object")return[new at("projection",a,`object expected, ${T} found`)];let M=[];for(const R in a)M=M.concat(m[R]?h.validateSpec({key:R,value:a[R],valueSpec:m[R],style:y,styleSpec:u}):[new at(R,a[R],`unknown property "${R}"`)]);return M},projectionDefinition:function(h){const a=h.key;let u=h.value;u=u instanceof String?u.valueOf():u;const m=ji(u);return m!=="array"||(function(y){return Array.isArray(y)&&y.length===3&&typeof y[0]=="string"&&typeof y[1]=="string"&&typeof y[2]=="number"})(u)||(function(y){return!!["interpolate","step","literal"].includes(y[0])})(u)?["array","string"].includes(m)?[]:[new at(a,u,`projection expected, invalid type "${m}" found`)]:[new at(a,u,`projection expected, invalid array ${JSON.stringify(u)} found`)]},string:qc,formatted:function(h){return qc(h).length===0?[]:Gc(h)},resolvedImage:function(h){return qc(h).length===0?[]:Gc(h)},padding:function(h){const a=h.key,u=h.value;if(ji(u)==="array"){if(u.length<1||u.length>4)return[new at(a,u,`padding requires 1 to 4 values; ${u.length} values found`)];const m={type:"number"};let y=[];for(let T=0;T<u.length;T++)y=y.concat(h.validateSpec({key:`${a}[${T}]`,value:u[T],validateSpec:h.validateSpec,valueSpec:m}));return y}return mf({key:a,value:u,valueSpec:{}})},numberArray:function(h){const a=h.key,u=h.value;if(ji(u)==="array"){const m={type:"number"};if(u.length<1)return[new at(a,u,"array length at least 1 expected, length 0 found")];let y=[];for(let T=0;T<u.length;T++)y=y.concat(h.validateSpec({key:`${a}[${T}]`,value:u[T],validateSpec:h.validateSpec,valueSpec:m}));return y}return mf({key:a,value:u,valueSpec:{}})},colorArray:function(h){const a=h.key,u=h.value;if(ji(u)==="array"){if(u.length<1)return[new at(a,u,"array length at least 1 expected, length 0 found")];let m=[];for(let y=0;y<u.length;y++)m=m.concat(gf({key:`${a}[${y}]`,value:u[y]}));return m}return gf({key:a,value:u})},variableAnchorOffsetCollection:function(h){const a=h.key,u=h.value,m=ji(u),y=h.styleSpec;if(m!=="array"||u.length<1||u.length%2!=0)return[new at(a,u,"variableAnchorOffsetCollection requires a non-empty array of even length")];let T=[];for(let M=0;M<u.length;M+=2)T=T.concat(ju({key:`${a}[${M}]`,value:u[M],valueSpec:y.layout_symbol["text-anchor"]})),T=T.concat(nm({key:`${a}[${M+1}]`,value:u[M+1],valueSpec:{length:2,value:"number"},validateSpec:h.validateSpec,style:h.style,styleSpec:y}));return T},sprite:k_,state:D_,fontFaces:function(h){const a=h.key,u=h.value,m=h.validateSpec,y=h.styleSpec,T=h.style;if(!B0(u))return[new at(a,u,`object expected, ${ji(u)} found`)];const M=[];for(const R in u){const F=u[R],$=ji(F);if($==="string")M.push(...qc({key:`${a}.${R}`,value:F}));else if($==="array"){const H={url:{type:"string",required:!0},"unicode-range":{type:"array",value:"string"}};for(const[K,ne]of F.entries())M.push(...Zo({key:`${a}.${R}[${K}]`,value:ne,valueSpec:H,styleSpec:y,style:T,validateSpec:m}))}else M.push(new at(`${a}.${R}`,F,`string or array expected, ${$} found`))}return M}};function Wc(h){const a=h.value,u=h.valueSpec,m=h.styleSpec;return h.validateSpec=Wc,u.expression&&Js(Hr(a))?rm(h):u.expression&&Uc(Uu(a))?Gc(h):u.type&&F_[u.type]?F_[u.type](h):Zo(Ot({},h,{valueSpec:u.type?m[u.type]:u}))}function N0(h){const a=h.value,u=h.key,m=qc(h);return m.length||(a.indexOf("{fontstack}")===-1&&m.push(new at(u,a,'"glyphs" url must include a "{fontstack}" token')),a.indexOf("{range}")===-1&&m.push(new at(u,a,'"glyphs" url must include a "{range}" token'))),m}function da(h,a=Tt){let u=[];return u=u.concat(Wc({key:"",value:h,valueSpec:a.$root,styleSpec:a,style:h,validateSpec:Wc,objectElementValidators:{glyphs:N0,"*":()=>[]}})),h.constants&&(u=u.concat(R0({key:"constants",value:h.constants}))),$0(u)}function za(h){return function(a){return h(Object.assign({},a,{validateSpec:Wc}))}}function $0(h){return[].concat(h).sort(((a,u)=>a.line-u.line))}function Ba(h){return function(...a){return $0(h.apply(this,a))}}da.source=Ba(za(R_)),da.sprite=Ba(za(k_)),da.glyphs=Ba(za(N0)),da.light=Ba(za(_f)),da.sky=Ba(za(z0)),da.terrain=Ba(za(L_)),da.state=Ba(za(D_)),da.layer=Ba(za(O0)),da.filter=Ba(za(Kh)),da.paintProperty=Ba(za(D0)),da.layoutProperty=Ba(za(F0));const k1={type:"enum","property-type":"data-constant",expression:{interpolated:!1,parameters:["global-state"]},values:{visible:{},none:{}},transition:!1,default:"visible"};class vf{constructor(a,u){this._globalState=u,this.setValue(a)}evaluate(){var a;return(a=this._literalValue)!==null&&a!==void 0?a:this._compiledValue.evaluate({})}setValue(a){if(a==null||a==="visible"||a==="none")return this._literalValue=a==="none"?"none":"visible",this._compiledValue=void 0,void(this._globalStateRefs=new Set);const u=hf(a,k1,this._globalState);if(u.result==="error")throw this._literalValue="visible",this._compiledValue=void 0,new Error(u.value.map((m=>`${m.key}: ${m.message}`)).join(", "));this._literalValue=void 0,this._compiledValue=u.value,this._globalStateRefs=jc(u.value.expression)}getGlobalStateRefs(){return this._globalStateRefs}}const yf=Tt,Cs=da,bf=Cs.light,V0=Cs.sky,D1=Cs.paintProperty,F1=Cs.layoutProperty;function Jh(h,a){let u=!1;if(a&&a.length)for(const m of a)h.fire(new un(new Error(m.message))),u=!0;return u}class Qh{constructor(a,u,m){const y=this.cells=[];if(a instanceof ArrayBuffer){this.arrayBuffer=a;const M=new Int32Array(this.arrayBuffer);a=M[0],this.d=(u=M[1])+2*(m=M[2]);for(let F=0;F<this.d*this.d;F++){const $=M[3+F],H=M[3+F+1];y.push($===H?null:M.subarray($,H))}const R=M[3+y.length+1];this.keys=M.subarray(M[3+y.length],R),this.bboxes=M.subarray(R),this.insert=this._insertReadonly}else{this.d=u+2*m;for(let M=0;M<this.d*this.d;M++)y.push([]);this.keys=[],this.bboxes=[]}this.n=u,this.extent=a,this.padding=m,this.scale=u/a,this.uid=0;const T=m/u*a;this.min=-T,this.max=a+T}insert(a,u,m,y,T){this._forEachCell(u,m,y,T,this._insertCell,this.uid++,void 0,void 0),this.keys.push(a),this.bboxes.push(u),this.bboxes.push(m),this.bboxes.push(y),this.bboxes.push(T)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(a,u,m,y,T,M){this.cells[T].push(M)}query(a,u,m,y,T){const M=this.min,R=this.max;if(a<=M&&u<=M&&R<=m&&R<=y&&!T)return Array.prototype.slice.call(this.keys);{const F=[];return this._forEachCell(a,u,m,y,this._queryCell,F,{},T),F}}_queryCell(a,u,m,y,T,M,R,F){const $=this.cells[T];if($!==null){const H=this.keys,K=this.bboxes;for(let ne=0;ne<$.length;ne++){const se=$[ne];if(R[se]===void 0){const me=4*se;(F?F(K[me+0],K[me+1],K[me+2],K[me+3]):a<=K[me+2]&&u<=K[me+3]&&m>=K[me+0]&&y>=K[me+1])?(R[se]=!0,M.push(H[se])):R[se]=!1}}}}_forEachCell(a,u,m,y,T,M,R,F){const $=this._convertToCellCoord(a),H=this._convertToCellCoord(u),K=this._convertToCellCoord(m),ne=this._convertToCellCoord(y);for(let se=$;se<=K;se++)for(let me=H;me<=ne;me++){const ge=this.d*me+se;if((!F||F(this._convertFromCellCoord(se),this._convertFromCellCoord(me),this._convertFromCellCoord(se+1),this._convertFromCellCoord(me+1)))&&T.call(this,a,u,m,y,ge,M,R,F))return}}_convertFromCellCoord(a){return(a-this.padding)/this.scale}_convertToCellCoord(a){return Math.max(0,Math.min(this.d-1,Math.floor(a*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const a=this.cells,u=3+this.cells.length+1+1;let m=0;for(let M=0;M<this.cells.length;M++)m+=this.cells[M].length;const y=new Int32Array(u+m+this.keys.length+this.bboxes.length);y[0]=this.extent,y[1]=this.n,y[2]=this.padding;let T=u;for(let M=0;M<a.length;M++){const R=a[M];y[3+M]=T,y.set(R,T),T+=R.length}return y[3+a.length]=T,y.set(this.keys,T),T+=this.keys.length,y[3+a.length+1]=T,y.set(this.bboxes,T),T+=this.bboxes.length,y.buffer}static serialize(a,u){const m=a.toArrayBuffer();return u&&u.push(m),{buffer:m}}static deserialize(a){return new Qh(a.buffer)}}const Na={};function mi(h,a,u={}){if(Na[h])throw new Error(`${h} is already registered.`);Object.defineProperty(a,"_classRegistryKey",{value:h,writeable:!1}),Na[h]={klass:a,omit:u.omit||[],shallow:u.shallow||[]}}mi("Object",Object),mi("Set",Set),mi("TransferableGridIndex",Qh),mi("Color",sn),mi("Error",Error),mi("AJAXError",ot),mi("ResolvedImage",ao),mi("StylePropertyFunction",Qp),mi("StyleExpression",Oa,{omit:["_evaluator"]}),mi("ZoomDependentExpression",E_),mi("ZoomConstantExpression",Jp),mi("CompoundExpression",Vs,{omit:["_evaluate"]});for(const h in Da)Da[h]._classRegistryKey||mi(`Expression_${h}`,Da[h]);function sm(h){return h&&typeof ArrayBuffer<"u"&&(h instanceof ArrayBuffer||h.constructor&&h.constructor.name==="ArrayBuffer")}function O_(h){return h.$name||h.constructor._classRegistryKey}function ed(h){return!(function(a){if(a===null||typeof a!="object")return!1;const u=O_(a);return!(!u||u==="Object")})(h)&&(h==null||typeof h=="boolean"||typeof h=="number"||typeof h=="string"||h instanceof Boolean||h instanceof Number||h instanceof String||h instanceof Date||h instanceof RegExp||h instanceof Blob||h instanceof Error||sm(h)||xe(h)||ArrayBuffer.isView(h)||h instanceof ImageData)}function xf(h,a){if(ed(h))return(sm(h)||xe(h))&&a&&a.push(h),ArrayBuffer.isView(h)&&a&&a.push(h.buffer),h instanceof ImageData&&a&&a.push(h.data.buffer),h;if(Array.isArray(h)){const T=[];for(const M of h)T.push(xf(M,a));return T}if(typeof h!="object")throw new Error("can't serialize object of type "+typeof h);const u=O_(h);if(!u)throw new Error(`can't serialize object of unregistered class ${h.constructor.name}`);if(!Na[u])throw new Error(`${u} is not registered.`);const{klass:m}=Na[u],y=m.serialize?m.serialize(h,a):{};if(m.serialize){if(a&&y===a[a.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const T in h){if(!h.hasOwnProperty(T)||Na[u].omit.indexOf(T)>=0)continue;const M=h[T];y[T]=Na[u].shallow.indexOf(T)>=0?M:xf(M,a)}h instanceof Error&&(y.message=h.message)}if(y.$name)throw new Error("$name property is reserved for worker serialization logic.");return u!=="Object"&&(y.$name=u),y}function wf(h){if(ed(h))return h;if(Array.isArray(h))return h.map(wf);if(typeof h!="object")throw new Error("can't deserialize object of type "+typeof h);const a=O_(h)||"Object";if(!Na[a])throw new Error(`can't deserialize unregistered class ${a}`);const{klass:u}=Na[a];if(!u)throw new Error(`can't deserialize unregistered class ${a}`);if(u.deserialize)return u.deserialize(h);const m=Object.create(u.prototype);for(const y of Object.keys(h)){if(y==="$name")continue;const T=h[y];m[y]=Na[a].shallow.indexOf(y)>=0?T:wf(T)}return m}class z_{constructor(){this.first=!0}update(a,u){const m=Math.floor(a);return this.first?(this.first=!1,this.lastIntegerZoom=m,this.lastIntegerZoomTime=0,this.lastZoom=a,this.lastFloorZoom=m,!0):(this.lastFloorZoom>m?(this.lastIntegerZoom=m+1,this.lastIntegerZoomTime=u):this.lastFloorZoom<m&&(this.lastIntegerZoom=m,this.lastIntegerZoomTime=u),a!==this.lastZoom&&(this.lastZoom=a,this.lastFloorZoom=m,!0))}}function Sf(h){return/[\u02EA\u02EB\u2E80-\u2FDF\u2FF0-\u303F\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FD-\u30FF\u3105-\u312F\u31A0-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE4F\uFF00-\uFFEF]|\uD81B[\uDFE0-\uDFFF]|[\uD81C-\uD822\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFFF]|\uD82C[\uDC00-\uDEFB]|\uD83C[\uDE00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))}function B_(h){return/[\u02EA\u02EB\u1100-\u11FF\u1400-\u167F\u18B0-\u18F5\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u3007\u3012\u3013\u3020-\u302F\u3031-\u303F\u3041-\u3096\u309D-\u30FB\u30FD-\u30FF\u3105-\u312F\u3131-\u318E\u3190-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE48\uFE50-\uFE57\uFE5F-\uFE62\uFE67-\uFE6F\uFF00-\uFF07\uFF0A-\uFF0C\uFF0E-\uFF19\uFF1F-\uFF3A\uFF3C\uFF3E\uFF40-\uFF5A\uFFE0-\uFFE2\uFFE4-\uFFE7]|\uD802[\uDD80-\uDD9F]|\uD805[\uDD80-\uDDFF]|\uD806[\uDE00-\uDEBF]|\uD811[\uDC00-\uDE7F]|\uD81B[\uDFE0-\uDFE4\uDFF0-\uDFF6]|[\uD81C-\uD822\uD83D\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD30-\uDEFB]|\uD833[\uDEC0-\uDFCF]|\uD834[\uDC00-\uDDFF\uDEE0-\uDF7F]|\uD836[\uDC00-\uDEAF]|\uD83C[\uDC00-\uDE00\uDF00-\uDFFF]|\uD83E[\uDD00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))}function U0(h){return/\s/u.test(String.fromCodePoint(h))}function td(h){for(const a of h)if(B_(a.codePointAt(0)))return!0;return!1}function O1(h){for(const a of h)if(!j0(a.codePointAt(0)))return!1;return!0}function om(h){const a=h.map((u=>{try{return new RegExp(`\\p{sc=${u}}`,"u").source}catch{return null}})).filter((u=>u));return new RegExp(a.join("|"),"u")}const am=om(["Arab","Dupl","Mong","Ougr","Syrc"]);function j0(h){return!am.test(String.fromCodePoint(h))}function N_(h){return!(B_(h)||(a=h,/[\xA7\xA9\xAE\xB1\xBC-\xBE\xD7\xF7\u2016\u2020\u2021\u2030\u2031\u203B\u203C\u2042\u2047-\u2049\u2051\u2100-\u218F\u221E\u2234\u2235\u2300-\u2307\u230C-\u231F\u2324-\u2328\u232B\u237D-\u239A\u23BE-\u23CD\u23CF\u23D1-\u23DB\u23E2-\u2422\u2424-\u24FF\u25A0-\u2619\u2620-\u2767\u2776-\u2793\u2B12-\u2B2F\u2B50-\u2B59\u2BB8-\u2BEB\u3000-\u303F\u30A0-\u30FF\uE000-\uF8FF\uFE30-\uFE6F\uFF00-\uFFEF\uFFFC\uFFFD]|[\uDB80-\uDBFF][\uDC00-\uDFFF]/gim.test(String.fromCodePoint(a))));var a}const G0=om(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function $_(h){return G0.test(String.fromCodePoint(h))}function V_(h,a){return!(!a&&$_(h)||/[\u0900-\u0DFF\u0F00-\u109F\u1780-\u17FF]/gim.test(String.fromCodePoint(h)))}function q0(h){for(const a of h)if($_(a.codePointAt(0)))return!0;return!1}const Hc=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(h){this.pluginStatus=h.pluginStatus,this.pluginURL=h.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(h){if(Hc.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=h.applyArabicShaping,this.processBidirectionalText=h.processBidirectionalText,this.processStyledBidirectionalText=h.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(h,a){return s(this,void 0,void 0,(function*(){if(this.isParsed())return this.getState();if(h.pluginStatus!=="loading")return this.setState(h),h;const u=h.pluginURL,m=new Promise((T=>{this.loadScriptResolve=T}));a(u);const y=new Promise((T=>setTimeout((()=>T()),this.TIMEOUT)));if(yield Promise.race([m,y]),this.isParsed()){const T={pluginStatus:"loaded",pluginURL:u};return this.setState(T),T}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${u}`)}))}};class Wn{constructor(a,u){this.isSupportedScript=z1,this.zoom=a,u?(this.now=u.now||0,this.fadeDuration=u.fadeDuration||0,this.zoomHistory=u.zoomHistory||new z_,this.transition=u.transition||{}):(this.now=0,this.fadeDuration=0,this.zoomHistory=new z_,this.transition={})}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const a=this.zoom,u=a-Math.floor(a),m=this.crossFadingFactor();return a>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:u+(1-u)*m}:{fromScale:.5,toScale:1,t:1-(1-m)*u}}}function z1(h){return(function(a,u){for(const m of a)if(!V_(m.codePointAt(0),u))return!1;return!0})(h,Hc.getRTLTextPluginStatus()==="loaded")}const Tf="-transition";class lm{constructor(a,u,m){this.property=a,this.value=u,this.expression=(function(y,T,M){if(Js(y))return new Qp(y,T);if(Uc(y)){const R=A_(y,T,M);if(R.result==="error")throw new Error(R.value.map((F=>`${F.key}: ${F.message}`)).join(", "));return R.value}{let R=y;return T.type==="color"&&typeof y=="string"?R=sn.parse(y):T.type!=="padding"||typeof y!="number"&&!Array.isArray(y)?T.type!=="numberArray"||typeof y!="number"&&!Array.isArray(y)?T.type!=="colorArray"||typeof y!="string"&&!Array.isArray(y)?T.type==="variableAnchorOffsetCollection"&&Array.isArray(y)?R=Ss.parse(y):T.type==="projectionDefinition"&&typeof y=="string"&&(R=$s.parse(y)):R=qi.parse(y):R=xn.parse(y):R=fs.parse(y),{globalStateRefs:new Set,_globalState:null,kind:"constant",evaluate:()=>R}}})(u===void 0?a.specification.default:u,a.specification,m)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}getGlobalStateRefs(){return this.expression.globalStateRefs||new Set}possiblyEvaluate(a,u,m){return this.property.possiblyEvaluate(this,a,u,m)}}class cm{constructor(a,u){this.property=a,this.value=new lm(a,void 0,u)}transitioned(a,u){return new W0(this.property,this.value,u,Je({},a.transition,this.transition),a.now)}untransitioned(){return new W0(this.property,this.value,null,{},0)}}class U_{constructor(a,u){this._properties=a,this._values=Object.create(a.defaultTransitionablePropertyValues),this._globalState=u}getValue(a){return fe(this._values[a].value.value)}setValue(a,u){Object.prototype.hasOwnProperty.call(this._values,a)||(this._values[a]=new cm(this._values[a].property,this._globalState)),this._values[a].value=new lm(this._values[a].property,u===null?void 0:fe(u),this._globalState)}getTransition(a){return fe(this._values[a].transition)}setTransition(a,u){Object.prototype.hasOwnProperty.call(this._values,a)||(this._values[a]=new cm(this._values[a].property,this._globalState)),this._values[a].transition=fe(u)||void 0}serialize(){const a={};for(const u of Object.keys(this._values)){const m=this.getValue(u);m!==void 0&&(a[u]=m);const y=this.getTransition(u);y!==void 0&&(a[`${u}${Tf}`]=y)}return a}transitioned(a,u){const m=new H0(this._properties);for(const y of Object.keys(this._values))m._values[y]=this._values[y].transitioned(a,u._values[y]);return m}untransitioned(){const a=new H0(this._properties);for(const u of Object.keys(this._values))a._values[u]=this._values[u].untransitioned();return a}}class W0{constructor(a,u,m,y,T){this.property=a,this.value=u,this.begin=T+y.delay||0,this.end=this.begin+y.duration||0,a.specification.transition&&(y.delay||y.duration)&&(this.prior=m)}possiblyEvaluate(a,u,m){const y=a.now||0,T=this.value.possiblyEvaluate(a,u,m),M=this.prior;if(M){if(y>this.end)return this.prior=null,T;if(this.value.isDataDriven())return this.prior=null,T;if(y<this.begin)return M.possiblyEvaluate(a,u,m);{const R=(y-this.begin)/(this.end-this.begin);return this.property.interpolate(M.possiblyEvaluate(a,u,m),T,Ue(R))}}return T}}class H0{constructor(a){this._properties=a,this._values=Object.create(a.defaultTransitioningPropertyValues)}possiblyEvaluate(a,u,m){const y=new Mf(this._properties);for(const T of Object.keys(this._values))y._values[T]=this._values[T].possiblyEvaluate(a,u,m);return y}hasTransition(){for(const a of Object.keys(this._values))if(this._values[a].prior)return!0;return!1}}class Z0{constructor(a,u){this._properties=a,this._values=Object.create(a.defaultPropertyValues),this._globalState=u}hasValue(a){return this._values[a].value!==void 0}getValue(a){return fe(this._values[a].value)}setValue(a,u){this._values[a]=new lm(this._values[a].property,u===null?void 0:fe(u),this._globalState)}serialize(){const a={};for(const u of Object.keys(this._values)){const m=this.getValue(u);m!==void 0&&(a[u]=m)}return a}possiblyEvaluate(a,u,m){const y=new Mf(this._properties);for(const T of Object.keys(this._values))y._values[T]=this._values[T].possiblyEvaluate(a,u,m);return y}}class $a{constructor(a,u,m){this.property=a,this.value=u,this.parameters=m}isConstant(){return this.value.kind==="constant"}constantOr(a){return this.value.kind==="constant"?this.value.value:a}evaluate(a,u,m,y){return this.property.evaluate(this.value,this.parameters,a,u,m,y)}}class Mf{constructor(a){this._properties=a,this._values=Object.create(a.defaultPossiblyEvaluatedValues)}get(a){return this._values[a]}}class Mi{constructor(a){this.specification=a}possiblyEvaluate(a,u){if(a.isDataDriven())throw new Error("Value should not be data driven");return a.expression.evaluate(u)}interpolate(a,u,m){const y=sr[this.specification.type];return y?y(a,u,m):a}}class Oi{constructor(a,u){this.specification=a,this.overrides=u}possiblyEvaluate(a,u,m,y){return new $a(this,a.expression.kind==="constant"||a.expression.kind==="camera"?{kind:"constant",value:a.expression.evaluate(u,null,{},m,y)}:a.expression,u)}interpolate(a,u,m){if(a.value.kind!=="constant"||u.value.kind!=="constant")return a;if(a.value.value===void 0||u.value.value===void 0)return new $a(this,{kind:"constant",value:void 0},a.parameters);const y=sr[this.specification.type];if(y){const T=y(a.value.value,u.value.value,m);return new $a(this,{kind:"constant",value:T},a.parameters)}return a}evaluate(a,u,m,y,T,M){return a.kind==="constant"?a.value:a.evaluate(u,m,y,T,M)}}class Cf extends Oi{possiblyEvaluate(a,u,m,y){if(a.value===void 0)return new $a(this,{kind:"constant",value:void 0},u);if(a.expression.kind==="constant"){const T=a.expression.evaluate(u,null,{},m,y),M=a.property.specification.type==="resolvedImage"&&typeof T!="string"?T.name:T,R=this._calculate(M,M,M,u);return new $a(this,{kind:"constant",value:R},u)}if(a.expression.kind==="camera"){const T=this._calculate(a.expression.evaluate({zoom:u.zoom-1}),a.expression.evaluate({zoom:u.zoom}),a.expression.evaluate({zoom:u.zoom+1}),u);return new $a(this,{kind:"constant",value:T},u)}return new $a(this,a.expression,u)}evaluate(a,u,m,y,T,M){if(a.kind==="source"){const R=a.evaluate(u,m,y,T,M);return this._calculate(R,R,R,u)}return a.kind==="composite"?this._calculate(a.evaluate({zoom:Math.floor(u.zoom)-1},m,y),a.evaluate({zoom:Math.floor(u.zoom)},m,y),a.evaluate({zoom:Math.floor(u.zoom)+1},m,y),u):a.value}_calculate(a,u,m,y){return y.zoom>y.zoomHistory.lastIntegerZoom?{from:a,to:u}:{from:m,to:u}}interpolate(a){return a}}class um{constructor(a){this.specification=a}possiblyEvaluate(a,u,m,y){if(a.value!==void 0){if(a.expression.kind==="constant"){const T=a.expression.evaluate(u,null,{},m,y);return this._calculate(T,T,T,u)}return this._calculate(a.expression.evaluate(new Wn(Math.floor(u.zoom-1),u)),a.expression.evaluate(new Wn(Math.floor(u.zoom),u)),a.expression.evaluate(new Wn(Math.floor(u.zoom+1),u)),u)}}_calculate(a,u,m,y){return y.zoom>y.zoomHistory.lastIntegerZoom?{from:a,to:u}:{from:m,to:u}}interpolate(a){return a}}class hm{constructor(a){this.specification=a}possiblyEvaluate(a,u,m,y){return!!a.expression.evaluate(u,null,{},m,y)}interpolate(){return!1}}class co{constructor(a){this.properties=a,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const u in a){const m=a[u];m.specification.overridable&&this.overridableProperties.push(u);const y=this.defaultPropertyValues[u]=new lm(m,void 0,void 0),T=this.defaultTransitionablePropertyValues[u]=new cm(m,void 0);this.defaultTransitioningPropertyValues[u]=T.untransitioned(),this.defaultPossiblyEvaluatedValues[u]=y.possiblyEvaluate({})}}}mi("DataDrivenProperty",Oi),mi("DataConstantProperty",Mi),mi("CrossFadedDataDrivenProperty",Cf),mi("CrossFadedProperty",um),mi("ColorRampProperty",hm);class fa extends nn{constructor(a,u,m){if(super(),this.id=a.id,this.type=a.type,this._globalState=m,this._featureFilter={filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set},a.type!=="custom"&&(this.metadata=a.metadata,this.minzoom=a.minzoom,this.maxzoom=a.maxzoom,this._visibilityExpression=(function(y,T){return new vf(y,T)})(this.visibility,m),a.type!=="background"&&(this.source=a.source,this.sourceLayer=a["source-layer"],this.filter=a.filter,this._featureFilter=df(a.filter,m)),u.layout&&(this._unevaluatedLayout=new Z0(u.layout,m)),u.paint)){this._transitionablePaint=new U_(u.paint,m);for(const y in a.paint)this.setPaintProperty(y,a.paint[y],{validate:!1});for(const y in a.layout)this.setLayoutProperty(y,a.layout[y],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Mf(u.paint)}}setFilter(a){this.filter=a,this._featureFilter=df(a,this._globalState)}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(a){return a==="visibility"?this.visibility:this._unevaluatedLayout.getValue(a)}getLayoutAffectingGlobalStateRefs(){const a=new Set;for(const u of this._visibilityExpression.getGlobalStateRefs())a.add(u);if(this._unevaluatedLayout)for(const u in this._unevaluatedLayout._values){const m=this._unevaluatedLayout._values[u];for(const y of m.getGlobalStateRefs())a.add(y)}for(const u of this._featureFilter.getGlobalStateRefs())a.add(u);return a}getPaintAffectingGlobalStateRefs(){var a;const u=new globalThis.Map;if(this._transitionablePaint)for(const m in this._transitionablePaint._values){const y=this._transitionablePaint._values[m].value;for(const T of y.getGlobalStateRefs()){const M=(a=u.get(T))!==null&&a!==void 0?a:[];M.push({name:m,value:y.value}),u.set(T,M)}}return u}getVisibilityAffectingGlobalStateRefs(){return this._visibilityExpression.getGlobalStateRefs()}setLayoutProperty(a,u,m={}){if(u==null||!this._validate(F1,`layers.${this.id}.layout.${a}`,a,u,m))return a==="visibility"?(this.visibility=u,this._visibilityExpression.setValue(u),void this.recalculateVisibility()):void this._unevaluatedLayout.setValue(a,u)}getPaintProperty(a){return a.endsWith(Tf)?this._transitionablePaint.getTransition(a.slice(0,-11)):this._transitionablePaint.getValue(a)}setPaintProperty(a,u,m={}){if(u!=null&&this._validate(D1,`layers.${this.id}.paint.${a}`,a,u,m))return!1;if(a.endsWith(Tf))return this._transitionablePaint.setTransition(a.slice(0,-11),u||void 0),!1;{const y=this._transitionablePaint._values[a],T=y.property.specification["property-type"]==="cross-faded-data-driven",M=y.value.isDataDriven(),R=y.value;this._transitionablePaint.setValue(a,u),this._handleSpecialPaintPropertyUpdate(a);const F=this._transitionablePaint._values[a].value;return F.isDataDriven()||M||T||this._handleOverridablePaintPropertyUpdate(a,R,F)}}_handleSpecialPaintPropertyUpdate(a){}_handleOverridablePaintPropertyUpdate(a,u,m){return!1}isHidden(a=this.minzoom,u=!1){return!!(this.minzoom&&a<(u?Math.floor(this.minzoom):this.minzoom))||!!(this.maxzoom&&a>=this.maxzoom)||this._evaluatedVisibility==="none"}updateTransitions(a){this._transitioningPaint=this._transitionablePaint.transitioned(a,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculateVisibility(){this._evaluatedVisibility=this._visibilityExpression.evaluate()}recalculate(a,u){a.getCrossfadeParameters&&(this._crossfadeParameters=a.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(a,void 0,u)),this.paint=this._transitioningPaint.possiblyEvaluate(a,void 0,u)}serialize(){const a={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(a.layout=a.layout||{},a.layout.visibility=this.visibility),we(a,((u,m)=>!(u===void 0||m==="layout"&&!Object.keys(u).length||m==="paint"&&!Object.keys(u).length)))}_validate(a,u,m,y,T={}){return(!T||T.validate!==!1)&&Jh(this,a.call(Cs,{key:u,layerType:this.type,objectKey:m,value:y,styleSpec:Tt,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const a in this.paint._values){const u=this.paint.get(a);if(u instanceof $a&&yn(u.property.specification)&&(u.value.kind==="source"||u.value.kind==="composite")&&u.value.isStateDependent)return!0}return!1}}let j_;var X0={get paint(){return j_=j_||new co({"raster-opacity":new Mi(Tt.paint_raster["raster-opacity"]),"raster-hue-rotate":new Mi(Tt.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Mi(Tt.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Mi(Tt.paint_raster["raster-brightness-max"]),"raster-saturation":new Mi(Tt.paint_raster["raster-saturation"]),"raster-contrast":new Mi(Tt.paint_raster["raster-contrast"]),"raster-resampling":new Mi(Tt.paint_raster["raster-resampling"]),"raster-fade-duration":new Mi(Tt.paint_raster["raster-fade-duration"])})}};class B1 extends fa{constructor(a,u){super(a,X0,u)}}const N1={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Ef{constructor(a,u){this._structArray=a,this._pos1=u*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Ir{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(a,u){return a._trim(),u&&(a.isTransferred=!0,u.push(a.arrayBuffer)),{length:a.length,arrayBuffer:a.arrayBuffer}}static deserialize(a){const u=Object.create(this.prototype);return u.arrayBuffer=a.arrayBuffer,u.length=a.length,u.capacity=a.arrayBuffer.byteLength/u.bytesPerElement,u._refreshViews(),u}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(a){this.reserve(a),this.length=a}reserve(a){if(a>this.capacity){this.capacity=Math.max(a,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const u=this.uint8;this._refreshViews(),u&&this.uint8.set(u)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Zr(h,a=1){let u=0,m=0;return{members:h.map((y=>{const T=N1[y.type].BYTES_PER_ELEMENT,M=u=Gu(u,Math.max(a,T)),R=y.components||1;return m=Math.max(m,T),u+=T*R,{name:y.name,type:y.type,components:R,offset:M}})),size:Gu(u,Math.max(m,a)),alignment:a}}function Gu(h,a){return Math.ceil(h/a)*a}class Af extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(a,u){const m=this.length;return this.resize(m+1),this.emplace(m,a,u)}emplace(a,u,m){const y=2*a;return this.int16[y+0]=u,this.int16[y+1]=m,a}}Af.prototype.bytesPerElement=4,mi("StructArrayLayout2i4",Af);class dm extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(a,u,m){const y=this.length;return this.resize(y+1),this.emplace(y,a,u,m)}emplace(a,u,m,y){const T=3*a;return this.int16[T+0]=u,this.int16[T+1]=m,this.int16[T+2]=y,a}}dm.prototype.bytesPerElement=6,mi("StructArrayLayout3i6",dm);class G_ extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(a,u,m,y){const T=this.length;return this.resize(T+1),this.emplace(T,a,u,m,y)}emplace(a,u,m,y,T){const M=4*a;return this.int16[M+0]=u,this.int16[M+1]=m,this.int16[M+2]=y,this.int16[M+3]=T,a}}G_.prototype.bytesPerElement=8,mi("StructArrayLayout4i8",G_);class fm extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M){const R=this.length;return this.resize(R+1),this.emplace(R,a,u,m,y,T,M)}emplace(a,u,m,y,T,M,R){const F=6*a;return this.int16[F+0]=u,this.int16[F+1]=m,this.int16[F+2]=y,this.int16[F+3]=T,this.int16[F+4]=M,this.int16[F+5]=R,a}}fm.prototype.bytesPerElement=12,mi("StructArrayLayout2i4i12",fm);class q_ extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M){const R=this.length;return this.resize(R+1),this.emplace(R,a,u,m,y,T,M)}emplace(a,u,m,y,T,M,R){const F=4*a,$=8*a;return this.int16[F+0]=u,this.int16[F+1]=m,this.uint8[$+4]=y,this.uint8[$+5]=T,this.uint8[$+6]=M,this.uint8[$+7]=R,a}}q_.prototype.bytesPerElement=8,mi("StructArrayLayout2i4ub8",q_);class Pf extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(a,u){const m=this.length;return this.resize(m+1),this.emplace(m,a,u)}emplace(a,u,m){const y=2*a;return this.float32[y+0]=u,this.float32[y+1]=m,a}}Pf.prototype.bytesPerElement=8,mi("StructArrayLayout2f8",Pf);class ac extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M,R,F,$,H){const K=this.length;return this.resize(K+1),this.emplace(K,a,u,m,y,T,M,R,F,$,H)}emplace(a,u,m,y,T,M,R,F,$,H,K){const ne=10*a;return this.uint16[ne+0]=u,this.uint16[ne+1]=m,this.uint16[ne+2]=y,this.uint16[ne+3]=T,this.uint16[ne+4]=M,this.uint16[ne+5]=R,this.uint16[ne+6]=F,this.uint16[ne+7]=$,this.uint16[ne+8]=H,this.uint16[ne+9]=K,a}}ac.prototype.bytesPerElement=20,mi("StructArrayLayout10ui20",ac);class pm extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M,R,F){const $=this.length;return this.resize($+1),this.emplace($,a,u,m,y,T,M,R,F)}emplace(a,u,m,y,T,M,R,F,$){const H=8*a;return this.uint16[H+0]=u,this.uint16[H+1]=m,this.uint16[H+2]=y,this.uint16[H+3]=T,this.uint16[H+4]=M,this.uint16[H+5]=R,this.uint16[H+6]=F,this.uint16[H+7]=$,a}}pm.prototype.bytesPerElement=16,mi("StructArrayLayout8ui16",pm);class If extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M,R,F,$,H,K,ne){const se=this.length;return this.resize(se+1),this.emplace(se,a,u,m,y,T,M,R,F,$,H,K,ne)}emplace(a,u,m,y,T,M,R,F,$,H,K,ne,se){const me=12*a;return this.int16[me+0]=u,this.int16[me+1]=m,this.int16[me+2]=y,this.int16[me+3]=T,this.uint16[me+4]=M,this.uint16[me+5]=R,this.uint16[me+6]=F,this.uint16[me+7]=$,this.int16[me+8]=H,this.int16[me+9]=K,this.int16[me+10]=ne,this.int16[me+11]=se,a}}If.prototype.bytesPerElement=24,mi("StructArrayLayout4i4ui4i24",If);class mm extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(a,u,m){const y=this.length;return this.resize(y+1),this.emplace(y,a,u,m)}emplace(a,u,m,y){const T=3*a;return this.float32[T+0]=u,this.float32[T+1]=m,this.float32[T+2]=y,a}}mm.prototype.bytesPerElement=12,mi("StructArrayLayout3f12",mm);class Rf extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(a){const u=this.length;return this.resize(u+1),this.emplace(u,a)}emplace(a,u){return this.uint32[1*a+0]=u,a}}Rf.prototype.bytesPerElement=4,mi("StructArrayLayout1ul4",Rf);class W_ extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M,R,F,$){const H=this.length;return this.resize(H+1),this.emplace(H,a,u,m,y,T,M,R,F,$)}emplace(a,u,m,y,T,M,R,F,$,H){const K=10*a,ne=5*a;return this.int16[K+0]=u,this.int16[K+1]=m,this.int16[K+2]=y,this.int16[K+3]=T,this.int16[K+4]=M,this.int16[K+5]=R,this.uint32[ne+3]=F,this.uint16[K+8]=$,this.uint16[K+9]=H,a}}W_.prototype.bytesPerElement=20,mi("StructArrayLayout6i1ul2ui20",W_);class id extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M){const R=this.length;return this.resize(R+1),this.emplace(R,a,u,m,y,T,M)}emplace(a,u,m,y,T,M,R){const F=6*a;return this.int16[F+0]=u,this.int16[F+1]=m,this.int16[F+2]=y,this.int16[F+3]=T,this.int16[F+4]=M,this.int16[F+5]=R,a}}id.prototype.bytesPerElement=12,mi("StructArrayLayout2i2i2i12",id);class qu extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T){const M=this.length;return this.resize(M+1),this.emplace(M,a,u,m,y,T)}emplace(a,u,m,y,T,M){const R=4*a,F=8*a;return this.float32[R+0]=u,this.float32[R+1]=m,this.float32[R+2]=y,this.int16[F+6]=T,this.int16[F+7]=M,a}}qu.prototype.bytesPerElement=16,mi("StructArrayLayout2f1f2i16",qu);class H_ extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M){const R=this.length;return this.resize(R+1),this.emplace(R,a,u,m,y,T,M)}emplace(a,u,m,y,T,M,R){const F=16*a,$=4*a,H=8*a;return this.uint8[F+0]=u,this.uint8[F+1]=m,this.float32[$+1]=y,this.float32[$+2]=T,this.int16[H+6]=M,this.int16[H+7]=R,a}}H_.prototype.bytesPerElement=16,mi("StructArrayLayout2ub2f2i16",H_);class Lf extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(a,u,m){const y=this.length;return this.resize(y+1),this.emplace(y,a,u,m)}emplace(a,u,m,y){const T=3*a;return this.uint16[T+0]=u,this.uint16[T+1]=m,this.uint16[T+2]=y,a}}Lf.prototype.bytesPerElement=6,mi("StructArrayLayout3ui6",Lf);class Wu extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M,R,F,$,H,K,ne,se,me,ge,ve,Ae){const He=this.length;return this.resize(He+1),this.emplace(He,a,u,m,y,T,M,R,F,$,H,K,ne,se,me,ge,ve,Ae)}emplace(a,u,m,y,T,M,R,F,$,H,K,ne,se,me,ge,ve,Ae,He){const Ie=24*a,Le=12*a,Ke=48*a;return this.int16[Ie+0]=u,this.int16[Ie+1]=m,this.uint16[Ie+2]=y,this.uint16[Ie+3]=T,this.uint32[Le+2]=M,this.uint32[Le+3]=R,this.uint32[Le+4]=F,this.uint16[Ie+10]=$,this.uint16[Ie+11]=H,this.uint16[Ie+12]=K,this.float32[Le+7]=ne,this.float32[Le+8]=se,this.uint8[Ke+36]=me,this.uint8[Ke+37]=ge,this.uint8[Ke+38]=ve,this.uint32[Le+10]=Ae,this.int16[Ie+22]=He,a}}Wu.prototype.bytesPerElement=48,mi("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",Wu);class Z_ extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(a,u,m,y,T,M,R,F,$,H,K,ne,se,me,ge,ve,Ae,He,Ie,Le,Ke,nt,Ct,Ut,Bt,Zt,ni,Yt){const $t=this.length;return this.resize($t+1),this.emplace($t,a,u,m,y,T,M,R,F,$,H,K,ne,se,me,ge,ve,Ae,He,Ie,Le,Ke,nt,Ct,Ut,Bt,Zt,ni,Yt)}emplace(a,u,m,y,T,M,R,F,$,H,K,ne,se,me,ge,ve,Ae,He,Ie,Le,Ke,nt,Ct,Ut,Bt,Zt,ni,Yt,$t){const Rt=32*a,fi=16*a;return this.int16[Rt+0]=u,this.int16[Rt+1]=m,this.int16[Rt+2]=y,this.int16[Rt+3]=T,this.int16[Rt+4]=M,this.int16[Rt+5]=R,this.int16[Rt+6]=F,this.int16[Rt+7]=$,this.uint16[Rt+8]=H,this.uint16[Rt+9]=K,this.uint16[Rt+10]=ne,this.uint16[Rt+11]=se,this.uint16[Rt+12]=me,this.uint16[Rt+13]=ge,this.uint16[Rt+14]=ve,this.uint16[Rt+15]=Ae,this.uint16[Rt+16]=He,this.uint16[Rt+17]=Ie,this.uint16[Rt+18]=Le,this.uint16[Rt+19]=Ke,this.uint16[Rt+20]=nt,this.uint16[Rt+21]=Ct,this.uint16[Rt+22]=Ut,this.uint32[fi+12]=Bt,this.float32[fi+13]=Zt,this.float32[fi+14]=ni,this.uint16[Rt+30]=Yt,this.uint16[Rt+31]=$t,a}}Z_.prototype.bytesPerElement=64,mi("StructArrayLayout8i15ui1ul2f2ui64",Z_);class gm extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(a){const u=this.length;return this.resize(u+1),this.emplace(u,a)}emplace(a,u){return this.float32[1*a+0]=u,a}}gm.prototype.bytesPerElement=4,mi("StructArrayLayout1f4",gm);class _m extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(a,u,m){const y=this.length;return this.resize(y+1),this.emplace(y,a,u,m)}emplace(a,u,m,y){const T=3*a;return this.uint16[6*a+0]=u,this.float32[T+1]=m,this.float32[T+2]=y,a}}_m.prototype.bytesPerElement=12,mi("StructArrayLayout1ui2f12",_m);class X_ extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(a,u,m){const y=this.length;return this.resize(y+1),this.emplace(y,a,u,m)}emplace(a,u,m,y){const T=4*a;return this.uint32[2*a+0]=u,this.uint16[T+2]=m,this.uint16[T+3]=y,a}}X_.prototype.bytesPerElement=8,mi("StructArrayLayout1ul2ui8",X_);class A extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(a,u){const m=this.length;return this.resize(m+1),this.emplace(m,a,u)}emplace(a,u,m){const y=2*a;return this.uint16[y+0]=u,this.uint16[y+1]=m,a}}A.prototype.bytesPerElement=4,mi("StructArrayLayout2ui4",A);class l extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(a){const u=this.length;return this.resize(u+1),this.emplace(u,a)}emplace(a,u){return this.uint16[1*a+0]=u,a}}l.prototype.bytesPerElement=2,mi("StructArrayLayout1ui2",l);class f extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(a,u,m,y){const T=this.length;return this.resize(T+1),this.emplace(T,a,u,m,y)}emplace(a,u,m,y,T){const M=4*a;return this.float32[M+0]=u,this.float32[M+1]=m,this.float32[M+2]=y,this.float32[M+3]=T,a}}f.prototype.bytesPerElement=16,mi("StructArrayLayout4f16",f);class v extends Ef{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new d(this.anchorPointX,this.anchorPointY)}}v.prototype.size=20;class w extends W_{get(a){return new v(this,a)}}mi("CollisionBoxArray",w);class I extends Ef{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(a){this._structArray.uint8[this._pos1+37]=a}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(a){this._structArray.uint8[this._pos1+38]=a}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(a){this._structArray.uint32[this._pos4+10]=a}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}I.prototype.size=48;class k extends Wu{get(a){return new I(this,a)}}mi("PlacedSymbolArray",k);class B extends Ef{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(a){this._structArray.uint32[this._pos4+12]=a}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}B.prototype.size=64;class W extends Z_{get(a){return new B(this,a)}}mi("SymbolInstanceArray",W);class Z extends gm{getoffsetX(a){return this.float32[1*a+0]}}mi("GlyphOffsetArray",Z);class J extends dm{getx(a){return this.int16[3*a+0]}gety(a){return this.int16[3*a+1]}gettileUnitDistanceFromAnchor(a){return this.int16[3*a+2]}}mi("SymbolLineVertexArray",J);class ue extends Ef{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}ue.prototype.size=12;class le extends _m{get(a){return new ue(this,a)}}mi("TextAnchorOffsetArray",le);class _e extends Ef{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}_e.prototype.size=8;class Ee extends X_{get(a){return new _e(this,a)}}mi("FeatureIndexArray",Ee);class ze extends Af{}class $e extends Af{}class Ne extends Af{}class Ze extends fm{}class rt extends q_{}class We extends Pf{}class it extends ac{}class lt extends pm{}class Qe extends If{}class _t extends mm{}class Dt extends Rf{}class At extends id{}class Pt extends H_{}class It extends Lf{}class Qt extends A{}const ti=Zr([{name:"a_pos",components:2,type:"Int16"}],4),{members:Xt}=ti;class oi{constructor(a=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=a}prepareSegment(a,u,m,y){const T=this.segments[this.segments.length-1];return a>oi.MAX_VERTEX_ARRAY_LENGTH&&tt(`Max vertices per segment is ${oi.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${a}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${oi.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!T||T.vertexLength+a>oi.MAX_VERTEX_ARRAY_LENGTH||T.sortKey!==y?this.createNewSegment(u,m,y):T}createNewSegment(a,u,m){const y={vertexOffset:a.length,primitiveOffset:u.length,vertexLength:0,primitiveLength:0,vaos:{}};return m!==void 0&&(y.sortKey=m),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(y),y}getOrCreateLatestSegment(a,u,m){return this.prepareSegment(0,a,u,m)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const a of this.segments)for(const u in a.vaos)a.vaos[u].destroy()}static simpleSegment(a,u,m,y){return new oi([{vertexOffset:a,primitiveOffset:u,vertexLength:m,primitiveLength:y,vaos:{},sortKey:0}])}}function Yi(h,a){return 256*(h=ye(Math.floor(h),0,255))+ye(Math.floor(a),0,255)}oi.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,mi("SegmentVector",oi);const Dn=Zr([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]),mr=Zr([{name:"a_dasharray_from",components:4,type:"Uint16"},{name:"a_dasharray_to",components:4,type:"Uint16"}]);var Qn,xr,er,Br={exports:{}},wr={exports:{}},Es={exports:{}},rs=(function(){if(er)return Br.exports;er=1;var h=(Qn||(Qn=1,wr.exports=function(u,m){var y,T,M,R,F,$,H,K;for(T=u.length-(y=3&u.length),M=m,F=3432918353,$=461845907,K=0;K<T;)H=255&u.charCodeAt(K)|(255&u.charCodeAt(++K))<<8|(255&u.charCodeAt(++K))<<16|(255&u.charCodeAt(++K))<<24,++K,M=27492+(65535&(R=5*(65535&(M=(M^=H=(65535&(H=(H=(65535&H)*F+(((H>>>16)*F&65535)<<16)&4294967295)<<15|H>>>17))*$+(((H>>>16)*$&65535)<<16)&4294967295)<<13|M>>>19))+((5*(M>>>16)&65535)<<16)&4294967295))+((58964+(R>>>16)&65535)<<16);switch(H=0,y){case 3:H^=(255&u.charCodeAt(K+2))<<16;case 2:H^=(255&u.charCodeAt(K+1))<<8;case 1:M^=H=(65535&(H=(H=(65535&(H^=255&u.charCodeAt(K)))*F+(((H>>>16)*F&65535)<<16)&4294967295)<<15|H>>>17))*$+(((H>>>16)*$&65535)<<16)&4294967295}return M^=u.length,M=2246822507*(65535&(M^=M>>>16))+((2246822507*(M>>>16)&65535)<<16)&4294967295,M=3266489909*(65535&(M^=M>>>13))+((3266489909*(M>>>16)&65535)<<16)&4294967295,(M^=M>>>16)>>>0}),wr.exports),a=(xr||(xr=1,Es.exports=function(u,m){for(var y,T=u.length,M=m^T,R=0;T>=4;)y=1540483477*(65535&(y=255&u.charCodeAt(R)|(255&u.charCodeAt(++R))<<8|(255&u.charCodeAt(++R))<<16|(255&u.charCodeAt(++R))<<24))+((1540483477*(y>>>16)&65535)<<16),M=1540483477*(65535&M)+((1540483477*(M>>>16)&65535)<<16)^(y=1540483477*(65535&(y^=y>>>24))+((1540483477*(y>>>16)&65535)<<16)),T-=4,++R;switch(T){case 3:M^=(255&u.charCodeAt(R+2))<<16;case 2:M^=(255&u.charCodeAt(R+1))<<8;case 1:M=1540483477*(65535&(M^=255&u.charCodeAt(R)))+((1540483477*(M>>>16)&65535)<<16)}return M=1540483477*(65535&(M^=M>>>13))+((1540483477*(M>>>16)&65535)<<16),(M^=M>>>15)>>>0}),Es.exports);return Br.exports=h,Br.exports.murmur3=h,Br.exports.murmur2=a,Br.exports})(),Xr=p(rs);class Us{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(a,u,m,y){this.ids.push(Zc(a)),this.positions.push(u,m,y)}getPositions(a){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const u=Zc(a);let m=0,y=this.ids.length-1;for(;m<y;){const M=m+y>>1;this.ids[M]>=u?y=M:m=M+1}const T=[];for(;this.ids[m]===u;)T.push({index:this.positions[3*m],start:this.positions[3*m+1],end:this.positions[3*m+2]}),m++;return T}static serialize(a,u){const m=new Float64Array(a.ids),y=new Uint32Array(a.positions);return lc(m,y,0,m.length-1),u&&u.push(m.buffer,y.buffer),{ids:m,positions:y}}static deserialize(a){const u=new Us;return u.ids=a.ids,u.positions=a.positions,u.indexed=!0,u}}function Zc(h){const a=+h;return!isNaN(a)&&a<=Number.MAX_SAFE_INTEGER?a:Xr(String(h))}function lc(h,a,u,m){for(;u<m;){const y=h[u+m>>1];let T=u-1,M=m+1;for(;;){do T++;while(h[T]<y);do M--;while(h[M]>y);if(T>=M)break;Sl(h,T,M),Sl(a,3*T,3*M),Sl(a,3*T+1,3*M+1),Sl(a,3*T+2,3*M+2)}M-u<m-M?(lc(h,a,u,M),u=M+1):(lc(h,a,M+1,m),m=M)}}function Sl(h,a,u){const m=h[a];h[a]=h[u],h[u]=m}mi("FeaturePositionMap",Us);class Co{constructor(a,u){this.gl=a.gl,this.location=u}}class Hu extends Co{constructor(a,u){super(a,u),this.current=0}set(a){this.current!==a&&(this.current=a,this.gl.uniform1f(this.location,a))}}class kf extends Co{constructor(a,u){super(a,u),this.current=[0,0,0,0]}set(a){a[0]===this.current[0]&&a[1]===this.current[1]&&a[2]===this.current[2]&&a[3]===this.current[3]||(this.current=a,this.gl.uniform4f(this.location,a[0],a[1],a[2],a[3]))}}class Zu extends Co{constructor(a,u){super(a,u),this.current=sn.transparent}set(a){a.r===this.current.r&&a.g===this.current.g&&a.b===this.current.b&&a.a===this.current.a||(this.current=a,this.gl.uniform4f(this.location,a.r,a.g,a.b,a.a))}}const pa=new Float32Array(16);function Tl(h){return[Yi(255*h.r,255*h.g),Yi(255*h.b,255*h.a)]}class Va{constructor(a,u,m){this.value=a,this.uniformNames=u.map((y=>`u_${y}`)),this.type=m}setUniform(a,u,m){a.set(m.constantOr(this.value))}getBinding(a,u,m){return this.type==="color"?new Zu(a,u):new Hu(a,u)}}class Ua{constructor(a,u){this.uniformNames=u.map((m=>`u_${m}`)),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(a,u){this.pixelRatioFrom=u.pixelRatio,this.pixelRatioTo=a.pixelRatio,this.patternFrom=u.tlbr,this.patternTo=a.tlbr}setConstantDashPositions(a,u){this.dashTo=[0,a.y,a.height,a.width],this.dashFrom=[0,u.y,u.height,u.width]}setUniform(a,u,m,y){let T=null;y==="u_pattern_to"?T=this.patternTo:y==="u_pattern_from"?T=this.patternFrom:y==="u_dasharray_to"?T=this.dashTo:y==="u_dasharray_from"?T=this.dashFrom:y==="u_pixel_ratio_to"?T=this.pixelRatioTo:y==="u_pixel_ratio_from"&&(T=this.pixelRatioFrom),T!==null&&a.set(T)}getBinding(a,u,m){return m.substr(0,9)==="u_pattern"||m.substr(0,12)==="u_dasharray_"?new kf(a,u):new Hu(a,u)}}class or{constructor(a,u,m,y){this.expression=a,this.type=m,this.maxValue=0,this.paintVertexAttributes=u.map((T=>({name:`a_${T}`,type:"Float32",components:m==="color"?2:1,offset:0}))),this.paintVertexArray=new y}populatePaintArray(a,u,m){const y=this.paintVertexArray.length,T=this.expression.evaluate(new Wn(0,m),u,{},m.canonical,[],m.formattedSection);this.paintVertexArray.resize(a),this._setPaintValue(y,a,T)}updatePaintArray(a,u,m,y,T){const M=this.expression.evaluate(new Wn(0,T),m,y);this._setPaintValue(a,u,M)}_setPaintValue(a,u,m){if(this.type==="color"){const y=Tl(m);for(let T=a;T<u;T++)this.paintVertexArray.emplace(T,y[0],y[1])}else{for(let y=a;y<u;y++)this.paintVertexArray.emplace(y,m);this.maxValue=Math.max(this.maxValue,Math.abs(m))}}upload(a){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=a.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class tr{constructor(a,u,m,y,T,M){this.expression=a,this.uniformNames=u.map((R=>`u_${R}_t`)),this.type=m,this.useIntegerZoom=y,this.zoom=T,this.maxValue=0,this.paintVertexAttributes=u.map((R=>({name:`a_${R}`,type:"Float32",components:m==="color"?4:2,offset:0}))),this.paintVertexArray=new M}populatePaintArray(a,u,m){const y=this.expression.evaluate(new Wn(this.zoom,m),u,{},m.canonical,[],m.formattedSection),T=this.expression.evaluate(new Wn(this.zoom+1,m),u,{},m.canonical,[],m.formattedSection),M=this.paintVertexArray.length;this.paintVertexArray.resize(a),this._setPaintValue(M,a,y,T)}updatePaintArray(a,u,m,y,T){const M=this.expression.evaluate(new Wn(this.zoom,T),m,y),R=this.expression.evaluate(new Wn(this.zoom+1,T),m,y);this._setPaintValue(a,u,M,R)}_setPaintValue(a,u,m,y){if(this.type==="color"){const T=Tl(m),M=Tl(y);for(let R=a;R<u;R++)this.paintVertexArray.emplace(R,T[0],T[1],M[0],M[1])}else{for(let T=a;T<u;T++)this.paintVertexArray.emplace(T,m,y);this.maxValue=Math.max(this.maxValue,Math.abs(m),Math.abs(y))}}upload(a){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=a.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(a,u){const m=this.useIntegerZoom?Math.floor(u.zoom):u.zoom,y=ye(this.expression.interpolationFactor(m,this.zoom,this.zoom+1),0,1);a.set(y)}getBinding(a,u,m){return new Hu(a,u)}}class gs{constructor(a,u,m,y,T,M){this.expression=a,this.type=u,this.useIntegerZoom=m,this.zoom=y,this.layerId=M,this.zoomInPaintVertexArray=new T,this.zoomOutPaintVertexArray=new T}populatePaintArray(a,u,m){const y=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(a),this.zoomOutPaintVertexArray.resize(a),this._setPaintValues(y,a,this.getPositionIds(u),m)}updatePaintArray(a,u,m,y,T){this._setPaintValues(a,u,this.getPositionIds(m),T)}_setPaintValues(a,u,m,y){const T=this.getPositions(y);if(!T||!m)return;const M=T[m.min],R=T[m.mid],F=T[m.max];if(M&&R&&F)for(let $=a;$<u;$++)this.emplace(this.zoomInPaintVertexArray,$,R,M),this.emplace(this.zoomOutPaintVertexArray,$,R,F)}upload(a){if(this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer){const u=this.getVertexAttributes();this.zoomInPaintVertexBuffer=a.createVertexBuffer(this.zoomInPaintVertexArray,u,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=a.createVertexBuffer(this.zoomOutPaintVertexArray,u,this.expression.isStateDependent)}}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class _s extends gs{getPositions(a){return a.imagePositions}getPositionIds(a){return a.patterns&&a.patterns[this.layerId]}getVertexAttributes(){return Dn.members}emplace(a,u,m,y){a.emplace(u,m.tlbr[0],m.tlbr[1],m.tlbr[2],m.tlbr[3],y.tlbr[0],y.tlbr[1],y.tlbr[2],y.tlbr[3],m.pixelRatio,y.pixelRatio)}}class Y0 extends gs{getPositions(a){return a.dashPositions}getPositionIds(a){return a.dashes&&a.dashes[this.layerId]}getVertexAttributes(){return mr.members}emplace(a,u,m,y){a.emplace(u,0,m.y,m.height,m.width,0,y.y,y.height,y.width)}}class K0{constructor(a,u,m){this.binders={},this._buffers=[];const y=[];for(const T in a.paint._values){if(!m(T))continue;const M=a.paint.get(T);if(!(M instanceof $a&&yn(M.property.specification)))continue;const R=$1(T,a.type),F=M.value,$=M.property.specification.type,H=M.property.useIntegerZoom,K=M.property.specification["property-type"],ne=K==="cross-faded"||K==="cross-faded-data-driven";if(F.kind==="constant")this.binders[T]=ne?new Ua(F.value,R):new Va(F.value,R,$),y.push(`/u_${T}`);else if(F.kind==="source"||ne){const se=J0(T,$,"source");this.binders[T]=ne?T==="line-dasharray"?new Y0(F,$,H,u,se,a.id):new _s(F,$,H,u,se,a.id):new or(F,R,$,se),y.push(`/a_${T}`)}else{const se=J0(T,$,"composite");this.binders[T]=new tr(F,R,$,H,u,se),y.push(`/z_${T}`)}}this.cacheKey=y.sort().join("")}getMaxValue(a){const u=this.binders[a];return u instanceof or||u instanceof tr?u.maxValue:0}populatePaintArrays(a,u,m){for(const y in this.binders){const T=this.binders[y];(T instanceof or||T instanceof tr||T instanceof gs)&&T.populatePaintArray(a,u,m)}}setConstantPatternPositions(a,u){for(const m in this.binders){const y=this.binders[m];y instanceof Ua&&y.setConstantPatternPositions(a,u)}}setConstantDashPositions(a,u){for(const m in this.binders){const y=this.binders[m];y instanceof Ua&&y.setConstantDashPositions(a,u)}}updatePaintArrays(a,u,m,y,T){let M=!1;for(const R in a){const F=u.getPositions(R);for(const $ of F){const H=m.feature($.index);for(const K in this.binders){const ne=this.binders[K];if((ne instanceof or||ne instanceof tr||ne instanceof gs)&&ne.expression.isStateDependent===!0){const se=y.paint.get(K);ne.expression=se.value,ne.updatePaintArray($.start,$.end,H,a[R],T),M=!0}}}}return M}defines(){const a=[];for(const u in this.binders){const m=this.binders[u];(m instanceof Va||m instanceof Ua)&&a.push(...m.uniformNames.map((y=>`#define HAS_UNIFORM_${y}`)))}return a}getBinderAttributes(){const a=[];for(const u in this.binders){const m=this.binders[u];if(m instanceof or||m instanceof tr)for(let y=0;y<m.paintVertexAttributes.length;y++)a.push(m.paintVertexAttributes[y].name);else if(m instanceof gs){const y=m.getVertexAttributes();for(const T of y)a.push(T.name)}}return a}getBinderUniforms(){const a=[];for(const u in this.binders){const m=this.binders[u];if(m instanceof Va||m instanceof Ua||m instanceof tr)for(const y of m.uniformNames)a.push(y)}return a}getPaintVertexBuffers(){return this._buffers}getUniforms(a,u){const m=[];for(const y in this.binders){const T=this.binders[y];if(T instanceof Va||T instanceof Ua||T instanceof tr){for(const M of T.uniformNames)if(u[M]){const R=T.getBinding(a,u[M],M);m.push({name:M,property:y,binding:R})}}}return m}setUniforms(a,u,m,y){for(const{name:T,property:M,binding:R}of u)this.binders[M].setUniform(R,y,m.get(M),T)}updatePaintBuffers(a){this._buffers=[];for(const u in this.binders){const m=this.binders[u];if(a&&m instanceof gs){const y=a.fromScale===2?m.zoomInPaintVertexBuffer:m.zoomOutPaintVertexBuffer;y&&this._buffers.push(y)}else(m instanceof or||m instanceof tr)&&m.paintVertexBuffer&&this._buffers.push(m.paintVertexBuffer)}}upload(a){for(const u in this.binders){const m=this.binders[u];(m instanceof or||m instanceof tr||m instanceof gs)&&m.upload(a)}this.updatePaintBuffers()}destroy(){for(const a in this.binders){const u=this.binders[a];(u instanceof or||u instanceof tr||u instanceof gs)&&u.destroy()}}}class Xu{constructor(a,u,m=()=>!0){this.programConfigurations={};for(const y of a)this.programConfigurations[y.id]=new K0(y,u,m);this.needsUpload=!1,this._featureMap=new Us,this._bufferOffset=0}populatePaintArrays(a,u,m,y){for(const T in this.programConfigurations)this.programConfigurations[T].populatePaintArrays(a,u,y);u.id!==void 0&&this._featureMap.add(u.id,m,this._bufferOffset,a),this._bufferOffset=a,this.needsUpload=!0}updatePaintArrays(a,u,m,y){for(const T of m)this.needsUpload=this.programConfigurations[T.id].updatePaintArrays(a,this._featureMap,u,T,y)||this.needsUpload}get(a){return this.programConfigurations[a]}upload(a){if(this.needsUpload){for(const u in this.programConfigurations)this.programConfigurations[u].upload(a);this.needsUpload=!1}}destroy(){for(const a in this.programConfigurations)this.programConfigurations[a].destroy()}}function $1(h,a){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-dasharray":["dasharray_to","dasharray_from"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[h]||[h.replace(`${a}-`,"").replace(/-/g,"_")]}function J0(h,a,u){const m={color:{source:Pf,composite:f},number:{source:gm,composite:Pf}},y=(function(T){return{"line-pattern":{source:it,composite:it},"fill-pattern":{source:it,composite:it},"fill-extrusion-pattern":{source:it,composite:it},"line-dasharray":{source:lt,composite:lt}}[T]})(h);return y&&y[u]||m[a][u]}mi("ConstantBinder",Va),mi("CrossFadedConstantBinder",Ua),mi("SourceExpressionBinder",or),mi("CrossFadedPatternBinder",_s),mi("CrossFadedDasharrayBinder",Y0),mi("CompositeExpressionBinder",tr),mi("ProgramConfiguration",K0,{omit:["_buffers"]}),mi("ProgramConfigurationSet",Xu);const Y_=Math.pow(2,14)-1,Xc=-Y_-1;function Yc(h){const a=Pe/h.extent,u=h.loadGeometry();for(let m=0;m<u.length;m++){const y=u[m];for(let T=0;T<y.length;T++){const M=y[T],R=Math.round(M.x*a),F=Math.round(M.y*a);M.x=ye(R,Xc,Y_),M.y=ye(F,Xc,Y_),(R<M.x||R>M.x+1||F<M.y||F>M.y+1)&&tt("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return u}function Kc(h,a){return{type:h.type,id:h.id,properties:h.properties,geometry:a?Yc(h):[]}}const K_=-32768;function J_(h,a,u,m,y){h.emplaceBack(K_+8*a+m,K_+8*u+y)}class vm{constructor(a){this.zoom=a.zoom,this.overscaling=a.overscaling,this.layers=a.layers,this.layerIds=this.layers.map((u=>u.id)),this.index=a.index,this.hasDependencies=!1,this.layoutVertexArray=new $e,this.indexArray=new It,this.segments=new oi,this.programConfigurations=new Xu(a.layers,a.zoom),this.stateDependentLayerIds=this.layers.filter((u=>u.isStateDependent())).map((u=>u.id))}populate(a,u,m){const y=this.layers[0],T=[];let M=null,R=!1,F=y.type==="heatmap";if(y.type==="circle"){const H=y;M=H.layout.get("circle-sort-key"),R=!M.isConstant(),F=F||H.paint.get("circle-pitch-alignment")==="map"}const $=F?u.subdivisionGranularity.circle:1;for(const{feature:H,id:K,index:ne,sourceLayerIndex:se}of a){const me=this.layers[0]._featureFilter.needGeometry,ge=Kc(H,me);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom),ge,m))continue;const ve=R?M.evaluate(ge,{},m):void 0,Ae={id:K,properties:H.properties,type:H.type,sourceLayerIndex:se,index:ne,geometry:me?ge.geometry:Yc(H),patterns:{},sortKey:ve};T.push(Ae)}R&&T.sort(((H,K)=>H.sortKey-K.sortKey));for(const H of T){const{geometry:K,index:ne,sourceLayerIndex:se}=H,me=a[ne].feature;this.addFeature(H,K,ne,m,$),u.featureIndex.insert(me,K,ne,se,this.index)}}update(a,u,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(a,u,this.stateDependentLayers,{imagePositions:m})}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(a){this.uploaded||(this.layoutVertexBuffer=a.createVertexBuffer(this.layoutVertexArray,Xt),this.indexBuffer=a.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(a),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(a,u,m,y,T=1){let M;switch(T){case 1:M=[0,7];break;case 3:M=[0,2,5,7];break;case 5:M=[0,1,3,4,6,7];break;case 7:M=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${T}; valid values are 1, 3, 5, 7.`)}const R=M.length;for(const F of u)for(const $ of F){const H=$.x,K=$.y;if(H<0||H>=Pe||K<0||K>=Pe)continue;const ne=this.segments.prepareSegment(R*R,this.layoutVertexArray,this.indexArray,a.sortKey),se=ne.vertexLength;for(let me=0;me<R;me++)for(let ge=0;ge<R;ge++)J_(this.layoutVertexArray,H,K,M[ge],M[me]);for(let me=0;me<R-1;me++)for(let ge=0;ge<R-1;ge++){const ve=se+me*R+ge,Ae=se+(me+1)*R+ge;this.indexArray.emplaceBack(ve,Ae+1,ve+1),this.indexArray.emplaceBack(ve,Ae,Ae+1)}ne.vertexLength+=R*R,ne.primitiveLength+=(R-1)*(R-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,a,m,{imagePositions:{},canonical:y})}}function ym(h,a){for(let u=0;u<h.length;u++)if(bm(a,h[u]))return!0;for(let u=0;u<a.length;u++)if(bm(h,a[u]))return!0;return!!V1(h,a)}function Q0(h,a,u){return!!bm(h,a)||!!U1(a,h,u)}function wE(h,a){if(h.length===1)return TE(a,h[0]);for(let u=0;u<a.length;u++){const m=a[u];for(let y=0;y<m.length;y++)if(bm(h,m[y]))return!0}for(let u=0;u<h.length;u++)if(TE(a,h[u]))return!0;for(let u=0;u<a.length;u++)if(V1(h,a[u]))return!0;return!1}function $N(h,a,u){if(h.length>1){if(V1(h,a))return!0;for(let m=0;m<a.length;m++)if(U1(a[m],h,u))return!0}for(let m=0;m<h.length;m++)if(U1(h[m],a,u))return!0;return!1}function V1(h,a){if(h.length===0||a.length===0)return!1;for(let u=0;u<h.length-1;u++){const m=h[u],y=h[u+1];for(let T=0;T<a.length-1;T++)if(VN(m,y,a[T],a[T+1]))return!0}return!1}function VN(h,a,u,m){return Mt(h,u,m)!==Mt(a,u,m)&&Mt(h,a,u)!==Mt(h,a,m)}function U1(h,a,u){const m=u*u;if(a.length===1)return h.distSqr(a[0])<m;for(let y=1;y<a.length;y++)if(SE(h,a[y-1],a[y])<m)return!0;return!1}function SE(h,a,u){const m=a.distSqr(u);if(m===0)return h.distSqr(a);const y=((h.x-a.x)*(u.x-a.x)+(h.y-a.y)*(u.y-a.y))/m;return h.distSqr(y<0?a:y>1?u:u.sub(a)._mult(y)._add(a))}function TE(h,a){let u,m,y,T=!1;for(let M=0;M<h.length;M++){u=h[M];for(let R=0,F=u.length-1;R<u.length;F=R++)m=u[R],y=u[F],m.y>a.y!=y.y>a.y&&a.x<(y.x-m.x)*(a.y-m.y)/(y.y-m.y)+m.x&&(T=!T)}return T}function bm(h,a){let u=!1;for(let m=0,y=h.length-1;m<h.length;y=m++){const T=h[m],M=h[y];T.y>a.y!=M.y>a.y&&a.x<(M.x-T.x)*(a.y-T.y)/(M.y-T.y)+T.x&&(u=!u)}return u}function UN(h,a,u){const m=u[0],y=u[2];if(h.x<m.x&&a.x<m.x||h.x>y.x&&a.x>y.x||h.y<m.y&&a.y<m.y||h.y>y.y&&a.y>y.y)return!1;const T=Mt(h,a,u[0]);return T!==Mt(h,a,u[1])||T!==Mt(h,a,u[2])||T!==Mt(h,a,u[3])}function xm(h,a,u){const m=a.paint.get(h).value;return m.kind==="constant"?m.value:u.programConfigurations.get(a.id).getMaxValue(h)}function eb(h){return Math.sqrt(h[0]*h[0]+h[1]*h[1])}function tb(h,a,u,m,y){if(!a[0]&&!a[1])return h;const T=d.convert(a)._mult(y);u==="viewport"&&T._rotate(-m);const M=[];for(let R=0;R<h.length;R++)M.push(h[R].sub(T));return M}function jN(h){const a=[];for(let u=0;u<h.length;u++){const m=h[u],y=a.at(-1);(u===0||y&&!m.equals(y))&&a.push(m)}return a}function GN({queryGeometry:h,size:a},u){return Q0(h,u,a)}function qN({queryGeometry:h,size:a,transform:u,unwrappedTileID:m,getElevation:y},T){return Q0(h,T,a*(u.projectTileCoordinates(T.x,T.y,m,y).signedDistanceFromCamera/u.cameraToCenterDistance))}function WN({queryGeometry:h,size:a,transform:u,unwrappedTileID:m,getElevation:y},T){const M=u.projectTileCoordinates(T.x,T.y,m,y).signedDistanceFromCamera,R=a*(u.cameraToCenterDistance/M);return Q0(h,j1(T,u,m,y),R)}function HN({queryGeometry:h,size:a,transform:u,unwrappedTileID:m,getElevation:y},T){return Q0(h,j1(T,u,m,y),a)}function ME({queryGeometry:h,size:a,transform:u,unwrappedTileID:m,getElevation:y,pitchAlignment:T="map",pitchScale:M="map"},R){const F=T==="map"?M==="map"?GN:qN:M==="map"?WN:HN,$={queryGeometry:h,size:a,transform:u,unwrappedTileID:m,getElevation:y};for(const H of R)for(const K of H)if(F($,K))return!0;return!1}function j1(h,a,u,m){const y=a.projectTileCoordinates(h.x,h.y,u,m).point;return new d((.5*y.x+.5)*a.width,(.5*-y.y+.5)*a.height)}let CE,EE;mi("CircleBucket",vm,{omit:["layers"]});var ZN={get paint(){return EE=EE||new co({"circle-radius":new Oi(Tt.paint_circle["circle-radius"]),"circle-color":new Oi(Tt.paint_circle["circle-color"]),"circle-blur":new Oi(Tt.paint_circle["circle-blur"]),"circle-opacity":new Oi(Tt.paint_circle["circle-opacity"]),"circle-translate":new Mi(Tt.paint_circle["circle-translate"]),"circle-translate-anchor":new Mi(Tt.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Mi(Tt.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Mi(Tt.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Oi(Tt.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Oi(Tt.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Oi(Tt.paint_circle["circle-stroke-opacity"])})},get layout(){return CE=CE||new co({"circle-sort-key":new Oi(Tt.layout_circle["circle-sort-key"])})}};class XN extends fa{constructor(a,u){super(a,ZN,u)}createBucket(a){return new vm(a)}queryRadius(a){const u=a;return xm("circle-radius",this,u)+xm("circle-stroke-width",this,u)+eb(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:a,feature:u,featureState:m,geometry:y,transform:T,pixelsToTileUnits:M,unwrappedTileID:R,getElevation:F}){const $=tb(a,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-T.bearingInRadians,M),H=this.paint.get("circle-radius").evaluate(u,m)+this.paint.get("circle-stroke-width").evaluate(u,m),K=this.paint.get("circle-pitch-scale"),ne=this.paint.get("circle-pitch-alignment");let se,me;return ne==="map"?(se=$,me=H*M):(se=(function(ge,ve,Ae,He){return ge.map((Ie=>j1(Ie,ve,Ae,He)))})($,T,R,F),me=H),ME({queryGeometry:se,size:me,transform:T,unwrappedTileID:R,getElevation:F,pitchAlignment:ne,pitchScale:K},y)}}class AE extends vm{}let PE;mi("HeatmapBucket",AE,{omit:["layers"]});var YN={get paint(){return PE=PE||new co({"heatmap-radius":new Oi(Tt.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Oi(Tt.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Mi(Tt.paint_heatmap["heatmap-intensity"]),"heatmap-color":new hm(Tt.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Mi(Tt.paint_heatmap["heatmap-opacity"])})}};function G1(h,{width:a,height:u},m,y){if(y){if(y instanceof Uint8ClampedArray)y=new Uint8Array(y.buffer);else if(y.length!==a*u*m)throw new RangeError(`mismatched image size. expected: ${y.length} but got: ${a*u*m}`)}else y=new Uint8Array(a*u*m);return h.width=a,h.height=u,h.data=y,h}function IE(h,{width:a,height:u},m){if(a===h.width&&u===h.height)return;const y=G1({},{width:a,height:u},m);q1(h,y,{x:0,y:0},{x:0,y:0},{width:Math.min(h.width,a),height:Math.min(h.height,u)},m),h.width=a,h.height=u,h.data=y.data}function q1(h,a,u,m,y,T){if(y.width===0||y.height===0)return a;if(y.width>h.width||y.height>h.height||u.x>h.width-y.width||u.y>h.height-y.height)throw new RangeError("out of range source coordinates for image copy");if(y.width>a.width||y.height>a.height||m.x>a.width-y.width||m.y>a.height-y.height)throw new RangeError("out of range destination coordinates for image copy");const M=h.data,R=a.data;if(M===R)throw new Error("srcData equals dstData, so image is already copied");for(let F=0;F<y.height;F++){const $=((u.y+F)*h.width+u.x)*T,H=((m.y+F)*a.width+m.x)*T;for(let K=0;K<y.width*T;K++)R[H+K]=M[$+K]}return a}class Q_{constructor(a,u){G1(this,a,1,u)}resize(a){IE(this,a,1)}clone(){return new Q_({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(a,u,m,y,T){q1(a,u,m,y,T,1)}}class Xo{constructor(a,u){G1(this,a,4,u)}resize(a){IE(this,a,4)}replace(a,u){u?this.data.set(a):this.data=a instanceof Uint8ClampedArray?new Uint8Array(a.buffer):a}clone(){return new Xo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(a,u,m,y,T){q1(a,u,m,y,T,4)}setPixel(a,u,m){const y=4*(a*this.width+u);this.data[y+0]=Math.round(255*m.r/m.a),this.data[y+1]=Math.round(255*m.g/m.a),this.data[y+2]=Math.round(255*m.b/m.a),this.data[y+3]=Math.round(255*m.a)}}function RE(h){const a={},u=h.resolution||256,m=h.clips?h.clips.length:1,y=h.image||new Xo({width:u,height:m});if(Math.log(u)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${u}`);const T=(M,R,F)=>{a[h.evaluationKey]=F;const $=h.expression.evaluate(a);y.setPixel(M/4/u,R/4,$)};if(h.clips)for(let M=0,R=0;M<m;++M,R+=4*u)for(let F=0,$=0;F<u;F++,$+=4){const H=F/(u-1),{start:K,end:ne}=h.clips[M];T(R,$,K*(1-H)+ne*H)}else for(let M=0,R=0;M<u;M++,R+=4)T(0,R,M/(u-1));return y}mi("AlphaImage",Q_),mi("RGBAImage",Xo);const W1="big-fb";class KN extends fa{createBucket(a){return new AE(a)}constructor(a,u){super(a,YN,u),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(a){a==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=RE({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(W1)&&this.heatmapFbos.delete(W1)}queryRadius(a){return xm("heatmap-radius",this,a)}queryIntersectsFeature({queryGeometry:a,feature:u,featureState:m,geometry:y,transform:T,pixelsToTileUnits:M,unwrappedTileID:R,getElevation:F}){return ME({queryGeometry:a,size:this.paint.get("heatmap-radius").evaluate(u,m)*M,transform:T,unwrappedTileID:R,getElevation:F},y)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&!this.isHidden()}}let LE;var JN={get paint(){return LE=LE||new co({"hillshade-illumination-direction":new Mi(Tt.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-altitude":new Mi(Tt.paint_hillshade["hillshade-illumination-altitude"]),"hillshade-illumination-anchor":new Mi(Tt.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Mi(Tt.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Mi(Tt.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Mi(Tt.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Mi(Tt.paint_hillshade["hillshade-accent-color"]),"hillshade-method":new Mi(Tt.paint_hillshade["hillshade-method"])})}};class QN extends fa{constructor(a,u){super(a,JN,u),this.recalculate({zoom:0,zoomHistory:{}},void 0)}getIlluminationProperties(){let a=this.paint.get("hillshade-illumination-direction").values,u=this.paint.get("hillshade-illumination-altitude").values,m=this.paint.get("hillshade-highlight-color").values,y=this.paint.get("hillshade-shadow-color").values;const T=Math.max(a.length,u.length,m.length,y.length);a=a.concat(Array(T-a.length).fill(a.at(-1))),u=u.concat(Array(T-u.length).fill(u.at(-1))),m=m.concat(Array(T-m.length).fill(m.at(-1))),y=y.concat(Array(T-y.length).fill(y.at(-1)));const M=u.map(Xe);return{directionRadians:a.map(Xe),altitudeRadians:M,shadowColor:y,highlightColor:m}}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&!this.isHidden()}}let kE;var e4={get paint(){return kE=kE||new co({"color-relief-opacity":new Mi(Tt["paint_color-relief"]["color-relief-opacity"]),"color-relief-color":new hm(Tt["paint_color-relief"]["color-relief-color"])})}};class H1{constructor(a,u,m,y){this.context=a,this.format=m,this.texture=a.gl.createTexture(),this.update(u,y)}update(a,u,m){const{width:y,height:T}=a,M=!(this.size&&this.size[0]===y&&this.size[1]===T||m),{context:R}=this,{gl:F}=R;if(this.useMipmap=!!(u&&u.useMipmap),F.bindTexture(F.TEXTURE_2D,this.texture),R.pixelStoreUnpackFlipY.set(!1),R.pixelStoreUnpack.set(1),R.pixelStoreUnpackPremultiplyAlpha.set(this.format===F.RGBA&&(!u||u.premultiply!==!1)),M)this.size=[y,T],a instanceof HTMLImageElement||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement||a instanceof ImageData||xe(a)?F.texImage2D(F.TEXTURE_2D,0,this.format,this.format,F.UNSIGNED_BYTE,a):F.texImage2D(F.TEXTURE_2D,0,this.format,y,T,0,this.format,F.UNSIGNED_BYTE,a.data);else{const{x:$,y:H}=m||{x:0,y:0};a instanceof HTMLImageElement||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement||a instanceof ImageData||xe(a)?F.texSubImage2D(F.TEXTURE_2D,0,$,H,F.RGBA,F.UNSIGNED_BYTE,a):F.texSubImage2D(F.TEXTURE_2D,0,$,H,y,T,F.RGBA,F.UNSIGNED_BYTE,a.data)}this.useMipmap&&this.isSizePowerOfTwo()&&F.generateMipmap(F.TEXTURE_2D),R.pixelStoreUnpackFlipY.setDefault(),R.pixelStoreUnpack.setDefault(),R.pixelStoreUnpackPremultiplyAlpha.setDefault()}bind(a,u,m){const{context:y}=this,{gl:T}=y;T.bindTexture(T.TEXTURE_2D,this.texture),m!==T.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(m=T.LINEAR),a!==this.filter&&(T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MAG_FILTER,a),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MIN_FILTER,m||a),this.filter=a),u!==this.wrap&&(T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_S,u),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_T,u),this.wrap=u)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:a}=this.context;a.deleteTexture(this.texture),this.texture=null}}class DE{constructor(a,u,m,y=1,T=1,M=1,R=0){if(this.uid=a,u.height!==u.width)throw new RangeError("DEM tiles must be square");if(m&&!["mapbox","terrarium","custom"].includes(m))return void tt(`"${m}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=u.height;const F=this.dim=u.height-2;switch(this.data=new Uint32Array(u.data.buffer),m){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=y,this.greenFactor=T,this.blueFactor=M,this.baseShift=R;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let $=0;$<F;$++)this.data[this._idx(-1,$)]=this.data[this._idx(0,$)],this.data[this._idx(F,$)]=this.data[this._idx(F-1,$)],this.data[this._idx($,-1)]=this.data[this._idx($,0)],this.data[this._idx($,F)]=this.data[this._idx($,F-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(F,-1)]=this.data[this._idx(F-1,0)],this.data[this._idx(-1,F)]=this.data[this._idx(0,F-1)],this.data[this._idx(F,F)]=this.data[this._idx(F-1,F-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let $=0;$<F;$++)for(let H=0;H<F;H++){const K=this.get($,H);K>this.max&&(this.max=K),K<this.min&&(this.min=K)}}get(a,u){const m=new Uint8Array(this.data.buffer),y=4*this._idx(a,u);return this.unpack(m[y],m[y+1],m[y+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(a,u){if(a<-1||a>=this.dim+1||u<-1||u>=this.dim+1)throw new RangeError(`Out of range source coordinates for DEM data. x: ${a}, y: ${u}, dim: ${this.dim}`);return(u+1)*this.stride+(a+1)}unpack(a,u,m){return a*this.redFactor+u*this.greenFactor+m*this.blueFactor-this.baseShift}pack(a){return FE(a,this.getUnpackVector())}getPixels(){return new Xo({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(a,u,m){if(this.dim!==a.dim)throw new Error("dem dimension mismatch");let y=u*this.dim,T=u*this.dim+this.dim,M=m*this.dim,R=m*this.dim+this.dim;switch(u){case-1:y=T-1;break;case 1:T=y+1}switch(m){case-1:M=R-1;break;case 1:R=M+1}const F=-u*this.dim,$=-m*this.dim;for(let H=M;H<R;H++)for(let K=y;K<T;K++)this.data[this._idx(K,H)]=a.data[this._idx(K+F,H+$)]}}function FE(h,a){const u=a[0],m=a[1],y=a[2],T=a[3],M=Math.min(u,m,y),R=Math.round((h+T)/M);return{r:Math.floor(R*M/u)%256,g:Math.floor(R*M/m)%256,b:Math.floor(R*M/y)%256}}mi("DEMData",DE);class t4 extends fa{constructor(a,u){super(a,e4,u)}_createColorRamp(a){const u={elevationStops:[],colorStops:[]},m=this._transitionablePaint._values["color-relief-color"].value.expression;if(m instanceof Jp&&m._styleExpression.expression instanceof yr){this.colorRampExpression=m;const M=m._styleExpression.expression;u.elevationStops=M.labels,u.colorStops=[];for(const R of u.elevationStops)u.colorStops.push(M.evaluate({globals:{elevation:R}}))}if(u.elevationStops.length<1&&(u.elevationStops=[0],u.colorStops=[sn.transparent]),u.elevationStops.length<2&&(u.elevationStops.push(u.elevationStops[0]+1),u.colorStops.push(u.colorStops[0])),u.elevationStops.length<=a)return u;const y={elevationStops:[],colorStops:[]},T=(u.elevationStops.length-1)/(a-1);for(let M=0;M<u.elevationStops.length-.5;M+=T)y.elevationStops.push(u.elevationStops[Math.round(M)]),y.colorStops.push(u.colorStops[Math.round(M)]);return tt(`Too many colors in specification of ${this.id} color-relief layer, may not render properly. Max possible colors: ${a}, provided: ${u.elevationStops.length}`),y}_colorRampChanged(){return this.colorRampExpression!=this._transitionablePaint._values["color-relief-color"].value.expression}getColorRampTextures(a,u,m){if(this.colorRampTextures&&!this._colorRampChanged())return this.colorRampTextures;const y=this._createColorRamp(u),T=new Xo({width:y.colorStops.length,height:1}),M=new Xo({width:y.colorStops.length,height:1});for(let R=0;R<y.elevationStops.length;R++){const F=FE(y.elevationStops[R],m);M.setPixel(0,R,new sn(F.r/255,F.g/255,F.b/255,1)),T.setPixel(0,R,y.colorStops[R])}return this.colorRampTextures={elevationTexture:new H1(a,M,a.gl.RGBA),colorTexture:new H1(a,T,a.gl.RGBA)},this.colorRampTextures}hasOffscreenPass(){return!this.isHidden()&&!!this.colorRampTextures}}const i4=Zr([{name:"a_pos",components:2,type:"Int16"}],4),{members:n4}=i4;function ib(h,a,u){const m=u.patternDependencies;let y=!1;for(const T of a){const M=T.paint.get(`${h}-pattern`);M.isConstant()||(y=!0);const R=M.constantOr(null);R&&(y=!0,m[R.to]=!0,m[R.from]=!0)}return y}function Z1(h,a,u,m,y){const{zoom:T}=m,M=y.patternDependencies;for(const R of a){const F=R.paint.get(`${h}-pattern`).value;if(F.kind!=="constant"){let $=F.evaluate({zoom:T-1},u,{},y.availableImages),H=F.evaluate({zoom:T},u,{},y.availableImages),K=F.evaluate({zoom:T+1},u,{},y.availableImages);$=$&&$.name?$.name:$,H=H&&H.name?H.name:H,K=K&&K.name?K.name:K,M[$]=!0,M[H]=!0,M[K]=!0,u.patterns[R.id]={min:$,mid:H,max:K}}}return u}function OE(h,a,u,m,y){let T;if(y===(function(M,R,F,$){let H=0;for(let K=R,ne=F-$;K<F;K+=$)H+=(M[ne]-M[K])*(M[K+1]+M[ne+1]),ne=K;return H})(h,a,u,m)>0)for(let M=a;M<u;M+=m)T=$E(M/m|0,h[M],h[M+1],T);else for(let M=u-m;M>=a;M-=m)T=$E(M/m|0,h[M],h[M+1],T);return T&&wm(T,T.next)&&(nv(T),T=T.next),T}function Df(h,a){if(!h)return h;a||(a=h);let u,m=h;do if(u=!1,m.steiner||!wm(m,m.next)&&ss(m.prev,m,m.next)!==0)m=m.next;else{if(nv(m),m=a=m.prev,m===m.next)break;u=!0}while(u||m!==a);return a}function ev(h,a,u,m,y,T,M){if(!h)return;!M&&T&&(function(F,$,H,K){let ne=F;do ne.z===0&&(ne.z=X1(ne.x,ne.y,$,H,K)),ne.prevZ=ne.prev,ne.nextZ=ne.next,ne=ne.next;while(ne!==F);ne.prevZ.nextZ=null,ne.prevZ=null,(function(se){let me,ge=1;do{let ve,Ae=se;se=null;let He=null;for(me=0;Ae;){me++;let Ie=Ae,Le=0;for(let nt=0;nt<ge&&(Le++,Ie=Ie.nextZ,Ie);nt++);let Ke=ge;for(;Le>0||Ke>0&&Ie;)Le!==0&&(Ke===0||!Ie||Ae.z<=Ie.z)?(ve=Ae,Ae=Ae.nextZ,Le--):(ve=Ie,Ie=Ie.nextZ,Ke--),He?He.nextZ=ve:se=ve,ve.prevZ=He,He=ve;Ae=Ie}He.nextZ=null,ge*=2}while(me>1)})(ne)})(h,m,y,T);let R=h;for(;h.prev!==h.next;){const F=h.prev,$=h.next;if(T?s4(h,m,y,T):r4(h))a.push(F.i,h.i,$.i),nv(h),h=$.next,R=$.next;else if((h=$)===R){M?M===1?ev(h=o4(Df(h),a),a,u,m,y,T,2):M===2&&a4(h,a,u,m,y,T):ev(Df(h),a,u,m,y,T,1);break}}}function r4(h){const a=h.prev,u=h,m=h.next;if(ss(a,u,m)>=0)return!1;const y=a.x,T=u.x,M=m.x,R=a.y,F=u.y,$=m.y,H=Math.min(y,T,M),K=Math.min(R,F,$),ne=Math.max(y,T,M),se=Math.max(R,F,$);let me=m.next;for(;me!==a;){if(me.x>=H&&me.x<=ne&&me.y>=K&&me.y<=se&&tv(y,R,T,F,M,$,me.x,me.y)&&ss(me.prev,me,me.next)>=0)return!1;me=me.next}return!0}function s4(h,a,u,m){const y=h.prev,T=h,M=h.next;if(ss(y,T,M)>=0)return!1;const R=y.x,F=T.x,$=M.x,H=y.y,K=T.y,ne=M.y,se=Math.min(R,F,$),me=Math.min(H,K,ne),ge=Math.max(R,F,$),ve=Math.max(H,K,ne),Ae=X1(se,me,a,u,m),He=X1(ge,ve,a,u,m);let Ie=h.prevZ,Le=h.nextZ;for(;Ie&&Ie.z>=Ae&&Le&&Le.z<=He;){if(Ie.x>=se&&Ie.x<=ge&&Ie.y>=me&&Ie.y<=ve&&Ie!==y&&Ie!==M&&tv(R,H,F,K,$,ne,Ie.x,Ie.y)&&ss(Ie.prev,Ie,Ie.next)>=0||(Ie=Ie.prevZ,Le.x>=se&&Le.x<=ge&&Le.y>=me&&Le.y<=ve&&Le!==y&&Le!==M&&tv(R,H,F,K,$,ne,Le.x,Le.y)&&ss(Le.prev,Le,Le.next)>=0))return!1;Le=Le.nextZ}for(;Ie&&Ie.z>=Ae;){if(Ie.x>=se&&Ie.x<=ge&&Ie.y>=me&&Ie.y<=ve&&Ie!==y&&Ie!==M&&tv(R,H,F,K,$,ne,Ie.x,Ie.y)&&ss(Ie.prev,Ie,Ie.next)>=0)return!1;Ie=Ie.prevZ}for(;Le&&Le.z<=He;){if(Le.x>=se&&Le.x<=ge&&Le.y>=me&&Le.y<=ve&&Le!==y&&Le!==M&&tv(R,H,F,K,$,ne,Le.x,Le.y)&&ss(Le.prev,Le,Le.next)>=0)return!1;Le=Le.nextZ}return!0}function o4(h,a){let u=h;do{const m=u.prev,y=u.next.next;!wm(m,y)&&BE(m,u,u.next,y)&&iv(m,y)&&iv(y,m)&&(a.push(m.i,u.i,y.i),nv(u),nv(u.next),u=h=y),u=u.next}while(u!==h);return Df(u)}function a4(h,a,u,m,y,T){let M=h;do{let R=M.next.next;for(;R!==M.prev;){if(M.i!==R.i&&d4(M,R)){let F=NE(M,R);return M=Df(M,M.next),F=Df(F,F.next),ev(M,a,u,m,y,T,0),void ev(F,a,u,m,y,T,0)}R=R.next}M=M.next}while(M!==h)}function l4(h,a){let u=h.x-a.x;return u===0&&(u=h.y-a.y,u===0)&&(u=(h.next.y-h.y)/(h.next.x-h.x)-(a.next.y-a.y)/(a.next.x-a.x)),u}function c4(h,a){const u=(function(y,T){let M=T;const R=y.x,F=y.y;let $,H=-1/0;if(wm(y,M))return M;do{if(wm(y,M.next))return M.next;if(F<=M.y&&F>=M.next.y&&M.next.y!==M.y){const ge=M.x+(F-M.y)*(M.next.x-M.x)/(M.next.y-M.y);if(ge<=R&&ge>H&&(H=ge,$=M.x<M.next.x?M:M.next,ge===R))return $}M=M.next}while(M!==T);if(!$)return null;const K=$,ne=$.x,se=$.y;let me=1/0;M=$;do{if(R>=M.x&&M.x>=ne&&R!==M.x&&zE(F<se?R:H,F,ne,se,F<se?H:R,F,M.x,M.y)){const ge=Math.abs(F-M.y)/(R-M.x);iv(M,y)&&(ge<me||ge===me&&(M.x>$.x||M.x===$.x&&u4($,M)))&&($=M,me=ge)}M=M.next}while(M!==K);return $})(h,a);if(!u)return a;const m=NE(u,h);return Df(m,m.next),Df(u,u.next)}function u4(h,a){return ss(h.prev,h,a.prev)<0&&ss(a.next,h,h.next)<0}function X1(h,a,u,m,y){return(h=1431655765&((h=858993459&((h=252645135&((h=16711935&((h=(h-u)*y|0)|h<<8))|h<<4))|h<<2))|h<<1))|(a=1431655765&((a=858993459&((a=252645135&((a=16711935&((a=(a-m)*y|0)|a<<8))|a<<4))|a<<2))|a<<1))<<1}function h4(h){let a=h,u=h;do(a.x<u.x||a.x===u.x&&a.y<u.y)&&(u=a),a=a.next;while(a!==h);return u}function zE(h,a,u,m,y,T,M,R){return(y-M)*(a-R)>=(h-M)*(T-R)&&(h-M)*(m-R)>=(u-M)*(a-R)&&(u-M)*(T-R)>=(y-M)*(m-R)}function tv(h,a,u,m,y,T,M,R){return!(h===M&&a===R)&&zE(h,a,u,m,y,T,M,R)}function d4(h,a){return h.next.i!==a.i&&h.prev.i!==a.i&&!(function(u,m){let y=u;do{if(y.i!==u.i&&y.next.i!==u.i&&y.i!==m.i&&y.next.i!==m.i&&BE(y,y.next,u,m))return!0;y=y.next}while(y!==u);return!1})(h,a)&&(iv(h,a)&&iv(a,h)&&(function(u,m){let y=u,T=!1;const M=(u.x+m.x)/2,R=(u.y+m.y)/2;do y.y>R!=y.next.y>R&&y.next.y!==y.y&&M<(y.next.x-y.x)*(R-y.y)/(y.next.y-y.y)+y.x&&(T=!T),y=y.next;while(y!==u);return T})(h,a)&&(ss(h.prev,h,a.prev)||ss(h,a.prev,a))||wm(h,a)&&ss(h.prev,h,h.next)>0&&ss(a.prev,a,a.next)>0)}function ss(h,a,u){return(a.y-h.y)*(u.x-a.x)-(a.x-h.x)*(u.y-a.y)}function wm(h,a){return h.x===a.x&&h.y===a.y}function BE(h,a,u,m){const y=rb(ss(h,a,u)),T=rb(ss(h,a,m)),M=rb(ss(u,m,h)),R=rb(ss(u,m,a));return y!==T&&M!==R||!(y!==0||!nb(h,u,a))||!(T!==0||!nb(h,m,a))||!(M!==0||!nb(u,h,m))||!(R!==0||!nb(u,a,m))}function nb(h,a,u){return a.x<=Math.max(h.x,u.x)&&a.x>=Math.min(h.x,u.x)&&a.y<=Math.max(h.y,u.y)&&a.y>=Math.min(h.y,u.y)}function rb(h){return h>0?1:h<0?-1:0}function iv(h,a){return ss(h.prev,h,h.next)<0?ss(h,a,h.next)>=0&&ss(h,h.prev,a)>=0:ss(h,a,h.prev)<0||ss(h,h.next,a)<0}function NE(h,a){const u=Y1(h.i,h.x,h.y),m=Y1(a.i,a.x,a.y),y=h.next,T=a.prev;return h.next=a,a.prev=h,u.next=y,y.prev=u,m.next=u,u.prev=m,T.next=m,m.prev=T,m}function $E(h,a,u,m){const y=Y1(h,a,u);return m?(y.next=m.next,y.prev=m,m.next.prev=y,m.next=y):(y.prev=y,y.next=y),y}function nv(h){h.next.prev=h.prev,h.prev.next=h.next,h.prevZ&&(h.prevZ.nextZ=h.nextZ),h.nextZ&&(h.nextZ.prevZ=h.prevZ)}function Y1(h,a,u){return{i:h,x:a,y:u,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Sm{constructor(a,u){if(u>a)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=a,this._minGranularity=u}getGranularityForZoomLevel(a){return Math.max(Math.floor(this._baseZoomGranularity/(1<<a)),this._minGranularity,1)}}class sb{constructor(a){this.fill=a.fill,this.line=a.line,this.tile=a.tile,this.stencil=a.stencil,this.circle=a.circle}}sb.noSubdivision=new sb({fill:new Sm(0,0),line:new Sm(0,0),tile:new Sm(0,0),stencil:new Sm(0,0),circle:1}),mi("SubdivisionGranularityExpression",Sm),mi("SubdivisionGranularitySetting",sb);const Tm=-32768,rv=32767;class f4{constructor(a,u){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=a,this._granularityCellSize=Pe/a,this._canonical=u}_getKey(a,u){return(a+=32768)<<16|u+32768}_vertexToIndex(a,u){if(a<-32768||u<-32768||a>32767||u>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const m=0|Math.round(a),y=0|Math.round(u),T=this._getKey(m,y);if(this._vertexDictionary.has(T))return this._vertexDictionary.get(T);const M=this._vertexBuffer.length/2;return this._vertexDictionary.set(T,M),this._vertexBuffer.push(m,y),M}_subdivideTrianglesScanline(a){if(this._granularity<2)return(function(y,T){const M=[];for(let R=0;R<T.length;R+=3){const F=T[R],$=T[R+1],H=T[R+2],K=y[2*F],ne=y[2*F+1];(y[2*$]-K)*(y[2*H+1]-ne)-(y[2*$+1]-ne)*(y[2*H]-K)>0?(M.push(F),M.push(H),M.push($)):(M.push(F),M.push($),M.push(H))}return M})(this._vertexBuffer,a);const u=[],m=a.length;for(let y=0;y<m;y+=3){const T=[a[y+0],a[y+1],a[y+2]],M=[this._vertexBuffer[2*a[y+0]+0],this._vertexBuffer[2*a[y+0]+1],this._vertexBuffer[2*a[y+1]+0],this._vertexBuffer[2*a[y+1]+1],this._vertexBuffer[2*a[y+2]+0],this._vertexBuffer[2*a[y+2]+1]];let R=1/0,F=1/0,$=-1/0,H=-1/0;for(let ge=0;ge<3;ge++){const ve=M[2*ge],Ae=M[2*ge+1];R=Math.min(R,ve),$=Math.max($,ve),F=Math.min(F,Ae),H=Math.max(H,Ae)}if(R===$||F===H)continue;const K=Math.floor(R/this._granularityCellSize),ne=Math.ceil($/this._granularityCellSize),se=Math.floor(F/this._granularityCellSize),me=Math.ceil(H/this._granularityCellSize);if(K!==ne||se!==me)for(let ge=se;ge<me;ge++){const ve=this._scanlineGenerateVertexRingForCellRow(ge,M,T);p4(this._vertexBuffer,ve,u)}else u.push(...T)}return u}_scanlineGenerateVertexRingForCellRow(a,u,m){const y=a*this._granularityCellSize,T=y+this._granularityCellSize,M=[];for(let R=0;R<3;R++){const F=u[2*R],$=u[2*R+1],H=u[2*(R+1)%6],K=u[(2*(R+1)+1)%6],ne=u[2*(R+2)%6],se=u[(2*(R+2)+1)%6],me=H-F,ge=K-$,ve=me===0,Ae=ge===0,He=(y-$)/ge,Ie=(T-$)/ge,Le=Math.min(He,Ie),Ke=Math.max(He,Ie);if(!Ae&&(Le>=1||Ke<=0)||Ae&&($<y||$>T)){K>=y&&K<=T&&M.push(m[(R+1)%3]);continue}!Ae&&Le>0&&M.push(this._vertexToIndex(F+me*Le,$+ge*Le));const nt=F+me*Math.max(Le,0),Ct=F+me*Math.min(Ke,1);ve||this._generateIntraEdgeVertices(M,F,$,H,K,nt,Ct),!Ae&&Ke<1&&M.push(this._vertexToIndex(F+me*Ke,$+ge*Ke)),(Ae||K>=y&&K<=T)&&M.push(m[(R+1)%3]),!Ae&&(K<=y||K>=T)&&this._generateInterEdgeVertices(M,F,$,H,K,ne,se,Ct,y,T)}return M}_generateIntraEdgeVertices(a,u,m,y,T,M,R){const F=y-u,$=T-m,H=$===0,K=H?Math.min(u,y):Math.min(M,R),ne=H?Math.max(u,y):Math.max(M,R),se=Math.floor(K/this._granularityCellSize)+1,me=Math.ceil(ne/this._granularityCellSize)-1;if(H?u<y:M<R)for(let ge=se;ge<=me;ge++){const ve=ge*this._granularityCellSize;a.push(this._vertexToIndex(ve,m+$*(ve-u)/F))}else for(let ge=me;ge>=se;ge--){const ve=ge*this._granularityCellSize;a.push(this._vertexToIndex(ve,m+$*(ve-u)/F))}}_generateInterEdgeVertices(a,u,m,y,T,M,R,F,$,H){const K=T-m,ne=M-y,se=R-T,me=($-T)/se,ge=(H-T)/se,ve=Math.min(me,ge),Ae=Math.max(me,ge),He=y+ne*ve;let Ie=Math.floor(Math.min(He,F)/this._granularityCellSize)+1,Le=Math.ceil(Math.max(He,F)/this._granularityCellSize)-1,Ke=F<He;const nt=se===0;if(nt&&(R===$||R===H))return;if(nt||ve>=1||Ae<=0){const Ut=m-R,Bt=M+(u-M)*Math.min(($-R)/Ut,(H-R)/Ut);Ie=Math.floor(Math.min(Bt,F)/this._granularityCellSize)+1,Le=Math.ceil(Math.max(Bt,F)/this._granularityCellSize)-1,Ke=F<Bt}const Ct=K>0?H:$;if(Ke)for(let Ut=Ie;Ut<=Le;Ut++)a.push(this._vertexToIndex(Ut*this._granularityCellSize,Ct));else for(let Ut=Le;Ut>=Ie;Ut--)a.push(this._vertexToIndex(Ut*this._granularityCellSize,Ct))}_generateOutline(a){const u=[];for(const m of a){const y=Ff(m,this._granularity,!0),T=this._pointArrayToIndices(y),M=[];for(let R=1;R<T.length;R++)M.push(T[R-1]),M.push(T[R]);u.push(M)}return u}_handlePoles(a){let u=!1,m=!1;this._canonical&&(this._canonical.y===0&&(u=!0),this._canonical.y===(1<<this._canonical.z)-1&&(m=!0)),(u||m)&&this._fillPoles(a,u,m)}_ensureNoPoleVertices(){const a=this._vertexBuffer;for(let u=0;u<a.length;u+=2){const m=a[u+1];m===Tm&&(a[u+1]=-32767),m===rv&&(a[u+1]=32766)}}_generatePoleQuad(a,u,m,y,T,M){y>T!=(M===Tm)?(a.push(u),a.push(m),a.push(this._vertexToIndex(y,M)),a.push(m),a.push(this._vertexToIndex(T,M)),a.push(this._vertexToIndex(y,M))):(a.push(m),a.push(u),a.push(this._vertexToIndex(y,M)),a.push(this._vertexToIndex(T,M)),a.push(m),a.push(this._vertexToIndex(y,M)))}_fillPoles(a,u,m){const y=this._vertexBuffer,T=Pe,M=a.length;for(let R=2;R<M;R+=3){const F=a[R-2],$=a[R-1],H=a[R],K=y[2*F],ne=y[2*F+1],se=y[2*$],me=y[2*$+1],ge=y[2*H],ve=y[2*H+1];u&&(ne===0&&me===0&&this._generatePoleQuad(a,F,$,K,se,Tm),me===0&&ve===0&&this._generatePoleQuad(a,$,H,se,ge,Tm),ve===0&&ne===0&&this._generatePoleQuad(a,H,F,ge,K,Tm)),m&&(ne===T&&me===T&&this._generatePoleQuad(a,F,$,K,se,rv),me===T&&ve===T&&this._generatePoleQuad(a,$,H,se,ge,rv),ve===T&&ne===T&&this._generatePoleQuad(a,H,F,ge,K,rv))}}_initializeVertices(a){for(let u=0;u<a.length;u+=2)this._vertexToIndex(a[u],a[u+1])}subdividePolygonInternal(a,u){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:m,holeIndices:y}=(function(R){const F=[],$=[];for(const H of R)if(H.length!==0){H!==R[0]&&F.push($.length/2);for(let K=0;K<H.length;K++)$.push(H[K].x),$.push(H[K].y)}return{flattened:$,holeIndices:F}})(a);let T;this._initializeVertices(m);try{const R=(function($,H,K=2){const ne=H&&H.length,se=ne?H[0]*K:$.length;let me=OE($,0,se,K,!0);const ge=[];if(!me||me.next===me.prev)return ge;let ve,Ae,He;if(ne&&(me=(function(Ie,Le,Ke,nt){const Ct=[];for(let Ut=0,Bt=Le.length;Ut<Bt;Ut++){const Zt=OE(Ie,Le[Ut]*nt,Ut<Bt-1?Le[Ut+1]*nt:Ie.length,nt,!1);Zt===Zt.next&&(Zt.steiner=!0),Ct.push(h4(Zt))}Ct.sort(l4);for(let Ut=0;Ut<Ct.length;Ut++)Ke=c4(Ct[Ut],Ke);return Ke})($,H,me,K)),$.length>80*K){ve=$[0],Ae=$[1];let Ie=ve,Le=Ae;for(let Ke=K;Ke<se;Ke+=K){const nt=$[Ke],Ct=$[Ke+1];nt<ve&&(ve=nt),Ct<Ae&&(Ae=Ct),nt>Ie&&(Ie=nt),Ct>Le&&(Le=Ct)}He=Math.max(Ie-ve,Le-Ae),He=He!==0?32767/He:0}return ev(me,ge,K,ve,Ae,He,0),ge})(m,y),F=this._convertIndices(m,R);T=this._subdivideTrianglesScanline(F)}catch(R){console.error(R)}let M=[];return u&&(M=this._generateOutline(a)),this._ensureNoPoleVertices(),this._handlePoles(T),{verticesFlattened:this._vertexBuffer,indicesTriangles:T,indicesLineList:M}}_convertIndices(a,u){const m=[];for(let y=0;y<u.length;y++)m.push(this._vertexToIndex(a[2*u[y]],a[2*u[y]+1]));return m}_pointArrayToIndices(a){const u=[];for(let m=0;m<a.length;m++){const y=a[m];u.push(this._vertexToIndex(y.x,y.y))}return u}}function VE(h,a,u,m=!0){return new f4(u,a).subdividePolygonInternal(h,m)}function Ff(h,a,u=!1){if(!h||h.length<1)return[];if(h.length<2)return[];const m=h[0],y=h[h.length-1],T=u&&(m.x!==y.x||m.y!==y.y);if(a<2)return T?[...h,h[0]]:[...h];const M=Math.floor(Pe/a),R=[];R.push(new d(h[0].x,h[0].y));const F=h.length,$=T?F:F-1;for(let H=0;H<$;H++){const K=h[H],ne=H<F-1?h[H+1]:h[0],se=K.x,me=K.y,ge=ne.x,ve=ne.y,Ae=se!==ge,He=me!==ve;if(!Ae&&!He)continue;const Ie=ge-se,Le=ve-me,Ke=Math.abs(Ie),nt=Math.abs(Le);let Ct=se,Ut=me;for(;;){const Zt=Ie>0?(Math.floor(Ct/M)+1)*M:(Math.ceil(Ct/M)-1)*M,ni=Le>0?(Math.floor(Ut/M)+1)*M:(Math.ceil(Ut/M)-1)*M,Yt=Math.abs(Ct-Zt),$t=Math.abs(Ut-ni),Rt=Math.abs(Ct-ge),fi=Math.abs(Ut-ve),hi=Ae?Yt/Ke:Number.POSITIVE_INFINITY,vi=He?$t/nt:Number.POSITIVE_INFINITY;if((Rt<=Yt||!Ae)&&(fi<=$t||!He))break;if(hi<vi&&Ae||!He){Ct=Zt,Ut+=Le*hi;const ui=new d(Ct,Math.round(Ut));R[R.length-1].x===ui.x&&R[R.length-1].y===ui.y||R.push(ui)}else{Ct+=Ie*vi,Ut=ni;const ui=new d(Math.round(Ct),Ut);R[R.length-1].x===ui.x&&R[R.length-1].y===ui.y||R.push(ui)}}const Bt=new d(ge,ve);R[R.length-1].x===Bt.x&&R[R.length-1].y===Bt.y||R.push(Bt)}return R}function p4(h,a,u){if(a.length===0)throw new Error("Subdivision vertex ring is empty.");let m=0,y=h[2*a[0]];for(let F=1;F<a.length;F++){const $=h[2*a[F]];$<y&&(y=$,m=F)}const T=a.length;let M=m,R=(M+1)%T;for(;;){const F=M-1>=0?M-1:T-1,$=(R+1)%T,H=h[2*a[F]],K=h[2*a[$]],ne=h[2*a[M]],se=h[2*a[M]+1],me=h[2*a[R]+1];let ge=!1;if(H<K)ge=!0;else if(H>K)ge=!1;else{const ve=me-se,Ae=-(h[2*a[R]]-ne),He=se<me?1:-1;((H-ne)*ve+(h[2*a[F]+1]-se)*Ae)*He>((K-ne)*ve+(h[2*a[$]+1]-se)*Ae)*He&&(ge=!0)}if(ge){const ve=a[F],Ae=a[M],He=a[R];ve!==Ae&&ve!==He&&Ae!==He&&u.push(He,Ae,ve),M--,M<0&&(M=T-1)}else{const ve=a[$],Ae=a[M],He=a[R];ve!==Ae&&ve!==He&&Ae!==He&&u.push(He,Ae,ve),R++,R>=T&&(R=0)}if(F===$)break}}function UE(h,a,u,m,y,T,M,R,F){const $=y.length/2,H=M&&R&&F;if($<oi.MAX_VERTEX_ARRAY_LENGTH){const K=a.prepareSegment($,u,m),ne=K.vertexLength;for(let ge=0;ge<T.length;ge+=3)m.emplaceBack(ne+T[ge],ne+T[ge+1],ne+T[ge+2]);let se,me;K.vertexLength+=$,K.primitiveLength+=T.length/3,H&&(me=M.prepareSegment($,u,R),se=me.vertexLength,me.vertexLength+=$);for(let ge=0;ge<y.length;ge+=2)h(y[ge],y[ge+1]);if(H)for(let ge=0;ge<F.length;ge++){const ve=F[ge];for(let Ae=1;Ae<ve.length;Ae+=2)R.emplaceBack(se+ve[Ae-1],se+ve[Ae]);me.primitiveLength+=ve.length/2}}else(function(K,ne,se,me,ge,ve){const Ae=[];for(let nt=0;nt<me.length/2;nt++)Ae.push(-1);const He={count:0};let Ie=0,Le=K.getOrCreateLatestSegment(ne,se),Ke=Le.vertexLength;for(let nt=2;nt<ge.length;nt+=3){const Ct=ge[nt-2],Ut=ge[nt-1],Bt=ge[nt];let Zt=Ae[Ct]<Ie,ni=Ae[Ut]<Ie,Yt=Ae[Bt]<Ie;Le.vertexLength+((Zt?1:0)+(ni?1:0)+(Yt?1:0))>oi.MAX_VERTEX_ARRAY_LENGTH&&(Le=K.createNewSegment(ne,se),Ie=He.count,Zt=!0,ni=!0,Yt=!0,Ke=0);const $t=sv(Ae,me,ve,He,Ct,Zt,Le),Rt=sv(Ae,me,ve,He,Ut,ni,Le),fi=sv(Ae,me,ve,He,Bt,Yt,Le);se.emplaceBack(Ke+$t-Ie,Ke+Rt-Ie,Ke+fi-Ie),Le.primitiveLength++}})(a,u,m,y,T,h),H&&(function(K,ne,se,me,ge,ve){const Ae=[];for(let nt=0;nt<me.length/2;nt++)Ae.push(-1);const He={count:0};let Ie=0,Le=K.getOrCreateLatestSegment(ne,se),Ke=Le.vertexLength;for(let nt=0;nt<ge.length;nt++){const Ct=ge[nt];for(let Ut=1;Ut<ge[nt].length;Ut+=2){const Bt=Ct[Ut-1],Zt=Ct[Ut];let ni=Ae[Bt]<Ie,Yt=Ae[Zt]<Ie;Le.vertexLength+((ni?1:0)+(Yt?1:0))>oi.MAX_VERTEX_ARRAY_LENGTH&&(Le=K.createNewSegment(ne,se),Ie=He.count,ni=!0,Yt=!0,Ke=0);const $t=sv(Ae,me,ve,He,Bt,ni,Le),Rt=sv(Ae,me,ve,He,Zt,Yt,Le);se.emplaceBack(Ke+$t-Ie,Ke+Rt-Ie),Le.primitiveLength++}}})(M,u,R,y,F,h),a.forceNewSegmentOnNextPrepare(),M?.forceNewSegmentOnNextPrepare()}function sv(h,a,u,m,y,T,M){if(T){const R=m.count;return u(a[2*y],a[2*y+1]),h[y]=m.count,m.count++,M.vertexLength++,R}return h[y]}class K1{constructor(a){this.zoom=a.zoom,this.overscaling=a.overscaling,this.layers=a.layers,this.layerIds=this.layers.map((u=>u.id)),this.index=a.index,this.hasDependencies=!1,this.patternFeatures=[],this.layoutVertexArray=new Ne,this.indexArray=new It,this.indexArray2=new Qt,this.programConfigurations=new Xu(a.layers,a.zoom),this.segments=new oi,this.segments2=new oi,this.stateDependentLayerIds=this.layers.filter((u=>u.isStateDependent())).map((u=>u.id))}populate(a,u,m){this.hasDependencies=ib("fill",this.layers,u);const y=this.layers[0].layout.get("fill-sort-key"),T=!y.isConstant(),M=[];for(const{feature:R,id:F,index:$,sourceLayerIndex:H}of a){const K=this.layers[0]._featureFilter.needGeometry,ne=Kc(R,K);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom),ne,m))continue;const se=T?y.evaluate(ne,{},m,u.availableImages):void 0,me={id:F,properties:R.properties,type:R.type,sourceLayerIndex:H,index:$,geometry:K?ne.geometry:Yc(R),patterns:{},sortKey:se};M.push(me)}T&&M.sort(((R,F)=>R.sortKey-F.sortKey));for(const R of M){const{geometry:F,index:$,sourceLayerIndex:H}=R;if(this.hasDependencies){const K=Z1("fill",this.layers,R,{zoom:this.zoom},u);this.patternFeatures.push(K)}else this.addFeature(R,F,$,m,{},u.subdivisionGranularity);u.featureIndex.insert(a[$].feature,F,$,H,this.index)}}update(a,u,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(a,u,this.stateDependentLayers,{imagePositions:m})}addFeatures(a,u,m){for(const y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,u,m,a.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(a){this.uploaded||(this.layoutVertexBuffer=a.createVertexBuffer(this.layoutVertexArray,n4),this.indexBuffer=a.createIndexBuffer(this.indexArray),this.indexBuffer2=a.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(a),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(a,u,m,y,T,M){for(const R of Gh(u,500)){const F=VE(R,y,M.fill.getGranularityForZoomLevel(y.z)),$=this.layoutVertexArray;UE(((H,K)=>{$.emplaceBack(H,K)}),this.segments,this.layoutVertexArray,this.indexArray,F.verticesFlattened,F.indicesTriangles,this.segments2,this.indexArray2,F.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,a,m,{imagePositions:T,canonical:y})}}let jE,GE;mi("FillBucket",K1,{omit:["layers","patternFeatures"]});var m4={get paint(){return GE=GE||new co({"fill-antialias":new Mi(Tt.paint_fill["fill-antialias"]),"fill-opacity":new Oi(Tt.paint_fill["fill-opacity"]),"fill-color":new Oi(Tt.paint_fill["fill-color"]),"fill-outline-color":new Oi(Tt.paint_fill["fill-outline-color"]),"fill-translate":new Mi(Tt.paint_fill["fill-translate"]),"fill-translate-anchor":new Mi(Tt.paint_fill["fill-translate-anchor"]),"fill-pattern":new Cf(Tt.paint_fill["fill-pattern"])})},get layout(){return jE=jE||new co({"fill-sort-key":new Oi(Tt.layout_fill["fill-sort-key"])})}};class g4 extends fa{constructor(a,u){super(a,m4,u)}recalculate(a,u){super.recalculate(a,u);const m=this.paint._values["fill-outline-color"];m.value.kind==="constant"&&m.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(a){return new K1(a)}queryRadius(){return eb(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:a,geometry:u,transform:m,pixelsToTileUnits:y}){return wE(tb(a,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-m.bearingInRadians,y),u)}isTileClipped(){return!0}}const _4=Zr([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),v4=Zr([{name:"a_centroid",components:2,type:"Int16"}],4),{members:y4}=_4;class ov{constructor(a,u,m,y,T){this.properties={},this.extent=m,this.type=0,this.id=void 0,this._pbf=a,this._geometry=-1,this._keys=y,this._values=T,a.readFields(b4,this,u)}loadGeometry(){const a=this._pbf;a.pos=this._geometry;const u=a.readVarint()+a.pos,m=[];let y,T=1,M=0,R=0,F=0;for(;a.pos<u;){if(M<=0){const $=a.readVarint();T=7&$,M=$>>3}if(M--,T===1||T===2)R+=a.readSVarint(),F+=a.readSVarint(),T===1&&(y&&m.push(y),y=[]),y&&y.push(new d(R,F));else{if(T!==7)throw new Error(`unknown command ${T}`);y&&y.push(y[0].clone())}}return y&&m.push(y),m}bbox(){const a=this._pbf;a.pos=this._geometry;const u=a.readVarint()+a.pos;let m=1,y=0,T=0,M=0,R=1/0,F=-1/0,$=1/0,H=-1/0;for(;a.pos<u;){if(y<=0){const K=a.readVarint();m=7&K,y=K>>3}if(y--,m===1||m===2)T+=a.readSVarint(),M+=a.readSVarint(),T<R&&(R=T),T>F&&(F=T),M<$&&($=M),M>H&&(H=M);else if(m!==7)throw new Error(`unknown command ${m}`)}return[R,$,F,H]}toGeoJSON(a,u,m){const y=this.extent*Math.pow(2,m),T=this.extent*a,M=this.extent*u,R=this.loadGeometry();function F(ne){return[360*(ne.x+T)/y-180,360/Math.PI*Math.atan(Math.exp((1-2*(ne.y+M)/y)*Math.PI))-90]}function $(ne){return ne.map(F)}let H;if(this.type===1){const ne=[];for(const me of R)ne.push(me[0]);const se=$(ne);H=ne.length===1?{type:"Point",coordinates:se[0]}:{type:"MultiPoint",coordinates:se}}else if(this.type===2){const ne=R.map($);H=ne.length===1?{type:"LineString",coordinates:ne[0]}:{type:"MultiLineString",coordinates:ne}}else{if(this.type!==3)throw new Error("unknown feature type");{const ne=qE(R),se=[];for(const me of ne)se.push(me.map($));H=se.length===1?{type:"Polygon",coordinates:se[0]}:{type:"MultiPolygon",coordinates:se}}}const K={type:"Feature",geometry:H,properties:this.properties};return this.id!=null&&(K.id=this.id),K}}function b4(h,a,u){h===1?a.id=u.readVarint():h===2?(function(m,y){const T=m.readVarint()+m.pos;for(;m.pos<T;){const M=y._keys[m.readVarint()],R=y._values[m.readVarint()];y.properties[M]=R}})(u,a):h===3?a.type=u.readVarint():h===4&&(a._geometry=u.pos)}function qE(h){const a=h.length;if(a<=1)return[h];const u=[];let m,y;for(let T=0;T<a;T++){const M=x4(h[T]);M!==0&&(y===void 0&&(y=M<0),y===M<0?(m&&u.push(m),m=[h[T]]):m&&m.push(h[T]))}return m&&u.push(m),u}function x4(h){let a=0;for(let u,m,y=0,T=h.length,M=T-1;y<T;M=y++)u=h[y],m=h[M],a+=(m.x-u.x)*(u.y+m.y);return a}ov.types=["Unknown","Point","LineString","Polygon"];class w4{constructor(a,u){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=a,this._keys=[],this._values=[],this._features=[],a.readFields(S4,this,u),this.length=this._features.length}feature(a){if(a<0||a>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[a];const u=this._pbf.readVarint()+this._pbf.pos;return new ov(this._pbf,u,this.extent,this._keys,this._values)}}function S4(h,a,u){h===15?a.version=u.readVarint():h===1?a.name=u.readString():h===5?a.extent=u.readVarint():h===2?a._features.push(u.pos):h===3?a._keys.push(u.readString()):h===4&&a._values.push((function(m){let y=null;const T=m.readVarint()+m.pos;for(;m.pos<T;){const M=m.readVarint()>>3;y=M===1?m.readString():M===2?m.readFloat():M===3?m.readDouble():M===4?m.readVarint64():M===5?m.readVarint():M===6?m.readSVarint():M===7?m.readBoolean():null}if(y==null)throw new Error("unknown feature value");return y})(u))}class WE{constructor(a,u){this.layers=a.readFields(T4,{},u)}}function T4(h,a,u){if(h===3){const m=new w4(u,u.readVarint()+u.pos);m.length&&(a[m.name]=m)}}const J1=Math.pow(2,13);function av(h,a,u,m,y,T,M,R){h.emplaceBack(a,u,2*Math.floor(m*J1)+M,y*J1*2,T*J1*2,Math.round(R))}class Q1{constructor(a){this.zoom=a.zoom,this.overscaling=a.overscaling,this.layers=a.layers,this.layerIds=this.layers.map((u=>u.id)),this.index=a.index,this.hasDependencies=!1,this.layoutVertexArray=new Ze,this.centroidVertexArray=new ze,this.indexArray=new It,this.programConfigurations=new Xu(a.layers,a.zoom),this.segments=new oi,this.stateDependentLayerIds=this.layers.filter((u=>u.isStateDependent())).map((u=>u.id))}populate(a,u,m){this.features=[],this.hasDependencies=ib("fill-extrusion",this.layers,u);for(const{feature:y,id:T,index:M,sourceLayerIndex:R}of a){const F=this.layers[0]._featureFilter.needGeometry,$=Kc(y,F);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom),$,m))continue;const H={id:T,sourceLayerIndex:R,index:M,geometry:F?$.geometry:Yc(y),properties:y.properties,type:y.type,patterns:{}};this.hasDependencies?this.features.push(Z1("fill-extrusion",this.layers,H,{zoom:this.zoom},u)):this.addFeature(H,H.geometry,M,m,{},u.subdivisionGranularity),u.featureIndex.insert(y,H.geometry,M,R,this.index,!0)}}addFeatures(a,u,m){for(const y of this.features){const{geometry:T}=y;this.addFeature(y,T,y.index,u,m,a.subdivisionGranularity)}}update(a,u,m){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(a,u,this.stateDependentLayers,{imagePositions:m})}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(a){this.uploaded||(this.layoutVertexBuffer=a.createVertexBuffer(this.layoutVertexArray,y4),this.centroidVertexBuffer=a.createVertexBuffer(this.centroidVertexArray,v4.members,!0),this.indexBuffer=a.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(a),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(a,u,m,y,T,M){for(const R of Gh(u,500)){const F={x:0,y:0,sampleCount:0},$=this.layoutVertexArray.length;this.processPolygon(F,y,a,R,M);const H=this.layoutVertexArray.length-$,K=Math.floor(F.x/F.sampleCount),ne=Math.floor(F.y/F.sampleCount);for(let se=0;se<H;se++)this.centroidVertexArray.emplaceBack(K,ne)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,a,m,{imagePositions:T,canonical:y})}processPolygon(a,u,m,y,T){if(y.length<1||HE(y[0]))return;for(const K of y)K.length!==0&&M4(a,K);const M={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},R=T.fill.getGranularityForZoomLevel(u.z),F=ov.types[m.type]==="Polygon";for(const K of y){if(K.length===0||HE(K))continue;const ne=Ff(K,R,F);this._generateSideFaces(ne,M)}if(!F)return;const $=VE(y,u,R,!1),H=this.layoutVertexArray;UE(((K,ne)=>{av(H,K,ne,0,0,1,1,0)}),this.segments,this.layoutVertexArray,this.indexArray,$.verticesFlattened,$.indicesTriangles)}_generateSideFaces(a,u){let m=0;for(let y=1;y<a.length;y++){const T=a[y],M=a[y-1];if(C4(T,M))continue;u.segment.vertexLength+4>oi.MAX_VERTEX_ARRAY_LENGTH&&(u.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const R=T.sub(M)._perp()._unit(),F=M.dist(T);m+F>32768&&(m=0),av(this.layoutVertexArray,T.x,T.y,R.x,R.y,0,0,m),av(this.layoutVertexArray,T.x,T.y,R.x,R.y,0,1,m),m+=F,av(this.layoutVertexArray,M.x,M.y,R.x,R.y,0,0,m),av(this.layoutVertexArray,M.x,M.y,R.x,R.y,0,1,m);const $=u.segment.vertexLength;this.indexArray.emplaceBack($,$+2,$+1),this.indexArray.emplaceBack($+1,$+2,$+3),u.segment.vertexLength+=4,u.segment.primitiveLength+=2}}}function M4(h,a){for(let u=0;u<a.length;u++){const m=a[u];u===a.length-1&&a[0].x===m.x&&a[0].y===m.y||(h.x+=m.x,h.y+=m.y,h.sampleCount++)}}function C4(h,a){return h.x===a.x&&(h.x<0||h.x>Pe)||h.y===a.y&&(h.y<0||h.y>Pe)}function HE(h){return h.every((a=>a.x<0))||h.every((a=>a.x>Pe))||h.every((a=>a.y<0))||h.every((a=>a.y>Pe))}let ZE;mi("FillExtrusionBucket",Q1,{omit:["layers","features"]});var E4={get paint(){return ZE=ZE||new co({"fill-extrusion-opacity":new Mi(Tt["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Oi(Tt["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Mi(Tt["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Mi(Tt["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Cf(Tt["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Oi(Tt["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Oi(Tt["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Mi(Tt["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class A4 extends fa{constructor(a,u){super(a,E4,u)}createBucket(a){return new Q1(a)}queryRadius(){return eb(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:a,feature:u,featureState:m,geometry:y,transform:T,pixelsToTileUnits:M,pixelPosMatrix:R}){const F=tb(a,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-T.bearingInRadians,M),$=this.paint.get("fill-extrusion-height").evaluate(u,m),H=this.paint.get("fill-extrusion-base").evaluate(u,m),K=(function(se,me){const ge=[];for(const ve of se){const Ae=[ve.x,ve.y,0,1];re(Ae,Ae,me),ge.push(new d(Ae[0]/Ae[3],Ae[1]/Ae[3]))}return ge})(F,R),ne=(function(se,me,ge,ve){const Ae=[],He=[],Ie=ve[8]*me,Le=ve[9]*me,Ke=ve[10]*me,nt=ve[11]*me,Ct=ve[8]*ge,Ut=ve[9]*ge,Bt=ve[10]*ge,Zt=ve[11]*ge;for(const ni of se){const Yt=[],$t=[];for(const Rt of ni){const fi=Rt.x,hi=Rt.y,vi=ve[0]*fi+ve[4]*hi+ve[12],ui=ve[1]*fi+ve[5]*hi+ve[13],Ei=ve[2]*fi+ve[6]*hi+ve[14],Tn=ve[3]*fi+ve[7]*hi+ve[15],dn=Ei+Ke,Sr=Tn+nt,to=vi+Ct,ps=ui+Ut,Tr=Ei+Bt,gr=Tn+Zt,In=new d((vi+Ie)/Sr,(ui+Le)/Sr);In.z=dn/Sr,Yt.push(In);const Nr=new d(to/gr,ps/gr);Nr.z=Tr/gr,$t.push(Nr)}Ae.push(Yt),He.push($t)}return[Ae,He]})(y,H,$,R);return(function(se,me,ge){let ve=1/0;wE(ge,me)&&(ve=XE(ge,me[0]));for(let Ae=0;Ae<me.length;Ae++){const He=me[Ae],Ie=se[Ae];for(let Le=0;Le<He.length-1;Le++){const Ke=He[Le],nt=[Ke,He[Le+1],Ie[Le+1],Ie[Le],Ke];ym(ge,nt)&&(ve=Math.min(ve,XE(ge,nt)))}}return ve!==1/0&&ve})(ne[0],ne[1],K)}}function lv(h,a){return h.x*a.x+h.y*a.y}function XE(h,a){if(h.length===1){let u=0;const m=a[u++];let y;for(;!y||m.equals(y);)if(y=a[u++],!y)return 1/0;for(;u<a.length;u++){const T=a[u],M=h[0],R=y.sub(m),F=T.sub(m),$=M.sub(m),H=lv(R,R),K=lv(R,F),ne=lv(F,F),se=lv($,R),me=lv($,F),ge=H*ne-K*K,ve=(ne*se-K*me)/ge,Ae=(H*me-K*se)/ge,He=m.z*(1-ve-Ae)+y.z*ve+T.z*Ae;if(isFinite(He))return He}return 1/0}{let u=1/0;for(const m of a)u=Math.min(u,m.z);return u}}const P4=Zr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:I4}=P4,R4=Zr([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:L4}=R4,k4=Math.cos(Math.PI/180*37.5),YE=Math.pow(2,14)/.5;class eS{constructor(a){this.zoom=a.zoom,this.overscaling=a.overscaling,this.layers=a.layers,this.layerIds=this.layers.map((u=>u.id)),this.index=a.index,this.hasDependencies=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((u=>{this.gradients[u.id]={}})),this.layoutVertexArray=new rt,this.layoutVertexArray2=new We,this.indexArray=new It,this.programConfigurations=new Xu(a.layers,a.zoom),this.segments=new oi,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((u=>u.isStateDependent())).map((u=>u.id))}populate(a,u,m){this.hasDependencies=ib("line",this.layers,u)||this.hasLineDasharray(this.layers);const y=this.layers[0].layout.get("line-sort-key"),T=!y.isConstant(),M=[];for(const{feature:R,id:F,index:$,sourceLayerIndex:H}of a){const K=this.layers[0]._featureFilter.needGeometry,ne=Kc(R,K);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom),ne,m))continue;const se=T?y.evaluate(ne,{},m):void 0,me={id:F,properties:R.properties,type:R.type,sourceLayerIndex:H,index:$,geometry:K?ne.geometry:Yc(R),patterns:{},dashes:{},sortKey:se};M.push(me)}T&&M.sort(((R,F)=>R.sortKey-F.sortKey));for(const R of M){const{geometry:F,index:$,sourceLayerIndex:H}=R;this.hasDependencies?(ib("line",this.layers,u)?Z1("line",this.layers,R,{zoom:this.zoom},u):this.hasLineDasharray(this.layers)&&this.addLineDashDependencies(this.layers,R,this.zoom,u),this.patternFeatures.push(R)):this.addFeature(R,F,$,m,{},{},u.subdivisionGranularity),u.featureIndex.insert(a[$].feature,F,$,H,this.index)}}update(a,u,m,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(a,u,this.stateDependentLayers,{imagePositions:m,dashPositions:y})}addFeatures(a,u,m,y){for(const T of this.patternFeatures)this.addFeature(T,T.geometry,T.index,u,m,y,a.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(a){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=a.createVertexBuffer(this.layoutVertexArray2,L4)),this.layoutVertexBuffer=a.createVertexBuffer(this.layoutVertexArray,I4),this.indexBuffer=a.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(a),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(a){if(a.properties&&Object.prototype.hasOwnProperty.call(a.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(a.properties,"mapbox_clip_end"))return{start:+a.properties.mapbox_clip_start,end:+a.properties.mapbox_clip_end}}addFeature(a,u,m,y,T,M,R){const F=this.layers[0].layout,$=F.get("line-join").evaluate(a,{}),H=F.get("line-cap"),K=F.get("line-miter-limit"),ne=F.get("line-round-limit");this.lineClips=this.lineFeatureClips(a);for(const se of u)this.addLine(se,a,$,H,K,ne,y,R);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,a,m,{imagePositions:T,dashPositions:M,canonical:y})}addLine(a,u,m,y,T,M,R,F){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,a=Ff(a,R?F.line.getGranularityForZoomLevel(R.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Ie=0;Ie<a.length-1;Ie++)this.totalDistance+=a[Ie].dist(a[Ie+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const $=ov.types[u.type]==="Polygon";let H=a.length;for(;H>=2&&a[H-1].equals(a[H-2]);)H--;let K=0;for(;K<H-1&&a[K].equals(a[K+1]);)K++;if(H<($?3:2))return;m==="bevel"&&(T=1.05);const ne=this.overscaling<=16?122880/(512*this.overscaling):0,se=this.segments.prepareSegment(10*H,this.layoutVertexArray,this.indexArray);let me,ge,ve,Ae,He;this.e1=this.e2=-1,$&&(me=a[H-2],He=a[K].sub(me)._unit()._perp());for(let Ie=K;Ie<H;Ie++){if(ve=Ie===H-1?$?a[K+1]:void 0:a[Ie+1],ve&&a[Ie].equals(ve))continue;He&&(Ae=He),me&&(ge=me),me=a[Ie],He=ve?ve.sub(me)._unit()._perp():Ae,Ae=Ae||He;let Le=Ae.add(He);Le.x===0&&Le.y===0||Le._unit();const Ke=Ae.x*He.x+Ae.y*He.y,nt=Le.x*He.x+Le.y*He.y,Ct=nt!==0?1/nt:1/0,Ut=2*Math.sqrt(2-2*nt),Bt=nt<k4&&ge&&ve,Zt=Ae.x*He.y-Ae.y*He.x>0;if(Bt&&Ie>K){const $t=me.dist(ge);if($t>2*ne){const Rt=me.sub(me.sub(ge)._mult(ne/$t)._round());this.updateDistance(ge,Rt),this.addCurrentVertex(Rt,Ae,0,0,se),ge=Rt}}const ni=ge&&ve;let Yt=ni?m:$?"butt":y;if(ni&&Yt==="round"&&(Ct<M?Yt="miter":Ct<=2&&(Yt="fakeround")),Yt==="miter"&&Ct>T&&(Yt="bevel"),Yt==="bevel"&&(Ct>2&&(Yt="flipbevel"),Ct<T&&(Yt="miter")),ge&&this.updateDistance(ge,me),Yt==="miter")Le._mult(Ct),this.addCurrentVertex(me,Le,0,0,se);else if(Yt==="flipbevel"){if(Ct>100)Le=He.mult(-1);else{const $t=Ct*Ae.add(He).mag()/Ae.sub(He).mag();Le._perp()._mult($t*(Zt?-1:1))}this.addCurrentVertex(me,Le,0,0,se),this.addCurrentVertex(me,Le.mult(-1),0,0,se)}else if(Yt==="bevel"||Yt==="fakeround"){const $t=-Math.sqrt(Ct*Ct-1),Rt=Zt?$t:0,fi=Zt?0:$t;if(ge&&this.addCurrentVertex(me,Ae,Rt,fi,se),Yt==="fakeround"){const hi=Math.round(180*Ut/Math.PI/20);for(let vi=1;vi<hi;vi++){let ui=vi/hi;if(ui!==.5){const Tn=ui-.5;ui+=ui*Tn*(ui-1)*((1.0904+Ke*(Ke*(3.55645-1.43519*Ke)-3.2452))*Tn*Tn+(.848013+Ke*(.215638*Ke-1.06021)))}const Ei=He.sub(Ae)._mult(ui)._add(Ae)._unit()._mult(Zt?-1:1);this.addHalfVertex(me,Ei.x,Ei.y,!1,Zt,0,se)}}ve&&this.addCurrentVertex(me,He,-Rt,-fi,se)}else if(Yt==="butt")this.addCurrentVertex(me,Le,0,0,se);else if(Yt==="square"){const $t=ge?1:-1;this.addCurrentVertex(me,Le,$t,$t,se)}else Yt==="round"&&(ge&&(this.addCurrentVertex(me,Ae,0,0,se),this.addCurrentVertex(me,Ae,1,1,se,!0)),ve&&(this.addCurrentVertex(me,He,-1,-1,se,!0),this.addCurrentVertex(me,He,0,0,se)));if(Bt&&Ie<H-1){const $t=me.dist(ve);if($t>2*ne){const Rt=me.add(ve.sub(me)._mult(ne/$t)._round());this.updateDistance(me,Rt),this.addCurrentVertex(Rt,He,0,0,se),me=Rt}}}}addCurrentVertex(a,u,m,y,T,M=!1){const R=u.y*y-u.x,F=-u.y-u.x*y;this.addHalfVertex(a,u.x+u.y*m,u.y-u.x*m,M,!1,m,T),this.addHalfVertex(a,R,F,M,!0,-y,T),this.distance>YE/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(a,u,m,y,T,M))}addHalfVertex({x:a,y:u},m,y,T,M,R,F){const $=.5*(this.lineClips?this.scaledDistance*(YE-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((a<<1)+(T?1:0),(u<<1)+(M?1:0),Math.round(63*m)+128,Math.round(63*y)+128,1+(R===0?0:R<0?-1:1)|(63&$)<<2,$>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const H=F.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,H,this.e2),F.primitiveLength++),M?this.e2=H:this.e1=H}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(a,u){this.distance+=a.dist(u),this.updateScaledDistance()}hasLineDasharray(a){for(const u of a){const m=u.paint.get("line-dasharray");if(m&&!m.isConstant())return!0}return!1}addLineDashDependencies(a,u,m,y){for(const T of a){const M=T.paint.get("line-dasharray");if(!M||M.value.kind==="constant")continue;const R=T.layout.get("line-cap")==="round",F={dasharray:M.value.evaluate({zoom:m-1},u,{}),round:R},$={dasharray:M.value.evaluate({zoom:m},u,{}),round:R},H={dasharray:M.value.evaluate({zoom:m+1},u,{}),round:R},K=`${F.dasharray.join(",")},${F.round}`,ne=`${$.dasharray.join(",")},${$.round}`,se=`${H.dasharray.join(",")},${H.round}`;y.dashDependencies[K]=F,y.dashDependencies[ne]=$,y.dashDependencies[se]=H,u.dashes[T.id]={min:K,mid:ne,max:se}}}}let KE,JE;mi("LineBucket",eS,{omit:["layers","patternFeatures"]});var QE={get paint(){return JE=JE||new co({"line-opacity":new Oi(Tt.paint_line["line-opacity"]),"line-color":new Oi(Tt.paint_line["line-color"]),"line-translate":new Mi(Tt.paint_line["line-translate"]),"line-translate-anchor":new Mi(Tt.paint_line["line-translate-anchor"]),"line-width":new Oi(Tt.paint_line["line-width"]),"line-gap-width":new Oi(Tt.paint_line["line-gap-width"]),"line-offset":new Oi(Tt.paint_line["line-offset"]),"line-blur":new Oi(Tt.paint_line["line-blur"]),"line-dasharray":new Cf(Tt.paint_line["line-dasharray"]),"line-pattern":new Cf(Tt.paint_line["line-pattern"]),"line-gradient":new hm(Tt.paint_line["line-gradient"])})},get layout(){return KE=KE||new co({"line-cap":new Mi(Tt.layout_line["line-cap"]),"line-join":new Oi(Tt.layout_line["line-join"]),"line-miter-limit":new Mi(Tt.layout_line["line-miter-limit"]),"line-round-limit":new Mi(Tt.layout_line["line-round-limit"]),"line-sort-key":new Oi(Tt.layout_line["line-sort-key"])})}};class D4 extends Oi{possiblyEvaluate(a,u){return u=new Wn(Math.floor(u.zoom),{now:u.now,fadeDuration:u.fadeDuration,zoomHistory:u.zoomHistory,transition:u.transition}),super.possiblyEvaluate(a,u)}evaluate(a,u,m,y){return u=Je({},u,{zoom:Math.floor(u.zoom)}),super.evaluate(a,u,m,y)}}let ob;class F4 extends fa{constructor(a,u){super(a,QE,u),this.gradientVersion=0,ob||(ob=new D4(QE.paint.properties["line-width"].specification),ob.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(a){if(a==="line-gradient"){const u=this.gradientExpression();this.stepInterpolant=!!(function(m){return m._styleExpression!==void 0})(u)&&u._styleExpression.expression instanceof Ea,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(a,u){super.recalculate(a,u),this.paint._values["line-floorwidth"]=ob.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,a)}createBucket(a){return new eS(a)}queryRadius(a){const u=a,m=eA(xm("line-width",this,u),xm("line-gap-width",this,u)),y=xm("line-offset",this,u);return m/2+Math.abs(y)+eb(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:a,feature:u,featureState:m,geometry:y,transform:T,pixelsToTileUnits:M}){const R=tb(a,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-T.bearingInRadians,M),F=M/2*eA(this.paint.get("line-width").evaluate(u,m),this.paint.get("line-gap-width").evaluate(u,m)),$=this.paint.get("line-offset").evaluate(u,m);return $&&(y=(function(H,K){const ne=[];for(let se=0;se<H.length;se++){const me=jN(H[se]),ge=[];for(let ve=0;ve<me.length;ve++){const Ae=me[ve],He=me[ve-1],Ie=me[ve+1],Le=ve===0?new d(0,0):Ae.sub(He)._unit()._perp(),Ke=ve===me.length-1?new d(0,0):Ie.sub(Ae)._unit()._perp(),nt=Le._add(Ke)._unit(),Ct=nt.x*Ke.x+nt.y*Ke.y;Ct!==0&&nt._mult(1/Ct),ge.push(nt._mult(K)._add(Ae))}ne.push(ge)}return ne})(y,$*M)),(function(H,K,ne){for(let se=0;se<K.length;se++){const me=K[se];if(H.length>=3){for(let ge=0;ge<me.length;ge++)if(bm(H,me[ge]))return!0}if($N(H,me,ne))return!0}return!1})(R,y,F)}isTileClipped(){return!0}}function eA(h,a){return a>0?a+2*h:h}const O4=Zr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),z4=Zr([{name:"a_projected_pos",components:3,type:"Float32"}],4);Zr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const B4=Zr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);Zr([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const tA=Zr([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),N4=Zr([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function $4(h,a,u){return h.sections.forEach((m=>{m.text=(function(y,T,M){const R=T.layout.get("text-transform").evaluate(M,{});return R==="uppercase"?y=y.toLocaleUpperCase():R==="lowercase"&&(y=y.toLocaleLowerCase()),Hc.applyArabicShaping&&(y=Hc.applyArabicShaping(y)),y})(m.text,a,u)})),h}Zr([{name:"triangle",components:3,type:"Uint16"}]),Zr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Zr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Zr([{type:"Float32",name:"offsetX"}]),Zr([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Zr([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);var As=24;const cv={"!":"ï¸","#":"ï¼",$:"ï¼","%":"ï¼","&":"ï¼","(":"ï¸µ",")":"ï¸¶","*":"ï¼","+":"ï¼",",":"ï¸","-":"ï¸²",".":"ã»","/":"ï¼",":":"ï¸",";":"ï¸","<":"ï¸¿","=":"ï¼",">":"ï¹","?":"ï¸","@":"ï¼ ","[":"ï¹","\\":"ï¼¼","]":"ï¹","^":"ï¼¾",_:"ï¸³","`":"ï½","{":"ï¸·","|":"â","}":"ï¸¸","~":"ï½","Â¢":"ï¿ ","Â£":"ï¿¡","Â¥":"ï¿¥","Â¦":"ï¿¤","Â¬":"ï¿¢","Â¯":"ï¿£","â":"ï¸²","â":"ï¸±","â":"ï¹","â":"ï¹","â":"ï¹","â":"ï¹","â¦":"ï¸","â¯":"ï¸","â§":"ã»","â©":"ï¿¦","ã":"ï¸","ã":"ï¸","ã":"ï¸¿","ã":"ï¹","ã":"ï¸½","ã":"ï¸¾","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¸»","ã":"ï¸¼","ã":"ï¸¹","ã":"ï¸º","ã":"ï¸","ã":"ï¸","ï¼":"ï¸","ï¼":"ï¸µ","ï¼":"ï¸¶","ï¼":"ï¸","ï¼":"ï¸²","ï¼":"ã»","ï¼":"ï¸","ï¼":"ï¸","ï¼":"ï¸¿","ï¼":"ï¹","ï¼":"ï¸","ï¼»":"ï¹","ï¼½":"ï¹","ï¼¿":"ï¸³","ï½":"ï¸·","ï½":"â","ï½":"ï¸¸","ï½":"ï¸µ","ï½ ":"ï¸¶","ï½¡":"ï¸","ï½¢":"ï¹","ï½£":"ï¹"},V4={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},U4={40:!0};function iA(h,a,u,m,y,T){if("fontStack"in a){const M=u[a.fontStack],R=M&&M[h];return R?R.metrics.advance*a.scale+y:0}{const M=m[a.imageName];return M?M.displaySize[0]*a.scale*As/T+y:0}}function nA(h,a,u,m){const y=Math.pow(h-a,2);return m?h<a?y/2:2*y:y+Math.abs(u)*u}function j4(h,a,u){let m=0;return h===10&&(m-=1e4),u&&(m+=150),h!==40&&h!==65288||(m+=50),a!==41&&a!==65289||(m+=50),m}function rA(h,a,u,m,y,T){let M=null,R=nA(a,u,y,T);for(const F of m){const $=nA(a-F.x,u,y,T)+F.badness;$<=R&&(M=F,R=$)}return{index:h,x:a,priorBreak:M,badness:R}}function sA(h){return h?sA(h.priorBreak).concat(h.index):[]}class Mm{constructor(a="",u=[],m=[]){this.text=a,this.sections=u,this.sectionIndex=m,this.imageSectionID=null}static fromFeature(a,u){const m=new Mm;for(let y=0;y<a.sections.length;y++){const T=a.sections[y];T.image?m.addImageSection(T):m.addTextSection(T,u)}return m}length(){return[...this.text].length}getSection(a){return this.sections[this.sectionIndex[a]]}getSectionIndex(a){return this.sectionIndex[a]}verticalizePunctuation(){this.text=(function(a){let u="",m={premature:!0,value:void 0};const y=a[Symbol.iterator]();let T=y.next();const M=a[Symbol.iterator]();M.next();let R=M.next();for(;!T.done;)u+=!R.done&&N_(R.value.codePointAt(0))&&!cv[R.value]||!m.premature&&N_(m.value.codePointAt(0))&&!cv[m.value]||!cv[T.value]?T.value:cv[T.value],m={value:T.value,premature:!1},T=y.next(),R=M.next();return u})(this.text)}hasZeroWidthSpaces(){return this.text.includes("â")}trim(){const a=this.text.match(/^\s*/),u=a?a[0].length:0,m=this.text.match(/\S\s*$/),y=m?m[0].length-1:0;this.text=this.text.substring(u,this.text.length-y),this.sectionIndex=this.sectionIndex.slice(u,this.sectionIndex.length-y)}substring(a,u){const m=[...this.text].slice(a,u).join(""),y=this.sectionIndex.slice(a,u);return new Mm(m,this.sections,y)}toCodeUnitIndex(a){return[...this.text].slice(0,a).join("").length}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((a,u)=>Math.max(a,this.sections[u].scale)),0)}getMaxImageSize(a){let u=0,m=0;for(let y=0;y<this.length();y++){const T=this.getSection(y);if("imageName"in T){const M=a[T.imageName];if(!M)continue;const R=M.displaySize;u=Math.max(u,R[0]),m=Math.max(m,R[1])}}return{maxImageWidth:u,maxImageHeight:m}}addTextSection(a,u){this.text+=a.text,this.sections.push({scale:a.scale||1,verticalAlign:a.verticalAlign||"bottom",fontStack:a.fontStack||u});const m=this.sections.length-1;this.sectionIndex.push(...[...a.text].map((()=>m)))}addImageSection(a){const u=a.image?a.image.name:"";if(u.length===0)return void tt("Can't add FormattedSection with an empty image.");const m=this.getNextImageSectionCharCode();m?(this.text+=String.fromCharCode(m),this.sections.push({scale:1,verticalAlign:a.verticalAlign||"bottom",imageName:u}),this.sectionIndex.push(this.sections.length-1)):tt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}determineLineBreaks(a,u,m,y,T){const M=[],R=this.determineAverageLineWidth(a,u,m,y,T),F=this.hasZeroWidthSpaces();let $=0,H=0;const K=this.text[Symbol.iterator]();let ne=K.next();const se=this.text[Symbol.iterator]();se.next();let me=se.next();const ge=this.text[Symbol.iterator]();ge.next(),ge.next();let ve=ge.next();for(;!ne.done;){const Ae=this.getSection(H),He=ne.value.codePointAt(0);if(U0(He)||($+=iA(He,Ae,m,y,a,T)),!me.done){const Ie=Sf(He),Le=me.value.codePointAt(0);(V4[He]||Ie||"imageName"in Ae||!ve.done&&U4[Le])&&M.push(rA(H+1,$,R,M,j4(He,Le,Ie&&F),!1))}H++,ne=K.next(),me=se.next(),ve=ge.next()}return sA(rA(this.length(),$,R,M,0,!0))}determineAverageLineWidth(a,u,m,y,T){let M=0,R=0;for(const F of this.text){const $=this.getSection(R);M+=iA(F.codePointAt(0),$,m,y,a,T),R++}return M/Math.max(1,Math.ceil(M/u))}}const tS=4294967296,oA=1/tS,aA=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");class ab{constructor(a=new Uint8Array(16)){this.buf=ArrayBuffer.isView(a)?a:new Uint8Array(a),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(a,u,m=this.length){for(;this.pos<m;){const y=this.readVarint(),T=y>>3,M=this.pos;this.type=7&y,a(T,u,this),this.pos===M&&this.skip(y)}return u}readMessage(a,u){return this.readFields(a,u,this.readVarint()+this.pos)}readFixed32(){const a=this.dataView.getUint32(this.pos,!0);return this.pos+=4,a}readSFixed32(){const a=this.dataView.getInt32(this.pos,!0);return this.pos+=4,a}readFixed64(){const a=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*tS;return this.pos+=8,a}readSFixed64(){const a=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*tS;return this.pos+=8,a}readFloat(){const a=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,a}readDouble(){const a=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,a}readVarint(a){const u=this.buf;let m,y;return y=u[this.pos++],m=127&y,y<128?m:(y=u[this.pos++],m|=(127&y)<<7,y<128?m:(y=u[this.pos++],m|=(127&y)<<14,y<128?m:(y=u[this.pos++],m|=(127&y)<<21,y<128?m:(y=u[this.pos],m|=(15&y)<<28,(function(T,M,R){const F=R.buf;let $,H;if(H=F[R.pos++],$=(112&H)>>4,H<128||(H=F[R.pos++],$|=(127&H)<<3,H<128)||(H=F[R.pos++],$|=(127&H)<<10,H<128)||(H=F[R.pos++],$|=(127&H)<<17,H<128)||(H=F[R.pos++],$|=(127&H)<<24,H<128)||(H=F[R.pos++],$|=(1&H)<<31,H<128))return Cm(T,$,M);throw new Error("Expected varint not more than 10 bytes")})(m,a,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const a=this.readVarint();return a%2==1?(a+1)/-2:a/2}readBoolean(){return!!this.readVarint()}readString(){const a=this.readVarint()+this.pos,u=this.pos;return this.pos=a,a-u>=12&&aA?aA.decode(this.buf.subarray(u,a)):(function(m,y,T){let M="",R=y;for(;R<T;){const F=m[R];let $,H,K,ne=null,se=F>239?4:F>223?3:F>191?2:1;if(R+se>T)break;se===1?F<128&&(ne=F):se===2?($=m[R+1],(192&$)==128&&(ne=(31&F)<<6|63&$,ne<=127&&(ne=null))):se===3?($=m[R+1],H=m[R+2],(192&$)==128&&(192&H)==128&&(ne=(15&F)<<12|(63&$)<<6|63&H,(ne<=2047||ne>=55296&&ne<=57343)&&(ne=null))):se===4&&($=m[R+1],H=m[R+2],K=m[R+3],(192&$)==128&&(192&H)==128&&(192&K)==128&&(ne=(15&F)<<18|(63&$)<<12|(63&H)<<6|63&K,(ne<=65535||ne>=1114112)&&(ne=null))),ne===null?(ne=65533,se=1):ne>65535&&(ne-=65536,M+=String.fromCharCode(ne>>>10&1023|55296),ne=56320|1023&ne),M+=String.fromCharCode(ne),R+=se}return M})(this.buf,u,a)}readBytes(){const a=this.readVarint()+this.pos,u=this.buf.subarray(this.pos,a);return this.pos=a,u}readPackedVarint(a=[],u){const m=this.readPackedEnd();for(;this.pos<m;)a.push(this.readVarint(u));return a}readPackedSVarint(a=[]){const u=this.readPackedEnd();for(;this.pos<u;)a.push(this.readSVarint());return a}readPackedBoolean(a=[]){const u=this.readPackedEnd();for(;this.pos<u;)a.push(this.readBoolean());return a}readPackedFloat(a=[]){const u=this.readPackedEnd();for(;this.pos<u;)a.push(this.readFloat());return a}readPackedDouble(a=[]){const u=this.readPackedEnd();for(;this.pos<u;)a.push(this.readDouble());return a}readPackedFixed32(a=[]){const u=this.readPackedEnd();for(;this.pos<u;)a.push(this.readFixed32());return a}readPackedSFixed32(a=[]){const u=this.readPackedEnd();for(;this.pos<u;)a.push(this.readSFixed32());return a}readPackedFixed64(a=[]){const u=this.readPackedEnd();for(;this.pos<u;)a.push(this.readFixed64());return a}readPackedSFixed64(a=[]){const u=this.readPackedEnd();for(;this.pos<u;)a.push(this.readSFixed64());return a}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(a){const u=7&a;if(u===0)for(;this.buf[this.pos++]>127;);else if(u===2)this.pos=this.readVarint()+this.pos;else if(u===5)this.pos+=4;else{if(u!==1)throw new Error(`Unimplemented type: ${u}`);this.pos+=8}}writeTag(a,u){this.writeVarint(a<<3|u)}realloc(a){let u=this.length||16;for(;u<this.pos+a;)u*=2;if(u!==this.length){const m=new Uint8Array(u);m.set(this.buf),this.buf=m,this.dataView=new DataView(m.buffer),this.length=u}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(a){this.realloc(4),this.dataView.setInt32(this.pos,a,!0),this.pos+=4}writeSFixed32(a){this.realloc(4),this.dataView.setInt32(this.pos,a,!0),this.pos+=4}writeFixed64(a){this.realloc(8),this.dataView.setInt32(this.pos,-1&a,!0),this.dataView.setInt32(this.pos+4,Math.floor(a*oA),!0),this.pos+=8}writeSFixed64(a){this.realloc(8),this.dataView.setInt32(this.pos,-1&a,!0),this.dataView.setInt32(this.pos+4,Math.floor(a*oA),!0),this.pos+=8}writeVarint(a){(a=+a||0)>268435455||a<0?(function(u,m){let y,T;if(u>=0?(y=u%4294967296|0,T=u/4294967296|0):(y=~(-u%4294967296),T=~(-u/4294967296),4294967295^y?y=y+1|0:(y=0,T=T+1|0)),u>=18446744073709552e3||u<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");m.realloc(10),(function(M,R,F){F.buf[F.pos++]=127&M|128,M>>>=7,F.buf[F.pos++]=127&M|128,M>>>=7,F.buf[F.pos++]=127&M|128,M>>>=7,F.buf[F.pos++]=127&M|128,F.buf[F.pos]=127&(M>>>=7)})(y,0,m),(function(M,R){const F=(7&M)<<4;R.buf[R.pos++]|=F|((M>>>=3)?128:0),M&&(R.buf[R.pos++]=127&M|((M>>>=7)?128:0),M&&(R.buf[R.pos++]=127&M|((M>>>=7)?128:0),M&&(R.buf[R.pos++]=127&M|((M>>>=7)?128:0),M&&(R.buf[R.pos++]=127&M|((M>>>=7)?128:0),M&&(R.buf[R.pos++]=127&M)))))})(T,m)})(a,this):(this.realloc(4),this.buf[this.pos++]=127&a|(a>127?128:0),a<=127||(this.buf[this.pos++]=127&(a>>>=7)|(a>127?128:0),a<=127||(this.buf[this.pos++]=127&(a>>>=7)|(a>127?128:0),a<=127||(this.buf[this.pos++]=a>>>7&127))))}writeSVarint(a){this.writeVarint(a<0?2*-a-1:2*a)}writeBoolean(a){this.writeVarint(+a)}writeString(a){a=String(a),this.realloc(4*a.length),this.pos++;const u=this.pos;this.pos=(function(y,T,M){for(let R,F,$=0;$<T.length;$++){if(R=T.charCodeAt($),R>55295&&R<57344){if(!F){R>56319||$+1===T.length?(y[M++]=239,y[M++]=191,y[M++]=189):F=R;continue}if(R<56320){y[M++]=239,y[M++]=191,y[M++]=189,F=R;continue}R=F-55296<<10|R-56320|65536,F=null}else F&&(y[M++]=239,y[M++]=191,y[M++]=189,F=null);R<128?y[M++]=R:(R<2048?y[M++]=R>>6|192:(R<65536?y[M++]=R>>12|224:(y[M++]=R>>18|240,y[M++]=R>>12&63|128),y[M++]=R>>6&63|128),y[M++]=63&R|128)}return M})(this.buf,a,this.pos);const m=this.pos-u;m>=128&&lA(u,m,this),this.pos=u-1,this.writeVarint(m),this.pos+=m}writeFloat(a){this.realloc(4),this.dataView.setFloat32(this.pos,a,!0),this.pos+=4}writeDouble(a){this.realloc(8),this.dataView.setFloat64(this.pos,a,!0),this.pos+=8}writeBytes(a){const u=a.length;this.writeVarint(u),this.realloc(u);for(let m=0;m<u;m++)this.buf[this.pos++]=a[m]}writeRawMessage(a,u){this.pos++;const m=this.pos;a(u,this);const y=this.pos-m;y>=128&&lA(m,y,this),this.pos=m-1,this.writeVarint(y),this.pos+=y}writeMessage(a,u,m){this.writeTag(a,2),this.writeRawMessage(u,m)}writePackedVarint(a,u){u.length&&this.writeMessage(a,G4,u)}writePackedSVarint(a,u){u.length&&this.writeMessage(a,q4,u)}writePackedBoolean(a,u){u.length&&this.writeMessage(a,Z4,u)}writePackedFloat(a,u){u.length&&this.writeMessage(a,W4,u)}writePackedDouble(a,u){u.length&&this.writeMessage(a,H4,u)}writePackedFixed32(a,u){u.length&&this.writeMessage(a,X4,u)}writePackedSFixed32(a,u){u.length&&this.writeMessage(a,Y4,u)}writePackedFixed64(a,u){u.length&&this.writeMessage(a,K4,u)}writePackedSFixed64(a,u){u.length&&this.writeMessage(a,J4,u)}writeBytesField(a,u){this.writeTag(a,2),this.writeBytes(u)}writeFixed32Field(a,u){this.writeTag(a,5),this.writeFixed32(u)}writeSFixed32Field(a,u){this.writeTag(a,5),this.writeSFixed32(u)}writeFixed64Field(a,u){this.writeTag(a,1),this.writeFixed64(u)}writeSFixed64Field(a,u){this.writeTag(a,1),this.writeSFixed64(u)}writeVarintField(a,u){this.writeTag(a,0),this.writeVarint(u)}writeSVarintField(a,u){this.writeTag(a,0),this.writeSVarint(u)}writeStringField(a,u){this.writeTag(a,2),this.writeString(u)}writeFloatField(a,u){this.writeTag(a,5),this.writeFloat(u)}writeDoubleField(a,u){this.writeTag(a,1),this.writeDouble(u)}writeBooleanField(a,u){this.writeVarintField(a,+u)}}function Cm(h,a,u){return u?4294967296*a+(h>>>0):4294967296*(a>>>0)+(h>>>0)}function lA(h,a,u){const m=a<=16383?1:a<=2097151?2:a<=268435455?3:Math.floor(Math.log(a)/(7*Math.LN2));u.realloc(m);for(let y=u.pos-1;y>=h;y--)u.buf[y+m]=u.buf[y]}function G4(h,a){for(let u=0;u<h.length;u++)a.writeVarint(h[u])}function q4(h,a){for(let u=0;u<h.length;u++)a.writeSVarint(h[u])}function W4(h,a){for(let u=0;u<h.length;u++)a.writeFloat(h[u])}function H4(h,a){for(let u=0;u<h.length;u++)a.writeDouble(h[u])}function Z4(h,a){for(let u=0;u<h.length;u++)a.writeBoolean(h[u])}function X4(h,a){for(let u=0;u<h.length;u++)a.writeFixed32(h[u])}function Y4(h,a){for(let u=0;u<h.length;u++)a.writeSFixed32(h[u])}function K4(h,a){for(let u=0;u<h.length;u++)a.writeFixed64(h[u])}function J4(h,a){for(let u=0;u<h.length;u++)a.writeSFixed64(h[u])}function Q4(h,a,u){h===1&&u.readMessage(e$,a)}function e$(h,a,u){if(h===3){const{id:m,bitmap:y,width:T,height:M,left:R,top:F,advance:$}=u.readMessage(t$,{});a.push({id:m,bitmap:new Q_({width:T+6,height:M+6},y),metrics:{width:T,height:M,left:R,top:F,advance:$}})}}function t$(h,a,u){h===1?a.id=u.readVarint():h===2?a.bitmap=u.readBytes():h===3?a.width=u.readVarint():h===4?a.height=u.readVarint():h===5?a.left=u.readSVarint():h===6?a.top=u.readSVarint():h===7&&(a.advance=u.readVarint())}function cA(h){let a=0,u=0;for(const M of h)a+=M.w*M.h,u=Math.max(u,M.w);h.sort(((M,R)=>R.h-M.h));const m=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(a/.95)),u),h:1/0}];let y=0,T=0;for(const M of h)for(let R=m.length-1;R>=0;R--){const F=m[R];if(!(M.w>F.w||M.h>F.h)){if(M.x=F.x,M.y=F.y,T=Math.max(T,M.y+M.h),y=Math.max(y,M.x+M.w),M.w===F.w&&M.h===F.h){const $=m.pop();$&&R<m.length&&(m[R]=$)}else M.h===F.h?(F.x+=M.w,F.w-=M.w):M.w===F.w?(F.y+=M.h,F.h-=M.h):(m.push({x:F.x+M.w,y:F.y,w:F.w-M.w,h:M.h}),F.y+=M.h,F.h-=M.h);break}}return{w:y,h:T,fill:a/(y*T)||0}}class iS{constructor(a,{pixelRatio:u,version:m,stretchX:y,stretchY:T,content:M,textFitWidth:R,textFitHeight:F}){this.paddedRect=a,this.pixelRatio=u,this.stretchX=y,this.stretchY=T,this.content=M,this.version=m,this.textFitWidth=R,this.textFitHeight=F}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class uA{constructor(a,u){const m={},y={};this.haveRenderCallbacks=[];const T=[];this.addImages(a,m,T),this.addImages(u,y,T);const{w:M,h:R}=cA(T),F=new Xo({width:M||1,height:R||1});for(const $ in a){const H=a[$],K=m[$].paddedRect;Xo.copy(H.data,F,{x:0,y:0},{x:K.x+1,y:K.y+1},H.data)}for(const $ in u){const H=u[$],K=y[$].paddedRect,ne=K.x+1,se=K.y+1,me=H.data.width,ge=H.data.height;Xo.copy(H.data,F,{x:0,y:0},{x:ne,y:se},H.data),Xo.copy(H.data,F,{x:0,y:ge-1},{x:ne,y:se-1},{width:me,height:1}),Xo.copy(H.data,F,{x:0,y:0},{x:ne,y:se+ge},{width:me,height:1}),Xo.copy(H.data,F,{x:me-1,y:0},{x:ne-1,y:se},{width:1,height:ge}),Xo.copy(H.data,F,{x:0,y:0},{x:ne+me,y:se},{width:1,height:ge})}this.image=F,this.iconPositions=m,this.patternPositions=y}addImages(a,u,m){for(const y in a){const T=a[y],M={x:0,y:0,w:T.data.width+2,h:T.data.height+2};m.push(M),u[y]=new iS(M,T),T.hasRenderCallback&&this.haveRenderCallbacks.push(y)}}patchUpdatedImages(a,u){a.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const m in a.updatedImages)this.patchUpdatedImage(this.iconPositions[m],a.getImage(m),u),this.patchUpdatedImage(this.patternPositions[m],a.getImage(m),u)}patchUpdatedImage(a,u,m){if(!a||!u||a.version===u.version)return;a.version=u.version;const[y,T]=a.tl;m.update(u.data,void 0,{x:y,y:T})}}var nd;function lb(h,a,u,m,y,T,M,R,F,$,H,K,ne,se,me){const ge=Mm.fromFeature(h,y);let ve;K===c.az.vertical&&ge.verticalizePunctuation();let Ae=ge.determineLineBreaks($,T,a,m,se);const{processBidirectionalText:He,processStyledBidirectionalText:Ie}=Hc;if(He&&ge.sections.length===1){ve=[],Ae=Ae.map((Ct=>ge.toCodeUnitIndex(Ct)));const nt=He(ge.toString(),Ae);for(const Ct of nt){const Ut=[...Ct].map((()=>0));ve.push(new Mm(Ct,ge.sections,Ut))}}else if(Ie){ve=[],Ae=Ae.map((Bt=>ge.toCodeUnitIndex(Bt)));let nt=0;const Ct=[];for(const Bt of ge.text)Ct.push(...Array(Bt.length).fill(ge.sectionIndex[nt])),nt++;const Ut=Ie(ge.text,Ct,Ae);for(const Bt of Ut){const Zt=[];let ni="";for(const Yt of Bt[0])Zt.push(Bt[1][ni.length]),ni+=Yt;ve.push(new Mm(Bt[0],ge.sections,Zt))}}else ve=(function(nt,Ct){const Ut=[];let Bt=0;for(const Zt of Ct)Ut.push(nt.substring(Bt,Zt)),Bt=Zt;return Bt<nt.length()&&Ut.push(nt.substring(Bt,nt.length())),Ut})(ge,Ae);const Le=[],Ke={positionedLines:Le,text:ge.toString(),top:H[1],bottom:H[1],left:H[0],right:H[0],writingMode:K,iconsInText:!1,verticalizable:!1};return(function(nt,Ct,Ut,Bt,Zt,ni,Yt,$t,Rt,fi,hi,vi){let ui=0,Ei=0,Tn=0,dn=0;const Sr=$t==="right"?1:$t==="left"?0:.5,to=As/vi;let ps=0;for(const In of Zt){In.trim();const Nr=In.getMaxScale(),Yr={positionedGlyphs:[],lineOffset:0};nt.positionedLines[ps]=Yr;const ar=Yr.positionedGlyphs;let Yo=0;if(!In.length()){Ei+=ni,++ps;continue}const io=i$(Bt,In,to);let Ko=0;for(const Rs of In.text){const Rr=In.getSection(Ko),ms=Rs.codePointAt(0),$r=n$(Rt,hi,ms),Ls={glyph:ms,imageName:null,x:ui,y:Ei+-17,vertical:$r,scale:1,fontStack:"",sectionIndex:In.getSectionIndex(Ko),metrics:null,rect:null};let Ju;if("fontStack"in Rr){if(Ju=r$(Rr,ms,$r,io,Ct,Ut),!Ju)continue;Ls.fontStack=Rr.fontStack}else{if(nt.iconsInText=!0,Rr.scale*=to,Ju=s$(Rr,$r,Nr,io,Bt),!Ju)continue;Yo=Math.max(Yo,Ju.imageOffset),Ls.imageName=Rr.imageName}const{rect:hc,metrics:gv,baselineOffset:ld}=Ju;Ls.y+=ld,Ls.scale=Rr.scale,Ls.metrics=gv,Ls.rect=hc,ar.push(Ls),$r?(nt.verticalizable=!0,ui+=("imageName"in Rr?gv.advance:As)*Rr.scale+fi):ui+=gv.advance*Rr.scale+fi,Ko++}ar.length!==0&&(Tn=Math.max(ui-fi,Tn),o$(ar,0,ar.length-1,Sr)),ui=0,Yr.lineOffset=Math.max(Yo,(Nr-1)*As);const Ml=ni*Nr+Yo;Ei+=Ml,dn=Math.max(Ml,dn),++ps}const{horizontalAlign:Tr,verticalAlign:gr}=nS(Yt);(function(In,Nr,Yr,ar,Yo,io,Ko,Ml,Rs){const Rr=(Nr-Yr)*Yo;let ms=0;ms=io!==Ko?-Ml*ar- -17:-ar*Rs*Ko+.5*Ko;for(const $r of In)for(const Ls of $r.positionedGlyphs)Ls.x+=Rr,Ls.y+=ms})(nt.positionedLines,Sr,Tr,gr,Tn,dn,ni,Ei,Zt.length),nt.top+=-gr*Ei,nt.bottom=nt.top+Ei,nt.left+=-Tr*Tn,nt.right=nt.left+Tn})(Ke,a,u,m,ve,M,R,F,K,$,ne,me),!(function(nt){for(const Ct of nt)if(Ct.positionedGlyphs.length!==0)return!1;return!0})(Le)&&Ke}function nS(h){let a=.5,u=.5;switch(h){case"right":case"top-right":case"bottom-right":a=1;break;case"left":case"top-left":case"bottom-left":a=0}switch(h){case"bottom":case"bottom-right":case"bottom-left":u=1;break;case"top":case"top-right":case"top-left":u=0}return{horizontalAlign:a,verticalAlign:u}}function i$(h,a,u){const m=a.getMaxScale()*As,{maxImageWidth:y,maxImageHeight:T}=a.getMaxImageSize(h),M=Math.max(m,T*u);return{verticalLineContentWidth:Math.max(m,y*u),horizontalLineContentHeight:M}}function hA(h){switch(h){case"top":return 0;case"center":return .5;default:return 1}}function n$(h,a,u){return!(h===c.az.horizontal||!a&&!B_(u)||a&&(U0(u)||(m=u,new RegExp("\\p{sc=Arab}","u").test(String.fromCodePoint(m)))));var m}function r$(h,a,u,m,y,T){const M=T[h.fontStack],R=(function($,H,K,ne){if($&&$.rect)return $;const se=H[K.fontStack],me=se&&se[ne];return me?{rect:null,metrics:me.metrics}:null})(M&&M[a],y,h,a);if(R===null)return null;let F;if(u)F=m.verticalLineContentWidth-h.scale*As;else{const $=hA(h.verticalAlign);F=(m.horizontalLineContentHeight-h.scale*As)*$}return{rect:R.rect,metrics:R.metrics,baselineOffset:F}}function s$(h,a,u,m,y){const T=y[h.imageName];if(!T)return null;const M=T.paddedRect,R=T.displaySize,F={width:R[0],height:R[1],left:1,top:-3,advance:a?R[1]:R[0]};let $;if(a)$=m.verticalLineContentWidth-R[1]*h.scale;else{const H=hA(h.verticalAlign);$=(m.horizontalLineContentHeight-R[1]*h.scale)*H}return{rect:M,metrics:F,baselineOffset:$,imageOffset:(a?R[0]:R[1])*h.scale-As*u}}function o$(h,a,u,m){if(m===0)return;const y=h[u],T=(h[u].x+y.metrics.advance*y.scale)*m;for(let M=a;M<=u;M++)h[M].x-=T}function a$(h,a,u){const{horizontalAlign:m,verticalAlign:y}=nS(u),T=a[0]-h.displaySize[0]*m,M=a[1]-h.displaySize[1]*y;return{image:h,top:M,bottom:M+h.displaySize[1],left:T,right:T+h.displaySize[0]}}function dA(h){var a,u;let m=h.left,y=h.top,T=h.right-m,M=h.bottom-y;const R=(a=h.image.textFitWidth)!==null&&a!==void 0?a:"stretchOrShrink",F=(u=h.image.textFitHeight)!==null&&u!==void 0?u:"stretchOrShrink",$=(h.image.content[2]-h.image.content[0])/(h.image.content[3]-h.image.content[1]);if(F==="proportional"){if(R==="stretchOnly"&&T/M<$||R==="proportional"){const H=Math.ceil(M*$);m*=H/T,T=H}}else if(R==="proportional"&&F==="stretchOnly"&&$!==0&&T/M>$){const H=Math.ceil(T/$);y*=H/M,M=H}return{x1:m,y1:y,x2:m+T,y2:y+M}}function fA(h,a,u,m,y,T){const M=h.image;let R;if(M.content){const ve=M.content,Ae=M.pixelRatio||1;R=[ve[0]/Ae,ve[1]/Ae,M.displaySize[0]-ve[2]/Ae,M.displaySize[1]-ve[3]/Ae]}const F=a.left*T,$=a.right*T;let H,K,ne,se;u==="width"||u==="both"?(se=y[0]+F-m[3],K=y[0]+$+m[1]):(se=y[0]+(F+$-M.displaySize[0])/2,K=se+M.displaySize[0]);const me=a.top*T,ge=a.bottom*T;return u==="height"||u==="both"?(H=y[1]+me-m[0],ne=y[1]+ge+m[2]):(H=y[1]+(me+ge-M.displaySize[1])/2,ne=H+M.displaySize[1]),{image:M,top:H,right:K,bottom:ne,left:se,collisionPadding:R}}mi("ImagePosition",iS),mi("ImageAtlas",uA),c.az=void 0,(nd=c.az||(c.az={}))[nd.none=0]="none",nd[nd.horizontal=1]="horizontal",nd[nd.vertical=2]="vertical",nd[nd.horizontalOnly=3]="horizontalOnly";const Yu=128,rd=32640;function pA(h,a){const{expression:u}=a;if(u.kind==="constant")return{kind:"constant",layoutSize:u.evaluate(new Wn(h+1))};if(u.kind==="source")return{kind:"source"};{const{zoomStops:m,interpolationType:y}=u;let T=0;for(;T<m.length&&m[T]<=h;)T++;T=Math.max(0,T-1);let M=T;for(;M<m.length&&m[M]<h+1;)M++;M=Math.min(m.length-1,M);const R=m[T],F=m[M];return u.kind==="composite"?{kind:"composite",minZoom:R,maxZoom:F,interpolationType:y}:{kind:"camera",minZoom:R,maxZoom:F,minSize:u.evaluate(new Wn(R)),maxSize:u.evaluate(new Wn(F)),interpolationType:y}}}function rS(h,a,u){let m="never";const y=h.get(a);return y?m=y:h.get(u)&&(m="always"),m}const l$=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function cb(h,a,u,m,y,T,M,R,F,$,H,K,ne){const se=R?Math.min(rd,Math.round(R[0])):0,me=R?Math.min(rd,Math.round(R[1])):0;h.emplaceBack(a,u,Math.round(32*m),Math.round(32*y),T,M,(se<<1)+(F?1:0),me,16*$,16*H,256*K,256*ne)}function sS(h,a,u){h.emplaceBack(a.x,a.y,u),h.emplaceBack(a.x,a.y,u),h.emplaceBack(a.x,a.y,u),h.emplaceBack(a.x,a.y,u)}function c$(h){for(const a of h.sections)if(q0(a.text))return!0;return!1}class oS{constructor(a){this.layoutVertexArray=new Qe,this.indexArray=new It,this.programConfigurations=a,this.segments=new oi,this.dynamicLayoutVertexArray=new _t,this.opacityVertexArray=new Dt,this.hasVisibleVertices=!1,this.placedSymbolArray=new k}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(a,u,m,y){this.isEmpty()||(m&&(this.layoutVertexBuffer=a.createVertexBuffer(this.layoutVertexArray,O4.members),this.indexBuffer=a.createIndexBuffer(this.indexArray,u),this.dynamicLayoutVertexBuffer=a.createVertexBuffer(this.dynamicLayoutVertexArray,z4.members,!0),this.opacityVertexBuffer=a.createVertexBuffer(this.opacityVertexArray,l$,!0),this.opacityVertexBuffer.itemSize=1),(m||y)&&this.programConfigurations.upload(a))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}mi("SymbolBuffers",oS);class aS{constructor(a,u,m){this.layoutVertexArray=new a,this.layoutAttributes=u,this.indexArray=new m,this.segments=new oi,this.collisionVertexArray=new Pt}upload(a){this.layoutVertexBuffer=a.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=a.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=a.createVertexBuffer(this.collisionVertexArray,B4.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}mi("CollisionBuffers",aS);class Em{constructor(a){this.collisionBoxArray=a.collisionBoxArray,this.zoom=a.zoom,this.overscaling=a.overscaling,this.layers=a.layers,this.layerIds=this.layers.map((M=>M.id)),this.index=a.index,this.pixelRatio=a.pixelRatio,this.sourceLayerIndex=a.sourceLayerIndex,this.hasDependencies=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const u=this.layers[0]._unevaluatedLayout._values;this.textSizeData=pA(this.zoom,u["text-size"]),this.iconSizeData=pA(this.zoom,u["icon-size"]);const m=this.layers[0].layout,y=m.get("symbol-sort-key"),T=m.get("symbol-z-order");this.canOverlap=rS(m,"text-overlap","text-allow-overlap")!=="never"||rS(m,"icon-overlap","icon-allow-overlap")!=="never"||m.get("text-ignore-placement")||m.get("icon-ignore-placement"),this.sortFeaturesByKey=T!=="viewport-y"&&!y.isConstant(),this.sortFeaturesByY=(T==="viewport-y"||T==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,m.get("symbol-placement")==="point"&&(this.writingModes=m.get("text-writing-mode").map((M=>c.az[M]))),this.stateDependentLayerIds=this.layers.filter((M=>M.isStateDependent())).map((M=>M.id)),this.sourceID=a.sourceID}createArrays(){this.text=new oS(new Xu(this.layers,this.zoom,(a=>/^text/.test(a)))),this.icon=new oS(new Xu(this.layers,this.zoom,(a=>/^icon/.test(a)))),this.glyphOffsetArray=new Z,this.lineVertexArray=new J,this.symbolInstances=new W,this.textAnchorOffsets=new le}calculateGlyphDependencies(a,u,m,y,T){for(const M of a)if(u[M.codePointAt(0)]=!0,(m||y)&&T){const R=cv[M];R&&(u[R.codePointAt(0)]=!0)}}populate(a,u,m){const y=this.layers[0],T=y.layout,M=T.get("text-font"),R=T.get("text-field"),F=T.get("icon-image"),$=(R.value.kind!=="constant"||R.value.value instanceof Ns&&!R.value.value.isEmpty()||R.value.value.toString().length>0)&&(M.value.kind!=="constant"||M.value.value.length>0),H=F.value.kind!=="constant"||!!F.value.value||Object.keys(F.parameters).length>0,K=T.get("symbol-sort-key");if(this.features=[],!$&&!H)return;const ne=u.iconDependencies,se=u.glyphDependencies,me=u.availableImages,ge=new Wn(this.zoom);for(const{feature:ve,id:Ae,index:He,sourceLayerIndex:Ie}of a){const Le=y._featureFilter.needGeometry,Ke=Kc(ve,Le);if(!y._featureFilter.filter(ge,Ke,m))continue;let nt,Ct;if(Le||(Ke.geometry=Yc(ve)),$){const Bt=y.getValueAndResolveTokens("text-field",Ke,m,me),Zt=Ns.factory(Bt),ni=this.hasRTLText=this.hasRTLText||c$(Zt);(!ni||Hc.getRTLTextPluginStatus()==="unavailable"||ni&&Hc.isParsed())&&(nt=$4(Zt,y,Ke))}if(H){const Bt=y.getValueAndResolveTokens("icon-image",Ke,m,me);Ct=Bt instanceof ao?Bt:ao.fromString(Bt)}if(!nt&&!Ct)continue;const Ut=this.sortFeaturesByKey?K.evaluate(Ke,{},m):void 0;if(this.features.push({id:Ae,text:nt,icon:Ct,index:He,sourceLayerIndex:Ie,geometry:Ke.geometry,properties:ve.properties,type:ov.types[ve.type],sortKey:Ut}),Ct&&(ne[Ct.name]=!0),nt){const Bt=M.evaluate(Ke,{},m).join(","),Zt=T.get("text-rotation-alignment")!=="viewport"&&T.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(c.az.vertical)>=0;for(const ni of nt.sections)if(ni.image)ne[ni.image.name]=!0;else{const Yt=td(nt.toString()),$t=ni.fontStack||Bt,Rt=se[$t]=se[$t]||{};this.calculateGlyphDependencies(ni.text,Rt,Zt,this.allowVerticalPlacement,Yt)}}}T.get("symbol-placement")==="line"&&(this.features=(function(ve){const Ae={},He={},Ie=[];let Le=0;function Ke(Bt){Ie.push(ve[Bt]),Le++}function nt(Bt,Zt,ni){const Yt=He[Bt];return delete He[Bt],He[Zt]=Yt,Ie[Yt].geometry[0].pop(),Ie[Yt].geometry[0]=Ie[Yt].geometry[0].concat(ni[0]),Yt}function Ct(Bt,Zt,ni){const Yt=Ae[Zt];return delete Ae[Zt],Ae[Bt]=Yt,Ie[Yt].geometry[0].shift(),Ie[Yt].geometry[0]=ni[0].concat(Ie[Yt].geometry[0]),Yt}function Ut(Bt,Zt,ni){const Yt=ni?Zt[0][Zt[0].length-1]:Zt[0][0];return`${Bt}:${Yt.x}:${Yt.y}`}for(let Bt=0;Bt<ve.length;Bt++){const Zt=ve[Bt],ni=Zt.geometry,Yt=Zt.text?Zt.text.toString():null;if(!Yt){Ke(Bt);continue}const $t=Ut(Yt,ni),Rt=Ut(Yt,ni,!0);if($t in He&&Rt in Ae&&He[$t]!==Ae[Rt]){const fi=Ct($t,Rt,ni),hi=nt($t,Rt,Ie[fi].geometry);delete Ae[$t],delete He[Rt],He[Ut(Yt,Ie[hi].geometry,!0)]=hi,Ie[fi].geometry=null}else $t in He?nt($t,Rt,ni):Rt in Ae?Ct($t,Rt,ni):(Ke(Bt),Ae[$t]=Le-1,He[Rt]=Le-1)}return Ie.filter((Bt=>Bt.geometry))})(this.features)),this.sortFeaturesByKey&&this.features.sort(((ve,Ae)=>ve.sortKey-Ae.sortKey))}update(a,u,m){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(a,u,this.layers,{imagePositions:m}),this.icon.programConfigurations.updatePaintArrays(a,u,this.layers,{imagePositions:m}))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(a){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(a),this.iconCollisionBox.upload(a)),this.text.upload(a,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(a,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(a,u){const m=this.lineVertexArray.length;if(a.segment!==void 0){let y=a.dist(u[a.segment+1]),T=a.dist(u[a.segment]);const M={};for(let R=a.segment+1;R<u.length;R++)M[R]={x:u[R].x,y:u[R].y,tileUnitDistanceFromAnchor:y},R<u.length-1&&(y+=u[R+1].dist(u[R]));for(let R=a.segment||0;R>=0;R--)M[R]={x:u[R].x,y:u[R].y,tileUnitDistanceFromAnchor:T},R>0&&(T+=u[R-1].dist(u[R]));for(let R=0;R<u.length;R++){const F=M[R];this.lineVertexArray.emplaceBack(F.x,F.y,F.tileUnitDistanceFromAnchor)}}return{lineStartIndex:m,lineLength:this.lineVertexArray.length-m}}addSymbols(a,u,m,y,T,M,R,F,$,H,K,ne){const se=a.indexArray,me=a.layoutVertexArray,ge=a.segments.prepareSegment(4*u.length,me,se,this.canOverlap?M.sortKey:void 0),ve=this.glyphOffsetArray.length,Ae=ge.vertexLength,He=this.allowVerticalPlacement&&R===c.az.vertical?Math.PI/2:0,Ie=M.text&&M.text.sections;for(let Le=0;Le<u.length;Le++){const{tl:Ke,tr:nt,bl:Ct,br:Ut,tex:Bt,pixelOffsetTL:Zt,pixelOffsetBR:ni,minFontScaleX:Yt,minFontScaleY:$t,glyphOffset:Rt,isSDF:fi,sectionIndex:hi}=u[Le],vi=ge.vertexLength,ui=Rt[1];cb(me,F.x,F.y,Ke.x,ui+Ke.y,Bt.x,Bt.y,m,fi,Zt.x,Zt.y,Yt,$t),cb(me,F.x,F.y,nt.x,ui+nt.y,Bt.x+Bt.w,Bt.y,m,fi,ni.x,Zt.y,Yt,$t),cb(me,F.x,F.y,Ct.x,ui+Ct.y,Bt.x,Bt.y+Bt.h,m,fi,Zt.x,ni.y,Yt,$t),cb(me,F.x,F.y,Ut.x,ui+Ut.y,Bt.x+Bt.w,Bt.y+Bt.h,m,fi,ni.x,ni.y,Yt,$t),sS(a.dynamicLayoutVertexArray,F,He),se.emplaceBack(vi,vi+2,vi+1),se.emplaceBack(vi+1,vi+2,vi+3),ge.vertexLength+=4,ge.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Rt[0]),Le!==u.length-1&&hi===u[Le+1].sectionIndex||a.programConfigurations.populatePaintArrays(me.length,M,M.index,{imagePositions:{},canonical:ne,formattedSection:Ie&&Ie[hi]})}a.placedSymbolArray.emplaceBack(F.x,F.y,ve,this.glyphOffsetArray.length-ve,Ae,$,H,F.segment,m?m[0]:0,m?m[1]:0,y[0],y[1],R,0,!1,0,K)}_addCollisionDebugVertex(a,u,m,y,T,M){return u.emplaceBack(0,0),a.emplaceBack(m.x,m.y,y,T,Math.round(M.x),Math.round(M.y))}addCollisionDebugVertices(a,u,m,y,T,M,R){const F=T.segments.prepareSegment(4,T.layoutVertexArray,T.indexArray),$=F.vertexLength,H=T.layoutVertexArray,K=T.collisionVertexArray,ne=R.anchorX,se=R.anchorY;this._addCollisionDebugVertex(H,K,M,ne,se,new d(a,u)),this._addCollisionDebugVertex(H,K,M,ne,se,new d(m,u)),this._addCollisionDebugVertex(H,K,M,ne,se,new d(m,y)),this._addCollisionDebugVertex(H,K,M,ne,se,new d(a,y)),F.vertexLength+=4;const me=T.indexArray;me.emplaceBack($,$+1),me.emplaceBack($+1,$+2),me.emplaceBack($+2,$+3),me.emplaceBack($+3,$),F.primitiveLength+=4}addDebugCollisionBoxes(a,u,m,y){for(let T=a;T<u;T++){const M=this.collisionBoxArray.get(T);this.addCollisionDebugVertices(M.x1,M.y1,M.x2,M.y2,y?this.textCollisionBox:this.iconCollisionBox,M.anchorPoint,m)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new aS(At,tA.members,Qt),this.iconCollisionBox=new aS(At,tA.members,Qt);for(let a=0;a<this.symbolInstances.length;a++){const u=this.symbolInstances.get(a);this.addDebugCollisionBoxes(u.textBoxStartIndex,u.textBoxEndIndex,u,!0),this.addDebugCollisionBoxes(u.verticalTextBoxStartIndex,u.verticalTextBoxEndIndex,u,!0),this.addDebugCollisionBoxes(u.iconBoxStartIndex,u.iconBoxEndIndex,u,!1),this.addDebugCollisionBoxes(u.verticalIconBoxStartIndex,u.verticalIconBoxEndIndex,u,!1)}}_deserializeCollisionBoxesForSymbol(a,u,m,y,T,M,R,F,$){const H={};for(let K=u;K<m;K++){const ne=a.get(K);H.textBox={x1:ne.x1,y1:ne.y1,x2:ne.x2,y2:ne.y2,anchorPointX:ne.anchorPointX,anchorPointY:ne.anchorPointY},H.textFeatureIndex=ne.featureIndex;break}for(let K=y;K<T;K++){const ne=a.get(K);H.verticalTextBox={x1:ne.x1,y1:ne.y1,x2:ne.x2,y2:ne.y2,anchorPointX:ne.anchorPointX,anchorPointY:ne.anchorPointY},H.verticalTextFeatureIndex=ne.featureIndex;break}for(let K=M;K<R;K++){const ne=a.get(K);H.iconBox={x1:ne.x1,y1:ne.y1,x2:ne.x2,y2:ne.y2,anchorPointX:ne.anchorPointX,anchorPointY:ne.anchorPointY},H.iconFeatureIndex=ne.featureIndex;break}for(let K=F;K<$;K++){const ne=a.get(K);H.verticalIconBox={x1:ne.x1,y1:ne.y1,x2:ne.x2,y2:ne.y2,anchorPointX:ne.anchorPointX,anchorPointY:ne.anchorPointY},H.verticalIconFeatureIndex=ne.featureIndex;break}return H}deserializeCollisionBoxes(a){this.collisionArrays=[];for(let u=0;u<this.symbolInstances.length;u++){const m=this.symbolInstances.get(u);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(a,m.textBoxStartIndex,m.textBoxEndIndex,m.verticalTextBoxStartIndex,m.verticalTextBoxEndIndex,m.iconBoxStartIndex,m.iconBoxEndIndex,m.verticalIconBoxStartIndex,m.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(a,u){const m=a.placedSymbolArray.get(u),y=m.vertexStartIndex+4*m.numGlyphs;for(let T=m.vertexStartIndex;T<y;T+=4)a.indexArray.emplaceBack(T,T+2,T+1),a.indexArray.emplaceBack(T+1,T+2,T+3)}getSortedSymbolIndexes(a){if(this.sortedAngle===a&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const u=Math.sin(a),m=Math.cos(a),y=[],T=[],M=[];for(let R=0;R<this.symbolInstances.length;++R){M.push(R);const F=this.symbolInstances.get(R);y.push(0|Math.round(u*F.anchorX+m*F.anchorY)),T.push(F.featureIndex)}return M.sort(((R,F)=>y[R]-y[F]||T[F]-T[R])),M}addToSortKeyRanges(a,u){const m=this.sortKeyRanges[this.sortKeyRanges.length-1];m&&m.sortKey===u?m.symbolInstanceEnd=a+1:this.sortKeyRanges.push({sortKey:u,symbolInstanceStart:a,symbolInstanceEnd:a+1})}sortFeatures(a){if(this.sortFeaturesByY&&this.sortedAngle!==a&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(a),this.sortedAngle=a,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const u of this.symbolInstanceIndexes){const m=this.symbolInstances.get(u);this.featureSortOrder.push(m.featureIndex),[m.rightJustifiedTextSymbolIndex,m.centerJustifiedTextSymbolIndex,m.leftJustifiedTextSymbolIndex].forEach(((y,T,M)=>{y>=0&&M.indexOf(y)===T&&this.addIndicesForPlacedSymbol(this.text,y)})),m.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,m.verticalPlacedTextSymbolIndex),m.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,m.placedIconSymbolIndex),m.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,m.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let mA,gA;mi("SymbolBucket",Em,{omit:["layers","collisionBoxArray","features","compareText"]}),Em.MAX_GLYPHS=65535,Em.addDynamicAttributes=sS;var lS={get paint(){return gA=gA||new co({"icon-opacity":new Oi(Tt.paint_symbol["icon-opacity"]),"icon-color":new Oi(Tt.paint_symbol["icon-color"]),"icon-halo-color":new Oi(Tt.paint_symbol["icon-halo-color"]),"icon-halo-width":new Oi(Tt.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Oi(Tt.paint_symbol["icon-halo-blur"]),"icon-translate":new Mi(Tt.paint_symbol["icon-translate"]),"icon-translate-anchor":new Mi(Tt.paint_symbol["icon-translate-anchor"]),"text-opacity":new Oi(Tt.paint_symbol["text-opacity"]),"text-color":new Oi(Tt.paint_symbol["text-color"],{runtimeType:Wi,getOverride:h=>h.textColor,hasOverride:h=>!!h.textColor}),"text-halo-color":new Oi(Tt.paint_symbol["text-halo-color"]),"text-halo-width":new Oi(Tt.paint_symbol["text-halo-width"]),"text-halo-blur":new Oi(Tt.paint_symbol["text-halo-blur"]),"text-translate":new Mi(Tt.paint_symbol["text-translate"]),"text-translate-anchor":new Mi(Tt.paint_symbol["text-translate-anchor"])})},get layout(){return mA=mA||new co({"symbol-placement":new Mi(Tt.layout_symbol["symbol-placement"]),"symbol-spacing":new Mi(Tt.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Mi(Tt.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Oi(Tt.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Mi(Tt.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Mi(Tt.layout_symbol["icon-allow-overlap"]),"icon-overlap":new Mi(Tt.layout_symbol["icon-overlap"]),"icon-ignore-placement":new Mi(Tt.layout_symbol["icon-ignore-placement"]),"icon-optional":new Mi(Tt.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Mi(Tt.layout_symbol["icon-rotation-alignment"]),"icon-size":new Oi(Tt.layout_symbol["icon-size"]),"icon-text-fit":new Mi(Tt.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Mi(Tt.layout_symbol["icon-text-fit-padding"]),"icon-image":new Oi(Tt.layout_symbol["icon-image"]),"icon-rotate":new Oi(Tt.layout_symbol["icon-rotate"]),"icon-padding":new Oi(Tt.layout_symbol["icon-padding"]),"icon-keep-upright":new Mi(Tt.layout_symbol["icon-keep-upright"]),"icon-offset":new Oi(Tt.layout_symbol["icon-offset"]),"icon-anchor":new Oi(Tt.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Mi(Tt.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Mi(Tt.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Mi(Tt.layout_symbol["text-rotation-alignment"]),"text-field":new Oi(Tt.layout_symbol["text-field"]),"text-font":new Oi(Tt.layout_symbol["text-font"]),"text-size":new Oi(Tt.layout_symbol["text-size"]),"text-max-width":new Oi(Tt.layout_symbol["text-max-width"]),"text-line-height":new Mi(Tt.layout_symbol["text-line-height"]),"text-letter-spacing":new Oi(Tt.layout_symbol["text-letter-spacing"]),"text-justify":new Oi(Tt.layout_symbol["text-justify"]),"text-radial-offset":new Oi(Tt.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Mi(Tt.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new Oi(Tt.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new Oi(Tt.layout_symbol["text-anchor"]),"text-max-angle":new Mi(Tt.layout_symbol["text-max-angle"]),"text-writing-mode":new Mi(Tt.layout_symbol["text-writing-mode"]),"text-rotate":new Oi(Tt.layout_symbol["text-rotate"]),"text-padding":new Mi(Tt.layout_symbol["text-padding"]),"text-keep-upright":new Mi(Tt.layout_symbol["text-keep-upright"]),"text-transform":new Oi(Tt.layout_symbol["text-transform"]),"text-offset":new Oi(Tt.layout_symbol["text-offset"]),"text-allow-overlap":new Mi(Tt.layout_symbol["text-allow-overlap"]),"text-overlap":new Mi(Tt.layout_symbol["text-overlap"]),"text-ignore-placement":new Mi(Tt.layout_symbol["text-ignore-placement"]),"text-optional":new Mi(Tt.layout_symbol["text-optional"])})}};class _A{constructor(a){if(a.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=a.property.overrides?a.property.overrides.runtimeType:Ci,this.defaultValue=a}evaluate(a){if(a.formattedSection){const u=this.defaultValue.property.overrides;if(u&&u.hasOverride(a.formattedSection))return u.getOverride(a.formattedSection)}return a.feature&&a.featureState?this.defaultValue.evaluate(a.feature,a.featureState):this.defaultValue.property.specification.default}eachChild(a){this.defaultValue.isConstant()||a(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}mi("FormatSectionOverride",_A,{omit:["defaultValue"]});class ub extends fa{constructor(a,u){super(a,lS,u)}recalculate(a,u){if(super.recalculate(a,u),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const m=this.layout.get("text-writing-mode");if(m){const y=[];for(const T of m)y.indexOf(T)<0&&y.push(T);this.layout._values["text-writing-mode"]=y}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(a,u,m,y){const T=this.layout.get(a).evaluate(u,{},m,y),M=this._unevaluatedLayout._values[a];return M.isDataDriven()||Uc(M.value)||!T?T:(function(R,F){return F.replace(/{([^{}]+)}/g,(($,H)=>R&&H in R?String(R[H]):""))})(u.properties,T)}createBucket(a){return new Em(a)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const a of lS.paint.overridableProperties){if(!ub.hasPaintOverride(this.layout,a))continue;const u=this.paint.get(a),m=new _A(u),y=new Oa(m,u.property.specification);let T=null;T=u.value.kind==="constant"||u.value.kind==="source"?new Jp("source",y):new E_("composite",y,u.value.zoomStops),this.paint._values[a]=new $a(u.property,T,u.parameters)}}_handleOverridablePaintPropertyUpdate(a,u,m){return!(!this.layout||u.isDataDriven()||m.isDataDriven())&&ub.hasPaintOverride(this.layout,a)}static hasPaintOverride(a,u){const m=a.get("text-field"),y=lS.paint.properties[u];let T=!1;const M=R=>{for(const F of R)if(y.overrides&&y.overrides.hasOverride(F))return void(T=!0)};if(m.value.kind==="constant"&&m.value.value instanceof Ns)M(m.value.value.sections);else if(m.value.kind==="source"||m.value.kind==="composite"){const R=$=>{T||($ instanceof Uo&&Pr($.value)===Jn?M($.value.sections):$ instanceof Pa?M($.sections):$.eachChild(R))},F=m.value;F._styleExpression&&R(F._styleExpression.expression)}return T}}let vA;var u$={get paint(){return vA=vA||new co({"background-color":new Mi(Tt.paint_background["background-color"]),"background-pattern":new um(Tt.paint_background["background-pattern"]),"background-opacity":new Mi(Tt.paint_background["background-opacity"])})}};class h$ extends fa{constructor(a,u){super(a,u$,u)}}class d$ extends fa{constructor(a,u){super(a,{},u),this.onAdd=m=>{this.implementation.onAdd&&this.implementation.onAdd(m,m.painter.context.gl)},this.onRemove=m=>{this.implementation.onRemove&&this.implementation.onRemove(m,m.painter.context.gl)},this.implementation=a}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class f${constructor(a){this._methodToThrottle=a,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._methodToThrottle()}),0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const p$={once:!0},cS=63710088e-1;class sd{constructor(a,u){if(isNaN(a)||isNaN(u))throw new Error(`Invalid LngLat object: (${a}, ${u})`);if(this.lng=+a,this.lat=+u,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new sd(Be(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(a){const u=Math.PI/180,m=this.lat*u,y=a.lat*u,T=Math.sin(m)*Math.sin(y)+Math.cos(m)*Math.cos(y)*Math.cos((a.lng-this.lng)*u);return cS*Math.acos(Math.min(T,1))}static convert(a){if(a instanceof sd)return a;if(Array.isArray(a)&&(a.length===2||a.length===3))return new sd(Number(a[0]),Number(a[1]));if(!Array.isArray(a)&&typeof a=="object"&&a!==null)return new sd(Number("lng"in a?a.lng:a.lon),Number(a.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const yA=2*Math.PI*cS;function bA(h){return yA*Math.cos(h*Math.PI/180)}function xA(h){return(180+h)/360}function wA(h){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+h*Math.PI/360)))/360}function SA(h,a){return h/bA(a)}function TA(h){return 360*h-180}function hb(h){return 360/Math.PI*Math.atan(Math.exp((180-360*h)*Math.PI/180))-90}function MA(h,a){return h*bA(hb(a))}class uv{constructor(a,u,m=0){this.x=+a,this.y=+u,this.z=+m}static fromLngLat(a,u=0){const m=sd.convert(a);return new uv(xA(m.lng),wA(m.lat),SA(u,m.lat))}toLngLat(){return new sd(TA(this.x),hb(this.y))}toAltitude(){return MA(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/yA*(a=hb(this.y),1/Math.cos(a*Math.PI/180));var a}}function CA(h,a,u){var m=2*Math.PI*6378137/256/Math.pow(2,u);return[h*m-2*Math.PI*6378137/2,a*m-2*Math.PI*6378137/2]}class uS{constructor(a,u,m){if(!(function(y,T,M){return!(y<0||y>25||M<0||M>=Math.pow(2,y)||T<0||T>=Math.pow(2,y))})(a,u,m))throw new Error(`x=${u}, y=${m}, z=${a} outside of bounds. 0<=x<${Math.pow(2,a)}, 0<=y<${Math.pow(2,a)} 0<=z<=25 `);this.z=a,this.x=u,this.y=m,this.key=Am(0,a,a,u,m)}equals(a){return this.z===a.z&&this.x===a.x&&this.y===a.y}url(a,u,m){const y=(function(M,R,F){var $=CA(256*M,256*(R=Math.pow(2,F)-R-1),F),H=CA(256*(M+1),256*(R+1),F);return $[0]+","+$[1]+","+H[0]+","+H[1]})(this.x,this.y,this.z),T=(function(M,R,F){let $,H="";for(let K=M;K>0;K--)$=1<<K-1,H+=(R&$?1:0)+(F&$?2:0);return H})(this.z,this.x,this.y);return a[(this.x+this.y)%a.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(m==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,u>1?"@2x":"").replace(/{quadkey}/g,T).replace(/{bbox-epsg-3857}/g,y)}isChildOf(a){const u=this.z-a.z;return u>0&&a.x===this.x>>u&&a.y===this.y>>u}getTilePoint(a){const u=Math.pow(2,this.z);return new d((a.x*u-this.x)*Pe,(a.y*u-this.y)*Pe)}toString(){return`${this.z}/${this.x}/${this.y}`}}class EA{constructor(a,u){this.wrap=a,this.canonical=u,this.key=Am(a,u.z,u.z,u.x,u.y)}}class ja{constructor(a,u,m,y,T){if(this.terrainRttPosMatrix32f=null,a<m)throw new Error(`overscaledZ should be >= z; overscaledZ = ${a}; z = ${m}`);this.overscaledZ=a,this.wrap=u,this.canonical=new uS(m,+y,+T),this.key=Am(u,a,m,y,T)}clone(){return new ja(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(a){return this.overscaledZ===a.overscaledZ&&this.wrap===a.wrap&&this.canonical.equals(a.canonical)}scaledTo(a){if(a>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${a}; overscaledZ = ${this.overscaledZ}`);const u=this.canonical.z-a;return a>this.canonical.z?new ja(a,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new ja(a,this.wrap,a,this.canonical.x>>u,this.canonical.y>>u)}isOverscaled(){return this.overscaledZ>this.canonical.z}calculateScaledKey(a,u){if(a>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${a}; overscaledZ = ${this.overscaledZ}`);const m=this.canonical.z-a;return a>this.canonical.z?Am(this.wrap*+u,a,this.canonical.z,this.canonical.x,this.canonical.y):Am(this.wrap*+u,a,a,this.canonical.x>>m,this.canonical.y>>m)}isChildOf(a){if(a.wrap!==this.wrap||this.overscaledZ-a.overscaledZ<=0)return!1;if(a.overscaledZ===0)return this.overscaledZ>0;const u=this.canonical.z-a.canonical.z;return!(u<0)&&a.canonical.x===this.canonical.x>>u&&a.canonical.y===this.canonical.y>>u}children(a){if(this.overscaledZ>=a)return[new ja(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const u=this.canonical.z+1,m=2*this.canonical.x,y=2*this.canonical.y;return[new ja(u,this.wrap,u,m,y),new ja(u,this.wrap,u,m+1,y),new ja(u,this.wrap,u,m,y+1),new ja(u,this.wrap,u,m+1,y+1)]}isLessThan(a){return this.wrap<a.wrap||!(this.wrap>a.wrap)&&(this.overscaledZ<a.overscaledZ||!(this.overscaledZ>a.overscaledZ)&&(this.canonical.x<a.canonical.x||!(this.canonical.x>a.canonical.x)&&this.canonical.y<a.canonical.y))}wrapped(){return new ja(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(a){return new ja(this.overscaledZ,a,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new EA(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(a){return this.canonical.getTilePoint(new uv(a.x-this.wrap,a.y))}}function Am(h,a,u,m,y){(h*=2)<0&&(h=-1*h-1);const T=1<<u;return(T*T*h+T*y+m).toString(36)+u.toString(36)+a.toString(36)}function hS(h,a){return a?h.properties[a]:h.id}function m$(h,a){const u={id:h.id};if(a.removeAllProperties&&(delete h.removeProperties,delete h.addOrUpdateProperties,delete a.removeProperties),a.removeProperties)for(const m of a.removeProperties){const y=h.addOrUpdateProperties.findIndex((T=>T.key===m));y>-1&&h.addOrUpdateProperties.splice(y,1)}return(h.removeAllProperties||a.removeAllProperties)&&(u.removeAllProperties=!0),(h.removeProperties||a.removeProperties)&&(u.removeProperties=[...h.removeProperties||[],...a.removeProperties||[]]),(h.addOrUpdateProperties||a.addOrUpdateProperties)&&(u.addOrUpdateProperties=[...h.addOrUpdateProperties||[],...a.addOrUpdateProperties||[]]),(h.newGeometry||a.newGeometry)&&(u.newGeometry=a.newGeometry||h.newGeometry),u}function AA(h){var a,u;if(!h)return{};const m={};return m.removeAll=h.removeAll,m.remove=new Set(h.remove||[]),m.add=new Map((a=h.add)===null||a===void 0?void 0:a.map((y=>[y.id,y]))),m.update=new Map((u=h.update)===null||u===void 0?void 0:u.map((y=>[y.id,y]))),m}mi("CanonicalTileID",uS),mi("OverscaledTileID",ja,{omit:["terrainRttPosMatrix32f"]});class Of{constructor(){this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0}extend(a){return this.minX=Math.min(this.minX,a.x),this.minY=Math.min(this.minY,a.y),this.maxX=Math.max(this.maxX,a.x),this.maxY=Math.max(this.maxY,a.y),this}expandBy(a){return this.minX-=a,this.minY-=a,this.maxX+=a,this.maxY+=a,(this.minX>this.maxX||this.minY>this.maxY)&&(this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0),this}shrinkBy(a){return this.expandBy(-a)}map(a){const u=new Of;return u.extend(a(new d(this.minX,this.minY))),u.extend(a(new d(this.maxX,this.minY))),u.extend(a(new d(this.minX,this.maxY))),u.extend(a(new d(this.maxX,this.maxY))),u}static fromPoints(a){const u=new Of;for(const m of a)u.extend(m);return u}contains(a){return a.x>=this.minX&&a.x<=this.maxX&&a.y>=this.minY&&a.y<=this.maxY}empty(){return this.minX>this.maxX}width(){return this.maxX-this.minX}height(){return this.maxY-this.minY}covers(a){return!this.empty()&&!a.empty()&&a.minX>=this.minX&&a.maxX<=this.maxX&&a.minY>=this.minY&&a.maxY<=this.maxY}intersects(a){return!this.empty()&&!a.empty()&&a.minX<=this.maxX&&a.maxX>=this.minX&&a.minY<=this.maxY&&a.maxY>=this.minY}}class PA{constructor(a){this._stringToNumber={},this._numberToString=[];for(let u=0;u<a.length;u++){const m=a[u];this._stringToNumber[m]=u,this._numberToString[u]=m}}encode(a){return this._stringToNumber[a]}decode(a){if(a>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${a} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[a]}}class IA{constructor(a,u,m,y,T){this.type="Feature",this._vectorTileFeature=a,this._x=m,this._y=y,this._z=u,this.properties=a.properties,this.id=T}projectPoint(a,u,m,y){return[360*(a.x+u)/y-180,360/Math.PI*Math.atan(Math.exp((1-2*(a.y+m)/y)*Math.PI))-90]}projectLine(a,u,m,y){return a.map((T=>this.projectPoint(T,u,m,y)))}get geometry(){if(this._geometry)return this._geometry;const a=this._vectorTileFeature,u=a.extent*Math.pow(2,this._z),m=a.extent*this._x,y=a.extent*this._y,T=a.loadGeometry();switch(a.type){case 1:{const M=[];for(const F of T)M.push(F[0]);const R=this.projectLine(M,m,y,u);this._geometry=M.length===1?{type:"Point",coordinates:R[0]}:{type:"MultiPoint",coordinates:R};break}case 2:{const M=T.map((R=>this.projectLine(R,m,y,u)));this._geometry=M.length===1?{type:"LineString",coordinates:M[0]}:{type:"MultiLineString",coordinates:M};break}case 3:{const M=qE(T),R=[];for(const F of M)R.push(F.map(($=>this.projectLine($,m,y,u))));this._geometry=R.length===1?{type:"Polygon",coordinates:R[0]}:{type:"MultiPolygon",coordinates:R};break}default:throw new Error(`unknown feature type: ${a.type}`)}return this._geometry}set geometry(a){this._geometry=a}toJSON(){const a={geometry:this.geometry};for(const u in this)u!=="_geometry"&&u!=="_vectorTileFeature"&&u!=="_x"&&u!=="_y"&&u!=="_z"&&(a[u]=this[u]);return a}}class Pm{_name;dataBuffer;nullabilityBuffer;_size;constructor(a,u,m){this._name=a,this.dataBuffer=u,typeof m=="number"?this._size=m:(this.nullabilityBuffer=m,this._size=m.size())}getValue(a){return this.nullabilityBuffer&&!this.nullabilityBuffer.get(a)?null:this.getValueFromBuffer(a)}has(a){return this.nullabilityBuffer&&this.nullabilityBuffer.get(a)||!this.nullabilityBuffer}get name(){return this._name}get size(){return this._size}}class db extends Pm{}class dS extends db{getValueFromBuffer(a){return this.dataBuffer[a]}}class fS extends db{getValueFromBuffer(a){return this.dataBuffer[a]}}class RA extends Pm{delta;constructor(a,u,m,y){super(a,u,y),this.delta=m}}class pS extends RA{constructor(a,u,m,y){super(a,Int32Array.of(u),m,y)}getValueFromBuffer(a){return this.dataBuffer[0]+a*this.delta}}class mS extends Pm{constructor(a,u,m){super(a,Int32Array.of(u),m)}getValueFromBuffer(a){return this.dataBuffer[0]}}class g${_name;_geometryVector;_idVector;_propertyVectors;_extent;propertyVectorsMap;constructor(a,u,m,y,T=4096){this._name=a,this._geometryVector=u,this._idVector=m,this._propertyVectors=y,this._extent=T}get name(){return this._name}get idVector(){return this._idVector}get geometryVector(){return this._geometryVector}get propertyVectors(){return this._propertyVectors}getPropertyVector(a){return this.propertyVectorsMap||(this.propertyVectorsMap=new Map(this._propertyVectors.map((u=>[u.name,u])))),this.propertyVectorsMap.get(a)}*[Symbol.iterator](){const a=this.geometryVector[Symbol.iterator]();let u=0;for(;u<this.numFeatures;){let m;this.idVector&&(m=this.containsMaxSaveIntegerValues(this.idVector)?Number(this.idVector.getValue(u)):this.idVector.getValue(u));const y=a?.next().value,T={};for(const M of this.propertyVectors){if(!M)continue;const R=M.name,F=M.getValue(u);F!==null&&(T[R]=F)}u++,yield{id:m,geometry:y,properties:T}}}get numFeatures(){return this.geometryVector.numGeometries}get extent(){return this._extent}getFeatures(){const a=[],u=this.geometryVector.getGeometries();for(let m=0;m<this.numFeatures;m++){let y;this.idVector&&(y=this.containsMaxSaveIntegerValues(this.idVector)?Number(this.idVector.getValue(m)):this.idVector.getValue(m));const T={coordinates:u[m],type:this.geometryVector.geometryType(m)},M={};for(const R of this.propertyVectors){if(!R)continue;const F=R.name,$=R.getValue(m);$!==null&&(M[F]=$)}a.push({id:y,geometry:T,properties:M})}return a}containsMaxSaveIntegerValues(a){return a instanceof dS||a instanceof mS&&a instanceof pS||a instanceof fS}}class _${value;constructor(a){this.value=a}get(){return this.value}set(a){this.value=a}increment(){return this.value++}add(a){this.value+=a}}var vn,Ku,Qs,cc,zf,ma,Ps,Is,LA,Ga;function js(h,a,u){const m=new Int32Array(u);let y=0,T=a.get();for(let M=0;M<m.length;M++){let R=h[T++],F=127&R;R<128||(R=h[T++],F|=(127&R)<<7,R<128||(R=h[T++],F|=(127&R)<<14,R<128||(R=h[T++],F|=(127&R)<<21,R<128||(R=h[T++],F|=(15&R)<<28)))),m[y++]=F}return a.set(T),m}function fb(h,a,u){const m=new BigInt64Array(u);for(let y=0;y<m.length;y++)m[y]=y$(h,a);return m}function v$(h,a){let u,m;return m=h[a.get()],a.increment(),u=127&m,m<128?u:(m=h[a.get()],a.increment(),u|=(127&m)<<7,m<128?u:(m=h[a.get()],a.increment(),u|=(127&m)<<14,m<128?u:(m=h[a.get()],a.increment(),u|=(127&m)<<21,m<128?u:(m=h[a.get()],u|=(15&m)<<28,(function(y,T,M){let R,F;if(F=T[M.get()],M.increment(),R=(112&F)>>4,F<128||(F=T[M.get()],M.increment(),R|=(127&F)<<3,F<128)||(F=T[M.get()],M.increment(),R|=(127&F)<<10,F<128)||(F=T[M.get()],M.increment(),R|=(127&F)<<17,F<128)||(F=T[M.get()],M.increment(),R|=(127&F)<<24,F<128)||(F=T[M.get()],M.increment(),R|=(1&F)<<31,F<128))return 4294967296*R+(y>>>0);throw new Error("Expected varint not more than 10 bytes")})(u,h,a)))))}function kA(h,a,u,m){throw new Error("FastPFor is not implemented yet.")}function Bf(h){return h>>>1^-(1&h)}function Im(h){return h>>1n^-(1n&h)}function y$(h,a){let u=0n,m=0,y=a.get();for(;y<h.length;){const T=h[y++];if(u|=BigInt(127&T)<<BigInt(m),!(128&T))break;if(m+=7,m>=64)throw new Error("Varint too long")}return a.set(y),u}function DA(h,a,u){const m=new Int32Array(u);let y=0;for(let T=0;T<a;T++){const M=h[T];m.fill(h[T+a],y,y+M),y+=M}return m}function FA(h,a,u){const m=new BigInt64Array(u);let y=0;for(let T=0;T<a;T++){const M=Number(h[T]);m.fill(h[T+a],y,y+M),y+=M}return m}function OA(h,a,u){const m=new Float64Array(u);let y=0;for(let T=0;T<a;T++){const M=h[T];m.fill(h[T+a],y,y+M),y+=M}return m}function gS(h){const a=h.length/4*4;let u=1;if(a>=4)for(let m=h[0];u<a-4;u+=4)m=h[u]+=m,m=h[u+1]+=m,m=h[u+2]+=m,m=h[u+3]+=m;for(;u!=h.length;)h[u]+=h[u-1],++u}function zA(h){h[0]=h[0]>>>1^-(1&h[0]),h[1]=h[1]>>>1^-(1&h[1]);const a=h.length/4*4;let u=2;if(a>=4)for(;u<a-4;u+=4){const m=h[u],y=h[u+1],T=h[u+2],M=h[u+3];h[u]=(m>>>1^-(1&m))+h[u-2],h[u+1]=(y>>>1^-(1&y))+h[u-1],h[u+2]=(T>>>1^-(1&T))+h[u],h[u+3]=(M>>>1^-(1&M))+h[u+1]}for(;u!=h.length;u+=2)h[u]=(h[u]>>>1^-(1&h[u]))+h[u-2],h[u+1]=(h[u+1]>>>1^-(1&h[u+1]))+h[u-1]}(function(h){h.NONE="NONE",h.DELTA="DELTA",h.COMPONENTWISE_DELTA="COMPONENTWISE_DELTA",h.RLE="RLE",h.MORTON="MORTON",h.PDE="PDE"})(vn||(vn={})),(function(h){h.NONE="NONE",h.FAST_PFOR="FAST_PFOR",h.VARINT="VARINT",h.ALP="ALP"})(Ku||(Ku={})),(function(h){h.PRESENT="PRESENT",h.DATA="DATA",h.OFFSET="OFFSET",h.LENGTH="LENGTH"})(Qs||(Qs={}));class _S{_dictionaryType;_offsetType;_lengthType;constructor(a,u,m){this._dictionaryType=a,this._offsetType=u,this._lengthType=m}get dictionaryType(){return this._dictionaryType}get offsetType(){return this._offsetType}get lengthType(){return this._lengthType}}function Eo(h,a){const u=(function(m,y){const T=m[y.get()],M=Object.values(Qs)[T>>4];let R=null;switch(M){case Qs.DATA:R=new _S(Object.values(cc)[15&T]);break;case Qs.OFFSET:R=new _S(null,Object.values(zf)[15&T]);break;case Qs.LENGTH:R=new _S(null,null,Object.values(ma)[15&T])}y.increment();const F=m[y.get()],$=Object.values(vn)[F>>5],H=Object.values(vn)[F>>2&7],K=Object.values(Ku)[3&F];y.increment();const ne=js(m,y,2),se=ne[0];return{physicalStreamType:M,logicalStreamType:R,logicalLevelTechnique1:$,logicalLevelTechnique2:H,physicalLevelTechnique:K,numValues:se,byteLength:ne[1],decompressedCount:se}})(h,a);return u.logicalLevelTechnique1===vn.MORTON?(function(m,y,T){const M=js(y,T,2);return{physicalStreamType:m.physicalStreamType,logicalStreamType:m.logicalStreamType,logicalLevelTechnique1:m.logicalLevelTechnique1,logicalLevelTechnique2:m.logicalLevelTechnique2,physicalLevelTechnique:m.physicalLevelTechnique,numValues:m.numValues,byteLength:m.byteLength,decompressedCount:m.decompressedCount,numBits:M[0],coordinateShift:M[1]}})(u,h,a):vn.RLE!==u.logicalLevelTechnique1&&vn.RLE!==u.logicalLevelTechnique2||Ku.NONE===u.physicalLevelTechnique?u:(function(m,y,T){const M=js(y,T,2);return{physicalStreamType:m.physicalStreamType,logicalStreamType:m.logicalStreamType,logicalLevelTechnique1:m.logicalLevelTechnique1,logicalLevelTechnique2:m.logicalLevelTechnique2,physicalLevelTechnique:m.physicalLevelTechnique,numValues:m.numValues,byteLength:m.byteLength,decompressedCount:M[1],runs:M[0],numRleValues:M[1]}})(u,h,a)}(function(h){h.NONE="NONE",h.SINGLE="SINGLE",h.SHARED="SHARED",h.VERTEX="VERTEX",h.MORTON="MORTON",h.FSST="FSST"})(cc||(cc={})),(function(h){h.VERTEX="VERTEX",h.INDEX="INDEX",h.STRING="STRING",h.KEY="KEY"})(zf||(zf={})),(function(h){h.VAR_BINARY="VAR_BINARY",h.GEOMETRIES="GEOMETRIES",h.PARTS="PARTS",h.RINGS="RINGS",h.TRIANGLES="TRIANGLES",h.SYMBOL="SYMBOL",h.DICTIONARY="DICTIONARY"})(ma||(ma={})),(function(h){h[h.FLAT=0]="FLAT",h[h.CONST=1]="CONST",h[h.SEQUENCE=2]="SEQUENCE",h[h.DICTIONARY=3]="DICTIONARY",h[h.FSST_DICTIONARY=4]="FSST_DICTIONARY"})(Ps||(Ps={}));class uc{values;_size;constructor(a,u){this.values=a,this._size=u}get(a){const u=Math.floor(a/8);return(this.values[u]>>a%8&1)==1}set(a,u){const m=Math.floor(a/8);this.values[m]=this.values[m]|(u?1:0)<<a%8}getInt(a){const u=Math.floor(a/8);return this.values[u]>>a%8&1}size(){return this._size}getBuffer(){return this.values}}function Ao(h,a,u,m,y){return(function(T,M,R){switch(M.logicalLevelTechnique1){case vn.DELTA:return M.logicalLevelTechnique2===vn.RLE?(function(F,$,H){const K=new Int32Array(H);let ne=0,se=0;for(let me=0;me<$;me++){const ge=F[me],ve=Bf(F[me+$]);for(let Ae=0;Ae<ge;Ae++)se+=ve,K[ne++]=se}return K})(T,M.runs,M.numRleValues):((function(F){F[0]=F[0]>>>1^-(1&F[0]);const $=F.length/4*4;let H=1;if($>=4)for(;H<$-4;H+=4){const K=F[H],ne=F[H+1],se=F[H+2],me=F[H+3];F[H]=(K>>>1^-(1&K))+F[H-1],F[H+1]=(ne>>>1^-(1&ne))+F[H],F[H+2]=(se>>>1^-(1&se))+F[H+1],F[H+3]=(me>>>1^-(1&me))+F[H+2]}for(;H!=F.length;++H)F[H]=(F[H]>>>1^-(1&F[H]))+F[H-1]})(T),T);case vn.RLE:return(function(F,$,H){return H?(function(K,ne,se){const me=new Int32Array(se);let ge=0;for(let ve=0;ve<ne;ve++){const Ae=K[ve];let He=K[ve+ne];He=He>>>1^-(1&He),me.fill(He,ge,ge+Ae),ge+=Ae}return me})(F,$.runs,$.numRleValues):DA(F,$.runs,$.numRleValues)})(T,M,R);case vn.MORTON:return gS(T),T;case vn.COMPONENTWISE_DELTA:return zA(T),T;case vn.NONE:return R&&(function(F){for(let $=0;$<F.length;$++){const H=F[$];F[$]=H>>>1^-(1&H)}})(T),T;default:throw new Error(`The specified Logical level technique is not supported: ${M.logicalLevelTechnique1}`)}})(pb(h,a,u),u,m)}function od(h,a,u){return(function(m,y){if(y.logicalLevelTechnique1===vn.DELTA&&y.logicalLevelTechnique2===vn.NONE)return(function(M){const R=new Int32Array(M.length+1);R[0]=0,R[1]=Bf(M[0]);let F=R[1],$=2;for(;$!=R.length;++$){const H=M[$-1];F+=H>>>1^-(1&H),R[$]=R[$-1]+F}return R})(m);if(y.logicalLevelTechnique1===vn.RLE&&y.logicalLevelTechnique2===vn.NONE)return(function(M,R,F){const $=new Int32Array(F+1);$[0]=0;let H=1,K=$[0];for(let ne=0;ne<R;ne++){const se=M[ne],me=M[ne+R];for(let ge=H;ge<H+se;ge++)$[ge]=me+K,K=$[ge];H+=se}return $})(m,y.runs,y.numRleValues);if(y.logicalLevelTechnique1===vn.NONE&&y.logicalLevelTechnique2===vn.NONE){(function(M){let R=0;for(let F=0;F<M.length;F++)M[F]+=R,R=M[F]})(m);const T=new Int32Array(y.numValues+1);return T[0]=0,T.set(m,1),T}if(y.logicalLevelTechnique1===vn.DELTA&&y.logicalLevelTechnique2===vn.RLE){const T=(function(M,R,F){const $=new Int32Array(F+1);$[0]=0;let H=1,K=$[0];for(let ne=0;ne<R;ne++){const se=M[ne];let me=M[ne+R];me=me>>>1^-(1&me);for(let ge=H;ge<H+se;ge++)$[ge]=me+K,K=$[ge];H+=se}return $})(m,y.runs,y.numRleValues);return gS(T),T}throw new Error("Only delta encoding is supported for transforming length to offset streams yet.")})(pb(h,a,u),u)}function pb(h,a,u){const m=u.physicalLevelTechnique;if(m===Ku.FAST_PFOR)return kA();if(m===Ku.VARINT)return js(h,a,u.numValues);if(m===Ku.NONE){const y=a.get();a.add(u.byteLength);const T=h.subarray(y,a.get());return new Int32Array(T)}throw new Error("Specified physicalLevelTechnique is not supported (yet).")}function vS(h,a,u,m){const y=pb(h,a,u);if(y.length===1){const T=y[0];return m?Bf(T):T}return m?(function(T){return Bf(T[1])})(y):(function(T){return T[1]})(y)}function BA(h,a,u){return(function(m){if(m.length==2){const y=Bf(m[1]);return[y,y]}return[Bf(m[2]),Bf(m[3])]})(pb(h,a,u))}function NA(h,a,u){return(function(m){if(m.length==2){const y=Im(m[1]);return[y,y]}return[Im(m[2]),Im(m[3])]})(fb(h,a,u.numValues))}function $A(h,a,u,m){return(function(y,T,M){switch(T.logicalLevelTechnique1){case vn.DELTA:return T.logicalLevelTechnique2===vn.RLE?(function(R,F,$){const H=new BigInt64Array($);let K=0,ne=0n;for(let se=0;se<F;se++){const me=Number(R[se]),ge=Im(R[se+F]);for(let ve=0;ve<me;ve++)ne+=ge,H[K++]=ne}return H})(y,T.runs,T.numRleValues):((function(R){R[0]=R[0]>>1n^-(1n&R[0]);const F=R.length/4*4;let $=1;if(F>=4)for(;$<F-4;$+=4){const H=R[$],K=R[$+1],ne=R[$+2],se=R[$+3];R[$]=(H>>1n^-(1n&H))+R[$-1],R[$+1]=(K>>1n^-(1n&K))+R[$],R[$+2]=(ne>>1n^-(1n&ne))+R[$+1],R[$+3]=(se>>1n^-(1n&se))+R[$+2]}for(;$!=R.length;++$)R[$]=(R[$]>>1n^-(1n&R[$]))+R[$-1]})(y),y);case vn.RLE:return(function(R,F,$){return $?(function(H,K,ne){const se=new BigInt64Array(ne);let me=0;for(let ge=0;ge<K;ge++){const ve=Number(H[ge]);let Ae=H[ge+K];Ae=Ae>>1n^-(1n&Ae),se.fill(Ae,me,me+ve),me+=ve}return se})(R,F.runs,F.numRleValues):FA(R,F.runs,F.numRleValues)})(y,T,M);case vn.NONE:return M&&(function(R){for(let F=0;F<R.length;F++){const $=R[F];R[F]=$>>1n^-(1n&$)}})(y),y;default:throw new Error(`The specified Logical level technique is not supported: ${T.logicalLevelTechnique1}`)}})(fb(h,a,u.numValues),u,m)}function VA(h,a,u,m){const y=fb(h,a,u.numValues);if(y.length===1){const T=y[0];return m?Im(T):T}return m?(function(T){return Im(T[1])})(y):(function(T){return T[1]})(y)}function yS(h,a,u,m,y){return(function(T,M,R,F){switch(M.logicalLevelTechnique1){case vn.DELTA:return M.logicalLevelTechnique2===vn.RLE&&(T=DA(T,M.runs,M.numRleValues)),(function($,H){const K=new Int32Array($.size());let ne=0;$.get(0)?(K[0]=$.get(0)?H[0]>>>1^-(1&H[0]):0,ne=1):K[0]=0;let se=1;for(;se!=K.length;++se)K[se]=$.get(se)?K[se-1]+(H[ne]>>>1^-(1&H[ne++])):K[se-1];return K})(F,T);case vn.RLE:return(function($,H,K,ne){const se=H;return K?(function(me,ge,ve){const Ae=new Int32Array(me.size());let He=0;for(let Ie=0;Ie<ve;Ie++){const Le=ge[Ie];let Ke=ge[Ie+ve];Ke=Ke>>>1^-(1&Ke);for(let nt=He;nt<He+Le;nt++)me.get(nt)?Ae[nt]=Ke:(Ae[nt]=0,He++);He+=Le}return Ae})(ne,$,se.runs):(function(me,ge,ve){const Ae=new Int32Array(me.size());let He=0;for(let Ie=0;Ie<ve;Ie++){const Le=ge[Ie],Ke=ge[Ie+ve];for(let nt=He;nt<He+Le;nt++)me.get(nt)?Ae[nt]=Ke:(Ae[nt]=0,He++);He+=Le}return Ae})(ne,$,se.runs)})(T,M,R,F);case vn.MORTON:return gS(T),T;case vn.COMPONENTWISE_DELTA:return zA(T),T;case vn.NONE:return T=R?(function($,H){const K=new Int32Array($.size());let ne=0,se=0;for(;se!=K.length;++se)if($.get(se)){const me=H[ne++];K[se]=me>>>1^-(1&me)}else K[se]=0;return K})(F,T):(function($,H){const K=new Int32Array($.size());let ne=0,se=0;for(;se!=K.length;++se)K[se]=$.get(se)?H[ne++]:0;return K})(F,T),T;default:throw new Error("The specified Logical level technique is not supported")}})(u.physicalLevelTechnique===Ku.FAST_PFOR?kA():js(h,a,u.numValues),u,m,y)}function mb(h,a,u,m){const y=h.logicalLevelTechnique1;if(y===vn.RLE)return h.runs===1?Ps.CONST:Ps.FLAT;const T=a instanceof uc?a.size():a;if(y===vn.DELTA&&h.logicalLevelTechnique2===vn.RLE){const M=h.runs,R=2;if(h.numRleValues!==T)return Ps.FLAT;if(M===1)return Ps.SEQUENCE;if(M===2){const F=m.get();let $;if(h.physicalLevelTechnique===Ku.VARINT)$=js(u,m,4);else{const H=m.get();$=new Int32Array(u.buffer,u.byteOffset+H,4)}if(m.set(F),$[2]===R&&$[3]===R)return Ps.SEQUENCE}}return h.numValues===1?Ps.CONST:Ps.FLAT}class UA extends db{getValueFromBuffer(a){return this.dataBuffer[a]}}class jA extends RA{constructor(a,u,m,y){super(a,BigInt64Array.of(u),m,y)}getValueFromBuffer(a){return this.dataBuffer[0]+BigInt(a)*this.delta}}class Rm{_geometryOffsets;_partOffsets;_ringOffsets;constructor(a,u,m){this._geometryOffsets=a,this._partOffsets=u,this._ringOffsets=m}get geometryOffsets(){return this._geometryOffsets}get partOffsets(){return this._partOffsets}get ringOffsets(){return this._ringOffsets}}function bS(h,a,u){return{x:GA(h,a)-u,y:GA(h>>1,a)-u}}function GA(h,a){let u=0;for(let m=0;m<a;m++)u|=(h&1<<2*m)>>m;return u}(function(h){h[h.POINT=0]="POINT",h[h.LINESTRING=1]="LINESTRING",h[h.POLYGON=2]="POLYGON",h[h.MULTIPOINT=3]="MULTIPOINT",h[h.MULTILINESTRING=4]="MULTILINESTRING",h[h.MULTIPOLYGON=5]="MULTIPOLYGON"})(Is||(Is={})),(function(h){h[h.POINT=0]="POINT",h[h.LINESTRING=1]="LINESTRING",h[h.POLYGON=2]="POLYGON"})(LA||(LA={})),(function(h){h[h.MORTON=0]="MORTON",h[h.VEC_2=1]="VEC_2",h[h.VEC_3=2]="VEC_3"})(Ga||(Ga={}));class b${createPoint(a){return[[a]]}createMultiPoint(a){return a.map((u=>[u]))}createLineString(a){return[a]}createMultiLineString(a){return a}createPolygon(a,u){return[a].concat(u)}createMultiPolygon(a){return a.flat()}}function qA(h){const a=new Array(h.numGeometries);let u=1,m=1,y=1,T=0;const M=new b$;let R=0,F=0;const $=h.mortonSettings,H=h.topologyVector,K=H.geometryOffsets,ne=H.partOffsets,se=H.ringOffsets,me=h.vertexOffsets,ge=h.containsPolygonGeometry(),ve=h.vertexBuffer;for(let Ae=0;Ae<h.numGeometries;Ae++){const He=h.geometryType(Ae);if(He===Is.POINT){if(me&&me.length!==0)if(h.vertexBufferType===Ga.VEC_2){const Ie=2*me[F++],Le=new d(ve[Ie],ve[Ie+1]);a[T++]=M.createPoint(Le)}else{const Ie=bS(ve[me[F++]],$.numBits,$.coordinateShift),Le=new d(Ie.x,Ie.y);a[T++]=M.createPoint(Le)}else{const Ie=new d(ve[R++],ve[R++]);a[T++]=M.createPoint(Ie)}K&&y++,ne&&u++,se&&m++}else if(He===Is.MULTIPOINT){const Ie=K[y]-K[y-1];y++;const Le=new Array(Ie);if(me&&me.length!==0){for(let Ke=0;Ke<Ie;Ke++){const nt=2*me[F++];Le[Ke]=new d(ve[nt],ve[nt+1])}a[T++]=M.createMultiPoint(Le)}else{for(let Ke=0;Ke<Ie;Ke++){const nt=ve[R++],Ct=ve[R++];Le[Ke]=new d(nt,Ct)}a[T++]=M.createMultiPoint(Le)}}else if(He===Is.LINESTRING){let Ie,Le=0;ge?(Le=se[m]-se[m-1],m++):Le=ne[u]-ne[u-1],u++,me&&me.length!==0?(Ie=h.vertexBufferType===Ga.VEC_2?wS(ve,me,F,Le,!1):SS(ve,me,F,Le,!1,$),F+=Le):(Ie=xS(ve,R,Le,!1),R+=2*Le),a[T++]=M.createLineString(Ie),K&&y++}else if(He===Is.POLYGON){const Ie=ne[u]-ne[u-1];u++;const Le=new Array(Ie-1);let Ke=se[m]-se[m-1];if(m++,me&&me.length!==0){const nt=h.vertexBufferType===Ga.VEC_2?_b(ve,me,F,Ke):vb(ve,me,F,Ke,0,$);F+=Ke;for(let Ct=0;Ct<Le.length;Ct++)Ke=se[m]-se[m-1],m++,Le[Ct]=h.vertexBufferType===Ga.VEC_2?_b(ve,me,F,Ke):vb(ve,me,F,Ke,0,$),F+=Ke;a[T++]=M.createPolygon(nt,Le)}else{const nt=gb(ve,R,Ke);R+=2*Ke;for(let Ct=0;Ct<Le.length;Ct++)Ke=se[m]-se[m-1],m++,Le[Ct]=gb(ve,R,Ke),R+=2*Ke;a[T++]=M.createPolygon(nt,Le)}K&&y++}else if(He===Is.MULTILINESTRING){const Ie=K[y]-K[y-1];y++;const Le=new Array(Ie);if(me&&me.length!==0){for(let Ke=0;Ke<Ie;Ke++){let nt=0;ge?(nt=se[m]-se[m-1],m++):nt=ne[u]-ne[u-1],u++;const Ct=h.vertexBufferType===Ga.VEC_2?wS(ve,me,F,nt,!1):SS(ve,me,F,nt,!1,$);Le[Ke]=Ct,F+=nt}a[T++]=M.createMultiLineString(Le)}else{for(let Ke=0;Ke<Ie;Ke++){let nt=0;ge?(nt=se[m]-se[m-1],m++):nt=ne[u]-ne[u-1],u++,Le[Ke]=xS(ve,R,nt,!1),R+=2*nt}a[T++]=M.createMultiLineString(Le)}}else{if(He!==Is.MULTIPOLYGON)throw new Error("The specified geometry type is currently not supported.");{const Ie=K[y]-K[y-1];y++;const Le=new Array(Ie);let Ke=0;if(me&&me.length!==0){for(let nt=0;nt<Ie;nt++){const Ct=ne[u]-ne[u-1];u++;const Ut=new Array(Ct-1);Ke=se[m]-se[m-1],m++;const Bt=h.vertexBufferType===Ga.VEC_2?_b(ve,me,F,Ke):vb(ve,me,F,Ke,0,$);F+=Ke;for(let Zt=0;Zt<Ut.length;Zt++)Ke=se[m]-se[m-1],m++,Ut[Zt]=h.vertexBufferType===Ga.VEC_2?_b(ve,me,F,Ke):vb(ve,me,F,Ke,0,$),F+=Ke;Le[nt]=M.createPolygon(Bt,Ut)}a[T++]=M.createMultiPolygon(Le)}else{for(let nt=0;nt<Ie;nt++){const Ct=ne[u]-ne[u-1];u++;const Ut=new Array(Ct-1);Ke=se[m]-se[m-1],m++;const Bt=gb(ve,R,Ke);R+=2*Ke;for(let Zt=0;Zt<Ut.length;Zt++){const ni=se[m]-se[m-1];m++,Ut[Zt]=gb(ve,R,ni),R+=2*ni}Le[nt]=M.createPolygon(Bt,Ut)}a[T++]=M.createMultiPolygon(Le)}}}}return a}function gb(h,a,u){return xS(h,a,u,!0)}function _b(h,a,u,m){return wS(h,a,u,m,!0)}function vb(h,a,u,m,y,T){return SS(h,a,u,m,!0,T)}function xS(h,a,u,m){const y=new Array(m?u+1:u);for(let T=0;T<2*u;T+=2)y[T/2]=new d(h[a+T],h[a+T+1]);return m&&(y[y.length-1]=y[0]),y}function wS(h,a,u,m,y){const T=new Array(y?m+1:m);for(let M=0;M<2*m;M+=2){const R=2*a[u+M/2];T[M/2]=new d(h[R],h[R+1])}return y&&(T[T.length-1]=T[0]),T}function SS(h,a,u,m,y,T){const M=new Array(y?m+1:m);for(let R=0;R<m;R++){const F=bS(h[a[u+R]],T.numBits,T.coordinateShift);M[R]=new d(F.x,F.y)}return y&&(M[M.length-1]=M[0]),M}class WA{_vertexBufferType;_topologyVector;_vertexOffsets;_vertexBuffer;_mortonSettings;constructor(a,u,m,y,T){this._vertexBufferType=a,this._topologyVector=u,this._vertexOffsets=m,this._vertexBuffer=y,this._mortonSettings=T}get vertexBufferType(){return this._vertexBufferType}get topologyVector(){return this._topologyVector}get vertexOffsets(){return this._vertexOffsets}get vertexBuffer(){return this._vertexBuffer}*[Symbol.iterator](){const a=qA(this);let u=0;for(;u<this.numGeometries;)yield{coordinates:a[u],type:this.geometryType(u)},u++}getSimpleEncodedVertex(a){const u=this.vertexOffsets?2*this.vertexOffsets[a]:2*a;return[this.vertexBuffer[u],this.vertexBuffer[u+1]]}getVertex(a){if(this.vertexOffsets&&this.mortonSettings){const m=bS(this.vertexBuffer[this.vertexOffsets[a]],this.mortonSettings.numBits,this.mortonSettings.coordinateShift);return[m.x,m.y]}const u=this.vertexOffsets?2*this.vertexOffsets[a]:2*a;return[this.vertexBuffer[u],this.vertexBuffer[u+1]]}getGeometries(){return qA(this)}get mortonSettings(){return this._mortonSettings}}class HA extends WA{_numGeometries;_geometryType;constructor(a,u,m,y,T,M,R){super(m,y,T,M,R),this._numGeometries=a,this._geometryType=u}geometryType(a){return this._geometryType}get numGeometries(){return this._numGeometries}containsPolygonGeometry(){return this._geometryType===Is.POLYGON||this._geometryType===Is.MULTIPOLYGON}containsSingleGeometryType(){return!0}}class ZA extends WA{_geometryTypes;constructor(a,u,m,y,T,M){super(a,m,y,T,M),this._geometryTypes=u}geometryType(a){return this._geometryTypes[a]}get numGeometries(){return this._geometryTypes.length}containsPolygonGeometry(){for(let a=0;a<this.numGeometries;a++)if(this.geometryType(a)===Is.POLYGON||this.geometryType(a)===Is.MULTIPOLYGON)return!0;return!1}containsSingleGeometryType(){return!1}}class XA{_triangleOffsets;_indexBuffer;_vertexBuffer;_topologyVector;constructor(a,u,m,y){this._triangleOffsets=a,this._indexBuffer=u,this._vertexBuffer=m,this._topologyVector=y}get triangleOffsets(){return this._triangleOffsets}get indexBuffer(){return this._indexBuffer}get vertexBuffer(){return this._vertexBuffer}get topologyVector(){return this._topologyVector}getGeometries(){if(!this._topologyVector)throw new Error("Cannot convert GpuVector to coordinates without topology information");const a=new Array(this.numGeometries),u=this._topologyVector,m=u.partOffsets,y=u.ringOffsets,T=u.geometryOffsets;let M=0,R=1,F=1,$=1;for(let H=0;H<this.numGeometries;H++)switch(this.geometryType(H)){case Is.POLYGON:{const K=m[R]-m[R-1];R++;const ne=[];for(let se=0;se<K;se++){const me=y[F]-y[F-1];F++;const ge=[];for(let ve=0;ve<me;ve++){const Ae=this._vertexBuffer[M++],He=this._vertexBuffer[M++];ge.push(new d(Ae,He))}ge.length>0&&ge.push(ge[0]),ne.push(ge)}a[H]=ne,T&&$++}break;case Is.MULTIPOLYGON:{const K=T[$]-T[$-1];$++;const ne=[];for(let se=0;se<K;se++){const me=m[R]-m[R-1];R++;for(let ge=0;ge<me;ge++){const ve=y[F]-y[F-1];F++;const Ae=[];for(let He=0;He<ve;He++){const Ie=this._vertexBuffer[M++],Le=this._vertexBuffer[M++];Ae.push(new d(Ie,Le))}Ae.length>0&&Ae.push(Ae[0]),ne.push(Ae)}}a[H]=ne}}return a}[Symbol.iterator](){return null}}function YA(h,a,u,m,y,T){return new x$(h,a,u,m,y,T)}class x$ extends XA{_numGeometries;_geometryType;constructor(a,u,m,y,T,M){super(m,y,T,M),this._numGeometries=a,this._geometryType=u}geometryType(a){return this._geometryType}get numGeometries(){return this._numGeometries}containsSingleGeometryType(){return!0}}function KA(h,a,u,m,y){return new w$(h,a,u,m,y)}class w$ extends XA{_geometryTypes;constructor(a,u,m,y,T){super(u,m,y,T),this._geometryTypes=a}geometryType(a){return this._geometryTypes[a]}get numGeometries(){return this._geometryTypes.length}containsSingleGeometryType(){return!1}}function S$(h,a,u,m,y){const T=Eo(h,u);let M=null,R=null,F=null,$=null,H=null,K=null,ne=null,se=null;if(mb(T,m,h,u)===Ps.CONST){const ge=vS(h,u,T,!1);for(let ve=0;ve<a-1;ve++){const Ae=Eo(h,u);switch(Ae.physicalStreamType){case Qs.LENGTH:switch(Ae.logicalStreamType.lengthType){case ma.GEOMETRIES:M=od(h,u,Ae);break;case ma.PARTS:R=od(h,u,Ae);break;case ma.RINGS:F=od(h,u,Ae);break;case ma.TRIANGLES:ne=od(h,u,Ae)}break;case Qs.OFFSET:switch(Ae.logicalStreamType.offsetType){case zf.VERTEX:$=Ao(h,u,Ae,!1);break;case zf.INDEX:se=Ao(h,u,Ae,!1)}break;case Qs.DATA:cc.VERTEX===Ae.logicalStreamType.dictionaryType?H=Ao(h,u,Ae,!0):(K={numBits:Ae.numBits,coordinateShift:Ae.coordinateShift},H=Ao(h,u,Ae,!1))}}return se!==null?M!=null||R!=null?YA(m,ge,ne,se,H,new Rm(M,R,F)):YA(m,ge,ne,se,H):K===null?(function(ve,Ae,He,Ie,Le){return new HA(ve,Ae,Ga.VEC_2,He,Ie,Le)})(m,ge,new Rm(M,R,F),$,H):(function(ve,Ae,He,Ie,Le,Ke){return new HA(ve,Ae,Ga.MORTON,He,Ie,Le,Ke)})(m,ge,new Rm(M,R,F),$,H,K)}const me=Ao(h,u,T,!1);for(let ge=0;ge<a-1;ge++){const ve=Eo(h,u);switch(ve.physicalStreamType){case Qs.LENGTH:switch(ve.logicalStreamType.lengthType){case ma.GEOMETRIES:M=Ao(h,u,ve,!1);break;case ma.PARTS:R=Ao(h,u,ve,!1);break;case ma.RINGS:F=Ao(h,u,ve,!1);break;case ma.TRIANGLES:ne=od(h,u,ve)}break;case Qs.OFFSET:switch(ve.logicalStreamType.offsetType){case zf.VERTEX:$=Ao(h,u,ve,!1);break;case zf.INDEX:se=Ao(h,u,ve,!1)}break;case Qs.DATA:cc.VERTEX===ve.logicalStreamType.dictionaryType?H=Ao(h,u,ve,!0):(K={numBits:ve.numBits,coordinateShift:ve.coordinateShift},H=Ao(h,u,ve,!1))}}return se!==null&&R===null?KA(me,ne,se,H):(M!==null?(M=TS(me,M,2),R!==null&&F!==null?(R=JA(me,M,R,!1),F=(function(ge,ve,Ae,He){const Ie=new Int32Array(Ae[Ae.length-1]+1);let Le=0;Ie[0]=Le;let Ke=1,nt=1,Ct=0;for(let Ut=0;Ut<ge.length;Ut++){const Bt=ge[Ut],Zt=ve[Ut+1]-ve[Ut];if(Bt!==0&&Bt!==3)for(let ni=0;ni<Zt;ni++){const Yt=Ae[Ke]-Ae[Ke-1];Ke++;for(let $t=0;$t<Yt;$t++)Le=Ie[nt++]=Le+He[Ct++]}else for(let ni=0;ni<Zt;ni++)Ie[nt++]=++Le,Ke++}return Ie})(me,M,R,F)):R!==null&&(R=(function(ge,ve,Ae){const He=new Int32Array(ve[ve.length-1]+1);let Ie=0;He[0]=Ie;let Le=1,Ke=0;for(let nt=0;nt<ge.length;nt++){const Ct=ge[nt],Ut=ve[nt+1]-ve[nt];if(Ct===4||Ct===1)for(let Bt=0;Bt<Ut;Bt++)Ie=He[Le++]=Ie+Ae[Ke++];else for(let Bt=0;Bt<Ut;Bt++)He[Le++]=++Ie}return He})(me,M,R))):R!==null&&F!==null?(R=TS(me,R,1),F=JA(me,R,F,!0)):R!==null&&(R=TS(me,R,0)),se!==null?KA(me,ne,se,H,new Rm(M,R,F)):K===null?(function(ge,ve,Ae,He){return new ZA(Ga.VEC_2,ge,ve,Ae,He)})(me,new Rm(M,R,F),$,H):(function(ge,ve,Ae,He,Ie){return new ZA(Ga.MORTON,ge,ve,Ae,He,Ie)})(me,new Rm(M,R,F),$,H,K))}function TS(h,a,u){const m=new Int32Array(h.length+1);let y=0;m[0]=y;let T=0;for(let M=0;M<h.length;M++)y=m[M+1]=y+(h[M]>u?a[T++]:1);return m}function JA(h,a,u,m){const y=new Int32Array(a[a.length-1]+1);let T=0;y[0]=T;let M=1,R=0;for(let F=0;F<h.length;F++){const $=h[F],H=a[F+1]-a[F];if($===5||$===2||m&&($===4||$===1))for(let K=0;K<H;K++)T=y[M++]=T+u[R++];else for(let K=0;K<H;K++)y[M++]=++T}return y}class T$ extends Pm{dataVector;constructor(a,u,m){super(a,u.getBuffer(),m),this.dataVector=u}getValueFromBuffer(a){return this.dataVector.get(a)}}class M$ extends db{getValueFromBuffer(a){return this.dataBuffer[a]}}class QA extends Pm{constructor(a,u,m){super(a,BigInt64Array.of(u),m)}getValueFromBuffer(a){return this.dataBuffer[0]}}function hv(h,a,u){return eP(h,Math.ceil(a/8),u)}function eP(h,a,u){const m=new Uint8Array(a);let y=0;for(;y<a;){const T=h[u.increment()];if(T<=127){const M=T+3,R=h[u.increment()],F=y+M;m.fill(R,y,F),y=F}else{const M=256-T;for(let R=0;R<M;R++)m[y++]=h[u.increment()]}}return m}const C$=new TextDecoder;function MS(h,a,u){return u-a>=12?C$.decode(h.subarray(a,u)):(function(m,y,T){let M="",R=y;for(;R<T;){const F=m[R];let $,H,K,ne=null,se=F>239?4:F>223?3:F>191?2:1;if(R+se>T)break;se===1?F<128&&(ne=F):se===2?($=m[R+1],(192&$)==128&&(ne=(31&F)<<6|63&$,ne<=127&&(ne=null))):se===3?($=m[R+1],H=m[R+2],(192&$)==128&&(192&H)==128&&(ne=(15&F)<<12|(63&$)<<6|63&H,(ne<=2047||ne>=55296&&ne<=57343)&&(ne=null))):se===4&&($=m[R+1],H=m[R+2],K=m[R+3],(192&$)==128&&(192&H)==128&&(192&K)==128&&(ne=(15&F)<<18|(63&$)<<12|(63&H)<<6|63&K,(ne<=65535||ne>=1114112)&&(ne=null))),ne===null?(ne=65533,se=1):ne>65535&&(ne-=65536,M+=String.fromCharCode(ne>>>10&1023|55296),ne=56320|1023&ne),M+=String.fromCharCode(ne),R+=se}return M})(h,a,u)}class CS extends Pm{offsetBuffer;constructor(a,u,m,y){super(a,m,y),this.offsetBuffer=u}}class tP extends CS{textEncoder;constructor(a,u,m,y){super(a,u,m,y??u.length-1),this.textEncoder=new TextEncoder}getValueFromBuffer(a){return MS(this.dataBuffer,this.offsetBuffer[a],this.offsetBuffer[a+1])}}class Lm extends CS{indexBuffer;textEncoder;constructor(a,u,m,y,T){super(a,m,y,T??u.length),this.indexBuffer=u,this.indexBuffer=u,this.textEncoder=new TextEncoder}getValueFromBuffer(a){const u=this.indexBuffer[a];return MS(this.dataBuffer,this.offsetBuffer[u],this.offsetBuffer[u+1])}}class iP extends CS{indexBuffer;symbolOffsetBuffer;symbolTableBuffer;textEncoder;symbolLengthBuffer;lengthBuffer;decodedDictionary;constructor(a,u,m,y,T,M,R){super(a,m,y,R),this.indexBuffer=u,this.symbolOffsetBuffer=T,this.symbolTableBuffer=M,this.textEncoder=new TextEncoder}getValueFromBuffer(a){this.decodedDictionary==null&&(this.symbolLengthBuffer==null&&(this.symbolLengthBuffer=this.offsetToLengthBuffer(this.symbolOffsetBuffer),this.lengthBuffer=this.offsetToLengthBuffer(this.offsetBuffer)),this.decodedDictionary=(function(m,y,T){const M=[],R=new Array(y.length).fill(0);for(let F=1;F<y.length;F++)R[F]=R[F-1]+y[F-1];for(let F=0;F<T.length;F++)if(T[F]===255)M.push(T[++F]);else{const $=y[T[F]],H=R[T[F]];for(let K=0;K<$;K++)M.push(m[H+K])}return new Uint8Array(M)})(this.symbolTableBuffer,this.symbolLengthBuffer,this.dataBuffer));const u=this.indexBuffer[a];return MS(this.decodedDictionary,this.offsetBuffer[u],this.offsetBuffer[u+1])}offsetToLengthBuffer(a){const u=new Uint32Array(a.length-1);let m=a[0];for(let y=1;y<a.length;y++){const T=a[y];u[y-1]=T-m,m=T}return u}}function E$(h,a,u,m,y,T){return u.type==="scalarType"?(function(M,R,F,$,H,K){let ne=null,se=0;if(M===0)return null;if(K.nullable){const ge=Eo(R,F);se=ge.numValues;const ve=F.get(),Ae=hv(R,se,F);F.set(ve+ge.byteLength),ne=new uc(Ae,ge.numValues)}const me=ne??$;switch(H.physicalType){case 4:case 3:return(function(ge,ve,Ae,He,Ie){const Le=Eo(ge,ve),Ke=mb(Le,Ie,ge,ve),nt=He.physicalType===3;if(Ke===Ps.FLAT){const Ct=dv(Ie)?yS(ge,ve,Le,nt,Ie):Ao(ge,ve,Le,nt);return new dS(Ae.name,Ct,Ie)}if(Ke===Ps.SEQUENCE){const Ct=BA(ge,ve,Le);return new pS(Ae.name,Ct[0],Ct[1],Le.numRleValues)}{const Ct=vS(ge,ve,Le,nt);return new mS(Ae.name,Ct,Ie)}})(R,F,K,H,me);case 9:return(function(ge,ve,Ae,He,Ie){let Le=null,Ke=null,nt=null,Ct=null,Ut=null,Bt=null,Zt=null,ni=null;for(let Yt=0;Yt<He;Yt++){const $t=Eo(ve,Ae);if($t.byteLength!==0)switch($t.physicalStreamType){case Qs.PRESENT:{const Rt=hv(ve,$t.numValues,Ae);Bt=new uc(Rt,$t.numValues);break}case Qs.OFFSET:Ke=Ie!=null||Bt!=null?yS(ve,Ae,$t,!1,Ie??Bt):Ao(ve,Ae,$t,!1);break;case Qs.LENGTH:{const Rt=od(ve,Ae,$t);ma.DICTIONARY===$t.logicalStreamType.lengthType?Le=Rt:ma.SYMBOL===$t.logicalStreamType.lengthType?Ct=Rt:Zt=Rt;break}case Qs.DATA:{const Rt=ve.subarray(Ae.get(),Ae.get()+$t.byteLength);Ae.add($t.byteLength);const fi=$t.logicalStreamType.dictionaryType;cc.FSST===fi?Ut=Rt:cc.SINGLE===fi||cc.SHARED===fi?nt=Rt:cc.NONE===fi&&(ni=Rt);break}}}return(function(Yt,$t,Rt,fi,hi,vi,ui){return $t?new iP(Yt,Rt,fi,hi,vi,$t,ui):null})(ge,Ut,Ke,Le,nt,Ct,Ie??Bt)??(function(Yt,$t,Rt,fi,hi){return $t?hi?new Lm(Yt,Rt,fi,$t,hi):new Lm(Yt,Rt,fi,$t):null})(ge,nt,Ke,Le,Ie??Bt)??(function(Yt,$t,Rt,fi,hi){if(!$t||!Rt)return null;if(fi)return hi?new Lm(Yt,fi,$t,Rt,hi):new Lm(Yt,fi,$t,Rt);if(hi&&hi.size()!==$t.length-1){const vi=new Int32Array(hi.size());let ui=0;for(let Ei=0;Ei<hi.size();Ei++)vi[Ei]=hi.get(Ei)?ui++:0;return new Lm(Yt,vi,$t,Rt,hi)}return hi?new tP(Yt,$t,Rt,hi):new tP(Yt,$t,Rt)})(ge,Zt,ni,Ke,Ie??Bt)})(K.name,R,F,K.nullable?M-1:M,ne);case 0:return(function(ge,ve,Ae,He,Ie){const Le=Eo(ge,ve),Ke=Le.numValues,nt=ve.get(),Ct=dv(Ie)?(function(Bt,Zt,ni,Yt){const $t=eP(Bt,Math.ceil(Zt/8),ni),Rt=new uc($t,Zt),fi=Yt.size(),hi=new uc(new Uint8Array(fi),fi);let vi=0;for(let ui=0;ui<Yt.size();ui++){const Ei=!!Yt.get(ui)&&Rt.get(vi++);hi.set(ui,Ei)}return hi.getBuffer()})(ge,Ke,ve,Ie):hv(ge,Ke,ve);ve.set(nt+Le.byteLength);const Ut=new uc(Ct,Ke);return new T$(Ae.name,Ut,Ie)})(R,F,K,0,me);case 6:case 5:return(function(ge,ve,Ae,He,Ie){const Le=Eo(ge,ve),Ke=mb(Le,He,ge,ve),nt=Ie.physicalType===5;if(Ke===Ps.FLAT){const Ct=dv(He)?(function(Ut,Bt,Zt,ni,Yt){return(function($t,Rt,fi,hi){switch(Rt.logicalLevelTechnique1){case vn.DELTA:return Rt.logicalLevelTechnique2===vn.RLE&&($t=FA($t,Rt.runs,Rt.numRleValues)),(function(vi,ui){const Ei=new BigInt64Array(vi.size());let Tn=0;vi.get(0)?(Ei[0]=vi.get(0)?ui[0]>>1n^-(1n&ui[0]):0n,Tn=1):Ei[0]=0n;let dn=1;for(;dn!=Ei.length;++dn)Ei[dn]=vi.get(dn)?Ei[dn-1]+(ui[Tn]>>1n^-(1n&ui[Tn++])):Ei[dn-1];return Ei})(hi,$t);case vn.RLE:return(function(vi,ui,Ei,Tn){const dn=ui;return Ei?(function(Sr,to,ps){const Tr=new BigInt64Array(Sr.size());let gr=0;for(let In=0;In<ps;In++){const Nr=Number(to[In]);let Yr=to[In+ps];Yr=Yr>>1n^-(1n&Yr);for(let ar=gr;ar<gr+Nr;ar++)Sr.get(ar)?Tr[ar]=Yr:(Tr[ar]=0n,gr++);gr+=Nr}return Tr})(Tn,vi,dn.runs):(function(Sr,to,ps){const Tr=new BigInt64Array(Sr.size());let gr=0;for(let In=0;In<ps;In++){const Nr=Number(to[In]),Yr=to[In+ps];for(let ar=gr;ar<gr+Nr;ar++)Sr.get(ar)?Tr[ar]=Yr:(Tr[ar]=0n,gr++);gr+=Nr}return Tr})(Tn,vi,dn.runs)})($t,Rt,fi,hi);case vn.NONE:return $t=fi?(function(vi,ui){const Ei=new BigInt64Array(vi.size());let Tn=0,dn=0;for(;dn!=Ei.length;++dn)if(vi.get(dn)){const Sr=ui[Tn++];Ei[dn]=Sr>>1n^-(1n&Sr)}else Ei[dn]=0n;return Ei})(hi,$t):(function(vi,ui){const Ei=new BigInt64Array(vi.size());let Tn=0,dn=0;for(;dn!=Ei.length;++dn)Ei[dn]=vi.get(dn)?ui[Tn++]:0n;return Ei})(hi,$t),$t;default:throw new Error("The specified Logical level technique is not supported")}})(fb(Ut,Bt,Zt.numValues),Zt,ni,Yt)})(ge,ve,Le,nt,He):$A(ge,ve,Le,nt);return new UA(Ae.name,Ct,He)}if(Ke===Ps.SEQUENCE){const Ct=NA(ge,ve,Le);return new jA(Ae.name,Ct[0],Ct[1],Le.numRleValues)}{const Ct=VA(ge,ve,Le,nt);return new QA(Ae.name,Ct,He)}})(R,F,K,me,H);case 7:return(function(ge,ve,Ae,He){const Ie=Eo(ge,ve),Le=dv(He)?(function(Ke,nt,Ct,Ut){const Bt=nt.get(),Zt=Bt+Ut*Float32Array.BYTES_PER_ELEMENT,ni=new Uint8Array(Ke.subarray(Bt,Zt)).buffer,Yt=new Float32Array(ni);nt.set(Zt);const $t=Ct.size(),Rt=new Float32Array($t);let fi=0;for(let hi=0;hi<$t;hi++)Rt[hi]=Ct.get(hi)?Yt[fi++]:0;return Rt})(ge,ve,He,Ie.numValues):(function(Ke,nt,Ct){const Ut=nt.get(),Bt=Ut+Ct*Float32Array.BYTES_PER_ELEMENT,Zt=new Uint8Array(Ke.subarray(Ut,Bt)).buffer,ni=new Float32Array(Zt);return nt.set(Bt),ni})(ge,ve,Ie.numValues);return new M$(Ae.name,Le,He)})(R,F,K,me);case 8:return(function(ge,ve,Ae,He){const Ie=Eo(ge,ve),Le=dv(He)?(function(Ke,nt,Ct,Ut){const Bt=nt.get(),Zt=Bt+Ut*Float64Array.BYTES_PER_ELEMENT,ni=new Uint8Array(Ke.subarray(Bt,Zt)).buffer,Yt=new Float64Array(ni);nt.set(Zt);const $t=Ct.size(),Rt=new Float64Array($t);let fi=0;for(let hi=0;hi<$t;hi++)Rt[hi]=Ct.get(hi)?Yt[fi++]:0;return Rt})(ge,ve,He,Ie.numValues):(function(Ke,nt,Ct){const Ut=nt.get(),Bt=Ut+Ct*Float64Array.BYTES_PER_ELEMENT,Zt=new Uint8Array(Ke.subarray(Ut,Bt)).buffer,ni=new Float64Array(Zt);return nt.set(Bt),ni})(ge,ve,Ie.numValues);return new fS(Ae.name,Le,He)})(R,F,K,me);default:throw new Error(`The specified data type for the field is currently not supported: ${H}`)}})(m,h,a,y,u.scalarType,u):m!=1?null:(function(M,R,F,$){let H=null,K=null,ne=null,se=null,me=!1;for(;!me;){const He=Eo(M,R);switch(He.physicalStreamType){case Qs.LENGTH:ma.DICTIONARY===He.logicalStreamType.lengthType?H=od(M,R,He):ne=od(M,R,He);break;case Qs.DATA:cc.SINGLE===He.logicalStreamType.dictionaryType||cc.SHARED===He.logicalStreamType.dictionaryType?(K=M.subarray(R.get(),R.get()+He.byteLength),me=!0):se=M.subarray(R.get(),R.get()+He.byteLength),R.add(He.byteLength)}}const ge=F.complexType.children,ve=[];let Ae=0;for(const He of ge){const Ie=js(M,R,1)[0];if(Ie==0)continue;const Le=`${F.name}${He.name==="default"?"":":"+He.name}`;if(Ie!==2||He.type!=="scalarField"||He.scalarField.physicalType!==9)throw new Error("Currently only optional string fields are implemented for a struct.");const Ke=Eo(M,R),nt=hv(M,Ke.numValues,R),Ct=Eo(M,R),Ut=Ct.decompressedCount!==$?yS(M,R,Ct,!1,new uc(nt,Ke.numValues)):Ao(M,R,Ct,!1);ve[Ae++]=se?new iP(Le,Ut,H,K,ne,se,new uc(nt,Ke.numValues)):new Lm(Le,Ut,H,K,new uc(nt,Ke.numValues))}return ve})(h,a,u,y)}function dv(h){return h instanceof uc}function A$(h){if(h.name==="id")return!1;if(h.type==="scalarType"){const a=h.scalarType;if(a.type==="physicalType")switch(a.physicalType){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:default:return!1;case 9:return!0}else if(a.type==="logicalType")return!1}else if(h.type==="complexType"){const a=h.complexType;if(a.type==="physicalType")switch(a.physicalType){case 0:case 1:return!0;default:return!1}}return console.warn("Unexpected column type in hasStreamCount",h),!1}const P$=new TextDecoder;function nP(h,a){const u=js(h,a,1)[0];if(u===0)return"";const m=a.get(),y=h.subarray(m,m+u);return a.add(u),P$.decode(y)}function rP(h,a){const u=js(h,a,1)[0]>>>0,m=!!(4&u),y=!!(2&u),T=js(h,a,1)[0]>>>0,M={};if(1&u&&(M.nullable=!0),y){const R={};if(m?(R.type="logicalType",R.logicalType=T):(R.type="physicalType",R.physicalType=T),8&u){const F=js(h,a,1)[0]>>>0;R.children=new Array(F);for(let $=0;$<F;$++)R.children[$]=rP(h,a)}M.type="complexField",M.complexField=R}else{const R={};m?(R.type="logicalType",R.logicalType=T):(R.type="physicalType",R.physicalType=T),M.type="scalarField",M.scalarField=R}return M}function I$(h,a){const u=js(h,a,1)[0]>>>0,m=(function(y){switch(y){case 0:case 1:case 2:case 3:{const T={};T.nullable=!!(1&y),T.columnScope=0;const M={};return M.physicalType=y>1?6:4,M.type="physicalType",T.scalarType=M,T.type="scalarType",T}case 4:{const T={nullable:!1,columnScope:0},M={type:"physicalType",physicalType:0};return T.type="complexType",T.complexType=M,T}case 30:{const T={nullable:!1,columnScope:0},M={type:"physicalType",physicalType:1};return T.type="complexType",T.complexType=M,T}default:return(function(T){let M=null;switch(T){case 10:case 11:M=0;break;case 12:case 13:M=1;break;case 14:case 15:M=2;break;case 16:case 17:M=3;break;case 18:case 19:M=4;break;case 20:case 21:M=5;break;case 22:case 23:M=6;break;case 24:case 25:M=7;break;case 26:case 27:M=8;break;case 28:case 29:M=9;break;default:return null}const R={};R.nullable=!!(1&T),R.columnScope=0;const F={type:"physicalType"};return F.physicalType=M,R.type="scalarType",R.scalarType=F,R})(y)}})(u);if(!m)throw new Error(`Unsupported column type code: ${u}`);if((function(y){return y>=10})(u)?m.name=nP(h,a):u>=0&&u<=3?m.name="id":u===4&&(m.name="geometry"),(function(y){return y===30})(u)){const y=js(h,a,1)[0]>>>0,T=m.complexType;T.children=new Array(y);for(let M=0;M<y;M++)T.children[M]=rP(h,a)}return m}function R$(h,a){const u={featureTables:[]},m={};m.name=nP(h,a);const y=js(h,a,1)[0]>>>0,T=js(h,a,1)[0]>>>0;m.columns=new Array(T);for(let M=0;M<T;M++)m.columns[M]=I$(h,a);return u.featureTables.push(m),[u,y]}function L$(h,a,u,m,y,T,M=!1){const R=a.scalarType.physicalType,F=mb(y,T,h,u);if(R===4)switch(F){case Ps.FLAT:{const $=Ao(h,u,y,!1);return new dS(m,$,T)}case Ps.SEQUENCE:{const $=BA(h,u,y);return new pS(m,$[0],$[1],y.numRleValues)}case Ps.CONST:{const $=vS(h,u,y,!1);return new mS(m,$,T)}}else switch(F){case Ps.FLAT:{if(M){const H=(function(K,ne,se,me){const ge=(function(ve,Ae,He){const Ie=new Float64Array(Ae);for(let Le=0;Le<Ae;Le++)Ie[Le]=v$(ve,He);return Ie})(K,se.numValues,ne);return(function(ve,Ae,He){switch(Ae.logicalLevelTechnique1){case vn.DELTA:return Ae.logicalLevelTechnique2===vn.RLE&&(ve=OA(ve,Ae.runs,Ae.numRleValues)),(function(Ie){Ie[0]=Ie[0]%2==1?(Ie[0]+1)/-2:Ie[0]/2;const Le=Ie.length/4*4;let Ke=1;if(Le>=4)for(;Ke<Le-4;Ke+=4){const nt=Ie[Ke],Ct=Ie[Ke+1],Ut=Ie[Ke+2],Bt=Ie[Ke+3];Ie[Ke]=(nt%2==1?(nt+1)/-2:nt/2)+Ie[Ke-1],Ie[Ke+1]=(Ct%2==1?(Ct+1)/-2:Ct/2)+Ie[Ke],Ie[Ke+2]=(Ut%2==1?(Ut+1)/-2:Ut/2)+Ie[Ke+1],Ie[Ke+3]=(Bt%2==1?(Bt+1)/-2:Bt/2)+Ie[Ke+2]}for(;Ke!=Ie.length;++Ke)Ie[Ke]=(Ie[Ke]%2==1?(Ie[Ke]+1)/-2:Ie[Ke]/2)+Ie[Ke-1]})(ve),ve;case vn.RLE:return(function(Ie,Le,Ke){return OA(Ie,Le.runs,Le.numRleValues)})(ve,Ae);case vn.NONE:return ve;default:throw new Error(`The specified Logical level technique is not supported: ${Ae.logicalLevelTechnique1}`)}})(ge,se)})(h,u,y);return new fS(m,H,T)}const $=$A(h,u,y,!1);return new UA(m,$,T)}case Ps.SEQUENCE:{const $=NA(h,u,y);return new jA(m,$[0],$[1],y.numRleValues)}case Ps.CONST:{const $=VA(h,u,y,!1);return new QA(m,$,T)}}throw new Error("Vector type not supported for id column.")}class k${constructor(a,u){var m;switch(this._featureData=a,this.properties=this._featureData.properties||{},(m=this._featureData.geometry)===null||m===void 0?void 0:m.type){case Is.POINT:case Is.MULTIPOINT:this.type=1;break;case Is.LINESTRING:case Is.MULTILINESTRING:this.type=2;break;case Is.POLYGON:case Is.MULTIPOLYGON:this.type=3;break;default:this.type=0}this.extent=u,this.id=Number(this._featureData.id)}loadGeometry(){const a=[];for(const u of this._featureData.geometry.coordinates){const m=[];for(const y of u)m.push(new d(y.x,y.y));a.push(m)}return a}}class D${constructor(a){this.features=[],this.featureTable=a,this.name=a.name,this.extent=a.extent,this.version=2,this.features=a.getFeatures(),this.length=this.features.length}feature(a){return new k$(this.features[a],this.extent)}}class sP{constructor(a){this.layers={};const u=(function(m,y,T=!0){const M=new _$(0),R=[];for(;M.get()<m.length;){const F=js(m,M,1)[0]>>>0,$=M.get()+F;if($>m.length)throw new Error(`Block overruns tile: ${$} > ${m.length}`);if(js(m,M,1)[0]>>>0!=1){M.set($);continue}const H=R$(m,M),K=H[1],ne=H[0].featureTables[0];let se=null,me=null;const ge=[];let ve=0;for(const He of ne.columns){const Ie=He.name;if(Ie==="id"){let Le=null;if(He.nullable){const nt=Eo(m,M),Ct=M.get(),Ut=hv(m,nt.numValues,M);M.set(Ct+nt.byteLength),Le=new uc(Ut,nt.numValues)}const Ke=Eo(m,M);ve=Ke.decompressedCount,se=L$(m,He,M,Ie,Ke,Le??ve,T)}else if(Ie==="geometry"){const Le=js(m,M,1)[0];if(ve===0){const Ke=M.get();ve=Eo(m,M).decompressedCount,M.set(Ke)}me=S$(m,Le,M,ve)}else{const Le=A$(He)?js(m,M,1)[0]:1;if(Le===0&&He.type==="scalarType")continue;const Ke=E$(m,M,He,Le,ve);if(Ke)if(Array.isArray(Ke))for(const nt of Ke)ge.push(nt);else ge.push(Ke)}}const Ae=new g$(ne.name,me,se,ge,K);R.push(Ae),M.set($)}return R})(new Uint8Array(a));this.layers=u.reduce(((m,y)=>Object.assign(Object.assign({},m),{[y.name]:new D$(y)})),{})}}class F${constructor(a,u){this.feature=a,this.type=a.type,this.properties=a.tags?a.tags:{},this.extent=u,"id"in a&&(typeof a.id=="string"?this.id=parseInt(a.id,10):typeof a.id!="number"||isNaN(a.id)||(this.id=a.id))}loadGeometry(){const a=[],u=this.feature.type===1?[this.feature.geometry]:this.feature.geometry;for(const m of u){const y=[];for(const T of m)y.push(new d(T[0],T[1]));a.push(y)}return a}}const fv="_geojsonTileLayer";function O$(h,a){a.writeVarintField(15,h.version||1),a.writeStringField(1,h.name||""),a.writeVarintField(5,h.extent||4096);const u={keys:[],values:[],keycache:{},valuecache:{}};for(let T=0;T<h.length;T++)u.feature=h.feature(T),a.writeMessage(2,z$,u);const m=u.keys;for(const T of m)a.writeStringField(3,T);const y=u.values;for(const T of y)a.writeMessage(4,$$,T)}function z$(h,a){if(!h.feature)return;const u=h.feature;u.id!==void 0&&a.writeVarintField(1,u.id),a.writeMessage(2,B$,h),a.writeVarintField(3,u.type),a.writeMessage(4,N$,u)}function B$(h,a){for(const u in h.feature?.properties){let m=h.feature.properties[u],y=h.keycache[u];if(m==null)continue;y===void 0&&(h.keys.push(u),y=h.keys.length-1,h.keycache[u]=y),a.writeVarint(y),typeof m!="string"&&typeof m!="boolean"&&typeof m!="number"&&(m=JSON.stringify(m));const T=typeof m+":"+m;let M=h.valuecache[T];M===void 0&&(h.values.push(m),M=h.values.length-1,h.valuecache[T]=M),a.writeVarint(M)}}function ES(h,a){return(a<<3)+(7&h)}function oP(h){return h<<1^h>>31}function N$(h,a){const u=h.loadGeometry(),m=h.type;let y=0,T=0;for(const M of u){let R=1;m===1&&(R=M.length),a.writeVarint(ES(1,R));const F=m===3?M.length-1:M.length;for(let $=0;$<F;$++){$===1&&m!==1&&a.writeVarint(ES(2,F-1));const H=M[$].x-y,K=M[$].y-T;a.writeVarint(oP(H)),a.writeVarint(oP(K)),y+=H,T+=K}h.type===3&&a.writeVarint(ES(7,1))}}function $$(h,a){const u=typeof h;u==="string"?a.writeStringField(1,h):u==="boolean"?a.writeBooleanField(7,h):u==="number"&&(h%1!=0?a.writeDoubleField(3,h):h<0?a.writeSVarintField(6,h):a.writeVarintField(5,h))}class aP{constructor(a,u){this.tileID=a,this.x=a.canonical.x,this.y=a.canonical.y,this.z=a.canonical.z,this.grid=new Qh(Pe,16,0),this.grid3D=new Qh(Pe,16,0),this.featureIndexArray=new Ee,this.promoteId=u}insert(a,u,m,y,T,M){const R=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(m,y,T);const F=M?this.grid3D:this.grid;for(let $=0;$<u.length;$++){const H=u[$],K=[1/0,1/0,-1/0,-1/0];for(let ne=0;ne<H.length;ne++){const se=H[ne];K[0]=Math.min(K[0],se.x),K[1]=Math.min(K[1],se.y),K[2]=Math.max(K[2],se.x),K[3]=Math.max(K[3],se.y)}K[0]<Pe&&K[1]<Pe&&K[2]>=0&&K[3]>=0&&F.insert(R,K[0],K[1],K[2],K[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=this.encoding!=="mlt"?new WE(new ab(this.rawTileData)).layers:new sP(this.rawTileData).layers,this.sourceLayerCoder=new PA(this.vtLayers?Object.keys(this.vtLayers).sort():[fv])),this.vtLayers}query(a,u,m,y){this.loadVTLayers();const T=a.params,M=Pe/a.tileSize/a.scale,R=df(T.filter,T.globalState),F=a.queryGeometry,$=a.queryPadding*M,H=Of.fromPoints(F),K=this.grid.query(H.minX-$,H.minY-$,H.maxX+$,H.maxY+$),ne=Of.fromPoints(a.cameraQueryGeometry).expandBy($),se=this.grid3D.query(ne.minX,ne.minY,ne.maxX,ne.maxY,((ve,Ae,He,Ie)=>(function(Le,Ke,nt,Ct,Ut){for(const Zt of Le)if(Ke<=Zt.x&&nt<=Zt.y&&Ct>=Zt.x&&Ut>=Zt.y)return!0;const Bt=[new d(Ke,nt),new d(Ke,Ut),new d(Ct,Ut),new d(Ct,nt)];if(Le.length>2){for(const Zt of Bt)if(bm(Le,Zt))return!0}for(let Zt=0;Zt<Le.length-1;Zt++)if(UN(Le[Zt],Le[Zt+1],Bt))return!0;return!1})(a.cameraQueryGeometry,ve-$,Ae-$,He+$,Ie+$)));for(const ve of se)K.push(ve);K.sort(V$);const me={};let ge;for(let ve=0;ve<K.length;ve++){const Ae=K[ve];if(Ae===ge)continue;ge=Ae;const He=this.featureIndexArray.get(Ae);let Ie=null;this.loadMatchingFeature(me,He.bucketIndex,He.sourceLayerIndex,He.featureIndex,R,T.layers,T.availableImages,u,m,y,((Le,Ke,nt)=>(Ie||(Ie=Yc(Le)),Ke.queryIntersectsFeature({queryGeometry:F,feature:Le,featureState:nt,geometry:Ie,zoom:this.z,transform:a.transform,pixelsToTileUnits:M,pixelPosMatrix:a.pixelPosMatrix,unwrappedTileID:this.tileID.toUnwrapped(),getElevation:a.getElevation}))))}return me}loadMatchingFeature(a,u,m,y,T,M,R,F,$,H,K){const ne=this.bucketLayerIDs[u];if(M&&!ne.some((ve=>M.has(ve))))return;const se=this.sourceLayerCoder.decode(m),me=this.vtLayers[se].feature(y);if(T.needGeometry){const ve=Kc(me,!0);if(!T.filter(new Wn(this.tileID.overscaledZ),ve,this.tileID.canonical))return}else if(!T.filter(new Wn(this.tileID.overscaledZ),me))return;const ge=this.getId(me,se);for(let ve=0;ve<ne.length;ve++){const Ae=ne[ve];if(M&&!M.has(Ae))continue;const He=F[Ae];if(!He)continue;let Ie={};ge&&H&&(Ie=H.getState(He.sourceLayer||fv,ge));const Le=Je({},$[Ae]);Le.paint=lP(Le.paint,He.paint,me,Ie,R),Le.layout=lP(Le.layout,He.layout,me,Ie,R);const Ke=!K||K(me,He,Ie);if(!Ke)continue;const nt=new IA(me,this.z,this.x,this.y,ge);nt.layer=Le;let Ct=a[Ae];Ct===void 0&&(Ct=a[Ae]=[]),Ct.push({featureIndex:y,feature:nt,intersectionZ:Ke})}}lookupSymbolFeatures(a,u,m,y,T,M,R,F){const $={};this.loadVTLayers();const H=df(T.filterSpec,T.globalState);for(const K of a)this.loadMatchingFeature($,m,y,K,H,M,R,F,u);return $}hasLayer(a){for(const u of this.bucketLayerIDs)for(const m of u)if(a===m)return!0;return!1}getId(a,u){var m;let y=a.id;return this.promoteId&&(y=a.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[u]],typeof y=="boolean"&&(y=Number(y)),y===void 0&&(!((m=a.properties)===null||m===void 0)&&m.cluster)&&this.promoteId&&(y=Number(a.properties.cluster_id))),y}}function lP(h,a,u,m,y){return yt(h,((T,M)=>{const R=a instanceof Mf?a.get(M):null;return R&&R.evaluate?R.evaluate(u,m,y):R}))}function V$(h,a){return a-h}function cP(h,a,u,m,y){const T=[];for(let M=0;M<h.length;M++){const R=h[M];let F;for(let $=0;$<R.length-1;$++){let H=R[$],K=R[$+1];H.x<a&&K.x<a||(H.x<a?H=new d(a,H.y+(a-H.x)/(K.x-H.x)*(K.y-H.y))._round():K.x<a&&(K=new d(a,H.y+(a-H.x)/(K.x-H.x)*(K.y-H.y))._round()),H.y<u&&K.y<u||(H.y<u?H=new d(H.x+(u-H.y)/(K.y-H.y)*(K.x-H.x),u)._round():K.y<u&&(K=new d(H.x+(u-H.y)/(K.y-H.y)*(K.x-H.x),u)._round()),H.x>=m&&K.x>=m||(H.x>=m?H=new d(m,H.y+(m-H.x)/(K.x-H.x)*(K.y-H.y))._round():K.x>=m&&(K=new d(m,H.y+(m-H.x)/(K.x-H.x)*(K.y-H.y))._round()),H.y>=y&&K.y>=y||(H.y>=y?H=new d(H.x+(y-H.y)/(K.y-H.y)*(K.x-H.x),y)._round():K.y>=y&&(K=new d(H.x+(y-H.y)/(K.y-H.y)*(K.x-H.x),y)._round()),F&&H.equals(F[F.length-1])||(F=[H],T.push(F)),F.push(K)))))}}return T}function uP(h,a,u,m,y){switch(a){case 1:return(function(T,M,R,F){const $=[];for(const H of T)for(const K of H){const ne=F===0?K.x:K.y;ne>=M&&ne<=R&&$.push([K])}return $})(h,u,m,y);case 2:return hP(h,u,m,y,!1);case 3:return hP(h,u,m,y,!0)}return[]}function U$(h,a,u,m,y){const T=m===0?j$:G$;let M=[];const R=[];for(let H=0;H<h.length-1;H++){const K=h[H],ne=h[H+1],se=m===0?K.x:K.y,me=m===0?ne.x:ne.y;let ge=!1;se<a?me>a&&M.push(T(K,ne,a)):se>u?me<u&&M.push(T(K,ne,u)):M.push(K),me<a&&se>=a&&(M.push(T(K,ne,a)),ge=!0),me>u&&se<=u&&(M.push(T(K,ne,u)),ge=!0),!y&&ge&&(R.push(M),M=[])}const F=h.length-1,$=m===0?h[F].x:h[F].y;return $>=a&&$<=u&&M.push(h[F]),y&&M.length>0&&!M[0].equals(M[M.length-1])&&M.push(new d(M[0].x,M[0].y)),M.length>0&&R.push(M),R}function hP(h,a,u,m,y){const T=[];for(const M of h){const R=U$(M,a,u,m,y);R.length>0&&T.push(...R)}return T}function j$(h,a,u){return new d(u,h.y+(u-h.x)/(a.x-h.x)*(a.y-h.y))}function G$(h,a,u){return new d(h.x+(u-h.y)/(a.y-h.y)*(a.x-h.x),u)}mi("FeatureIndex",aP,{omit:["rawTileData","sourceLayerCoder"]});class ad extends d{constructor(a,u,m,y){super(a,u),this.angle=m,y!==void 0&&(this.segment=y)}clone(){return new ad(this.x,this.y,this.angle,this.segment)}}function dP(h,a,u,m,y){if(a.segment===void 0||u===0)return!0;let T=a,M=a.segment+1,R=0;for(;R>-u/2;){if(M--,M<0)return!1;R-=h[M].dist(T),T=h[M]}R+=h[M].dist(h[M+1]),M++;const F=[];let $=0;for(;R<u/2;){const H=h[M],K=h[M+1];if(!K)return!1;let ne=h[M-1].angleTo(H)-H.angleTo(K);for(ne=Math.abs((ne+3*Math.PI)%(2*Math.PI)-Math.PI),F.push({distance:R,angleDelta:ne}),$+=ne;R-F[0].distance>m;)$-=F.shift().angleDelta;if($>y)return!1;M++,R+=H.dist(K)}return!0}function fP(h){let a=0;for(let u=0;u<h.length-1;u++)a+=h[u].dist(h[u+1]);return a}function pP(h,a,u){return h?.6*a*u:0}function mP(h,a){return Math.max(h?h.right-h.left:0,a?a.right-a.left:0)}function q$(h,a,u,m,y,T){const M=pP(u,y,T),R=mP(u,m)*T;let F=0;const $=fP(h)/2;for(let H=0;H<h.length-1;H++){const K=h[H],ne=h[H+1],se=K.dist(ne);if(F+se>$){const me=($-F)/se,ge=sr.number(K.x,ne.x,me),ve=sr.number(K.y,ne.y,me),Ae=new ad(ge,ve,ne.angleTo(K),H);return Ae._round(),!M||dP(h,Ae,R,M,a)?Ae:void 0}F+=se}}function W$(h,a,u,m,y,T,M,R,F){const $=pP(m,T,M),H=mP(m,y),K=H*M,ne=h[0].x===0||h[0].x===F||h[0].y===0||h[0].y===F;return a-K<a/4&&(a=K+a/4),gP(h,ne?a/2*R%a:(H/2+2*T)*M*R%a,a,$,u,K,ne,!1,F)}function gP(h,a,u,m,y,T,M,R,F){const $=T/2,H=fP(h);let K=0,ne=a-u,se=[];for(let me=0;me<h.length-1;me++){const ge=h[me],ve=h[me+1],Ae=ge.dist(ve),He=ve.angleTo(ge);for(;ne+u<K+Ae;){ne+=u;const Ie=(ne-K)/Ae,Le=sr.number(ge.x,ve.x,Ie),Ke=sr.number(ge.y,ve.y,Ie);if(Le>=0&&Le<F&&Ke>=0&&Ke<F&&ne-$>=0&&ne+$<=H){const nt=new ad(Le,Ke,He,me);nt._round(),m&&!dP(h,nt,T,m,y)||se.push(nt)}}K+=Ae}return R||se.length||M||(se=gP(h,K/2,u,m,y,T,M,!0,F)),se}function _P(h,a,u,m){const y=[],T=h.image,M=T.pixelRatio,R=T.paddedRect.w-2,F=T.paddedRect.h-2;let $={x1:h.left,y1:h.top,x2:h.right,y2:h.bottom};const H=T.stretchX||[[0,R]],K=T.stretchY||[[0,F]],ne=(Rt,fi)=>Rt+fi[1]-fi[0],se=H.reduce(ne,0),me=K.reduce(ne,0),ge=R-se,ve=F-me;let Ae=0,He=se,Ie=0,Le=me,Ke=0,nt=ge,Ct=0,Ut=ve;if(T.content&&m){const Rt=T.content,fi=Rt[2]-Rt[0],hi=Rt[3]-Rt[1];(T.textFitWidth||T.textFitHeight)&&($=dA(h)),Ae=yb(H,0,Rt[0]),Ie=yb(K,0,Rt[1]),He=yb(H,Rt[0],Rt[2]),Le=yb(K,Rt[1],Rt[3]),Ke=Rt[0]-Ae,Ct=Rt[1]-Ie,nt=fi-He,Ut=hi-Le}const Bt=$.x1,Zt=$.y1,ni=$.x2-Bt,Yt=$.y2-Zt,$t=(Rt,fi,hi,vi)=>{const ui=bb(Rt.stretch-Ae,He,ni,Bt),Ei=xb(Rt.fixed-Ke,nt,Rt.stretch,se),Tn=bb(fi.stretch-Ie,Le,Yt,Zt),dn=xb(fi.fixed-Ct,Ut,fi.stretch,me),Sr=bb(hi.stretch-Ae,He,ni,Bt),to=xb(hi.fixed-Ke,nt,hi.stretch,se),ps=bb(vi.stretch-Ie,Le,Yt,Zt),Tr=xb(vi.fixed-Ct,Ut,vi.stretch,me),gr=new d(ui,Tn),In=new d(Sr,Tn),Nr=new d(Sr,ps),Yr=new d(ui,ps),ar=new d(Ei/M,dn/M),Yo=new d(to/M,Tr/M),io=a*Math.PI/180;if(io){const Rs=Math.sin(io),Rr=Math.cos(io),ms=[Rr,-Rs,Rs,Rr];gr._matMult(ms),In._matMult(ms),Yr._matMult(ms),Nr._matMult(ms)}const Ko=Rt.stretch+Rt.fixed,Ml=fi.stretch+fi.fixed;return{tl:gr,tr:In,bl:Yr,br:Nr,tex:{x:T.paddedRect.x+1+Ko,y:T.paddedRect.y+1+Ml,w:hi.stretch+hi.fixed-Ko,h:vi.stretch+vi.fixed-Ml},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ar,pixelOffsetBR:Yo,minFontScaleX:nt/M/ni,minFontScaleY:Ut/M/Yt,isSDF:u}};if(m&&(T.stretchX||T.stretchY)){const Rt=vP(H,ge,se),fi=vP(K,ve,me);for(let hi=0;hi<Rt.length-1;hi++){const vi=Rt[hi],ui=Rt[hi+1];for(let Ei=0;Ei<fi.length-1;Ei++)y.push($t(vi,fi[Ei],ui,fi[Ei+1]))}}else y.push($t({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:R+1},{fixed:0,stretch:F+1}));return y}function yb(h,a,u){let m=0;for(const y of h)m+=Math.max(a,Math.min(u,y[1]))-Math.max(a,Math.min(u,y[0]));return m}function vP(h,a,u){const m=[{fixed:-1,stretch:0}];for(const[y,T]of h){const M=m[m.length-1];m.push({fixed:y-M.stretch,stretch:M.stretch}),m.push({fixed:y-M.stretch,stretch:M.stretch+(T-y)})}return m.push({fixed:a+1,stretch:u}),m}function bb(h,a,u,m){return h/a*u+m}function xb(h,a,u,m){return h-a*u/m}mi("Anchor",ad);class wb{constructor(a,u,m,y,T,M,R,F,$,H){var K;if(this.boxStartIndex=a.length,$){let ne=M.top,se=M.bottom;const me=M.collisionPadding;me&&(ne-=me[1],se+=me[3]);let ge=se-ne;ge>0&&(ge=Math.max(10,ge),this.circleDiameter=ge)}else{const ne=!((K=M.image)===null||K===void 0)&&K.content&&(M.image.textFitWidth||M.image.textFitHeight)?dA(M):{x1:M.left,y1:M.top,x2:M.right,y2:M.bottom};ne.y1=ne.y1*R-F[0],ne.y2=ne.y2*R+F[2],ne.x1=ne.x1*R-F[3],ne.x2=ne.x2*R+F[1];const se=M.collisionPadding;if(se&&(ne.x1-=se[0]*R,ne.y1-=se[1]*R,ne.x2+=se[2]*R,ne.y2+=se[3]*R),H){const me=new d(ne.x1,ne.y1),ge=new d(ne.x2,ne.y1),ve=new d(ne.x1,ne.y2),Ae=new d(ne.x2,ne.y2),He=H*Math.PI/180;me._rotate(He),ge._rotate(He),ve._rotate(He),Ae._rotate(He),ne.x1=Math.min(me.x,ge.x,ve.x,Ae.x),ne.x2=Math.max(me.x,ge.x,ve.x,Ae.x),ne.y1=Math.min(me.y,ge.y,ve.y,Ae.y),ne.y2=Math.max(me.y,ge.y,ve.y,Ae.y)}a.emplaceBack(u.x,u.y,ne.x1,ne.y1,ne.x2,ne.y2,m,y,T)}this.boxEndIndex=a.length}}class H${constructor(a=[],u=(m,y)=>m<y?-1:m>y?1:0){if(this.data=a,this.length=this.data.length,this.compare=u,this.length>0)for(let m=(this.length>>1)-1;m>=0;m--)this._down(m)}push(a){this.data.push(a),this._up(this.length++)}pop(){if(this.length===0)return;const a=this.data[0],u=this.data.pop();return--this.length>0&&(this.data[0]=u,this._down(0)),a}peek(){return this.data[0]}_up(a){const{data:u,compare:m}=this,y=u[a];for(;a>0;){const T=a-1>>1,M=u[T];if(m(y,M)>=0)break;u[a]=M,a=T}u[a]=y}_down(a){const{data:u,compare:m}=this,y=this.length>>1,T=u[a];for(;a<y;){let M=1+(a<<1);const R=M+1;if(R<this.length&&m(u[R],u[M])<0&&(M=R),m(u[M],T)>=0)break;u[a]=u[M],a=M}u[a]=T}}function Z$(h,a=1,u=!1){const m=Of.fromPoints(h[0]),y=Math.min(m.width(),m.height());let T=y/2;const M=new H$([],X$),{minX:R,minY:F,maxX:$,maxY:H}=m;if(y===0)return new d(R,F);for(let se=R;se<$;se+=y)for(let me=F;me<H;me+=y)M.push(new km(se+T,me+T,T,h));let K=(function(se){let me=0,ge=0,ve=0;const Ae=se[0];for(let He=0,Ie=Ae.length,Le=Ie-1;He<Ie;Le=He++){const Ke=Ae[He],nt=Ae[Le],Ct=Ke.x*nt.y-nt.x*Ke.y;ge+=(Ke.x+nt.x)*Ct,ve+=(Ke.y+nt.y)*Ct,me+=3*Ct}return new km(ge/me,ve/me,0,se)})(h),ne=M.length;for(;M.length;){const se=M.pop();(se.d>K.d||!K.d)&&(K=se,u&&console.log("found best %d after %d probes",Math.round(1e4*se.d)/1e4,ne)),se.max-K.d<=a||(T=se.h/2,M.push(new km(se.p.x-T,se.p.y-T,T,h)),M.push(new km(se.p.x+T,se.p.y-T,T,h)),M.push(new km(se.p.x-T,se.p.y+T,T,h)),M.push(new km(se.p.x+T,se.p.y+T,T,h)),ne+=4)}return u&&(console.log(`num probes: ${ne}`),console.log(`best distance: ${K.d}`)),K.p}function X$(h,a){return a.max-h.max}function km(h,a,u,m){this.p=new d(h,a),this.h=u,this.d=(function(y,T){let M=!1,R=1/0;for(let F=0;F<T.length;F++){const $=T[F];for(let H=0,K=$.length,ne=K-1;H<K;ne=H++){const se=$[H],me=$[ne];se.y>y.y!=me.y>y.y&&y.x<(me.x-se.x)*(y.y-se.y)/(me.y-se.y)+se.x&&(M=!M),R=Math.min(R,SE(y,se,me))}}return(M?1:-1)*Math.sqrt(R)})(this.p,m),this.max=this.d+this.h*Math.SQRT2}var eo;c.aP=void 0,(eo=c.aP||(c.aP={}))[eo.center=1]="center",eo[eo.left=2]="left",eo[eo.right=3]="right",eo[eo.top=4]="top",eo[eo.bottom=5]="bottom",eo[eo["top-left"]=6]="top-left",eo[eo["top-right"]=7]="top-right",eo[eo["bottom-left"]=8]="bottom-left",eo[eo["bottom-right"]=9]="bottom-right";const AS=Number.POSITIVE_INFINITY;function yP(h,a){return a[1]!==AS?(function(u,m,y){let T=0,M=0;switch(m=Math.abs(m),y=Math.abs(y),u){case"top-right":case"top-left":case"top":M=y-7;break;case"bottom-right":case"bottom-left":case"bottom":M=7-y}switch(u){case"top-right":case"bottom-right":case"right":T=-m;break;case"top-left":case"bottom-left":case"left":T=m}return[T,M]})(h,a[0],a[1]):(function(u,m){let y=0,T=0;m<0&&(m=0);const M=m/Math.SQRT2;switch(u){case"top-right":case"top-left":T=M-7;break;case"bottom-right":case"bottom-left":T=7-M;break;case"bottom":T=7-m;break;case"top":T=m-7}switch(u){case"top-right":case"bottom-right":y=-M;break;case"top-left":case"bottom-left":y=M;break;case"left":y=m;break;case"right":y=-m}return[y,T]})(h,a[0])}function bP(h,a,u){var m;const y=h.layout,T=(m=y.get("text-variable-anchor-offset"))===null||m===void 0?void 0:m.evaluate(a,{},u);if(T){const R=T.values,F=[];for(let $=0;$<R.length;$+=2){const H=F[$]=R[$],K=R[$+1].map((ne=>ne*As));H.startsWith("top")?K[1]-=7:H.startsWith("bottom")&&(K[1]+=7),F[$+1]=K}return new Ss(F)}const M=y.get("text-variable-anchor");if(M){let R;R=h._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[y.get("text-radial-offset").evaluate(a,{},u)*As,AS]:y.get("text-offset").evaluate(a,{},u).map(($=>$*As));const F=[];for(const $ of M)F.push($,yP($,R));return new Ss(F)}return null}function PS(h){switch(h){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Y$(h,a,u,m,y,T,M,R,F,$,H,K){let ne=T.textMaxSize.evaluate(a,{});ne===void 0&&(ne=M);const se=h.layers[0].layout,me=se.get("icon-offset").evaluate(a,{},H),ge=wP(u.horizontal),ve=M/24,Ae=h.tilePixelRatio*ve,He=h.tilePixelRatio*ne/24,Ie=h.tilePixelRatio*R,Le=h.tilePixelRatio*se.get("symbol-spacing"),Ke=se.get("text-padding")*h.tilePixelRatio,nt=(function(hi,vi,ui,Ei=1){const Tn=hi.get("icon-padding").evaluate(vi,{},ui),dn=Tn&&Tn.values;return[dn[0]*Ei,dn[1]*Ei,dn[2]*Ei,dn[3]*Ei]})(se,a,H,h.tilePixelRatio),Ct=se.get("text-max-angle")/180*Math.PI,Ut=se.get("text-rotation-alignment")!=="viewport"&&se.get("symbol-placement")!=="point",Bt=se.get("icon-rotation-alignment")==="map"&&se.get("symbol-placement")!=="point",Zt=se.get("symbol-placement"),ni=Le/2,Yt=se.get("icon-text-fit");let $t;m&&Yt!=="none"&&(h.allowVerticalPlacement&&u.vertical&&($t=fA(m,u.vertical,Yt,se.get("icon-text-fit-padding"),me,ve)),ge&&(m=fA(m,ge,Yt,se.get("icon-text-fit-padding"),me,ve)));const Rt=H?K.line.getGranularityForZoomLevel(H.z):1,fi=(hi,vi)=>{vi.x<0||vi.x>=Pe||vi.y<0||vi.y>=Pe||(function(ui,Ei,Tn,dn,Sr,to,ps,Tr,gr,In,Nr,Yr,ar,Yo,io,Ko,Ml,Rs,Rr,ms,$r,Ls,Ju,hc,gv){const ld=ui.addToLineVertexArray(Ei,Tn);let Nf,Dm,Fm,Om,CP=0,EP=0,AP=0,PP=0,zS=-1,BS=-1;const Qu={};let IP=Xr("");if(ui.allowVerticalPlacement&&dn.vertical){const uo=Tr.layout.get("text-rotate").evaluate($r,{},hc)+90;Fm=new wb(gr,Ei,In,Nr,Yr,dn.vertical,ar,Yo,io,uo),ps&&(Om=new wb(gr,Ei,In,Nr,Yr,ps,Ml,Rs,io,uo))}if(Sr){const uo=Tr.layout.get("icon-rotate").evaluate($r,{}),qa=Tr.layout.get("icon-text-fit")!=="none",$f=_P(Sr,uo,Ju,qa),fc=ps?_P(ps,uo,Ju,qa):void 0;Dm=new wb(gr,Ei,In,Nr,Yr,Sr,Ml,Rs,!1,uo),CP=4*$f.length;const Vf=ui.iconSizeData;let Jc=null;Vf.kind==="source"?(Jc=[Yu*Tr.layout.get("icon-size").evaluate($r,{})],Jc[0]>rd&&tt(`${ui.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Vf.kind==="composite"&&(Jc=[Yu*Ls.compositeIconSizes[0].evaluate($r,{},hc),Yu*Ls.compositeIconSizes[1].evaluate($r,{},hc)],(Jc[0]>rd||Jc[1]>rd)&&tt(`${ui.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),ui.addSymbols(ui.icon,$f,Jc,ms,Rr,$r,c.az.none,Ei,ld.lineStartIndex,ld.lineLength,-1,hc),zS=ui.icon.placedSymbolArray.length-1,fc&&(EP=4*fc.length,ui.addSymbols(ui.icon,fc,Jc,ms,Rr,$r,c.az.vertical,Ei,ld.lineStartIndex,ld.lineLength,-1,hc),BS=ui.icon.placedSymbolArray.length-1)}const RP=Object.keys(dn.horizontal);for(const uo of RP){const qa=dn.horizontal[uo];if(!Nf){IP=Xr(qa.text);const fc=Tr.layout.get("text-rotate").evaluate($r,{},hc);Nf=new wb(gr,Ei,In,Nr,Yr,qa,ar,Yo,io,fc)}const $f=qa.positionedLines.length===1;if(AP+=xP(ui,Ei,qa,to,Tr,io,$r,Ko,ld,dn.vertical?c.az.horizontal:c.az.horizontalOnly,$f?RP:[uo],Qu,zS,Ls,hc),$f)break}dn.vertical&&(PP+=xP(ui,Ei,dn.vertical,to,Tr,io,$r,Ko,ld,c.az.vertical,["vertical"],Qu,BS,Ls,hc));const Q$=Nf?Nf.boxStartIndex:ui.collisionBoxArray.length,e5=Nf?Nf.boxEndIndex:ui.collisionBoxArray.length,t5=Fm?Fm.boxStartIndex:ui.collisionBoxArray.length,i5=Fm?Fm.boxEndIndex:ui.collisionBoxArray.length,n5=Dm?Dm.boxStartIndex:ui.collisionBoxArray.length,r5=Dm?Dm.boxEndIndex:ui.collisionBoxArray.length,s5=Om?Om.boxStartIndex:ui.collisionBoxArray.length,o5=Om?Om.boxEndIndex:ui.collisionBoxArray.length;let dc=-1;const Tb=(uo,qa)=>uo&&uo.circleDiameter?Math.max(uo.circleDiameter,qa):qa;dc=Tb(Nf,dc),dc=Tb(Fm,dc),dc=Tb(Dm,dc),dc=Tb(Om,dc);const LP=dc>-1?1:0;LP&&(dc*=gv/As),ui.glyphOffsetArray.length>=Em.MAX_GLYPHS&&tt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),$r.sortKey!==void 0&&ui.addToSortKeyRanges(ui.symbolInstances.length,$r.sortKey);const a5=bP(Tr,$r,hc),[l5,c5]=(function(uo,qa){const $f=uo.length,fc=qa?.values;if(fc?.length>0)for(let Vf=0;Vf<fc.length;Vf+=2){const Jc=fc[Vf+1];uo.emplaceBack(c.aP[fc[Vf]],Jc[0],Jc[1])}return[$f,uo.length]})(ui.textAnchorOffsets,a5);ui.symbolInstances.emplaceBack(Ei.x,Ei.y,Qu.right>=0?Qu.right:-1,Qu.center>=0?Qu.center:-1,Qu.left>=0?Qu.left:-1,Qu.vertical||-1,zS,BS,IP,Q$,e5,t5,i5,n5,r5,s5,o5,In,AP,PP,CP,EP,LP,0,ar,dc,l5,c5)})(h,vi,hi,u,m,y,$t,h.layers[0],h.collisionBoxArray,a.index,a.sourceLayerIndex,h.index,Ae,[Ke,Ke,Ke,Ke],Ut,F,Ie,nt,Bt,me,a,T,$,H,M)};if(Zt==="line")for(const hi of cP(a.geometry,0,0,Pe,Pe)){const vi=Ff(hi,Rt),ui=W$(vi,Le,Ct,u.vertical||ge,m,24,He,h.overscaling,Pe);for(const Ei of ui)ge&&K$(h,ge.text,ni,Ei)||fi(vi,Ei)}else if(Zt==="line-center"){for(const hi of a.geometry)if(hi.length>1){const vi=Ff(hi,Rt),ui=q$(vi,Ct,u.vertical||ge,m,24,He);ui&&fi(vi,ui)}}else if(a.type==="Polygon")for(const hi of Gh(a.geometry,0)){const vi=Z$(hi,16);fi(Ff(hi[0],Rt,!0),new ad(vi.x,vi.y,0))}else if(a.type==="LineString")for(const hi of a.geometry){const vi=Ff(hi,Rt);fi(vi,new ad(vi[0].x,vi[0].y,0))}else if(a.type==="Point")for(const hi of a.geometry)for(const vi of hi)fi([vi],new ad(vi.x,vi.y,0))}function xP(h,a,u,m,y,T,M,R,F,$,H,K,ne,se,me){const ge=(function(He,Ie,Le,Ke,nt,Ct,Ut,Bt){const Zt=Ke.layout.get("text-rotate").evaluate(Ct,{})*Math.PI/180,ni=[];for(const Yt of Ie.positionedLines)for(const $t of Yt.positionedGlyphs){if(!$t.rect)continue;const Rt=$t.rect||{};let fi=4,hi=!0,vi=1,ui=0;const Ei=(nt||Bt)&&$t.vertical,Tn=$t.metrics.advance*$t.scale/2;if(Bt&&Ie.verticalizable&&(ui=Yt.lineOffset/2-($t.imageName?-(As-$t.metrics.width*$t.scale)/2:($t.scale-1)*As)),$t.imageName){const Rs=Ut[$t.imageName];hi=Rs.sdf,vi=Rs.pixelRatio,fi=1/vi}const dn=nt?[$t.x+Tn,$t.y]:[0,0];let Sr=nt?[0,0]:[$t.x+Tn+Le[0],$t.y+Le[1]-ui],to=[0,0];Ei&&(to=Sr,Sr=[0,0]);const ps=$t.metrics.isDoubleResolution?2:1,Tr=($t.metrics.left-fi)*$t.scale-Tn+Sr[0],gr=(-$t.metrics.top-fi)*$t.scale+Sr[1],In=Tr+Rt.w/ps*$t.scale/vi,Nr=gr+Rt.h/ps*$t.scale/vi,Yr=new d(Tr,gr),ar=new d(In,gr),Yo=new d(Tr,Nr),io=new d(In,Nr);if(Ei){const Rs=new d(-Tn,Tn- -17),Rr=-Math.PI/2,ms=12-Tn,$r=new d(22-ms,-($t.imageName?ms:0)),Ls=new d(...to);Yr._rotateAround(Rr,Rs)._add($r)._add(Ls),ar._rotateAround(Rr,Rs)._add($r)._add(Ls),Yo._rotateAround(Rr,Rs)._add($r)._add(Ls),io._rotateAround(Rr,Rs)._add($r)._add(Ls)}if(Zt){const Rs=Math.sin(Zt),Rr=Math.cos(Zt),ms=[Rr,-Rs,Rs,Rr];Yr._matMult(ms),ar._matMult(ms),Yo._matMult(ms),io._matMult(ms)}const Ko=new d(0,0),Ml=new d(0,0);ni.push({tl:Yr,tr:ar,bl:Yo,br:io,tex:Rt,writingMode:Ie.writingMode,glyphOffset:dn,sectionIndex:$t.sectionIndex,isSDF:hi,pixelOffsetTL:Ko,pixelOffsetBR:Ml,minFontScaleX:0,minFontScaleY:0})}return ni})(0,u,R,y,T,M,m,h.allowVerticalPlacement),ve=h.textSizeData;let Ae=null;ve.kind==="source"?(Ae=[Yu*y.layout.get("text-size").evaluate(M,{})],Ae[0]>rd&&tt(`${h.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):ve.kind==="composite"&&(Ae=[Yu*se.compositeTextSizes[0].evaluate(M,{},me),Yu*se.compositeTextSizes[1].evaluate(M,{},me)],(Ae[0]>rd||Ae[1]>rd)&&tt(`${h.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),h.addSymbols(h.text,ge,Ae,R,T,M,$,a,F.lineStartIndex,F.lineLength,ne,me);for(const He of H)K[He]=h.text.placedSymbolArray.length-1;return 4*ge.length}function wP(h){for(const a in h)return h[a];return null}function K$(h,a,u,m){const y=h.compareText;if(a in y){const T=y[a];for(let M=T.length-1;M>=0;M--)if(m.dist(T[M])<u)return!0}else y[a]=[];return y[a].push(m),!1}const SP=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class IS{static from(a){if(!(a instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[u,m]=new Uint8Array(a,0,2);if(u!==219)throw new Error("Data does not appear to be in a KDBush format.");const y=m>>4;if(y!==1)throw new Error(`Got v${y} data when expected v1.`);const T=SP[15&m];if(!T)throw new Error("Unrecognized array type.");const[M]=new Uint16Array(a,2,1),[R]=new Uint32Array(a,4,1);return new IS(R,M,T,a)}constructor(a,u=64,m=Float64Array,y){if(isNaN(a)||a<0)throw new Error(`Unpexpected numItems value: ${a}.`);this.numItems=+a,this.nodeSize=Math.min(Math.max(+u,2),65535),this.ArrayType=m,this.IndexArrayType=a<65536?Uint16Array:Uint32Array;const T=SP.indexOf(this.ArrayType),M=2*a*this.ArrayType.BYTES_PER_ELEMENT,R=a*this.IndexArrayType.BYTES_PER_ELEMENT,F=(8-R%8)%8;if(T<0)throw new Error(`Unexpected typed array class: ${m}.`);y&&y instanceof ArrayBuffer?(this.data=y,this.ids=new this.IndexArrayType(this.data,8,a),this.coords=new this.ArrayType(this.data,8+R+F,2*a),this._pos=2*a,this._finished=!0):(this.data=new ArrayBuffer(8+M+R+F),this.ids=new this.IndexArrayType(this.data,8,a),this.coords=new this.ArrayType(this.data,8+R+F,2*a),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+T]),new Uint16Array(this.data,2,1)[0]=u,new Uint32Array(this.data,4,1)[0]=a)}add(a,u){const m=this._pos>>1;return this.ids[m]=m,this.coords[this._pos++]=a,this.coords[this._pos++]=u,m}finish(){const a=this._pos>>1;if(a!==this.numItems)throw new Error(`Added ${a} items when expected ${this.numItems}.`);return RS(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(a,u,m,y){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:T,coords:M,nodeSize:R}=this,F=[0,T.length-1,0],$=[];for(;F.length;){const H=F.pop()||0,K=F.pop()||0,ne=F.pop()||0;if(K-ne<=R){for(let ve=ne;ve<=K;ve++){const Ae=M[2*ve],He=M[2*ve+1];Ae>=a&&Ae<=m&&He>=u&&He<=y&&$.push(T[ve])}continue}const se=ne+K>>1,me=M[2*se],ge=M[2*se+1];me>=a&&me<=m&&ge>=u&&ge<=y&&$.push(T[se]),(H===0?a<=me:u<=ge)&&(F.push(ne),F.push(se-1),F.push(1-H)),(H===0?m>=me:y>=ge)&&(F.push(se+1),F.push(K),F.push(1-H))}return $}within(a,u,m){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:y,coords:T,nodeSize:M}=this,R=[0,y.length-1,0],F=[],$=m*m;for(;R.length;){const H=R.pop()||0,K=R.pop()||0,ne=R.pop()||0;if(K-ne<=M){for(let ve=ne;ve<=K;ve++)MP(T[2*ve],T[2*ve+1],a,u)<=$&&F.push(y[ve]);continue}const se=ne+K>>1,me=T[2*se],ge=T[2*se+1];MP(me,ge,a,u)<=$&&F.push(y[se]),(H===0?a-m<=me:u-m<=ge)&&(R.push(ne),R.push(se-1),R.push(1-H)),(H===0?a+m>=me:u+m>=ge)&&(R.push(se+1),R.push(K),R.push(1-H))}return F}}function RS(h,a,u,m,y,T){if(y-m<=u)return;const M=m+y>>1;TP(h,a,M,m,y,T),RS(h,a,u,m,M-1,1-T),RS(h,a,u,M+1,y,1-T)}function TP(h,a,u,m,y,T){for(;y>m;){if(y-m>600){const $=y-m+1,H=u-m+1,K=Math.log($),ne=.5*Math.exp(2*K/3),se=.5*Math.sqrt(K*ne*($-ne)/$)*(H-$/2<0?-1:1);TP(h,a,u,Math.max(m,Math.floor(u-H*ne/$+se)),Math.min(y,Math.floor(u+($-H)*ne/$+se)),T)}const M=a[2*u+T];let R=m,F=y;for(pv(h,a,m,u),a[2*y+T]>M&&pv(h,a,m,y);R<F;){for(pv(h,a,R,F),R++,F--;a[2*R+T]<M;)R++;for(;a[2*F+T]>M;)F--}a[2*m+T]===M?pv(h,a,m,F):(F++,pv(h,a,F,y)),F<=u&&(m=F+1),u<=F&&(y=F-1)}}function pv(h,a,u,m){LS(h,u,m),LS(a,2*u,2*m),LS(a,2*u+1,2*m+1)}function LS(h,a,u){const m=h[a];h[a]=h[u],h[u]=m}function MP(h,a,u,m){const y=h-u,T=a-m;return y*y+T*T}var kS;c.cH=void 0,(kS=c.cH||(c.cH={})).create="create",kS.load="load",kS.fullLoad="fullLoad";let Sb=null,mv=[];const DS=1e3/60,FS="loadTime",OS="fullLoadTime",J$={mark(h){performance.mark(h)},frame(h){const a=h;Sb!=null&&mv.push(a-Sb),Sb=a},clearMetrics(){Sb=null,mv=[],performance.clearMeasures(FS),performance.clearMeasures(OS);for(const h in c.cH)performance.clearMarks(c.cH[h])},getPerformanceMetrics(){performance.measure(FS,c.cH.create,c.cH.load),performance.measure(OS,c.cH.create,c.cH.fullLoad);const h=performance.getEntriesByName(FS)[0].duration,a=performance.getEntriesByName(OS)[0].duration,u=mv.length,m=1/(mv.reduce(((T,M)=>T+M),0)/u/1e3),y=mv.filter((T=>T>DS)).reduce(((T,M)=>T+(M-DS)/DS),0);return{loadTime:h,fullLoadTime:a,fps:m,percentDroppedFrames:y/(u+y)*100,totalFrames:u}}};c.$=L,c.A=D,c.B=Jh,c.C=Cs,c.D=Mi,c.E=nn,c.F=function([h,a,u]){return a+=90,a*=Math.PI/180,u*=Math.PI/180,{x:h*Math.cos(a)*Math.sin(u),y:h*Math.sin(a)*Math.sin(u),z:h*Math.cos(u)}},c.G=sr,c.H=Wn,c.I=iS,c.J=V0,c.K=function(h){if(Ce==null){const a=h.navigator?h.navigator.userAgent:null;Ce=!!h.safari||!(!a||!(/\b(iPad|iPhone|iPod)\b/.test(a)||a.match("Safari")&&!a.match("Chrome")))}return Ce},c.L=class{constructor(h,a){this.target=h,this.mapId=a,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new f$((()=>this.process())),this.subscription=De(this.target,"message",(u=>this.receive(u)),!1),this.globalScope=mt(self)?h:window}registerMessageHandler(h,a){this.messageHandlers[h]=a}unregisterMessageHandler(h){delete this.messageHandlers[h]}sendAsync(h,a){return new Promise(((u,m)=>{const y=Math.round(1e18*Math.random()).toString(36).substring(0,10),T=a?De(a.signal,"abort",(()=>{T?.unsubscribe(),delete this.resolveRejects[y];const F={id:y,type:"<cancel>",origin:location.origin,targetMapId:h.targetMapId,sourceMapId:this.mapId};this.target.postMessage(F)}),p$):null;this.resolveRejects[y]={resolve:F=>{T?.unsubscribe(),u(F)},reject:F=>{T?.unsubscribe(),m(F)}};const M=[],R=Object.assign(Object.assign({},h),{id:y,sourceMapId:this.mapId,origin:location.origin,data:xf(h.data,M)});this.target.postMessage(R,{transfer:M})}))}receive(h){const a=h.data,u=a.id;if(!(a.origin!=="file://"&&location.origin!=="file://"&&a.origin!=="resource://android"&&location.origin!=="resource://android"&&a.origin!==location.origin||a.targetMapId&&this.mapId!==a.targetMapId)){if(a.type==="<cancel>"){delete this.tasks[u];const m=this.abortControllers[u];return delete this.abortControllers[u],void(m&&m.abort())}if(mt(self)||a.mustQueue)return this.tasks[u]=a,this.taskQueue.push(u),void this.invoker.trigger();this.processTask(u,a)}}process(){if(this.taskQueue.length===0)return;const h=this.taskQueue.shift(),a=this.tasks[h];delete this.tasks[h],this.taskQueue.length>0&&this.invoker.trigger(),a&&this.processTask(h,a)}processTask(h,a){return s(this,void 0,void 0,(function*(){if(a.type==="<response>"){const y=this.resolveRejects[h];return delete this.resolveRejects[h],y?void(a.error?y.reject(wf(a.error)):y.resolve(wf(a.data))):void 0}if(!this.messageHandlers[a.type])return void this.completeTask(h,new Error(`Could not find a registered handler for ${a.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const u=wf(a.data),m=new AbortController;this.abortControllers[h]=m;try{const y=yield this.messageHandlers[a.type](a.sourceMapId,u,m);this.completeTask(h,null,y)}catch(y){this.completeTask(h,y)}}))}completeTask(h,a,u){const m=[];delete this.abortControllers[h];const y={id:h,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:a?xf(a):null,data:xf(u,m)};this.target.postMessage(y,{transfer:m})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},c.M=pt,c.N=function(){var h=new D(16);return D!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=0,h[12]=0,h[13]=0,h[14]=0),h[0]=1,h[5]=1,h[10]=1,h[15]=1,h},c.O=function(h,a,u){var m,y,T,M,R,F,$,H,K,ne,se,me,ge=u[0],ve=u[1],Ae=u[2];return a===h?(h[12]=a[0]*ge+a[4]*ve+a[8]*Ae+a[12],h[13]=a[1]*ge+a[5]*ve+a[9]*Ae+a[13],h[14]=a[2]*ge+a[6]*ve+a[10]*Ae+a[14],h[15]=a[3]*ge+a[7]*ve+a[11]*Ae+a[15]):(y=a[1],T=a[2],M=a[3],R=a[4],F=a[5],$=a[6],H=a[7],K=a[8],ne=a[9],se=a[10],me=a[11],h[0]=m=a[0],h[1]=y,h[2]=T,h[3]=M,h[4]=R,h[5]=F,h[6]=$,h[7]=H,h[8]=K,h[9]=ne,h[10]=se,h[11]=me,h[12]=m*ge+R*ve+K*Ae+a[12],h[13]=y*ge+F*ve+ne*Ae+a[13],h[14]=T*ge+$*ve+se*Ae+a[14],h[15]=M*ge+H*ve+me*Ae+a[15]),h},c.P=d,c.Q=function(h,a,u){var m=u[0],y=u[1],T=u[2];return h[0]=a[0]*m,h[1]=a[1]*m,h[2]=a[2]*m,h[3]=a[3]*m,h[4]=a[4]*y,h[5]=a[5]*y,h[6]=a[6]*y,h[7]=a[7]*y,h[8]=a[8]*T,h[9]=a[9]*T,h[10]=a[10]*T,h[11]=a[11]*T,h[12]=a[12],h[13]=a[13],h[14]=a[14],h[15]=a[15],h},c.R=Xo,c.S=function(h,a,u){var m=a[0],y=a[1],T=a[2],M=a[3],R=a[4],F=a[5],$=a[6],H=a[7],K=a[8],ne=a[9],se=a[10],me=a[11],ge=a[12],ve=a[13],Ae=a[14],He=a[15],Ie=u[0],Le=u[1],Ke=u[2],nt=u[3];return h[0]=Ie*m+Le*R+Ke*K+nt*ge,h[1]=Ie*y+Le*F+Ke*ne+nt*ve,h[2]=Ie*T+Le*$+Ke*se+nt*Ae,h[3]=Ie*M+Le*H+Ke*me+nt*He,h[4]=(Ie=u[4])*m+(Le=u[5])*R+(Ke=u[6])*K+(nt=u[7])*ge,h[5]=Ie*y+Le*F+Ke*ne+nt*ve,h[6]=Ie*T+Le*$+Ke*se+nt*Ae,h[7]=Ie*M+Le*H+Ke*me+nt*He,h[8]=(Ie=u[8])*m+(Le=u[9])*R+(Ke=u[10])*K+(nt=u[11])*ge,h[9]=Ie*y+Le*F+Ke*ne+nt*ve,h[10]=Ie*T+Le*$+Ke*se+nt*Ae,h[11]=Ie*M+Le*H+Ke*me+nt*He,h[12]=(Ie=u[12])*m+(Le=u[13])*R+(Ke=u[14])*K+(nt=u[15])*ge,h[13]=Ie*y+Le*F+Ke*ne+nt*ve,h[14]=Ie*T+Le*$+Ke*se+nt*Ae,h[15]=Ie*M+Le*H+Ke*me+nt*He,h},c.T=H1,c.U=function(h,a){const u={};for(let m=0;m<a.length;m++){const y=a[m];y in h&&(u[y]=h[y])}return u},c.V=sd,c.W=Be,c.X=wA,c.Y=xA,c.Z=Re,c._=s,c.a=pe,c.a$=q,c.a0=E,c.a1=be,c.a2=ja,c.a3=TA,c.a4=hb,c.a5=Pe,c.a6=function(h,a,u){if(!h)return a||{};if(!a)return h||{};const m=AA(h),y=AA(a);(function(M,R){R.removeAll&&(M.add.clear(),M.update.clear(),M.remove.clear(),R.remove.clear());for(const F of R.remove)M.add.delete(F),M.update.delete(F);for(const[F,$]of R.update){const H=M.update.get(F);H&&(R.update.set(F,m$(H,$)),M.update.delete(F))}})(m,y);const T={};if((m.removeAll||y.removeAll)&&(T.removeAll=!0),T.remove=new Set([...m.remove,...y.remove]),T.add=new Map([...m.add,...y.add]),T.update=new Map([...m.update,...y.update]),T.remove.size&&T.add.size)for(const M of T.add.keys())T.remove.delete(M);return(function(M){const R={};return M.removeAll&&(R.removeAll=M.removeAll),M.remove&&(R.remove=Array.from(M.remove)),M.add&&(R.add=Array.from(M.add.values())),M.update&&(R.update=Array.from(M.update.values())),R})(T)},c.a7=function(h,a){const u=new Map;if(h==null||h.type==null)return u;if(h.type==="Feature"){const m=hS(h,a);return m==null?void 0:(u.set(m,h),u)}if(h.type==="FeatureCollection"){const m=new Set;for(const y of h.features){const T=hS(y,a);if(T==null||m.has(T))return;m.add(T),u.set(T,y)}return u}},c.a8=function(h,a,u){var m,y;const T=[];if(a.removeAll)h.clear();else if(a.remove)for(const M of a.remove){const R=h.get(M);R&&(T.push(R.geometry),h.delete(M))}if(a.add)for(const M of a.add){const R=hS(M,u);if(R==null)continue;const F=h.get(R);F&&T.push(F.geometry),T.push(M.geometry),h.set(R,M)}if(a.update)for(const M of a.update){const R=h.get(M.id);if(!R)continue;const F=!!M.newGeometry,$=M.removeAllProperties||((m=M.removeProperties)===null||m===void 0?void 0:m.length)>0||((y=M.addOrUpdateProperties)===null||y===void 0?void 0:y.length)>0;if(!F&&!$)continue;T.push(R.geometry);const H=Object.assign({},R);if(h.set(M.id,H),F&&(T.push(M.newGeometry),H.geometry=M.newGeometry),$){if(H.properties=M.removeAllProperties?{}:Object.assign({},H.properties||{}),M.removeProperties)for(const K of M.removeProperties)delete H.properties[K];if(M.addOrUpdateProperties)for(const{key:K,value:ne}of M.addOrUpdateProperties)H.properties[K]=ne}}return T},c.a9=uv,c.aA=function(h,{uSize:a,uSizeT:u},{lowerSize:m,upperSize:y}){return h.kind==="source"?m/Yu:h.kind==="composite"?sr.number(m/Yu,y/Yu,u):a},c.aB=function(h,a){var u=a[0],m=a[1],y=a[2],T=a[3],M=a[4],R=a[5],F=a[6],$=a[7],H=a[8],K=a[9],ne=a[10],se=a[11],me=a[12],ge=a[13],ve=a[14],Ae=a[15],He=u*R-m*M,Ie=u*F-y*M,Le=u*$-T*M,Ke=m*F-y*R,nt=m*$-T*R,Ct=y*$-T*F,Ut=H*ge-K*me,Bt=H*ve-ne*me,Zt=H*Ae-se*me,ni=K*ve-ne*ge,Yt=K*Ae-se*ge,$t=ne*Ae-se*ve,Rt=He*$t-Ie*Yt+Le*ni+Ke*Zt-nt*Bt+Ct*Ut;return Rt?(h[0]=(R*$t-F*Yt+$*ni)*(Rt=1/Rt),h[1]=(y*Yt-m*$t-T*ni)*Rt,h[2]=(ge*Ct-ve*nt+Ae*Ke)*Rt,h[3]=(ne*nt-K*Ct-se*Ke)*Rt,h[4]=(F*Zt-M*$t-$*Bt)*Rt,h[5]=(u*$t-y*Zt+T*Bt)*Rt,h[6]=(ve*Le-me*Ct-Ae*Ie)*Rt,h[7]=(H*Ct-ne*Le+se*Ie)*Rt,h[8]=(M*Yt-R*Zt+$*Ut)*Rt,h[9]=(m*Zt-u*Yt-T*Ut)*Rt,h[10]=(me*nt-ge*Le+Ae*He)*Rt,h[11]=(K*Le-H*nt-se*He)*Rt,h[12]=(R*Bt-M*ni-F*Ut)*Rt,h[13]=(u*ni-m*Bt+y*Ut)*Rt,h[14]=(ge*Ie-me*Ke-ve*He)*Rt,h[15]=(H*Ke-K*Ie+ne*He)*Rt,h):null},c.aC=ce,c.aD=function(h){var a=h[0],u=h[1];return Math.sqrt(a*a+u*u)},c.aE=function(h){return h[0]=0,h[1]=0,h},c.aF=function(h,a,u){return h[0]=a[0]*u,h[1]=a[1]*u,h},c.aG=sS,c.aH=re,c.aI=function(h,a,u,m){const y=a.y-h.y,T=a.x-h.x,M=m.y-u.y,R=m.x-u.x,F=M*T-R*y;if(F===0)return null;const $=(R*(h.y-u.y)-M*(h.x-u.x))/F;return new d(h.x+$*T,h.y+$*y)},c.aJ=cP,c.aK=ym,c.aL=function(h){let a=1/0,u=1/0,m=-1/0,y=-1/0;for(const T of h)a=Math.min(a,T.x),u=Math.min(u,T.y),m=Math.max(m,T.x),y=Math.max(y,T.y);return[a,u,m,y]},c.aM=As,c.aN=je,c.aO=function(h,a,u,m,y=!1){if(!u[0]&&!u[1])return[0,0];const T=y?m==="map"?-h.bearingInRadians:0:m==="viewport"?h.bearingInRadians:0;if(T){const M=Math.sin(T),R=Math.cos(T);u=[u[0]*R-u[1]*M,u[0]*M+u[1]*R]}return[y?u[0]:je(a,u[0],h.zoom),y?u[1]:je(a,u[1],h.zoom)]},c.aQ=rS,c.aR=PS,c.aS=nS,c.aT=IS,c.aU=Zr,c.aV=sb,c.aW=ze,c.aX=oi,c.aY=It,c.aZ=bt,c.a_=MA,c.aa=Of,c.ab=25,c.ac=uS,c.ad=h=>{const a=window.document.createElement("video");return a.muted=!0,new Promise((u=>{a.onloadstart=()=>{u(a)};for(const m of h){const y=window.document.createElement("source");zt(m)||(a.crossOrigin="Anonymous"),y.src=m,a.appendChild(y)}}))},c.ae=at,c.af=function(){return ct++},c.ag=w,c.ah=Em,c.ai=fv,c.aj=df,c.ak=Kc,c.al=IA,c.am=function(h){const a={};if(h.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((u,m,y,T)=>{const M=y||T;return a[m]=!M||M.toLowerCase(),""})),a["max-age"]){const u=parseInt(a["max-age"],10);isNaN(u)?delete a["max-age"]:a["max-age"]=u}return a},c.an=ye,c.ao=85.051129,c.ap=Xe,c.aq=function(h){return Math.pow(2,h)},c.ar=U,c.as=SA,c.at=function(h){return Math.log(h)/Math.LN2},c.au=function(h){var a=h[0],u=h[1];return a*a+u*u},c.av=function(h){if(!h.length)return new Set;const a=Math.max(...h.map((F=>F.canonical.z)));let u=1/0,m=-1/0,y=1/0,T=-1/0;const M=[];for(const F of h){const{x:$,y:H,z:K}=F.canonical,ne=Math.pow(2,a-K),se=$*ne,me=H*ne;M.push({id:F,x:se,y:me}),se<u&&(u=se),se>m&&(m=se),me<y&&(y=me),me>T&&(T=me)}const R=new Set;for(const F of M)F.x!==u&&F.x!==m&&F.y!==y&&F.y!==T||R.add(F.id);return R},c.aw=function(h,a){const u=Math.abs(2*h.wrap)-+(h.wrap<0),m=Math.abs(2*a.wrap)-+(a.wrap<0);return h.overscaledZ-a.overscaledZ||m-u||a.canonical.y-h.canonical.y||a.canonical.x-h.canonical.x},c.ax=class{constructor(h,a){this.max=h,this.onRemove=a,this.reset()}reset(){for(const h in this.data)for(const a of this.data[h])a.timeout&&clearTimeout(a.timeout),this.onRemove(a.value);return this.data={},this.order=[],this}add(h,a,u){const m=h.wrapped().key;this.data[m]===void 0&&(this.data[m]=[]);const y={value:a,timeout:void 0};if(u!==void 0&&(y.timeout=setTimeout((()=>{this.remove(h,y)}),u)),this.data[m].push(y),this.order.push(m),this.order.length>this.max){const T=this._getAndRemoveByKey(this.order[0]);T&&this.onRemove(T)}return this}has(h){return h.wrapped().key in this.data}getAndRemove(h){return this.has(h)?this._getAndRemoveByKey(h.wrapped().key):null}_getAndRemoveByKey(h){const a=this.data[h].shift();return a.timeout&&clearTimeout(a.timeout),this.data[h].length===0&&delete this.data[h],this.order.splice(this.order.indexOf(h),1),a.value}getByKey(h){const a=this.data[h];return a?a[0].value:null}get(h){return this.has(h)?this.data[h.wrapped().key][0].value:null}remove(h,a){if(!this.has(h))return this;const u=h.wrapped().key,m=a===void 0?0:this.data[u].indexOf(a),y=this.data[u][m];return this.data[u].splice(m,1),y.timeout&&clearTimeout(y.timeout),this.data[u].length===0&&delete this.data[u],this.onRemove(y.value),this.order.splice(this.order.indexOf(u),1),this}setMaxSize(h){for(this.max=h;this.order.length>this.max;){const a=this._getAndRemoveByKey(this.order[0]);a&&this.onRemove(a)}return this}filter(h){const a=[];for(const u in this.data)for(const m of this.data[u])h(m.value)||a.push(m);for(const u of a)this.remove(u.value.tileID,u)}},c.ay=function(h,a){let u=0,m=0;if(h.kind==="constant")m=h.layoutSize;else if(h.kind!=="source"){const{interpolationType:y,minZoom:T,maxZoom:M}=h,R=y?ye(yr.interpolationFactor(y,a,T,M),0,1):0;h.kind==="camera"?m=sr.number(h.minSize,h.maxSize,R):u=R}return{uSizeT:u,uSize:m}},c.b=xe,c.b$=Zu,c.b0=V,c.b1=function(h){var a=new D(3);return a[0]=h[0],a[1]=h[1],a[2]=h[2],a},c.b2=function(h,a,u){return h[0]=a[0]-u[0],h[1]=a[1]-u[1],h[2]=a[2]-u[2],h},c.b3=function(h,a){var u=a[0],m=a[1],y=a[2],T=u*u+m*m+y*y;return T>0&&(T=1/Math.sqrt(T)),h[0]=a[0]*T,h[1]=a[1]*T,h[2]=a[2]*T,h},c.b4=z,c.b5=function(h,a){return h[0]*a[0]+h[1]*a[1]+h[2]*a[2]},c.b6=function(h,a,u){return h[0]=a[0]*u[0],h[1]=a[1]*u[1],h[2]=a[2]*u[2],h[3]=a[3]*u[3],h},c.b7=G,c.b8=function(h,a,u){const m=a[0]*u[0]+a[1]*u[1]+a[2]*u[2];return m===0?null:(-(h[0]*u[0]+h[1]*u[1]+h[2]*u[2])-u[3])/m},c.b9=X,c.bA=function(h,a,u,m){return h[0]=a[0]+u[0]*m,h[1]=a[1]+u[1]*m,h[2]=a[2]+u[2]*m,h},c.bB=de,c.bC=function(h,a,u){var m=u[0],y=u[1],T=u[2],M=u[3],R=a[0],F=a[1],$=a[2],H=y*$-T*F,K=T*R-m*$,ne=m*F-y*R;return h[0]=R+M*(H+=H)+y*(ne+=ne)-T*(K+=K),h[1]=F+M*K+T*H-m*ne,h[2]=$+M*ne+m*K-y*H,h},c.bD=function(h,a,u){const m=(function(F){var $=F[3],H=F[4],K=F[5],ne=F[6],se=F[7],me=F[8];return F[0]*(me*H-K*se)+F[1]*(-me*$+K*ne)+F[2]*(se*$-H*ne)})([h[0],h[1],h[2],a[0],a[1],a[2],u[0],u[1],u[2]]);if(m===0)return null;const y=z([],[a[0],a[1],a[2]],[u[0],u[1],u[2]]),T=z([],[u[0],u[1],u[2]],[h[0],h[1],h[2]]),M=z([],[h[0],h[1],h[2]],[a[0],a[1],a[2]]),R=q([],y,-h[3]);return V(R,R,q([],T,-a[3])),V(R,R,q([],M,-u[3])),q(R,R,1/m),R},c.bE=cS,c.bF=function(){return new Float64Array(4)},c.bG=function(h,a,u,m){var y=[],T=[];return y[0]=a[0]-u[0],y[1]=a[1]-u[1],y[2]=a[2]-u[2],T[0]=y[0]*Math.cos(m)-y[1]*Math.sin(m),T[1]=y[0]*Math.sin(m)+y[1]*Math.cos(m),T[2]=y[2],h[0]=T[0]+u[0],h[1]=T[1]+u[1],h[2]=T[2]+u[2],h},c.bH=function(h,a,u,m){var y=[],T=[];return y[0]=a[0]-u[0],y[1]=a[1]-u[1],y[2]=a[2]-u[2],T[0]=y[0],T[1]=y[1]*Math.cos(m)-y[2]*Math.sin(m),T[2]=y[1]*Math.sin(m)+y[2]*Math.cos(m),h[0]=T[0]+u[0],h[1]=T[1]+u[1],h[2]=T[2]+u[2],h},c.bI=function(h,a,u,m){var y=[],T=[];return y[0]=a[0]-u[0],y[1]=a[1]-u[1],y[2]=a[2]-u[2],T[0]=y[2]*Math.sin(m)+y[0]*Math.cos(m),T[1]=y[1],T[2]=y[2]*Math.cos(m)-y[0]*Math.sin(m),h[0]=T[0]+u[0],h[1]=T[1]+u[1],h[2]=T[2]+u[2],h},c.bJ=function(h,a,u){var m=Math.sin(u),y=Math.cos(u),T=a[0],M=a[1],R=a[2],F=a[3],$=a[8],H=a[9],K=a[10],ne=a[11];return a!==h&&(h[4]=a[4],h[5]=a[5],h[6]=a[6],h[7]=a[7],h[12]=a[12],h[13]=a[13],h[14]=a[14],h[15]=a[15]),h[0]=T*y-$*m,h[1]=M*y-H*m,h[2]=R*y-K*m,h[3]=F*y-ne*m,h[8]=T*m+$*y,h[9]=M*m+H*y,h[10]=R*m+K*y,h[11]=F*m+ne*y,h},c.bK=function(h,a){const u=Fe(h,360),m=Fe(a,360),y=m-u,T=m>u?y-360:y+360;return Math.abs(y)<Math.abs(T)?y:T},c.bL=function(h){return h[0]=0,h[1]=0,h[2]=0,h},c.bM=function(h,a,u,m){const y=Math.sqrt(h*h+a*a),T=Math.sqrt(u*u+m*m);h/=y,a/=y,u/=T,m/=T;const M=Math.acos(h*u+a*m);return-a*u+h*m>0?M:-M},c.bN=function(h,a){const u=Fe(h,2*Math.PI),m=Fe(a,2*Math.PI);return Math.min(Math.abs(u-m),Math.abs(u-m+2*Math.PI),Math.abs(u-m-2*Math.PI))},c.bO=function(){const h={},a=Tt.$version;for(const u in Tt.$root){const m=Tt.$root[u];if(m.required){let y=null;y=u==="version"?a:m.type==="array"?[]:{},y!=null&&(h[u]=y)}}return h},c.bP=St,c.bQ=z_,c.bR=function h(a,u){if(Array.isArray(a)){if(!Array.isArray(u)||a.length!==u.length)return!1;for(let m=0;m<a.length;m++)if(!h(a[m],u[m]))return!1;return!0}if(typeof a=="object"&&a!==null&&u!==null){if(typeof u!="object"||Object.keys(a).length!==Object.keys(u).length)return!1;for(const m in a)if(!h(a[m],u[m]))return!1;return!0}return a===u},c.bS=function(h){h=h.slice();const a=Object.create(null);for(let u=0;u<h.length;u++)a[h[u].id]=h[u];for(let u=0;u<h.length;u++)"ref"in h[u]&&(h[u]=fr(h[u],a[h[u].ref]));return h},c.bT=function(h,a){if(h.type==="custom")return new d$(h,a);switch(h.type){case"background":return new h$(h,a);case"circle":return new XN(h,a);case"color-relief":return new t4(h,a);case"fill":return new g4(h,a);case"fill-extrusion":return new A4(h,a);case"heatmap":return new KN(h,a);case"hillshade":return new QN(h,a);case"line":return new F4(h,a);case"raster":return new B1(h,a);case"symbol":return new ub(h,a)}},c.bU=h=>h.type==="raster",c.bV=fe,c.bW=function(h,a){if(!h)return[{command:"setStyle",args:[a]}];let u=[];try{if(!Li(h.version,a.version))return[{command:"setStyle",args:[a]}];Li(h.center,a.center)||u.push({command:"setCenter",args:[a.center]}),Li(h.state,a.state)||u.push({command:"setGlobalState",args:[a.state]}),Li(h.centerAltitude,a.centerAltitude)||u.push({command:"setCenterAltitude",args:[a.centerAltitude]}),Li(h.zoom,a.zoom)||u.push({command:"setZoom",args:[a.zoom]}),Li(h.bearing,a.bearing)||u.push({command:"setBearing",args:[a.bearing]}),Li(h.pitch,a.pitch)||u.push({command:"setPitch",args:[a.pitch]}),Li(h.roll,a.roll)||u.push({command:"setRoll",args:[a.roll]}),Li(h.sprite,a.sprite)||u.push({command:"setSprite",args:[a.sprite]}),Li(h.glyphs,a.glyphs)||u.push({command:"setGlyphs",args:[a.glyphs]}),Li(h.transition,a.transition)||u.push({command:"setTransition",args:[a.transition]}),Li(h.light,a.light)||u.push({command:"setLight",args:[a.light]}),Li(h.terrain,a.terrain)||u.push({command:"setTerrain",args:[a.terrain]}),Li(h.sky,a.sky)||u.push({command:"setSky",args:[a.sky]}),Li(h.projection,a.projection)||u.push({command:"setProjection",args:[a.projection]});const m={},y=[];(function(M,R,F,$){let H;for(H in R=R||{},M=M||{})Object.prototype.hasOwnProperty.call(M,H)&&(Object.prototype.hasOwnProperty.call(R,H)||wn(H,F,$));for(H in R)Object.prototype.hasOwnProperty.call(R,H)&&(Object.prototype.hasOwnProperty.call(M,H)?Li(M[H],R[H])||(M[H].type==="geojson"&&R[H].type==="geojson"&&Sn(M,R,H)?gn(F,{command:"setGeoJSONSourceData",args:[H,R[H].data]}):kn(H,R,F,$)):zn(H,R,F))})(h.sources,a.sources,y,m);const T=[];h.layers&&h.layers.forEach((M=>{"source"in M&&m[M.source]?u.push({command:"removeLayer",args:[M.id]}):T.push(M)})),u=u.concat(y),(function(M,R,F){R=R||[];const $=(M=M||[]).map(Ye),H=R.map(Ye),K=M.reduce(kt,{}),ne=R.reduce(kt,{}),se=$.slice(),me=Object.create(null);let ge,ve,Ae,He,Ie;for(let Le=0,Ke=0;Le<$.length;Le++)ge=$[Le],Object.prototype.hasOwnProperty.call(ne,ge)?Ke++:(gn(F,{command:"removeLayer",args:[ge]}),se.splice(se.indexOf(ge,Ke),1));for(let Le=0,Ke=0;Le<H.length;Le++)ge=H[H.length-1-Le],se[se.length-1-Le]!==ge&&(Object.prototype.hasOwnProperty.call(K,ge)?(gn(F,{command:"removeLayer",args:[ge]}),se.splice(se.lastIndexOf(ge,se.length-Ke),1)):Ke++,He=se[se.length-Le],gn(F,{command:"addLayer",args:[ne[ge],He]}),se.splice(se.length-Le,0,ge),me[ge]=!0);for(let Le=0;Le<H.length;Le++)if(ge=H[Le],ve=K[ge],Ae=ne[ge],!me[ge]&&!Li(ve,Ae))if(Li(ve.source,Ae.source)&&Li(ve["source-layer"],Ae["source-layer"])&&Li(ve.type,Ae.type)){for(Ie in Kn(ve.layout,Ae.layout,F,ge,null,"setLayoutProperty"),Kn(ve.paint,Ae.paint,F,ge,null,"setPaintProperty"),Li(ve.filter,Ae.filter)||gn(F,{command:"setFilter",args:[ge,Ae.filter]}),Li(ve.minzoom,Ae.minzoom)&&Li(ve.maxzoom,Ae.maxzoom)||gn(F,{command:"setLayerZoomRange",args:[ge,Ae.minzoom,Ae.maxzoom]}),ve)Object.prototype.hasOwnProperty.call(ve,Ie)&&Ie!=="layout"&&Ie!=="paint"&&Ie!=="filter"&&Ie!=="metadata"&&Ie!=="minzoom"&&Ie!=="maxzoom"&&(Ie.indexOf("paint.")===0?Kn(ve[Ie],Ae[Ie],F,ge,Ie.slice(6),"setPaintProperty"):Li(ve[Ie],Ae[Ie])||gn(F,{command:"setLayerProperty",args:[ge,Ie,Ae[Ie]]}));for(Ie in Ae)Object.prototype.hasOwnProperty.call(Ae,Ie)&&!Object.prototype.hasOwnProperty.call(ve,Ie)&&Ie!=="layout"&&Ie!=="paint"&&Ie!=="filter"&&Ie!=="metadata"&&Ie!=="minzoom"&&Ie!=="maxzoom"&&(Ie.indexOf("paint.")===0?Kn(ve[Ie],Ae[Ie],F,ge,Ie.slice(6),"setPaintProperty"):Li(ve[Ie],Ae[Ie])||gn(F,{command:"setLayerProperty",args:[ge,Ie,Ae[Ie]]}))}else gn(F,{command:"removeLayer",args:[ge]}),He=se[se.lastIndexOf(ge)+1],gn(F,{command:"addLayer",args:[Ae,He]})})(T,a.layers,u)}catch(m){console.warn("Unable to compute style diff:",m),u=[{command:"setStyle",args:[a]}]}return u},c.bX=function(h){const a=[],u=h.id;return u===void 0&&a.push({message:`layers.${u}: missing required property "id"`}),h.render===void 0&&a.push({message:`layers.${u}: missing required method "render"`}),h.renderingMode&&h.renderingMode!=="2d"&&h.renderingMode!=="3d"&&a.push({message:`layers.${u}: property "renderingMode" must be either "2d" or "3d"`}),a},c.bY=yt,c.bZ=we,c.b_=class extends Co{constructor(h,a){super(h,a),this.current=0}set(h){this.current!==h&&(this.current=h,this.gl.uniform1i(this.location,h))}},c.ba=function(h,a,u){return h[0]=a[0]*u,h[1]=a[1]*u,h[2]=a[2]*u,h[3]=a[3]*u,h},c.bb=function(h,a){return h[0]*a[0]+h[1]*a[1]+h[2]*a[2]+h[3]},c.bc=EA,c.bd=Am,c.be=function(h,a,u,m,y){var T=1/Math.tan(a/2);if(h[0]=T/u,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=T,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,y!=null&&y!==1/0){var M=1/(m-y);h[10]=(y+m)*M,h[14]=2*y*m*M}else h[10]=-1,h[14]=-2*m;return h},c.bf=function(h){var a=new D(16);return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[3],a[4]=h[4],a[5]=h[5],a[6]=h[6],a[7]=h[7],a[8]=h[8],a[9]=h[9],a[10]=h[10],a[11]=h[11],a[12]=h[12],a[13]=h[13],a[14]=h[14],a[15]=h[15],a},c.bg=function(h,a,u){var m=Math.sin(u),y=Math.cos(u),T=a[0],M=a[1],R=a[2],F=a[3],$=a[4],H=a[5],K=a[6],ne=a[7];return a!==h&&(h[8]=a[8],h[9]=a[9],h[10]=a[10],h[11]=a[11],h[12]=a[12],h[13]=a[13],h[14]=a[14],h[15]=a[15]),h[0]=T*y+$*m,h[1]=M*y+H*m,h[2]=R*y+K*m,h[3]=F*y+ne*m,h[4]=$*y-T*m,h[5]=H*y-M*m,h[6]=K*y-R*m,h[7]=ne*y-F*m,h},c.bh=function(h,a,u){var m=Math.sin(u),y=Math.cos(u),T=a[4],M=a[5],R=a[6],F=a[7],$=a[8],H=a[9],K=a[10],ne=a[11];return a!==h&&(h[0]=a[0],h[1]=a[1],h[2]=a[2],h[3]=a[3],h[12]=a[12],h[13]=a[13],h[14]=a[14],h[15]=a[15]),h[4]=T*y+$*m,h[5]=M*y+H*m,h[6]=R*y+K*m,h[7]=F*y+ne*m,h[8]=$*y-T*m,h[9]=H*y-M*m,h[10]=K*y-R*m,h[11]=ne*y-F*m,h},c.bi=function(){const h=new Float32Array(16);return U(h),h},c.bj=function(){const h=new Float64Array(16);return U(h),h},c.bk=function(){return new Float64Array(16)},c.bl=function(h,a,u){const m=new Float64Array(4);return de(m,h,a-90,u),m},c.bm=function(h,a,u,m){var y,T,M,R,F,$=a[0],H=a[1],K=a[2],ne=a[3],se=u[0],me=u[1],ge=u[2],ve=u[3];return(T=$*se+H*me+K*ge+ne*ve)<0&&(T=-T,se=-se,me=-me,ge=-ge,ve=-ve),1-T>C?(y=Math.acos(T),M=Math.sin(y),R=Math.sin((1-m)*y)/M,F=Math.sin(m*y)/M):(R=1-m,F=m),h[0]=R*$+F*se,h[1]=R*H+F*me,h[2]=R*K+F*ge,h[3]=R*ne+F*ve,h},c.bn=function(h){const a=new Float64Array(9);(function(T,M){var R=M[0],F=M[1],$=M[2],H=M[3],K=R+R,ne=F+F,se=$+$,me=R*K,ge=F*K,ve=F*ne,Ae=$*K,He=$*ne,Ie=$*se,Le=H*K,Ke=H*ne,nt=H*se;T[0]=1-ve-Ie,T[3]=ge-nt,T[6]=Ae+Ke,T[1]=ge+nt,T[4]=1-me-Ie,T[7]=He-Le,T[2]=Ae-Ke,T[5]=He+Le,T[8]=1-me-ve})(a,h);const u=bt(-Math.asin(ye(a[2],-1,1)));let m,y;return Math.hypot(a[5],a[8])<.001?(m=0,y=-bt(Math.atan2(a[3],a[4]))):(m=bt(a[5]===0&&a[8]===0?0:Math.atan2(a[5],a[8])),y=bt(a[1]===0&&a[0]===0?0:Math.atan2(a[1],a[0]))),{roll:m,pitch:u+90,bearing:y}},c.bo=function(h,a){return h.roll==a.roll&&h.pitch==a.pitch&&h.bearing==a.bearing},c.bp=sn,c.bq=Hu,c.br=Tm,c.bs=rv,c.bt=Sm,c.bu=qe,c.bv=Ue,c.bw=$s,c.bx=function(h,a,u,m,y){return qe(m,y,ye((h-a)/(u-a),0,1))},c.by=Fe,c.bz=function(){return new Float64Array(3)},c.c=Oe,c.c$=function(h,a,u,m,y){return s(this,void 0,void 0,(function*(){if(E())try{return yield be(h,a,u,m,y)}catch{}return(function(T,M,R,F,$){const H=T.width,K=T.height;ie&&ae||(ie=new OffscreenCanvas(H,K),ae=ie.getContext("2d",{willReadFrequently:!0})),ie.width=H,ie.height=K,ae.drawImage(T,0,0,H,K);const ne=ae.getImageData(M,R,F,$);return ae.clearRect(0,0,H,K),ne.data})(h,a,u,m,y)}))},c.c0=class extends Co{constructor(h,a){super(h,a),this.current=pa}set(h){if(h[12]!==this.current[12]||h[0]!==this.current[0])return this.current=h,void this.gl.uniformMatrix4fv(this.location,!1,h);for(let a=1;a<16;a++)if(h[a]!==this.current[a]){this.current=h,this.gl.uniformMatrix4fv(this.location,!1,h);break}}},c.c1=kf,c.c2=class extends Co{constructor(h,a){super(h,a),this.current=[0,0,0]}set(h){h[0]===this.current[0]&&h[1]===this.current[1]&&h[2]===this.current[2]||(this.current=h,this.gl.uniform3f(this.location,h[0],h[1],h[2]))}},c.c3=class extends Co{constructor(h,a){super(h,a),this.current=[0,0]}set(h){h[0]===this.current[0]&&h[1]===this.current[1]||(this.current=h,this.gl.uniform2f(this.location,h[0],h[1]))}},c.c4=O,c.c5=function(h,a){var u=Math.sin(a),m=Math.cos(a);return h[0]=m,h[1]=u,h[2]=0,h[3]=-u,h[4]=m,h[5]=0,h[6]=0,h[7]=0,h[8]=1,h},c.c6=function(h,a,u){var m=a[0],y=a[1],T=a[2];return h[0]=m*u[0]+y*u[3]+T*u[6],h[1]=m*u[1]+y*u[4]+T*u[7],h[2]=m*u[2]+y*u[5]+T*u[8],h},c.c7=function(h,a,u,m,y,T,M){var R=1/(a-u),F=1/(m-y),$=1/(T-M);return h[0]=-2*R,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=-2*F,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=2*$,h[11]=0,h[12]=(a+u)*R,h[13]=(y+m)*F,h[14]=(M+T)*$,h[15]=1,h},c.c8=class extends Co{constructor(h,a){super(h,a),this.current=new Array}set(h){if(h!=this.current){this.current=h;const a=new Float32Array(4*h.length);for(let u=0;u<h.length;u++)a[4*u]=h[u].r,a[4*u+1]=h[u].g,a[4*u+2]=h[u].b,a[4*u+3]=h[u].a;this.gl.uniform4fv(this.location,a)}}},c.c9=class extends Co{constructor(h,a){super(h,a),this.current=new Array}set(h){if(h!=this.current){this.current=h;const a=new Float32Array(h);this.gl.uniform1fv(this.location,a)}}},c.cA=function(h,a){return Te[a]&&"touches"in h},c.cB=function(h){return Te[h]||te[h]},c.cC=function(h,a,u){var m=a[0],y=a[1];return h[0]=u[0]*m+u[4]*y+u[12],h[1]=u[1]*m+u[5]*y+u[13],h},c.cD=function(h,a){const{x:u,y:m}=uv.fromLngLat(a);return!(h<0||h>25||m<0||m>=1||u<0||u>=1)},c.cE=function(h,a){return h[0]=a[0],h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=a[1],h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=a[2],h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},c.cF=class extends dm{},c.cG=J$,c.cI=ot,c.cJ=function(h,a){Oe.REGISTERED_PROTOCOLS[h]=a},c.cK=function(h){delete Oe.REGISTERED_PROTOCOLS[h]},c.cL=function(h,a){const u={};for(let y=0;y<h.length;y++){const T=a&&a[h[y].id]||I0(h[y]);a&&(a[h[y].id]=T);let M=u[T];M||(M=u[T]=[]),M.push(h[y])}const m=[];for(const y in u)m.push(u[y]);return m},c.cM=mi,c.cN=PA,c.cO=aP,c.cP=uA,c.cQ=function(h){h.bucket.createArrays(),h.bucket.tilePixelRatio=Pe/(512*h.bucket.overscaling),h.bucket.compareText={},h.bucket.iconsNeedLinear=!1;const a=h.bucket.layers[0],u=a.layout,m=a._unevaluatedLayout._values,y={layoutIconSize:m["icon-size"].possiblyEvaluate(new Wn(h.bucket.zoom+1),h.canonical),layoutTextSize:m["text-size"].possiblyEvaluate(new Wn(h.bucket.zoom+1),h.canonical),textMaxSize:m["text-size"].possiblyEvaluate(new Wn(18))};if(h.bucket.textSizeData.kind==="composite"){const{minZoom:$,maxZoom:H}=h.bucket.textSizeData;y.compositeTextSizes=[m["text-size"].possiblyEvaluate(new Wn($),h.canonical),m["text-size"].possiblyEvaluate(new Wn(H),h.canonical)]}if(h.bucket.iconSizeData.kind==="composite"){const{minZoom:$,maxZoom:H}=h.bucket.iconSizeData;y.compositeIconSizes=[m["icon-size"].possiblyEvaluate(new Wn($),h.canonical),m["icon-size"].possiblyEvaluate(new Wn(H),h.canonical)]}const T=u.get("text-line-height")*As,M=u.get("text-rotation-alignment")!=="viewport"&&u.get("symbol-placement")!=="point",R=u.get("text-keep-upright"),F=u.get("text-size");for(const $ of h.bucket.features){const H=u.get("text-font").evaluate($,{},h.canonical).join(","),K=F.evaluate($,{},h.canonical),ne=y.layoutTextSize.evaluate($,{},h.canonical),se=y.layoutIconSize.evaluate($,{},h.canonical),me={horizontal:{},vertical:void 0},ge=$.text;let ve,Ae=[0,0];if(ge){const Le=ge.toString(),Ke=u.get("text-letter-spacing").evaluate($,{},h.canonical)*As,nt=O1(Le)?Ke:0,Ct=u.get("text-anchor").evaluate($,{},h.canonical),Ut=bP(a,$,h.canonical);if(!Ut){const Yt=u.get("text-radial-offset").evaluate($,{},h.canonical);Ae=Yt?yP(Ct,[Yt*As,AS]):u.get("text-offset").evaluate($,{},h.canonical).map(($t=>$t*As))}let Bt=M?"center":u.get("text-justify").evaluate($,{},h.canonical);const Zt=u.get("symbol-placement")==="point"?u.get("text-max-width").evaluate($,{},h.canonical)*As:1/0,ni=()=>{h.bucket.allowVerticalPlacement&&td(Le)&&(me.vertical=lb(ge,h.glyphMap,h.glyphPositions,h.imagePositions,H,Zt,T,Ct,"left",nt,Ae,c.az.vertical,!0,ne,K))};if(!M&&Ut){const Yt=new Set;if(Bt==="auto")for(let Rt=0;Rt<Ut.values.length;Rt+=2)Yt.add(PS(Ut.values[Rt]));else Yt.add(Bt);let $t=!1;for(const Rt of Yt)if(!me.horizontal[Rt])if($t)me.horizontal[Rt]=me.horizontal[0];else{const fi=lb(ge,h.glyphMap,h.glyphPositions,h.imagePositions,H,Zt,T,"center",Rt,nt,Ae,c.az.horizontal,!1,ne,K);fi&&(me.horizontal[Rt]=fi,$t=fi.positionedLines.length===1)}ni()}else{Bt==="auto"&&(Bt=PS(Ct));const Yt=lb(ge,h.glyphMap,h.glyphPositions,h.imagePositions,H,Zt,T,Ct,Bt,nt,Ae,c.az.horizontal,!1,ne,K);Yt&&(me.horizontal[Bt]=Yt),ni(),td(Le)&&M&&R&&(me.vertical=lb(ge,h.glyphMap,h.glyphPositions,h.imagePositions,H,Zt,T,Ct,Bt,nt,Ae,c.az.vertical,!1,ne,K))}}let He=!1;if($.icon&&$.icon.name){const Le=h.imageMap[$.icon.name];Le&&(ve=a$(h.imagePositions[$.icon.name],u.get("icon-offset").evaluate($,{},h.canonical),u.get("icon-anchor").evaluate($,{},h.canonical)),He=!!Le.sdf,h.bucket.sdfIcons===void 0?h.bucket.sdfIcons=He:h.bucket.sdfIcons!==He&&tt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Le.pixelRatio!==h.bucket.pixelRatio||u.get("icon-rotate").constantOr(1)!==0)&&(h.bucket.iconsNeedLinear=!0))}const Ie=wP(me.horizontal)||me.vertical;h.bucket.iconsInText=!!Ie&&Ie.iconsInText,(Ie||ve)&&Y$(h.bucket,$,me,ve,h.imageMap,y,ne,se,Ae,He,h.canonical,h.subdivisionGranularity)}h.showCollisionBoxes&&h.bucket.generateCollisionDebugBuffers()},c.cR=K1,c.cS=Q1,c.cT=eS,c.cU=function(h){const a=new ab;return(function(u,m){for(const y in u.layers)m.writeMessage(3,O$,u.layers[y])})(h,a),a.finish()},c.cV=function(h,a,u,m,y,T){let M=uP(h,a,u,y,0);return M=uP(M,a,m,T,1),M},c.cW=class{constructor(h){this.maxEntries=h,this.map=new Map}get(h){const a=this.map.get(h);return a!==void 0&&(this.map.delete(h),this.map.set(h,a)),a}set(h,a){if(this.map.has(h))this.map.delete(h);else if(this.map.size>=this.maxEntries){const u=this.map.keys().next().value;this.map.delete(u)}this.map.set(h,a)}clear(){this.map.clear()}},c.cX=WE,c.cY=ab,c.cZ=sP,c.c_=class{constructor(h){this._marks={start:[h.url,"start"].join("#"),end:[h.url,"end"].join("#"),measure:h.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let h=performance.getEntriesByName(this._marks.measure);return h.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),h=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),h}},c.ca=class extends qu{},c.cb=N4,c.cc=class extends Lf{},c.cd=W1,c.ce=function(h){return h<=1?1:Math.pow(2,Math.ceil(Math.log(h)/Math.LN2))},c.cf=RE,c.cg=function(h,a,u){var m=a[0],y=a[1],T=a[2],M=u[3]*m+u[7]*y+u[11]*T+u[15];return h[0]=(u[0]*m+u[4]*y+u[8]*T+u[12])/(M=M||1),h[1]=(u[1]*m+u[5]*y+u[9]*T+u[13])/M,h[2]=(u[2]*m+u[6]*y+u[10]*T+u[14])/M,h},c.ch=class extends G_{},c.ci=class extends l{},c.cj=function(h,a){return h[0]===a[0]&&h[1]===a[1]&&h[2]===a[2]&&h[3]===a[3]&&h[4]===a[4]&&h[5]===a[5]&&h[6]===a[6]&&h[7]===a[7]&&h[8]===a[8]&&h[9]===a[9]&&h[10]===a[10]&&h[11]===a[11]&&h[12]===a[12]&&h[13]===a[13]&&h[14]===a[14]&&h[15]===a[15]},c.ck=function(h,a){var u=h[0],m=h[1],y=h[2],T=h[3],M=h[4],R=h[5],F=h[6],$=h[7],H=h[8],K=h[9],ne=h[10],se=h[11],me=h[12],ge=h[13],ve=h[14],Ae=h[15],He=a[0],Ie=a[1],Le=a[2],Ke=a[3],nt=a[4],Ct=a[5],Ut=a[6],Bt=a[7],Zt=a[8],ni=a[9],Yt=a[10],$t=a[11],Rt=a[12],fi=a[13],hi=a[14],vi=a[15];return Math.abs(u-He)<=C*Math.max(1,Math.abs(u),Math.abs(He))&&Math.abs(m-Ie)<=C*Math.max(1,Math.abs(m),Math.abs(Ie))&&Math.abs(y-Le)<=C*Math.max(1,Math.abs(y),Math.abs(Le))&&Math.abs(T-Ke)<=C*Math.max(1,Math.abs(T),Math.abs(Ke))&&Math.abs(M-nt)<=C*Math.max(1,Math.abs(M),Math.abs(nt))&&Math.abs(R-Ct)<=C*Math.max(1,Math.abs(R),Math.abs(Ct))&&Math.abs(F-Ut)<=C*Math.max(1,Math.abs(F),Math.abs(Ut))&&Math.abs($-Bt)<=C*Math.max(1,Math.abs($),Math.abs(Bt))&&Math.abs(H-Zt)<=C*Math.max(1,Math.abs(H),Math.abs(Zt))&&Math.abs(K-ni)<=C*Math.max(1,Math.abs(K),Math.abs(ni))&&Math.abs(ne-Yt)<=C*Math.max(1,Math.abs(ne),Math.abs(Yt))&&Math.abs(se-$t)<=C*Math.max(1,Math.abs(se),Math.abs($t))&&Math.abs(me-Rt)<=C*Math.max(1,Math.abs(me),Math.abs(Rt))&&Math.abs(ge-fi)<=C*Math.max(1,Math.abs(ge),Math.abs(fi))&&Math.abs(ve-hi)<=C*Math.max(1,Math.abs(ve),Math.abs(hi))&&Math.abs(Ae-vi)<=C*Math.max(1,Math.abs(Ae),Math.abs(vi))},c.cl=function(h,a){return h[0]=a[0],h[1]=a[1],h[2]=a[2],h[3]=a[3],h[4]=a[4],h[5]=a[5],h[6]=a[6],h[7]=a[7],h[8]=a[8],h[9]=a[9],h[10]=a[10],h[11]=a[11],h[12]=a[12],h[13]=a[13],h[14]=a[14],h[15]=a[15],h},c.cm=h=>h.type==="symbol",c.cn=h=>h.type==="circle",c.co=h=>h.type==="heatmap",c.cp=h=>h.type==="line",c.cq=h=>h.type==="fill",c.cr=h=>h.type==="fill-extrusion",c.cs=h=>h.type==="hillshade",c.ct=h=>h.type==="color-relief",c.cu=h=>h.type==="background",c.cv=h=>h.type==="custom",c.cw=ke,c.cx=function(h,a,u){const m=Se(a.x-u.x,a.y-u.y),y=Se(h.x-u.x,h.y-u.y),T=Math.atan2(m[0]*y[1]-m[1]*y[0],(function(M,R){return M[0]*R[0]+M[1]*R[1]})(m,y));return bt(T)},c.cy=et,c.cz=function(h,a){return te[a]&&(h instanceof MouseEvent||h instanceof WheelEvent)},c.d=zt,c.d0=DE,c.d1=p,c.d2=class{constructor(h,a){this.layers={[fv]:this},this.name=fv,this.version=a?a.version:1,this.extent=a?a.extent:4096,this.length=h.length,this.features=h}feature(h){return new F$(this.features[h],this.extent)}},c.d3=hf,c.d4=Hc,c.e=Je,c.f=h=>s(void 0,void 0,void 0,(function*(){if(h.byteLength===0)return createImageBitmap(new ImageData(1,1));const a=new Blob([new Uint8Array(h)],{type:"image/png"});try{return createImageBitmap(a)}catch(u){throw new Error(`Could not load image because of ${u.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}})),c.g=ht,c.h=h=>new Promise(((a,u)=>{const m=new Image;m.onload=()=>{a(m),URL.revokeObjectURL(m.src),m.onload=null,window.requestAnimationFrame((()=>{m.src=vt}))},m.onerror=()=>u(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const y=new Blob([new Uint8Array(h)],{type:"image/png"});m.src=h.byteLength?URL.createObjectURL(y):vt})),c.i=mt,c.j=(h,a)=>Lt(Je(h,{type:"json"}),a),c.k=un,c.l=Fi,c.m=Lt,c.n=(h,a)=>Lt(Je(h,{type:"arrayBuffer"}),a),c.o=function(h){return new ab(h).readFields(Q4,[])},c.p=cA,c.q=function(h){return/[\u02EA\u02EB\u1100-\u11FF\u2E80-\u2FDF\u3000-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE4F\uFF00-\uFFEF]|\uD81B[\uDFE0-\uDFFF]|[\uD81C-\uD822\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFFF]|\uD82C[\uDC00-\uDEFB]|\uD83C[\uDE00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))},c.r=Q_,c.s=De,c.t=co,c.u=Tt,c.v=yf,c.w=tt,c.x=U_,c.y=bf,c.z=Tf})),r("worker",["./shared"],(function(c){class s{constructor(te,he){this.keyCache={},te&&this.replace(te,he)}replace(te,he){this._layerConfigs={},this._layers={},this.update(te,[],he)}update(te,he,pe){for(const Oe of te){this._layerConfigs[Oe.id]=Oe;const ht=this._layers[Oe.id]=c.bT(Oe,pe);ht._featureFilter=c.aj(ht.filter,pe),this.keyCache[Oe.id]&&delete this.keyCache[Oe.id]}for(const Oe of he)delete this.keyCache[Oe],delete this._layerConfigs[Oe],delete this._layers[Oe];this.familiesBySource={};const Re=c.cL(Object.values(this._layerConfigs),this.keyCache);for(const Oe of Re){const ht=Oe.map((Jt=>this._layers[Jt.id])),pt=ht[0];if(pt.isHidden())continue;const ot=pt.source||"";let St=this.familiesBySource[ot];St||(St=this.familiesBySource[ot]={});const Lt=pt.sourceLayer||c.ai;let zt=St[Lt];zt||(zt=St[Lt]=[]),zt.push(ht)}}}class d{constructor(te){const he={},pe=[];for(const pt in te){const ot=te[pt],St=he[pt]={};for(const Lt in ot){const zt=ot[+Lt];if(!zt||zt.bitmap.width===0||zt.bitmap.height===0)continue;const Jt={x:0,y:0,w:zt.bitmap.width+2,h:zt.bitmap.height+2};pe.push(Jt),St[Lt]={rect:Jt,metrics:zt.metrics}}}const{w:Re,h:Oe}=c.p(pe),ht=new c.r({width:Re||1,height:Oe||1});for(const pt in te){const ot=te[pt];for(const St in ot){const Lt=ot[+St];if(!Lt||Lt.bitmap.width===0||Lt.bitmap.height===0)continue;const zt=he[pt][St].rect;c.r.copy(Lt.bitmap,ht,{x:0,y:0},{x:zt.x+1,y:zt.y+1},Lt.bitmap)}}this.image=ht,this.positions=he}}c.cM("GlyphAtlas",d);class p{constructor(te){this.tileID=new c.a2(te.tileID.overscaledZ,te.tileID.wrap,te.tileID.canonical.z,te.tileID.canonical.x,te.tileID.canonical.y),this.uid=te.uid,this.zoom=te.zoom,this.pixelRatio=te.pixelRatio,this.tileSize=te.tileSize,this.source=te.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=te.showCollisionBoxes,this.collectResourceTiming=!!te.collectResourceTiming,this.returnDependencies=!!te.returnDependencies,this.promoteId=te.promoteId,this.inFlightDependencies=[]}parse(te,he,pe,Re,Oe){return c._(this,void 0,void 0,(function*(){this.status="parsing",this.data=te,this.collisionBoxArray=new c.ag;const ht=new c.cN(Object.keys(te.layers).sort()),pt=new c.cO(this.tileID,this.promoteId);pt.bucketLayerIDs=[];const ot={},St={featureIndex:pt,iconDependencies:{},patternDependencies:{},glyphDependencies:{},dashDependencies:{},availableImages:pe,subdivisionGranularity:Oe},Lt=he.familiesBySource[this.source];for(const Sn in Lt){const Kn=te.layers[Sn];if(!Kn)continue;Kn.version===1&&c.w(`Vector tile source "${this.source}" layer "${Sn}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Ye=ht.encode(Sn),kt=[];for(let at=0;at<Kn.length;at++){const Ot=Kn.feature(at),Gt=pt.getId(Ot,Sn);kt.push({feature:Ot,id:Gt,index:at,sourceLayerIndex:Ye})}for(const at of Lt[Sn]){const Ot=at[0];Ot.source!==this.source&&c.w(`layer.source = ${Ot.source} does not equal this.source = ${this.source}`),Ot.isHidden(this.zoom,!0)||(g(at,this.zoom,pe),(ot[Ot.id]=Ot.createBucket({index:pt.bucketLayerIDs.length,layers:at,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Ye,sourceID:this.source})).populate(kt,St,this.tileID.canonical),pt.bucketLayerIDs.push(at.map((Gt=>Gt.id))))}}const zt=c.bY(St.glyphDependencies,(Sn=>Object.keys(Sn).map(Number)));this.inFlightDependencies.forEach((Sn=>Sn?.abort())),this.inFlightDependencies=[];let Jt=Promise.resolve({});if(Object.keys(zt).length){const Sn=new AbortController;this.inFlightDependencies.push(Sn),Jt=Re.sendAsync({type:"GG",data:{stacks:zt,source:this.source,tileID:this.tileID,type:"glyphs"}},Sn)}const gi=Object.keys(St.iconDependencies);let Fi=Promise.resolve({});if(gi.length){const Sn=new AbortController;this.inFlightDependencies.push(Sn),Fi=Re.sendAsync({type:"GI",data:{icons:gi,source:this.source,tileID:this.tileID,type:"icons"}},Sn)}const un=Object.keys(St.patternDependencies);let nn=Promise.resolve({});if(un.length){const Sn=new AbortController;this.inFlightDependencies.push(Sn),nn=Re.sendAsync({type:"GI",data:{icons:un,source:this.source,tileID:this.tileID,type:"patterns"}},Sn)}const Tt=St.dashDependencies;let hn=Promise.resolve({});if(Object.keys(Tt).length){const Sn=new AbortController;this.inFlightDependencies.push(Sn),hn=Re.sendAsync({type:"GDA",data:{dashes:Tt}},Sn)}const[fr,Li,gn,zn]=yield Promise.all([Jt,Fi,nn,hn]),wn=new d(fr),kn=new c.cP(Li,gn);for(const Sn in ot){const Kn=ot[Sn];Kn instanceof c.ah?(g(Kn.layers,this.zoom,pe),c.cQ({bucket:Kn,glyphMap:fr,glyphPositions:wn.positions,imageMap:Li,imagePositions:kn.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:St.subdivisionGranularity})):Kn.hasDependencies&&(Kn instanceof c.cR||Kn instanceof c.cS||Kn instanceof c.cT)&&(g(Kn.layers,this.zoom,pe),Kn.addFeatures(St,this.tileID.canonical,kn.patternPositions,zn))}return this.status="done",{buckets:Object.values(ot).filter((Sn=>!Sn.isEmpty())),featureIndex:pt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:wn.image,imageAtlas:kn,dashPositions:zn,glyphMap:this.returnDependencies?fr:null,iconMap:this.returnDependencies?Li:null,glyphPositions:this.returnDependencies?wn.positions:null}}))}}function g(Te,te,he){const pe=new c.H(te);for(const Re of Te)Re.recalculate(pe,he)}class _{constructor(te,he,pe,Re,Oe){this.type=te,this.properties=pe||{},this.extent=Oe,this.pointsArray=he,this.id=Re}loadGeometry(){return this.pointsArray.map((te=>te.map((he=>new c.P(he.x,he.y)))))}}class x{constructor(te,he,pe){this.version=2,this._myFeatures=te,this.name=he,this.length=te.length,this.extent=pe}feature(te){return this._myFeatures[te]}}class b{constructor(){this.layers={}}addLayer(te){this.layers[te.name]=te}}function S(Te){let te=c.cU(Te);return te.byteOffset===0&&te.byteLength===te.buffer.byteLength||(te=new Uint8Array(te)),{vectorTile:Te,rawData:te.buffer}}function P(Te,te,he){const{extent:pe}=Te,Re=Math.pow(2,he.z-te.z),Oe=(he.x-te.x*Re)*pe,ht=(he.y-te.y*Re)*pe,pt=[];for(let ot=0;ot<Te.length;ot++){const St=Te.feature(ot);let Lt=St.loadGeometry();for(const Jt of Lt)for(const gi of Jt)gi.x=gi.x*Re-Oe,gi.y=gi.y*Re-ht;const zt=128;Lt=c.cV(Lt,St.type,-zt,-zt,pe+zt,pe+zt),Lt.length!==0&&pt.push(new _(St.type,Lt,St.properties,St.id,pe))}return new x(pt,Te.name,pe)}class L{constructor(te,he,pe){this.actor=te,this.layerIndex=he,this.availableImages=pe,this.fetching={},this.loading={},this.loaded={},this.overzoomedTileResultCache=new c.cW(1e3)}loadVectorTile(te,he){return c._(this,void 0,void 0,(function*(){const pe=yield c.n(te.request,he);try{return{vectorTile:te.encoding!=="mlt"?new c.cX(new c.cY(pe.data)):new c.cZ(pe.data),rawData:pe.data,cacheControl:pe.cacheControl,expires:pe.expires}}catch(Re){const Oe=new Uint8Array(pe.data);let ht=`Unable to parse the tile at ${te.request.url}, `;throw ht+=Oe[0]===31&&Oe[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${Re.message}`,new Error(ht)}}))}loadTile(te){return c._(this,void 0,void 0,(function*(){const{uid:he,overzoomParameters:pe}=te;pe&&(te.request=pe.overzoomRequest);const Re=!!(te&&te.request&&te.request.collectResourceTiming)&&new c.c_(te.request),Oe=new p(te);this.loading[he]=Oe;const ht=new AbortController;Oe.abort=ht;try{const pt=yield this.loadVectorTile(te,ht);if(delete this.loading[he],!pt)return null;if(pe){const Jt=this._getOverzoomTile(te,pt.vectorTile);pt.rawData=Jt.rawData,pt.vectorTile=Jt.vectorTile}const ot=pt.rawData,St={};pt.expires&&(St.expires=pt.expires),pt.cacheControl&&(St.cacheControl=pt.cacheControl);const Lt={};if(Re){const Jt=Re.finish();Jt&&(Lt.resourceTiming=JSON.parse(JSON.stringify(Jt)))}Oe.vectorTile=pt.vectorTile;const zt=Oe.parse(pt.vectorTile,this.layerIndex,this.availableImages,this.actor,te.subdivisionGranularity);this.loaded[he]=Oe,this.fetching[he]={rawTileData:ot,cacheControl:St,resourceTiming:Lt};try{const Jt=yield zt;return c.e({rawTileData:ot.slice(0),encoding:te.encoding},Jt,St,Lt)}finally{delete this.fetching[he]}}catch(pt){throw delete this.loading[he],Oe.status="done",this.loaded[he]=Oe,pt}}))}_getOverzoomTile(te,he){const{tileID:pe,source:Re,overzoomParameters:Oe}=te,{maxZoomTileID:ht}=Oe,pt=`${ht.key}_${pe.key}`,ot=this.overzoomedTileResultCache.get(pt);if(ot)return ot;const St=new b,Lt=this.layerIndex.familiesBySource[Re];for(const Jt in Lt){const gi=he.layers[Jt];if(!gi)continue;const Fi=P(gi,ht,pe.canonical);Fi.length>0&&St.addLayer(Fi)}const zt=S(St);return this.overzoomedTileResultCache.set(pt,zt),zt}reloadTile(te){return c._(this,void 0,void 0,(function*(){const he=te.uid;if(!this.loaded||!this.loaded[he])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const pe=this.loaded[he];if(pe.showCollisionBoxes=te.showCollisionBoxes,pe.status==="parsing"){const Re=yield pe.parse(pe.vectorTile,this.layerIndex,this.availableImages,this.actor,te.subdivisionGranularity);let Oe;if(this.fetching[he]){const{rawTileData:ht,cacheControl:pt,resourceTiming:ot}=this.fetching[he];delete this.fetching[he],Oe=c.e({rawTileData:ht.slice(0),encoding:te.encoding},Re,pt,ot)}else Oe=Re;return Oe}if(pe.status==="done"&&pe.vectorTile)return pe.parse(pe.vectorTile,this.layerIndex,this.availableImages,this.actor,te.subdivisionGranularity)}))}abortTile(te){return c._(this,void 0,void 0,(function*(){const he=this.loading,pe=te.uid;he&&he[pe]&&he[pe].abort&&(he[pe].abort.abort(),delete he[pe])}))}removeTile(te){return c._(this,void 0,void 0,(function*(){this.loaded&&this.loaded[te.uid]&&delete this.loaded[te.uid]}))}}class E{constructor(){this.loaded={}}loadTile(te){return c._(this,void 0,void 0,(function*(){const{uid:he,encoding:pe,rawImageData:Re,redFactor:Oe,greenFactor:ht,blueFactor:pt,baseShift:ot}=te,St=Re.width+2,Lt=Re.height+2,zt=c.b(Re)?new c.R({width:St,height:Lt},yield c.c$(Re,-1,-1,St,Lt)):Re,Jt=new c.d0(he,zt,pe,Oe,ht,pt,ot);return this.loaded=this.loaded||{},this.loaded[he]=Jt,Jt}))}removeTile(te){const he=this.loaded,pe=te.uid;he&&he[pe]&&delete he[pe]}}var C,D,O=(function(){if(D)return C;function Te(he,pe){if(he.length!==0){te(he[0],pe);for(var Re=1;Re<he.length;Re++)te(he[Re],!pe)}}function te(he,pe){for(var Re=0,Oe=0,ht=0,pt=he.length,ot=pt-1;ht<pt;ot=ht++){var St=(he[ht][0]-he[ot][0])*(he[ot][1]+he[ht][1]),Lt=Re+St;Oe+=Math.abs(Re)>=Math.abs(St)?Re-Lt+St:St-Lt+Re,Re=Lt}Re+Oe>=0!=!!pe&&he.reverse()}return D=1,C=function he(pe,Re){var Oe,ht=pe&&pe.type;if(ht==="FeatureCollection")for(Oe=0;Oe<pe.features.length;Oe++)he(pe.features[Oe],Re);else if(ht==="GeometryCollection")for(Oe=0;Oe<pe.geometries.length;Oe++)he(pe.geometries[Oe],Re);else if(ht==="Feature")he(pe.geometry,Re);else if(ht==="Polygon")Te(pe.coordinates,Re);else if(ht==="MultiPolygon")for(Oe=0;Oe<pe.coordinates.length;Oe++)Te(pe.coordinates[Oe],Re);return pe}})(),U=c.d1(O);const j={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Te=>Te},G=Math.fround||(N=new Float32Array(1),Te=>(N[0]=+Te,N[0]));var N;class V{constructor(te){this.options=Object.assign(Object.create(j),te),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(te){const{log:he,minZoom:pe,maxZoom:Re}=this.options;he&&console.time("total time");const Oe=`prepare ${te.length} points`;he&&console.time(Oe),this.points=te;const ht=[];for(let ot=0;ot<te.length;ot++){const St=te[ot];if(!St.geometry)continue;const[Lt,zt]=St.geometry.coordinates,Jt=G(Q(Lt)),gi=G(X(zt));ht.push(Jt,gi,1/0,ot,-1,1),this.options.reduce&&ht.push(0)}let pt=this.trees[Re+1]=this._createTree(ht);he&&console.timeEnd(Oe);for(let ot=Re;ot>=pe;ot--){const St=+Date.now();pt=this.trees[ot]=this._createTree(this._cluster(pt,ot)),he&&console.log("z%d: %d clusters in %dms",ot,pt.numItems,+Date.now()-St)}return he&&console.timeEnd("total time"),this}getClusters(te,he){let pe=((te[0]+180)%360+360)%360-180;const Re=Math.max(-90,Math.min(90,te[1]));let Oe=te[2]===180?180:((te[2]+180)%360+360)%360-180;const ht=Math.max(-90,Math.min(90,te[3]));if(te[2]-te[0]>=360)pe=-180,Oe=180;else if(pe>Oe){const zt=this.getClusters([pe,Re,180,ht],he),Jt=this.getClusters([-180,Re,Oe,ht],he);return zt.concat(Jt)}const pt=this.trees[this._limitZoom(he)],ot=pt.range(Q(pe),X(ht),Q(Oe),X(Re)),St=pt.data,Lt=[];for(const zt of ot){const Jt=this.stride*zt;Lt.push(St[Jt+5]>1?q(St,Jt,this.clusterProps):this.points[St[Jt+3]])}return Lt}getChildren(te){const he=this._getOriginId(te),pe=this._getOriginZoom(te),Re="No cluster with the specified id.",Oe=this.trees[pe];if(!Oe)throw new Error(Re);const ht=Oe.data;if(he*this.stride>=ht.length)throw new Error(Re);const pt=this.options.radius/(this.options.extent*Math.pow(2,pe-1)),ot=Oe.within(ht[he*this.stride],ht[he*this.stride+1],pt),St=[];for(const Lt of ot){const zt=Lt*this.stride;ht[zt+4]===te&&St.push(ht[zt+5]>1?q(ht,zt,this.clusterProps):this.points[ht[zt+3]])}if(St.length===0)throw new Error(Re);return St}getLeaves(te,he,pe){const Re=[];return this._appendLeaves(Re,te,he=he||10,pe=pe||0,0),Re}getTile(te,he,pe){const Re=this.trees[this._limitZoom(te)],Oe=Math.pow(2,te),{extent:ht,radius:pt}=this.options,ot=pt/ht,St=(pe-ot)/Oe,Lt=(pe+1+ot)/Oe,zt={features:[]};return this._addTileFeatures(Re.range((he-ot)/Oe,St,(he+1+ot)/Oe,Lt),Re.data,he,pe,Oe,zt),he===0&&this._addTileFeatures(Re.range(1-ot/Oe,St,1,Lt),Re.data,Oe,pe,Oe,zt),he===Oe-1&&this._addTileFeatures(Re.range(0,St,ot/Oe,Lt),Re.data,-1,pe,Oe,zt),zt.features.length?zt:null}getClusterExpansionZoom(te){let he=this._getOriginZoom(te)-1;for(;he<=this.options.maxZoom;){const pe=this.getChildren(te);if(he++,pe.length!==1)break;te=pe[0].properties.cluster_id}return he}_appendLeaves(te,he,pe,Re,Oe){const ht=this.getChildren(he);for(const pt of ht){const ot=pt.properties;if(ot&&ot.cluster?Oe+ot.point_count<=Re?Oe+=ot.point_count:Oe=this._appendLeaves(te,ot.cluster_id,pe,Re,Oe):Oe<Re?Oe++:te.push(pt),te.length===pe)break}return Oe}_createTree(te){const he=new c.aT(te.length/this.stride|0,this.options.nodeSize,Float32Array);for(let pe=0;pe<te.length;pe+=this.stride)he.add(te[pe],te[pe+1]);return he.finish(),he.data=te,he}_addTileFeatures(te,he,pe,Re,Oe,ht){for(const pt of te){const ot=pt*this.stride,St=he[ot+5]>1;let Lt,zt,Jt;if(St)Lt=z(he,ot,this.clusterProps),zt=he[ot],Jt=he[ot+1];else{const un=this.points[he[ot+3]];Lt=un.properties;const[nn,Tt]=un.geometry.coordinates;zt=Q(nn),Jt=X(Tt)}const gi={type:1,geometry:[[Math.round(this.options.extent*(zt*Oe-pe)),Math.round(this.options.extent*(Jt*Oe-Re))]],tags:Lt};let Fi;Fi=St||this.options.generateId?he[ot+3]:this.points[he[ot+3]].id,Fi!==void 0&&(gi.id=Fi),ht.features.push(gi)}}_limitZoom(te){return Math.max(this.options.minZoom,Math.min(Math.floor(+te),this.options.maxZoom+1))}_cluster(te,he){const{radius:pe,extent:Re,reduce:Oe,minPoints:ht}=this.options,pt=pe/(Re*Math.pow(2,he)),ot=te.data,St=[],Lt=this.stride;for(let zt=0;zt<ot.length;zt+=Lt){if(ot[zt+2]<=he)continue;ot[zt+2]=he;const Jt=ot[zt],gi=ot[zt+1],Fi=te.within(ot[zt],ot[zt+1],pt),un=ot[zt+5];let nn=un;for(const Tt of Fi){const hn=Tt*Lt;ot[hn+2]>he&&(nn+=ot[hn+5])}if(nn>un&&nn>=ht){let Tt,hn=Jt*un,fr=gi*un,Li=-1;const gn=(zt/Lt<<5)+(he+1)+this.points.length;for(const zn of Fi){const wn=zn*Lt;if(ot[wn+2]<=he)continue;ot[wn+2]=he;const kn=ot[wn+5];hn+=ot[wn]*kn,fr+=ot[wn+1]*kn,ot[wn+4]=gn,Oe&&(Tt||(Tt=this._map(ot,zt,!0),Li=this.clusterProps.length,this.clusterProps.push(Tt)),Oe(Tt,this._map(ot,wn)))}ot[zt+4]=gn,St.push(hn/nn,fr/nn,1/0,gn,-1,nn),Oe&&St.push(Li)}else{for(let Tt=0;Tt<Lt;Tt++)St.push(ot[zt+Tt]);if(nn>1)for(const Tt of Fi){const hn=Tt*Lt;if(!(ot[hn+2]<=he)){ot[hn+2]=he;for(let fr=0;fr<Lt;fr++)St.push(ot[hn+fr])}}}}return St}_getOriginId(te){return te-this.points.length>>5}_getOriginZoom(te){return(te-this.points.length)%32}_map(te,he,pe){if(te[he+5]>1){const ht=this.clusterProps[te[he+6]];return pe?Object.assign({},ht):ht}const Re=this.points[te[he+3]].properties,Oe=this.options.map(Re);return pe&&Oe===Re?Object.assign({},Oe):Oe}}function q(Te,te,he){return{type:"Feature",id:Te[te+3],properties:z(Te,te,he),geometry:{type:"Point",coordinates:[(pe=Te[te],360*(pe-.5)),re(Te[te+1])]}};var pe}function z(Te,te,he){const pe=Te[te+5],Re=pe>=1e4?`${Math.round(pe/1e3)}k`:pe>=1e3?Math.round(pe/100)/10+"k":pe,Oe=Te[te+6],ht=Oe===-1?{}:Object.assign({},he[Oe]);return Object.assign(ht,{cluster:!0,cluster_id:Te[te+3],point_count:pe,point_count_abbreviated:Re})}function Q(Te){return Te/360+.5}function X(Te){const te=Math.sin(Te*Math.PI/180),he=.5-.25*Math.log((1+te)/(1-te))/Math.PI;return he<0?0:he>1?1:he}function re(Te){const te=(180-360*Te)*Math.PI/180;return 360*Math.atan(Math.exp(te))/Math.PI-90}function oe(Te,te,he,pe){let Re=pe;const Oe=te+(he-te>>1);let ht,pt=he-te;const ot=Te[te],St=Te[te+1],Lt=Te[he],zt=Te[he+1];for(let Jt=te+3;Jt<he;Jt+=3){const gi=de(Te[Jt],Te[Jt+1],ot,St,Lt,zt);if(gi>Re)ht=Jt,Re=gi;else if(gi===Re){const Fi=Math.abs(Jt-Oe);Fi<pt&&(ht=Jt,pt=Fi)}}Re>pe&&(ht-te>3&&oe(Te,te,ht,pe),Te[ht+2]=Re,he-ht>3&&oe(Te,ht,he,pe))}function de(Te,te,he,pe,Re,Oe){let ht=Re-he,pt=Oe-pe;if(ht!==0||pt!==0){const ot=((Te-he)*ht+(te-pe)*pt)/(ht*ht+pt*pt);ot>1?(he=Re,pe=Oe):ot>0&&(he+=ht*ot,pe+=pt*ot)}return ht=Te-he,pt=te-pe,ht*ht+pt*pt}function ce(Te,te,he,pe){const Re={id:Te??null,type:te,geometry:he,tags:pe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(te==="Point"||te==="MultiPoint"||te==="LineString")Se(Re,he);else if(te==="Polygon")Se(Re,he[0]);else if(te==="MultiLineString")for(const Oe of he)Se(Re,Oe);else if(te==="MultiPolygon")for(const Oe of he)Se(Re,Oe[0]);return Re}function Se(Te,te){for(let he=0;he<te.length;he+=3)Te.minX=Math.min(Te.minX,te[he]),Te.minY=Math.min(Te.minY,te[he+1]),Te.maxX=Math.max(Te.maxX,te[he]),Te.maxY=Math.max(Te.maxY,te[he+1])}function Pe(Te,te,he,pe){if(!te.geometry)return;const Re=te.geometry.coordinates;if(Re&&Re.length===0)return;const Oe=te.geometry.type,ht=Math.pow(he.tolerance/((1<<he.maxZoom)*he.extent),2);let pt=[],ot=te.id;if(he.promoteId?ot=te.properties[he.promoteId]:he.generateId&&(ot=pe||0),Oe==="Point")je(Re,pt);else if(Oe==="MultiPoint")for(const St of Re)je(St,pt);else if(Oe==="LineString")Fe(Re,pt,ht,!1);else if(Oe==="MultiLineString"){if(he.lineMetrics){for(const St of Re)pt=[],Fe(St,pt,ht,!1),Te.push(ce(ot,"LineString",pt,te.properties));return}qe(Re,pt,ht,!1)}else if(Oe==="Polygon")qe(Re,pt,ht,!0);else{if(Oe!=="MultiPolygon"){if(Oe==="GeometryCollection"){for(const St of te.geometry.geometries)Pe(Te,{id:ot,geometry:St,properties:te.properties},he,pe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const St of Re){const Lt=[];qe(St,Lt,ht,!0),pt.push(Lt)}}Te.push(ce(ot,Oe,pt,te.properties))}function je(Te,te){te.push(Ue(Te[0]),ke(Te[1]),0)}function Fe(Te,te,he,pe){let Re,Oe,ht=0;for(let ot=0;ot<Te.length;ot++){const St=Ue(Te[ot][0]),Lt=ke(Te[ot][1]);te.push(St,Lt,0),ot>0&&(ht+=pe?(Re*Lt-St*Oe)/2:Math.sqrt(Math.pow(St-Re,2)+Math.pow(Lt-Oe,2))),Re=St,Oe=Lt}const pt=te.length-3;te[2]=1,oe(te,0,pt,he),te[pt+2]=1,te.size=Math.abs(ht),te.start=0,te.end=te.size}function qe(Te,te,he,pe){for(let Re=0;Re<Te.length;Re++){const Oe=[];Fe(Te[Re],Oe,he,pe),te.push(Oe)}}function Ue(Te){return Te/360+.5}function ke(Te){const te=Math.sin(Te*Math.PI/180),he=.5-.25*Math.log((1+te)/(1-te))/Math.PI;return he<0?0:he>1?1:he}function et(Te,te,he,pe,Re,Oe,ht,pt){if(pe/=te,Oe>=(he/=te)&&ht<pe)return Te;if(ht<he||Oe>=pe)return null;const ot=[];for(const St of Te){const Lt=St.geometry;let zt=St.type;const Jt=Re===0?St.minX:St.minY,gi=Re===0?St.maxX:St.maxY;if(Jt>=he&&gi<pe){ot.push(St);continue}if(gi<he||Jt>=pe)continue;let Fi=[];if(zt==="Point"||zt==="MultiPoint")ye(Lt,Fi,he,pe,Re);else if(zt==="LineString")Be(Lt,Fi,he,pe,Re,!1,pt.lineMetrics);else if(zt==="MultiLineString")ct(Lt,Fi,he,pe,Re,!1);else if(zt==="Polygon")ct(Lt,Fi,he,pe,Re,!0);else if(zt==="MultiPolygon")for(const un of Lt){const nn=[];ct(un,nn,he,pe,Re,!0),nn.length&&Fi.push(nn)}if(Fi.length){if(pt.lineMetrics&&zt==="LineString"){for(const un of Fi)ot.push(ce(St.id,zt,un,St.tags));continue}zt!=="LineString"&&zt!=="MultiLineString"||(Fi.length===1?(zt="LineString",Fi=Fi[0]):zt="MultiLineString"),zt!=="Point"&&zt!=="MultiPoint"||(zt=Fi.length===3?"Point":"MultiPoint"),ot.push(ce(St.id,zt,Fi,St.tags))}}return ot.length?ot:null}function ye(Te,te,he,pe,Re){for(let Oe=0;Oe<Te.length;Oe+=3){const ht=Te[Oe+Re];ht>=he&&ht<=pe&&yt(te,Te[Oe],Te[Oe+1],Te[Oe+2])}}function Be(Te,te,he,pe,Re,Oe,ht){let pt=Je(Te);const ot=Re===0?we:fe;let St,Lt,zt=Te.start;for(let nn=0;nn<Te.length-3;nn+=3){const Tt=Te[nn],hn=Te[nn+1],fr=Te[nn+2],Li=Te[nn+3],gn=Te[nn+4],zn=Re===0?Tt:hn,wn=Re===0?Li:gn;let kn=!1;ht&&(St=Math.sqrt(Math.pow(Tt-Li,2)+Math.pow(hn-gn,2))),zn<he?wn>he&&(Lt=ot(pt,Tt,hn,Li,gn,he),ht&&(pt.start=zt+St*Lt)):zn>pe?wn<pe&&(Lt=ot(pt,Tt,hn,Li,gn,pe),ht&&(pt.start=zt+St*Lt)):yt(pt,Tt,hn,fr),wn<he&&zn>=he&&(Lt=ot(pt,Tt,hn,Li,gn,he),kn=!0),wn>pe&&zn<=pe&&(Lt=ot(pt,Tt,hn,Li,gn,pe),kn=!0),!Oe&&kn&&(ht&&(pt.end=zt+St*Lt),te.push(pt),pt=Je(Te)),ht&&(zt+=St)}let Jt=Te.length-3;const gi=Te[Jt],Fi=Te[Jt+1],un=Re===0?gi:Fi;un>=he&&un<=pe&&yt(pt,gi,Fi,Te[Jt+2]),Jt=pt.length-3,Oe&&Jt>=3&&(pt[Jt]!==pt[0]||pt[Jt+1]!==pt[1])&&yt(pt,pt[0],pt[1],pt[2]),pt.length&&te.push(pt)}function Je(Te){const te=[];return te.size=Te.size,te.start=Te.start,te.end=Te.end,te}function ct(Te,te,he,pe,Re,Oe){for(const ht of Te)Be(ht,te,he,pe,Re,Oe,!1)}function yt(Te,te,he,pe){Te.push(te,he,pe)}function we(Te,te,he,pe,Re,Oe){const ht=(Oe-te)/(pe-te);return yt(Te,Oe,he+(Re-he)*ht,1),ht}function fe(Te,te,he,pe,Re,Oe){const ht=(Oe-he)/(Re-he);return yt(Te,te+(pe-te)*ht,Oe,1),ht}function Ve(Te,te){const he=[];for(let pe=0;pe<Te.length;pe++){const Re=Te[pe],Oe=Re.type;let ht;if(Oe==="Point"||Oe==="MultiPoint"||Oe==="LineString")ht=tt(Re.geometry,te);else if(Oe==="MultiLineString"||Oe==="Polygon"){ht=[];for(const pt of Re.geometry)ht.push(tt(pt,te))}else if(Oe==="MultiPolygon"){ht=[];for(const pt of Re.geometry){const ot=[];for(const St of pt)ot.push(tt(St,te));ht.push(ot)}}he.push(ce(Re.id,Oe,ht,Re.tags))}return he}function tt(Te,te){const he=[];he.size=Te.size,Te.start!==void 0&&(he.start=Te.start,he.end=Te.end);for(let pe=0;pe<Te.length;pe+=3)he.push(Te[pe]+te,Te[pe+1],Te[pe+2]);return he}function Mt(Te,te){if(Te.transformed)return Te;const he=1<<Te.z,pe=Te.x,Re=Te.y;for(const Oe of Te.features){const ht=Oe.geometry,pt=Oe.type;if(Oe.geometry=[],pt===1)for(let ot=0;ot<ht.length;ot+=2)Oe.geometry.push(mt(ht[ot],ht[ot+1],te,he,pe,Re));else for(let ot=0;ot<ht.length;ot++){const St=[];for(let Lt=0;Lt<ht[ot].length;Lt+=2)St.push(mt(ht[ot][Lt],ht[ot][Lt+1],te,he,pe,Re));Oe.geometry.push(St)}}return Te.transformed=!0,Te}function mt(Te,te,he,pe,Re,Oe){return[Math.round(he*(Te*pe-Re)),Math.round(he*(te*pe-Oe))]}function Ce(Te,te,he,pe,Re){const Oe=te===Re.maxZoom?0:Re.tolerance/((1<<te)*Re.extent),ht={features:[],numPoints:0,numSimplified:0,numFeatures:Te.length,source:null,x:he,y:pe,z:te,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const pt of Te)xe(ht,pt,Oe,Re);return ht}function xe(Te,te,he,pe){const Re=te.geometry,Oe=te.type,ht=[];if(Te.minX=Math.min(Te.minX,te.minX),Te.minY=Math.min(Te.minY,te.minY),Te.maxX=Math.max(Te.maxX,te.maxX),Te.maxY=Math.max(Te.maxY,te.maxY),Oe==="Point"||Oe==="MultiPoint")for(let pt=0;pt<Re.length;pt+=3)ht.push(Re[pt],Re[pt+1]),Te.numPoints++,Te.numSimplified++;else if(Oe==="LineString")vt(ht,Re,Te,he,!1,!1);else if(Oe==="MultiLineString"||Oe==="Polygon")for(let pt=0;pt<Re.length;pt++)vt(ht,Re[pt],Te,he,Oe==="Polygon",pt===0);else if(Oe==="MultiPolygon")for(let pt=0;pt<Re.length;pt++){const ot=Re[pt];for(let St=0;St<ot.length;St++)vt(ht,ot[St],Te,he,!0,St===0)}if(ht.length){let pt=te.tags||null;if(Oe==="LineString"&&pe.lineMetrics){pt={};for(const St in te.tags)pt[St]=te.tags[St];pt.mapbox_clip_start=Re.start/Re.size,pt.mapbox_clip_end=Re.end/Re.size}const ot={geometry:ht,type:Oe==="Polygon"||Oe==="MultiPolygon"?3:Oe==="LineString"||Oe==="MultiLineString"?2:1,tags:pt};te.id!==null&&(ot.id=te.id),Te.features.push(ot)}}function vt(Te,te,he,pe,Re,Oe){const ht=pe*pe;if(pe>0&&te.size<(Re?ht:pe))return void(he.numPoints+=te.length/3);const pt=[];for(let ot=0;ot<te.length;ot+=3)(pe===0||te[ot+2]>ht)&&(he.numSimplified++,pt.push(te[ot],te[ot+1])),he.numPoints++;Re&&(function(ot,St){let Lt=0;for(let zt=0,Jt=ot.length,gi=Jt-2;zt<Jt;gi=zt,zt+=2)Lt+=(ot[zt]-ot[gi])*(ot[zt+1]+ot[gi+1]);if(Lt>0===St)for(let zt=0,Jt=ot.length;zt<Jt/2;zt+=2){const gi=ot[zt],Fi=ot[zt+1];ot[zt]=ot[Jt-2-zt],ot[zt+1]=ot[Jt-1-zt],ot[Jt-2-zt]=gi,ot[Jt-1-zt]=Fi}})(pt,Oe),Te.push(pt)}const be={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class ie{constructor(te,he){const pe=(he=this.options=(function(Oe,ht){for(const pt in ht)Oe[pt]=ht[pt];return Oe})(Object.create(be),he)).debug;if(pe&&console.time("preprocess data"),he.maxZoom<0||he.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(he.promoteId&&he.generateId)throw new Error("promoteId and generateId cannot be used together.");let Re=(function(Oe,ht){const pt=[];if(Oe.type==="FeatureCollection")for(let ot=0;ot<Oe.features.length;ot++)Pe(pt,Oe.features[ot],ht,ot);else Pe(pt,Oe.type==="Feature"?Oe:{geometry:Oe},ht);return pt})(te,he);this.tiles={},this.tileCoords=[],pe&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",he.indexMaxZoom,he.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Re=(function(Oe,ht){const pt=ht.buffer/ht.extent;let ot=Oe;const St=et(Oe,1,-1-pt,pt,0,-1,2,ht),Lt=et(Oe,1,1-pt,2+pt,0,-1,2,ht);return(St||Lt)&&(ot=et(Oe,1,-pt,1+pt,0,-1,2,ht)||[],St&&(ot=Ve(St,1).concat(ot)),Lt&&(ot=ot.concat(Ve(Lt,-1)))),ot})(Re,he),Re.length&&this.splitTile(Re,0,0,0),pe&&(Re.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(te,he,pe,Re,Oe,ht,pt){const ot=[te,he,pe,Re],St=this.options,Lt=St.debug;for(;ot.length;){Re=ot.pop(),pe=ot.pop(),he=ot.pop(),te=ot.pop();const zt=1<<he,Jt=ae(he,pe,Re);let gi=this.tiles[Jt];if(!gi&&(Lt>1&&console.time("creation"),gi=this.tiles[Jt]=Ce(te,he,pe,Re,St),this.tileCoords.push({z:he,x:pe,y:Re}),Lt)){Lt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",he,pe,Re,gi.numFeatures,gi.numPoints,gi.numSimplified),console.timeEnd("creation"));const kn=`z${he}`;this.stats[kn]=(this.stats[kn]||0)+1,this.total++}if(gi.source=te,Oe==null){if(he===St.indexMaxZoom||gi.numPoints<=St.indexMaxPoints)continue}else{if(he===St.maxZoom||he===Oe)continue;if(Oe!=null){const kn=Oe-he;if(pe!==ht>>kn||Re!==pt>>kn)continue}}if(gi.source=null,te.length===0)continue;Lt>1&&console.time("clipping");const Fi=.5*St.buffer/St.extent,un=.5-Fi,nn=.5+Fi,Tt=1+Fi;let hn=null,fr=null,Li=null,gn=null,zn=et(te,zt,pe-Fi,pe+nn,0,gi.minX,gi.maxX,St),wn=et(te,zt,pe+un,pe+Tt,0,gi.minX,gi.maxX,St);te=null,zn&&(hn=et(zn,zt,Re-Fi,Re+nn,1,gi.minY,gi.maxY,St),fr=et(zn,zt,Re+un,Re+Tt,1,gi.minY,gi.maxY,St),zn=null),wn&&(Li=et(wn,zt,Re-Fi,Re+nn,1,gi.minY,gi.maxY,St),gn=et(wn,zt,Re+un,Re+Tt,1,gi.minY,gi.maxY,St),wn=null),Lt>1&&console.timeEnd("clipping"),ot.push(hn||[],he+1,2*pe,2*Re),ot.push(fr||[],he+1,2*pe,2*Re+1),ot.push(Li||[],he+1,2*pe+1,2*Re),ot.push(gn||[],he+1,2*pe+1,2*Re+1)}}getTile(te,he,pe){te=+te,he=+he,pe=+pe;const Re=this.options,{extent:Oe,debug:ht}=Re;if(te<0||te>24)return null;const pt=1<<te,ot=ae(te,he=he+pt&pt-1,pe);if(this.tiles[ot])return Mt(this.tiles[ot],Oe);ht>1&&console.log("drilling down to z%d-%d-%d",te,he,pe);let St,Lt=te,zt=he,Jt=pe;for(;!St&&Lt>0;)Lt--,zt>>=1,Jt>>=1,St=this.tiles[ae(Lt,zt,Jt)];return St&&St.source?(ht>1&&(console.log("found parent tile z%d-%d-%d",Lt,zt,Jt),console.time("drilling down")),this.splitTile(St.source,Lt,zt,Jt,te,he,pe),ht>1&&console.timeEnd("drilling down"),this.tiles[ot]?Mt(this.tiles[ot],Oe):null):null}}function ae(Te,te,he){return 32*((1<<Te)*he+te)+Te}class De extends L{constructor(te,he,pe,Re=Xe){super(te,he,pe),this._dataUpdateable=new Map,this._createGeoJSONIndex=Re}loadVectorTile(te,he){return c._(this,void 0,void 0,(function*(){const pe=te.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const Re=this._geoJSONIndex.getTile(pe.z,pe.x,pe.y);return Re?S(new c.d2(Re.features,{version:2,extent:c.a5})):null}))}loadData(te){return c._(this,void 0,void 0,(function*(){var he;(he=this._pendingRequest)===null||he===void 0||he.abort();const pe=this._startPerformance(te);this._pendingRequest=new AbortController;try{(!this._pendingData||te.request||te.data||te.dataDiff)&&(this._pendingData=this.loadAndProcessGeoJSON(te,this._pendingRequest));const Re=yield this._pendingData;this._geoJSONIndex=this._createGeoJSONIndex(Re,te),this.loaded={};const Oe={};return te.request&&(Oe.data=Re),this._finishPerformance(pe,te,Oe),Oe}catch(Re){if(delete this._pendingRequest,c.Z(Re))return{abandoned:!0};throw Re}}))}_startPerformance(te){var he;if(!((he=te?.request)===null||he===void 0)&&he.collectResourceTiming)return new c.c_(te.request)}_finishPerformance(te,he,pe){if(!te)return;const Re=te.finish();Re&&(pe.resourceTiming={},pe.resourceTiming[he.source]=JSON.parse(JSON.stringify(Re)))}getData(){return c._(this,void 0,void 0,(function*(){return this._pendingData}))}reloadTile(te){const he=this.loaded;return he&&he[te.uid]?super.reloadTile(te):this.loadTile(te)}loadAndProcessGeoJSON(te,he){return c._(this,void 0,void 0,(function*(){let pe;if(te.request?pe=yield this.loadGeoJSONFromUrl(te.request,te.promoteId,he):te.data?pe=this._loadGeoJSONFromObject(te.data,te.promoteId):te.dataDiff&&(pe=this._loadGeoJSONFromDiff(te.dataDiff,te.promoteId,te.source)),delete this._pendingRequest,typeof pe!="object")throw new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`);return U(pe,!0),te.filter&&(pe=this._filterGeoJSON(pe,te.filter)),pe}))}loadGeoJSONFromUrl(te,he,pe){return c._(this,void 0,void 0,(function*(){const Re=yield c.j(te,pe);return this._dataUpdateable=c.a7(Re.data,he),Re.data}))}_loadGeoJSONFromObject(te,he){return this._dataUpdateable=c.a7(te,he),te}_loadGeoJSONFromDiff(te,he,pe){if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${pe}`);c.a8(this._dataUpdateable,te,he);const Re=Array.from(this._dataUpdateable.values());return this._toFeatureCollection(Re)}_filterGeoJSON(te,he){const pe=c.d3(he,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(pe.result==="error")throw new Error(pe.value.map((Oe=>`${Oe.key}: ${Oe.message}`)).join(", "));const Re=te.features.filter((Oe=>pe.value.evaluate({zoom:0},Oe)));return this._toFeatureCollection(Re)}_toFeatureCollection(te){return{type:"FeatureCollection",features:te}}removeSource(te){return c._(this,void 0,void 0,(function*(){this._pendingRequest&&this._pendingRequest.abort()}))}getClusterExpansionZoom(te){return this._geoJSONIndex.getClusterExpansionZoom(te.clusterId)}getClusterChildren(te){return this._geoJSONIndex.getChildren(te.clusterId)}getClusterLeaves(te){return this._geoJSONIndex.getLeaves(te.clusterId,te.limit,te.offset)}}function Xe(Te,te){return te.cluster?new V((function({superclusterOptions:he,clusterProperties:pe}){if(!pe||!he)return he;const Re={},Oe={},ht={accumulated:null,zoom:0},pt={properties:null},ot=Object.keys(pe);for(const St of ot){const[Lt,zt]=pe[St],Jt=c.d3(zt),gi=c.d3(typeof Lt=="string"?[Lt,["accumulated"],["get",St]]:Lt);Re[St]=Jt.value,Oe[St]=gi.value}return he.map=St=>{pt.properties=St;const Lt={};for(const zt of ot)Lt[zt]=Re[zt].evaluate(ht,pt);return Lt},he.reduce=(St,Lt)=>{pt.properties=Lt;for(const zt of ot)ht.accumulated=St[zt],St[zt]=Oe[zt].evaluate(ht,pt)},he})(te)).load(Te.features):(function(he,pe){return new ie(he,pe)})(Te,te.geojsonVtOptions)}class bt{constructor(te){this.self=te,this.actor=new c.L(te),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.globalStates=new Map,this.self.registerWorkerSource=(he,pe)=>{if(this.externalWorkerSourceTypes[he])throw new Error(`Worker source with name "${he}" already registered.`);this.externalWorkerSourceTypes[he]=pe},this.self.addProtocol=c.cJ,this.self.removeProtocol=c.cK,this.self.registerRTLTextPlugin=he=>{c.d4.setMethods(he)},this.actor.registerMessageHandler("LDT",((he,pe)=>this._getDEMWorkerSource(he,pe.source).loadTile(pe))),this.actor.registerMessageHandler("RDT",((he,pe)=>c._(this,void 0,void 0,(function*(){this._getDEMWorkerSource(he,pe.source).removeTile(pe)})))),this.actor.registerMessageHandler("GCEZ",((he,pe)=>c._(this,void 0,void 0,(function*(){return this._getWorkerSource(he,pe.type,pe.source).getClusterExpansionZoom(pe)})))),this.actor.registerMessageHandler("GCC",((he,pe)=>c._(this,void 0,void 0,(function*(){return this._getWorkerSource(he,pe.type,pe.source).getClusterChildren(pe)})))),this.actor.registerMessageHandler("GCL",((he,pe)=>c._(this,void 0,void 0,(function*(){return this._getWorkerSource(he,pe.type,pe.source).getClusterLeaves(pe)})))),this.actor.registerMessageHandler("LD",((he,pe)=>this._getWorkerSource(he,pe.type,pe.source).loadData(pe))),this.actor.registerMessageHandler("GD",((he,pe)=>this._getWorkerSource(he,pe.type,pe.source).getData())),this.actor.registerMessageHandler("LT",((he,pe)=>this._getWorkerSource(he,pe.type,pe.source).loadTile(pe))),this.actor.registerMessageHandler("RT",((he,pe)=>this._getWorkerSource(he,pe.type,pe.source).reloadTile(pe))),this.actor.registerMessageHandler("AT",((he,pe)=>this._getWorkerSource(he,pe.type,pe.source).abortTile(pe))),this.actor.registerMessageHandler("RMT",((he,pe)=>this._getWorkerSource(he,pe.type,pe.source).removeTile(pe))),this.actor.registerMessageHandler("RS",((he,pe)=>c._(this,void 0,void 0,(function*(){if(!this.workerSources[he]||!this.workerSources[he][pe.type]||!this.workerSources[he][pe.type][pe.source])return;const Re=this.workerSources[he][pe.type][pe.source];delete this.workerSources[he][pe.type][pe.source],Re.removeSource!==void 0&&Re.removeSource(pe)})))),this.actor.registerMessageHandler("RM",(he=>c._(this,void 0,void 0,(function*(){delete this.layerIndexes[he],delete this.availableImages[he],delete this.workerSources[he],delete this.demWorkerSources[he],this.globalStates.delete(he)})))),this.actor.registerMessageHandler("SR",((he,pe)=>c._(this,void 0,void 0,(function*(){this.referrer=pe})))),this.actor.registerMessageHandler("SRPS",((he,pe)=>this._syncRTLPluginState(he,pe))),this.actor.registerMessageHandler("IS",((he,pe)=>c._(this,void 0,void 0,(function*(){this.self.importScripts(pe)})))),this.actor.registerMessageHandler("SI",((he,pe)=>this._setImages(he,pe))),this.actor.registerMessageHandler("UL",((he,pe)=>c._(this,void 0,void 0,(function*(){this._getLayerIndex(he).update(pe.layers,pe.removedIds,this._getGlobalState(he))})))),this.actor.registerMessageHandler("UGS",((he,pe)=>c._(this,void 0,void 0,(function*(){const Re=this._getGlobalState(he);for(const Oe in pe)Re[Oe]=pe[Oe]})))),this.actor.registerMessageHandler("SL",((he,pe)=>c._(this,void 0,void 0,(function*(){this._getLayerIndex(he).replace(pe,this._getGlobalState(he))}))))}_getGlobalState(te){let he=this.globalStates.get(te);return he||(he={},this.globalStates.set(te,he)),he}_setImages(te,he){return c._(this,void 0,void 0,(function*(){this.availableImages[te]=he;for(const pe in this.workerSources[te]){const Re=this.workerSources[te][pe];for(const Oe in Re)Re[Oe].availableImages=he}}))}_syncRTLPluginState(te,he){return c._(this,void 0,void 0,(function*(){return yield c.d4.syncState(he,this.self.importScripts)}))}_getAvailableImages(te){let he=this.availableImages[te];return he||(he=[]),he}_getLayerIndex(te){let he=this.layerIndexes[te];return he||(he=this.layerIndexes[te]=new s),he}_getWorkerSource(te,he,pe){if(this.workerSources[te]||(this.workerSources[te]={}),this.workerSources[te][he]||(this.workerSources[te][he]={}),!this.workerSources[te][he][pe]){const Re={sendAsync:(Oe,ht)=>(Oe.targetMapId=te,this.actor.sendAsync(Oe,ht))};switch(he){case"vector":this.workerSources[te][he][pe]=new L(Re,this._getLayerIndex(te),this._getAvailableImages(te));break;case"geojson":this.workerSources[te][he][pe]=new De(Re,this._getLayerIndex(te),this._getAvailableImages(te));break;default:this.workerSources[te][he][pe]=new this.externalWorkerSourceTypes[he](Re,this._getLayerIndex(te),this._getAvailableImages(te))}}return this.workerSources[te][he][pe]}_getDEMWorkerSource(te,he){return this.demWorkerSources[te]||(this.demWorkerSources[te]={}),this.demWorkerSources[te][he]||(this.demWorkerSources[te][he]=new E),this.demWorkerSources[te][he]}}return c.i(self)&&(self.worker=new bt(self)),bt})),r("index",["exports","./shared"],(function(c,s){var d="5.15.0";function p(){var A=new s.A(4);return s.A!=Float32Array&&(A[1]=0,A[2]=0),A[0]=1,A[3]=1,A}let g,_,x;const b={frame(A,l,f){const v=requestAnimationFrame((I=>{w(),l(I)})),{unsubscribe:w}=s.s(A.signal,"abort",(()=>{w(),cancelAnimationFrame(v),f(new s.a(A.signal.reason))}),!1)},frameAsync(A){return new Promise(((l,f)=>{this.frame(A,l,f)}))},getImageData(A,l=0){return this.getImageCanvasContext(A).getImageData(-l,-l,A.width+2*l,A.height+2*l)},getImageCanvasContext(A){const l=window.document.createElement("canvas"),f=l.getContext("2d",{willReadFrequently:!0});if(!f)throw new Error("failed to create canvas 2d context");return l.width=A.width,l.height=A.height,f.drawImage(A,0,0,A.width,A.height),f},resolveURL:A=>(g||(g=document.createElement("a")),g.href=A,g.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return x!==void 0?x:!!matchMedia&&(_==null&&(_=matchMedia("(prefers-reduced-motion: reduce)")),_.matches)},set prefersReducedMotion(A){x=A}},S=new class{constructor(){this._realTime=typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),this._frozenAt=null}getCurrentTime(){return this._frozenAt!==null?this._frozenAt:this._realTime()}setNow(A){this._frozenAt=A}restoreNow(){this._frozenAt=null}isFrozen(){return this._frozenAt!==null}};function P(){return S.getCurrentTime()}class L{static testProp(l){if(!L.docStyle)return l[0];for(let f=0;f<l.length;f++)if(l[f]in L.docStyle)return l[f];return l[0]}static create(l,f,v){const w=window.document.createElement(l);return f!==void 0&&(w.className=f),v&&v.appendChild(w),w}static createNS(l,f){return window.document.createElementNS(l,f)}static disableDrag(){L.docStyle&&L.selectProp&&(L.userSelect=L.docStyle[L.selectProp],L.docStyle[L.selectProp]="none")}static enableDrag(){L.docStyle&&L.selectProp&&(L.docStyle[L.selectProp]=L.userSelect)}static setTransform(l,f){l.style[L.transformProp]=f}static addEventListener(l,f,v,w={}){l.addEventListener(f,v,"passive"in w?w:w.capture)}static removeEventListener(l,f,v,w={}){l.removeEventListener(f,v,"passive"in w?w:w.capture)}static suppressClickInternal(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",L.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",L.suppressClickInternal,!0),window.setTimeout((()=>{window.removeEventListener("click",L.suppressClickInternal,!0)}),0)}static getScale(l){const f=l.getBoundingClientRect();return{x:f.width/l.offsetWidth||1,y:f.height/l.offsetHeight||1,boundingClientRect:f}}static getPoint(l,f,v){const w=f.boundingClientRect;return new s.P((v.clientX-w.left)/f.x-l.clientLeft,(v.clientY-w.top)/f.y-l.clientTop)}static mousePos(l,f){const v=L.getScale(l);return L.getPoint(l,v,f)}static touchPos(l,f){const v=[],w=L.getScale(l);for(let I=0;I<f.length;I++)v.push(L.getPoint(l,w,f[I]));return v}static mouseButton(l){return l.button}static remove(l){l.parentNode&&l.parentNode.removeChild(l)}static sanitize(l){const f=new DOMParser().parseFromString(l,"text/html").body||document.createElement("body"),v=f.querySelectorAll("script");for(const w of v)w.remove();return L.clean(f),f.innerHTML}static isPossiblyDangerous(l,f){const v=f.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(l)||!v.includes("javascript:")&&!v.includes("data:"))||!!l.startsWith("on")||void 0}static clean(l){const f=l.children;for(const v of f)L.removeAttributes(v),L.clean(v)}static removeAttributes(l){for(const{name:f,value:v}of l.attributes)L.isPossiblyDangerous(f,v)&&l.removeAttribute(f)}}L.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,L.selectProp=L.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),L.transformProp=L.testProp(["transform","WebkitTransform"]);const E={supported:!1,testSupport:function(A){!O&&D&&(U?j(A):C=A)}};let C,D,O=!1,U=!1;function j(A){const l=A.createTexture();A.bindTexture(A.TEXTURE_2D,l);try{if(A.texImage2D(A.TEXTURE_2D,0,A.RGBA,A.RGBA,A.UNSIGNED_BYTE,D),A.isContextLost())return;E.supported=!0}catch{}A.deleteTexture(l),O=!0}var G;typeof document<"u"&&(D=document.createElement("img"),D.onload=()=>{C&&j(C),C=null,U=!0},D.onerror=()=>{O=!0,C=null},D.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),(function(A){let l,f,v,w;A.resetRequestQueue=()=>{l=[],f=0,v=0,w={}},A.addThrottleControl=W=>{const Z=v++;return w[Z]=W,Z},A.removeThrottleControl=W=>{delete w[W],k()},A.getImage=(W,Z,J=!0)=>new Promise(((ue,le)=>{E.supported&&(W.headers||(W.headers={}),W.headers.accept="image/webp,*/*"),s.e(W,{type:"image"}),l.push({abortController:Z,requestParameters:W,supportImageRefresh:J,state:"queued",onError:_e=>{le(_e)},onSuccess:_e=>{ue(_e)}}),k()}));const I=W=>s._(this,void 0,void 0,(function*(){W.state="running";const{requestParameters:Z,supportImageRefresh:J,onError:ue,onSuccess:le,abortController:_e}=W,Ee=J===!1&&!s.i(self)&&!s.g(Z.url)&&(!Z.headers||Object.keys(Z.headers).reduce(((Ne,Ze)=>Ne&&Ze==="accept"),!0));f++;const ze=Ee?B(Z,_e):s.m(Z,_e);try{const Ne=yield ze;delete W.abortController,W.state="completed",Ne.data instanceof HTMLImageElement||s.b(Ne.data)?le(Ne):Ne.data&&le({data:yield($e=Ne.data,typeof createImageBitmap=="function"?s.f($e):s.h($e)),cacheControl:Ne.cacheControl,expires:Ne.expires})}catch(Ne){delete W.abortController,ue(Ne)}finally{f--,k()}var $e})),k=()=>{const W=(()=>{for(const Z of Object.keys(w))if(w[Z]())return!0;return!1})()?s.c.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:s.c.MAX_PARALLEL_IMAGE_REQUESTS;for(let Z=f;Z<W&&l.length>0;Z++){const J=l.shift();J.abortController.signal.aborted?Z--:I(J)}},B=(W,Z)=>new Promise(((J,ue)=>{const le=new Image,_e=W.url,Ee=W.credentials;Ee&&Ee==="include"?le.crossOrigin="use-credentials":(Ee&&Ee==="same-origin"||!s.d(_e))&&(le.crossOrigin="anonymous"),Z.signal.addEventListener("abort",(()=>{le.src="",ue(new s.a(Z.signal.reason))})),le.fetchPriority="high",le.onload=()=>{le.onerror=le.onload=null,J({data:le})},le.onerror=()=>{le.onerror=le.onload=null,Z.signal.aborted||ue(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},le.src=_e}))})(G||(G={})),G.resetRequestQueue();class N{constructor(l){this._transformRequestFn=l??null}transformRequest(l,f){return this._transformRequestFn&&this._transformRequestFn(l,f)||{url:l}}setTransformRequest(l){this._transformRequestFn=l}}function V(A){const l=[];if(typeof A=="string")l.push({id:"default",url:A});else if(A&&A.length>0){const f=[];for(const{id:v,url:w}of A){const I=`${v}${w}`;f.indexOf(I)===-1&&(f.push(I),l.push({id:v,url:w}))}}return l}function q(A,l,f){try{const v=new URL(A);return v.pathname+=`${l}${f}`,v.toString()}catch{throw new Error(`Invalid sprite URL "${A}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}function z(A){const{userImage:l}=A;return!!(l&&l.render&&l.render())&&(A.data.replace(new Uint8Array(l.data.buffer)),!0)}class Q extends s.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new s.R({width:1,height:1}),this.dirty=!0}destroy(){this.atlasTexture&&(this.atlasTexture.destroy(),this.atlasTexture=null);for(const l of Object.keys(this.images))this.removeImage(l);this.patterns={},this.atlasImage=new s.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(l){if(this.loaded!==l&&(this.loaded=l,l)){for(const{ids:f,promiseResolve:v}of this.requestors)v(this._getImagesForIds(f));this.requestors=[]}}getImage(l){const f=this.images[l];if(f&&!f.data&&f.spriteData){const v=f.spriteData;f.data=new s.R({width:v.width,height:v.height},v.context.getImageData(v.x,v.y,v.width,v.height).data),f.spriteData=null}return f}addImage(l,f){if(this.images[l])throw new Error(`Image id ${l} already exist, use updateImage instead`);this._validate(l,f)&&(this.images[l]=f)}_validate(l,f){let v=!0;const w=f.data||f.spriteData;return this._validateStretch(f.stretchX,w&&w.width)||(this.fire(new s.k(new Error(`Image "${l}" has invalid "stretchX" value`))),v=!1),this._validateStretch(f.stretchY,w&&w.height)||(this.fire(new s.k(new Error(`Image "${l}" has invalid "stretchY" value`))),v=!1),this._validateContent(f.content,f)||(this.fire(new s.k(new Error(`Image "${l}" has invalid "content" value`))),v=!1),v}_validateStretch(l,f){if(!l)return!0;let v=0;for(const w of l){if(w[0]<v||w[1]<w[0]||f<w[1])return!1;v=w[1]}return!0}_validateContent(l,f){if(!l)return!0;if(l.length!==4)return!1;const v=f.spriteData,w=v&&v.width||f.data.width,I=v&&v.height||f.data.height;return!(l[0]<0||w<l[0]||l[1]<0||I<l[1]||l[2]<0||w<l[2]||l[3]<0||I<l[3]||l[2]<l[0]||l[3]<l[1])}updateImage(l,f,v=!0){const w=this.getImage(l);if(v&&(w.data.width!==f.data.width||w.data.height!==f.data.height))throw new Error(`size mismatch between old image (${w.data.width}x${w.data.height}) and new image (${f.data.width}x${f.data.height}).`);f.version=w.version+1,this.images[l]=f,this.updatedImages[l]=!0}removeImage(l){const f=this.images[l];delete this.images[l],delete this.patterns[l],f.userImage&&f.userImage.onRemove&&f.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(l){return new Promise(((f,v)=>{let w=!0;if(!this.isLoaded())for(const I of l)this.images[I]||(w=!1);this.isLoaded()||w?f(this._getImagesForIds(l)):this.requestors.push({ids:l,promiseResolve:f})}))}_getImagesForIds(l){const f={};for(const v of l){let w=this.getImage(v);w||(this.fire(new s.l("styleimagemissing",{id:v})),w=this.getImage(v)),w?f[v]={data:w.data.clone(),pixelRatio:w.pixelRatio,sdf:w.sdf,version:w.version,stretchX:w.stretchX,stretchY:w.stretchY,content:w.content,textFitWidth:w.textFitWidth,textFitHeight:w.textFitHeight,hasRenderCallback:!!(w.userImage&&w.userImage.render)}:s.w(`Image "${v}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return f}getPixelSize(){const{width:l,height:f}=this.atlasImage;return{width:l,height:f}}getPattern(l){const f=this.patterns[l],v=this.getImage(l);if(!v)return null;if(f&&f.position.version===v.version)return f.position;if(f)f.position.version=v.version;else{const w={w:v.data.width+2,h:v.data.height+2,x:0,y:0},I=new s.I(w,v);this.patterns[l]={bin:w,position:I}}return this._updatePatternAtlas(),this.patterns[l].position}bind(l){const f=l.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new s.T(l,this.atlasImage,f.RGBA),this.atlasTexture.bind(f.LINEAR,f.CLAMP_TO_EDGE)}_updatePatternAtlas(){const l=[];for(const I in this.patterns)l.push(this.patterns[I].bin);const{w:f,h:v}=s.p(l),w=this.atlasImage;w.resize({width:f||1,height:v||1});for(const I in this.patterns){const{bin:k}=this.patterns[I],B=k.x+1,W=k.y+1,Z=this.getImage(I).data,J=Z.width,ue=Z.height;s.R.copy(Z,w,{x:0,y:0},{x:B,y:W},{width:J,height:ue}),s.R.copy(Z,w,{x:0,y:ue-1},{x:B,y:W-1},{width:J,height:1}),s.R.copy(Z,w,{x:0,y:0},{x:B,y:W+ue},{width:J,height:1}),s.R.copy(Z,w,{x:J-1,y:0},{x:B-1,y:W},{width:1,height:ue}),s.R.copy(Z,w,{x:0,y:0},{x:B+J,y:W},{width:1,height:ue})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(l){for(const f of l){if(this.callbackDispatchedThisFrame[f])continue;this.callbackDispatchedThisFrame[f]=!0;const v=this.getImage(f);v||s.w(`Image with ID: "${f}" was not found`),z(v)&&this.updateImage(f,v)}}cloneImages(){const l={};for(const f in this.images){const v=this.images[f];l[f]=Object.assign(Object.assign({},v),{data:v.data?v.data.clone():null})}return l}}const X=1e20;function re(A,l,f,v,w,I,k,B,W){for(let Z=l;Z<l+v;Z++)oe(A,f*I+Z,I,w,k,B,W);for(let Z=f;Z<f+w;Z++)oe(A,Z*I+l,1,v,k,B,W)}function oe(A,l,f,v,w,I,k){I[0]=0,k[0]=-X,k[1]=X,w[0]=A[l];for(let B=1,W=0,Z=0;B<v;B++){w[B]=A[l+B*f];const J=B*B;do{const ue=I[W];Z=(w[B]-w[ue]+J-ue*ue)/(B-ue)/2}while(Z<=k[W]&&--W>-1);W++,I[W]=B,k[W]=Z,k[W+1]=X}for(let B=0,W=0;B<v;B++){for(;k[W+1]<B;)W++;const Z=I[W],J=B-Z;A[l+B*f]=w[Z]+J*J}}const de=s.v.layout_symbol["text-font"].default.join(",");class ce{constructor(l,f,v){this.requestManager=l,this.localIdeographFontFamily=f,this.entries={},this.lang=v}setURL(l){this.url=l}getGlyphs(l){return s._(this,void 0,void 0,(function*(){const f=[];for(const I in l)for(const k of l[I])f.push(this._getAndCacheGlyphsPromise(I,k));const v=yield Promise.all(f),w={};for(const{stack:I,id:k,glyph:B}of v)w[I]||(w[I]={}),w[I][k]=B&&{id:B.id,bitmap:B.bitmap.clone(),metrics:B.metrics};return w}))}_getAndCacheGlyphsPromise(l,f){return s._(this,void 0,void 0,(function*(){let v=this.entries[l];v||(v=this.entries[l]={glyphs:{},requests:{},ranges:{}});let w=v.glyphs[f];return w!==void 0?{stack:l,id:f,glyph:w}:!this.url||this._charUsesLocalIdeographFontFamily(f)?(w=v.glyphs[f]=this._drawGlyph(v,l,f),{stack:l,id:f,glyph:w}):yield this._downloadAndCacheRangePromise(l,f)}))}_downloadAndCacheRangePromise(l,f){return s._(this,void 0,void 0,(function*(){const v=this.entries[l],w=Math.floor(f/256);if(v.ranges[w])return{stack:l,id:f,glyph:null};if(!v.requests[w]){const I=ce.loadGlyphRange(l,w,this.url,this.requestManager);v.requests[w]=I}try{const I=yield v.requests[w];for(const k in I)v.glyphs[+k]=I[+k];return v.ranges[w]=!0,{stack:l,id:f,glyph:I[f]||null}}catch(I){const k=v.glyphs[f]=this._drawGlyph(v,l,f);return this._warnOnMissingGlyphRange(k,w,f,I),{stack:l,id:f,glyph:k}}}))}_warnOnMissingGlyphRange(l,f,v,w){const I=256*f,k=I+255,B=v.toString(16).padStart(4,"0").toUpperCase();s.w(`Unable to load glyph range ${f}, ${I}-${k}. Rendering codepoint U+${B} locally instead. ${w}`)}_charUsesLocalIdeographFontFamily(l){return!!this.localIdeographFontFamily&&s.q(l)}_drawGlyph(l,f,v){const w=f===de&&this.localIdeographFontFamily!==""&&this._charUsesLocalIdeographFontFamily(v),I=w?"ideographTinySDF":"tinySDF";l[I]||(l[I]=this._createTinySDF(w?this.localIdeographFontFamily:f));const k=l[I].draw(String.fromCodePoint(v));return{id:v,bitmap:new s.r({width:k.width||60,height:k.height||60},k.data),metrics:{width:k.glyphWidth/2||24,height:k.glyphHeight/2||24,left:k.glyphLeft/2+.5||0,top:k.glyphTop/2-27.5||-8,advance:k.glyphAdvance/2||24,isDoubleResolution:!0}}}_createTinySDF(l){const f=l?l.split(","):[];f.push("sans-serif");const v=f.map((w=>/[-\w]+/.test(w)?w:`'${CSS.escape(w)}'`)).join(",");return new ce.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:v,fontWeight:this._fontWeight(f[0]),fontStyle:this._fontStyle(f[0]),lang:this.lang})}_fontStyle(l){return/italic/i.test(l)?"italic":/oblique/i.test(l)?"oblique":"normal"}_fontWeight(l){const f={thin:100,hairline:100,"extra light":200,"ultra light":200,light:300,normal:400,regular:400,medium:500,semibold:600,demibold:600,bold:700,"extra bold":800,"ultra bold":800,black:900,heavy:900,"extra black":950,"ultra black":950};let v;for(const[w,I]of Object.entries(f))new RegExp(`\\b${w}\\b`,"i").test(l)&&(v=`${I}`);return v}destroy(){for(const l in this.entries){const f=this.entries[l];f.tinySDF&&(f.tinySDF=null),f.ideographTinySDF&&(f.ideographTinySDF=null),f.glyphs={},f.requests={},f.ranges={}}this.entries={}}}ce.loadGlyphRange=function(A,l,f,v){return s._(this,void 0,void 0,(function*(){const w=256*l,I=w+255,k=v.transformRequest(f.replace("{fontstack}",A).replace("{range}",`${w}-${I}`),"Glyphs"),B=yield s.n(k,new AbortController);if(!B||!B.data)throw new Error(`Could not load glyph range. range: ${l}, ${w}-${I}`);const W={};for(const Z of s.o(B.data))W[Z.id]=Z;return W}))},ce.TinySDF=class{constructor({fontSize:A=24,buffer:l=3,radius:f=8,cutoff:v=.25,fontFamily:w="sans-serif",fontWeight:I="normal",fontStyle:k="normal",lang:B=null}={}){this.buffer=l,this.cutoff=v,this.radius=f,this.lang=B;const W=this.size=A+4*l,Z=this._createCanvas(W),J=this.ctx=Z.getContext("2d",{willReadFrequently:!0});J.font=`${k} ${I} ${A}px ${w}`,J.textBaseline="alphabetic",J.textAlign="left",J.fillStyle="black",this.gridOuter=new Float64Array(W*W),this.gridInner=new Float64Array(W*W),this.f=new Float64Array(W),this.z=new Float64Array(W+1),this.v=new Uint16Array(W)}_createCanvas(A){const l=document.createElement("canvas");return l.width=l.height=A,l}draw(A){const{width:l,actualBoundingBoxAscent:f,actualBoundingBoxDescent:v,actualBoundingBoxLeft:w,actualBoundingBoxRight:I}=this.ctx.measureText(A),k=Math.ceil(f),B=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(I-w))),W=Math.min(this.size-this.buffer,k+Math.ceil(v)),Z=B+2*this.buffer,J=W+2*this.buffer,ue=Math.max(Z*J,0),le=new Uint8ClampedArray(ue),_e={data:le,width:Z,height:J,glyphWidth:B,glyphHeight:W,glyphTop:k,glyphLeft:0,glyphAdvance:l};if(B===0||W===0)return _e;const{ctx:Ee,buffer:ze,gridInner:$e,gridOuter:Ne}=this;this.lang&&(Ee.lang=this.lang),Ee.clearRect(ze,ze,B,W),Ee.fillText(A,ze,ze+k);const Ze=Ee.getImageData(ze,ze,B,W);Ne.fill(X,0,ue),$e.fill(0,0,ue);for(let rt=0;rt<W;rt++)for(let We=0;We<B;We++){const it=Ze.data[4*(rt*B+We)+3]/255;if(it===0)continue;const lt=(rt+ze)*Z+We+ze;if(it===1)Ne[lt]=0,$e[lt]=X;else{const Qe=.5-it;Ne[lt]=Qe>0?Qe*Qe:0,$e[lt]=Qe<0?Qe*Qe:0}}re(Ne,0,0,Z,J,Z,this.f,this.v,this.z),re($e,ze,ze,B,W,Z,this.f,this.v,this.z);for(let rt=0;rt<ue;rt++){const We=Math.sqrt(Ne[rt])-Math.sqrt($e[rt]);le[rt]=Math.round(255-255*(We/this.radius+this.cutoff))}return _e}};class Se{constructor(){this.specification=s.u.light.position}possiblyEvaluate(l,f){return s.F(l.expression.evaluate(f))}interpolate(l,f,v){return{x:s.G.number(l.x,f.x,v),y:s.G.number(l.y,f.y,v),z:s.G.number(l.z,f.z,v)}}}let Pe;class je extends s.E{constructor(l){super(),Pe=Pe||new s.t({anchor:new s.D(s.u.light.anchor),position:new Se,color:new s.D(s.u.light.color),intensity:new s.D(s.u.light.intensity)}),this._transitionable=new s.x(Pe,void 0),this.setLight(l),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(l,f={}){if(!this._validate(s.y,l,f))for(const v in l){const w=l[v];v.endsWith(s.z)?this._transitionable.setTransition(v.slice(0,-s.z.length),w):this._transitionable.setValue(v,w)}}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,f,v){return(!v||v.validate!==!1)&&s.B(this,l.call(s.C,{value:f,style:{glyphs:!0,sprite:!0},styleSpec:s.u}))}}const Fe=new s.t({"sky-color":new s.D(s.u.sky["sky-color"]),"horizon-color":new s.D(s.u.sky["horizon-color"]),"fog-color":new s.D(s.u.sky["fog-color"]),"fog-ground-blend":new s.D(s.u.sky["fog-ground-blend"]),"horizon-fog-blend":new s.D(s.u.sky["horizon-fog-blend"]),"sky-horizon-blend":new s.D(s.u.sky["sky-horizon-blend"]),"atmosphere-blend":new s.D(s.u.sky["atmosphere-blend"])});class qe extends s.E{constructor(l){super(),this._transitionable=new s.x(Fe,void 0),this.setSky(l),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new s.H(0))}setSky(l,f={}){if(!this._validate(s.J,l,f)){l||(l={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const v in l){const w=l[v];v.endsWith(s.z)?this._transitionable.setTransition(v.slice(0,-s.z.length),w):this._transitionable.setValue(v,w)}}}getSky(){return this._transitionable.serialize()}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,f,v={}){return v?.validate!==!1&&s.B(this,l.call(s.C,s.e({value:f,style:{glyphs:!0,sprite:!0},styleSpec:s.u})))}calculateFogBlendOpacity(l){return l<60?0:l<70?(l-60)/10:1}}class Ue{constructor(l,f){this.width=l,this.height=f,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(l,f){const v=l.join(",")+String(f);return this.dashEntry[v]||(this.dashEntry[v]=this.addDash(l,f)),this.dashEntry[v]}getDashRanges(l,f,v){const w=[];let I=l.length%2==1?-l[l.length-1]*v:0,k=l[0]*v,B=!0;w.push({left:I,right:k,isDash:B,zeroLength:l[0]===0});let W=l[0];for(let Z=1;Z<l.length;Z++){B=!B;const J=l[Z];I=W*v,W+=J,k=W*v,w.push({left:I,right:k,isDash:B,zeroLength:J===0})}return w}addRoundDash(l,f,v){const w=f/2;for(let I=-v;I<=v;I++){const k=this.width*(this.nextRow+v+I);let B=0,W=l[B];for(let Z=0;Z<this.width;Z++){Z/W.right>1&&(W=l[++B]);const J=Math.abs(Z-W.left),ue=Math.abs(Z-W.right),le=Math.min(J,ue);let _e;const Ee=I/v*(w+1);if(W.isDash){const ze=w-Math.abs(Ee);_e=Math.sqrt(le*le+ze*ze)}else _e=w-Math.sqrt(le*le+Ee*Ee);this.data[k+Z]=Math.max(0,Math.min(255,_e+128))}}}addRegularDash(l){for(let B=l.length-1;B>=0;--B){const W=l[B],Z=l[B+1];W.zeroLength?l.splice(B,1):Z&&Z.isDash===W.isDash&&(Z.left=W.left,l.splice(B,1))}const f=l[0],v=l[l.length-1];f.isDash===v.isDash&&(f.left=v.left-this.width,v.right=f.right+this.width);const w=this.width*this.nextRow;let I=0,k=l[I];for(let B=0;B<this.width;B++){B/k.right>1&&(k=l[++I]);const W=Math.abs(B-k.left),Z=Math.abs(B-k.right),J=Math.min(W,Z);this.data[w+B]=Math.max(0,Math.min(255,(k.isDash?J:-J)+128))}}addDash(l,f){const v=f?7:0,w=2*v+1;if(this.nextRow+w>this.height)return s.w("LineAtlas out of space"),null;let I=0;for(let B=0;B<l.length;B++)I+=l[B];if(I!==0){const B=this.width/I,W=this.getDashRanges(l,this.width,B);f?this.addRoundDash(W,B,v):this.addRegularDash(W)}const k={y:this.nextRow+v,height:2*v,width:I};return this.nextRow+=w,this.dirty=!0,k}bind(l){const f=l.gl;this.texture?(f.bindTexture(f.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,f.texSubImage2D(f.TEXTURE_2D,0,0,0,this.width,this.height,f.ALPHA,f.UNSIGNED_BYTE,this.data))):(this.texture=f.createTexture(),f.bindTexture(f.TEXTURE_2D,this.texture),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texImage2D(f.TEXTURE_2D,0,f.ALPHA,this.width,this.height,0,f.ALPHA,f.UNSIGNED_BYTE,this.data))}}const ke="maplibre_preloaded_worker_pool";class et{constructor(){this.active={}}acquire(l){if(!this.workers)for(this.workers=[];this.workers.length<et.workerCount;)this.workers.push(new Worker(s.c.WORKER_URL));return this.active[l]=!0,this.workers.slice()}release(l){delete this.active[l],this.numActive()===0&&(this.workers.forEach((f=>{f.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[ke]}numActive(){return Object.keys(this.active).length}}const ye=Math.floor(b.hardwareConcurrency/2);let Be,Je;function ct(){return Be||(Be=new et),Be}et.workerCount=s.K(globalThis)?Math.max(Math.min(ye,3),1):1;class yt{constructor(l,f){this.workerPool=l,this.actors=[],this.currentActor=0,this.id=f;const v=this.workerPool.acquire(f);for(let w=0;w<v.length;w++){const I=new s.L(v[w],f);I.name=`Worker ${w}`,this.actors.push(I)}if(!this.actors.length)throw new Error("No actors found")}broadcast(l,f){const v=[];for(const w of this.actors)v.push(w.sendAsync({type:l,data:f}));return Promise.all(v)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(l=!0){this.actors.forEach((f=>{f.remove()})),this.actors=[],l&&this.workerPool.release(this.id)}registerMessageHandler(l,f){for(const v of this.actors)v.registerMessageHandler(l,f)}unregisterMessageHandler(l){for(const f of this.actors)f.unregisterMessageHandler(l)}}function we(){return Je||(Je=new yt(ct(),s.M),Je.registerMessageHandler("GR",((A,l,f)=>s.m(l,f)))),Je}function fe(A,l){const f=s.N();return s.O(f,f,[1,1,0]),s.Q(f,f,[.5*A.width,.5*A.height,1]),A.calculatePosMatrix?s.S(f,f,A.calculatePosMatrix(l.toUnwrapped())):f}function Ve(A,l,f,v,w,I,k){var B;const W=(function(le,_e,Ee){if(le)for(const ze of le){const $e=_e[ze];if($e&&$e.source===Ee&&$e.type==="fill-extrusion")return!0}else for(const ze in _e){const $e=_e[ze];if($e.source===Ee&&$e.type==="fill-extrusion")return!0}return!1})((B=w?.layers)!==null&&B!==void 0?B:null,l,A.id),Z=I.maxPitchScaleFactor(),J=A.tilesIn(v,Z,W);J.sort(tt);const ue=[];for(const le of J)ue.push({wrappedTileID:le.tileID.wrapped().key,queryResults:le.tile.queryRenderedFeatures(l,f,A.getState(),le.queryGeometry,le.cameraQueryGeometry,le.scale,w,I,Z,fe(I,le.tileID),k?(_e,Ee)=>k(le.tileID,_e,Ee):void 0)});return(function(le,_e){for(const Ee in le)for(const ze of le[Ee])Mt(ze,_e);return le})((function(le){const _e={},Ee={};for(const ze of le){const $e=ze.queryResults,Ne=ze.wrappedTileID,Ze=Ee[Ne]=Ee[Ne]||{};for(const rt in $e){const We=$e[rt],it=Ze[rt]=Ze[rt]||{},lt=_e[rt]=_e[rt]||[];for(const Qe of We)it[Qe.featureIndex]||(it[Qe.featureIndex]=!0,lt.push(Qe))}}return _e})(ue),A)}function tt(A,l){const f=A.tileID,v=l.tileID;return f.overscaledZ-v.overscaledZ||f.canonical.y-v.canonical.y||f.wrap-v.wrap||f.canonical.x-v.canonical.x}function Mt(A,l){const f=A.feature,v=l.getFeatureState(f.layer["source-layer"],f.id);f.source=f.layer.source,f.layer["source-layer"]&&(f.sourceLayer=f.layer["source-layer"]),f.state=v}function mt(A,l,f){return s._(this,void 0,void 0,(function*(){let v=A;if(A.url?v=(yield s.j(l.transformRequest(A.url,"Source"),f)).data:yield b.frameAsync(f),!v)return null;const w=s.U(s.e(v,A),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in v&&v.vector_layers&&(w.vectorLayerIds=v.vector_layers.map((I=>I.id))),w}))}class Ce{constructor(l,f){l&&(f?this.setSouthWest(l).setNorthEast(f):Array.isArray(l)&&(l.length===4?this.setSouthWest([l[0],l[1]]).setNorthEast([l[2],l[3]]):this.setSouthWest(l[0]).setNorthEast(l[1])))}setNorthEast(l){return this._ne=l instanceof s.V?new s.V(l.lng,l.lat):s.V.convert(l),this}setSouthWest(l){return this._sw=l instanceof s.V?new s.V(l.lng,l.lat):s.V.convert(l),this}extend(l){const f=this._sw,v=this._ne;let w,I;if(l instanceof s.V)w=l,I=l;else{if(!(l instanceof Ce))return Array.isArray(l)?l.length===4||l.every(Array.isArray)?this.extend(Ce.convert(l)):this.extend(s.V.convert(l)):l&&("lng"in l||"lon"in l)&&"lat"in l?this.extend(s.V.convert(l)):this;if(w=l._sw,I=l._ne,!w||!I)return this}return f||v?(f.lng=Math.min(w.lng,f.lng),f.lat=Math.min(w.lat,f.lat),v.lng=Math.max(I.lng,v.lng),v.lat=Math.max(I.lat,v.lat)):(this._sw=new s.V(w.lng,w.lat),this._ne=new s.V(I.lng,I.lat)),this}getCenter(){return new s.V((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new s.V(this.getWest(),this.getNorth())}getSouthEast(){return new s.V(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(l){const{lng:f,lat:v}=s.V.convert(l);let w=this._sw.lng<=f&&f<=this._ne.lng;return this._sw.lng>this._ne.lng&&(w=this._sw.lng>=f&&f>=this._ne.lng),this._sw.lat<=v&&v<=this._ne.lat&&w}intersects(l){if(!((l=Ce.convert(l)).getNorth()>=this.getSouth()&&l.getSouth()<=this.getNorth()))return!1;const f=Math.abs(this.getEast()-this.getWest()),v=Math.abs(l.getEast()-l.getWest());if(f>=360||v>=360)return!0;const w=s.W(this.getWest(),-180,180),I=s.W(this.getEast(),-180,180),k=s.W(l.getWest(),-180,180),B=s.W(l.getEast(),-180,180),W=w>=I,Z=k>=B;return!(!W||!Z)||(W?B>=w||k<=I:Z?I>=k||w<=B:k<=I&&B>=w)}static convert(l){return l instanceof Ce?l:l&&new Ce(l)}static fromLngLat(l,f=0){const v=360*f/40075017,w=v/Math.cos(Math.PI/180*l.lat);return new Ce(new s.V(l.lng-w,l.lat-v),new s.V(l.lng+w,l.lat+v))}adjustAntiMeridian(){const l=new s.V(this._sw.lng,this._sw.lat),f=new s.V(this._ne.lng,this._ne.lat);return new Ce(l,l.lng>f.lng?new s.V(f.lng+360,f.lat):f)}}class xe{constructor(l,f,v){this.bounds=Ce.convert(this.validateBounds(l)),this.minzoom=f||0,this.maxzoom=v||24}validateBounds(l){return Array.isArray(l)&&l.length===4?[Math.max(-180,l[0]),Math.max(-90,l[1]),Math.min(180,l[2]),Math.min(90,l[3])]:[-180,-90,180,90]}contains(l){const f=Math.pow(2,l.z),v=Math.floor(s.Y(this.bounds.getWest())*f),w=Math.floor(s.X(this.bounds.getNorth())*f),I=Math.ceil(s.Y(this.bounds.getEast())*f),k=Math.ceil(s.X(this.bounds.getSouth())*f);return l.x>=v&&l.x<I&&l.y>=w&&l.y<k}}class vt extends s.E{constructor(l,f,v,w){if(super(),this.id=l,this.dispatcher=v,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.e(this,s.U(f,["url","scheme","tileSize","promoteId","encoding"])),this._options=s.e({type:"vector"},f),this._collectResourceTiming=f.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(w)}load(){return s._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new s.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const l=yield mt(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.tileManagers[this.id].clearTiles(),l&&(s.e(this,l),l.bounds&&(this.tileBounds=new xe(l.bounds,this.minzoom,this.maxzoom)),this.fire(new s.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.l("data",{dataType:"source",sourceDataType:"content"})))}catch(l){this._tileJSONRequest=null,this._loaded=!0,s.Z(l)||this.fire(new s.k(l))}}))}loaded(){return this._loaded}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}onAdd(l){this.map=l,this.load()}setSourceProperty(l){this._tileJSONRequest&&this._tileJSONRequest.abort(),l(),this.load()}setTiles(l){return this.setSourceProperty((()=>{this._options.tiles=l})),this}setUrl(l){return this.setSourceProperty((()=>{this.url=l,this._options.url=l})),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return s.e({},this._options)}loadTile(l){return s._(this,void 0,void 0,(function*(){const f=l.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),v={request:this.map._requestManager.transformRequest(f,"Tile"),uid:l.uid,tileID:l.tileID,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity,encoding:this.encoding,overzoomParameters:this._getOverzoomParameters(l)};v.request.collectResourceTiming=this._collectResourceTiming;let w="RT";if(l.actor&&l.state!=="expired"){if(l.state==="loading")return new Promise(((I,k)=>{l.reloadPromise={resolve:I,reject:k}}))}else l.actor=this.dispatcher.getActor(),w="LT";l.abortController=new AbortController;try{const I=yield l.actor.sendAsync({type:w,data:v},l.abortController);if(delete l.abortController,l.aborted)return;this._afterTileLoadWorkerResponse(l,I)}catch(I){if(delete l.abortController,l.aborted)return;if(I&&I.status!==404)throw I;this._afterTileLoadWorkerResponse(l,null)}}))}_getOverzoomParameters(l){if(l.tileID.canonical.z<=this.maxzoom||this.map._zoomLevelsToOverscale===void 0)return;const f=l.tileID.scaledTo(this.maxzoom).canonical,v=f.url(this.tiles,this.map.getPixelRatio(),this.scheme);return{maxZoomTileID:f,overzoomRequest:this.map._requestManager.transformRequest(v,"Tile")}}_afterTileLoadWorkerResponse(l,f){if(f&&f.resourceTiming&&(l.resourceTiming=f.resourceTiming),f&&this.map._refreshExpiredTiles&&l.setExpiryData(f),l.loadVectorData(f,this.map.painter),l.reloadPromise){const v=l.reloadPromise;l.reloadPromise=null,this.loadTile(l).then(v.resolve).catch(v.reject)}}abortTile(l){return s._(this,void 0,void 0,(function*(){l.abortController&&(l.abortController.abort(),delete l.abortController),l.actor&&(yield l.actor.sendAsync({type:"AT",data:{uid:l.uid,type:this.type,source:this.id}}))}))}unloadTile(l){return s._(this,void 0,void 0,(function*(){l.unloadVectorData(),l.actor&&(yield l.actor.sendAsync({type:"RMT",data:{uid:l.uid,type:this.type,source:this.id}}))}))}hasTransition(){return!1}}class be extends s.E{constructor(l,f,v,w){super(),this.id=l,this.dispatcher=v,this.setEventedParent(w),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.e({type:"raster"},f),s.e(this,s.U(f,["url","scheme","tileSize"]))}load(){return s._(this,arguments,void 0,(function*(l=!1){this._loaded=!1,this.fire(new s.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const f=yield mt(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,f&&(s.e(this,f),f.bounds&&(this.tileBounds=new xe(f.bounds,this.minzoom,this.maxzoom)),this.fire(new s.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:l})))}catch(f){this._tileJSONRequest=null,this._loaded=!0,s.Z(f)||this.fire(new s.k(f))}}))}loaded(){return this._loaded}onAdd(l){this.map=l,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(l){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),l(),this.load(!0)}setTiles(l){return this.setSourceProperty((()=>{this._options.tiles=l})),this}setUrl(l){return this.setSourceProperty((()=>{this.url=l,this._options.url=l})),this}serialize(){return s.e({},this._options)}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l){return s._(this,void 0,void 0,(function*(){const f=l.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);l.abortController=new AbortController;try{const v=yield G.getImage(this.map._requestManager.transformRequest(f,"Tile"),l.abortController,this.map._refreshExpiredTiles);if(delete l.abortController,l.aborted)return void(l.state="unloaded");if(v&&v.data){this.map._refreshExpiredTiles&&(v.cacheControl||v.expires)&&l.setExpiryData({cacheControl:v.cacheControl,expires:v.expires});const w=this.map.painter.context,I=w.gl,k=v.data;l.texture=this.map.painter.getTileTexture(k.width),l.texture?l.texture.update(k,{useMipmap:!0}):(l.texture=new s.T(w,k,I.RGBA,{useMipmap:!0}),l.texture.bind(I.LINEAR,I.CLAMP_TO_EDGE,I.LINEAR_MIPMAP_NEAREST)),l.state="loaded"}}catch(v){if(delete l.abortController,l.aborted)l.state="unloaded";else if(v)throw l.state="errored",v}}))}abortTile(l){return s._(this,void 0,void 0,(function*(){l.abortController&&(l.abortController.abort(),delete l.abortController)}))}unloadTile(l){return s._(this,void 0,void 0,(function*(){l.texture&&this.map.painter.saveTileTexture(l.texture)}))}hasTransition(){return!1}}class ie extends be{constructor(l,f,v,w){super(l,f,v,w),this.type="raster-dem",this.maxzoom=22,this._options=s.e({type:"raster-dem"},f),this.encoding=f.encoding||"mapbox",this.redFactor=f.redFactor,this.greenFactor=f.greenFactor,this.blueFactor=f.blueFactor,this.baseShift=f.baseShift}loadTile(l){return s._(this,void 0,void 0,(function*(){const f=l.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),v=this.map._requestManager.transformRequest(f,"Tile");l.neighboringTiles=this._getNeighboringTiles(l.tileID),l.abortController=new AbortController;try{const w=yield G.getImage(v,l.abortController,this.map._refreshExpiredTiles);if(delete l.abortController,l.aborted)return void(l.state="unloaded");if(w&&w.data){const I=w.data;this.map._refreshExpiredTiles&&(w.cacheControl||w.expires)&&l.setExpiryData({cacheControl:w.cacheControl,expires:w.expires});const k=s.b(I)&&s.$()?I:yield this.readImageNow(I),B={type:this.type,uid:l.uid,source:this.id,rawImageData:k,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!l.actor||l.state==="expired"){l.actor=this.dispatcher.getActor();const W=yield l.actor.sendAsync({type:"LDT",data:B});l.dem=W,l.needsHillshadePrepare=!0,l.needsTerrainPrepare=!0,l.state="loaded"}}}catch(w){if(delete l.abortController,l.aborted)l.state="unloaded";else if(w)throw l.state="errored",w}}))}readImageNow(l){return s._(this,void 0,void 0,(function*(){if(typeof VideoFrame<"u"&&s.a0()){const f=l.width+2,v=l.height+2;try{return new s.R({width:f,height:v},yield s.a1(l,-1,-1,f,v))}catch{}}return b.getImageData(l,1)}))}_getNeighboringTiles(l){const f=l.canonical,v=Math.pow(2,f.z),w=(f.x-1+v)%v,I=f.x===0?l.wrap-1:l.wrap,k=(f.x+1+v)%v,B=f.x+1===v?l.wrap+1:l.wrap,W={};return W[new s.a2(l.overscaledZ,I,f.z,w,f.y).key]={backfilled:!1},W[new s.a2(l.overscaledZ,B,f.z,k,f.y).key]={backfilled:!1},f.y>0&&(W[new s.a2(l.overscaledZ,I,f.z,w,f.y-1).key]={backfilled:!1},W[new s.a2(l.overscaledZ,l.wrap,f.z,f.x,f.y-1).key]={backfilled:!1},W[new s.a2(l.overscaledZ,B,f.z,k,f.y-1).key]={backfilled:!1}),f.y+1<v&&(W[new s.a2(l.overscaledZ,I,f.z,w,f.y+1).key]={backfilled:!1},W[new s.a2(l.overscaledZ,l.wrap,f.z,f.x,f.y+1).key]={backfilled:!1},W[new s.a2(l.overscaledZ,B,f.z,k,f.y+1).key]={backfilled:!1}),W}unloadTile(l){return s._(this,void 0,void 0,(function*(){l.demTexture&&this.map.painter.saveTileTexture(l.demTexture),l.fbo&&(l.fbo.destroy(),delete l.fbo),l.dem&&delete l.dem,delete l.neighboringTiles,l.state="unloaded",l.actor&&(yield l.actor.sendAsync({type:"RDT",data:{type:this.type,uid:l.uid,source:this.id}}))}))}}function ae(A){return A.type==="GeometryCollection"?A.geometries.map((l=>l.coordinates)).flat(1/0):A.coordinates.flat(1/0)}function De(A){const l=new Ce;let f;switch(A.type){case"FeatureCollection":f=A.features.map((v=>ae(v.geometry))).flat(1/0);break;case"Feature":f=ae(A.geometry);break;default:f=ae(A)}if(f.length==0)return l;for(let v=0;v<f.length-1;v+=2)l.extend([f[v],f[v+1]]);return l}class Xe extends s.E{constructor(l,f,v,w){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._isUpdatingWorker=!1,this._pendingWorkerUpdate={data:f.data},this.actor=v.getActor(),this.setEventedParent(w),this._data=typeof f.data=="string"?{url:f.data}:{geojson:f.data},this._options=s.e({},f),this._collectResourceTiming=f.collectResourceTiming,f.maxzoom!==void 0&&(this.maxzoom=f.maxzoom),f.type&&(this.type=f.type),f.attribution&&(this.attribution=f.attribution),this.promoteId=f.promoteId,f.clusterMaxZoom!==void 0&&this.maxzoom<=f.clusterMaxZoom&&s.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${f.clusterMaxZoom}".`),this.workerOptions=s.e({source:this.id,cluster:f.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(f.buffer!==void 0?f.buffer:128),tolerance:this._pixelsToTileUnits(f.tolerance!==void 0?f.tolerance:.375),extent:s.a5,maxZoom:this.maxzoom,lineMetrics:f.lineMetrics||!1,generateId:f.generateId||!1},superclusterOptions:{maxZoom:this._getClusterMaxZoom(f.clusterMaxZoom),minPoints:Math.max(2,f.clusterMinPoints||2),extent:s.a5,radius:this._pixelsToTileUnits(f.clusterRadius||50),log:!1,generateId:f.generateId||!1},clusterProperties:f.clusterProperties,filter:f.filter},f.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_hasPendingWorkerUpdate(){return this._pendingWorkerUpdate.data!==void 0||this._pendingWorkerUpdate.diff!==void 0||this._pendingWorkerUpdate.optionsChanged}_pixelsToTileUnits(l){return l*(s.a5/this.tileSize)}_getClusterMaxZoom(l){const f=l?Math.round(l):this.maxzoom-1;return Number.isInteger(l)||l===void 0||s.w(`Integer expected for option 'clusterMaxZoom': provided value "${l}" rounded to "${f}"`),f}load(){return s._(this,void 0,void 0,(function*(){yield this._updateWorkerData()}))}onAdd(l){this.map=l,this.load()}setData(l,f){this._data=typeof l=="string"?{url:l}:{geojson:l},this._pendingWorkerUpdate={data:l};const v=this._updateWorkerData();return f?v:this}updateData(l,f){this._pendingWorkerUpdate.diff=s.a6(this._pendingWorkerUpdate.diff,l);const v=this._updateWorkerData();return f?v:this}getData(){return s._(this,void 0,void 0,(function*(){const l=s.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:l})}))}getBounds(){return s._(this,void 0,void 0,(function*(){return De(yield this.getData())}))}setClusterOptions(l){return this.workerOptions.cluster=l.cluster,l.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(l.clusterRadius)),l.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=this._getClusterMaxZoom(l.clusterMaxZoom)),this._pendingWorkerUpdate.optionsChanged=!0,this._updateWorkerData(),this}getClusterExpansionZoom(l){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:l,source:this.id}})}getClusterChildren(l){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:l,source:this.id}})}getClusterLeaves(l,f,v){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:l,limit:f,offset:v}})}_updateWorkerData(){return s._(this,void 0,void 0,(function*(){if(this._isUpdatingWorker)return;if(!this._hasPendingWorkerUpdate())return void s.w(`No pending worker updates for GeoJSONSource ${this.id}.`);const{data:l,diff:f}=this._pendingWorkerUpdate,v=s.e({type:this.type},this.workerOptions);l!==void 0?(typeof l=="string"?(v.request=this.map._requestManager.transformRequest(b.resolveURL(l),"Source"),v.request.collectResourceTiming=this._collectResourceTiming):v.data=l,this._pendingWorkerUpdate.data=void 0):f&&(v.dataDiff=f,this._pendingWorkerUpdate.diff=void 0),this._pendingWorkerUpdate.optionsChanged=void 0,this._isUpdatingWorker=!0,this.fire(new s.l("dataloading",{dataType:"source"}));try{const w=yield this.actor.sendAsync({type:"LD",data:v});if(this._isUpdatingWorker=!1,this._removed||w.abandoned)return void this.fire(new s.l("dataabort",{dataType:"source"}));w.data&&(this._data={geojson:w.data});const I=this._applyDiffToSource(f),k=this._getShouldReloadTileOptions(I);let B=null;w.resourceTiming&&w.resourceTiming[this.id]&&(B=w.resourceTiming[this.id].slice(0));const W={dataType:"source"};this._collectResourceTiming&&B&&B.length>0&&s.e(W,{resourceTiming:B}),this.fire(new s.l("data",Object.assign(Object.assign({},W),{sourceDataType:"metadata"}))),this.fire(new s.l("data",Object.assign(Object.assign({},W),{sourceDataType:"content",shouldReloadTileOptions:k})))}catch(w){if(this._isUpdatingWorker=!1,this._removed)return void this.fire(new s.l("dataabort",{dataType:"source"}));this.fire(new s.k(w))}finally{this._hasPendingWorkerUpdate()&&this._updateWorkerData()}}))}_applyDiffToSource(l){if(!l)return;const f=typeof this.promoteId=="string"?this.promoteId:void 0;if(!this._data.url&&!this._data.updateable){const w=s.a7(this._data.geojson,f);if(!w)throw new Error(`GeoJSONSource "${this.id}": GeoJSON data is not compatible with updateData`);this._data={updateable:w}}if(!this._data.updateable)return;const v=s.a8(this._data.updateable,l,f);return l.removeAll||this._options.cluster?void 0:v}_getShouldReloadTileOptions(l){if(l)return{affectedBounds:l.filter(Boolean).map((f=>De(f)))}}shouldReloadTile(l,{affectedBounds:f}){if(l.state==="loading")return!0;if(l.state==="unloaded")return!1;const{buffer:v,extent:w}=this.workerOptions.geojsonVtOptions,I=(function({x:k,y:B,z:W},Z=0){const J=s.a3((k-Z)/Math.pow(2,W)),ue=s.a4((B+1+Z)/Math.pow(2,W)),le=s.a3((k+1+Z)/Math.pow(2,W)),_e=s.a4((B-Z)/Math.pow(2,W));return new Ce([J,ue],[le,_e])})(l.tileID.canonical,v/w);for(const k of f)if(I.intersects(k))return!0;return!1}loaded(){return!this._isUpdatingWorker&&!this._hasPendingWorkerUpdate()}loadTile(l){return s._(this,void 0,void 0,(function*(){const f=l.actor?"RT":"LT";l.actor=this.actor;const v={type:this.type,uid:l.uid,tileID:l.tileID,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};l.abortController=new AbortController;const w=yield this.actor.sendAsync({type:f,data:v},l.abortController);delete l.abortController,l.unloadVectorData(),l.aborted||l.loadVectorData(w,this.map.painter,f==="RT")}))}abortTile(l){return s._(this,void 0,void 0,(function*(){l.abortController&&(l.abortController.abort(),delete l.abortController),l.aborted=!0}))}unloadTile(l){return s._(this,void 0,void 0,(function*(){l.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:l.uid,type:this.type,source:this.id}})}))}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return s.e({},this._options,{type:this.type,data:this._data.updateable?{type:"FeatureCollection",features:Array.from(this._data.updateable.values())}:this._data.url||this._data.geojson})}hasTransition(){return!1}}class bt extends s.E{constructor(l,f,v,w){super(),this.flippedWindingOrder=!1,this.id=l,this.dispatcher=v,this.coordinates=f.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(w),this.options=f}load(l){return s._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new s.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const f=yield G.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,f&&f.data&&(this.image=f.data,l&&(this.coordinates=l),this._finishLoading())}catch(f){this._request=null,this._loaded=!0,s.Z(f)||this.fire(new s.k(f))}}))}loaded(){return this._loaded}updateImage(l){return l.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=l.url,this.load(l.coordinates).finally((()=>{this.texture=null})),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new s.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(l){this.map=l,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(l){this.coordinates=l;const f=l.map(s.a9.fromLngLat);var v;return this.tileID=(function(w){const I=s.aa.fromPoints(w),k=I.width(),B=I.height(),W=Math.max(k,B),Z=Math.max(0,Math.floor(-Math.log(W)/Math.LN2)),J=Math.pow(2,Z);return new s.ac(Z,Math.floor((I.minX+I.maxX)/2*J),Math.floor((I.minY+I.maxY)/2*J))})(f),this.terrainTileRanges=this._getOverlappingTileRanges(f),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=f.map((w=>this.tileID.getTilePoint(w)._round())),this.flippedWindingOrder=((v=this.tileCoords)[1].x-v[0].x)*(v[2].y-v[0].y)-(v[1].y-v[0].y)*(v[2].x-v[0].x)<0,this.fire(new s.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const l=this.map.painter.context,f=l.gl;this.texture||(this.texture=new s.T(l,this.image,f.RGBA),this.texture.bind(f.LINEAR,f.CLAMP_TO_EDGE));let v=!1;for(const w in this.tiles){const I=this.tiles[w];I.state!=="loaded"&&(I.state="loaded",I.texture=this.texture,v=!0)}v&&this.fire(new s.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(l){return s._(this,void 0,void 0,(function*(){this.tileID&&this.tileID.equals(l.tileID.canonical)?(this.tiles[String(l.tileID.wrap)]=l,l.buckets={}):l.state="errored"}))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}_getOverlappingTileRanges(l){const{minX:f,minY:v,maxX:w,maxY:I}=s.aa.fromPoints(l),k={};for(let B=0;B<=s.ab;B++){const W=Math.pow(2,B),Z=Math.floor(f*W),J=Math.floor(v*W),ue=Math.floor(w*W),le=Math.floor(I*W);k[B]={minTileX:Z,minTileY:J,maxTileX:ue,maxTileY:le}}return k}}class Te extends bt{constructor(l,f,v,w){super(l,f,v,w),this.roundZoom=!0,this.type="video",this.options=f}load(){return s._(this,void 0,void 0,(function*(){this._loaded=!1;const l=this.options;this.urls=[];for(const f of l.urls)this.urls.push(this.map._requestManager.transformRequest(f,"Source").url);try{const f=yield s.ad(this.urls);if(this._loaded=!0,!f)return;this.video=f,this.video.loop=!0,this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading()}catch(f){this.fire(new s.k(f))}}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){const f=this.video.seekable;l<f.start(0)||l>f.end(0)?this.fire(new s.k(new s.ae(`sources.${this.id}`,null,`Playback for this video can be set only between the ${f.start(0)} and ${f.end(0)}-second mark.`))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const l=this.map.painter.context,f=l.gl;this.texture?this.video.paused||(this.texture.bind(f.LINEAR,f.CLAMP_TO_EDGE),f.texSubImage2D(f.TEXTURE_2D,0,0,0,f.RGBA,f.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(l,this.video,f.RGBA),this.texture.bind(f.LINEAR,f.CLAMP_TO_EDGE));let v=!1;for(const w in this.tiles){const I=this.tiles[w];I.state!=="loaded"&&(I.state="loaded",I.texture=this.texture,v=!0)}v&&this.fire(new s.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class te extends bt{constructor(l,f,v,w){super(l,f,v,w),f.coordinates?Array.isArray(f.coordinates)&&f.coordinates.length===4&&!f.coordinates.some((I=>!Array.isArray(I)||I.length!==2||I.some((k=>typeof k!="number"))))||this.fire(new s.k(new s.ae(`sources.${l}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.k(new s.ae(`sources.${l}`,null,'missing required property "coordinates"'))),f.animate&&typeof f.animate!="boolean"&&this.fire(new s.k(new s.ae(`sources.${l}`,null,'optional "animate" property must be a boolean value'))),f.canvas?typeof f.canvas=="string"||f.canvas instanceof HTMLCanvasElement||this.fire(new s.k(new s.ae(`sources.${l}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.k(new s.ae(`sources.${l}`,null,'missing required property "canvas"'))),this.options=f,this.animate=f.animate===void 0||f.animate}load(){return s._(this,void 0,void 0,(function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}))}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const f=this.map.painter.context,v=f.gl;this.texture?(l||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):(this.texture=new s.T(f,this.canvas,v.RGBA,{premultiply:!0}),this.texture.bind(v.LINEAR,v.CLAMP_TO_EDGE));let w=!1;for(const I in this.tiles){const k=this.tiles[I];k.state!=="loaded"&&(k.state="loaded",k.texture=this.texture,w=!0)}w&&this.fire(new s.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",animate:this.animate,canvas:this.options.canvas,coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}}const he={},pe=A=>{switch(A){case"geojson":return Xe;case"image":return bt;case"raster":return be;case"raster-dem":return ie;case"vector":return vt;case"video":return Te;case"canvas":return te}return he[A]},Re="RTLPluginLoaded";class Oe extends s.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=we()}_syncState(l){return this.status=l,this.dispatcher.broadcast("SRPS",{pluginStatus:l,pluginURL:this.url}).catch((f=>{throw this.status="error",f}))}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(l){return s._(this,arguments,void 0,(function*(f,v=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=b.resolveURL(f),!this.url)throw new Error(`requested url ${f} is invalid`);if(this.status==="unavailable"){if(!v)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()}))}_requestImport(){return s._(this,void 0,void 0,(function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new s.l(Re))}))}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let ht=null;function pt(){return ht||(ht=new Oe),ht}var ot,St;(function(A){A[A.Base=0]="Base",A[A.Parent=1]="Parent"})(ot||(ot={})),(function(A){A[A.Departing=0]="Departing",A[A.Incoming=1]="Incoming"})(St||(St={}));class Lt{constructor(l,f){this.timeAdded=0,this.fadeEndTime=0,this.fadeOpacity=1,this.tileID=l,this.uid=s.af(),this.uses=0,this.tileSize=f,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}isRenderable(l){return this.hasData()&&(!this.fadeEndTime||this.fadeOpacity>0)&&(l||!this.holdingForSymbolFade())}setCrossFadeLogic({fadingRole:l,fadingDirection:f,fadingParentID:v,fadeEndTime:w}){this.resetFadeLogic(),this.fadingRole=l,this.fadingDirection=f,this.fadingParentID=v,this.fadeEndTime=w}setSelfFadeLogic(l){this.resetFadeLogic(),this.selfFading=!0,this.fadeEndTime=l}resetFadeLogic(){this.fadingRole=null,this.fadingDirection=null,this.fadingParentID=null,this.selfFading=!1,this.timeAdded=P(),this.fadeEndTime=0,this.fadeOpacity=1}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(l){this.demTexture&&l.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(l,f,v){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",l){l.featureIndex&&(this.latestFeatureIndex=l.featureIndex,l.rawTileData?(this.latestRawTileData=l.rawTileData,this.latestFeatureIndex.rawTileData=l.rawTileData,this.latestFeatureIndex.encoding=l.encoding):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData,this.latestFeatureIndex.encoding=this.latestEncoding)),this.collisionBoxArray=l.collisionBoxArray,this.buckets=(function(w,I){const k={};if(!I)return k;for(const B of w){const W=B.layerIds.map((Z=>I.getLayer(Z))).filter(Boolean);if(W.length!==0){B.layers=W,B.stateDependentLayerIds&&(B.stateDependentLayers=B.stateDependentLayerIds.map((Z=>W.filter((J=>J.id===Z))[0])));for(const Z of W)k[Z.id]=B}}return k})(l.buckets,f?.style),this.hasSymbolBuckets=!1;for(const w in this.buckets){const I=this.buckets[w];if(I instanceof s.ah){if(this.hasSymbolBuckets=!0,!v)break;I.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const w in this.buckets){const I=this.buckets[w];if(I instanceof s.ah&&I.hasRTLText){this.hasRTLText=!0,pt().lazyLoad();break}}this.queryPadding=0;for(const w in this.buckets){const I=this.buckets[w];this.queryPadding=Math.max(this.queryPadding,f.style.getLayer(w).queryRadius(I))}l.imageAtlas&&(this.imageAtlas=l.imageAtlas),l.glyphAtlasImage&&(this.glyphAtlasImage=l.glyphAtlasImage),this.dashPositions=l.dashPositions}else this.collisionBoxArray=new s.ag}unloadVectorData(){for(const l in this.buckets)this.buckets[l].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.dashPositions&&(this.dashPositions=null),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(l){return this.buckets[l.id]}upload(l){for(const v in this.buckets){const w=this.buckets[v];w.uploadPending()&&w.upload(l)}const f=l.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new s.T(l,this.imageAtlas.image,f.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new s.T(l,this.glyphAtlasImage,f.ALPHA),this.glyphAtlasImage=null)}prepare(l){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(l,this.imageAtlasTexture)}queryRenderedFeatures(l,f,v,w,I,k,B,W,Z,J,ue){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:w,cameraQueryGeometry:I,scale:k,tileSize:this.tileSize,pixelPosMatrix:J,transform:W,params:B,queryPadding:this.queryPadding*Z,getElevation:ue},l,f,v):{}}querySourceFeatures(l,f){const v=this.latestFeatureIndex;if(!v||!v.rawTileData)return;const w=v.loadVTLayers(),I=f&&f.sourceLayer?f.sourceLayer:"",k=w[s.ai]||w[I];if(!k)return;const B=s.aj(f?.filter,f?.globalState),{z:W,x:Z,y:J}=this.tileID.canonical,ue={z:W,x:Z,y:J};for(let le=0;le<k.length;le++){const _e=k.feature(le);if(B.needGeometry){const $e=s.ak(_e,!0);if(!B.filter(new s.H(this.tileID.overscaledZ),$e,this.tileID.canonical))continue}else if(!B.filter(new s.H(this.tileID.overscaledZ),_e))continue;const Ee=v.getId(_e,I),ze=new s.al(_e,W,Z,J,Ee);ze.tile=ue,l.push(ze)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(l){const f=this.expirationTime;if(l.cacheControl){const v=s.am(l.cacheControl);v["max-age"]&&(this.expirationTime=Date.now()+1e3*v["max-age"])}else l.expires&&(this.expirationTime=new Date(l.expires).getTime());if(this.expirationTime){const v=Date.now();let w=!1;if(this.expirationTime>v)w=!1;else if(f)if(this.expirationTime<f)w=!0;else{const I=this.expirationTime-f;I?this.expirationTime=v+Math.max(I,3e4):w=!0}else w=!0;w?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(l,f){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(l).length===0)return;const v=this.latestFeatureIndex.loadVTLayers();for(const w in this.buckets){if(!f.style.hasLayer(w))continue;const I=this.buckets[w],k=I.layers[0].sourceLayer||s.ai,B=v[k],W=l[k];if(!B||!W||Object.keys(W).length===0)continue;I.update(W,B,this.imageAtlas&&this.imageAtlas.patternPositions||{},this.dashPositions||{});const Z=f&&f.style&&f.style.getLayer(w);Z&&(this.queryPadding=Math.max(this.queryPadding,Z.queryRadius(I)))}}holdingForSymbolFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<P()}clearSymbolFadeHold(){this.symbolFadeHoldUntil=void 0}setSymbolHoldDuration(l){this.symbolFadeHoldUntil=P()+l}setDependencies(l,f){const v={};for(const w of f)v[w]=!0;this.dependencies[l]=v}hasDependency(l,f){for(const v of l){const w=this.dependencies[v];if(w){for(const I of f)if(w[I])return!0}}return!1}}class zt{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(l,f,v){const w=String(f);if(this.stateChanges[l]=this.stateChanges[l]||{},this.stateChanges[l][w]=this.stateChanges[l][w]||{},s.e(this.stateChanges[l][w],v),this.deletedStates[l]===null){this.deletedStates[l]={};for(const I in this.state[l])I!==w&&(this.deletedStates[l][I]=null)}else if(this.deletedStates[l]&&this.deletedStates[l][w]===null){this.deletedStates[l][w]={};for(const I in this.state[l][w])v[I]||(this.deletedStates[l][w][I]=null)}else for(const I in v)this.deletedStates[l]&&this.deletedStates[l][w]&&this.deletedStates[l][w][I]===null&&delete this.deletedStates[l][w][I]}removeFeatureState(l,f,v){if(this.deletedStates[l]===null)return;const w=String(f);if(this.deletedStates[l]=this.deletedStates[l]||{},v&&f!==void 0)this.deletedStates[l][w]!==null&&(this.deletedStates[l][w]=this.deletedStates[l][w]||{},this.deletedStates[l][w][v]=null);else if(f!==void 0)if(this.stateChanges[l]&&this.stateChanges[l][w])for(v in this.deletedStates[l][w]={},this.stateChanges[l][w])this.deletedStates[l][w][v]=null;else this.deletedStates[l][w]=null;else this.deletedStates[l]=null}getState(l,f){const v=String(f),w=s.e({},(this.state[l]||{})[v],(this.stateChanges[l]||{})[v]);if(this.deletedStates[l]===null)return{};if(this.deletedStates[l]){const I=this.deletedStates[l][f];if(I===null)return{};for(const k in I)delete w[k]}return w}initializeTileState(l,f){l.setFeatureState(this.state,f)}coalesceChanges(l,f){const v={};for(const w in this.stateChanges){this.state[w]=this.state[w]||{};const I={};for(const k in this.stateChanges[w])this.state[w][k]||(this.state[w][k]={}),s.e(this.state[w][k],this.stateChanges[w][k]),I[k]=this.state[w][k];v[w]=I}for(const w in this.deletedStates){this.state[w]=this.state[w]||{};const I={};if(this.deletedStates[w]===null)for(const k in this.state[w])I[k]={},this.state[w][k]={};else for(const k in this.deletedStates[w]){if(this.deletedStates[w][k]===null)this.state[w][k]={};else for(const B of Object.keys(this.deletedStates[w][k]))delete this.state[w][k][B];I[k]=this.state[w][k]}v[w]=v[w]||{},s.e(v[w],I)}this.stateChanges={},this.deletedStates={},Object.keys(v).length!==0&&l.setFeatureState(v,f)}}const Jt=89.25;function gi(A,l){const f=s.an(l.lat,-s.ao,s.ao);return new s.P(s.Y(l.lng)*A,s.X(f)*A)}function Fi(A,l){return new s.a9(l.x/A,l.y/A).toLngLat()}function un(A){return A.cameraToCenterDistance*Math.min(.85*Math.tan(s.ap(90-A.pitch)),Math.tan(s.ap(Jt-A.pitch)))}function nn(A,l){const f=A.canonical,v=l/s.aq(f.z),w=f.x+Math.pow(2,f.z)*A.wrap,I=s.ar(new Float64Array(16));return s.O(I,I,[w*v,f.y*v,0]),s.Q(I,I,[v/s.a5,v/s.a5,1]),I}function Tt(A,l,f,v,w){const I=s.a9.fromLngLat(A,l),k=w*s.as(1,A.lat),{x:B,y:W,z:Z}=hn(f,v);return new s.a9(I.x+k*-B,I.y+k*-W,I.z+k*-Z)}function hn(A,l){const f=s.ap(A),v=s.ap(l),w=Math.cos(-f),I=Math.sin(f);return{x:I*Math.sin(v),y:-I*Math.cos(v),z:w}}function fr(A,l,f){const v=l.intersectsFrustum(A);if(!f||v===0)return v;const w=l.intersectsPlane(f);return w===0?0:v===2&&w===2?2:1}function Li(A,l,f){let v=0;const w=(f-l)/10;for(let I=0;I<10;I++)v+=w*Math.pow(Math.cos(l+(I+.5)/10*(f-l)),A);return v}function gn(A,l){return function(f,v,w,I,k){const B=2*((A-1)/s.at(Math.cos(s.ap(Jt-k))/Math.cos(s.ap(Jt)))-1),W=Math.acos(w/I),Z=2*Li(B-1,0,s.ap(k/2)),J=Math.min(s.ap(Jt),W+s.ap(k/2)),ue=Li(B-1,Math.min(J,W-s.ap(k/2)),J),le=Math.atan(v/w),_e=Math.hypot(v,w);let Ee=f;return Ee+=s.at(I/_e/Math.max(.5,Math.cos(s.ap(k/2)))),Ee+=B*s.at(Math.cos(le))/2,Ee-=s.at(Math.max(1,ue/Z/l))/2,Ee}}const zn=gn(9.314,3);function wn(A,l){const f=(l.roundZoom?Math.round:Math.floor)(A.zoom+s.at(A.tileSize/l.tileSize));return Math.max(0,f)}function kn(A,l){const f=A.getCameraFrustum(),v=A.getClippingPlane(),w=A.screenPointToMercatorCoordinate(A.getCameraPoint()),I=s.a9.fromLngLat(A.center,A.elevation);w.z=I.z+Math.cos(A.pitchInRadians)*A.cameraToCenterDistance/A.worldSize;const k=A.getCoveringTilesDetailsProvider(),B=k.allowVariableZoom(A,l),W=wn(A,l),Z=l.minzoom||0,J=l.maxzoom!==void 0?l.maxzoom:A.maxZoom,ue=Math.min(Math.max(0,W),J),le=Math.pow(2,ue),_e=[le*w.x,le*w.y,0],Ee=[le*I.x,le*I.y,0],ze=Math.hypot(I.x-w.x,I.y-w.y),$e=Math.abs(I.z-w.z),Ne=Math.hypot(ze,$e),Ze=it=>({zoom:0,x:0,y:0,wrap:it,fullyVisible:!1}),rt=[],We=[];if(A.renderWorldCopies&&k.allowWorldCopies())for(let it=1;it<=3;it++)rt.push(Ze(-it)),rt.push(Ze(it));for(rt.push(Ze(0));rt.length>0;){const it=rt.pop(),lt=it.x,Qe=it.y;let _t=it.fullyVisible;const Dt={x:lt,y:Qe,z:it.zoom},At=k.getTileBoundingVolume(Dt,it.wrap,A.elevation,l);if(!_t){const ti=fr(f,At,v);if(ti===0)continue;_t=ti===2}const Pt=k.distanceToTile2d(w.x,w.y,Dt,At);let It=W;B&&(It=(l.calculateTileZoom||zn)(A.zoom+s.at(A.tileSize/l.tileSize),Pt,$e,Ne,A.fov)),It=(l.roundZoom?Math.round:Math.floor)(It),It=Math.max(0,It);const Qt=Math.min(It,J);if(it.wrap=k.getWrap(I,Dt,it.wrap),it.zoom>=Qt){if(it.zoom<Z)continue;const ti=ue-it.zoom,Xt=_e[0]-.5-(lt<<ti),oi=_e[1]-.5-(Qe<<ti),Yi=l.reparseOverscaled?Math.max(it.zoom,It):it.zoom;We.push({tileID:new s.a2(it.zoom===J?Yi:it.zoom,it.wrap,it.zoom,lt,Qe),distanceSq:s.au([Ee[0]-.5-lt,Ee[1]-.5-Qe]),tileDistanceToCamera:Math.sqrt(Xt*Xt+oi*oi)})}else for(let ti=0;ti<4;ti++)rt.push({zoom:it.zoom+1,x:(lt<<1)+ti%2,y:(Qe<<1)+(ti>>1),wrap:it.wrap,fullyVisible:_t})}return We.sort(((it,lt)=>it.distanceSq-lt.distanceSq)).map((it=>it.tileID))}const Sn=s.aa.fromPoints([new s.P(0,0),new s.P(s.a5,s.a5)]);function Kn(A){return A==="raster"||A==="image"||A==="video"}function Ye(A,l,f,v,w,I,k){if(!l.hasData())return!1;const{tileID:B,fadingRole:W,fadingDirection:Z,fadingParentID:J}=l;if(W===ot.Base&&Z===St.Incoming&&J)return f[J.key]=J,!0;const ue=Math.max(B.overscaledZ-w,I);for(let le=B.overscaledZ-1;le>=ue;le--){const _e=B.scaledTo(le),Ee=A.getLoadedTile(_e);if(Ee)return l.setCrossFadeLogic({fadingRole:ot.Base,fadingDirection:St.Incoming,fadingParentID:Ee.tileID,fadeEndTime:v+k}),Ee.setCrossFadeLogic({fadingRole:ot.Parent,fadingDirection:St.Departing,fadeEndTime:v+k}),f[_e.key]=_e,!0}return!1}function kt(A,l,f,v,w,I){if(!l.hasData())return!1;const k=l.tileID.children(w);let B=at(A,l,k,f,v,w,I);if(B)return!0;for(const W of k)at(A,l,W.children(w),f,v,w,I)&&(B=!0);return B}function at(A,l,f,v,w,I,k){if(f[0].overscaledZ>=I)return!1;let B=!1;for(const W of f){const Z=A.getLoadedTile(W);if(!Z)continue;const{fadingRole:J,fadingDirection:ue,fadingParentID:le}=Z;J===ot.Base&&ue===St.Departing&&le||(Z.setCrossFadeLogic({fadingRole:ot.Base,fadingDirection:St.Departing,fadingParentID:l.tileID,fadeEndTime:w+k}),l.setCrossFadeLogic({fadingRole:ot.Parent,fadingDirection:St.Incoming,fadeEndTime:w+k})),v[W.key]=W,B=!0}return B}function Ot(A,l,f,v){const w=A.tileID;return!!A.selfFading||!A.hasData()&&!!l.has(w)&&(A.setSelfFadeLogic(f+v),!0)}function Gt(A,l){var f;A.needsHillshadePrepare=!0,A.needsTerrainPrepare=!0;let v=l.tileID.canonical.x-A.tileID.canonical.x;const w=l.tileID.canonical.y-A.tileID.canonical.y,I=Math.pow(2,A.tileID.canonical.z),k=l.tileID.key;v===0&&w===0||Math.abs(w)>1||(Math.abs(v)>1&&(Math.abs(v+I)===1?v+=I:Math.abs(v-I)===1&&(v-=I)),l.dem&&A.dem&&(A.dem.backfillBorder(l.dem,v,w),!((f=A.neighboringTiles)===null||f===void 0)&&f[k]&&(A.neighboringTiles[k].backfilled=!0)))}class Gi{constructor(){this._tiles={}}handleWrapJump(l){const f={};for(const v in this._tiles){const w=this._tiles[v];w.tileID=w.tileID.unwrapTo(w.tileID.wrap+l),f[w.tileID.key]=w}this._tiles=f}setFeatureState(l,f){for(const v in this._tiles)this._tiles[v].setFeatureState(l,f)}getAllTiles(){return Object.values(this._tiles)}getAllIds(l=!1){return l?Object.values(this._tiles).map((f=>f.tileID)).sort(s.aw).map((f=>f.key)):Object.keys(this._tiles)}getTileById(l){return this._tiles[l]}setTile(l,f){this._tiles[l]=f}deleteTileById(l){delete this._tiles[l]}getLoadedTile(l){const f=this.getTileById(l.key);return f?.hasData()?f:null}isIdRenderable(l,f=!1){var v;return(v=this.getTileById(l))===null||v===void 0?void 0:v.isRenderable(f)}getRenderableIds(l=0,f){const v=[];for(const w of this.getAllIds())this.isIdRenderable(w,f)&&v.push(this.getTileById(w));return f?v.sort(((w,I)=>{const k=w.tileID,B=I.tileID,W=new s.P(k.canonical.x,k.canonical.y)._rotate(-l),Z=new s.P(B.canonical.x,B.canonical.y)._rotate(-l);return k.overscaledZ-B.overscaledZ||Z.y-W.y||Z.x-W.x})).map((w=>w.tileID.key)):v.map((w=>w.tileID)).sort(s.aw).map((w=>w.key))}}class Ci extends s.E{constructor(l,f,v){super(),this.id=l,this.dispatcher=v,this.on("data",(w=>this._dataHandler(w))),this.on("dataloading",(()=>{this._sourceErrored=!1})),this.on("error",(()=>{this._sourceErrored=this._source.loaded()})),this._source=((w,I,k,B)=>{const W=new(pe(I.type))(w,I,k,B);if(W.id!==w)throw new Error(`Expected Source id to be ${w} instead of ${W.id}`);return W})(l,f,v,this),this._inViewTiles=new Gi,this._outOfViewCache=new s.ax(0,(w=>this._unloadTile(w))),this._timers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._rasterFadeDuration=0,this._maxFadingAncestorLevels=5,this._state=new zt,this._didEmitContent=!1,this._updated=!1}onAdd(l){this.map=l,this._maxTileCacheSize=l?l._maxTileCacheSize:null,this._maxTileCacheZoomLevels=l?l._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(l)}onRemove(l){for(const f of this._inViewTiles.getAllTiles())f.unloadVectorData();this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(l),this._inViewTiles=new Gi}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const l of this._inViewTiles.getAllTiles())if(l.state!=="loaded"&&l.state!=="errored")return!1;return!0}getSource(){return this._source}getState(){return this._state}pause(){this._paused=!0}resume(){if(!this._paused)return;const l=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,l&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(l,f,v){return s._(this,void 0,void 0,(function*(){try{yield this._source.loadTile(l),this._tileLoaded(l,f,v)}catch(w){l.state="errored",w.status!==404?this._source.fire(new s.k(w,{tile:l})):this.update(this.transform,this.terrain)}}))}_unloadTile(l){this._source.unloadTile&&this._source.unloadTile(l)}_abortTile(l){this._source.abortTile&&this._source.abortTile(l),this._source.fire(new s.l("dataabort",{tile:l,coord:l.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(l){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._inViewTiles,this.map?this.map.painter:null);for(const f of this._inViewTiles.getAllTiles())f.upload(l),f.prepare(this.map.style.imageManager)}getIds(){return this._inViewTiles.getAllIds(!0)}getRenderableIds(l){var f;return this._inViewTiles.getRenderableIds((f=this.transform)===null||f===void 0?void 0:f.bearingInRadians,l)}hasRenderableParent(l){const f=l.overscaledZ-1;if(f>=this._source.minzoom){const v=this.getLoadedTile(l.scaledTo(f));if(v)return this._inViewTiles.isIdRenderable(v.tileID.key)}return!1}reload(l,f=void 0){if(this._paused)this._shouldReloadOnResume=!0;else{this._outOfViewCache.reset();for(const v of this._inViewTiles.getAllIds()){const w=this._inViewTiles.getTileById(v);f&&!this._source.shouldReloadTile(w,f)||(l?this._reloadTile(v,"expired"):w.state!=="errored"&&this._reloadTile(v,"reloading"))}}}_reloadTile(l,f){return s._(this,void 0,void 0,(function*(){const v=this._inViewTiles.getTileById(l);v&&(v.state!=="loading"&&(v.state=f),yield this._loadTile(v,l,f))}))}_tileLoaded(l,f,v){l.timeAdded=P(),l.selfFading&&(l.fadeEndTime=l.timeAdded+this._rasterFadeDuration),v==="expired"&&(l.refreshedUponExpiration=!0),this._setTileReloadTimer(f,l),this.getSource().type==="raster-dem"&&l.dem&&(function(w,I){var k,B;const W=I.getRenderableIds();for(const Z of W){if(!w.neighboringTiles||!w.neighboringTiles[Z])continue;const J=I.getTileById(Z);w.neighboringTiles[Z].backfilled||Gt(w,J),!((B=(k=J.neighboringTiles)===null||k===void 0?void 0:k[w.tileID.key])===null||B===void 0)&&B.backfilled||Gt(J,w)}})(l,this._inViewTiles),this._state.initializeTileState(l,this.map?this.map.painter:null),l.aborted||this._source.fire(new s.l("data",{dataType:"source",tile:l,coord:l.tileID}))}getTile(l){return this.getTileByID(l.key)}getTileByID(l){return this._inViewTiles.getTileById(l)}_retainLoadedChildren(l,f){const v=this._getLoadedDescendents(f),w=new Set;for(const I of f){const k=v[I.key];if(!k?.length){w.add(I);continue}const B=I.overscaledZ+Ci.maxOverzooming,W=k.filter((ue=>ue.tileID.overscaledZ<=B));if(!W.length){w.add(I);continue}const Z=Math.min(...W.map((ue=>ue.tileID.overscaledZ))),J=W.filter((ue=>ue.tileID.overscaledZ===Z)).map((ue=>ue.tileID));for(const ue of J)l[ue.key]=ue;this._areDescendentsComplete(J,Z,I.overscaledZ)||w.add(I)}return w}_getLoadedDescendents(l){var f;const v={};for(const w of this._inViewTiles.getAllTiles().filter((I=>I.hasData())))for(const I of l)w.tileID.isChildOf(I)&&(v[f=I.key]||(v[f]=[])).push(w);return v}_areDescendentsComplete(l,f,v){return l.length===1&&l[0].isOverscaled()?l[0].overscaledZ===f:Math.pow(4,f-v)===l.length}getLoadedTile(l){return this._inViewTiles.getLoadedTile(l)}updateCacheSize(l){const f=Math.ceil(l.width/this._source.tileSize)+1,v=Math.ceil(l.height/this._source.tileSize)+1,w=Math.floor(f*v*(this._maxTileCacheZoomLevels===null?s.c.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),I=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,w):w;this._outOfViewCache.setMaxSize(I)}handleWrapJump(l){const f=Math.round((l-(this._prevLng===void 0?l:this._prevLng))/360);this._prevLng=l,f&&(this._inViewTiles.handleWrapJump(f),this._resetTileReloadTimers())}update(l,f){if(!this._sourceLoaded||this._paused)return;let v;this.transform=l,this.terrain=f,this.updateCacheSize(l),this.handleWrapJump(this.transform.center.lng),this.used||this.usedForTerrain?this._source.tileID?v=l.getVisibleUnwrappedCoordinates(this._source.tileID).map((W=>new s.a2(W.canonical.z,W.wrap,W.canonical.z,W.canonical.x,W.canonical.y))):(v=kn(l,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.type==="vector"&&this.map._zoomLevelsToOverscale!==void 0?l.maxZoom-this.map._zoomLevelsToOverscale:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:f,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(v=v.filter((W=>this._source.hasTile(W))))):v=[],this.usedForTerrain&&(v=this._addTerrainIdealTiles(v));const w=v.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,w&&this.fire(new s.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const I=wn(l,this._source),k=this._updateRetainedTiles(v,I),B=Kn(this._source.type);B&&this._rasterFadeDuration>0&&!f&&(function(W,Z,J,ue,le,_e,Ee){const ze=P(),$e=s.av(Z);for(const Ne of Z){const Ze=W.getTileById(Ne.key);Ze.fadingDirection!==St.Departing&&Ze.fadeOpacity!==0||Ze.resetFadeLogic(),Ye(W,Ze,J,ze,ue,le,Ee)||kt(W,Ze,J,ze,_e,Ee)||Ot(Ze,$e,ze,Ee)||Ze.resetFadeLogic()}})(this._inViewTiles,v,k,this._maxFadingAncestorLevels,this._source.minzoom,this._source.maxzoom,this._rasterFadeDuration),B?this._cleanUpRasterTiles(k):this._cleanUpVectorTiles(k)}_cleanUpRasterTiles(l){for(const f of this._inViewTiles.getAllIds())l[f]||this._removeTile(f)}_cleanUpVectorTiles(l){for(const f of this._inViewTiles.getAllIds()){const v=this._inViewTiles.getTileById(f);l[f]?v.clearSymbolFadeHold():v.hasSymbolBuckets?v.holdingForSymbolFade()?v.symbolFadeFinished()&&this._removeTile(f):v.setSymbolHoldDuration(this.map._fadeDuration):this._removeTile(f)}}_addTerrainIdealTiles(l){const f=[];for(const v of l)if(v.canonical.z>this._source.minzoom){const w=v.scaledTo(v.canonical.z-1);f.push(w);const I=v.scaledTo(Math.max(this._source.minzoom,Math.min(v.canonical.z,5)));f.push(I)}return l.concat(f)}releaseSymbolFadeTiles(){for(const l of this._inViewTiles.getAllIds())this._inViewTiles.getTileById(l).holdingForSymbolFade()&&this._removeTile(l)}_updateRetainedTiles(l,f){var v;const w=new Set;for(const Z of l)this._addTile(Z).hasData()||w.add(Z);const I=l.reduce(((Z,J)=>(Z[J.key]=J,Z)),{}),k=this._retainLoadedChildren(I,w),B={},W=Math.max(f-Ci.maxUnderzooming,this._source.minzoom);for(const Z of k){let J=this._inViewTiles.getTileById(Z.key),ue=J?.wasRequested();for(let le=Z.overscaledZ-1;le>=W;--le){const _e=Z.scaledTo(le);if(B[_e.key])break;if(B[_e.key]=!0,J=this.getTile(_e),!J&&ue&&(J=this._addTile(_e)),J){const Ee=J.hasData();if((Ee||!(!((v=this.map)===null||v===void 0)&&v.cancelPendingTileRequestsWhileZooming)||ue)&&(I[_e.key]=_e),ue=J.wasRequested(),Ee)break}}}return I}_addTile(l){let f=this._inViewTiles.getTileById(l.key);if(f)return f;f=this._outOfViewCache.getAndRemove(l),f&&(f.resetFadeLogic(),this._setTileReloadTimer(l.key,f),f.tileID=l,this._state.initializeTileState(f,this.map?this.map.painter:null));const v=f;return f||(f=new Lt(l,this._source.tileSize*l.overscaleFactor()),this._loadTile(f,l.key,f.state)),f.uses++,this._inViewTiles.setTile(l.key,f),v||this._source.fire(new s.l("dataloading",{tile:f,coord:f.tileID,dataType:"source"})),f}_setTileReloadTimer(l,f){this._clearTileReloadTimer(l);const v=f.getExpiryTimeout();v&&(this._timers[l]=setTimeout((()=>{this._reloadTile(l,"expired"),delete this._timers[l]}),v))}_clearTileReloadTimer(l){const f=this._timers[l];f&&(clearTimeout(f),delete this._timers[l])}_resetTileReloadTimers(){for(const l in this._timers)clearTimeout(this._timers[l]),delete this._timers[l];for(const l of this._inViewTiles.getAllIds()){const f=this._inViewTiles.getTileById(l);this._setTileReloadTimer(l,f)}}refreshTiles(l){for(const f of this._inViewTiles.getAllIds()){const v=this._inViewTiles.getTileById(f);(this._inViewTiles.isIdRenderable(f)||v.state=="errored")&&l.some((w=>w.equals(v.tileID.canonical)))&&this._reloadTile(f,"expired")}}_removeTile(l){const f=this._inViewTiles.getTileById(l);f&&(f.uses--,this._inViewTiles.deleteTileById(l),this._clearTileReloadTimer(l),f.uses>0||(f.hasData()&&f.state!=="reloading"?this._outOfViewCache.add(f.tileID,f,f.getExpiryTimeout()):(f.aborted=!0,this._abortTile(f),this._unloadTile(f))))}_dataHandler(l){l.dataType==="source"&&(l.sourceDataType!=="metadata"?l.sourceDataType==="content"&&this._sourceLoaded&&!this._paused&&(this.reload(l.sourceDataChanged,l.shouldReloadTileOptions),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0):this._sourceLoaded=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const l of this._inViewTiles.getAllIds())this._removeTile(l);this._outOfViewCache.reset()}tilesIn(l,f,v){const w=[],I=this.transform;if(!I)return w;const k=I.getCoveringTilesDetailsProvider().allowWorldCopies(),B=v?I.getCameraQueryGeometry(l):l,W=_e=>I.screenPointToMercatorCoordinate(_e,this.terrain),Z=this.transformBbox(l,W,!k),J=this.transformBbox(B,W,!k),ue=this.getIds(),le=s.aa.fromPoints(J);for(let _e=0;_e<ue.length;_e++){const Ee=this._inViewTiles.getTileById(ue[_e]);if(Ee.holdingForSymbolFade())continue;const ze=k?[Ee.tileID]:[Ee.tileID.unwrapTo(-1),Ee.tileID.unwrapTo(0)],$e=Math.pow(2,I.zoom-Ee.tileID.overscaledZ),Ne=f*Ee.queryPadding*s.a5/Ee.tileSize/$e;for(const Ze of ze){const rt=le.map((We=>Ze.getTilePoint(new s.a9(We.x,We.y))));if(rt.expandBy(Ne),rt.intersects(Sn)){const We=Z.map((lt=>Ze.getTilePoint(lt))),it=J.map((lt=>Ze.getTilePoint(lt)));w.push({tile:Ee,tileID:k?Ze:Ze.unwrapTo(0),queryGeometry:We,cameraQueryGeometry:it,scale:$e})}}}return w}transformBbox(l,f,v){let w=l.map(f);if(v){const I=s.aa.fromPoints(l);I.shrinkBy(.001*Math.min(I.width(),I.height()));const k=I.map(f);s.aa.fromPoints(w).covers(k)||(w=w.map((B=>B.x>.5?new s.a9(B.x-1,B.y,B.z):B)))}return w}getVisibleCoordinates(l){const f=this.getRenderableIds(l).map((v=>this._inViewTiles.getTileById(v).tileID));return this.transform&&this.transform.populateCache(f),f}hasTransition(){return!!this._source.hasTransition()||!(!Kn(this._source.type)||!(function(l,f){if(f<=0)return!1;const v=P();for(const w of l.getAllTiles())if(w.fadeEndTime>=v)return!0;return!1})(this._inViewTiles,this._rasterFadeDuration))}setRasterFadeDuration(l){this._rasterFadeDuration=l}setFeatureState(l,f,v){this._state.updateState(l=l||s.ai,f,v)}removeFeatureState(l,f,v){this._state.removeFeatureState(l=l||s.ai,f,v)}getFeatureState(l,f){return this._state.getState(l=l||s.ai,f)}setDependencies(l,f,v){const w=this._inViewTiles.getTileById(l);w&&w.setDependencies(f,v)}reloadTilesForDependencies(l,f){for(const v of this._inViewTiles.getAllIds())this._inViewTiles.getTileById(v).hasDependency(l,f)&&this._reloadTile(v,"reloading");this._outOfViewCache.filter((v=>!v.hasDependency(l,f)))}areTilesLoaded(){for(const l of this._inViewTiles.getAllTiles())if(l.state!=="loaded"&&l.state!=="errored")return!1;return!0}}Ci.maxUnderzooming=10,Ci.maxOverzooming=3;class Nt{constructor(l,f){this.reset(l,f)}reset(l,f){this.points=l||[],this._distances=[0];for(let v=1;v<this.points.length;v++)this._distances[v]=this._distances[v-1]+this.points[v].dist(this.points[v-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(f||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(l){if(this.points.length===1)return this.points[0];l=s.an(l,0,1);let f=1,v=this._distances[f];const w=l*this.paddedLength+this.padding;for(;v<w&&f<this._distances.length;)v=this._distances[++f];const I=f-1,k=this._distances[I],B=v-k,W=B>0?(w-k)/B:0;return this.points[I].mult(1-W).add(this.points[f].mult(W))}}function si(A,l){let f=!0;return A==="always"||A!=="never"&&l!=="never"||(f=!1),f}class pi{constructor(l,f,v){const w=this.boxCells=[],I=this.circleCells=[];this.xCellCount=Math.ceil(l/v),this.yCellCount=Math.ceil(f/v);for(let k=0;k<this.xCellCount*this.yCellCount;k++)w.push([]),I.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=l,this.height=f,this.xScale=this.xCellCount/l,this.yScale=this.yCellCount/f,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(l,f,v,w,I){this._forEachCell(f,v,w,I,this._insertBoxCell,this.boxUid++),this.boxKeys.push(l),this.bboxes.push(f),this.bboxes.push(v),this.bboxes.push(w),this.bboxes.push(I)}insertCircle(l,f,v,w){this._forEachCell(f-w,v-w,f+w,v+w,this._insertCircleCell,this.circleUid++),this.circleKeys.push(l),this.circles.push(f),this.circles.push(v),this.circles.push(w)}_insertBoxCell(l,f,v,w,I,k){this.boxCells[I].push(k)}_insertCircleCell(l,f,v,w,I,k){this.circleCells[I].push(k)}_query(l,f,v,w,I,k,B){if(v<0||l>this.width||w<0||f>this.height)return[];const W=[];if(l<=0&&f<=0&&this.width<=v&&this.height<=w){if(I)return[{key:null,x1:l,y1:f,x2:v,y2:w}];for(let Z=0;Z<this.boxKeys.length;Z++)W.push({key:this.boxKeys[Z],x1:this.bboxes[4*Z],y1:this.bboxes[4*Z+1],x2:this.bboxes[4*Z+2],y2:this.bboxes[4*Z+3]});for(let Z=0;Z<this.circleKeys.length;Z++){const J=this.circles[3*Z],ue=this.circles[3*Z+1],le=this.circles[3*Z+2];W.push({key:this.circleKeys[Z],x1:J-le,y1:ue-le,x2:J+le,y2:ue+le})}}else this._forEachCell(l,f,v,w,this._queryCell,W,{hitTest:I,overlapMode:k,seenUids:{box:{},circle:{}}},B);return W}query(l,f,v,w){return this._query(l,f,v,w,!1,null)}hitTest(l,f,v,w,I,k){return this._query(l,f,v,w,!0,I,k).length>0}hitTestCircle(l,f,v,w,I){const k=l-v,B=l+v,W=f-v,Z=f+v;if(B<0||k>this.width||Z<0||W>this.height)return!1;const J=[];return this._forEachCell(k,W,B,Z,this._queryCellCircle,J,{hitTest:!0,overlapMode:w,circle:{x:l,y:f,radius:v},seenUids:{box:{},circle:{}}},I),J.length>0}_queryCell(l,f,v,w,I,k,B,W){const{seenUids:Z,hitTest:J,overlapMode:ue}=B,le=this.boxCells[I];if(le!==null){const Ee=this.bboxes;for(const ze of le)if(!Z.box[ze]){Z.box[ze]=!0;const $e=4*ze,Ne=this.boxKeys[ze];if(l<=Ee[$e+2]&&f<=Ee[$e+3]&&v>=Ee[$e+0]&&w>=Ee[$e+1]&&(!W||W(Ne))&&(!J||!si(ue,Ne.overlapMode))&&(k.push({key:Ne,x1:Ee[$e],y1:Ee[$e+1],x2:Ee[$e+2],y2:Ee[$e+3]}),J))return!0}}const _e=this.circleCells[I];if(_e!==null){const Ee=this.circles;for(const ze of _e)if(!Z.circle[ze]){Z.circle[ze]=!0;const $e=3*ze,Ne=this.circleKeys[ze];if(this._circleAndRectCollide(Ee[$e],Ee[$e+1],Ee[$e+2],l,f,v,w)&&(!W||W(Ne))&&(!J||!si(ue,Ne.overlapMode))){const Ze=Ee[$e],rt=Ee[$e+1],We=Ee[$e+2];if(k.push({key:Ne,x1:Ze-We,y1:rt-We,x2:Ze+We,y2:rt+We}),J)return!0}}}return!1}_queryCellCircle(l,f,v,w,I,k,B,W){const{circle:Z,seenUids:J,overlapMode:ue}=B,le=this.boxCells[I];if(le!==null){const Ee=this.bboxes;for(const ze of le)if(!J.box[ze]){J.box[ze]=!0;const $e=4*ze,Ne=this.boxKeys[ze];if(this._circleAndRectCollide(Z.x,Z.y,Z.radius,Ee[$e+0],Ee[$e+1],Ee[$e+2],Ee[$e+3])&&(!W||W(Ne))&&!si(ue,Ne.overlapMode))return k.push(!0),!0}}const _e=this.circleCells[I];if(_e!==null){const Ee=this.circles;for(const ze of _e)if(!J.circle[ze]){J.circle[ze]=!0;const $e=3*ze,Ne=this.circleKeys[ze];if(this._circlesCollide(Ee[$e],Ee[$e+1],Ee[$e+2],Z.x,Z.y,Z.radius)&&(!W||W(Ne))&&!si(ue,Ne.overlapMode))return k.push(!0),!0}}}_forEachCell(l,f,v,w,I,k,B,W){const Z=this._convertToXCellCoord(l),J=this._convertToYCellCoord(f),ue=this._convertToXCellCoord(v),le=this._convertToYCellCoord(w);for(let _e=Z;_e<=ue;_e++)for(let Ee=J;Ee<=le;Ee++)if(I.call(this,l,f,v,w,this.xCellCount*Ee+_e,k,B,W))return}_convertToXCellCoord(l){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(l*this.xScale)))}_convertToYCellCoord(l){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(l*this.yScale)))}_circlesCollide(l,f,v,w,I,k){const B=w-l,W=I-f,Z=v+k;return Z*Z>B*B+W*W}_circleAndRectCollide(l,f,v,w,I,k,B){const W=(k-w)/2,Z=Math.abs(l-(w+W));if(Z>W+v)return!1;const J=(B-I)/2,ue=Math.abs(f-(I+J));if(ue>J+v)return!1;if(Z<=W||ue<=J)return!0;const le=Z-W,_e=ue-J;return le*le+_e*_e<=v*v}}function Wi(A,l,f){const v=s.N();if(!A){const{vecSouth:ue,vecEast:le}=Ri(l),_e=p();_e[0]=le[0],_e[1]=le[1],_e[2]=ue[0],_e[3]=ue[1],w=_e,(J=(k=(I=_e)[0])*(Z=I[3])-(W=I[2])*(B=I[1]))&&(w[0]=Z*(J=1/J),w[1]=-B*J,w[2]=-W*J,w[3]=k*J),v[0]=_e[0],v[1]=_e[1],v[4]=_e[2],v[5]=_e[3]}var w,I,k,B,W,Z,J;return s.Q(v,v,[1/f,1/f,1]),v}function wt(A,l,f,v){if(A){const w=s.N();if(!l){const{vecSouth:I,vecEast:k}=Ri(f);w[0]=k[0],w[1]=k[1],w[4]=I[0],w[5]=I[1]}return s.Q(w,w,[v,v,1]),w}return f.pixelsToClipSpaceMatrix}function Ri(A){const l=Math.cos(A.rollInRadians),f=Math.sin(A.rollInRadians),v=Math.cos(A.pitchInRadians),w=Math.cos(A.bearingInRadians),I=Math.sin(A.bearingInRadians),k=s.aC();k[0]=-w*v*f-I*l,k[1]=-I*v*f+w*l;const B=s.aD(k);B<1e-9?s.aE(k):s.aF(k,k,1/B);const W=s.aC();W[0]=w*v*l-I*f,W[1]=I*v*l+w*f;const Z=s.aD(W);return Z<1e-9?s.aE(W):s.aF(W,W,1/Z),{vecEast:W,vecSouth:k}}function bi(A,l,f,v){let w;v?(w=[A,l,v(A,l),1],s.aH(w,w,f)):(w=[A,l,0,1],Zl(w,w,f));const I=w[3];return{point:new s.P(w[0]/I,w[1]/I),signedDistanceFromCamera:I,isOccluded:!1}}function Vi(A,l){return .5+A/l*.5}function Jn(A,l){return A.x>=-l[0]&&A.x<=l[0]&&A.y>=-l[1]&&A.y<=l[1]}function Xi(A,l,f,v,w,I,k,B,W,Z,J,ue,le){const _e=f?A.textSizeData:A.iconSizeData,Ee=s.ay(_e,l.transform.zoom),ze=[256/l.width*2+1,256/l.height*2+1],$e=f?A.text.dynamicLayoutVertexArray:A.icon.dynamicLayoutVertexArray;$e.clear();const Ne=A.lineVertexArray,Ze=f?A.text.placedSymbolArray:A.icon.placedSymbolArray,rt=l.transform.width/l.transform.height;let We=!1;for(let it=0;it<Ze.length;it++){const lt=Ze.get(it);if(lt.hidden||lt.writingMode===s.az.vertical&&!We){Hl(lt.numGlyphs,$e);continue}We=!1;const Qe=new s.P(lt.anchorX,lt.anchorY),_t={getElevation:le,pitchedLabelPlaneMatrix:v,lineVertexArray:Ne,pitchWithMap:I,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:l.transform,tileAnchorPoint:Qe,unwrappedTileID:W,width:Z,height:J,translation:ue},Dt=so(lt.anchorX,lt.anchorY,_t);if(!Jn(Dt.point,ze)){Hl(lt.numGlyphs,$e);continue}const At=Vi(l.transform.cameraToCenterDistance,Dt.signedDistanceFromCamera),Pt=s.aA(_e,Ee,lt),It=I?Pt*l.transform.getPitchedTextCorrection(lt.anchorX,lt.anchorY,W)/At:Pt*At,Qt=zr({projectionContext:_t,pitchedLabelPlaneMatrixInverse:w,symbol:lt,fontSize:It,flip:!1,keepUpright:k,glyphOffsetArray:A.glyphOffsetArray,dynamicLayoutVertexArray:$e,aspectRatio:rt,rotateToLine:B});We=Qt.useVertical,(Qt.notEnoughRoom||We||Qt.needsFlipping&&zr({projectionContext:_t,pitchedLabelPlaneMatrixInverse:w,symbol:lt,fontSize:It,flip:!0,keepUpright:k,glyphOffsetArray:A.glyphOffsetArray,dynamicLayoutVertexArray:$e,aspectRatio:rt,rotateToLine:B}).notEnoughRoom)&&Hl(lt.numGlyphs,$e)}f?A.text.dynamicLayoutVertexBuffer.updateData($e):A.icon.dynamicLayoutVertexBuffer.updateData($e)}function Gn(A,l,f,v,w,I,k,B){const W=I.glyphStartIndex+I.numGlyphs,Z=I.lineStartIndex,J=I.lineStartIndex+I.lineLength,ue=l.getoffsetX(I.glyphStartIndex),le=l.getoffsetX(W-1),_e=Ar(A*ue,f,v,w,I.segment,Z,J,B,k);if(!_e)return null;const Ee=Ar(A*le,f,v,w,I.segment,Z,J,B,k);return Ee?B.projectionCache.anyProjectionOccluded?null:{first:_e,last:Ee}:null}function on(A,l,f,v){return A===s.az.horizontal&&Math.abs(f.y-l.y)>Math.abs(f.x-l.x)*v?{useVertical:!0}:(A===s.az.vertical?l.y<f.y:l.x>f.x)?{needsFlipping:!0}:null}function zr(A){const{projectionContext:l,pitchedLabelPlaneMatrixInverse:f,symbol:v,fontSize:w,flip:I,keepUpright:k,glyphOffsetArray:B,dynamicLayoutVertexArray:W,aspectRatio:Z,rotateToLine:J}=A,ue=w/24,le=v.lineOffsetX*ue,_e=v.lineOffsetY*ue;let Ee;if(v.numGlyphs>1){const ze=v.glyphStartIndex+v.numGlyphs,$e=v.lineStartIndex,Ne=v.lineStartIndex+v.lineLength,Ze=Gn(ue,B,le,_e,I,v,J,l);if(!Ze)return{notEnoughRoom:!0};const rt=ns(Ze.first.point.x,Ze.first.point.y,l,f),We=ns(Ze.last.point.x,Ze.last.point.y,l,f);if(k&&!I){const it=on(v.writingMode,rt,We,Z);if(it)return it}Ee=[Ze.first];for(let it=v.glyphStartIndex+1;it<ze-1;it++){const lt=Ar(ue*B.getoffsetX(it),le,_e,I,v.segment,$e,Ne,l,J);if(!lt)return{notEnoughRoom:!0};Ee.push(lt)}Ee.push(Ze.last)}else{if(k&&!I){const $e=rn(l.tileAnchorPoint.x,l.tileAnchorPoint.y,l).point,Ne=v.lineStartIndex+v.segment+1,Ze=new s.P(l.lineVertexArray.getx(Ne),l.lineVertexArray.gety(Ne)),rt=rn(Ze.x,Ze.y,l),We=rt.signedDistanceFromCamera>0?rt.point:qn(l.tileAnchorPoint,Ze,$e,1,l),it=ns($e.x,$e.y,l,f),lt=ns(We.x,We.y,l,f),Qe=on(v.writingMode,it,lt,Z);if(Qe)return Qe}const ze=Ar(ue*B.getoffsetX(v.glyphStartIndex),le,_e,I,v.segment,v.lineStartIndex,v.lineStartIndex+v.lineLength,l,J);if(!ze||l.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};Ee=[ze]}for(const ze of Ee)s.aG(W,ze.point,ze.angle);return{}}function qn(A,l,f,v,w){const I=A.add(A.sub(l)._unit()),k=rn(I.x,I.y,w).point,B=f.sub(k);return f.add(B._mult(v/B.mag()))}function an(A,l,f){const v=l.projectionCache;if(v.projections[A])return v.projections[A];const w=new s.P(l.lineVertexArray.getx(A),l.lineVertexArray.gety(A)),I=rn(w.x,w.y,l);if(I.signedDistanceFromCamera>0)return v.projections[A]=I.point,v.anyProjectionOccluded=v.anyProjectionOccluded||I.isOccluded,I.point;const k=A-f.direction;return qn(f.distanceFromAnchor===0?l.tileAnchorPoint:new s.P(l.lineVertexArray.getx(k),l.lineVertexArray.gety(k)),w,f.previousVertex,f.absOffsetX-f.distanceFromAnchor+1,l)}function rn(A,l,f){const v=A+f.translation[0],w=l+f.translation[1];let I;return f.pitchWithMap?(I=bi(v,w,f.pitchedLabelPlaneMatrix,f.getElevation),I.isOccluded=!1):(I=f.transform.projectTileCoordinates(v,w,f.unwrappedTileID,f.getElevation),I.point.x=(.5*I.point.x+.5)*f.width,I.point.y=(.5*-I.point.y+.5)*f.height),I}function ns(A,l,f,v){if(f.pitchWithMap){const w=[A,l,0,1];return s.aH(w,w,v),f.transform.projectTileCoordinates(w[0]/w[3],w[1]/w[3],f.unwrappedTileID,f.getElevation).point}return{x:A/f.width*2-1,y:1-l/f.height*2}}function so(A,l,f){return f.transform.projectTileCoordinates(A,l,f.unwrappedTileID,f.getElevation)}function pl(A,l,f){return A._unit()._perp()._mult(l*f)}function To(A,l,f,v,w,I,k,B,W){if(B.projectionCache.offsets[A])return B.projectionCache.offsets[A];const Z=f.add(l);if(A+W.direction<v||A+W.direction>=w)return B.projectionCache.offsets[A]=Z,Z;const J=an(A+W.direction,B,W),ue=pl(J.sub(f),k,W.direction),le=f.add(ue),_e=J.add(ue);return B.projectionCache.offsets[A]=s.aI(I,Z,le,_e)||Z,B.projectionCache.offsets[A]}function Ar(A,l,f,v,w,I,k,B,W){const Z=v?A-l:A+l;let J=Z>0?1:-1,ue=0;v&&(J*=-1,ue=Math.PI),J<0&&(ue+=Math.PI);let le,_e=J>0?I+w:I+w+1;B.projectionCache.cachedAnchorPoint?le=B.projectionCache.cachedAnchorPoint:(le=rn(B.tileAnchorPoint.x,B.tileAnchorPoint.y,B).point,B.projectionCache.cachedAnchorPoint=le);let Ee,ze,$e=le,Ne=le,Ze=0,rt=0;const We=Math.abs(Z),it=[];let lt;for(;Ze+rt<=We;){if(_e+=J,_e<I||_e>=k)return null;Ze+=rt,Ne=$e,ze=Ee;const Dt={absOffsetX:We,direction:J,distanceFromAnchor:Ze,previousVertex:Ne};if($e=an(_e,B,Dt),f===0)it.push(Ne),lt=$e.sub(Ne);else{let At;const Pt=$e.sub(Ne);At=Pt.mag()===0?pl(an(_e+J,B,Dt).sub($e),f,J):pl(Pt,f,J),ze||(ze=Ne.add(At)),Ee=To(_e,At,$e,I,k,ze,f,B,Dt),it.push(ze),lt=Ee.sub(ze)}rt=lt.mag()}const Qe=lt._mult((We-Ze)/rt)._add(ze||Ne),_t=ue+Math.atan2($e.y-Ne.y,$e.x-Ne.x);return it.push(Qe),{point:Qe,angle:W?_t:0,path:it}}const rr=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Hl(A,l){for(let f=0;f<A;f++){const v=l.length;l.resize(v+4),l.float32.set(rr,3*v)}}function Zl(A,l,f){const v=l[0],w=l[1];return A[0]=f[0]*v+f[4]*w+f[12],A[1]=f[1]*v+f[5]*w+f[13],A[3]=f[3]*v+f[7]*w+f[15],A}const vr=100;class Ip{constructor(l,f=new pi(l.width+200,l.height+200,25),v=new pi(l.width+200,l.height+200,25)){this.transform=l,this.grid=f,this.ignoredGrid=v,this.pitchFactor=Math.cos(l.pitch*Math.PI/180)*l.cameraToCenterDistance,this.screenRightBoundary=l.width+vr,this.screenBottomBoundary=l.height+vr,this.gridRightBoundary=l.width+200,this.gridBottomBoundary=l.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(l,f,v,w,I,k,B,W,Z,J,ue,le){const _e=this.projectAndGetPerspectiveRatio(l.anchorPointX+W[0],l.anchorPointY+W[1],I,J,le),Ee=v*_e.perspectiveRatio;let ze;if(k||B)ze=this._projectCollisionBox(l,Ee,w,I,k,B,W,_e,J,ue,le);else{const lt=_e.x+(ue?ue.x*Ee:0),Qe=_e.y+(ue?ue.y*Ee:0);ze={allPointsOccluded:!1,box:[lt+l.x1*Ee,Qe+l.y1*Ee,lt+l.x2*Ee,Qe+l.y2*Ee]}}const[$e,Ne,Ze,rt]=ze.box,We=k?ze.allPointsOccluded:_e.isOccluded;let it=We;return it||(it=_e.perspectiveRatio<this.perspectiveRatioCutoff),it||(it=!this.isInsideGrid($e,Ne,Ze,rt)),it||f!=="always"&&this.grid.hitTest($e,Ne,Ze,rt,f,Z)?{box:[$e,Ne,Ze,rt],placeable:!1,offscreen:!1,occluded:We}:{box:[$e,Ne,Ze,rt],placeable:!0,offscreen:this.isOffscreen($e,Ne,Ze,rt),occluded:We}}placeCollisionCircles(l,f,v,w,I,k,B,W,Z,J,ue,le,_e,Ee){const ze=[],$e=new s.P(f.anchorX,f.anchorY),Ne=this.getPerspectiveRatio($e.x,$e.y,k,Ee),Ze=(Z?I*this.transform.getPitchedTextCorrection(f.anchorX,f.anchorY,k)/Ne:I*Ne)/s.aM,rt={getElevation:Ee,pitchedLabelPlaneMatrix:B,lineVertexArray:v,pitchWithMap:Z,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:$e,unwrappedTileID:k,width:this.transform.width,height:this.transform.height,translation:_e},We=Gn(Ze,w,f.lineOffsetX*Ze,f.lineOffsetY*Ze,!1,f,!1,rt);let it=!1,lt=!1,Qe=!0;if(We){const _t=.5*ue*Ne+le,Dt=new s.P(-100,-100),At=new s.P(this.screenRightBoundary,this.screenBottomBoundary),Pt=new Nt,It=We.first,Qt=We.last;let ti=[];for(let Yi=It.path.length-1;Yi>=1;Yi--)ti.push(It.path[Yi]);for(let Yi=1;Yi<Qt.path.length;Yi++)ti.push(Qt.path[Yi]);const Xt=2.5*_t;if(Z){const Yi=this.projectPathToScreenSpace(ti,rt);ti=Yi.some((Dn=>Dn.signedDistanceFromCamera<=0))?[]:Yi.map((Dn=>Dn.point))}let oi=[];if(ti.length>0){const Yi=ti[0].clone(),Dn=ti[0].clone();for(let mr=1;mr<ti.length;mr++)Yi.x=Math.min(Yi.x,ti[mr].x),Yi.y=Math.min(Yi.y,ti[mr].y),Dn.x=Math.max(Dn.x,ti[mr].x),Dn.y=Math.max(Dn.y,ti[mr].y);oi=Yi.x>=Dt.x&&Dn.x<=At.x&&Yi.y>=Dt.y&&Dn.y<=At.y?[ti]:Dn.x<Dt.x||Yi.x>At.x||Dn.y<Dt.y||Yi.y>At.y?[]:s.aJ([ti],Dt.x,Dt.y,At.x,At.y)}for(const Yi of oi){Pt.reset(Yi,.25*_t);let Dn=0;Dn=Pt.length<=.5*_t?1:Math.ceil(Pt.paddedLength/Xt)+1;for(let mr=0;mr<Dn;mr++){const Qn=mr/Math.max(Dn-1,1),xr=Pt.lerp(Qn),er=xr.x+vr,Br=xr.y+vr;ze.push(er,Br,_t,0);const wr=er-_t,Es=Br-_t,rs=er+_t,Xr=Br+_t;if(Qe=Qe&&this.isOffscreen(wr,Es,rs,Xr),lt=lt||this.isInsideGrid(wr,Es,rs,Xr),l!=="always"&&this.grid.hitTestCircle(er,Br,_t,l,J)&&(it=!0,!W))return{circles:[],offscreen:!1,collisionDetected:it}}}}return{circles:!W&&it||!lt||Ne<this.perspectiveRatioCutoff?[]:ze,offscreen:Qe,collisionDetected:it}}projectPathToScreenSpace(l,f){const v=(function(w,I){const k=s.N();return s.aB(k,I.pitchedLabelPlaneMatrix),w.map((B=>{const W=bi(B.x,B.y,k,I.getElevation),Z=I.transform.projectTileCoordinates(W.point.x,W.point.y,I.unwrappedTileID,I.getElevation);return Z.point.x=(.5*Z.point.x+.5)*I.width,Z.point.y=(.5*-Z.point.y+.5)*I.height,Z}))})(l,f);return(function(w){let I=0,k=0,B=0,W=0;for(let Z=0;Z<w.length;Z++)w[Z].isOccluded?(B=Z+1,W=0):(W++,W>k&&(k=W,I=B));return w.slice(I,I+k)})(v)}queryRenderedSymbols(l){if(l.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const f=[],v=new s.aa;for(const ue of l){const le=new s.P(ue.x+vr,ue.y+vr);v.extend(le),f.push(le)}const{minX:w,minY:I,maxX:k,maxY:B}=v,W=this.grid.query(w,I,k,B).concat(this.ignoredGrid.query(w,I,k,B)),Z={},J={};for(const ue of W){const le=ue.key;if(Z[le.bucketInstanceId]===void 0&&(Z[le.bucketInstanceId]={}),Z[le.bucketInstanceId][le.featureIndex])continue;const _e=[new s.P(ue.x1,ue.y1),new s.P(ue.x2,ue.y1),new s.P(ue.x2,ue.y2),new s.P(ue.x1,ue.y2)];s.aK(f,_e)&&(Z[le.bucketInstanceId][le.featureIndex]=!0,J[le.bucketInstanceId]===void 0&&(J[le.bucketInstanceId]=[]),J[le.bucketInstanceId].push(le.featureIndex))}return J}insertCollisionBox(l,f,v,w,I,k){(v?this.ignoredGrid:this.grid).insert({bucketInstanceId:w,featureIndex:I,collisionGroupID:k,overlapMode:f},l[0],l[1],l[2],l[3])}insertCollisionCircles(l,f,v,w,I,k){const B=v?this.ignoredGrid:this.grid,W={bucketInstanceId:w,featureIndex:I,collisionGroupID:k,overlapMode:f};for(let Z=0;Z<l.length;Z+=4)B.insertCircle(W,l[Z],l[Z+1],l[Z+2])}projectAndGetPerspectiveRatio(l,f,v,w,I){if(I){let k;w?(k=[l,f,w(l,f),1],s.aH(k,k,I)):(k=[l,f,0,1],Zl(k,k,I));const B=k[3];return{x:(k[0]/B+1)/2*this.transform.width+vr,y:(-k[1]/B+1)/2*this.transform.height+vr,perspectiveRatio:.5+this.transform.cameraToCenterDistance/B*.5,isOccluded:!1,signedDistanceFromCamera:B}}{const k=this.transform.projectTileCoordinates(l,f,v,w);return{x:(k.point.x+1)/2*this.transform.width+vr,y:(1-k.point.y)/2*this.transform.height+vr,perspectiveRatio:.5+this.transform.cameraToCenterDistance/k.signedDistanceFromCamera*.5,isOccluded:k.isOccluded,signedDistanceFromCamera:k.signedDistanceFromCamera}}}getPerspectiveRatio(l,f,v,w){const I=this.transform.projectTileCoordinates(l,f,v,w);return .5+this.transform.cameraToCenterDistance/I.signedDistanceFromCamera*.5}isOffscreen(l,f,v,w){return v<vr||l>=this.screenRightBoundary||w<vr||f>this.screenBottomBoundary}isInsideGrid(l,f,v,w){return v>=0&&l<this.gridRightBoundary&&w>=0&&f<this.gridBottomBoundary}getViewportMatrix(){const l=s.ar([]);return s.O(l,l,[-100,-100,0]),l}_projectCollisionBox(l,f,v,w,I,k,B,W,Z,J,ue){let le=1,_e=0,Ee=0,ze=1;const $e=l.anchorPointX+B[0],Ne=l.anchorPointY+B[1];if(k&&!I){const ti=this.projectAndGetPerspectiveRatio($e+1,Ne,w,Z,ue),Xt=ti.x-W.x,oi=Math.atan((ti.y-W.y)/Xt)+(Xt<0?Math.PI:0),Yi=Math.sin(oi),Dn=Math.cos(oi);le=Dn,_e=Yi,Ee=-Yi,ze=Dn}else if(!k&&I){const ti=Ri(this.transform);le=ti.vecEast[0],_e=ti.vecEast[1],Ee=ti.vecSouth[0],ze=ti.vecSouth[1]}let Ze=W.x,rt=W.y,We=f;I&&(Ze=$e,rt=Ne,We=Math.pow(2,-(this.transform.zoom-v.overscaledZ)),We*=this.transform.getPitchedTextCorrection($e,Ne,w),J||(We*=s.an(.5+W.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),J&&(Ze+=le*J.x*We+Ee*J.y*We,rt+=_e*J.x*We+ze*J.y*We);const it=l.x1*We,lt=l.x2*We,Qe=(it+lt)/2,_t=l.y1*We,Dt=l.y2*We,At=(_t+Dt)/2,Pt=[{offsetX:it,offsetY:_t},{offsetX:Qe,offsetY:_t},{offsetX:lt,offsetY:_t},{offsetX:lt,offsetY:At},{offsetX:lt,offsetY:Dt},{offsetX:Qe,offsetY:Dt},{offsetX:it,offsetY:Dt},{offsetX:it,offsetY:At}];let It=[];for(const{offsetX:ti,offsetY:Xt}of Pt)It.push(new s.P(Ze+le*ti+Ee*Xt,rt+_e*ti+ze*Xt));let Qt=!1;if(I){const ti=It.map((Xt=>this.projectAndGetPerspectiveRatio(Xt.x,Xt.y,w,Z,ue)));Qt=ti.some((Xt=>!Xt.isOccluded)),It=ti.map((Xt=>new s.P(Xt.x,Xt.y)))}else Qt=!0;return{box:s.aL(It),allPointsOccluded:!Qt}}}class Rp{constructor(l,f,v,w){this.opacity=l?Math.max(0,Math.min(1,l.opacity+(l.placed?f:-f))):w&&v?1:0,this.placed=v}isHidden(){return this.opacity===0&&!this.placed}}class Mu{constructor(l,f,v,w,I){this.text=new Rp(l?l.text:null,f,v,I),this.icon=new Rp(l?l.icon:null,f,w,I)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Lp{constructor(l,f,v){this.text=l,this.icon=f,this.skipFade=v}}class kp{constructor(l,f,v,w,I){this.bucketInstanceId=l,this.featureIndex=f,this.sourceLayerIndex=v,this.bucketIndex=w,this.tileID=I}}class Dp{constructor(l){this.crossSourceCollisions=l,this.maxGroupID=0,this.collisionGroups={}}get(l){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[l]){const f=++this.maxGroupID;this.collisionGroups[l]={ID:f,predicate:v=>v.collisionGroupID===f}}return this.collisionGroups[l]}}function Oh(A,l,f,v,w){const{horizontalAlign:I,verticalAlign:k}=s.aS(A);return new s.P(-(I-.5)*l+v[0]*w,-(k-.5)*f+v[1]*w)}class oo{constructor(l,f,v,w,I){this.transform=l.clone(),this.terrain=f,this.collisionIndex=new Ip(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=v,this.retainedQueryData={},this.collisionGroups=new Dp(w),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=I,I&&(I.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(l){const f=this.terrain;return f?(v,w)=>f.getElevation(l,v,w):null}getBucketParts(l,f,v,w){const I=v.getBucket(f),k=v.latestFeatureIndex;if(!I||!k||f.id!==I.layerIds[0])return;const B=v.collisionBoxArray,W=I.layers[0].layout,Z=I.layers[0].paint,J=Math.pow(2,this.transform.zoom-v.tileID.overscaledZ),ue=v.tileSize/s.a5,le=v.tileID.toUnwrapped(),_e=W.get("text-rotation-alignment")==="map",Ee=s.aN(v,1,this.transform.zoom),ze=s.aO(this.collisionIndex.transform,v,Z.get("text-translate"),Z.get("text-translate-anchor")),$e=s.aO(this.collisionIndex.transform,v,Z.get("icon-translate"),Z.get("icon-translate-anchor")),Ne=Wi(_e,this.transform,Ee);this.retainedQueryData[I.bucketInstanceId]=new kp(I.bucketInstanceId,k,I.sourceLayerIndex,I.index,v.tileID);const Ze={bucket:I,layout:W,translationText:ze,translationIcon:$e,unwrappedTileID:le,pitchedLabelPlaneMatrix:Ne,scale:J,textPixelRatio:ue,holdingForFade:v.holdingForSymbolFade(),collisionBoxArray:B,partiallyEvaluatedTextSize:s.ay(I.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(I.sourceID)};if(w)for(const rt of I.sortKeyRanges){const{sortKey:We,symbolInstanceStart:it,symbolInstanceEnd:lt}=rt;l.push({sortKey:We,symbolInstanceStart:it,symbolInstanceEnd:lt,parameters:Ze})}else l.push({symbolInstanceStart:0,symbolInstanceEnd:I.symbolInstances.length,parameters:Ze})}attemptAnchorPlacement(l,f,v,w,I,k,B,W,Z,J,ue,le,_e,Ee,ze,$e,Ne,Ze,rt,We){const it=s.aP[l.textAnchor],lt=[l.textOffset0,l.textOffset1],Qe=Oh(it,v,w,lt,I),_t=this.collisionIndex.placeCollisionBox(f,le,W,Z,J,B,k,$e,ue.predicate,rt,Qe,We);if((!Ze||this.collisionIndex.placeCollisionBox(Ze,le,W,Z,J,B,k,Ne,ue.predicate,rt,Qe,We).placeable)&&_t.placeable){let Dt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[_e.crossTileID]&&this.prevPlacement.placements[_e.crossTileID]&&this.prevPlacement.placements[_e.crossTileID].text&&(Dt=this.prevPlacement.variableOffsets[_e.crossTileID].anchor),_e.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[_e.crossTileID]={textOffset:lt,width:v,height:w,anchor:it,textBoxScale:I,prevAnchor:Dt},this.markUsedJustification(Ee,it,_e,ze),Ee.allowVerticalPlacement&&(this.markUsedOrientation(Ee,ze,_e),this.placedOrientations[_e.crossTileID]=ze),{shift:Qe,placedGlyphBoxes:_t}}}placeLayerBucketPart(l,f,v){const{bucket:w,layout:I,translationText:k,translationIcon:B,unwrappedTileID:W,pitchedLabelPlaneMatrix:Z,textPixelRatio:J,holdingForFade:ue,collisionBoxArray:le,partiallyEvaluatedTextSize:_e,collisionGroup:Ee}=l.parameters,ze=I.get("text-optional"),$e=I.get("icon-optional"),Ne=s.aQ(I,"text-overlap","text-allow-overlap"),Ze=Ne==="always",rt=s.aQ(I,"icon-overlap","icon-allow-overlap"),We=rt==="always",it=I.get("text-rotation-alignment")==="map",lt=I.get("text-pitch-alignment")==="map",Qe=I.get("icon-text-fit")!=="none",_t=I.get("symbol-z-order")==="viewport-y",Dt=Ze&&(We||!w.hasIconData()||$e),At=We&&(Ze||!w.hasTextData()||ze);!w.collisionArrays&&le&&w.deserializeCollisionBoxes(le);const Pt=this.retainedQueryData[w.bucketInstanceId].tileID,It=this._getTerrainElevationFunc(Pt),Qt=this.transform.getFastPathSimpleProjectionMatrix(Pt),ti=(Xt,oi,Yi)=>{var Dn,mr;if(f[Xt.crossTileID])return;if(ue)return void(this.placements[Xt.crossTileID]=new Lp(!1,!1,!1));let Qn=!1,xr=!1,er=!0,Br=null,wr={box:null,placeable:!1,offscreen:null,occluded:!1},Es={placeable:!1},rs=null,Xr=null,Us=null,Zc=0,lc=0,Sl=0;oi.textFeatureIndex?Zc=oi.textFeatureIndex:Xt.useRuntimeCollisionCircles&&(Zc=Xt.featureIndex),oi.verticalTextFeatureIndex&&(lc=oi.verticalTextFeatureIndex);const Co=oi.textBox;if(Co){const pa=or=>{let tr=s.az.horizontal;if(w.allowVerticalPlacement&&!or&&this.prevPlacement){const gs=this.prevPlacement.placedOrientations[Xt.crossTileID];gs&&(this.placedOrientations[Xt.crossTileID]=gs,tr=gs,this.markUsedOrientation(w,tr,Xt))}return tr},Tl=(or,tr)=>{if(w.allowVerticalPlacement&&Xt.numVerticalGlyphVertices>0&&oi.verticalTextBox){for(const gs of w.writingModes)if(gs===s.az.vertical?(wr=tr(),Es=wr):wr=or(),wr&&wr.placeable)break}else wr=or()},Va=Xt.textAnchorOffsetStartIndex,Ua=Xt.textAnchorOffsetEndIndex;if(Ua===Va){const or=(tr,gs)=>{const _s=this.collisionIndex.placeCollisionBox(tr,Ne,J,Pt,W,lt,it,k,Ee.predicate,It,void 0,Qt);return _s&&_s.placeable&&(this.markUsedOrientation(w,gs,Xt),this.placedOrientations[Xt.crossTileID]=gs),_s};Tl((()=>or(Co,s.az.horizontal)),(()=>{const tr=oi.verticalTextBox;return w.allowVerticalPlacement&&Xt.numVerticalGlyphVertices>0&&tr?or(tr,s.az.vertical):{box:null,offscreen:null}})),pa(wr&&wr.placeable)}else{let or=s.aP[(mr=(Dn=this.prevPlacement)===null||Dn===void 0?void 0:Dn.variableOffsets[Xt.crossTileID])===null||mr===void 0?void 0:mr.anchor];const tr=(_s,Y0,K0)=>{const Xu=_s.x2-_s.x1,$1=_s.y2-_s.y1,J0=Xt.textBoxScale,Y_=Qe&&rt==="never"?Y0:null;let Xc=null,Yc=Ne==="never"?1:2,Kc="never";or&&Yc++;for(let K_=0;K_<Yc;K_++){for(let J_=Va;J_<Ua;J_++){const vm=w.textAnchorOffsets.get(J_);if(or&&vm.textAnchor!==or)continue;const ym=this.attemptAnchorPlacement(vm,_s,Xu,$1,J0,it,lt,J,Pt,W,Ee,Kc,Xt,w,K0,k,B,Y_,It);if(ym&&(Xc=ym.placedGlyphBoxes,Xc&&Xc.placeable))return Qn=!0,Br=ym.shift,Xc}or?or=null:Kc=Ne}return v&&!Xc&&(Xc={box:this.collisionIndex.placeCollisionBox(Co,"always",J,Pt,W,lt,it,k,Ee.predicate,It,void 0,Qt).box,offscreen:!1,placeable:!1,occluded:!1}),Xc};Tl((()=>tr(Co,oi.iconBox,s.az.horizontal)),(()=>{const _s=oi.verticalTextBox;return w.allowVerticalPlacement&&(!wr||!wr.placeable)&&Xt.numVerticalGlyphVertices>0&&_s?tr(_s,oi.verticalIconBox,s.az.vertical):{box:null,occluded:!0,offscreen:null}})),wr&&(Qn=wr.placeable,er=wr.offscreen);const gs=pa(wr&&wr.placeable);if(!Qn&&this.prevPlacement){const _s=this.prevPlacement.variableOffsets[Xt.crossTileID];_s&&(this.variableOffsets[Xt.crossTileID]=_s,this.markUsedJustification(w,_s.anchor,Xt,gs))}}}if(rs=wr,Qn=rs&&rs.placeable,er=rs&&rs.offscreen,Xt.useRuntimeCollisionCircles&&Xt.centerJustifiedTextSymbolIndex>=0){const pa=w.text.placedSymbolArray.get(Xt.centerJustifiedTextSymbolIndex),Tl=s.aA(w.textSizeData,_e,pa),Va=I.get("text-padding");Xr=this.collisionIndex.placeCollisionCircles(Ne,pa,w.lineVertexArray,w.glyphOffsetArray,Tl,W,Z,v,lt,Ee.predicate,Xt.collisionCircleDiameter,Va,k,It),Xr.circles.length&&Xr.collisionDetected&&!v&&s.w("Collisions detected, but collision boxes are not shown"),Qn=Ze||Xr.circles.length>0&&!Xr.collisionDetected,er=er&&Xr.offscreen}if(oi.iconFeatureIndex&&(Sl=oi.iconFeatureIndex),oi.iconBox){const pa=Tl=>this.collisionIndex.placeCollisionBox(Tl,rt,J,Pt,W,lt,it,B,Ee.predicate,It,Qe&&Br?Br:void 0,Qt);Es&&Es.placeable&&oi.verticalIconBox?(Us=pa(oi.verticalIconBox),xr=Us.placeable):(Us=pa(oi.iconBox),xr=Us.placeable),er=er&&Us.offscreen}const Hu=ze||Xt.numHorizontalGlyphVertices===0&&Xt.numVerticalGlyphVertices===0,kf=$e||Xt.numIconVertices===0;Hu||kf?kf?Hu||(xr=xr&&Qn):Qn=xr&&Qn:xr=Qn=xr&&Qn;const Zu=xr&&Us.placeable;if(Qn&&rs.placeable&&this.collisionIndex.insertCollisionBox(rs.box,Ne,I.get("text-ignore-placement"),w.bucketInstanceId,Es&&Es.placeable&&lc?lc:Zc,Ee.ID),Zu&&this.collisionIndex.insertCollisionBox(Us.box,rt,I.get("icon-ignore-placement"),w.bucketInstanceId,Sl,Ee.ID),Xr&&Qn&&this.collisionIndex.insertCollisionCircles(Xr.circles,Ne,I.get("text-ignore-placement"),w.bucketInstanceId,Zc,Ee.ID),v&&this.storeCollisionData(w.bucketInstanceId,Yi,oi,rs,Us,Xr),Xt.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(w.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[Xt.crossTileID]=new Lp((Qn||Dt)&&!rs?.occluded,(xr||At)&&!Us?.occluded,er||w.justReloaded),f[Xt.crossTileID]=!0};if(_t){if(l.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const Xt=w.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let oi=Xt.length-1;oi>=0;--oi){const Yi=Xt[oi];ti(w.symbolInstances.get(Yi),w.collisionArrays[Yi],Yi)}}else for(let Xt=l.symbolInstanceStart;Xt<l.symbolInstanceEnd;Xt++)ti(w.symbolInstances.get(Xt),w.collisionArrays[Xt],Xt);w.justReloaded=!1}storeCollisionData(l,f,v,w,I,k){if(v.textBox||v.iconBox){let B,W;this.collisionBoxArrays.has(l)?B=this.collisionBoxArrays.get(l):(B=new Map,this.collisionBoxArrays.set(l,B)),B.has(f)?W=B.get(f):(W={text:null,icon:null},B.set(f,W)),v.textBox&&(W.text=w.box),v.iconBox&&(W.icon=I.box)}if(k){let B=this.collisionCircleArrays[l];B===void 0&&(B=this.collisionCircleArrays[l]=[]);for(let W=0;W<k.circles.length;W+=4)B.push(k.circles[W+0]-vr),B.push(k.circles[W+1]-vr),B.push(k.circles[W+2]),B.push(k.collisionDetected?1:0)}}markUsedJustification(l,f,v,w){let I;I=w===s.az.vertical?v.verticalPlacedTextSymbolIndex:{left:v.leftJustifiedTextSymbolIndex,center:v.centerJustifiedTextSymbolIndex,right:v.rightJustifiedTextSymbolIndex}[s.aR(f)];const k=[v.leftJustifiedTextSymbolIndex,v.centerJustifiedTextSymbolIndex,v.rightJustifiedTextSymbolIndex,v.verticalPlacedTextSymbolIndex];for(const B of k)B>=0&&(l.text.placedSymbolArray.get(B).crossTileID=I>=0&&B!==I?0:v.crossTileID)}markUsedOrientation(l,f,v){const w=f===s.az.horizontal||f===s.az.horizontalOnly?f:0,I=f===s.az.vertical?f:0,k=[v.leftJustifiedTextSymbolIndex,v.centerJustifiedTextSymbolIndex,v.rightJustifiedTextSymbolIndex];for(const B of k)l.text.placedSymbolArray.get(B).placedOrientation=w;v.verticalPlacedTextSymbolIndex&&(l.text.placedSymbolArray.get(v.verticalPlacedTextSymbolIndex).placedOrientation=I)}commit(l){this.commitTime=l,this.zoomAtLastRecencyCheck=this.transform.zoom;const f=this.prevPlacement;let v=!1;this.prevZoomAdjustment=f?f.zoomAdjustment(this.transform.zoom):0;const w=f?f.symbolFadeChange(l):1,I=f?f.opacities:{},k=f?f.variableOffsets:{},B=f?f.placedOrientations:{};for(const W in this.placements){const Z=this.placements[W],J=I[W];J?(this.opacities[W]=new Mu(J,w,Z.text,Z.icon),v=v||Z.text!==J.text.placed||Z.icon!==J.icon.placed):(this.opacities[W]=new Mu(null,w,Z.text,Z.icon,Z.skipFade),v=v||Z.text||Z.icon)}for(const W in I){const Z=I[W];if(!this.opacities[W]){const J=new Mu(Z,w,!1,!1);J.isHidden()||(this.opacities[W]=J,v=v||Z.text.placed||Z.icon.placed)}}for(const W in k)this.variableOffsets[W]||!this.opacities[W]||this.opacities[W].isHidden()||(this.variableOffsets[W]=k[W]);for(const W in B)this.placedOrientations[W]||!this.opacities[W]||this.opacities[W].isHidden()||(this.placedOrientations[W]=B[W]);if(f&&f.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");v?this.lastPlacementChangeTime=l:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=f?f.lastPlacementChangeTime:l)}updateLayerOpacities(l,f){const v={};for(const w of f){const I=w.getBucket(l);I&&w.latestFeatureIndex&&l.id===I.layerIds[0]&&this.updateBucketOpacities(I,w.tileID,v,w.collisionBoxArray)}}updateBucketOpacities(l,f,v,w){l.hasTextData()&&(l.text.opacityVertexArray.clear(),l.text.hasVisibleVertices=!1),l.hasIconData()&&(l.icon.opacityVertexArray.clear(),l.icon.hasVisibleVertices=!1),l.hasIconCollisionBoxData()&&l.iconCollisionBox.collisionVertexArray.clear(),l.hasTextCollisionBoxData()&&l.textCollisionBox.collisionVertexArray.clear();const I=l.layers[0],k=I.layout,B=new Mu(null,0,!1,!1,!0),W=k.get("text-allow-overlap"),Z=k.get("icon-allow-overlap"),J=I._unevaluatedLayout.hasValue("text-variable-anchor")||I._unevaluatedLayout.hasValue("text-variable-anchor-offset"),ue=k.get("text-rotation-alignment")==="map",le=k.get("text-pitch-alignment")==="map",_e=k.get("icon-text-fit")!=="none",Ee=new Mu(null,0,W&&(Z||!l.hasIconData()||k.get("icon-optional")),Z&&(W||!l.hasTextData()||k.get("text-optional")),!0);!l.collisionArrays&&w&&(l.hasIconCollisionBoxData()||l.hasTextCollisionBoxData())&&l.deserializeCollisionBoxes(w);const ze=(Ne,Ze,rt)=>{for(let We=0;We<Ze/4;We++)Ne.opacityVertexArray.emplaceBack(rt);Ne.hasVisibleVertices=Ne.hasVisibleVertices||rt!==kc},$e=this.collisionBoxArrays.get(l.bucketInstanceId);for(let Ne=0;Ne<l.symbolInstances.length;Ne++){const Ze=l.symbolInstances.get(Ne),{numHorizontalGlyphVertices:rt,numVerticalGlyphVertices:We,crossTileID:it}=Ze;let lt=this.opacities[it];v[it]?lt=B:lt||(lt=Ee,this.opacities[it]=lt),v[it]=!0;const Qe=Ze.numIconVertices>0,_t=this.placedOrientations[Ze.crossTileID],Dt=_t===s.az.vertical,At=_t===s.az.horizontal||_t===s.az.horizontalOnly;if(rt>0||We>0){const It=ef(lt.text);ze(l.text,rt,Dt?kc:It),ze(l.text,We,At?kc:It);const Qt=lt.text.isHidden();[Ze.rightJustifiedTextSymbolIndex,Ze.centerJustifiedTextSymbolIndex,Ze.leftJustifiedTextSymbolIndex].forEach((oi=>{oi>=0&&(l.text.placedSymbolArray.get(oi).hidden=Qt||Dt?1:0)})),Ze.verticalPlacedTextSymbolIndex>=0&&(l.text.placedSymbolArray.get(Ze.verticalPlacedTextSymbolIndex).hidden=Qt||At?1:0);const ti=this.variableOffsets[Ze.crossTileID];ti&&this.markUsedJustification(l,ti.anchor,Ze,_t);const Xt=this.placedOrientations[Ze.crossTileID];Xt&&(this.markUsedJustification(l,"left",Ze,Xt),this.markUsedOrientation(l,Xt,Ze))}if(Qe){const It=ef(lt.icon),Qt=!(_e&&Ze.verticalPlacedIconSymbolIndex&&Dt);Ze.placedIconSymbolIndex>=0&&(ze(l.icon,Ze.numIconVertices,Qt?It:kc),l.icon.placedSymbolArray.get(Ze.placedIconSymbolIndex).hidden=lt.icon.isHidden()),Ze.verticalPlacedIconSymbolIndex>=0&&(ze(l.icon,Ze.numVerticalIconVertices,Qt?kc:It),l.icon.placedSymbolArray.get(Ze.verticalPlacedIconSymbolIndex).hidden=lt.icon.isHidden())}const Pt=$e&&$e.has(Ne)?$e.get(Ne):{text:null,icon:null};if(l.hasIconCollisionBoxData()||l.hasTextCollisionBoxData()){const It=l.collisionArrays[Ne];if(It){let Qt=new s.P(0,0);if(It.textBox||It.verticalTextBox){let ti=!0;if(J){const Xt=this.variableOffsets[it];Xt?(Qt=Oh(Xt.anchor,Xt.width,Xt.height,Xt.textOffset,Xt.textBoxScale),ue&&Qt._rotate(le?-this.transform.bearingInRadians:this.transform.bearingInRadians)):ti=!1}if(It.textBox||It.verticalTextBox){let Xt;It.textBox&&(Xt=Dt),It.verticalTextBox&&(Xt=At),zh(l.textCollisionBox.collisionVertexArray,lt.text.placed,!ti||Xt,Pt.text,Qt.x,Qt.y)}}if(It.iconBox||It.verticalIconBox){const ti=!!(!At&&It.verticalIconBox);let Xt;It.iconBox&&(Xt=ti),It.verticalIconBox&&(Xt=!ti),zh(l.iconCollisionBox.collisionVertexArray,lt.icon.placed,Xt,Pt.icon,_e?Qt.x:0,_e?Qt.y:0)}}}}if(l.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[l.bucketInstanceId]&&(this.retainedQueryData[l.bucketInstanceId].featureSortOrder=l.featureSortOrder),l.hasTextData()&&l.text.opacityVertexBuffer&&l.text.opacityVertexBuffer.updateData(l.text.opacityVertexArray),l.hasIconData()&&l.icon.opacityVertexBuffer&&l.icon.opacityVertexBuffer.updateData(l.icon.opacityVertexArray),l.hasIconCollisionBoxData()&&l.iconCollisionBox.collisionVertexBuffer&&l.iconCollisionBox.collisionVertexBuffer.updateData(l.iconCollisionBox.collisionVertexArray),l.hasTextCollisionBoxData()&&l.textCollisionBox.collisionVertexBuffer&&l.textCollisionBox.collisionVertexBuffer.updateData(l.textCollisionBox.collisionVertexArray),l.text.opacityVertexArray.length!==l.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${l.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${l.text.layoutVertexArray.length}) / 4`);if(l.icon.opacityVertexArray.length!==l.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${l.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${l.icon.layoutVertexArray.length}) / 4`);l.bucketInstanceId in this.collisionCircleArrays&&(l.collisionCircleArray=this.collisionCircleArrays[l.bucketInstanceId],delete this.collisionCircleArrays[l.bucketInstanceId])}symbolFadeChange(l){return this.fadeDuration===0?1:(l-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(l){return Math.max(0,(this.transform.zoom-l)/1.5)}hasTransitions(l){return this.stale||l-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(l,f){const v=this.zoomAtLastRecencyCheck===f?1-this.zoomAdjustment(f):1;return this.zoomAtLastRecencyCheck=f,this.commitTime+this.fadeDuration*v>l}setStale(){this.stale=!0}}function zh(A,l,f,v,w,I){v&&v.length!==0||(v=[0,0,0,0]);const k=v[0]-vr,B=v[1]-vr,W=v[2]-vr,Z=v[3]-vr;A.emplaceBack(l?1:0,f?1:0,w||0,I||0,k,B),A.emplaceBack(l?1:0,f?1:0,w||0,I||0,W,B),A.emplaceBack(l?1:0,f?1:0,w||0,I||0,W,Z),A.emplaceBack(l?1:0,f?1:0,w||0,I||0,k,Z)}const Bh=Math.pow(2,25),Nh=Math.pow(2,24),y_=Math.pow(2,17),Cu=Math.pow(2,16),Eu=Math.pow(2,9),Au=Math.pow(2,8),Lc=Math.pow(2,1);function ef(A){if(A.opacity===0&&!A.placed)return 0;if(A.opacity===1&&A.placed)return 4294967295;const l=A.placed?1:0,f=Math.floor(127*A.opacity);return f*Bh+l*Nh+f*y_+l*Cu+f*Eu+l*Au+f*Lc+l}const kc=0;class ml{constructor(l){this._sortAcrossTiles=l.layout.get("symbol-z-order")!=="viewport-y"&&!l.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(l,f,v,w,I){const k=this._bucketParts;for(;this._currentTileIndex<l.length;)if(f.getBucketParts(k,w,l[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,I())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,k.sort(((B,W)=>B.sortKey-W.sortKey)));this._currentPartIndex<k.length;)if(f.placeLayerBucketPart(k[this._currentPartIndex],this._seenCrossTileIDs,v),this._currentPartIndex++,I())return!0;return!1}}class Dc{constructor(l,f,v,w,I,k,B,W){this.placement=new oo(l,f,k,B,W),this._currentPlacementIndex=v.length-1,this._forceFullPlacement=w,this._showCollisionBoxes=I,this._done=!1}isDone(){return this._done}continuePlacement(l,f,v){const w=P(),I=()=>!this._forceFullPlacement&&P()-w>2;for(;this._currentPlacementIndex>=0;){const k=f[l[this._currentPlacementIndex]],B=this.placement.collisionIndex.transform.zoom;if(k.type==="symbol"&&(!k.minzoom||k.minzoom<=B)&&(!k.maxzoom||k.maxzoom>B)){if(this._inProgressLayer||(this._inProgressLayer=new ml(k)),this._inProgressLayer.continuePlacement(v[k.source],this.placement,this._showCollisionBoxes,k,I))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(l){return this.placement.commit(l),this.placement}}const sn=512/s.a5/2;class $h{constructor(l,f,v){this.tileID=l,this.bucketInstanceId=v,this._symbolsByKey={};const w=new Map;for(let I=0;I<f.length;I++){const k=f.get(I),B=k.key,W=w.get(B);W?W.push(k):w.set(B,[k])}for(const[I,k]of w){const B={positions:k.map((W=>({x:Math.floor(W.anchorX*sn),y:Math.floor(W.anchorY*sn)}))),crossTileIDs:k.map((W=>W.crossTileID))};if(B.positions.length>128){const W=new s.aT(B.positions.length,16,Uint16Array);for(const{x:Z,y:J}of B.positions)W.add(Z,J);W.finish(),delete B.positions,B.index=W}this._symbolsByKey[I]=B}}getScaledCoordinates(l,f){const{x:v,y:w,z:I}=this.tileID.canonical,{x:k,y:B,z:W}=f.canonical,Z=sn/Math.pow(2,W-I),J=(B*s.a5+l.anchorY)*Z,ue=w*s.a5*sn;return{x:Math.floor((k*s.a5+l.anchorX)*Z-v*s.a5*sn),y:Math.floor(J-ue)}}findMatches(l,f,v){const w=this.tileID.canonical.z<f.canonical.z?1:Math.pow(2,this.tileID.canonical.z-f.canonical.z);for(let I=0;I<l.length;I++){const k=l.get(I);if(k.crossTileID)continue;const B=this._symbolsByKey[k.key];if(!B)continue;const W=this.getScaledCoordinates(k,f);if(B.index){const Z=B.index.range(W.x-w,W.y-w,W.x+w,W.y+w).sort();for(const J of Z){const ue=B.crossTileIDs[J];if(!v[ue]){v[ue]=!0,k.crossTileID=ue;break}}}else if(B.positions)for(let Z=0;Z<B.positions.length;Z++){const J=B.positions[Z],ue=B.crossTileIDs[Z];if(Math.abs(J.x-W.x)<=w&&Math.abs(J.y-W.y)<=w&&!v[ue]){v[ue]=!0,k.crossTileID=ue;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map((({crossTileIDs:l})=>l))}}class Fp{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Fc{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(l){const f=Math.round((l-this.lng)/360);if(f!==0)for(const v in this.indexes){const w=this.indexes[v],I={};for(const k in w){const B=w[k];B.tileID=B.tileID.unwrapTo(B.tileID.wrap+f),I[B.tileID.key]=B}this.indexes[v]=I}this.lng=l}addBucket(l,f,v){if(this.indexes[l.overscaledZ]&&this.indexes[l.overscaledZ][l.key]){if(this.indexes[l.overscaledZ][l.key].bucketInstanceId===f.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(l.overscaledZ,this.indexes[l.overscaledZ][l.key])}for(let I=0;I<f.symbolInstances.length;I++)f.symbolInstances.get(I).crossTileID=0;this.usedCrossTileIDs[l.overscaledZ]||(this.usedCrossTileIDs[l.overscaledZ]={});const w=this.usedCrossTileIDs[l.overscaledZ];for(const I in this.indexes){const k=this.indexes[I];if(Number(I)>l.overscaledZ)for(const B in k){const W=k[B];W.tileID.isChildOf(l)&&W.findMatches(f.symbolInstances,l,w)}else{const B=k[l.scaledTo(Number(I)).key];B&&B.findMatches(f.symbolInstances,l,w)}}for(let I=0;I<f.symbolInstances.length;I++){const k=f.symbolInstances.get(I);k.crossTileID||(k.crossTileID=v.generate(),w[k.crossTileID]=!0)}return this.indexes[l.overscaledZ]===void 0&&(this.indexes[l.overscaledZ]={}),this.indexes[l.overscaledZ][l.key]=new $h(l,f.symbolInstances,f.bucketInstanceId),!0}removeBucketCrossTileIDs(l,f){for(const v of f.getCrossTileIDsLists())for(const w of v)delete this.usedCrossTileIDs[l][w]}removeStaleBuckets(l){let f=!1;for(const v in this.indexes){const w=this.indexes[v];for(const I in w)l[w[I].bucketInstanceId]||(this.removeBucketCrossTileIDs(v,w[I]),delete w[I],f=!0)}return f}}class Ns{constructor(){this.layerIndexes={},this.crossTileIDs=new Fp,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(l,f,v){let w=this.layerIndexes[l.id];w===void 0&&(w=this.layerIndexes[l.id]=new Fc);let I=!1;const k={};w.handleWrapJump(v);for(const B of f){const W=B.getBucket(l);W&&l.id===W.layerIds[0]&&(W.bucketInstanceId||(W.bucketInstanceId=++this.maxBucketInstanceId),w.addBucket(B.tileID,W,this.crossTileIDs)&&(I=!0),k[W.bucketInstanceId]=!0)}return w.removeStaleBuckets(k)&&(I=!0),I}pruneUnusedLayers(l){const f={};l.forEach((v=>{f[v]=!0}));for(const v in this.layerIndexes)f[v]||delete this.layerIndexes[v]}}var fs="void main() {fragColor=vec4(1.0);}";const xn={prelude:qi(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:qi("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:qi("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:qi(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:qi(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:qi(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:qi(fs,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:qi(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:qi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:qi("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:qi("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),colorRelief:qi(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;uniform vec4 u_unpack;uniform sampler2D u_elevation_stops;uniform sampler2D u_color_stops;uniform int u_color_ramp_size;uniform float u_opacity;in vec2 v_pos;float getElevation(vec2 coord) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}float getElevationStop(int stop) {float x=(float(stop)+0.5)/float(u_color_ramp_size);vec4 data=texture(u_elevation_stops,vec2(x,0))*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {float el=getElevation(v_pos);int r=(u_color_ramp_size-1);int l=0;float el_l=getElevationStop(l);float el_r=getElevationStop(r);while(r-l > 1){int m=(r+l)/2;float el_m=getElevationStop(m);if(el < el_m){r=m;el_r=el_m;}else
{l=m;el_l=el_m;}}float x=(float(l)+(el-el_l)/(el_r-el_l)+0.5)/float(u_color_ramp_size);fragColor=u_opacity*texture(u_color_stops,vec2(x,0));
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_dimension;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_pos/8192.0)*scale+epsilon;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),debug:qi("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:qi(fs,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:qi(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:qi(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:qi(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:qi(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:qi(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:qi(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:qi(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {vec2 epsilon=1.0/u_dimension;float tileSize=u_dimension.x-2.0;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))*tileSize/pow(2.0,exaggeration+(28.2562-u_zoom));fragColor=clamp(vec4(deriv.x/8.0+0.5,deriv.y/8.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:qi(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform float u_exaggeration;uniform vec4 u_accent;uniform int u_method;uniform float u_altitudes[NUM_ILLUMINATION_SOURCES];uniform float u_azimuths[NUM_ILLUMINATION_SOURCES];uniform vec4 u_shadows[NUM_ILLUMINATION_SOURCES];uniform vec4 u_highlights[NUM_ILLUMINATION_SOURCES];
#define PI 3.141592653589793
#define STANDARD 0
#define COMBINED 1
#define IGOR 2
#define MULTIDIRECTIONAL 3
#define BASIC 4
float get_aspect(vec2 deriv){return deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);}void igor_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float aspect=get_aspect(deriv);float azimuth=u_azimuths[0]+PI;float slope_stength=atan(length(deriv))*2.0/PI;float aspect_strength=1.0-abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);float shadow_strength=slope_stength*aspect_strength;float highlight_strength=slope_stength*(1.0-aspect_strength);fragColor=u_shadows[0]*shadow_strength+u_highlights[0]*highlight_strength;}void standard_hillshade(vec2 deriv){float azimuth=u_azimuths[0]+PI;float slope=atan(0.625*length(deriv));float aspect=get_aspect(deriv);float intensity=u_exaggeration;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadows[0],u_highlights[0],shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;}void basic_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor=u_highlights[0]*(2.0*shade-1.0);}else
{fragColor=u_shadows[0]*(1.0-2.0*shade);}}void multidirectional_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;fragColor=vec4(0,0,0,0);for(int i=0; i < NUM_ILLUMINATION_SOURCES; i++){float cos_alt=cos(u_altitudes[i]);float sin_alt=sin(u_altitudes[i]);float cos_az=-cos(u_azimuths[i]);float sin_az=-sin(u_azimuths[i]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor+=u_highlights[i]*(2.0*shade-1.0)/float(NUM_ILLUMINATION_SOURCES);}else
{fragColor+=u_shadows[i]*(1.0-2.0*shade)/float(NUM_ILLUMINATION_SOURCES);}}}void combined_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=acos((sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv)));cang=clamp(cang,0.0,PI/2.0);float shade=cang*atan(length(deriv))*4.0/PI/PI;float highlight=(PI/2.0-cang)*atan(length(deriv))*4.0/PI/PI;fragColor=u_shadows[0]*shade+u_highlights[0]*highlight;}void main() {vec4 pixel=texture(u_image,v_pos);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));vec2 deriv=((pixel.rg*8.0)-4.0)/scaleFactor;if (u_method==BASIC) {basic_hillshade(deriv);} else if (u_method==COMBINED) {combined_hillshade(deriv);} else if (u_method==IGOR) {igor_hillshade(deriv);} else if (u_method==MULTIDIRECTIONAL) {multidirectional_hillshade(deriv);} else if (u_method==STANDARD) {standard_hillshade(deriv);} else {standard_hillshade(deriv);}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:qi(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:qi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:qi(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:qi(`uniform lowp float u_device_pixel_ratio;uniform lowp float u_lineatlas_width;uniform sampler2D u_image;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfgamma=(u_lineatlas_width/256.0/u_device_pixel_ratio)/min(dasharray_from.w,dasharray_to.w);alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_tileratio;uniform float u_crossfade_from;uniform float u_crossfade_to;uniform float u_lineatlas_height;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
float u_patternscale_a_x=u_tileratio/dasharray_from.w/u_crossfade_from;float u_patternscale_a_y=-dasharray_from.z/2.0/u_lineatlas_height;float u_patternscale_b_x=u_tileratio/dasharray_to.w/u_crossfade_to;float u_patternscale_b_y=-dasharray_to.z/2.0/u_lineatlas_height;v_tex_a=vec2(a_linesofar*u_patternscale_a_x/floorwidth,normal.y*u_patternscale_a_y+(float(dasharray_from.y)+0.5)/u_lineatlas_height);v_tex_b=vec2(a_linesofar*u_patternscale_b_x/floorwidth,normal.y*u_patternscale_b_y+(float(dasharray_to.y)+0.5)/u_lineatlas_height);v_width2=vec2(outset,inset);}`),lineGradientSDF:qi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform sampler2D u_image_dash;uniform float u_mix;uniform lowp float u_lineatlas_width;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);float sdfdist_a=texture(u_image_dash,v_tex_a).a;float sdfdist_b=texture(u_image_dash,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfgamma=(u_lineatlas_width/256.0)/min(dasharray_from.w,dasharray_to.w);float dash_alpha=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*dash_alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;uniform float u_tileratio;uniform float u_crossfade_from;uniform float u_crossfade_to;uniform float u_lineatlas_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;out vec2 v_tex_a;out vec2 v_tex_b;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;float texel_height=1.0/u_image_height;float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
float u_patternscale_a_x=u_tileratio/dasharray_from.w/u_crossfade_from;float u_patternscale_a_y=-dasharray_from.z/2.0/u_lineatlas_height;float u_patternscale_b_x=u_tileratio/dasharray_to.w/u_crossfade_to;float u_patternscale_b_y=-dasharray_to.z/2.0/u_lineatlas_height;v_tex_a=vec2(a_linesofar*u_patternscale_a_x/floorwidth,normal.y*u_patternscale_a_y+(float(dasharray_from.y)+0.5)/u_lineatlas_height);v_tex_b=vec2(a_linesofar*u_patternscale_b_x/floorwidth,normal.y*u_patternscale_b_y+(float(dasharray_to.y)+0.5)/u_lineatlas_height);v_width2=vec2(outset,inset);}`),raster:qi(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:qi(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:qi(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:qi(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:qi("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:qi("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:qi("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:qi("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:qi(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:qi("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function qi(A,l){const f=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,v=l.match(/in ([\w]+) ([\w]+)/g),w=A.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),I=l.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),k=I?I.concat(w):w,B={};return{fragmentSource:A=A.replace(f,((W,Z,J,ue,le)=>(B[le]=!0,Z==="define"?`
#ifndef HAS_UNIFORM_u_${le}
in ${J} ${ue} ${le};
#else
uniform ${J} ${ue} u_${le};
#endif
`:`
#ifdef HAS_UNIFORM_u_${le}
    ${J} ${ue} ${le} = u_${le};
#endif
`))),vertexSource:l=l.replace(f,((W,Z,J,ue,le)=>{const _e=ue==="float"?"vec2":"vec4",Ee=le.match(/color/)?"color":_e;return B[le]?Z==="define"?`
#ifndef HAS_UNIFORM_u_${le}
uniform lowp float u_${le}_t;
in ${J} ${_e} a_${le};
out ${J} ${ue} ${le};
#else
uniform ${J} ${ue} u_${le};
#endif
`:Ee==="vec4"?`
#ifndef HAS_UNIFORM_u_${le}
    ${le} = a_${le};
#else
    ${J} ${ue} ${le} = u_${le};
#endif
`:`
#ifndef HAS_UNIFORM_u_${le}
    ${le} = unpack_mix_${Ee}(a_${le}, u_${le}_t);
#else
    ${J} ${ue} ${le} = u_${le};
#endif
`:Z==="define"?`
#ifndef HAS_UNIFORM_u_${le}
uniform lowp float u_${le}_t;
in ${J} ${_e} a_${le};
#else
uniform ${J} ${ue} u_${le};
#endif
`:Ee==="vec4"?`
#ifndef HAS_UNIFORM_u_${le}
    ${J} ${ue} ${le} = a_${le};
#else
    ${J} ${ue} ${le} = u_${le};
#endif
`:`
#ifndef HAS_UNIFORM_u_${le}
    ${J} ${ue} ${le} = unpack_mix_${Ee}(a_${le}, u_${le}_t);
#else
    ${J} ${ue} ${le} = u_${le};
#endif
`})),staticAttributes:v,staticUniforms:k}}class Bn{constructor(l,f,v){this.vertexBuffer=l,this.indexBuffer=f,this.segments=v}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var Ma=s.aU([{name:"a_pos",type:"Int16",components:2}]);const Ss="#define PROJECTION_MERCATOR",ao="mercator";class $s{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return ao}get shaderDefine(){return Ss}get shaderPreludeCode(){return xn.projectionMercator}get vertexShaderPreludeCode(){return xn.projectionMercator.vertexSource}get subdivisionGranularity(){return s.aV.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(l){}getMeshFromTileID(l,f,v,w,I){if(this._cachedMesh)return this._cachedMesh;const k=new s.aW;k.emplaceBack(0,0),k.emplaceBack(s.a5,0),k.emplaceBack(0,s.a5),k.emplaceBack(s.a5,s.a5);const B=l.createVertexBuffer(k,Ma.members),W=s.aX.simpleSegment(0,0,4,2),Z=new s.aY;Z.emplaceBack(1,0,2),Z.emplaceBack(1,2,3);const J=l.createIndexBuffer(Z);return this._cachedMesh=new Bn(B,J,W),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(l){}}class Oc{constructor(l=0,f=0,v=0,w=0){if(isNaN(l)||l<0||isNaN(f)||f<0||isNaN(v)||v<0||isNaN(w)||w<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=l,this.bottom=f,this.left=v,this.right=w}interpolate(l,f,v){return f.top!=null&&l.top!=null&&(this.top=s.G.number(l.top,f.top,v)),f.bottom!=null&&l.bottom!=null&&(this.bottom=s.G.number(l.bottom,f.bottom,v)),f.left!=null&&l.left!=null&&(this.left=s.G.number(l.left,f.left,v)),f.right!=null&&l.right!=null&&(this.right=s.G.number(l.right,f.right,v)),this}getCenter(l,f){const v=s.an((this.left+l-this.right)/2,0,l),w=s.an((this.top+f-this.bottom)/2,0,f);return new s.P(v,w)}equals(l){return this.top===l.top&&this.bottom===l.bottom&&this.left===l.left&&this.right===l.right}clone(){return new Oc(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function gl(A,l){if(!A.renderWorldCopies||A.lngRange)return;const f=l.lng-A.center.lng;l.lng+=f>180?-360:f<-180?360:0}function Pr(A){return Math.max(0,Math.floor(A))}class Xl{constructor(l,f){var v;this.applyConstrain=(w,I)=>this._constrainOverride!==null?this._constrainOverride(w,I):this._callbacks.defaultConstrain(w,I),this._callbacks=l,this._tileSize=512,this._renderWorldCopies=f?.renderWorldCopies===void 0||!!f?.renderWorldCopies,this._minZoom=f?.minZoom||0,this._maxZoom=f?.maxZoom||22,this._minPitch=f?.minPitch==null?0:f?.minPitch,this._maxPitch=f?.maxPitch==null?60:f?.maxPitch,this._constrainOverride=(v=f?.constrainOverride)!==null&&v!==void 0?v:null,this.setMaxBounds(),this._width=0,this._height=0,this._center=new s.V(0,0),this._elevation=0,this._zoom=0,this._tileZoom=Pr(this._zoom),this._scale=s.aq(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new Oc,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(l,f,v){this._constrainOverride=l.constrainOverride,this._latRange=l.latRange,this._lngRange=l.lngRange,this._width=l.width,this._height=l.height,this._center=l.center,this._elevation=l.elevation,this._minElevationForCurrentTile=l.minElevationForCurrentTile,this._zoom=l.zoom,this._tileZoom=Pr(this._zoom),this._scale=s.aq(this._zoom),this._bearingInRadians=l.bearingInRadians,this._fovInRadians=l.fovInRadians,this._pitchInRadians=l.pitchInRadians,this._rollInRadians=l.rollInRadians,this._unmodified=l.unmodified,this._edgeInsets=new Oc(l.padding.top,l.padding.bottom,l.padding.left,l.padding.right),this._minZoom=l.minZoom,this._maxZoom=l.maxZoom,this._minPitch=l.minPitch,this._maxPitch=l.maxPitch,this._renderWorldCopies=l.renderWorldCopies,this._cameraToCenterDistance=l.cameraToCenterDistance,this._nearZ=l.nearZ,this._farZ=l.farZ,this._autoCalculateNearFarZ=!v&&l.autoCalculateNearFarZ,f&&this.constrainInternal(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(l){this._minElevationForCurrentTile=l}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(l){this._minZoom!==l&&(this._minZoom=l,this.setZoom(this.applyConstrain(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(l){this._maxZoom!==l&&(this._maxZoom=l,this.setZoom(this.applyConstrain(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(l){this._minPitch!==l&&(this._minPitch=l,this.setPitch(Math.max(this.pitch,l)))}get maxPitch(){return this._maxPitch}setMaxPitch(l){this._maxPitch!==l&&(this._maxPitch=l,this.setPitch(Math.min(this.pitch,l)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(l){l===void 0?l=!0:l===null&&(l=!1),this._renderWorldCopies=l}get constrainOverride(){return this._constrainOverride}setConstrainOverride(l){l===void 0&&(l=null),this._constrainOverride!==l&&(this._constrainOverride=l,this.constrainInternal(),this._calcMatrices())}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(l){const f=s.W(l,-180,180)*Math.PI/180;var v,w,I,k,B,W,Z,J,ue;this._bearingInRadians!==f&&(this._unmodified=!1,this._bearingInRadians=f,this._calcMatrices(),this._rotationMatrix=p(),v=this._rotationMatrix,I=-this._bearingInRadians,k=(w=this._rotationMatrix)[0],B=w[1],W=w[2],Z=w[3],J=Math.sin(I),ue=Math.cos(I),v[0]=k*ue+W*J,v[1]=B*ue+Z*J,v[2]=k*-J+W*ue,v[3]=B*-J+Z*ue)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(l){const f=s.an(l,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==f&&(this._unmodified=!1,this._pitchInRadians=f,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(l){const f=l/180*Math.PI;this._rollInRadians!==f&&(this._unmodified=!1,this._rollInRadians=f,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return s.aZ(this._fovInRadians)}setFov(l){l=s.an(l,.1,150),this.fov!==l&&(this._unmodified=!1,this._fovInRadians=s.ap(l),this._calcMatrices())}get zoom(){return this._zoom}setZoom(l){const f=this.applyConstrain(this._center,l).zoom;this._zoom!==f&&(this._unmodified=!1,this._zoom=f,this._tileZoom=Math.max(0,Math.floor(f)),this._scale=s.aq(f),this.constrainInternal(),this._calcMatrices())}get center(){return this._center}setCenter(l){l.lat===this._center.lat&&l.lng===this._center.lng||(this._unmodified=!1,this._center=l,this.constrainInternal(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(l){l!==this._elevation&&(this._elevation=l,this.constrainInternal(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(l){this._edgeInsets.equals(l)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,l,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(l,f){this._autoCalculateNearFarZ=!1,this._nearZ=l,this._farZ=f,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(l){return this._edgeInsets.equals(l)}interpolatePadding(l,f,v){this._unmodified=!1,this._edgeInsets.interpolate(l,f,v),this.constrainInternal(),this._calcMatrices()}resize(l,f,v=!0){this._width=l,this._height=f,v&&this.constrainInternal(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new Ce([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(l){l?(this._lngRange=[l.getWest(),l.getEast()],this._latRange=[l.getSouth(),l.getNorth()],this.constrainInternal()):(this._lngRange=null,this._latRange=[-s.ao,s.ao])}getCameraQueryGeometry(l,f){if(f.length===1)return[f[0],l];{const{minX:v,minY:w,maxX:I,maxY:k}=s.aa.fromPoints(f).extend(l);return[new s.P(v,w),new s.P(I,w),new s.P(I,k),new s.P(v,k),new s.P(v,w)]}}constrainInternal(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const l=this._unmodified,{center:f,zoom:v}=this.applyConstrain(this.center,this.zoom);this.setCenter(f),this.setZoom(v),this._unmodified=l,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let l=s.ar(new Float64Array(16));s.Q(l,l,[this._width/2,-this._height/2,1]),s.O(l,l,[1,-1,0]),this._clipSpaceToPixelsMatrix=l,l=s.ar(new Float64Array(16)),s.Q(l,l,[1,-1,1]),s.O(l,l,[-1,-1,0]),s.Q(l,l,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=l,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(l,f,v,w){const I=v!==void 0?v:this.bearing,k=w=w!==void 0?w:this.pitch,{distanceToCenter:B,clampedElevation:W}=this._distanceToCenterFromAltElevationPitch(f,this.elevation,k),{x:Z,y:J}=hn(k,I),ue=s.a9.fromLngLat(l,f);let le,_e,Ee=s.a_(1,ue.y),ze=0;do{if(ze+=1,ze>10)break;_e=B/Ee,le=new s.a9(ue.x+Z*_e,ue.y+J*_e),Ee=1/le.meterInMercatorCoordinateUnits()}while(Math.abs(B-_e*Ee)>1e-12);return{center:le.toLngLat(),elevation:W,zoom:s.at(this.height/2/Math.tan(this.fovInRadians/2)/_e/this.tileSize)}}recalculateZoomAndCenter(l){if(this.elevation-l==0)return;const f=1/this.worldSize,v=s.as(1,this.center.lat)*this.worldSize,w=s.a9.fromLngLat(this.center,this.elevation),I=w.x/f,k=w.y/f,B=w.z/f,W=this.pitch,Z=this.bearing,{x:J,y:ue,z:le}=hn(W,Z),_e=this.cameraToCenterDistance,Ee=I+_e*-J,ze=k+_e*-ue,$e=B+_e*le,{distanceToCenter:Ne,clampedElevation:Ze}=this._distanceToCenterFromAltElevationPitch($e/v,l,W),rt=Ne*v,We=new s.a9((Ee+J*rt)*f,(ze+ue*rt)*f,0).toLngLat(),it=s.as(1,We.lat),lt=s.at(this.height/2/Math.tan(this.fovInRadians/2)/Ne/it/this.tileSize);this._elevation=Ze,this._center=We,this.setZoom(lt)}_distanceToCenterFromAltElevationPitch(l,f,v){const w=-Math.cos(s.ap(v)),I=l-f;let k,B=f;return w*I>=0||Math.abs(w)<.1?(k=1e4,B=l+k*w):k=-I/w,{distanceToCenter:k,clampedElevation:B}}getCameraPoint(){const l=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(l*Math.sin(this.rollInRadians),l*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const l=s.as(1,this.center.lat)*this.worldSize;return Tt(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/l).toLngLat()}getMercatorTileCoordinates(l){if(!l)return[0,0,1,1];const f=l.canonical.z>=0?1<<l.canonical.z:Math.pow(2,l.canonical.z);return[l.canonical.x/f,l.canonical.y/f,1/f/s.a5,1/f/s.a5]}}class Uo{constructor(l,f){this.min=l,this.max=f,this.center=s.a$([],s.b0([],this.min,this.max),.5)}quadrant(l){const f=[l%2==0,l<2],v=s.b1(this.min),w=s.b1(this.max);for(let I=0;I<f.length;I++)v[I]=f[I]?this.min[I]:this.center[I],w[I]=f[I]?this.center[I]:this.max[I];return w[2]=this.max[2],new Uo(v,w)}distanceX(l){return Math.max(Math.min(this.max[0],l[0]),this.min[0])-l[0]}distanceY(l){return Math.max(Math.min(this.max[1],l[1]),this.min[1])-l[1]}intersectsFrustum(l){let f=!0;for(let v=0;v<l.planes.length;v++){const w=this.intersectsPlane(l.planes[v]);if(w===0)return 0;w===1&&(f=!1)}return f?2:l.aabb.min[0]>this.max[0]||l.aabb.min[1]>this.max[1]||l.aabb.min[2]>this.max[2]||l.aabb.max[0]<this.min[0]||l.aabb.max[1]<this.min[1]||l.aabb.max[2]<this.min[2]?0:1}intersectsPlane(l){let f=l[3],v=l[3];for(let w=0;w<3;w++)l[w]>0?(f+=l[w]*this.min[w],v+=l[w]*this.max[w]):(v+=l[w]*this.min[w],f+=l[w]*this.max[w]);return f>=0?2:v<0?0:1}}class Pu{distanceToTile2d(l,f,v,w){const I=w.distanceX([l,f]),k=w.distanceY([l,f]);return Math.hypot(I,k)}getWrap(l,f,v){return v}getTileBoundingVolume(l,f,v,w){var I,k;let B=0,W=0;if(w?.terrain){const J=new s.a2(l.z,f,l.z,l.x,l.y),ue=w.terrain.getMinMaxElevation(J);B=(I=ue.minElevation)!==null&&I!==void 0?I:Math.min(0,v),W=(k=ue.maxElevation)!==null&&k!==void 0?k:Math.max(0,v)}const Z=1<<l.z;return new Uo([f+l.x/Z,l.y/Z,B],[f+(l.x+1)/Z,(l.y+1)/Z,W])}allowVariableZoom(l,f){const v=l.fov*(Math.abs(Math.cos(l.rollInRadians))*l.height+Math.abs(Math.sin(l.rollInRadians))*l.width)/l.height,w=s.an(78.5-v/2,0,60);return!!f.terrain||l.pitch>w}allowWorldCopies(){return!0}prepareNextFrame(){}}class Ts{constructor(l,f,v){this.points=l,this.planes=f,this.aabb=v}static fromInvProjectionMatrix(l,f=1,v=0,w,I){const k=I?[[6,5,4],[0,1,2],[0,3,7],[2,1,5],[3,2,6],[0,4,5]]:[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]],B=Math.pow(2,v),W=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((le=>(function(_e,Ee,ze,$e){const Ne=s.aH([],_e,Ee),Ze=1/Ne[3]/ze*$e;return s.b6(Ne,Ne,[Ze,Ze,1/Ne[3],Ze])})(le,l,f,B)));w&&(function(le,_e,Ee,ze){const $e=ze?4:0,Ne=ze?0:4;let Ze=0;const rt=[],We=[];for(let Qe=0;Qe<4;Qe++){const _t=s.b2([],le[Qe+Ne],le[Qe+$e]),Dt=s.b7(_t);s.a$(_t,_t,1/Dt),rt.push(Dt),We.push(_t)}for(let Qe=0;Qe<4;Qe++){const _t=s.b8(le[Qe+$e],We[Qe],Ee);Ze=_t!==null&&_t>=0?Math.max(Ze,_t):Math.max(Ze,rt[Qe])}const it=(function(Qe,_t){const Dt=s.b2([],Qe[_t[0]],Qe[_t[1]]),At=s.b2([],Qe[_t[2]],Qe[_t[1]]),Pt=[0,0,0,0];return s.b3(Pt,s.b4([],Dt,At)),Pt[3]=-s.b5(Pt,Qe[_t[0]]),Pt})(le,_e),lt=(function(Qe,_t){const Dt=s.b9(Qe),At=s.ba([],Qe,1/Dt),Pt=s.b2([],_t,s.a$([],At,s.b5(_t,At))),It=s.b9(Pt);if(It>0){const Qt=Math.sqrt(1-At[3]*At[3]),ti=s.a$([],At,-At[3]),Xt=s.b0([],ti,s.a$([],Pt,Qt/It));return s.bb(_t,Xt)}return null})(Ee,it);if(lt!==null){const Qe=lt/s.b5(We[0],it);Ze=Math.min(Ze,Qe)}for(let Qe=0;Qe<4;Qe++){const _t=Math.min(Ze,rt[Qe]);le[Qe+Ne]=[le[Qe+$e][0]+We[Qe][0]*_t,le[Qe+$e][1]+We[Qe][1]*_t,le[Qe+$e][2]+We[Qe][2]*_t,1]}})(W,k[0],w,I);const Z=k.map((le=>{const _e=s.b2([],W[le[0]],W[le[1]]),Ee=s.b2([],W[le[2]],W[le[1]]),ze=s.b3([],s.b4([],_e,Ee)),$e=-s.b5(ze,W[le[1]]);return ze.concat($e)})),J=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],ue=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const le of W)for(let _e=0;_e<3;_e++)J[_e]=Math.min(J[_e],le[_e]),ue[_e]=Math.max(ue[_e],le[_e]);return new Ts(W,Z,new Uo(J,ue))}}class Yl{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(l){this._helper.setMinZoom(l)}setMaxZoom(l){this._helper.setMaxZoom(l)}setMinPitch(l){this._helper.setMinPitch(l)}setMaxPitch(l){this._helper.setMaxPitch(l)}setRenderWorldCopies(l){this._helper.setRenderWorldCopies(l)}setBearing(l){this._helper.setBearing(l)}setPitch(l){this._helper.setPitch(l)}setRoll(l){this._helper.setRoll(l)}setFov(l){this._helper.setFov(l)}setZoom(l){this._helper.setZoom(l)}setCenter(l){this._helper.setCenter(l)}setElevation(l){this._helper.setElevation(l)}setMinElevationForCurrentTile(l){this._helper.setMinElevationForCurrentTile(l)}setPadding(l){this._helper.setPadding(l)}interpolatePadding(l,f,v){return this._helper.interpolatePadding(l,f,v)}isPaddingEqual(l){return this._helper.isPaddingEqual(l)}resize(l,f,v=!0){this._helper.resize(l,f,v)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(l){this._helper.setMaxBounds(l)}setConstrainOverride(l){this._helper.setConstrainOverride(l)}overrideNearFarZ(l,f){this._helper.overrideNearFarZ(l,f)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(l){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),l)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(l,f){}constructor(l){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this.defaultConstrain=(f,v)=>{v=s.an(+v,this.minZoom,this.maxZoom);const w={center:new s.V(f.lng,f.lat),zoom:v};let I=this._helper._lngRange;if(!this._helper._renderWorldCopies&&I===null){const We=179.9999999999;I=[-We,We]}const k=this.tileSize*s.aq(w.zoom);let B=0,W=k,Z=0,J=k,ue=0,le=0;const{x:_e,y:Ee}=this.size;if(this._helper._latRange){const We=this._helper._latRange;B=s.X(We[1])*k,W=s.X(We[0])*k,W-B<Ee&&(ue=Ee/(W-B))}I&&(Z=s.W(s.Y(I[0])*k,0,k),J=s.W(s.Y(I[1])*k,0,k),J<Z&&(J+=k),J-Z<_e&&(le=_e/(J-Z)));const{x:ze,y:$e}=gi(k,f);let Ne,Ze;const rt=Math.max(le||0,ue||0);if(rt){const We=new s.P(le?(J+Z)/2:ze,ue?(W+B)/2:$e);return w.center=Fi(k,We).wrap(),w.zoom+=s.at(rt),w}if(this._helper._latRange){const We=Ee/2;$e-We<B&&(Ze=B+We),$e+We>W&&(Ze=W-We)}if(I){const We=(Z+J)/2;let it=ze;this._helper._renderWorldCopies&&(it=s.W(ze,We-k/2,We+k/2));const lt=_e/2;it-lt<Z&&(Ne=Z+lt),it+lt>J&&(Ne=J-lt)}if(Ne!==void 0||Ze!==void 0){const We=new s.P(Ne??ze,Ze??$e);w.center=Fi(k,We).wrap()}return w},this.applyConstrain=(f,v)=>this._helper.applyConstrain(f,v),this._helper=new Xl({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(f,v)=>this.defaultConstrain(f,v)},l),this._coveringTilesDetailsProvider=new Pu}clone(){const l=new Yl;return l.apply(this),l}apply(l,f,v){this._helper.apply(l,f,v)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(l){const f=[new s.bc(0,l)];if(this._helper._renderWorldCopies){const v=this.screenPointToMercatorCoordinate(new s.P(0,0)),w=this.screenPointToMercatorCoordinate(new s.P(this._helper._width,0)),I=this.screenPointToMercatorCoordinate(new s.P(this._helper._width,this._helper._height)),k=this.screenPointToMercatorCoordinate(new s.P(0,this._helper._height)),B=Math.floor(Math.min(v.x,w.x,I.x,k.x)),W=Math.floor(Math.max(v.x,w.x,I.x,k.x)),Z=1;for(let J=B-Z;J<=W+Z;J++)J!==0&&f.push(new s.bc(J,l))}return f}getCameraFrustum(){return Ts.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(l){const f=this.screenPointToLocation(this.centerPoint,l),v=l?l.getElevationForLngLatZoom(f,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(v)}setLocationAtPoint(l,f){const v=s.as(this.elevation,this.center.lat),w=this.screenPointToMercatorCoordinateAtZ(f,v),I=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,v),k=s.a9.fromLngLat(l),B=new s.a9(k.x-(w.x-I.x),k.y-(w.y-I.y));this.setCenter(B?.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(l,f){return f?this.coordinatePoint(s.a9.fromLngLat(l),f.getElevationForLngLat(l,this),this._pixelMatrix3D):this.coordinatePoint(s.a9.fromLngLat(l))}screenPointToLocation(l,f){var v;return(v=this.screenPointToMercatorCoordinate(l,f))===null||v===void 0?void 0:v.toLngLat()}screenPointToMercatorCoordinate(l,f){if(f){const v=f.pointCoordinate(l);if(v!=null)return v}return this.screenPointToMercatorCoordinateAtZ(l)}screenPointToMercatorCoordinateAtZ(l,f){const v=f||0,w=[l.x,l.y,0,1],I=[l.x,l.y,1,1];s.aH(w,w,this._pixelMatrixInverse),s.aH(I,I,this._pixelMatrixInverse);const k=w[3],B=I[3],W=w[1]/k,Z=I[1]/B,J=w[2]/k,ue=I[2]/B,le=J===ue?0:(v-J)/(ue-J);return new s.a9(s.G.number(w[0]/k,I[0]/B,le)/this.worldSize,s.G.number(W,Z,le)/this.worldSize,v)}coordinatePoint(l,f=0,v=this._pixelMatrix){const w=[l.x*this.worldSize,l.y*this.worldSize,f,1];return s.aH(w,w,v),new s.P(w[0]/w[3],w[1]/w[3])}getBounds(){const l=Math.max(0,this._helper._height/2-un(this));return new Ce().extend(this.screenPointToLocation(new s.P(0,l))).extend(this.screenPointToLocation(new s.P(this._helper._width,l))).extend(this.screenPointToLocation(new s.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new s.P(0,this._helper._height)))}isPointOnMapSurface(l,f){return f?f.pointCoordinate(l)!=null:l.y>this.height/2-un(this)}calculatePosMatrix(l,f=!1,v){var w;const I=(w=l.key)!==null&&w!==void 0?w:s.bd(l.wrap,l.canonical.z,l.canonical.z,l.canonical.x,l.canonical.y),k=f?this._alignedPosMatrixCache:this._posMatrixCache;if(k.has(I)){const Z=k.get(I);return v?Z.f32:Z.f64}const B=nn(l,this.worldSize);s.S(B,f?this._alignedProjMatrix:this._viewProjMatrix,B);const W={f64:B,f32:new Float32Array(B)};return k.set(I,W),v?W.f32:W.f64}calculateFogMatrix(l){const f=l.key,v=this._fogMatrixCacheF32;if(v.has(f))return v.get(f);const w=nn(l,this.worldSize);return s.S(w,this._fogMatrix,w),v.set(f,new Float32Array(w)),v.get(f)}calculateCenterFromCameraLngLatAlt(l,f,v,w){return this._helper.calculateCenterFromCameraLngLatAlt(l,f,v,w)}_calculateNearFarZIfNeeded(l,f,v){if(!this._helper.autoCalculateNearFarZ)return;const w=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),I=l-w*this._helper._pixelPerMeter/Math.cos(f),k=w<0?I:l,B=Math.PI/2+this.pitchInRadians,W=s.ap(this.fov)*(Math.abs(Math.cos(s.ap(this.roll)))*this.height+Math.abs(Math.sin(s.ap(this.roll)))*this.width)/this.height*(.5+v.y/this.height),Z=Math.sin(W)*k/Math.sin(s.an(Math.PI-B-W,.01,Math.PI-.01)),J=un(this),ue=Math.atan(J/this._helper.cameraToCenterDistance),le=s.ap(.75),_e=ue>le?2*ue*(.5+v.y/(2*J)):le,Ee=Math.sin(_e)*k/Math.sin(s.an(Math.PI-B-_e,.01,Math.PI-.01)),ze=Math.min(Z,Ee);this._helper._farZ=1.01*(Math.cos(Math.PI/2-f)*ze+k),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const l=this.centerOffset,f=gi(this.worldSize,this.center),v=f.x,w=f.y;this._helper._pixelPerMeter=s.as(1,this.center.lat)*this.worldSize;const I=s.ap(Math.min(this.pitch,Jt)),k=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(I));let B;this._calculateNearFarZIfNeeded(k,I,l),B=new Float64Array(16),s.be(B,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),s.aB(this._invProjMatrix,B),B[8]=2*-l.x/this._helper._width,B[9]=2*l.y/this._helper._height,this._projectionMatrix=s.bf(B),s.Q(B,B,[1,-1,1]),s.O(B,B,[0,0,-this._helper.cameraToCenterDistance]),s.bg(B,B,-this.rollInRadians),s.bh(B,B,this.pitchInRadians),s.bg(B,B,-this.bearingInRadians),s.O(B,B,[-v,-w,0]),this._mercatorMatrix=s.Q([],B,[this.worldSize,this.worldSize,this.worldSize]),s.Q(B,B,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=s.S(new Float64Array(16),this.clipSpaceToPixelsMatrix,B),s.O(B,B,[0,0,-this.elevation]),this._viewProjMatrix=B,this._invViewProjMatrix=s.aB([],B);const W=[0,0,-1,1];s.aH(W,W,this._invViewProjMatrix),this._cameraPosition=[W[0]/W[3],W[1]/W[3],W[2]/W[3]],this._fogMatrix=new Float64Array(16),s.be(this._fogMatrix,this.fovInRadians,this.width/this.height,k,this._helper._farZ),this._fogMatrix[8]=2*-l.x/this.width,this._fogMatrix[9]=2*l.y/this.height,s.Q(this._fogMatrix,this._fogMatrix,[1,-1,1]),s.O(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),s.bg(this._fogMatrix,this._fogMatrix,-this.rollInRadians),s.bh(this._fogMatrix,this._fogMatrix,this.pitchInRadians),s.bg(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),s.O(this._fogMatrix,this._fogMatrix,[-v,-w,0]),s.Q(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),s.O(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=s.S(new Float64Array(16),this.clipSpaceToPixelsMatrix,B);const Z=this._helper._width%2/2,J=this._helper._height%2/2,ue=Math.cos(this.bearingInRadians),le=Math.sin(-this.bearingInRadians),_e=v-Math.round(v)+ue*Z+le*J,Ee=w-Math.round(w)+ue*J+le*Z,ze=new Float64Array(B);if(s.O(ze,ze,[_e>.5?_e-1:_e,Ee>.5?Ee-1:Ee,0]),this._alignedProjMatrix=ze,B=s.aB(new Float64Array(16),this._pixelMatrix),!B)throw new Error("failed to invert matrix");this._pixelMatrixInverse=B,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const l=this.screenPointToMercatorCoordinate(new s.P(0,0)),f=[l.x*this.worldSize,l.y*this.worldSize,0,1];return s.aH(f,f,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const l=s.as(1,this.center.lat)*this.worldSize;return Tt(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/l).toLngLat()}lngLatToCameraDepth(l,f){const v=s.a9.fromLngLat(l),w=[v.x*this.worldSize,v.y*this.worldSize,f,1];return s.aH(w,w,this._viewProjMatrix),w[2]/w[3]}getProjectionData(l){const{overscaledTileID:f,aligned:v,applyTerrainMatrix:w}=l,I=this._helper.getMercatorTileCoordinates(f),k=f?this.calculatePosMatrix(f,v,!0):null;let B;return B=f&&f.terrainRttPosMatrix32f&&w?f.terrainRttPosMatrix32f:k||s.bi(),{mainMatrix:B,tileMercatorCoords:I,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:B}}isLocationOccluded(l){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(l,f,v){return 1}transformLightDirection(l){return s.b1(l)}getRayDirectionFromPixel(l){throw new Error("Not implemented.")}projectTileCoordinates(l,f,v,w){const I=this.calculatePosMatrix(v);let k;w?(k=[l,f,w(l,f),1],s.aH(k,k,I)):(k=[l,f,0,1],Zl(k,k,I));const B=k[3];return{point:new s.P(k[0]/B,k[1]/B),signedDistanceFromCamera:B,isOccluded:!1}}populateCache(l){for(const f of l)this.calculatePosMatrix(f)}getMatrixForModel(l,f){const v=s.a9.fromLngLat(l,f),w=v.meterInMercatorCoordinateUnits(),I=s.bj();return s.O(I,I,[v.x,v.y,v.z]),s.bg(I,I,Math.PI),s.bh(I,I,Math.PI/2),s.Q(I,I,[-w,w,w]),I}getProjectionDataForCustomLayer(l=!0){const f=new s.a2(0,0,0,0,0),v=this.getProjectionData({overscaledTileID:f,applyGlobeMatrix:l}),w=nn(f,this.worldSize);s.S(w,this._viewProjMatrix,w),v.tileMercatorCoords=[0,0,1,1];const I=[s.a5,s.a5,this.worldSize/this._helper.pixelsPerMeter],k=s.bk();return s.Q(k,w,I),v.fallbackMatrix=k,v.mainMatrix=k,v}getFastPathSimpleProjectionMatrix(l){return this.calculatePosMatrix(l)}}function Ca(){s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function _l(A){if(A.useSlerp)if(A.k<1){const l=s.bl(A.startEulerAngles.roll,A.startEulerAngles.pitch,A.startEulerAngles.bearing),f=s.bl(A.endEulerAngles.roll,A.endEulerAngles.pitch,A.endEulerAngles.bearing),v=new Float64Array(4);s.bm(v,l,f,A.k);const w=s.bn(v);A.tr.setRoll(w.roll),A.tr.setPitch(w.pitch),A.tr.setBearing(w.bearing)}else A.tr.setRoll(A.endEulerAngles.roll),A.tr.setPitch(A.endEulerAngles.pitch),A.tr.setBearing(A.endEulerAngles.bearing);else A.tr.setRoll(s.G.number(A.startEulerAngles.roll,A.endEulerAngles.roll,A.k)),A.tr.setPitch(s.G.number(A.startEulerAngles.pitch,A.endEulerAngles.pitch,A.k)),A.tr.setBearing(s.G.number(A.startEulerAngles.bearing,A.endEulerAngles.bearing,A.k))}function jo(A,l,f,v,w){const I=w.padding,k=gi(w.worldSize,f.getNorthWest()),B=gi(w.worldSize,f.getNorthEast()),W=gi(w.worldSize,f.getSouthEast()),Z=gi(w.worldSize,f.getSouthWest()),J=s.ap(-v),ue=k.rotate(J),le=B.rotate(J),_e=W.rotate(J),Ee=Z.rotate(J),ze=new s.P(Math.max(ue.x,le.x,Ee.x,_e.x),Math.max(ue.y,le.y,Ee.y,_e.y)),$e=new s.P(Math.min(ue.x,le.x,Ee.x,_e.x),Math.min(ue.y,le.y,Ee.y,_e.y)),Ne=ze.sub($e),Ze=(w.width-(I.left+I.right+l.left+l.right))/Ne.x,rt=(w.height-(I.top+I.bottom+l.top+l.bottom))/Ne.y;if(rt<0||Ze<0)return void Ca();const We=Math.min(s.at(w.scale*Math.min(Ze,rt)),A.maxZoom),it=s.P.convert(A.offset),lt=new s.P((l.left-l.right)/2,(l.top-l.bottom)/2).rotate(s.ap(v)),Qe=it.add(lt).mult(w.scale/s.aq(We));return{center:Fi(w.worldSize,k.add(W).div(2).sub(Qe)),zoom:We,bearing:v}}class vl{get useGlobeControls(){return!1}handlePanInertia(l,f){const v=l.mag(),w=Math.abs(un(f));return{easingOffset:l.mult(Math.min(.75*w/v,1)),easingCenter:f.center}}handleMapControlsRollPitchBearingZoom(l,f){l.bearingDelta&&f.setBearing(f.bearing+l.bearingDelta),l.pitchDelta&&f.setPitch(f.pitch+l.pitchDelta),l.rollDelta&&f.setRoll(f.roll+l.rollDelta),l.zoomDelta&&f.setZoom(f.zoom+l.zoomDelta)}handleMapControlsPan(l,f,v){l.around.distSqr(f.centerPoint)<.01||f.setLocationAtPoint(v,l.around)}cameraForBoxAndBearing(l,f,v,w,I){return jo(l,f,v,w,I)}handleJumpToCenterZoom(l,f){l.zoom!==(f.zoom!==void 0?+f.zoom:l.zoom)&&l.setZoom(+f.zoom),f.center!==void 0&&l.setCenter(s.V.convert(f.center))}handleEaseTo(l,f){const v=l.zoom,w=l.padding,I={roll:l.roll,pitch:l.pitch,bearing:l.bearing},k={roll:f.roll===void 0?l.roll:f.roll,pitch:f.pitch===void 0?l.pitch:f.pitch,bearing:f.bearing===void 0?l.bearing:f.bearing},B=f.zoom!==void 0,W=!l.isPaddingEqual(f.padding);let Z=!1;const J=B?+f.zoom:l.zoom;let ue=l.centerPoint.add(f.offsetAsPoint);const le=l.screenPointToLocation(ue),{center:_e,zoom:Ee}=l.applyConstrain(s.V.convert(f.center||le),J??v);gl(l,_e);const ze=gi(l.worldSize,le),$e=gi(l.worldSize,_e).sub(ze),Ne=s.aq(Ee-v);return Z=Ee!==v,{easeFunc:Ze=>{if(Z&&l.setZoom(s.G.number(v,Ee,Ze)),s.bo(I,k)||_l({startEulerAngles:I,endEulerAngles:k,tr:l,k:Ze,useSlerp:I.roll!=k.roll}),W&&(l.interpolatePadding(w,f.padding,Ze),ue=l.centerPoint.add(f.offsetAsPoint)),f.around)l.setLocationAtPoint(f.around,f.aroundPoint);else{const rt=s.aq(l.zoom-v),We=Ee>v?Math.min(2,Ne):Math.max(.5,Ne),it=Math.pow(We,1-Ze),lt=Fi(l.worldSize,ze.add($e.mult(Ze*it)).mult(rt));l.setLocationAtPoint(l.renderWorldCopies?lt.wrap():lt,ue)}},isZooming:Z,elevationCenter:_e}}handleFlyTo(l,f){const v=f.zoom!==void 0,w=l.zoom,I=l.applyConstrain(s.V.convert(f.center||f.locationAtOffset),v?+f.zoom:w),k=I.center,B=I.zoom;gl(l,k);const W=gi(l.worldSize,f.locationAtOffset),Z=gi(l.worldSize,k).sub(W),J=Z.mag(),ue=s.aq(B-w);let le;if(f.minZoom!==void 0){const _e=Math.min(+f.minZoom,w,B),Ee=l.applyConstrain(k,_e).zoom;le=s.aq(Ee-w)}return{easeFunc:(_e,Ee,ze,$e)=>{l.setZoom(_e===1?B:w+s.at(Ee));const Ne=_e===1?k:Fi(l.worldSize,W.add(Z.mult(ze)).mult(Ee));l.setLocationAtPoint(l.renderWorldCopies?Ne.wrap():Ne,$e)},scaleOfZoom:ue,targetCenter:k,scaleOfMinZoom:le,pixelPathLength:J}}}class Nn{constructor(l,f,v){this.blendFunction=l,this.blendColor=f,this.mask=v}}Nn.Replace=[1,0],Nn.disabled=new Nn(Nn.Replace,s.bp.transparent,[!1,!1,!1,!1]),Nn.unblended=new Nn(Nn.Replace,s.bp.transparent,[!0,!0,!0,!0]),Nn.alphaBlended=new Nn([1,771],s.bp.transparent,[!0,!0,!0,!0]);const Kl=2305;class _n{constructor(l,f,v){this.enable=l,this.mode=f,this.frontFace=v}}_n.disabled=new _n(!1,1029,Kl),_n.backCCW=new _n(!0,1029,Kl),_n.frontCCW=new _n(!0,1028,Kl);class Ji{constructor(l,f,v){this.func=l,this.mask=f,this.range=v}}Ji.ReadOnly=!1,Ji.ReadWrite=!0,Ji.disabled=new Ji(519,Ji.ReadOnly,[0,1]);const Jl=7680;class bn{constructor(l,f,v,w,I,k){this.test=l,this.ref=f,this.mask=v,this.fail=w,this.depthFail=I,this.pass=k}}bn.disabled=new bn({func:519,mask:0},0,0,Jl,Jl,Jl);const Iu=new WeakMap;function Mo(A){var l;if(Iu.has(A))return Iu.get(A);{const f=(l=A.getParameter(A.VERSION))===null||l===void 0?void 0:l.startsWith("WebGL 2.0");return Iu.set(A,f),f}}class Ql{get awaitingQuery(){return!!this._readbackQueue}constructor(l){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=l;const f=l.context,v=f.gl;this._texFormat=v.RGBA,this._texType=v.UNSIGNED_BYTE;const w=new s.aW;w.emplaceBack(-1,-1),w.emplaceBack(2,-1),w.emplaceBack(-1,2);const I=new s.aY;I.emplaceBack(0,1,2),this._fullscreenTriangle=new Bn(f.createVertexBuffer(w,Ma.members),f.createIndexBuffer(I),s.aX.simpleSegment(0,0,w.length,I.length)),this._resultBuffer=new Uint8Array(4),f.activeTexture.set(v.TEXTURE1);const k=v.createTexture();v.bindTexture(v.TEXTURE_2D,k),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.NEAREST),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,v.NEAREST),v.texImage2D(v.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=f.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(k),Mo(v)&&(this._pbo=v.createBuffer(),v.bindBuffer(v.PIXEL_PACK_BUFFER,this._pbo),v.bufferData(v.PIXEL_PACK_BUFFER,4,v.STREAM_READ),v.bindBuffer(v.PIXEL_PACK_BUFFER,null))}destroy(){const l=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),l.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(l,f){const v=this._updateCount;return this._readbackQueue?v>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():v>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(l,f),this._updateCount++,this._measuredError}_bindFramebuffer(){const l=this._cachedRenderContext.context,f=l.gl;l.activeTexture.set(f.TEXTURE1),f.bindTexture(f.TEXTURE_2D,this._fbo.colorAttachment.get()),l.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(l,f){const v=this._cachedRenderContext.context,w=v.gl;if(this._bindFramebuffer(),v.viewport.set([0,0,this._texWidth,this._texHeight]),v.clear({color:s.bp.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(v,w.TRIANGLES,Ji.disabled,bn.disabled,Nn.unblended,_n.disabled,((I,k)=>({u_input:I,u_output_expected:k}))(l,f),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&Mo(w)){w.bindBuffer(w.PIXEL_PACK_BUFFER,this._pbo),w.readBuffer(w.COLOR_ATTACHMENT0),w.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),w.bindBuffer(w.PIXEL_PACK_BUFFER,null);const I=w.fenceSync(w.SYNC_GPU_COMMANDS_COMPLETE,0);w.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:I}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const l=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&Mo(l)){const f=l.clientWaitSync(this._readbackQueue.sync,0,0);if(f===l.WAIT_FAILED)return s.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(f===l.TIMEOUT_EXPIRED)return;l.bindBuffer(l.PIXEL_PACK_BUFFER,this._pbo),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),l.bindBuffer(l.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),l.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=Ql._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(l){let f=0;return f+=l[0]/256,f+=l[1]/65536,f+=l[2]/16777216,l[3]<127&&(f=-f),f/128}}const Ea=s.a5/128;function Op(A,l){const f=A.granularity!==void 0?Math.max(A.granularity,1):1,v=f+(A.generateBorders?2:0),w=f+(A.extendToNorthPole||A.generateBorders?1:0)+(A.extendToSouthPole||A.generateBorders?1:0),I=v+1,k=w+1,B=A.generateBorders?-1:0,W=A.generateBorders||A.extendToNorthPole?-1:0,Z=f+(A.generateBorders?1:0),J=f+(A.generateBorders||A.extendToSouthPole?1:0),ue=I*k,le=v*w*6,_e=I*k>65536;if(_e&&l==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const Ee=_e||l==="32bit",ze=new Int16Array(2*ue);let $e=0;for(let rt=W;rt<=J;rt++)for(let We=B;We<=Z;We++){let it=We/f*s.a5;We===-1&&(it=-Ea),We===f+1&&(it=s.a5+Ea);let lt=rt/f*s.a5;rt===-1&&(lt=A.extendToNorthPole?s.br:-Ea),rt===f+1&&(lt=A.extendToSouthPole?s.bs:s.a5+Ea),ze[$e++]=it,ze[$e++]=lt}const Ne=Ee?new Uint32Array(le):new Uint16Array(le);let Ze=0;for(let rt=0;rt<w;rt++)for(let We=0;We<v;We++){const it=We+1+rt*I,lt=We+(rt+1)*I,Qe=We+1+(rt+1)*I;Ne[Ze++]=We+rt*I,Ne[Ze++]=lt,Ne[Ze++]=it,Ne[Ze++]=it,Ne[Ze++]=lt,Ne[Ze++]=Qe}return{vertices:ze.buffer.slice(0),indices:Ne.buffer.slice(0),uses32bitIndices:Ee}}const Ru=new s.aV({fill:new s.bt(128,2),line:new s.bt(512,0),tile:new s.bt(128,32),stencil:new s.bt(128,1),circle:3});class tf{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return xn.projectionGlobe}get vertexShaderPreludeCode(){return xn.projectionMercator.vertexSource}get subdivisionGranularity(){return Ru}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(l){this._errorMeasurement||(this._errorMeasurement=new Ql(l));const f=s.X(this._errorQueryLatitudeDegrees),v=2*Math.atan(Math.exp(Math.PI-f*Math.PI*2))-.5*Math.PI,w=this._errorMeasurement.updateErrorLoop(f,v),I=P();w!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=w,this._errorMeasurementLastChangeTime=I);const k=Math.min(Math.max((I-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=s.bu(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,s.bv(k))}_getMeshKey(l){return`${l.granularity.toString(36)}_${l.generateBorders?"b":""}${l.extendToNorthPole?"n":""}${l.extendToSouthPole?"s":""}`}getMeshFromTileID(l,f,v,w,I){const k=(I==="stencil"?Ru.stencil:Ru.tile).getGranularityForZoomLevel(f.z);return this._getMesh(l,{granularity:k,generateBorders:v,extendToNorthPole:f.y===0&&w,extendToSouthPole:f.y===(1<<f.z)-1&&w})}_getMesh(l,f){const v=this._getMeshKey(f);if(v in this._tileMeshCache)return this._tileMeshCache[v];const w=(function(I,k){const B=Op(k,"16bit"),W=s.aW.deserialize({arrayBuffer:B.vertices,length:B.vertices.byteLength/2/2}),Z=s.aY.deserialize({arrayBuffer:B.indices,length:B.indices.byteLength/2/3});return new Bn(I.createVertexBuffer(W,Ma.members),I.createIndexBuffer(Z),s.aX.simpleSegment(0,0,W.length,Z.length))})(l,f);return this._tileMeshCache[v]=w,w}recalculate(l){}hasTransition(){const l=P();let f=!1;return f=f||(l-this._errorMeasurementLastChangeTime)/1e3<.7,f=f||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,f}setErrorQueryLatitudeDegrees(l){this._errorQueryLatitudeDegrees=l}}const b_=new s.t({type:new s.D(s.u.projection.type)});class zp extends s.E{constructor(l){super(),this._transitionable=new s.x(b_,void 0),this.setProjection(l),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new s.H(0)),this._mercatorProjection=new $s,this._verticalPerspectiveProjection=new tf}get transitionState(){const l=this.properties.get("type");if(typeof l=="string"&&l==="mercator")return 0;if(typeof l=="string"&&l==="vertical-perspective")return 1;if(l instanceof s.bw){if(l.from==="vertical-perspective"&&l.to==="mercator")return 1-l.transition;if(l.from==="mercator"&&l.to==="vertical-perspective")return l.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(l){this._mercatorProjection.updateGPUdependent(l),this._verticalPerspectiveProjection.updateGPUdependent(l)}getMeshFromTileID(l,f,v,w,I){return this.currentProjection.getMeshFromTileID(l,f,v,w,I)}setProjection(l){this._transitionable.setValue("type",l?.type||"mercator")}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}setErrorQueryLatitudeDegrees(l){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(l),this._mercatorProjection.setErrorQueryLatitudeDegrees(l)}}function yr(A){const l=ec(A.worldSize,A.center.lat);return 2*Math.PI*l}function Go(A,l,f,v,w){const I=1/(1<<w),k=l/s.a5*I+v*I,B=s.by((A/s.a5*I+f*I)*Math.PI*2+Math.PI,2*Math.PI),W=2*Math.atan(Math.exp(Math.PI-k*Math.PI*2))-.5*Math.PI,Z=Math.cos(W),J=new Float64Array(3);return J[0]=Math.sin(B)*Z,J[1]=Math.sin(W),J[2]=Math.cos(B)*Z,J}function sr(A){return(function(l,f){const v=Math.cos(f),w=new Float64Array(3);return w[0]=Math.sin(l)*v,w[1]=Math.sin(f),w[2]=Math.cos(l)*v,w})(A.lng*Math.PI/180,A.lat*Math.PI/180)}function ec(A,l){return A/(2*Math.PI)/Math.cos(l*Math.PI/180)}function nf(A){const l=Math.asin(A[1])/Math.PI*180,f=Math.sqrt(A[0]*A[0]+A[2]*A[2]);if(f>1e-6){const v=A[0]/f,w=Math.acos(A[2]/f),I=(v>0?w:-w)/Math.PI*180;return new s.V(s.W(I,-180,180),l)}return new s.V(0,l)}function Lu(A){return Math.cos(A*Math.PI/180)}function br(A,l){const f=Lu(A),v=Lu(l);return s.at(v/f)}function Bp(A,l){const f=A.rotate(l.bearingInRadians),v=l.zoom+br(l.center.lat,0),w=s.bu(1/Lu(l.center.lat),1/Lu(Math.min(Math.abs(l.center.lat),60)),s.bx(v,7,3,0,1)),I=360/yr({worldSize:l.worldSize,center:{lat:l.center.lat}});return new s.V(l.center.lng-f.x*I*w,s.an(l.center.lat+f.y*I,-s.ao,s.ao))}function rf(A){const l=.5*A,f=Math.sin(l),v=Math.cos(l);return Math.log(f+v)-Math.log(v-f)}function Np(A,l,f,v){const w=A.lat+f*v;if(Math.abs(f)>1){const I=(Math.sign(A.lat+f)!==Math.sign(A.lat)?-Math.abs(A.lat):Math.abs(A.lat))*Math.PI/180,k=Math.abs(A.lat+f)*Math.PI/180,B=rf(I+v*(k-I)),W=rf(I),Z=rf(k);return new s.V(A.lng+l*((B-W)/(Z-W)),w)}return new s.V(A.lng+l*v,w)}class sf{constructor(l){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._boundingVolumeFactory=l}swapBuffers(){if(!this._hadAnyChanges)return;const l=this._cachePrevious;this._cachePrevious=this._cache,this._cache=l,this._cache.clear(),this._hadAnyChanges=!1}getTileBoundingVolume(l,f,v,w){const I=`${l.z}_${l.x}_${l.y}_${w?.terrain?"t":""}`,k=this._cache.get(I);if(k)return k;const B=this._cachePrevious.get(I);if(B)return this._cache.set(I,B),B;const W=this._boundingVolumeFactory(l,f,v,w);return this._cache.set(I,W),this._hadAnyChanges=!0,W}}class Aa{constructor(l,f,v,w){this.min=v,this.max=w,this.points=l,this.planes=f}static fromAabb(l,f){const v=[];for(let w=0;w<8;w++)v.push([1&~w?l[0]:f[0],(w>>1&1)==1?f[1]:l[1],(w>>2&1)==1?f[2]:l[2]]);return new Aa(v,[[-1,0,0,f[0]],[1,0,0,-l[0]],[0,-1,0,f[1]],[0,1,0,-l[1]],[0,0,-1,f[2]],[0,0,1,-l[2]]],l,f)}static fromCenterSizeAngles(l,f,v){const w=s.bB([],v[0],v[1],v[2]),I=s.bC([],[f[0],0,0],w),k=s.bC([],[0,f[1],0],w),B=s.bC([],[0,0,f[2]],w),W=[...l],Z=[...l];for(let ue=0;ue<8;ue++)for(let le=0;le<3;le++){const _e=l[le]+I[le]*(1&~ue?-1:1)+k[le]*((ue>>1&1)==1?1:-1)+B[le]*((ue>>2&1)==1?1:-1);W[le]=Math.min(W[le],_e),Z[le]=Math.max(Z[le],_e)}const J=[];for(let ue=0;ue<8;ue++){const le=[...l];s.b0(le,le,s.a$([],I,1&~ue?-1:1)),s.b0(le,le,s.a$([],k,(ue>>1&1)==1?1:-1)),s.b0(le,le,s.a$([],B,(ue>>2&1)==1?1:-1)),J.push(le)}return new Aa(J,[[...I,-s.b5(I,J[0])],[...k,-s.b5(k,J[0])],[...B,-s.b5(B,J[0])],[-I[0],-I[1],-I[2],-s.b5(I,J[7])],[-k[0],-k[1],-k[2],-s.b5(k,J[7])],[-B[0],-B[1],-B[2],-s.b5(B,J[7])]],W,Z)}intersectsFrustum(l){let f=!0;const v=this.points.length,w=this.planes.length,I=l.planes.length,k=l.points.length;for(let B=0;B<I;B++){const W=l.planes[B];let Z=0;for(let J=0;J<v;J++){const ue=this.points[J];W[0]*ue[0]+W[1]*ue[1]+W[2]*ue[2]+W[3]>=0&&Z++}if(Z===0)return 0;Z<v&&(f=!1)}if(f)return 2;for(let B=0;B<w;B++){const W=this.planes[B];let Z=0;for(let J=0;J<k;J++){const ue=l.points[J];W[0]*ue[0]+W[1]*ue[1]+W[2]*ue[2]+W[3]>=0&&Z++}if(Z===0)return 0}return 1}intersectsPlane(l){const f=this.points.length;let v=0;for(let w=0;w<f;w++){const I=this.points[w];l[0]*I[0]+l[1]*I[1]+l[2]*I[2]+l[3]>=0&&v++}return v===f?2:v===0?0:1}}function Vh(A,l,f){const v=A-l;return v<0?-v:Math.max(0,v-f)}function tc(A,l,f,v,w){const I=A-f;let k;return k=I<0?Math.min(-I,1+I-w):I>1?Math.min(Math.max(I-w,0),1-I):0,Math.max(k,Vh(l,v,w))}class Uh{constructor(){this._boundingVolumeCache=new sf(this._computeTileBoundingVolume)}prepareNextFrame(){this._boundingVolumeCache.swapBuffers()}distanceToTile2d(l,f,v,w){const I=1<<v.z,k=1/I,B=v.x/I,W=v.y/I;let Z=2;return Z=Math.min(Z,tc(l,f,B,W,k)),Z=Math.min(Z,tc(l,f,B+.5,-W-k,k)),Z=Math.min(Z,tc(l,f,B+.5,2-W-k,k)),Z}getWrap(l,f,v){const w=1<<f.z,I=1/w,k=f.x/w,B=Vh(l.x,k,I),W=Vh(l.x,k-1,I),Z=Vh(l.x,k+1,I),J=Math.min(B,W,Z);return J===Z?1:J===W?-1:0}allowVariableZoom(l,f){return wn(l,f)>4}allowWorldCopies(){return!1}getTileBoundingVolume(l,f,v,w){return this._boundingVolumeCache.getTileBoundingVolume(l,f,v,w)}_computeTileBoundingVolume(l,f,v,w){var I,k;let B=0,W=0;if(w?.terrain){const Z=new s.a2(l.z,f,l.z,l.x,l.y),J=w.terrain.getMinMaxElevation(Z);B=(I=J.minElevation)!==null&&I!==void 0?I:Math.min(0,v),W=(k=J.maxElevation)!==null&&k!==void 0?k:Math.max(0,v)}if(B/=s.bE,W/=s.bE,B+=1,W+=1,l.z<=0)return Aa.fromAabb([-W,-W,-W],[W,W,W]);if(l.z===1)return Aa.fromAabb([l.x===0?-W:0,l.y===0?0:-W,-W],[l.x===0?0:W,l.y===0?W:0,W]);{const Z=[Go(0,0,l.x,l.y,l.z),Go(s.a5,0,l.x,l.y,l.z),Go(s.a5,s.a5,l.x,l.y,l.z),Go(0,s.a5,l.x,l.y,l.z)],J=[];for(const Pt of Z)J.push(s.a$([],Pt,W));if(W!==B)for(const Pt of Z)J.push(s.a$([],Pt,B));l.y===0&&J.push([0,1,0]),l.y===(1<<l.z)-1&&J.push([0,-1,0]);const ue=[1,1,1],le=[-1,-1,-1];for(const Pt of J)for(let It=0;It<3;It++)ue[It]=Math.min(ue[It],Pt[It]),le[It]=Math.max(le[It],Pt[It]);const _e=Go(s.a5/2,s.a5/2,l.x,l.y,l.z),Ee=s.b4([],[0,1,0],_e);s.b3(Ee,Ee);const ze=s.b4([],_e,Ee);s.b3(ze,ze);const $e=s.b4([],Z[2],Z[1]);s.b3($e,$e);const Ne=s.b4([],Z[0],Z[3]);s.b3(Ne,Ne),J.push(s.a$([],_e,W)),l.y>=(1<<l.z)/2&&J.push(s.a$([],Go(s.a5/2,0,l.x,l.y,l.z),W)),l.y<(1<<l.z)/2&&J.push(s.a$([],Go(s.a5/2,s.a5,l.x,l.y,l.z),W));const Ze=Pa(_e,J),rt=Pa(ze,J),We=[-_e[0],-_e[1],-_e[2],Ze.max],it=[_e[0],_e[1],_e[2],-Ze.min],lt=[-ze[0],-ze[1],-ze[2],rt.max],Qe=[ze[0],ze[1],ze[2],-rt.min],_t=[...$e,0],Dt=[...Ne,0],At=[];return l.y===0?At.push(s.bD(Dt,_t,We),s.bD(Dt,_t,it)):At.push(s.bD(lt,_t,We),s.bD(lt,_t,it),s.bD(lt,Dt,We),s.bD(lt,Dt,it)),l.y===(1<<l.z)-1?At.push(s.bD(Dt,_t,We),s.bD(Dt,_t,it)):At.push(s.bD(Qe,_t,We),s.bD(Qe,_t,it),s.bD(Qe,Dt,We),s.bD(Qe,Dt,it)),new Aa(At,[We,it,lt,Qe,_t,Dt],ue,le)}}}function Pa(A,l){let f=1/0,v=-1/0;for(const w of l){const I=s.b5(A,w);f=Math.min(f,I),v=Math.max(v,I)}return{min:f,max:v}}class yl{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(l){this._helper.setMinZoom(l)}setMaxZoom(l){this._helper.setMaxZoom(l)}setMinPitch(l){this._helper.setMinPitch(l)}setMaxPitch(l){this._helper.setMaxPitch(l)}setRenderWorldCopies(l){this._helper.setRenderWorldCopies(l)}setBearing(l){this._helper.setBearing(l)}setPitch(l){this._helper.setPitch(l)}setRoll(l){this._helper.setRoll(l)}setFov(l){this._helper.setFov(l)}setZoom(l){this._helper.setZoom(l)}setCenter(l){this._helper.setCenter(l)}setElevation(l){this._helper.setElevation(l)}setMinElevationForCurrentTile(l){this._helper.setMinElevationForCurrentTile(l)}setPadding(l){this._helper.setPadding(l)}interpolatePadding(l,f,v){return this._helper.interpolatePadding(l,f,v)}isPaddingEqual(l){return this._helper.isPaddingEqual(l)}resize(l,f){this._helper.resize(l,f)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(l){this._helper.setMaxBounds(l)}setConstrainOverride(l){this._helper.setConstrainOverride(l)}overrideNearFarZ(l,f){this._helper.overrideNearFarZ(l,f)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(l){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),l)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(l){}constructor(l){this._cachedClippingPlane=s.bF(),this._projectionMatrix=s.bj(),this._globeViewProjMatrix32f=s.bi(),this._globeViewProjMatrixNoCorrection=s.bj(),this._globeViewProjMatrixNoCorrectionInverted=s.bj(),this._globeProjMatrixInverted=s.bj(),this._cameraPosition=s.bz(),this._globeLatitudeErrorCorrectionRadians=0,this.defaultConstrain=(f,v)=>{const w=s.an(f.lat,-s.ao,s.ao),I=s.an(+v,this.minZoom+br(0,w),this.maxZoom);return{center:new s.V(f.lng,w),zoom:I}},this.applyConstrain=(f,v)=>this._helper.applyConstrain(f,v),this._helper=new Xl({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(f,v)=>this.defaultConstrain(f,v)},l),this._coveringTilesDetailsProvider=new Uh}clone(){const l=new yl;return l.apply(this),l}apply(l,f){this._globeLatitudeErrorCorrectionRadians=f||0,this._helper.apply(l)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const l=s.bz();return l[0]=this._cameraPosition[0],l[1]=this._cameraPosition[1],l[2]=this._cameraPosition[2],l}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(l){const{overscaledTileID:f,applyGlobeMatrix:v}=l,w=this._helper.getMercatorTileCoordinates(f);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:w,clippingPlane:this._cachedClippingPlane,projectionTransition:v?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(l){const f=this.pitchInRadians,v=this.cameraToCenterDistance/l,w=Math.sin(f)*v,I=Math.cos(f)*v+1,k=1/Math.sqrt(w*w+I*I)*1;let B=-w,W=I;const Z=Math.sqrt(B*B+W*W);B/=Z,W/=Z;const J=[0,B,W];s.bG(J,J,[0,0,0],-this.bearingInRadians),s.bH(J,J,[0,0,0],-1*this.center.lat*Math.PI/180),s.bI(J,J,[0,0,0],this.center.lng*Math.PI/180);const ue=1/s.b7(J);return s.a$(J,J,ue),[...J,-k*ue]}isLocationOccluded(l){return!this.isSurfacePointVisible(sr(l))}transformLightDirection(l){const f=this._helper._center.lng*Math.PI/180,v=this._helper._center.lat*Math.PI/180,w=Math.cos(v),I=[Math.sin(f)*w,Math.sin(v),Math.cos(f)*w],k=[I[2],0,-I[0]],B=[0,0,0];s.b4(B,k,I),s.b3(k,k),s.b3(B,B);const W=[0,0,0];return s.b3(W,[k[0]*l[0]+B[0]*l[1]+I[0]*l[2],k[1]*l[0]+B[1]*l[1]+I[1]*l[2],k[2]*l[0]+B[2]*l[1]+I[2]*l[2]]),W}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(l,f,v){const w=(function(B,W,Z){const J=1/(1<<Z.z);return new s.a9(B/s.a5*J+Z.x*J,W/s.a5*J+Z.y*J)})(l,f,v.canonical),I=(k=w.y,[s.by(w.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-k*Math.PI*2))-.5*Math.PI]);var k;return this.getCircleRadiusCorrection()/Math.cos(I[1])}projectTileCoordinates(l,f,v,w){const I=v.canonical,k=Go(l,f,I.x,I.y,I.z),B=1+(w?w(l,f):0)/s.bE,W=[k[0]*B,k[1]*B,k[2]*B,1];s.aH(W,W,this._globeViewProjMatrixNoCorrection);const Z=this._cachedClippingPlane,J=Z[0]*k[0]+Z[1]*k[1]+Z[2]*k[2]+Z[3]<0;return{point:new s.P(W[0]/W[3],W[1]/W[3]),signedDistanceFromCamera:W[3],isOccluded:J}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const l=ec(this.worldSize,this.center.lat),f=s.bk(),v=s.bk();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*l),s.be(f,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const w=this.centerOffset;f[8]=2*-w.x/this._helper._width,f[9]=2*w.y/this._helper._height,this._projectionMatrix=s.bf(f),this._globeProjMatrixInverted=s.bk(),s.aB(this._globeProjMatrixInverted,f),s.O(f,f,[0,0,-this.cameraToCenterDistance]),s.bg(f,f,this.rollInRadians),s.bh(f,f,-this.pitchInRadians),s.bg(f,f,this.bearingInRadians),s.O(f,f,[0,0,-l]);const I=s.bz();I[0]=l,I[1]=l,I[2]=l,s.bh(v,f,this.center.lat*Math.PI/180),s.bJ(v,v,-this.center.lng*Math.PI/180),s.Q(v,v,I),this._globeViewProjMatrixNoCorrection=v,s.bh(f,f,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),s.bJ(f,f,-this.center.lng*Math.PI/180),s.Q(f,f,I),this._globeViewProjMatrix32f=new Float32Array(f),this._globeViewProjMatrixNoCorrectionInverted=s.bk(),s.aB(this._globeViewProjMatrixNoCorrectionInverted,v);const k=s.bz();this._cameraPosition=s.bz(),this._cameraPosition[2]=this.cameraToCenterDistance/l,s.bG(this._cameraPosition,this._cameraPosition,k,-this.rollInRadians),s.bH(this._cameraPosition,this._cameraPosition,k,this.pitchInRadians),s.bG(this._cameraPosition,this._cameraPosition,k,-this.bearingInRadians),s.b0(this._cameraPosition,this._cameraPosition,[0,0,1]),s.bH(this._cameraPosition,this._cameraPosition,k,-this.center.lat*Math.PI/180),s.bI(this._cameraPosition,this._cameraPosition,k,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(l);const B=s.bf(this._globeViewProjMatrixNoCorrectionInverted);s.Q(B,B,[1,1,-1]),this._cachedFrustum=Ts.fromInvProjectionMatrix(B,1,0,this._cachedClippingPlane,!0)}calculateFogMatrix(l){s.w("calculateFogMatrix is not supported on globe projection.");const f=s.bk();return s.ar(f),f}getVisibleUnwrappedCoordinates(l){return[new s.bc(0,l)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(l){l&&s.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(l,f){if(!this._globeViewProjMatrixNoCorrection)return 1;const v=sr(l);s.a$(v,v,1+f/s.bE);const w=s.bF();return s.aH(w,[v[0],v[1],v[2],1],this._globeViewProjMatrixNoCorrection),w[2]/w[3]}populateCache(l){}getBounds(){const l=.5*this.width,f=.5*this.height,v=[new s.P(0,0),new s.P(l,0),new s.P(this.width,0),new s.P(this.width,f),new s.P(this.width,this.height),new s.P(l,this.height),new s.P(0,this.height),new s.P(0,f)],w=[];for(const ue of v)w.push(this.unprojectScreenPoint(ue));let I=0,k=0,B=0,W=0;const Z=this.center;for(const ue of w){const le=s.bK(Z.lng,ue.lng),_e=s.bK(Z.lat,ue.lat);le<k&&(k=le),le>I&&(I=le),_e<W&&(W=_e),_e>B&&(B=_e)}const J=[Z.lng+k,Z.lat+W,Z.lng+I,Z.lat+B];return this.isSurfacePointOnScreen([0,1,0])&&(J[3]=90,J[0]=-180,J[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(J[1]=-90,J[0]=-180,J[2]=180),new Ce(J)}calculateCenterFromCameraLngLatAlt(l,f,v,w){return this._helper.calculateCenterFromCameraLngLatAlt(l,f,v,w)}setLocationAtPoint(l,f){const v=sr(this.unprojectScreenPoint(f)),w=sr(l),I=s.bz();s.bL(I);const k=s.bz();s.bI(k,v,I,-this.center.lng*Math.PI/180),s.bH(k,k,I,this.center.lat*Math.PI/180);const B=w[0]*w[0]+w[2]*w[2],W=k[0]*k[0];if(B<W)return;const Z=Math.sqrt(B-W),J=-Z,ue=s.bM(w[0],w[2],k[0],Z),le=s.bM(w[0],w[2],k[0],J),_e=s.bz();s.bI(_e,w,I,-ue);const Ee=s.bM(_e[1],_e[2],k[1],k[2]),ze=s.bz();s.bI(ze,w,I,-le);const $e=s.bM(ze[1],ze[2],k[1],k[2]),Ne=.5*Math.PI,Ze=Ee>=-Ne&&Ee<=Ne,rt=$e>=-Ne&&$e<=Ne;let We,it;if(Ze&&rt){const Dt=this.center.lng*Math.PI/180,At=this.center.lat*Math.PI/180;s.bN(ue,Dt)+s.bN(Ee,At)<s.bN(le,Dt)+s.bN($e,At)?(We=ue,it=Ee):(We=le,it=$e)}else if(Ze)We=ue,it=Ee;else{if(!rt)return;We=le,it=$e}const lt=We/Math.PI*180,Qe=it/Math.PI*180,_t=this.center.lat;this.setCenter(new s.V(lt,s.an(Qe,-90,90))),this.setZoom(this.zoom+br(_t,this.center.lat))}locationToScreenPoint(l,f){const v=sr(l);if(f){const w=f.getElevationForLngLatZoom(l,this._helper._tileZoom);s.a$(v,v,1+w/s.bE)}return this._projectSurfacePointToScreen(v)}_projectSurfacePointToScreen(l){const f=s.bF();return s.aH(f,[...l,1],this._globeViewProjMatrixNoCorrection),f[0]/=f[3],f[1]/=f[3],new s.P((.5*f[0]+.5)*this.width,(.5*-f[1]+.5)*this.height)}screenPointToMercatorCoordinate(l,f){if(f){const v=f.pointCoordinate(l);if(v)return v}return s.a9.fromLngLat(this.unprojectScreenPoint(l))}screenPointToLocation(l,f){var v;return(v=this.screenPointToMercatorCoordinate(l,f))===null||v===void 0?void 0:v.toLngLat()}isPointOnMapSurface(l,f){const v=this._cameraPosition,w=this.getRayDirectionFromPixel(l);return!!this.rayPlanetIntersection(v,w)}getRayDirectionFromPixel(l){const f=s.bF();f[0]=l.x/this.width*2-1,f[1]=-1*(l.y/this.height*2-1),f[2]=1,f[3]=1,s.aH(f,f,this._globeViewProjMatrixNoCorrectionInverted),f[0]/=f[3],f[1]/=f[3],f[2]/=f[3];const v=s.bz();v[0]=f[0]-this._cameraPosition[0],v[1]=f[1]-this._cameraPosition[1],v[2]=f[2]-this._cameraPosition[2];const w=s.bz();return s.b3(w,v),w}isSurfacePointVisible(l){const f=this._cachedClippingPlane;return f[0]*l[0]+f[1]*l[1]+f[2]*l[2]+f[3]>=0}isSurfacePointOnScreen(l){if(!this.isSurfacePointVisible(l))return!1;const f=s.bF();return s.aH(f,[...l,1],this._globeViewProjMatrixNoCorrection),f[0]/=f[3],f[1]/=f[3],f[2]/=f[3],f[0]>-1&&f[0]<1&&f[1]>-1&&f[1]<1&&f[2]>-1&&f[2]<1}rayPlanetIntersection(l,f){const v=s.b5(l,f),w=s.bz(),I=s.bz();s.a$(I,f,v),s.b2(w,l,I);const k=1-s.b5(w,w);if(k<0)return null;const B=s.b5(l,l)-1,W=-v+(v<0?1:-1)*Math.sqrt(k),Z=B/W,J=W;return{tMin:Math.min(Z,J),tMax:Math.max(Z,J)}}unprojectScreenPoint(l){const f=this._cameraPosition,v=this.getRayDirectionFromPixel(l),w=this.rayPlanetIntersection(f,v);if(w){const J=s.bz();s.b0(J,f,[v[0]*w.tMin,v[1]*w.tMin,v[2]*w.tMin]);const ue=s.bz();return s.b3(ue,J),nf(ue)}const I=this._cachedClippingPlane,k=I[0]*v[0]+I[1]*v[1]+I[2]*v[2],B=-s.bb(I,f)/k,W=s.bz();if(B>0)s.b0(W,f,[v[0]*B,v[1]*B,v[2]*B]);else{const J=s.bz();s.b0(J,f,[2*v[0],2*v[1],2*v[2]]);const ue=s.bb(this._cachedClippingPlane,J);s.b2(W,J,[this._cachedClippingPlane[0]*ue,this._cachedClippingPlane[1]*ue,this._cachedClippingPlane[2]*ue])}const Z=(function(J){const ue=s.bz();return ue[0]=J[0]*-J[3],ue[1]=J[1]*-J[3],ue[2]=J[2]*-J[3],{center:ue,radius:Math.sqrt(1-J[3]*J[3])}})(I);return nf((function(J,ue,le){const _e=s.bz();s.b2(_e,le,J);const Ee=s.bz();return s.bA(Ee,J,_e,ue/s.b9(_e)),Ee})(Z.center,Z.radius,W))}getMatrixForModel(l,f){const v=s.V.convert(l),w=1/s.bE,I=s.bj();return s.bJ(I,I,v.lng/180*Math.PI),s.bh(I,I,-v.lat/180*Math.PI),s.O(I,I,[0,0,1+f/s.bE]),s.bh(I,I,.5*Math.PI),s.Q(I,I,[w,w,w]),I}getProjectionDataForCustomLayer(l=!0){const f=this.getProjectionData({overscaledTileID:new s.a2(0,0,0,0,0),applyGlobeMatrix:l});return f.tileMercatorCoords=[0,0,1,1],f}getFastPathSimpleProjectionMatrix(l){}}class bl{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(l){this._helper.setMinZoom(l)}setMaxZoom(l){this._helper.setMaxZoom(l)}setMinPitch(l){this._helper.setMinPitch(l)}setMaxPitch(l){this._helper.setMaxPitch(l)}setRenderWorldCopies(l){this._helper.setRenderWorldCopies(l)}setBearing(l){this._helper.setBearing(l)}setPitch(l){this._helper.setPitch(l)}setRoll(l){this._helper.setRoll(l)}setFov(l){this._helper.setFov(l)}setZoom(l){this._helper.setZoom(l)}setCenter(l){this._helper.setCenter(l)}setElevation(l){this._helper.setElevation(l)}setMinElevationForCurrentTile(l){this._helper.setMinElevationForCurrentTile(l)}setPadding(l){this._helper.setPadding(l)}interpolatePadding(l,f,v){return this._helper.interpolatePadding(l,f,v)}isPaddingEqual(l){return this._helper.isPaddingEqual(l)}resize(l,f,v=!0){this._helper.resize(l,f,v)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(l){this._helper.setMaxBounds(l)}setConstrainOverride(l){this._helper.setConstrainOverride(l)}overrideNearFarZ(l,f){this._helper.overrideNearFarZ(l,f)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(l){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),l)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(l,f){this._globeness=l,this._globeLatitudeErrorCorrectionRadians=f,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().prepareNextFrame(),this._mercatorTransform.getCoveringTilesDetailsProvider().prepareNextFrame()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(l){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this.defaultConstrain=(f,v)=>this.currentTransform.defaultConstrain(f,v),this.applyConstrain=(f,v)=>this._helper.applyConstrain(f,v),this._helper=new Xl({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(f,v)=>this.defaultConstrain(f,v)},l),this._globeness=1,this._mercatorTransform=new Yl,this._verticalPerspectiveTransform=new yl}clone(){const l=new bl;return l._globeness=this._globeness,l._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,l.apply(this),l}apply(l){this._helper.apply(l),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(l){const f=this._mercatorTransform.getProjectionData(l),v=this._verticalPerspectiveTransform.getProjectionData(l);return{mainMatrix:this.isGlobeRendering?v.mainMatrix:f.mainMatrix,clippingPlane:v.clippingPlane,tileMercatorCoords:v.tileMercatorCoords,projectionTransition:l.applyGlobeMatrix?this._globeness:0,fallbackMatrix:f.fallbackMatrix}}isLocationOccluded(l){return this.currentTransform.isLocationOccluded(l)}transformLightDirection(l){return this.currentTransform.transformLightDirection(l)}getPixelScale(){return s.bu(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return s.bu(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(l,f,v){const w=this._mercatorTransform.getPitchedTextCorrection(l,f,v),I=this._verticalPerspectiveTransform.getPitchedTextCorrection(l,f,v);return s.bu(w,I,this._globeness)}projectTileCoordinates(l,f,v,w){return this.currentTransform.projectTileCoordinates(l,f,v,w)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(l){return this.currentTransform.calculateFogMatrix(l)}getVisibleUnwrappedCoordinates(l){return this.currentTransform.getVisibleUnwrappedCoordinates(l)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(l){this._mercatorTransform.recalculateZoomAndCenter(l),this._verticalPerspectiveTransform.recalculateZoomAndCenter(l)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(l,f){return this.currentTransform.lngLatToCameraDepth(l,f)}populateCache(l){this._mercatorTransform.populateCache(l),this._verticalPerspectiveTransform.populateCache(l)}getBounds(){return this.currentTransform.getBounds()}calculateCenterFromCameraLngLatAlt(l,f,v,w){return this._helper.calculateCenterFromCameraLngLatAlt(l,f,v,w)}setLocationAtPoint(l,f){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(l,f),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(l,f),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(l,f){return this.currentTransform.locationToScreenPoint(l,f)}screenPointToMercatorCoordinate(l,f){return this.currentTransform.screenPointToMercatorCoordinate(l,f)}screenPointToLocation(l,f){return this.currentTransform.screenPointToLocation(l,f)}isPointOnMapSurface(l,f){return this.currentTransform.isPointOnMapSurface(l,f)}getRayDirectionFromPixel(l){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(l)}getMatrixForModel(l,f){return this.currentTransform.getMatrixForModel(l,f)}getProjectionDataForCustomLayer(l=!0){const f=this._mercatorTransform.getProjectionDataForCustomLayer(l);if(!this.isGlobeRendering)return f;const v=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(l);return v.fallbackMatrix=f.mainMatrix,v}getFastPathSimpleProjectionMatrix(l){return this.currentTransform.getFastPathSimpleProjectionMatrix(l)}}class Wr{get useGlobeControls(){return!0}handlePanInertia(l,f){const v=Bp(l,f);return Math.abs(v.lng-f.center.lng)>180&&(v.lng=f.center.lng+179.5*Math.sign(v.lng-f.center.lng)),{easingCenter:v,easingOffset:new s.P(0,0)}}handleMapControlsRollPitchBearingZoom(l,f){const v=l.around,w=f.screenPointToLocation(v);l.bearingDelta&&f.setBearing(f.bearing+l.bearingDelta),l.pitchDelta&&f.setPitch(f.pitch+l.pitchDelta),l.rollDelta&&f.setRoll(f.roll+l.rollDelta);const I=f.zoom;l.zoomDelta&&f.setZoom(f.zoom+l.zoomDelta);const k=f.zoom-I;if(k===0)return;const B=s.bK(f.center.lng,w.lng),W=B/(Math.abs(B/180)+1),Z=s.bK(f.center.lat,w.lat),J=f.getRayDirectionFromPixel(v),ue=f.cameraPosition,le=-1*s.b5(ue,J),_e=s.bz();s.b0(_e,ue,[J[0]*le,J[1]*le,J[2]*le]);const Ee=s.b7(_e)-1,ze=Math.exp(.5*-Math.max(Ee-.3,0)),$e=ec(f.worldSize,f.center.lat)/Math.min(f.width,f.height),Ne=s.bx($e,.9,.5,1,.25),Ze=(1-s.aq(-k))*Math.min(ze,Ne),rt=f.center.lat,We=f.zoom,it=new s.V(f.center.lng+W*Ze,s.an(f.center.lat+Z*Ze,-s.ao,s.ao));f.setLocationAtPoint(w,v);const lt=f.center,Qe=s.bx(Math.abs(B),45,85,0,1),_t=s.bx($e,.75,.35,0,1),Dt=Math.pow(Math.max(Qe,_t),.25),At=s.bK(lt.lng,it.lng),Pt=s.bK(lt.lat,it.lat);f.setCenter(new s.V(lt.lng+At*Dt,lt.lat+Pt*Dt).wrap()),f.setZoom(We+br(rt,f.center.lat))}handleMapControlsPan(l,f,v){if(!l.panDelta)return;const w=f.center.lat,I=f.zoom;f.setCenter(Bp(l.panDelta,f).wrap()),f.setZoom(I+br(w,f.center.lat))}cameraForBoxAndBearing(l,f,v,w,I){const k=jo(l,f,v,w,I),B=f.left/I.width*2-1,W=(I.width-f.right)/I.width*2-1,Z=f.top/I.height*-2+1,J=(I.height-f.bottom)/I.height*-2+1,ue=s.bK(v.getWest(),v.getEast())<0,le=ue?v.getEast():v.getWest(),_e=ue?v.getWest():v.getEast(),Ee=Math.max(v.getNorth(),v.getSouth()),ze=Math.min(v.getNorth(),v.getSouth()),$e=le+.5*s.bK(le,_e),Ne=Ee+.5*s.bK(Ee,ze),Ze=I.clone();Ze.setCenter(k.center),Ze.setBearing(k.bearing),Ze.setPitch(0),Ze.setRoll(0),Ze.setZoom(k.zoom);const rt=Ze.modelViewProjectionMatrix,We=[sr(v.getNorthWest()),sr(v.getNorthEast()),sr(v.getSouthWest()),sr(v.getSouthEast()),sr(new s.V(_e,Ne)),sr(new s.V(le,Ne)),sr(new s.V($e,Ee)),sr(new s.V($e,ze))],it=sr(k.center);let lt=Number.POSITIVE_INFINITY;for(const Qe of We)B<0&&(lt=Wr.getLesserNonNegativeNonNull(lt,Wr.solveVectorScale(Qe,it,rt,"x",B))),W>0&&(lt=Wr.getLesserNonNegativeNonNull(lt,Wr.solveVectorScale(Qe,it,rt,"x",W))),Z>0&&(lt=Wr.getLesserNonNegativeNonNull(lt,Wr.solveVectorScale(Qe,it,rt,"y",Z))),J<0&&(lt=Wr.getLesserNonNegativeNonNull(lt,Wr.solveVectorScale(Qe,it,rt,"y",J)));if(Number.isFinite(lt)&&lt!==0)return k.zoom=Ze.zoom+s.at(lt),k;Ca()}handleJumpToCenterZoom(l,f){const v=l.center.lat,w=l.applyConstrain(f.center?s.V.convert(f.center):l.center,l.zoom).center;l.setCenter(w.wrap());const I=f.zoom!==void 0?+f.zoom:l.zoom+br(v,w.lat);l.zoom!==I&&l.setZoom(I)}handleEaseTo(l,f){const v=l.zoom,w=l.center,I=l.padding,k={roll:l.roll,pitch:l.pitch,bearing:l.bearing},B={roll:f.roll===void 0?l.roll:f.roll,pitch:f.pitch===void 0?l.pitch:f.pitch,bearing:f.bearing===void 0?l.bearing:f.bearing},W=f.zoom!==void 0,Z=!l.isPaddingEqual(f.padding);let J=!1;const ue=f.center?s.V.convert(f.center):w,le=l.applyConstrain(ue,v).center;gl(l,le);const _e=l.clone();_e.setCenter(le),_e.setZoom(W?+f.zoom:v+br(w.lat,ue.lat)),_e.setBearing(f.bearing);const Ee=new s.P(s.an(l.centerPoint.x+f.offsetAsPoint.x,0,l.width),s.an(l.centerPoint.y+f.offsetAsPoint.y,0,l.height));_e.setLocationAtPoint(le,Ee);const ze=(f.offset&&f.offsetAsPoint.mag())>0?_e.center:le,$e=W?+f.zoom:v+br(w.lat,ze.lat),Ne=v+br(w.lat,0),Ze=$e+br(ze.lat,0),rt=s.bK(w.lng,ze.lng),We=s.bK(w.lat,ze.lat),it=s.aq(Ze-Ne);return J=$e!==v,{easeFunc:lt=>{if(s.bo(k,B)||_l({startEulerAngles:k,endEulerAngles:B,tr:l,k:lt,useSlerp:k.roll!=B.roll}),Z&&l.interpolatePadding(I,f.padding,lt),f.around)s.w("Easing around a point is not supported under globe projection."),l.setLocationAtPoint(f.around,f.aroundPoint);else{const Qe=Ze>Ne?Math.min(2,it):Math.max(.5,it),_t=Math.pow(Qe,1-lt),Dt=Np(w,rt,We,lt*_t);l.setCenter(Dt.wrap())}if(J){const Qe=s.G.number(Ne,Ze,lt)+br(0,l.center.lat);l.setZoom(Qe)}},isZooming:J,elevationCenter:ze}}handleFlyTo(l,f){const v=f.zoom!==void 0,w=l.center,I=l.zoom,k=l.padding,B=!l.isPaddingEqual(f.padding),W=l.applyConstrain(s.V.convert(f.center||f.locationAtOffset),I).center,Z=v?+f.zoom:l.zoom+br(l.center.lat,W.lat),J=l.clone();J.setCenter(W),J.setZoom(Z),J.setBearing(f.bearing);const ue=new s.P(s.an(l.centerPoint.x+f.offsetAsPoint.x,0,l.width),s.an(l.centerPoint.y+f.offsetAsPoint.y,0,l.height));J.setLocationAtPoint(W,ue);const le=J.center;gl(l,le);const _e=(function(We,it,lt){const Qe=sr(it),_t=sr(lt),Dt=s.b5(Qe,_t),At=Math.acos(Dt),Pt=yr(We);return At/(2*Math.PI)*Pt})(l,w,le),Ee=I+br(w.lat,0),ze=Z+br(le.lat,0),$e=s.aq(ze-Ee);let Ne;if(typeof f.minZoom=="number"){const We=+f.minZoom+br(le.lat,0),it=Math.min(We,Ee,ze)+br(0,le.lat),lt=l.applyConstrain(le,it).zoom+br(le.lat,0);Ne=s.aq(lt-Ee)}const Ze=s.bK(w.lng,le.lng),rt=s.bK(w.lat,le.lat);return{easeFunc:(We,it,lt,Qe)=>{const _t=Np(w,Ze,rt,lt);B&&l.interpolatePadding(k,f.padding,We);const Dt=We===1?le:_t;l.setCenter(Dt.wrap());const At=Ee+s.at(it);l.setZoom(We===1?Z:At+br(0,Dt.lat))},scaleOfZoom:$e,targetCenter:le,scaleOfMinZoom:Ne,pixelPathLength:_e}}static solveVectorScale(l,f,v,w,I){const k=w==="x"?[v[0],v[4],v[8],v[12]]:[v[1],v[5],v[9],v[13]],B=[v[3],v[7],v[11],v[15]],W=l[0]*k[0]+l[1]*k[1]+l[2]*k[2],Z=l[0]*B[0]+l[1]*B[1]+l[2]*B[2],J=f[0]*k[0]+f[1]*k[1]+f[2]*k[2],ue=f[0]*B[0]+f[1]*B[1]+f[2]*B[2];return J+I*Z===W+I*ue||B[3]*(W-J)+k[3]*(ue-Z)+W*ue==J*Z?null:(J+k[3]-I*ue-I*B[3])/(J-W-I*ue+I*Z)}static getLesserNonNegativeNonNull(l,f){return f!==null&&f>=0&&f<l?f:l}}class $p{constructor(l){this._globe=l,this._mercatorCameraHelper=new vl,this._verticalPerspectiveCameraHelper=new Wr}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(l,f){return this.currentHelper.handlePanInertia(l,f)}handleMapControlsRollPitchBearingZoom(l,f){return this.currentHelper.handleMapControlsRollPitchBearingZoom(l,f)}handleMapControlsPan(l,f,v){this.currentHelper.handleMapControlsPan(l,f,v)}cameraForBoxAndBearing(l,f,v,w,I){return this.currentHelper.cameraForBoxAndBearing(l,f,v,w,I)}handleJumpToCenterZoom(l,f){this.currentHelper.handleJumpToCenterZoom(l,f)}handleEaseTo(l,f){return this.currentHelper.handleEaseTo(l,f)}handleFlyTo(l,f){return this.currentHelper.handleFlyTo(l,f)}}const zc=(A,l)=>s.B(A,l&&l.filter((f=>f.identifier!=="source.canvas"))),qo=s.bO();class ic extends s.E{constructor(l,f={}){var v,w;super(),this._rtlPluginLoaded=()=>{for(const k in this.tileManagers){const B=this.tileManagers[k].getSource().type;B!=="vector"&&B!=="geojson"||this.tileManagers[k].reload()}},this.map=l,this.dispatcher=new yt(ct(),l._getMapId()),this.dispatcher.registerMessageHandler("GG",((k,B)=>this.getGlyphs(k,B))),this.dispatcher.registerMessageHandler("GI",((k,B)=>this.getImages(k,B))),this.dispatcher.registerMessageHandler("GDA",((k,B)=>this.getDashes(k,B))),this.imageManager=new Q,this.imageManager.setEventedParent(this);const I=((v=l._container)===null||v===void 0?void 0:v.lang)||typeof document<"u"&&((w=document.documentElement)===null||w===void 0?void 0:w.lang)||void 0;this.glyphManager=new ce(l._requestManager,f.localIdeographFontFamily,I),this.lineAtlas=new Ue(256,512),this.crossTileSymbolIndex=new Ns,this._setInitialValues(),this._resetUpdates(),this.dispatcher.broadcast("SR",s.bP()),pt().on(Re,this._rtlPluginLoaded),this.on("data",(k=>{if(k.dataType!=="source"||k.sourceDataType!=="metadata")return;const B=this.tileManagers[k.sourceId];if(!B)return;const W=B.getSource();if(W&&W.vectorLayerIds)for(const Z in this._layers){const J=this._layers[Z];J.source===W.id&&this._validateLayer(J)}}))}_setInitialValues(){var l;this._spritesImagesIds={},this._layers={},this._order=[],this.tileManagers={},this.zoomHistory=new s.bQ,this._availableImages=[],this._globalState={},this._serializedLayers={},this.stylesheet=null,this.light=null,this.sky=null,this.projection&&(this.projection.destroy(),delete this.projection),this._loaded=!1,this._changed=!1,this._updatedLayers={},this._updatedSources={},this._changedImages={},this._glyphsDidChange=!1,this._updatedPaintProps={},this._layerOrderChanged=!1,this.crossTileSymbolIndex=new(((l=this.crossTileSymbolIndex)===null||l===void 0?void 0:l.constructor)||Object),this.pauseablePlacement=void 0,this.placement=void 0,this.z=0}setGlobalStateProperty(l,f){var v,w,I;this._checkLoaded();const k=f===null?(I=(w=(v=this.stylesheet.state)===null||v===void 0?void 0:v[l])===null||w===void 0?void 0:w.default)!==null&&I!==void 0?I:null:f;if(s.bR(k,this._globalState[l]))return this;this._globalState[l]=k,this._applyGlobalStateChanges([l])}getGlobalState(){return this._globalState}setGlobalState(l){this._checkLoaded();const f=[];for(const v in l)!s.bR(this._globalState[v],l[v].default)&&(f.push(v),this._globalState[v]=l[v].default);this._applyGlobalStateChanges(f)}_applyGlobalStateChanges(l){if(l.length===0)return;const f=new Set,v={};for(const w of l){v[w]=this._globalState[w];for(const I in this._layers){const k=this._layers[I],B=k.getLayoutAffectingGlobalStateRefs(),W=k.getPaintAffectingGlobalStateRefs(),Z=k.getVisibilityAffectingGlobalStateRefs();if(B.has(w)&&f.add(k.source),W.has(w))for(const{name:J,value:ue}of W.get(w))this._updatePaintProperty(k,J,ue);Z?.has(w)&&(k.recalculateVisibility(),this._updateLayer(k))}}this.dispatcher.broadcast("UGS",v);for(const w in this.tileManagers)f.has(w)&&(this._reloadSource(w),this._changed=!0)}loadURL(l,f={},v){this.fire(new s.l("dataloading",{dataType:"style"})),f.validate=typeof f.validate!="boolean"||f.validate;const w=this.map._requestManager.transformRequest(l,"Style");this._loadStyleRequest=new AbortController;const I=this._loadStyleRequest;s.j(w,this._loadStyleRequest).then((k=>{this._loadStyleRequest=null,this._load(k.data,f,v)})).catch((k=>{this._loadStyleRequest=null,k&&!I.signal.aborted&&this.fire(new s.k(k))}))}loadJSON(l,f={},v){this.fire(new s.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,b.frameAsync(this._frameRequest).then((()=>{this._frameRequest=null,f.validate=f.validate!==!1,this._load(l,f,v)})).catch((()=>{}))}loadEmpty(){this.fire(new s.l("dataloading",{dataType:"style"})),this._load(qo,{validate:!1})}_load(l,f,v){var w,I;let k=f.transformStyle?f.transformStyle(v,l):l;if(!f.validate||!zc(this,s.C(k))){k=Object.assign({},k),this._loaded=!0,this.stylesheet=k;for(const B in k.sources)this.addSource(B,k.sources[B],{validate:!1});k.sprite?this._loadSprite(k.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(k.glyphs),this._createLayers(),this.light=new je(this.stylesheet.light),this._setProjectionInternal(((w=this.stylesheet.projection)===null||w===void 0?void 0:w.type)||"mercator"),this.sky=new qe(this.stylesheet.sky),this.map.setTerrain((I=this.stylesheet.terrain)!==null&&I!==void 0?I:null),this.fire(new s.l("data",{dataType:"style"})),this.fire(new s.l("style.load"))}}_createLayers(){var l,f,v;const w=s.bS(this.stylesheet.layers);this.setGlobalState((l=this.stylesheet.state)!==null&&l!==void 0?l:null),this.dispatcher.broadcast("SL",w),this._order=w.map((I=>I.id)),this._layers={},this._serializedLayers=null;for(const I of w){const k=s.bT(I,this._globalState);if(k.setEventedParent(this,{layer:{id:I.id}}),this._layers[I.id]=k,s.bU(k)&&this.tileManagers[k.source]){const B=(v=(f=I.paint)===null||f===void 0?void 0:f["raster-fade-duration"])!==null&&v!==void 0?v:k.paint.get("raster-fade-duration");this.tileManagers[k.source].setRasterFadeDuration(B)}}}_loadSprite(l,f=!1,v=void 0){this.imageManager.setLoaded(!1);const w=new AbortController;let I;this._spriteRequest=w,(function(k,B,W,Z){return s._(this,void 0,void 0,(function*(){const J=V(k),ue=W>1?"@2x":"",le={},_e={};for(const{id:Ee,url:ze}of J){const $e=B.transformRequest(q(ze,ue,".json"),"SpriteJSON");le[Ee]=s.j($e,Z);const Ne=B.transformRequest(q(ze,ue,".png"),"SpriteImage");_e[Ee]=G.getImage(Ne,Z)}return yield Promise.all([...Object.values(le),...Object.values(_e)]),(function(Ee,ze){return s._(this,void 0,void 0,(function*(){const $e={};for(const Ne in Ee){$e[Ne]={};const Ze=b.getImageCanvasContext((yield ze[Ne]).data),rt=(yield Ee[Ne]).data;for(const We in rt){const{width:it,height:lt,x:Qe,y:_t,sdf:Dt,pixelRatio:At,stretchX:Pt,stretchY:It,content:Qt,textFitWidth:ti,textFitHeight:Xt}=rt[We];$e[Ne][We]={data:null,pixelRatio:At,sdf:Dt,stretchX:Pt,stretchY:It,content:Qt,textFitWidth:ti,textFitHeight:Xt,spriteData:{width:it,height:lt,x:Qe,y:_t,context:Ze}}}}return $e}))})(le,_e)}))})(l,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then((k=>{if(this._spriteRequest=null,k)for(const B in k){this._spritesImagesIds[B]=[];const W=this._spritesImagesIds[B]?this._spritesImagesIds[B].filter((Z=>!(Z in k))):[];for(const Z of W)this.imageManager.removeImage(Z),this._changedImages[Z]=!0;for(const Z in k[B]){const J=B==="default"?Z:`${B}:${Z}`;this._spritesImagesIds[B].push(J),J in this.imageManager.images?this.imageManager.updateImage(J,k[B][Z],!1):this.imageManager.addImage(J,k[B][Z]),f&&(this._changedImages[J]=!0)}}})).catch((k=>{this._spriteRequest=null,I=k,w.signal.aborted||this.fire(new s.k(I))})).finally((()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),f&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.l("data",{dataType:"style"})),v&&v(I)}))}_unloadSprite(){for(const l of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(l),this._changedImages[l]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.l("data",{dataType:"style"}))}_validateLayer(l){const f=this.tileManagers[l.source];if(!f)return;const v=l.sourceLayer;if(!v)return;const w=f.getSource();(w.type==="geojson"||w.vectorLayerIds&&w.vectorLayerIds.indexOf(v)===-1)&&this.fire(new s.k(new Error(`Source layer "${v}" does not exist on source "${w.id}" as specified by style layer "${l.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const l in this.tileManagers)if(!this.tileManagers[l].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(l,f=!1){const v=this._serializedAllLayers();if(!l||l.length===0)return Object.values(f?s.bV(v):v);const w=[];for(const I of l)if(v[I]){const k=f?s.bV(v[I]):v[I];w.push(k)}return w}_serializedAllLayers(){let l=this._serializedLayers;if(l)return l;l=this._serializedLayers={};const f=Object.keys(this._layers);for(const v of f){const w=this._layers[v];w.type!=="custom"&&(l[v]=w.serialize())}return l}hasTransitions(){var l,f,v;if(!((l=this.light)===null||l===void 0)&&l.hasTransition()||!((f=this.sky)===null||f===void 0)&&f.hasTransition()||!((v=this.projection)===null||v===void 0)&&v.hasTransition())return!0;for(const w in this.tileManagers)if(this.tileManagers[w].hasTransition())return!0;for(const w in this._layers)if(this._layers[w].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(l){if(!this._loaded)return;const f=this._changed;if(f){const w=Object.keys(this._updatedLayers),I=Object.keys(this._removedLayers);(w.length||I.length)&&this._updateWorkerLayers(w,I);for(const k in this._updatedSources){const B=this._updatedSources[k];if(B==="reload")this._reloadSource(k);else{if(B!=="clear")throw new Error(`Invalid action ${B}`);this._clearSource(k)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const k in this._updatedPaintProps)this._layers[k].updateTransitions(l);this.light.updateTransitions(l),this.sky.updateTransitions(l),this._resetUpdates()}const v={};for(const w in this.tileManagers){const I=this.tileManagers[w];v[w]=I.used,I.used=!1}for(const w of this._order){const I=this._layers[w];I.recalculate(l,this._availableImages),!I.isHidden(l.zoom)&&I.source&&(this.tileManagers[I.source].used=!0)}for(const w in v){const I=this.tileManagers[w];!!v[w]!=!!I.used&&I.fire(new s.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:w}))}this.light.recalculate(l),this.sky.recalculate(l),this.projection.recalculate(l),this.z=l.zoom,f&&this.fire(new s.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const l=Object.keys(this._changedImages);if(l.length){for(const f in this.tileManagers)this.tileManagers[f].reloadTilesForDependencies(["icons","patterns"],l);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const l in this.tileManagers)this.tileManagers[l].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(l,f){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(l,!1),removedIds:f})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(l,f={}){var v;this._checkLoaded();const w=this.serialize();if(l=f.transformStyle?f.transformStyle(w,l):l,((v=f.validate)===null||v===void 0||v)&&zc(this,s.C(l)))return!1;(l=s.bV(l)).layers=s.bS(l.layers);const I=s.bW(w,l),k=this._getOperationsToPerform(I);if(k.unimplemented.length>0)throw new Error(`Unimplemented: ${k.unimplemented.join(", ")}.`);if(k.operations.length===0)return!1;for(const B of k.operations)B();return this.stylesheet=l,this._serializedLayers=null,!0}_getOperationsToPerform(l){const f=[],v=[];for(const w of l)switch(w.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":f.push((()=>this.addLayer.apply(this,w.args)));break;case"removeLayer":f.push((()=>this.removeLayer.apply(this,w.args)));break;case"setPaintProperty":f.push((()=>this.setPaintProperty.apply(this,w.args)));break;case"setLayoutProperty":f.push((()=>this.setLayoutProperty.apply(this,w.args)));break;case"setFilter":f.push((()=>this.setFilter.apply(this,w.args)));break;case"addSource":f.push((()=>this.addSource.apply(this,w.args)));break;case"removeSource":f.push((()=>this.removeSource.apply(this,w.args)));break;case"setLayerZoomRange":f.push((()=>this.setLayerZoomRange.apply(this,w.args)));break;case"setLight":f.push((()=>this.setLight.apply(this,w.args)));break;case"setGeoJSONSourceData":f.push((()=>this.setGeoJSONSourceData.apply(this,w.args)));break;case"setGlyphs":f.push((()=>this.setGlyphs.apply(this,w.args)));break;case"setSprite":f.push((()=>this.setSprite.apply(this,w.args)));break;case"setTerrain":f.push((()=>this.map.setTerrain.apply(this,w.args)));break;case"setSky":f.push((()=>this.setSky.apply(this,w.args)));break;case"setProjection":this.setProjection.apply(this,w.args);break;case"setGlobalState":f.push((()=>this.setGlobalState.apply(this,w.args)));break;case"setTransition":f.push((()=>{}));break;default:v.push(w.command)}return{operations:f,unimplemented:v}}addImage(l,f){if(this.getImage(l))return this.fire(new s.k(new Error(`An image named "${l}" already exists.`)));this.imageManager.addImage(l,f),this._afterImageUpdated(l)}updateImage(l,f){this.imageManager.updateImage(l,f)}getImage(l){return this.imageManager.getImage(l)}removeImage(l){if(!this.getImage(l))return this.fire(new s.k(new Error(`An image named "${l}" does not exist.`)));this.imageManager.removeImage(l),this._afterImageUpdated(l)}_afterImageUpdated(l){this._availableImages=this.imageManager.listImages(),this._changedImages[l]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(l,f,v={}){if(this._checkLoaded(),this.tileManagers[l]!==void 0)throw new Error(`Source "${l}" already exists.`);if(!f.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(f).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(f.type)>=0&&this._validate(s.C.source,`sources.${l}`,f,null,v))return;this.map&&this.map._collectResourceTiming&&(f.collectResourceTiming=!0);const w=this.tileManagers[l]=new Ci(l,f,this.dispatcher);w.style=this,w.setEventedParent(this,(()=>({isSourceLoaded:w.loaded(),source:w.serialize(),sourceId:l}))),w.onAdd(this.map),this._changed=!0}removeSource(l){if(this._checkLoaded(),this.tileManagers[l]===void 0)throw new Error("There is no source with this ID");for(const v in this._layers)if(this._layers[v].source===l)return this.fire(new s.k(new Error(`Source "${l}" cannot be removed while layer "${v}" is using it.`)));const f=this.tileManagers[l];delete this.tileManagers[l],delete this._updatedSources[l],f.fire(new s.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:l})),f.setEventedParent(null),f.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(l,f){if(this._checkLoaded(),this.tileManagers[l]===void 0)throw new Error(`There is no source with this ID=${l}`);const v=this.tileManagers[l].getSource();if(v.type!=="geojson")throw new Error(`geojsonSource.type is ${v.type}, which is !== 'geojson`);v.setData(f),this._changed=!0}getSource(l){return this.tileManagers[l]&&this.tileManagers[l].getSource()}addLayer(l,f,v={}){this._checkLoaded();const w=l.id;if(this.getLayer(w))return void this.fire(new s.k(new Error(`Layer "${w}" already exists on this map.`)));let I;if(l.type==="custom"){if(zc(this,s.bX(l)))return;I=s.bT(l,this._globalState)}else{if("source"in l&&typeof l.source=="object"&&(this.addSource(w,l.source),l=s.bV(l),l=s.e(l,{source:w})),this._validate(s.C.layer,`layers.${w}`,l,{arrayIndex:-1},v))return;I=s.bT(l,this._globalState),this._validateLayer(I),I.setEventedParent(this,{layer:{id:w}})}const k=f?this._order.indexOf(f):this._order.length;if(f&&k===-1)this.fire(new s.k(new Error(`Cannot add layer "${w}" before non-existing layer "${f}".`)));else{if(this._order.splice(k,0,w),this._layerOrderChanged=!0,this._layers[w]=I,this._removedLayers[w]&&I.source&&I.type!=="custom"){const B=this._removedLayers[w];delete this._removedLayers[w],B.type!==I.type?this._updatedSources[I.source]="clear":(this._updatedSources[I.source]="reload",this.tileManagers[I.source].pause())}this._updateLayer(I),I.onAdd&&I.onAdd(this.map)}}moveLayer(l,f){if(this._checkLoaded(),this._changed=!0,!this._layers[l])return void this.fire(new s.k(new Error(`The layer '${l}' does not exist in the map's style and cannot be moved.`)));if(l===f)return;const v=this._order.indexOf(l);this._order.splice(v,1);const w=f?this._order.indexOf(f):this._order.length;f&&w===-1?this.fire(new s.k(new Error(`Cannot move layer "${l}" before non-existing layer "${f}".`))):(this._order.splice(w,0,l),this._layerOrderChanged=!0)}removeLayer(l){this._checkLoaded();const f=this._layers[l];if(!f)return void this.fire(new s.k(new Error(`Cannot remove non-existing layer "${l}".`)));f.setEventedParent(null);const v=this._order.indexOf(l);this._order.splice(v,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[l]=f,delete this._layers[l],this._serializedLayers&&delete this._serializedLayers[l],delete this._updatedLayers[l],delete this._updatedPaintProps[l],f.onRemove&&f.onRemove(this.map)}getLayer(l){return this._layers[l]}getLayersOrder(){return[...this._order]}hasLayer(l){return l in this._layers}setLayerZoomRange(l,f,v){this._checkLoaded();const w=this.getLayer(l);w?w.minzoom===f&&w.maxzoom===v||(f!=null&&(w.minzoom=f),v!=null&&(w.maxzoom=v),this._updateLayer(w)):this.fire(new s.k(new Error(`Cannot set the zoom range of non-existing layer "${l}".`)))}setFilter(l,f,v={}){this._checkLoaded();const w=this.getLayer(l);if(w){if(!s.bR(w.filter,f))return f==null?(w.setFilter(void 0),void this._updateLayer(w)):void(this._validate(s.C.filter,`layers.${w.id}.filter`,f,null,v)||(w.setFilter(s.bV(f)),this._updateLayer(w)))}else this.fire(new s.k(new Error(`Cannot filter non-existing layer "${l}".`)))}getFilter(l){return s.bV(this.getLayer(l).filter)}setLayoutProperty(l,f,v,w={}){this._checkLoaded();const I=this.getLayer(l);I?s.bR(I.getLayoutProperty(f),v)||(I.setLayoutProperty(f,v,w),this._updateLayer(I)):this.fire(new s.k(new Error(`Cannot style non-existing layer "${l}".`)))}getLayoutProperty(l,f){const v=this.getLayer(l);if(v)return v.getLayoutProperty(f);this.fire(new s.k(new Error(`Cannot get style of non-existing layer "${l}".`)))}setPaintProperty(l,f,v,w={}){this._checkLoaded();const I=this.getLayer(l);I?s.bR(I.getPaintProperty(f),v)||this._updatePaintProperty(I,f,v,w):this.fire(new s.k(new Error(`Cannot style non-existing layer "${l}".`)))}_updatePaintProperty(l,f,v,w={}){l.setPaintProperty(f,v,w)&&this._updateLayer(l),s.bU(l)&&f==="raster-fade-duration"&&this.tileManagers[l.source].setRasterFadeDuration(v),this._changed=!0,this._updatedPaintProps[l.id]=!0,this._serializedLayers=null}getPaintProperty(l,f){return this.getLayer(l).getPaintProperty(f)}setFeatureState(l,f){this._checkLoaded();const v=l.source,w=l.sourceLayer,I=this.tileManagers[v];if(I===void 0)return void this.fire(new s.k(new Error(`The source '${v}' does not exist in the map's style.`)));const k=I.getSource().type;k==="geojson"&&w?this.fire(new s.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):k!=="vector"||w?(l.id===void 0&&this.fire(new s.k(new Error("The feature id parameter must be provided."))),I.setFeatureState(w,l.id,f)):this.fire(new s.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(l,f){this._checkLoaded();const v=l.source,w=this.tileManagers[v];if(w===void 0)return void this.fire(new s.k(new Error(`The source '${v}' does not exist in the map's style.`)));const I=w.getSource().type,k=I==="vector"?l.sourceLayer:void 0;I!=="vector"||k?f&&typeof l.id!="string"&&typeof l.id!="number"?this.fire(new s.k(new Error("A feature id is required to remove its specific state property."))):w.removeFeatureState(k,l.id,f):this.fire(new s.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(l){this._checkLoaded();const f=l.source,v=l.sourceLayer,w=this.tileManagers[f];if(w!==void 0)return w.getSource().type!=="vector"||v?(l.id===void 0&&this.fire(new s.k(new Error("The feature id parameter must be provided."))),w.getFeatureState(v,l.id)):void this.fire(new s.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new s.k(new Error(`The source '${f}' does not exist in the map's style.`)))}getTransition(){return s.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const l=s.bY(this.tileManagers,(I=>I.serialize())),f=this._serializeByIds(this._order,!0),v=this.map.getTerrain()||void 0,w=this.stylesheet;return s.bZ({version:w.version,name:w.name,metadata:w.metadata,light:w.light,sky:w.sky,center:w.center,zoom:w.zoom,bearing:w.bearing,pitch:w.pitch,sprite:w.sprite,glyphs:w.glyphs,transition:w.transition,projection:w.projection,sources:l,layers:f,terrain:v},(I=>I!==void 0))}_updateLayer(l){this._updatedLayers[l.id]=!0,l.source&&!this._updatedSources[l.source]&&this.tileManagers[l.source].getSource().type!=="raster"&&(this._updatedSources[l.source]="reload",this.tileManagers[l.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(l){const f=k=>this._layers[k].type==="fill-extrusion",v={},w=[];for(let k=this._order.length-1;k>=0;k--){const B=this._order[k];if(f(B)){v[B]=k;for(const W of l){const Z=W[B];if(Z)for(const J of Z)w.push(J)}}}w.sort(((k,B)=>B.intersectionZ-k.intersectionZ));const I=[];for(let k=this._order.length-1;k>=0;k--){const B=this._order[k];if(f(B))for(let W=w.length-1;W>=0;W--){const Z=w[W].feature;if(v[Z.layer.id]<k)break;I.push(Z),w.pop()}else for(const W of l){const Z=W[B];if(Z)for(const J of Z)I.push(J.feature)}}return I}queryRenderedFeatures(l,f,v){f&&f.filter&&this._validate(s.C.filter,"queryRenderedFeatures.filter",f.filter,null,f);const w={};if(f&&f.layers){if(!(Array.isArray(f.layers)||f.layers instanceof Set))return this.fire(new s.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const Z of f.layers){const J=this._layers[Z];if(!J)return this.fire(new s.k(new Error(`The layer '${Z}' does not exist in the map's style and cannot be queried for features.`))),[];w[J.source]=!0}}const I=[];f.availableImages=this._availableImages;const k=this._serializedAllLayers(),B=f.layers instanceof Set?f.layers:Array.isArray(f.layers)?new Set(f.layers):null,W=Object.assign(Object.assign({},f),{layers:B,globalState:this._globalState});for(const Z in this.tileManagers)f.layers&&!w[Z]||I.push(Ve(this.tileManagers[Z],this._layers,k,l,W,v,this.map.terrain?(J,ue,le)=>this.map.terrain.getElevation(J,ue,le):void 0));return this.placement&&I.push((function(Z,J,ue,le,_e,Ee,ze){const $e={},Ne=Ee.queryRenderedSymbols(le),Ze=[];for(const rt of Object.keys(Ne).map(Number))Ze.push(ze[rt]);Ze.sort(tt);for(const rt of Ze){const We=rt.featureIndex.lookupSymbolFeatures(Ne[rt.bucketInstanceId],J,rt.bucketIndex,rt.sourceLayerIndex,{filterSpec:_e.filter,globalState:_e.globalState},_e.layers,_e.availableImages,Z);for(const it in We){const lt=$e[it]=$e[it]||[],Qe=We[it];Qe.sort(((_t,Dt)=>{const At=rt.featureSortOrder;if(At){const Pt=At.indexOf(_t.featureIndex);return At.indexOf(Dt.featureIndex)-Pt}return Dt.featureIndex-_t.featureIndex}));for(const _t of Qe)lt.push(_t)}}return(function(rt,We,it){for(const lt in rt)for(const Qe of rt[lt])Mt(Qe,it[We[lt].source]);return rt})($e,Z,ue)})(this._layers,k,this.tileManagers,l,W,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(I)}querySourceFeatures(l,f){f?.filter&&this._validate(s.C.filter,"querySourceFeatures.filter",f.filter,null,f);const v=this.tileManagers[l];return v?(function(w,I){const k=w.getRenderableIds().map((Z=>w.getTileByID(Z))),B=[],W={};for(let Z=0;Z<k.length;Z++){const J=k[Z],ue=J.tileID.canonical.key;W[ue]||(W[ue]=!0,J.querySourceFeatures(B,I))}return B})(v,f?Object.assign(Object.assign({},f),{globalState:this._globalState}):{globalState:this._globalState}):[]}getLight(){return this.light.getLight()}setLight(l,f={}){this._checkLoaded();const v=this.light.getLight();let w=!1;for(const k in l)if(!s.bR(l[k],v[k])){w=!0;break}if(!w)return;const I={now:P(),transition:s.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(l,f),this.light.updateTransitions(I)}getProjection(){var l;return(l=this.stylesheet)===null||l===void 0?void 0:l.projection}setProjection(l){if(this._checkLoaded(),this.projection){if(this.projection.name===l.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=l,this._setProjectionInternal(l.type)}getSky(){var l;return(l=this.stylesheet)===null||l===void 0?void 0:l.sky}setSky(l,f={}){this._checkLoaded();const v=this.getSky();let w=!1;if(!l&&!v)return;if(l&&!v)w=!0;else if(!l&&v)w=!0;else for(const k in l)if(!s.bR(l[k],v[k])){w=!0;break}if(!w)return;const I={now:P(),transition:s.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=l,this.sky.setSky(l,f),this.sky.updateTransitions(I)}_setProjectionInternal(l){const f=(function(v,w){const I={constrainOverride:w};if(Array.isArray(v)){const k=new zp({type:v});return{projection:k,transform:new bl(I),cameraHelper:new $p(k)}}switch(v){case"mercator":return{projection:new $s,transform:new Yl(I),cameraHelper:new vl};case"globe":{const k=new zp({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:k,transform:new bl(I),cameraHelper:new $p(k)}}case"vertical-perspective":return{projection:new tf,transform:new yl(I),cameraHelper:new Wr};default:return s.w(`Unknown projection name: ${v}. Falling back to mercator projection.`),{projection:new $s,transform:new Yl(I),cameraHelper:new vl}}})(l,this.map.transformConstrain);this.projection=f.projection,this.map.migrateProjection(f.transform,f.cameraHelper);for(const v in this.tileManagers)this.tileManagers[v].reload()}_validate(l,f,v,w,I={}){return(!I||I.validate!==!1)&&zc(this,l.call(s.C,s.e({key:f,style:this.serialize(),value:v,styleSpec:s.u},w)))}_remove(l=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),pt().off(Re,this._rtlPluginLoaded);for(const f in this._layers)this._layers[f].setEventedParent(null);for(const f in this.tileManagers){const v=this.tileManagers[f];v.setEventedParent(null),v.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),l&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(l)}_clearSource(l){this.tileManagers[l].clearTiles()}_reloadSource(l){this.tileManagers[l].resume(),this.tileManagers[l].reload()}_updateSources(l){for(const f in this.tileManagers)this.tileManagers[f].update(l,this.map.terrain)}_generateCollisionBoxes(){for(const l in this.tileManagers)this._reloadSource(l)}_updatePlacement(l,f,v,w,I=!1){let k=!1,B=!1;const W={};for(const Z of this._order){const J=this._layers[Z];if(J.type!=="symbol")continue;if(!W[J.source]){const le=this.tileManagers[J.source];W[J.source]=le.getRenderableIds(!0).map((_e=>le.getTileByID(_e))).sort(((_e,Ee)=>Ee.tileID.overscaledZ-_e.tileID.overscaledZ||(_e.tileID.isLessThan(Ee.tileID)?-1:1)))}const ue=this.crossTileSymbolIndex.addLayer(J,W[J.source],l.center.lng);k=k||ue}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((I=I||this._layerOrderChanged||v===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(P(),l.zoom))&&(this.pauseablePlacement=new Dc(l,this.map.terrain,this._order,I,f,v,w,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,W),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(P()),B=!0),k&&this.pauseablePlacement.placement.setStale()),B||k)for(const Z of this._order){const J=this._layers[Z];J.type==="symbol"&&this.placement.updateLayerOpacities(J,W[J.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(P())}_releaseSymbolFadeTiles(){for(const l in this.tileManagers)this.tileManagers[l].releaseSymbolFadeTiles()}getImages(l,f){return s._(this,void 0,void 0,(function*(){const v=yield this.imageManager.getImages(f.icons);this._updateTilesForChangedImages();const w=this.tileManagers[f.source];return w&&w.setDependencies(f.tileID.key,f.type,f.icons),v}))}getGlyphs(l,f){return s._(this,void 0,void 0,(function*(){const v=yield this.glyphManager.getGlyphs(f.stacks),w=this.tileManagers[f.source];return w&&w.setDependencies(f.tileID.key,f.type,[""]),v}))}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(l,f={}){this._checkLoaded(),l&&this._validate(s.C.glyphs,"glyphs",l,null,f)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=l,this.glyphManager.entries={},this.glyphManager.setURL(l))}getDashes(l,f){return s._(this,void 0,void 0,(function*(){const v={};for(const[w,I]of Object.entries(f.dashes))v[w]=this.lineAtlas.getDash(I.dasharray,I.round);return v}))}addSprite(l,f,v={},w){this._checkLoaded();const I=[{id:l,url:f}],k=[...V(this.stylesheet.sprite),...I];this._validate(s.C.sprite,"sprite",k,null,v)||(this.stylesheet.sprite=k,this._loadSprite(I,!0,w))}removeSprite(l){this._checkLoaded();const f=V(this.stylesheet.sprite);if(f.find((v=>v.id===l))){if(this._spritesImagesIds[l])for(const v of this._spritesImagesIds[l])this.imageManager.removeImage(v),this._changedImages[v]=!0;f.splice(f.findIndex((v=>v.id===l)),1),this.stylesheet.sprite=f.length>0?f:void 0,delete this._spritesImagesIds[l],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.l("data",{dataType:"style"}))}else this.fire(new s.k(new Error(`Sprite "${l}" doesn't exists on this map.`)))}getSprite(){return V(this.stylesheet.sprite)}setSprite(l,f={},v){this._checkLoaded(),l&&this._validate(s.C.sprite,"sprite",l,null,f)||(this.stylesheet.sprite=l,l?this._loadSprite(l,!0,v):(this._unloadSprite(),v&&v(null)))}destroy(){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null);for(const l in this.tileManagers){const f=this.tileManagers[l];f.setEventedParent(null),f.onRemove(this.map)}this.tileManagers={},this.imageManager&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this._availableImages=[],this._spritesImagesIds={}),this.glyphManager&&this.glyphManager.destroy();for(const l in this._layers){const f=this._layers[l];f.setEventedParent(null),f.onRemove&&f.onRemove(this.map)}this._setInitialValues(),this.setEventedParent(null),this.dispatcher.unregisterMessageHandler("GG"),this.dispatcher.unregisterMessageHandler("GI"),this.dispatcher.unregisterMessageHandler("GDA"),this.dispatcher.remove(!0),this._listeners={},this._oneTimeListeners={}}}var x_=s.aU([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class jh{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(l,f,v,w,I,k,B,W,Z){this.context=l;let J=this.boundPaintVertexBuffers.length!==w.length;for(let ue=0;!J&&ue<w.length;ue++)this.boundPaintVertexBuffers[ue]!==w[ue]&&(J=!0);!this.vao||this.boundProgram!==f||this.boundLayoutVertexBuffer!==v||J||this.boundIndexBuffer!==I||this.boundVertexOffset!==k||this.boundDynamicVertexBuffer!==B||this.boundDynamicVertexBuffer2!==W||this.boundDynamicVertexBuffer3!==Z?this.freshBind(f,v,w,I,k,B,W,Z):(l.bindVertexArray.set(this.vao),B&&B.bind(),I&&I.dynamicDraw&&I.bind(),W&&W.bind(),Z&&Z.bind())}freshBind(l,f,v,w,I,k,B,W){const Z=l.numAttributes,J=this.context,ue=J.gl;this.vao&&this.destroy(),this.vao=J.createVertexArray(),J.bindVertexArray.set(this.vao),this.boundProgram=l,this.boundLayoutVertexBuffer=f,this.boundPaintVertexBuffers=v,this.boundIndexBuffer=w,this.boundVertexOffset=I,this.boundDynamicVertexBuffer=k,this.boundDynamicVertexBuffer2=B,this.boundDynamicVertexBuffer3=W,f.enableAttributes(ue,l);for(const le of v)le.enableAttributes(ue,l);k&&k.enableAttributes(ue,l),B&&B.enableAttributes(ue,l),W&&W.enableAttributes(ue,l),f.bind(),f.setVertexAttribPointers(ue,l,I);for(const le of v)le.bind(),le.setVertexAttribPointers(ue,l,I);k&&(k.bind(),k.setVertexAttribPointers(ue,l,I)),w&&w.bind(),B&&(B.bind(),B.setVertexAttribPointers(ue,l,I)),W&&(W.bind(),W.setVertexAttribPointers(ue,l,I)),J.currentNumAttributes=Z}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const w_=(A,l,f,v,w)=>({u_texture:0,u_ele_delta:A,u_fog_matrix:l,u_fog_color:f?f.properties.get("fog-color"):s.bp.white,u_fog_ground_blend:f?f.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:w?0:f?f.calculateFogBlendOpacity(v):0,u_horizon_color:f?f.properties.get("horizon-color"):s.bp.white,u_horizon_fog_blend:f?f.properties.get("horizon-fog-blend"):1,u_is_globe_mode:w?1:0}),Ia={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function Bc(A){const l=[];for(let f=0;f<A.length;f++){if(A[f]===null)continue;const v=A[f].split(" ");l.push(v.pop())}return l}class Vp{constructor(l,f,v,w,I,k,B,W,Z=[]){const J=l.gl;this.program=J.createProgram();const ue=Bc(f.staticAttributes),le=v?v.getBinderAttributes():[],_e=ue.concat(le),Ee=xn.prelude.staticUniforms?Bc(xn.prelude.staticUniforms):[],ze=B.staticUniforms?Bc(B.staticUniforms):[],$e=f.staticUniforms?Bc(f.staticUniforms):[],Ne=v?v.getBinderUniforms():[],Ze=Ee.concat(ze).concat($e).concat(Ne),rt=[];for(const At of Ze)rt.indexOf(At)<0&&rt.push(At);const We=v?v.defines():[];Mo(J)&&We.unshift("#version 300 es"),I&&We.push("#define OVERDRAW_INSPECTOR;"),k&&We.push("#define TERRAIN3D;"),W&&We.push(W),Z&&We.push(...Z);let it=We.concat(xn.prelude.fragmentSource,B.fragmentSource,f.fragmentSource).join(`
`),lt=We.concat(xn.prelude.vertexSource,B.vertexSource,f.vertexSource).join(`
`);Mo(J)||(it=(function(At){return At.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")})(it),lt=(function(At){return At.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")})(lt));const Qe=J.createShader(J.FRAGMENT_SHADER);if(J.isContextLost())return void(this.failedToCreate=!0);if(J.shaderSource(Qe,it),J.compileShader(Qe),!J.getShaderParameter(Qe,J.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${J.getShaderInfoLog(Qe)}`);J.attachShader(this.program,Qe);const _t=J.createShader(J.VERTEX_SHADER);if(J.isContextLost())return void(this.failedToCreate=!0);if(J.shaderSource(_t,lt),J.compileShader(_t),!J.getShaderParameter(_t,J.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${J.getShaderInfoLog(_t)}`);J.attachShader(this.program,_t),this.attributes={};const Dt={};this.numAttributes=_e.length;for(let At=0;At<this.numAttributes;At++)_e[At]&&(J.bindAttribLocation(this.program,At,_e[At]),this.attributes[_e[At]]=At);if(J.linkProgram(this.program),!J.getProgramParameter(this.program,J.LINK_STATUS))throw new Error(`Program failed to link: ${J.getProgramInfoLog(this.program)}`);J.deleteShader(_t),J.deleteShader(Qe);for(let At=0;At<rt.length;At++){const Pt=rt[At];if(Pt&&!Dt[Pt]){const It=J.getUniformLocation(this.program,Pt);It&&(Dt[Pt]=It)}}this.fixedUniforms=w(l,Dt),this.terrainUniforms=((At,Pt)=>({u_depth:new s.b_(At,Pt.u_depth),u_terrain:new s.b_(At,Pt.u_terrain),u_terrain_dim:new s.bq(At,Pt.u_terrain_dim),u_terrain_matrix:new s.c0(At,Pt.u_terrain_matrix),u_terrain_unpack:new s.c1(At,Pt.u_terrain_unpack),u_terrain_exaggeration:new s.bq(At,Pt.u_terrain_exaggeration)}))(l,Dt),this.projectionUniforms=((At,Pt)=>({u_projection_matrix:new s.c0(At,Pt.u_projection_matrix),u_projection_tile_mercator_coords:new s.c1(At,Pt.u_projection_tile_mercator_coords),u_projection_clipping_plane:new s.c1(At,Pt.u_projection_clipping_plane),u_projection_transition:new s.bq(At,Pt.u_projection_transition),u_projection_fallback_matrix:new s.c0(At,Pt.u_projection_fallback_matrix)}))(l,Dt),this.binderUniforms=v?v.getUniforms(l,Dt):[]}draw(l,f,v,w,I,k,B,W,Z,J,ue,le,_e,Ee,ze,$e,Ne,Ze,rt){const We=l.gl;if(this.failedToCreate)return;if(l.program.set(this.program),l.setDepthMode(v),l.setStencilMode(w),l.setColorMode(I),l.setCullFace(k),W){l.activeTexture.set(We.TEXTURE2),We.bindTexture(We.TEXTURE_2D,W.depthTexture),l.activeTexture.set(We.TEXTURE3),We.bindTexture(We.TEXTURE_2D,W.texture);for(const lt in this.terrainUniforms)this.terrainUniforms[lt].set(W[lt])}if(Z)for(const lt in Z)this.projectionUniforms[Ia[lt]].set(Z[lt]);if(B)for(const lt in this.fixedUniforms)this.fixedUniforms[lt].set(B[lt]);$e&&$e.setUniforms(l,this.binderUniforms,Ee,{zoom:ze});let it=0;switch(f){case We.LINES:it=2;break;case We.TRIANGLES:it=3;break;case We.LINE_STRIP:it=1}for(const lt of _e.get()){const Qe=lt.vaos||(lt.vaos={});(Qe[J]||(Qe[J]=new jh)).bind(l,this,ue,$e?$e.getPaintVertexBuffers():[],le,lt.vertexOffset,Ne,Ze,rt),We.drawElements(f,lt.primitiveLength*it,We.UNSIGNED_SHORT,lt.primitiveOffset*it*2)}}}function of(A,l,f){const v=1/s.aN(f,1,l.transform.tileZoom),w=Math.pow(2,f.tileID.overscaledZ),I=f.tileSize*Math.pow(2,l.transform.tileZoom)/w,k=I*(f.tileID.canonical.x+f.tileID.wrap*w),B=I*f.tileID.canonical.y;return{u_image:0,u_texsize:f.imageAtlasTexture.size,u_scale:[v,A.fromScale,A.toScale],u_fade:A.t,u_pixel_coord_upper:[k>>16,B>>16],u_pixel_coord_lower:[65535&k,65535&B]}}const af=(A,l,f,v)=>{const w=A.style.light,I=w.properties.get("position"),k=[I.x,I.y,I.z],B=s.c4();w.properties.get("anchor")==="viewport"&&s.c5(B,A.transform.bearingInRadians),s.c6(k,k,B);const W=A.transform.transformLightDirection(k),Z=w.properties.get("color");return{u_lightpos:k,u_lightpos_globe:W,u_lightintensity:w.properties.get("intensity"),u_lightcolor:[Z.r,Z.g,Z.b],u_vertical_gradient:+l,u_opacity:f,u_fill_translate:v}},xl=(A,l,f,v,w,I,k)=>s.e(af(A,l,f,v),of(I,A,k),{u_height_factor:-Math.pow(2,w.overscaledZ)/k.tileSize/8}),ku=(A,l,f,v)=>s.e(of(l,A,f),{u_fill_translate:v}),lf=(A,l)=>({u_world:A,u_fill_translate:l}),Up=(A,l,f,v,w)=>s.e(ku(A,l,f,w),{u_world:v}),jp=(A,l,f,v,w)=>{const I=A.transform;let k,B,W=0;if(f.paint.get("circle-pitch-alignment")==="map"){const Z=s.aN(l,1,I.zoom);k=!0,B=[Z,Z],W=Z/(s.a5*Math.pow(2,l.tileID.overscaledZ))*2*Math.PI*w}else k=!1,B=I.pixelsToGLUnits;return{u_camera_to_center_distance:I.cameraToCenterDistance,u_scale_with_map:+(f.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+k,u_device_pixel_ratio:A.pixelRatio,u_extrude_scale:B,u_globe_extrude_scale:W,u_translate:v}},nc=A=>({u_pixel_extrude_scale:[1/A.width,1/A.height]}),Nc=A=>({u_viewport_size:[A.width,A.height]}),Ra=(A,l=1)=>({u_color:A,u_overlay:0,u_overlay_scale:l}),$c=(A,l,f,v)=>{const w=s.aN(A,1,l)/(s.a5*Math.pow(2,A.tileID.overscaledZ))*2*Math.PI*v;return{u_extrude_scale:s.aN(A,1,l),u_intensity:f,u_globe_extrude_scale:w}},Gp=(A,l,f,v)=>{const w=s.N();s.c7(w,0,A.width,A.height,0,0,1);const I=A.context.gl;return{u_matrix:w,u_world:[I.drawingBufferWidth,I.drawingBufferHeight],u_image:f,u_color_ramp:v,u_opacity:l.paint.get("heatmap-opacity")}},Gh=(A,l,f)=>{const v=f.paint.get("hillshade-accent-color");let w;switch(f.paint.get("hillshade-method")){case"basic":w=4;break;case"combined":w=1;break;case"igor":w=2;break;case"multidirectional":w=3;break;default:w=0}const I=f.getIlluminationProperties();for(let k=0;k<I.directionRadians.length;k++)f.paint.get("hillshade-illumination-anchor")==="viewport"&&(I.directionRadians[k]+=A.transform.bearingInRadians);return{u_image:0,u_latrange:T_(0,l.tileID),u_exaggeration:f.paint.get("hillshade-exaggeration"),u_altitudes:I.altitudeRadians,u_azimuths:I.directionRadians,u_accent:v,u_method:w,u_highlights:I.highlightColor,u_shadows:I.shadowColor}},S_=(A,l)=>{const f=l.stride,v=s.N();return s.c7(v,0,s.a5,-s.a5,0,0,1),s.O(v,v,[0,-s.a5,0]),{u_matrix:v,u_image:1,u_dimension:[f,f],u_zoom:A.overscaledZ,u_unpack:l.getUnpackVector()}};function T_(A,l){const f=Math.pow(2,l.canonical.z),v=l.canonical.y;return[new s.a9(0,v/f).toLngLat().lat,new s.a9(0,(v+1)/f).toLngLat().lat]}const qp=(A,l,f=0)=>({u_image:0,u_unpack:l.getUnpackVector(),u_dimension:[l.stride,l.stride],u_elevation_stops:1,u_color_stops:4,u_color_ramp_size:f,u_opacity:A.paint.get("color-relief-opacity")}),Du=(A,l,f,v)=>{const w=A.transform;return{u_translation:Ou(A,l,f),u_ratio:v/s.aN(l,1,w.zoom),u_device_pixel_ratio:A.pixelRatio,u_units_to_pixels:[1/w.pixelsToGLUnits[0],1/w.pixelsToGLUnits[1]]}},Wp=(A,l,f,v,w)=>s.e(Du(A,l,f,v),{u_image:0,u_image_height:w}),qh=(A,l,f,v,w)=>{const I=A.transform,k=lo(l,I);return{u_translation:Ou(A,l,f),u_texsize:l.imageAtlasTexture.size,u_ratio:v/s.aN(l,1,I.zoom),u_device_pixel_ratio:A.pixelRatio,u_image:0,u_scale:[k,w.fromScale,w.toScale],u_fade:w.t,u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]]}},Hp=(A,l,f,v,w)=>{const I=lo(l,A.transform);return s.e(Du(A,l,f,v),{u_tileratio:I,u_crossfade_from:w.fromScale,u_crossfade_to:w.toScale,u_image:0,u_mix:w.t,u_lineatlas_width:A.lineAtlas.width,u_lineatlas_height:A.lineAtlas.height})},Fu=(A,l,f,v,w,I)=>{const k=lo(l,A.transform);return s.e(Du(A,l,f,v),{u_image:0,u_image_height:I,u_tileratio:k,u_crossfade_from:w.fromScale,u_crossfade_to:w.toScale,u_image_dash:1,u_mix:w.t,u_lineatlas_width:A.lineAtlas.width,u_lineatlas_height:A.lineAtlas.height})};function lo(A,l){return 1/s.aN(A,1,l.tileZoom)}function Ou(A,l,f){return s.aO(A.transform,l,f.paint.get("line-translate"),f.paint.get("line-translate-anchor"))}const La=(A,l,f,v,w)=>{return{u_tl_parent:A,u_scale_parent:l,u_buffer_scale:1,u_fade_t:f.mix,u_opacity:f.opacity*v.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:v.paint.get("raster-brightness-min"),u_brightness_high:v.paint.get("raster-brightness-max"),u_saturation_factor:(k=v.paint.get("raster-saturation"),k>0?1-1/(1.001-k):-k),u_contrast_factor:(I=v.paint.get("raster-contrast"),I>0?1/(1-I):1+I),u_spin_weights:Wh(v.paint.get("raster-hue-rotate")),u_coords_top:[w[0].x,w[0].y,w[1].x,w[1].y],u_coords_bottom:[w[3].x,w[3].y,w[2].x,w[2].y]};var I,k};function Wh(A){A*=Math.PI/180;const l=Math.sin(A),f=Math.cos(A);return[(2*f+1)/3,(-Math.sqrt(3)*l-f+1)/3,(Math.sqrt(3)*l-f+1)/3]}const zu=(A,l,f,v,w,I,k,B,W,Z,J,ue,le)=>{const _e=k.transform;return{u_is_size_zoom_constant:+(A==="constant"||A==="source"),u_is_size_feature_constant:+(A==="constant"||A==="camera"),u_size_t:l?l.uSizeT:0,u_size:l?l.uSize:0,u_camera_to_center_distance:_e.cameraToCenterDistance,u_pitch:_e.pitch/360*2*Math.PI,u_rotate_symbol:+f,u_aspect_ratio:_e.width/_e.height,u_fade_change:k.options.fadeDuration?k.symbolFadeChange:1,u_label_plane_matrix:B,u_coord_matrix:W,u_is_text:+J,u_pitch_with_map:+v,u_is_along_line:w,u_is_variable_anchor:I,u_texsize:ue,u_texture:0,u_translation:Z,u_pitched_scale:le}},Bu=(A,l,f,v,w,I,k,B,W,Z,J,ue,le,_e)=>{const Ee=k.transform;return s.e(zu(A,l,f,v,w,I,k,B,W,Z,J,ue,_e),{u_gamma_scale:v?Math.cos(Ee.pitch*Math.PI/180)*Ee.cameraToCenterDistance:1,u_device_pixel_ratio:k.pixelRatio,u_is_halo:1})},ka=(A,l,f,v,w,I,k,B,W,Z,J,ue,le)=>s.e(Bu(A,l,f,v,w,I,k,B,W,Z,!0,J,0,le),{u_texsize_icon:ue,u_texture_icon:1}),Hh=(A,l)=>({u_opacity:A,u_color:l}),cf=(A,l,f,v,w)=>s.e((function(I,k,B,W){const Z=B.imageManager.getPattern(I.from.toString()),J=B.imageManager.getPattern(I.to.toString()),{width:ue,height:le}=B.imageManager.getPixelSize(),_e=Math.pow(2,W.tileID.overscaledZ),Ee=W.tileSize*Math.pow(2,B.transform.tileZoom)/_e,ze=Ee*(W.tileID.canonical.x+W.tileID.wrap*_e),$e=Ee*W.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:Z.tl,u_pattern_br_a:Z.br,u_pattern_tl_b:J.tl,u_pattern_br_b:J.br,u_texsize:[ue,le],u_mix:k.t,u_pattern_size_a:Z.displaySize,u_pattern_size_b:J.displaySize,u_scale_a:k.fromScale,u_scale_b:k.toScale,u_tile_units_to_pixels:1/s.aN(W,1,B.transform.tileZoom),u_pixel_coord_upper:[ze>>16,$e>>16],u_pixel_coord_lower:[65535&ze,65535&$e]}})(f,w,l,v),{u_opacity:A}),Zp=(A,l)=>{},rc={fillExtrusion:(A,l)=>({u_lightpos:new s.c2(A,l.u_lightpos),u_lightpos_globe:new s.c2(A,l.u_lightpos_globe),u_lightintensity:new s.bq(A,l.u_lightintensity),u_lightcolor:new s.c2(A,l.u_lightcolor),u_vertical_gradient:new s.bq(A,l.u_vertical_gradient),u_opacity:new s.bq(A,l.u_opacity),u_fill_translate:new s.c3(A,l.u_fill_translate)}),fillExtrusionPattern:(A,l)=>({u_lightpos:new s.c2(A,l.u_lightpos),u_lightpos_globe:new s.c2(A,l.u_lightpos_globe),u_lightintensity:new s.bq(A,l.u_lightintensity),u_lightcolor:new s.c2(A,l.u_lightcolor),u_vertical_gradient:new s.bq(A,l.u_vertical_gradient),u_height_factor:new s.bq(A,l.u_height_factor),u_opacity:new s.bq(A,l.u_opacity),u_fill_translate:new s.c3(A,l.u_fill_translate),u_image:new s.b_(A,l.u_image),u_texsize:new s.c3(A,l.u_texsize),u_pixel_coord_upper:new s.c3(A,l.u_pixel_coord_upper),u_pixel_coord_lower:new s.c3(A,l.u_pixel_coord_lower),u_scale:new s.c2(A,l.u_scale),u_fade:new s.bq(A,l.u_fade)}),fill:(A,l)=>({u_fill_translate:new s.c3(A,l.u_fill_translate)}),fillPattern:(A,l)=>({u_image:new s.b_(A,l.u_image),u_texsize:new s.c3(A,l.u_texsize),u_pixel_coord_upper:new s.c3(A,l.u_pixel_coord_upper),u_pixel_coord_lower:new s.c3(A,l.u_pixel_coord_lower),u_scale:new s.c2(A,l.u_scale),u_fade:new s.bq(A,l.u_fade),u_fill_translate:new s.c3(A,l.u_fill_translate)}),fillOutline:(A,l)=>({u_world:new s.c3(A,l.u_world),u_fill_translate:new s.c3(A,l.u_fill_translate)}),fillOutlinePattern:(A,l)=>({u_world:new s.c3(A,l.u_world),u_image:new s.b_(A,l.u_image),u_texsize:new s.c3(A,l.u_texsize),u_pixel_coord_upper:new s.c3(A,l.u_pixel_coord_upper),u_pixel_coord_lower:new s.c3(A,l.u_pixel_coord_lower),u_scale:new s.c2(A,l.u_scale),u_fade:new s.bq(A,l.u_fade),u_fill_translate:new s.c3(A,l.u_fill_translate)}),circle:(A,l)=>({u_camera_to_center_distance:new s.bq(A,l.u_camera_to_center_distance),u_scale_with_map:new s.b_(A,l.u_scale_with_map),u_pitch_with_map:new s.b_(A,l.u_pitch_with_map),u_extrude_scale:new s.c3(A,l.u_extrude_scale),u_device_pixel_ratio:new s.bq(A,l.u_device_pixel_ratio),u_globe_extrude_scale:new s.bq(A,l.u_globe_extrude_scale),u_translate:new s.c3(A,l.u_translate)}),collisionBox:(A,l)=>({u_pixel_extrude_scale:new s.c3(A,l.u_pixel_extrude_scale)}),collisionCircle:(A,l)=>({u_viewport_size:new s.c3(A,l.u_viewport_size)}),debug:(A,l)=>({u_color:new s.b$(A,l.u_color),u_overlay:new s.b_(A,l.u_overlay),u_overlay_scale:new s.bq(A,l.u_overlay_scale)}),depth:Zp,clippingMask:Zp,heatmap:(A,l)=>({u_extrude_scale:new s.bq(A,l.u_extrude_scale),u_intensity:new s.bq(A,l.u_intensity),u_globe_extrude_scale:new s.bq(A,l.u_globe_extrude_scale)}),heatmapTexture:(A,l)=>({u_matrix:new s.c0(A,l.u_matrix),u_world:new s.c3(A,l.u_world),u_image:new s.b_(A,l.u_image),u_color_ramp:new s.b_(A,l.u_color_ramp),u_opacity:new s.bq(A,l.u_opacity)}),hillshade:(A,l)=>({u_image:new s.b_(A,l.u_image),u_latrange:new s.c3(A,l.u_latrange),u_exaggeration:new s.bq(A,l.u_exaggeration),u_altitudes:new s.c9(A,l.u_altitudes),u_azimuths:new s.c9(A,l.u_azimuths),u_accent:new s.b$(A,l.u_accent),u_method:new s.b_(A,l.u_method),u_shadows:new s.c8(A,l.u_shadows),u_highlights:new s.c8(A,l.u_highlights)}),hillshadePrepare:(A,l)=>({u_matrix:new s.c0(A,l.u_matrix),u_image:new s.b_(A,l.u_image),u_dimension:new s.c3(A,l.u_dimension),u_zoom:new s.bq(A,l.u_zoom),u_unpack:new s.c1(A,l.u_unpack)}),colorRelief:(A,l)=>({u_image:new s.b_(A,l.u_image),u_unpack:new s.c1(A,l.u_unpack),u_dimension:new s.c3(A,l.u_dimension),u_elevation_stops:new s.b_(A,l.u_elevation_stops),u_color_stops:new s.b_(A,l.u_color_stops),u_color_ramp_size:new s.b_(A,l.u_color_ramp_size),u_opacity:new s.bq(A,l.u_opacity)}),line:(A,l)=>({u_translation:new s.c3(A,l.u_translation),u_ratio:new s.bq(A,l.u_ratio),u_device_pixel_ratio:new s.bq(A,l.u_device_pixel_ratio),u_units_to_pixels:new s.c3(A,l.u_units_to_pixels)}),lineGradient:(A,l)=>({u_translation:new s.c3(A,l.u_translation),u_ratio:new s.bq(A,l.u_ratio),u_device_pixel_ratio:new s.bq(A,l.u_device_pixel_ratio),u_units_to_pixels:new s.c3(A,l.u_units_to_pixels),u_image:new s.b_(A,l.u_image),u_image_height:new s.bq(A,l.u_image_height)}),linePattern:(A,l)=>({u_translation:new s.c3(A,l.u_translation),u_texsize:new s.c3(A,l.u_texsize),u_ratio:new s.bq(A,l.u_ratio),u_device_pixel_ratio:new s.bq(A,l.u_device_pixel_ratio),u_image:new s.b_(A,l.u_image),u_units_to_pixels:new s.c3(A,l.u_units_to_pixels),u_scale:new s.c2(A,l.u_scale),u_fade:new s.bq(A,l.u_fade)}),lineSDF:(A,l)=>({u_translation:new s.c3(A,l.u_translation),u_ratio:new s.bq(A,l.u_ratio),u_device_pixel_ratio:new s.bq(A,l.u_device_pixel_ratio),u_units_to_pixels:new s.c3(A,l.u_units_to_pixels),u_image:new s.b_(A,l.u_image),u_mix:new s.bq(A,l.u_mix),u_tileratio:new s.bq(A,l.u_tileratio),u_crossfade_from:new s.bq(A,l.u_crossfade_from),u_crossfade_to:new s.bq(A,l.u_crossfade_to),u_lineatlas_width:new s.bq(A,l.u_lineatlas_width),u_lineatlas_height:new s.bq(A,l.u_lineatlas_height)}),lineGradientSDF:(A,l)=>({u_translation:new s.c3(A,l.u_translation),u_ratio:new s.bq(A,l.u_ratio),u_device_pixel_ratio:new s.bq(A,l.u_device_pixel_ratio),u_units_to_pixels:new s.c3(A,l.u_units_to_pixels),u_image:new s.b_(A,l.u_image),u_image_height:new s.bq(A,l.u_image_height),u_tileratio:new s.bq(A,l.u_tileratio),u_crossfade_from:new s.bq(A,l.u_crossfade_from),u_crossfade_to:new s.bq(A,l.u_crossfade_to),u_image_dash:new s.b_(A,l.u_image_dash),u_mix:new s.bq(A,l.u_mix),u_lineatlas_width:new s.bq(A,l.u_lineatlas_width),u_lineatlas_height:new s.bq(A,l.u_lineatlas_height)}),raster:(A,l)=>({u_tl_parent:new s.c3(A,l.u_tl_parent),u_scale_parent:new s.bq(A,l.u_scale_parent),u_buffer_scale:new s.bq(A,l.u_buffer_scale),u_fade_t:new s.bq(A,l.u_fade_t),u_opacity:new s.bq(A,l.u_opacity),u_image0:new s.b_(A,l.u_image0),u_image1:new s.b_(A,l.u_image1),u_brightness_low:new s.bq(A,l.u_brightness_low),u_brightness_high:new s.bq(A,l.u_brightness_high),u_saturation_factor:new s.bq(A,l.u_saturation_factor),u_contrast_factor:new s.bq(A,l.u_contrast_factor),u_spin_weights:new s.c2(A,l.u_spin_weights),u_coords_top:new s.c1(A,l.u_coords_top),u_coords_bottom:new s.c1(A,l.u_coords_bottom)}),symbolIcon:(A,l)=>({u_is_size_zoom_constant:new s.b_(A,l.u_is_size_zoom_constant),u_is_size_feature_constant:new s.b_(A,l.u_is_size_feature_constant),u_size_t:new s.bq(A,l.u_size_t),u_size:new s.bq(A,l.u_size),u_camera_to_center_distance:new s.bq(A,l.u_camera_to_center_distance),u_pitch:new s.bq(A,l.u_pitch),u_rotate_symbol:new s.b_(A,l.u_rotate_symbol),u_aspect_ratio:new s.bq(A,l.u_aspect_ratio),u_fade_change:new s.bq(A,l.u_fade_change),u_label_plane_matrix:new s.c0(A,l.u_label_plane_matrix),u_coord_matrix:new s.c0(A,l.u_coord_matrix),u_is_text:new s.b_(A,l.u_is_text),u_pitch_with_map:new s.b_(A,l.u_pitch_with_map),u_is_along_line:new s.b_(A,l.u_is_along_line),u_is_variable_anchor:new s.b_(A,l.u_is_variable_anchor),u_texsize:new s.c3(A,l.u_texsize),u_texture:new s.b_(A,l.u_texture),u_translation:new s.c3(A,l.u_translation),u_pitched_scale:new s.bq(A,l.u_pitched_scale)}),symbolSDF:(A,l)=>({u_is_size_zoom_constant:new s.b_(A,l.u_is_size_zoom_constant),u_is_size_feature_constant:new s.b_(A,l.u_is_size_feature_constant),u_size_t:new s.bq(A,l.u_size_t),u_size:new s.bq(A,l.u_size),u_camera_to_center_distance:new s.bq(A,l.u_camera_to_center_distance),u_pitch:new s.bq(A,l.u_pitch),u_rotate_symbol:new s.b_(A,l.u_rotate_symbol),u_aspect_ratio:new s.bq(A,l.u_aspect_ratio),u_fade_change:new s.bq(A,l.u_fade_change),u_label_plane_matrix:new s.c0(A,l.u_label_plane_matrix),u_coord_matrix:new s.c0(A,l.u_coord_matrix),u_is_text:new s.b_(A,l.u_is_text),u_pitch_with_map:new s.b_(A,l.u_pitch_with_map),u_is_along_line:new s.b_(A,l.u_is_along_line),u_is_variable_anchor:new s.b_(A,l.u_is_variable_anchor),u_texsize:new s.c3(A,l.u_texsize),u_texture:new s.b_(A,l.u_texture),u_gamma_scale:new s.bq(A,l.u_gamma_scale),u_device_pixel_ratio:new s.bq(A,l.u_device_pixel_ratio),u_is_halo:new s.b_(A,l.u_is_halo),u_translation:new s.c3(A,l.u_translation),u_pitched_scale:new s.bq(A,l.u_pitched_scale)}),symbolTextAndIcon:(A,l)=>({u_is_size_zoom_constant:new s.b_(A,l.u_is_size_zoom_constant),u_is_size_feature_constant:new s.b_(A,l.u_is_size_feature_constant),u_size_t:new s.bq(A,l.u_size_t),u_size:new s.bq(A,l.u_size),u_camera_to_center_distance:new s.bq(A,l.u_camera_to_center_distance),u_pitch:new s.bq(A,l.u_pitch),u_rotate_symbol:new s.b_(A,l.u_rotate_symbol),u_aspect_ratio:new s.bq(A,l.u_aspect_ratio),u_fade_change:new s.bq(A,l.u_fade_change),u_label_plane_matrix:new s.c0(A,l.u_label_plane_matrix),u_coord_matrix:new s.c0(A,l.u_coord_matrix),u_is_text:new s.b_(A,l.u_is_text),u_pitch_with_map:new s.b_(A,l.u_pitch_with_map),u_is_along_line:new s.b_(A,l.u_is_along_line),u_is_variable_anchor:new s.b_(A,l.u_is_variable_anchor),u_texsize:new s.c3(A,l.u_texsize),u_texsize_icon:new s.c3(A,l.u_texsize_icon),u_texture:new s.b_(A,l.u_texture),u_texture_icon:new s.b_(A,l.u_texture_icon),u_gamma_scale:new s.bq(A,l.u_gamma_scale),u_device_pixel_ratio:new s.bq(A,l.u_device_pixel_ratio),u_is_halo:new s.b_(A,l.u_is_halo),u_translation:new s.c3(A,l.u_translation),u_pitched_scale:new s.bq(A,l.u_pitched_scale)}),background:(A,l)=>({u_opacity:new s.bq(A,l.u_opacity),u_color:new s.b$(A,l.u_color)}),backgroundPattern:(A,l)=>({u_opacity:new s.bq(A,l.u_opacity),u_image:new s.b_(A,l.u_image),u_pattern_tl_a:new s.c3(A,l.u_pattern_tl_a),u_pattern_br_a:new s.c3(A,l.u_pattern_br_a),u_pattern_tl_b:new s.c3(A,l.u_pattern_tl_b),u_pattern_br_b:new s.c3(A,l.u_pattern_br_b),u_texsize:new s.c3(A,l.u_texsize),u_mix:new s.bq(A,l.u_mix),u_pattern_size_a:new s.c3(A,l.u_pattern_size_a),u_pattern_size_b:new s.c3(A,l.u_pattern_size_b),u_scale_a:new s.bq(A,l.u_scale_a),u_scale_b:new s.bq(A,l.u_scale_b),u_pixel_coord_upper:new s.c3(A,l.u_pixel_coord_upper),u_pixel_coord_lower:new s.c3(A,l.u_pixel_coord_lower),u_tile_units_to_pixels:new s.bq(A,l.u_tile_units_to_pixels)}),terrain:(A,l)=>({u_texture:new s.b_(A,l.u_texture),u_ele_delta:new s.bq(A,l.u_ele_delta),u_fog_matrix:new s.c0(A,l.u_fog_matrix),u_fog_color:new s.b$(A,l.u_fog_color),u_fog_ground_blend:new s.bq(A,l.u_fog_ground_blend),u_fog_ground_blend_opacity:new s.bq(A,l.u_fog_ground_blend_opacity),u_horizon_color:new s.b$(A,l.u_horizon_color),u_horizon_fog_blend:new s.bq(A,l.u_horizon_fog_blend),u_is_globe_mode:new s.bq(A,l.u_is_globe_mode)}),terrainDepth:(A,l)=>({u_ele_delta:new s.bq(A,l.u_ele_delta)}),terrainCoords:(A,l)=>({u_texture:new s.b_(A,l.u_texture),u_terrain_coords_id:new s.bq(A,l.u_terrain_coords_id),u_ele_delta:new s.bq(A,l.u_ele_delta)}),projectionErrorMeasurement:(A,l)=>({u_input:new s.bq(A,l.u_input),u_output_expected:new s.bq(A,l.u_output_expected)}),atmosphere:(A,l)=>({u_sun_pos:new s.c2(A,l.u_sun_pos),u_atmosphere_blend:new s.bq(A,l.u_atmosphere_blend),u_globe_position:new s.c2(A,l.u_globe_position),u_globe_radius:new s.bq(A,l.u_globe_radius),u_inv_proj_matrix:new s.c0(A,l.u_inv_proj_matrix)}),sky:(A,l)=>({u_sky_color:new s.b$(A,l.u_sky_color),u_horizon_color:new s.b$(A,l.u_horizon_color),u_horizon:new s.c3(A,l.u_horizon),u_horizon_normal:new s.c3(A,l.u_horizon_normal),u_sky_horizon_blend:new s.bq(A,l.u_sky_horizon_blend),u_sky_blend:new s.bq(A,l.u_sky_blend)})};class wl{constructor(l,f,v){this.context=l;const w=l.gl;this.buffer=w.createBuffer(),this.dynamicDraw=!!v,this.context.unbindVAO(),l.bindElementBuffer.set(this.buffer),w.bufferData(w.ELEMENT_ARRAY_BUFFER,f.arrayBuffer,this.dynamicDraw?w.DYNAMIC_DRAW:w.STATIC_DRAW),this.dynamicDraw||delete f.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(l){const f=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),f.bufferSubData(f.ELEMENT_ARRAY_BUFFER,0,l.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Xp={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class M_{constructor(l,f,v,w){this.length=f.length,this.attributes=v,this.itemSize=f.bytesPerElement,this.dynamicDraw=w,this.context=l;const I=l.gl;this.buffer=I.createBuffer(),l.bindVertexBuffer.set(this.buffer),I.bufferData(I.ARRAY_BUFFER,f.arrayBuffer,this.dynamicDraw?I.DYNAMIC_DRAW:I.STATIC_DRAW),this.dynamicDraw||delete f.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(l){if(l.length!==this.length)throw new Error(`Length of new data is ${l.length}, which doesn't match current length of ${this.length}`);const f=this.context.gl;this.bind(),f.bufferSubData(f.ARRAY_BUFFER,0,l.arrayBuffer)}enableAttributes(l,f){for(let v=0;v<this.attributes.length;v++){const w=f.attributes[this.attributes[v].name];w!==void 0&&l.enableVertexAttribArray(w)}}setVertexAttribPointers(l,f,v){for(let w=0;w<this.attributes.length;w++){const I=this.attributes[w],k=f.attributes[I.name];k!==void 0&&l.vertexAttribPointer(k,I.components,l[Xp[I.type]],!1,this.itemSize,I.offset+this.itemSize*(v||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Mn{constructor(l){this.gl=l.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(l){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Zh extends Mn{getDefault(){return s.bp.transparent}set(l){const f=this.current;(l.r!==f.r||l.g!==f.g||l.b!==f.b||l.a!==f.a||this.dirty)&&(this.gl.clearColor(l.r,l.g,l.b,l.a),this.current=l,this.dirty=!1)}}class Xh extends Mn{getDefault(){return 1}set(l){(l!==this.current||this.dirty)&&(this.gl.clearDepth(l),this.current=l,this.dirty=!1)}}class Yh extends Mn{getDefault(){return 0}set(l){(l!==this.current||this.dirty)&&(this.gl.clearStencil(l),this.current=l,this.dirty=!1)}}class uf extends Mn{getDefault(){return[!0,!0,!0,!0]}set(l){const f=this.current;(l[0]!==f[0]||l[1]!==f[1]||l[2]!==f[2]||l[3]!==f[3]||this.dirty)&&(this.gl.colorMask(l[0],l[1],l[2],l[3]),this.current=l,this.dirty=!1)}}class sc extends Mn{getDefault(){return!0}set(l){(l!==this.current||this.dirty)&&(this.gl.depthMask(l),this.current=l,this.dirty=!1)}}class Vc extends Mn{getDefault(){return 255}set(l){(l!==this.current||this.dirty)&&(this.gl.stencilMask(l),this.current=l,this.dirty=!1)}}class Da extends Mn{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(l){const f=this.current;(l.func!==f.func||l.ref!==f.ref||l.mask!==f.mask||this.dirty)&&(this.gl.stencilFunc(l.func,l.ref,l.mask),this.current=l,this.dirty=!1)}}class Vs extends Mn{getDefault(){const l=this.gl;return[l.KEEP,l.KEEP,l.KEEP]}set(l){const f=this.current;(l[0]!==f[0]||l[1]!==f[1]||l[2]!==f[2]||this.dirty)&&(this.gl.stencilOp(l[0],l[1],l[2]),this.current=l,this.dirty=!1)}}class Yp extends Mn{getDefault(){return!1}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;l?f.enable(f.STENCIL_TEST):f.disable(f.STENCIL_TEST),this.current=l,this.dirty=!1}}class Kp extends Mn{getDefault(){return[0,1]}set(l){const f=this.current;(l[0]!==f[0]||l[1]!==f[1]||this.dirty)&&(this.gl.depthRange(l[0],l[1]),this.current=l,this.dirty=!1)}}class oc extends Mn{getDefault(){return!1}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;l?f.enable(f.DEPTH_TEST):f.disable(f.DEPTH_TEST),this.current=l,this.dirty=!1}}class ut extends Mn{getDefault(){return this.gl.LESS}set(l){(l!==this.current||this.dirty)&&(this.gl.depthFunc(l),this.current=l,this.dirty=!1)}}class Y extends Mn{getDefault(){return!1}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;l?f.enable(f.BLEND):f.disable(f.BLEND),this.current=l,this.dirty=!1}}class Me extends Mn{getDefault(){const l=this.gl;return[l.ONE,l.ZERO]}set(l){const f=this.current;(l[0]!==f[0]||l[1]!==f[1]||this.dirty)&&(this.gl.blendFunc(l[0],l[1]),this.current=l,this.dirty=!1)}}class dt extends Mn{getDefault(){return s.bp.transparent}set(l){const f=this.current;(l.r!==f.r||l.g!==f.g||l.b!==f.b||l.a!==f.a||this.dirty)&&(this.gl.blendColor(l.r,l.g,l.b,l.a),this.current=l,this.dirty=!1)}}class Ht extends Mn{getDefault(){return this.gl.FUNC_ADD}set(l){(l!==this.current||this.dirty)&&(this.gl.blendEquation(l),this.current=l,this.dirty=!1)}}class di extends Mn{getDefault(){return!1}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;l?f.enable(f.CULL_FACE):f.disable(f.CULL_FACE),this.current=l,this.dirty=!1}}class Ti extends Mn{getDefault(){return this.gl.BACK}set(l){(l!==this.current||this.dirty)&&(this.gl.cullFace(l),this.current=l,this.dirty=!1)}}class yn extends Mn{getDefault(){return this.gl.CCW}set(l){(l!==this.current||this.dirty)&&(this.gl.frontFace(l),this.current=l,this.dirty=!1)}}class pr extends Mn{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}}class Ms extends Mn{getDefault(){return this.gl.TEXTURE0}set(l){(l!==this.current||this.dirty)&&(this.gl.activeTexture(l),this.current=l,this.dirty=!1)}}class ji extends Mn{getDefault(){const l=this.gl;return[0,0,l.drawingBufferWidth,l.drawingBufferHeight]}set(l){const f=this.current;(l[0]!==f[0]||l[1]!==f[1]||l[2]!==f[2]||l[3]!==f[3]||this.dirty)&&(this.gl.viewport(l[0],l[1],l[2],l[3]),this.current=l,this.dirty=!1)}}class Js extends Mn{getDefault(){return null}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;f.bindFramebuffer(f.FRAMEBUFFER,l),this.current=l,this.dirty=!1}}class Fa extends Mn{getDefault(){return null}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;f.bindRenderbuffer(f.RENDERBUFFER,l),this.current=l,this.dirty=!1}}class ha extends Mn{getDefault(){return null}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;f.bindTexture(f.TEXTURE_2D,l),this.current=l,this.dirty=!1}}class Wo extends Mn{getDefault(){return null}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;f.bindBuffer(f.ARRAY_BUFFER,l),this.current=l,this.dirty=!1}}class Ho extends Mn{getDefault(){return null}set(l){const f=this.gl;f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,l),this.current=l,this.dirty=!1}}class Nu extends Mn{getDefault(){return null}set(l){var f;if(l===this.current&&!this.dirty)return;const v=this.gl;Mo(v)?v.bindVertexArray(l):(f=v.getExtension("OES_vertex_array_object"))===null||f===void 0||f.bindVertexArrayOES(l),this.current=l,this.dirty=!1}}class $u extends Mn{getDefault(){return 4}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;f.pixelStorei(f.UNPACK_ALIGNMENT,l),this.current=l,this.dirty=!1}}class C_ extends Mn{getDefault(){return!1}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,l),this.current=l,this.dirty=!1}}class Oa extends Mn{getDefault(){return!1}set(l){if(l===this.current&&!this.dirty)return;const f=this.gl;f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,l),this.current=l,this.dirty=!1}}class Uc extends Mn{constructor(l,f){super(l),this.context=l,this.parent=f}getDefault(){return null}}class hf extends Uc{setDirty(){this.dirty=!0}set(l){if(l===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const f=this.gl;f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,l,0),this.current=l,this.dirty=!1}}class Jp extends Uc{set(l){if(l===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const f=this.gl;f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,l),this.current=l,this.dirty=!1}}class E_ extends Uc{set(l){if(l===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const f=this.gl;f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.RENDERBUFFER,l),this.current=l,this.dirty=!1}}const A_="Framebuffer is not complete";class Qp{constructor(l,f,v,w,I){this.context=l,this.width=f,this.height=v;const k=l.gl,B=this.framebuffer=k.createFramebuffer();if(this.colorAttachment=new hf(l,B),w)this.depthAttachment=I?new E_(l,B):new Jp(l,B);else if(I)throw new Error("Stencil cannot be set without depth");if(k.checkFramebufferStatus(k.FRAMEBUFFER)!==k.FRAMEBUFFER_COMPLETE)throw new Error(A_)}destroy(){const l=this.context.gl,f=this.colorAttachment.get();if(f&&l.deleteTexture(f),this.depthAttachment){const v=this.depthAttachment.get();v&&l.deleteRenderbuffer(v)}l.deleteFramebuffer(this.framebuffer)}}class em{constructor(l){var f,v;if(this.gl=l,this.clearColor=new Zh(this),this.clearDepth=new Xh(this),this.clearStencil=new Yh(this),this.colorMask=new uf(this),this.depthMask=new sc(this),this.stencilMask=new Vc(this),this.stencilFunc=new Da(this),this.stencilOp=new Vs(this),this.stencilTest=new Yp(this),this.depthRange=new Kp(this),this.depthTest=new oc(this),this.depthFunc=new ut(this),this.blend=new Y(this),this.blendFunc=new Me(this),this.blendColor=new dt(this),this.blendEquation=new Ht(this),this.cullFace=new di(this),this.cullFaceSide=new Ti(this),this.frontFace=new yn(this),this.program=new pr(this),this.activeTexture=new Ms(this),this.viewport=new ji(this),this.bindFramebuffer=new Js(this),this.bindRenderbuffer=new Fa(this),this.bindTexture=new ha(this),this.bindVertexBuffer=new Wo(this),this.bindElementBuffer=new Ho(this),this.bindVertexArray=new Nu(this),this.pixelStoreUnpack=new $u(this),this.pixelStoreUnpackPremultiplyAlpha=new C_(this),this.pixelStoreUnpackFlipY=new Oa(this),this.extTextureFilterAnisotropic=l.getExtension("EXT_texture_filter_anisotropic")||l.getExtension("MOZ_EXT_texture_filter_anisotropic")||l.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=l.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=l.getParameter(l.MAX_TEXTURE_SIZE),Mo(l)){this.HALF_FLOAT=l.HALF_FLOAT;const w=l.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(f=l.RGBA16F)!==null&&f!==void 0?f:w?.RGBA16F_EXT,this.RGB16F=(v=l.RGB16F)!==null&&v!==void 0?v:w?.RGB16F_EXT,l.getExtension("EXT_color_buffer_float")}else{l.getExtension("EXT_color_buffer_half_float"),l.getExtension("OES_texture_half_float_linear");const w=l.getExtension("OES_texture_half_float");this.HALF_FLOAT=w?.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(l,f){return new wl(this,l,f)}createVertexBuffer(l,f,v){return new M_(this,l,f,v)}createRenderbuffer(l,f,v){const w=this.gl,I=w.createRenderbuffer();return this.bindRenderbuffer.set(I),w.renderbufferStorage(w.RENDERBUFFER,l,f,v),this.bindRenderbuffer.set(null),I}createFramebuffer(l,f,v,w){return new Qp(this,l,f,v,w)}clear({color:l,depth:f,stencil:v}){const w=this.gl;let I=0;l&&(I|=w.COLOR_BUFFER_BIT,this.clearColor.set(l),this.colorMask.set([!0,!0,!0,!0])),f!==void 0&&(I|=w.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(f),this.depthMask.set(!0)),v!==void 0&&(I|=w.STENCIL_BUFFER_BIT,this.clearStencil.set(v),this.stencilMask.set(255)),w.clear(I)}setCullFace(l){l.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(l.mode),this.frontFace.set(l.frontFace))}setDepthMode(l){l.func!==this.gl.ALWAYS||l.mask?(this.depthTest.set(!0),this.depthFunc.set(l.func),this.depthMask.set(l.mask),this.depthRange.set(l.range)):this.depthTest.set(!1)}setStencilMode(l){l.test.func!==this.gl.ALWAYS||l.mask?(this.stencilTest.set(!0),this.stencilMask.set(l.mask),this.stencilOp.set([l.fail,l.depthFail,l.pass]),this.stencilFunc.set({func:l.test.func,ref:l.ref,mask:l.test.mask})):this.stencilTest.set(!1)}setColorMode(l){s.bR(l.blendFunction,Nn.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(l.blendFunction),this.blendColor.set(l.blendColor)),this.colorMask.set(l.mask)}createVertexArray(){var l;return Mo(this.gl)?this.gl.createVertexArray():(l=this.gl.getExtension("OES_vertex_array_object"))===null||l===void 0?void 0:l.createVertexArrayOES()}deleteVertexArray(l){var f;return Mo(this.gl)?this.gl.deleteVertexArray(l):(f=this.gl.getExtension("OES_vertex_array_object"))===null||f===void 0?void 0:f.deleteVertexArrayOES(l)}unbindVAO(){this.bindVertexArray.set(null)}}let jc;function Vu(A,l,f,v,w){const I=A.context,k=A.transform,B=I.gl,W=A.useProgram("collisionBox"),Z=[];let J=0,ue=0;for(let Ne=0;Ne<v.length;Ne++){const Ze=v[Ne],rt=l.getTile(Ze).getBucket(f);if(!rt)continue;const We=w?rt.textCollisionBox:rt.iconCollisionBox,it=rt.collisionCircleArray;it.length>0&&(Z.push({circleArray:it,circleOffset:ue,coord:Ze}),J+=it.length/4,ue=J),We&&W.draw(I,B.LINES,Ji.disabled,bn.disabled,A.colorModeForRenderPass(),_n.disabled,nc(A.transform),A.style.map.terrain&&A.style.map.terrain.getTerrainData(Ze),k.getProjectionData({overscaledTileID:Ze,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),f.id,We.layoutVertexBuffer,We.indexBuffer,We.segments,null,A.transform.zoom,null,null,We.collisionVertexBuffer)}if(!w||!Z.length)return;const le=A.useProgram("collisionCircle"),_e=new s.ca;_e.resize(4*J),_e._trim();let Ee=0;for(const Ne of Z)for(let Ze=0;Ze<Ne.circleArray.length/4;Ze++){const rt=4*Ze,We=Ne.circleArray[rt+0],it=Ne.circleArray[rt+1],lt=Ne.circleArray[rt+2],Qe=Ne.circleArray[rt+3];_e.emplace(Ee++,We,it,lt,Qe,0),_e.emplace(Ee++,We,it,lt,Qe,1),_e.emplace(Ee++,We,it,lt,Qe,2),_e.emplace(Ee++,We,it,lt,Qe,3)}(!jc||jc.length<2*J)&&(jc=(function(Ne){const Ze=2*Ne,rt=new s.cc;rt.resize(Ze),rt._trim();for(let We=0;We<Ze;We++){const it=6*We;rt.uint16[it+0]=4*We+0,rt.uint16[it+1]=4*We+1,rt.uint16[it+2]=4*We+2,rt.uint16[it+3]=4*We+2,rt.uint16[it+4]=4*We+3,rt.uint16[it+5]=4*We+0}return rt})(J));const ze=I.createIndexBuffer(jc,!0),$e=I.createVertexBuffer(_e,s.cb.members,!0);for(const Ne of Z){const Ze=Nc(A.transform);le.draw(I,B.TRIANGLES,Ji.disabled,bn.disabled,A.colorModeForRenderPass(),_n.disabled,Ze,A.style.map.terrain&&A.style.map.terrain.getTerrainData(Ne.coord),null,f.id,$e,ze,s.aX.simpleSegment(0,2*Ne.circleOffset,Ne.circleArray.length,Ne.circleArray.length/2),null,A.transform.zoom,null,null,null)}$e.destroy(),ze.destroy()}const P_=s.ar(new Float32Array(16));function R1(A,l,f,v,w,I){const{horizontalAlign:k,verticalAlign:B}=s.aS(A);return new s.P((-(k-.5)*l/w+v[0])*I,(-(B-.5)*f/w+v[1])*I)}function df(A,l,f,v,w,I){const k=l.tileAnchorPoint.add(new s.P(l.translation[0],l.translation[1]));if(l.pitchWithMap){let B=v.mult(I);f||(B=B.rotate(-w));const W=k.add(B);return bi(W.x,W.y,l.pitchedLabelPlaneMatrix,l.getElevation).point}if(f){const B=rn(l.tileAnchorPoint.x+1,l.tileAnchorPoint.y,l).point.sub(A),W=Math.atan(B.y/B.x)+(B.x<0?Math.PI:0);return A.add(v.rotate(W))}return A.add(v)}function L1(A,l,f,v,w,I,k,B,W,Z,J,ue){const le=A.text.placedSymbolArray,_e=A.text.dynamicLayoutVertexArray,Ee=A.icon.dynamicLayoutVertexArray,ze={};_e.clear();for(let $e=0;$e<le.length;$e++){const Ne=le.get($e),Ze=Ne.hidden||!Ne.crossTileID||A.allowVerticalPlacement&&!Ne.placedOrientation?null:v[Ne.crossTileID];if(Ze){const rt=new s.P(Ne.anchorX,Ne.anchorY),We={getElevation:ue,width:w.width,height:w.height,pitchedLabelPlaneMatrix:I,pitchWithMap:f,transform:w,tileAnchorPoint:rt,translation:Z,unwrappedTileID:J},it=f?so(rt.x,rt.y,We):rn(rt.x,rt.y,We),lt=Vi(w.cameraToCenterDistance,it.signedDistanceFromCamera);let Qe=s.aA(A.textSizeData,B,Ne)*lt/s.aM;f&&(Qe*=A.tilePixelRatio/k);const{width:_t,height:Dt,anchor:At,textOffset:Pt,textBoxScale:It}=Ze,Qt=R1(At,_t,Dt,Pt,It,Qe),ti=w.getPitchedTextCorrection(rt.x+Z[0],rt.y+Z[1],J),Xt=df(it.point,We,l,Qt,-w.bearingInRadians,ti),oi=A.allowVerticalPlacement&&Ne.placedOrientation===s.az.vertical?Math.PI/2:0;for(let Yi=0;Yi<Ne.numGlyphs;Yi++)s.aG(_e,Xt,oi);W&&Ne.associatedIconIndex>=0&&(ze[Ne.associatedIconIndex]={shiftedAnchor:Xt,angle:oi})}else Hl(Ne.numGlyphs,_e)}if(W){Ee.clear();const $e=A.icon.placedSymbolArray;for(let Ne=0;Ne<$e.length;Ne++){const Ze=$e.get(Ne);if(Ze.hidden)Hl(Ze.numGlyphs,Ee);else{const rt=ze[Ne];if(rt)for(let We=0;We<Ze.numGlyphs;We++)s.aG(Ee,rt.shiftedAnchor,rt.angle);else Hl(Ze.numGlyphs,Ee)}}A.icon.dynamicLayoutVertexBuffer.updateData(Ee)}A.text.dynamicLayoutVertexBuffer.updateData(_e)}function E0(A,l,f){return f.iconsInText&&l?"symbolTextAndIcon":A?"symbolSDF":"symbolIcon"}function ff(A,l,f,v,w,I,k,B,W,Z,J,ue,le){const _e=A.context,Ee=_e.gl,ze=A.transform,$e=B==="map",Ne=W==="map",Ze=B!=="viewport"&&f.layout.get("symbol-placement")!=="point",rt=$e&&!Ne&&!Ze,We=!f.layout.get("symbol-sort-key").isConstant();let it=!1;const lt=A.getDepthModeForSublayer(0,Ji.ReadOnly),Qe=f._unevaluatedLayout.hasValue("text-variable-anchor")||f._unevaluatedLayout.hasValue("text-variable-anchor-offset"),_t=[],Dt=ze.getCircleRadiusCorrection();for(const At of v){const Pt=l.getTile(At),It=Pt.getBucket(f);if(!It)continue;const Qt=w?It.text:It.icon;if(!Qt||!Qt.segments.get().length||!Qt.hasVisibleVertices)continue;const ti=Qt.programConfigurations.get(f.id),Xt=w||It.sdfIcons,oi=w?It.textSizeData:It.iconSizeData,Yi=Ne||ze.pitch!==0,Dn=A.useProgram(E0(Xt,w,It),ti),mr=s.ay(oi,ze.zoom),Qn=A.style.map.terrain&&A.style.map.terrain.getTerrainData(At);let xr,er,Br,wr,Es=[0,0],rs=null;if(w)er=Pt.glyphAtlasTexture,Br=Ee.LINEAR,xr=Pt.glyphAtlasTexture.size,It.iconsInText&&(Es=Pt.imageAtlasTexture.size,rs=Pt.imageAtlasTexture,wr=Yi||A.options.rotating||A.options.zooming||oi.kind==="composite"||oi.kind==="camera"?Ee.LINEAR:Ee.NEAREST);else{const or=f.layout.get("icon-size").constantOr(0)!==1||It.iconsNeedLinear;er=Pt.imageAtlasTexture,Br=Xt||A.options.rotating||A.options.zooming||or||Yi?Ee.LINEAR:Ee.NEAREST,xr=Pt.imageAtlasTexture.size}const Xr=s.aN(Pt,1,A.transform.zoom),Us=Wi($e,A.transform,Xr),Zc=s.N();s.aB(Zc,Us);const lc=wt(Ne,$e,A.transform,Xr),Sl=s.aO(ze,Pt,I,k),Co=ze.getProjectionData({overscaledTileID:At,applyGlobeMatrix:!le,applyTerrainMatrix:!0}),Hu=Qe&&It.hasTextData(),kf=f.layout.get("icon-text-fit")!=="none"&&Hu&&It.hasIconData();if(Ze){const or=A.style.map.terrain?(gs,_s)=>A.style.map.terrain.getElevation(At,gs,_s):null,tr=f.layout.get("text-rotation-alignment")==="map";Xi(It,A,w,Us,Zc,Ne,Z,tr,At.toUnwrapped(),ze.width,ze.height,Sl,or)}const Zu=w&&Qe||kf,pa=Ze||Zu?P_:Ne?Us:A.transform.clipSpaceToPixelsMatrix,Tl=Xt&&f.paint.get(w?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Va;Va=Xt?It.iconsInText?ka(oi.kind,mr,rt,Ne,Ze,Zu,A,pa,lc,Sl,xr,Es,Dt):Bu(oi.kind,mr,rt,Ne,Ze,Zu,A,pa,lc,Sl,w,xr,0,Dt):zu(oi.kind,mr,rt,Ne,Ze,Zu,A,pa,lc,Sl,w,xr,Dt);const Ua={program:Dn,buffers:Qt,uniformValues:Va,projectionData:Co,atlasTexture:er,atlasTextureIcon:rs,atlasInterpolation:Br,atlasInterpolationIcon:wr,isSDF:Xt,hasHalo:Tl};if(We&&It.canOverlap){it=!0;const or=Qt.segments.get();for(const tr of or)_t.push({segments:new s.aX([tr]),sortKey:tr.sortKey,state:Ua,terrainData:Qn})}else _t.push({segments:Qt.segments,sortKey:0,state:Ua,terrainData:Qn})}it&&_t.sort(((At,Pt)=>At.sortKey-Pt.sortKey));for(const At of _t){const Pt=At.state;if(_e.activeTexture.set(Ee.TEXTURE0),Pt.atlasTexture.bind(Pt.atlasInterpolation,Ee.CLAMP_TO_EDGE),Pt.atlasTextureIcon&&(_e.activeTexture.set(Ee.TEXTURE1),Pt.atlasTextureIcon&&Pt.atlasTextureIcon.bind(Pt.atlasInterpolationIcon,Ee.CLAMP_TO_EDGE)),Pt.isSDF){const It=Pt.uniformValues;Pt.hasHalo&&(It.u_is_halo=1,tm(Pt.buffers,At.segments,f,A,Pt.program,lt,J,ue,It,Pt.projectionData,At.terrainData)),It.u_is_halo=0}tm(Pt.buffers,At.segments,f,A,Pt.program,lt,J,ue,Pt.uniformValues,Pt.projectionData,At.terrainData)}}function tm(A,l,f,v,w,I,k,B,W,Z,J){const ue=v.context;w.draw(ue,ue.gl.TRIANGLES,I,k,B,_n.backCCW,W,J,Z,f.id,A.layoutVertexBuffer,A.indexBuffer,l,f.paint,v.transform.zoom,A.programConfigurations.get(f.id),A.dynamicLayoutVertexBuffer,A.opacityVertexBuffer)}function A0(A,l,f,v,w){const I=A.context,k=I.gl,B=bn.disabled,W=new Nn([k.ONE,k.ONE],s.bp.transparent,[!0,!0,!0,!0]),Z=l.getBucket(f);if(!Z)return;const J=v.key;let ue=f.heatmapFbos.get(J);ue||(ue=pf(I,l.tileSize,l.tileSize),f.heatmapFbos.set(J,ue)),I.bindFramebuffer.set(ue.framebuffer),I.viewport.set([0,0,l.tileSize,l.tileSize]),I.clear({color:s.bp.transparent});const le=Z.programConfigurations.get(f.id),_e=A.useProgram("heatmap",le,!w),Ee=A.transform.getProjectionData({overscaledTileID:l.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),ze=A.style.map.terrain.getTerrainData(v);_e.draw(I,k.TRIANGLES,Ji.disabled,B,W,_n.disabled,$c(l,A.transform.zoom,f.paint.get("heatmap-intensity"),1),ze,Ee,f.id,Z.layoutVertexBuffer,Z.indexBuffer,Z.segments,f.paint,A.transform.zoom,le)}function P0(A,l,f,v,w){const I=A.context,k=I.gl,B=A.transform;I.setColorMode(A.colorModeForRenderPass());const W=im(I,l),Z=f.key,J=l.heatmapFbos.get(Z);if(!J)return;I.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,J.colorAttachment.get()),I.activeTexture.set(k.TEXTURE1),W.bind(k.LINEAR,k.CLAMP_TO_EDGE);const ue=B.getProjectionData({overscaledTileID:f,applyTerrainMatrix:w,applyGlobeMatrix:!v});A.useProgram("heatmapTexture").draw(I,k.TRIANGLES,Ji.disabled,bn.disabled,A.colorModeForRenderPass(),_n.disabled,Gp(A,l,0,1),null,ue,l.id,A.rasterBoundsBuffer,A.quadTriangleIndexBuffer,A.rasterBoundsSegments,l.paint,B.zoom),J.destroy(),l.heatmapFbos.delete(Z)}function pf(A,l,f){var v,w;const I=A.gl,k=I.createTexture();I.bindTexture(I.TEXTURE_2D,k),I.texParameteri(I.TEXTURE_2D,I.TEXTURE_WRAP_S,I.CLAMP_TO_EDGE),I.texParameteri(I.TEXTURE_2D,I.TEXTURE_WRAP_T,I.CLAMP_TO_EDGE),I.texParameteri(I.TEXTURE_2D,I.TEXTURE_MIN_FILTER,I.LINEAR),I.texParameteri(I.TEXTURE_2D,I.TEXTURE_MAG_FILTER,I.LINEAR);const B=(v=A.HALF_FLOAT)!==null&&v!==void 0?v:I.UNSIGNED_BYTE,W=(w=A.RGBA16F)!==null&&w!==void 0?w:I.RGBA;I.texImage2D(I.TEXTURE_2D,0,W,l,f,0,I.RGBA,B,null);const Z=A.createFramebuffer(l,f,!1,!1);return Z.colorAttachment.set(k),Z}function im(A,l){return l.colorRampTexture||(l.colorRampTexture=new s.T(A,l.colorRamp,A.gl.RGBA)),l.colorRampTexture}function I0(A,l,f,v,w,I,k,B){let W=256;if(w.stepInterpolant){const Z=l.getSource().maxzoom,J=k.canonical.z===Z?Math.ceil(1<<A.transform.maxZoom-k.canonical.z):1;W=s.an(s.ce(I.maxLineLength/s.a5*1024*J),256,f.maxTextureSize)}return B.gradient=s.cf({expression:w.gradientExpression(),evaluationKey:"lineProgress",resolution:W,image:B.gradient||void 0,clips:I.lineClipsArray}),B.texture?B.texture.update(B.gradient):B.texture=new s.T(f,B.gradient,v.RGBA),B.version=w.gradientVersion,B.texture}function R0(A,l,f,v,w){A.activeTexture.set(l.TEXTURE0),f.imageAtlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE),v.updatePaintBuffers(w)}function Hr(A,l,f,v,w,I){(w||A.lineAtlas.dirty)&&(l.activeTexture.set(f.TEXTURE0),A.lineAtlas.bind(l)),v.updatePaintBuffers(I)}function Uu(A,l,f,v,w,I,k){const B=I.gradients[w.id];let W=B.texture;w.gradientVersion!==B.version&&(W=I0(A,l,f,v,w,I,k,B)),f.activeTexture.set(v.TEXTURE0),W.bind(w.stepInterpolant?v.NEAREST:v.LINEAR,v.CLAMP_TO_EDGE)}function Zo(A,l,f,v,w,I,k,B,W){const Z=I.gradients[w.id];let J=Z.texture;w.gradientVersion!==Z.version&&(J=I0(A,l,f,v,w,I,k,Z)),f.activeTexture.set(v.TEXTURE0),J.bind(w.stepInterpolant?v.NEAREST:v.LINEAR,v.CLAMP_TO_EDGE),f.activeTexture.set(v.TEXTURE1),A.lineAtlas.bind(f),B.updatePaintBuffers(W)}function nm(A,l,f,v,w){if(!f||!v||!v.imageAtlas)return;const I=v.imageAtlas.patternPositions;let k=I[f.to.toString()],B=I[f.from.toString()];if(!k&&B&&(k=B),!B&&k&&(B=k),!k||!B){const W=w.getPaintProperty(l);k=I[W],B=I[W]}k&&B&&A.setConstantPatternPositions(k,B)}function mf(A,l,f,v,w,I,k,B){const W=A.context.gl,Z="fill-pattern",J=f.paint.get(Z),ue=J&&J.constantOr(1),le=f.getCrossfadeParameters();let _e,Ee,ze,$e,Ne;const Ze=A.transform,rt=f.paint.get("fill-translate"),We=f.paint.get("fill-translate-anchor");k?(Ee=ue&&!f.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",_e=W.LINES):(Ee=ue?"fillPattern":"fill",_e=W.TRIANGLES);const it=J.constantOr(null);for(const lt of v){const Qe=l.getTile(lt);if(ue&&!Qe.patternsLoaded())continue;const _t=Qe.getBucket(f);if(!_t)continue;const Dt=_t.programConfigurations.get(f.id),At=A.useProgram(Ee,Dt),Pt=A.style.map.terrain&&A.style.map.terrain.getTerrainData(lt);ue&&(A.context.activeTexture.set(W.TEXTURE0),Qe.imageAtlasTexture.bind(W.LINEAR,W.CLAMP_TO_EDGE),Dt.updatePaintBuffers(le)),nm(Dt,Z,it,Qe,f);const It=Ze.getProjectionData({overscaledTileID:lt,applyGlobeMatrix:!B,applyTerrainMatrix:!0}),Qt=s.aO(Ze,Qe,rt,We);if(k){$e=_t.indexBuffer2,Ne=_t.segments2;const Xt=[W.drawingBufferWidth,W.drawingBufferHeight];ze=Ee==="fillOutlinePattern"&&ue?Up(A,le,Qe,Xt,Qt):lf(Xt,Qt)}else $e=_t.indexBuffer,Ne=_t.segments,ze=ue?ku(A,le,Qe,Qt):{u_fill_translate:Qt};const ti=A.stencilModeForClipping(lt);At.draw(A.context,_e,w,ti,I,_n.backCCW,ze,Pt,It,f.id,_t.layoutVertexBuffer,$e,Ne,f.paint,A.transform.zoom,Dt)}}function rm(A,l,f,v,w,I,k,B){const W=A.context,Z=W.gl,J="fill-extrusion-pattern",ue=f.paint.get(J),le=ue.constantOr(1),_e=f.getCrossfadeParameters(),Ee=f.paint.get("fill-extrusion-opacity"),ze=ue.constantOr(null),$e=A.transform;for(const Ne of v){const Ze=l.getTile(Ne),rt=Ze.getBucket(f);if(!rt)continue;const We=A.style.map.terrain&&A.style.map.terrain.getTerrainData(Ne),it=rt.programConfigurations.get(f.id),lt=A.useProgram(le?"fillExtrusionPattern":"fillExtrusion",it);le&&(A.context.activeTexture.set(Z.TEXTURE0),Ze.imageAtlasTexture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE),it.updatePaintBuffers(_e));const Qe=$e.getProjectionData({overscaledTileID:Ne,applyGlobeMatrix:!B,applyTerrainMatrix:!0});nm(it,J,ze,Ze,f);const _t=s.aO($e,Ze,f.paint.get("fill-extrusion-translate"),f.paint.get("fill-extrusion-translate-anchor")),Dt=f.paint.get("fill-extrusion-vertical-gradient"),At=le?xl(A,Dt,Ee,_t,Ne,_e,Ze):af(A,Dt,Ee,_t);lt.draw(W,W.gl.TRIANGLES,w,I,k,_n.backCCW,At,We,Qe,f.id,rt.layoutVertexBuffer,rt.indexBuffer,rt.segments,f.paint,A.transform.zoom,it,A.style.map.terrain&&rt.centroidVertexBuffer)}}function Gc(A,l,f,v,w,I,k,B,W){var Z;const J=A.style.projection,ue=A.context,le=A.transform,_e=ue.gl,Ee=[`#define NUM_ILLUMINATION_SOURCES ${f.paint.get("hillshade-highlight-color").values.length}`],ze=A.useProgram("hillshade",null,!1,Ee),$e=!A.options.moving;for(const Ne of v){const Ze=l.getTile(Ne),rt=Ze.fbo;if(!rt)continue;const We=J.getMeshFromTileID(ue,Ne.canonical,B,!0,"raster"),it=(Z=A.style.map.terrain)===null||Z===void 0?void 0:Z.getTerrainData(Ne);ue.activeTexture.set(_e.TEXTURE0),_e.bindTexture(_e.TEXTURE_2D,rt.colorAttachment.get());const lt=le.getProjectionData({overscaledTileID:Ne,aligned:$e,applyGlobeMatrix:!W,applyTerrainMatrix:!0});ze.draw(ue,_e.TRIANGLES,I,w[Ne.overscaledZ],k,_n.backCCW,Gh(A,Ze,f),it,lt,f.id,We.vertexBuffer,We.indexBuffer,We.segments)}}function gf(A,l,f,v,w,I,k,B,W){var Z;const J=A.style.projection,ue=A.context,le=A.transform,_e=ue.gl,Ee=A.useProgram("colorRelief"),ze=!A.options.moving;let $e=!0,Ne=0;for(const Ze of v){const rt=l.getTile(Ze),We=rt.dem;if($e){const At=_e.getParameter(_e.MAX_TEXTURE_SIZE),{elevationTexture:Pt,colorTexture:It}=f.getColorRampTextures(ue,At,We.getUnpackVector());ue.activeTexture.set(_e.TEXTURE1),Pt.bind(_e.NEAREST,_e.CLAMP_TO_EDGE),ue.activeTexture.set(_e.TEXTURE4),It.bind(_e.LINEAR,_e.CLAMP_TO_EDGE),$e=!1,Ne=Pt.size[0]}if(!We||!We.data)continue;const it=We.stride,lt=We.getPixels();if(ue.activeTexture.set(_e.TEXTURE0),ue.pixelStoreUnpackPremultiplyAlpha.set(!1),rt.demTexture=rt.demTexture||A.getTileTexture(it),rt.demTexture){const At=rt.demTexture;At.update(lt,{premultiply:!1}),At.bind(_e.LINEAR,_e.CLAMP_TO_EDGE)}else rt.demTexture=new s.T(ue,lt,_e.RGBA,{premultiply:!1}),rt.demTexture.bind(_e.LINEAR,_e.CLAMP_TO_EDGE);const Qe=J.getMeshFromTileID(ue,Ze.canonical,B,!0,"raster"),_t=(Z=A.style.map.terrain)===null||Z===void 0?void 0:Z.getTerrainData(Ze),Dt=le.getProjectionData({overscaledTileID:Ze,aligned:ze,applyGlobeMatrix:!W,applyTerrainMatrix:!0});Ee.draw(ue,_e.TRIANGLES,I,w[Ze.overscaledZ],k,_n.backCCW,qp(f,rt.dem,Ne),_t,Dt,f.id,Qe.vertexBuffer,Qe.indexBuffer,Qe.segments)}}const ju=[new s.P(0,0),new s.P(s.a5,0),new s.P(s.a5,s.a5),new s.P(0,s.a5)];function Kh(A,l,f,v,w,I,k,B,W=!1,Z=!1){const J=v[v.length-1].overscaledZ,ue=A.context,le=ue.gl,_e=A.useProgram("raster"),Ee=A.transform,ze=A.style.projection,$e=A.colorModeForRenderPass(),Ne=!A.options.moving,Ze=f.paint.get("raster-opacity"),rt=f.paint.get("raster-resampling"),We=f.paint.get("raster-fade-duration"),it=!!A.style.map.terrain;for(const lt of v){const Qe=A.getDepthModeForSublayer(lt.overscaledZ-J,Ze===1?Ji.ReadWrite:Ji.ReadOnly,le.LESS),_t=l.getTile(lt),Dt=rt==="nearest"?le.NEAREST:le.LINEAR;ue.activeTexture.set(le.TEXTURE0),_t.texture.bind(Dt,le.CLAMP_TO_EDGE,le.LINEAR_MIPMAP_NEAREST),ue.activeTexture.set(le.TEXTURE1);const{parentTile:At,parentScaleBy:Pt,parentTopLeft:It,fadeValues:Qt}=L0(_t,l,We,it);_t.fadeOpacity=Qt.tileOpacity,At?(At.fadeOpacity=Qt.parentTileOpacity,At.texture.bind(Dt,le.CLAMP_TO_EDGE,le.LINEAR_MIPMAP_NEAREST)):_t.texture.bind(Dt,le.CLAMP_TO_EDGE,le.LINEAR_MIPMAP_NEAREST),_t.texture.useMipmap&&ue.extTextureFilterAnisotropic&&A.transform.pitch>20&&le.texParameterf(le.TEXTURE_2D,ue.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,ue.extTextureFilterAnisotropicMax);const ti=A.style.map.terrain&&A.style.map.terrain.getTerrainData(lt),Xt=Ee.getProjectionData({overscaledTileID:lt,aligned:Ne,applyGlobeMatrix:!Z,applyTerrainMatrix:!0}),oi=La(It,Pt,Qt.fadeMix,f,B),Yi=ze.getMeshFromTileID(ue,lt.canonical,I,k,"raster");_e.draw(ue,le.TRIANGLES,Qe,w?w[lt.overscaledZ]:bn.disabled,$e,W?_n.frontCCW:_n.backCCW,oi,ti,Xt,f.id,Yi.vertexBuffer,Yi.indexBuffer,Yi.segments)}}function L0(A,l,f,v){const w={parentTile:null,parentScaleBy:1,parentTopLeft:[0,0],fadeValues:{tileOpacity:1,parentTileOpacity:1,fadeMix:{opacity:1,mix:0}}};if(f===0||v)return w;if(A.fadingParentID){const I=l.getLoadedTile(A.fadingParentID);if(!I)return w;const k=Math.pow(2,I.tileID.overscaledZ-A.tileID.overscaledZ),B=[A.tileID.canonical.x*k%1,A.tileID.canonical.y*k%1],W=(function(Z,J,ue){const le=P(),_e=(le-J.timeAdded)/ue,Ee=Z.fadingDirection===St.Incoming,ze=s.an((le-Z.timeAdded)/ue,0,1),$e=s.an(1-_e,0,1),Ne=Ee?ze:$e;return{tileOpacity:Ne,parentTileOpacity:Ee?$e:ze,fadeMix:{opacity:1,mix:1-Ne}}})(A,I,f);return{parentTile:I,parentScaleBy:k,parentTopLeft:B,fadeValues:W}}if(A.selfFading){const I=(function(k,B){const W=(P()-k.timeAdded)/B,Z=s.an(W,0,1);return{tileOpacity:Z,fadeMix:{opacity:Z,mix:0}}})(A,f);return{parentTile:null,parentScaleBy:1,parentTopLeft:[0,0],fadeValues:I}}return w}const k0=new s.bp(1,0,0,1),D0=new s.bp(0,1,0,1),F0=new s.bp(0,0,1,1),O0=new s.bp(1,0,1,1),qc=new s.bp(0,1,1,1);function I_(A,l,f,v){_f(A,0,l+f/2,A.transform.width,f,v)}function R_(A,l,f,v){_f(A,l-f/2,0,f,A.transform.height,v)}function _f(A,l,f,v,w,I){const k=A.context,B=k.gl;B.enable(B.SCISSOR_TEST),B.scissor(l*A.pixelRatio,f*A.pixelRatio,v*A.pixelRatio,w*A.pixelRatio),k.clear({color:I}),B.disable(B.SCISSOR_TEST)}function z0(A,l,f){const v=A.context,w=v.gl,I=A.useProgram("debug"),k=Ji.disabled,B=bn.disabled,W=A.colorModeForRenderPass(),Z="$debug",J=A.style.map.terrain&&A.style.map.terrain.getTerrainData(f);v.activeTexture.set(w.TEXTURE0);const ue=l.getTileByID(f.key).latestRawTileData,le=Math.floor((ue&&ue.byteLength||0)/1024),_e=l.getTile(f).tileSize,Ee=512/Math.min(_e,512)*(f.overscaledZ/A.transform.zoom)*.5;let ze=f.canonical.toString();f.overscaledZ!==f.canonical.z&&(ze+=` => ${f.overscaledZ}`),(function(Ne,Ze){Ne.initDebugOverlayCanvas();const rt=Ne.debugOverlayCanvas,We=Ne.context.gl,it=Ne.debugOverlayCanvas.getContext("2d");it.clearRect(0,0,rt.width,rt.height),it.shadowColor="white",it.shadowBlur=2,it.lineWidth=1.5,it.strokeStyle="white",it.textBaseline="top",it.font="bold 36px Open Sans, sans-serif",it.fillText(Ze,5,5),it.strokeText(Ze,5,5),Ne.debugOverlayTexture.update(rt),Ne.debugOverlayTexture.bind(We.LINEAR,We.CLAMP_TO_EDGE)})(A,`${ze} ${le}kB`);const $e=A.transform.getProjectionData({overscaledTileID:f,applyGlobeMatrix:!0,applyTerrainMatrix:!0});I.draw(v,w.TRIANGLES,k,B,Nn.alphaBlended,_n.disabled,Ra(s.bp.transparent,Ee),null,$e,Z,A.debugBuffer,A.quadTriangleIndexBuffer,A.debugSegments),I.draw(v,w.LINE_STRIP,k,B,W,_n.disabled,Ra(s.bp.red),J,$e,Z,A.debugBuffer,A.tileBorderIndexBuffer,A.debugSegments)}function L_(A,l,f,v){const{isRenderingGlobe:w}=v,I=A.context,k=I.gl,B=A.transform,W=A.colorModeForRenderPass(),Z=A.getDepthModeFor3D(),J=A.useProgram("terrain");I.bindFramebuffer.set(null),I.viewport.set([0,0,A.width,A.height]);for(const ue of f){const le=l.getTerrainMesh(ue.tileID),_e=A.renderToTexture.getTexture(ue),Ee=l.getTerrainData(ue.tileID);I.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,_e.texture);const ze=l.getMeshFrameDelta(B.zoom),$e=B.calculateFogMatrix(ue.tileID.toUnwrapped()),Ne=w_(ze,$e,A.style.sky,B.pitch,w),Ze=B.getProjectionData({overscaledTileID:ue.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});J.draw(I,k.TRIANGLES,Z,bn.disabled,W,_n.backCCW,Ne,Ee,Ze,"terrain",le.vertexBuffer,le.indexBuffer,le.segments)}}function k_(A,l){if(!l.mesh){const f=new s.aW;f.emplaceBack(-1,-1),f.emplaceBack(1,-1),f.emplaceBack(1,1),f.emplaceBack(-1,1);const v=new s.aY;v.emplaceBack(0,1,2),v.emplaceBack(0,2,3),l.mesh=new Bn(A.createVertexBuffer(f,Ma.members),A.createIndexBuffer(v),s.aX.simpleSegment(0,0,f.length,v.length))}return l.mesh}class B0{constructor(l,f){this.context=new em(l),this.transform=f,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:s.ar(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=Ci.maxOverzooming+Ci.maxUnderzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Ns}resize(l,f,v){if(this.width=Math.floor(l*v),this.height=Math.floor(f*v),this.pixelRatio=v,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const w of this.style._order)this.style._layers[w].resize()}setup(){const l=this.context,f=new s.aW;f.emplaceBack(0,0),f.emplaceBack(s.a5,0),f.emplaceBack(0,s.a5),f.emplaceBack(s.a5,s.a5),this.tileExtentBuffer=l.createVertexBuffer(f,Ma.members),this.tileExtentSegments=s.aX.simpleSegment(0,0,4,2);const v=new s.aW;v.emplaceBack(0,0),v.emplaceBack(s.a5,0),v.emplaceBack(0,s.a5),v.emplaceBack(s.a5,s.a5),this.debugBuffer=l.createVertexBuffer(v,Ma.members),this.debugSegments=s.aX.simpleSegment(0,0,4,5);const w=new s.ch;w.emplaceBack(0,0,0,0),w.emplaceBack(s.a5,0,s.a5,0),w.emplaceBack(0,s.a5,0,s.a5),w.emplaceBack(s.a5,s.a5,s.a5,s.a5),this.rasterBoundsBuffer=l.createVertexBuffer(w,x_.members),this.rasterBoundsSegments=s.aX.simpleSegment(0,0,4,2);const I=new s.aW;I.emplaceBack(0,0),I.emplaceBack(s.a5,0),I.emplaceBack(0,s.a5),I.emplaceBack(s.a5,s.a5),this.rasterBoundsBufferPosOnly=l.createVertexBuffer(I,Ma.members),this.rasterBoundsSegmentsPosOnly=s.aX.simpleSegment(0,0,4,5);const k=new s.aW;k.emplaceBack(0,0),k.emplaceBack(1,0),k.emplaceBack(0,1),k.emplaceBack(1,1),this.viewportBuffer=l.createVertexBuffer(k,Ma.members),this.viewportSegments=s.aX.simpleSegment(0,0,4,2);const B=new s.ci;B.emplaceBack(0),B.emplaceBack(1),B.emplaceBack(3),B.emplaceBack(2),B.emplaceBack(0),this.tileBorderIndexBuffer=l.createIndexBuffer(B);const W=new s.aY;W.emplaceBack(1,0,2),W.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=l.createIndexBuffer(W);const Z=this.context.gl;this.stencilClearMode=new bn({func:Z.ALWAYS,mask:0},0,255,Z.ZERO,Z.ZERO,Z.ZERO),this.tileExtentMesh=new Bn(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const l=this.context,f=l.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const v=s.N();s.c7(v,0,this.width,this.height,0,0,1),s.Q(v,v,[f.drawingBufferWidth,f.drawingBufferHeight,0]);const w={mainMatrix:v,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:v};this.useProgram("clippingMask",null,!0).draw(l,f.TRIANGLES,Ji.disabled,this.stencilClearMode,Nn.disabled,_n.disabled,null,null,w,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(l,f,v){if(this.currentStencilSource===l.source||!l.isTileClipped()||!f||!f.length)return;this.currentStencilSource=l.source,this.nextStencilID+f.length>256&&this.clearStencil();const w=this.context;w.setColorMode(Nn.disabled),w.setDepthMode(Ji.disabled);const I={};for(const k of f)I[k.key]=this.nextStencilID++;this._renderTileMasks(I,f,v,!0),this._renderTileMasks(I,f,v,!1),this._tileClippingMaskIDs=I}_renderTileMasks(l,f,v,w){const I=this.context,k=I.gl,B=this.style.projection,W=this.transform,Z=this.useProgram("clippingMask");for(const J of f){const ue=l[J.key],le=this.style.map.terrain&&this.style.map.terrain.getTerrainData(J),_e=B.getMeshFromTileID(this.context,J.canonical,w,!0,"stencil"),Ee=W.getProjectionData({overscaledTileID:J,applyGlobeMatrix:!v,applyTerrainMatrix:!0});Z.draw(I,k.TRIANGLES,Ji.disabled,new bn({func:k.ALWAYS,mask:0},ue,255,k.KEEP,k.KEEP,k.REPLACE),Nn.disabled,v?_n.disabled:_n.backCCW,null,le,Ee,"$clipping",_e.vertexBuffer,_e.indexBuffer,_e.segments)}}_renderTilesDepthBuffer(){const l=this.context,f=l.gl,v=this.style.projection,w=this.transform,I=this.useProgram("depth"),k=this.getDepthModeFor3D(),B=kn(w,{tileSize:w.tileSize});for(const W of B){const Z=this.style.map.terrain&&this.style.map.terrain.getTerrainData(W),J=v.getMeshFromTileID(this.context,W.canonical,!0,!0,"raster"),ue=w.getProjectionData({overscaledTileID:W,applyGlobeMatrix:!0,applyTerrainMatrix:!0});I.draw(l,f.TRIANGLES,k,bn.disabled,Nn.disabled,_n.backCCW,null,Z,ue,"$clipping",J.vertexBuffer,J.indexBuffer,J.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const l=this.nextStencilID++,f=this.context.gl;return new bn({func:f.NOTEQUAL,mask:255},l,255,f.KEEP,f.KEEP,f.REPLACE)}stencilModeForClipping(l){const f=this.context.gl;return new bn({func:f.EQUAL,mask:255},this._tileClippingMaskIDs[l.key],0,f.KEEP,f.KEEP,f.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(l){const f=this.context.gl,v=l.sort(((k,B)=>B.overscaledZ-k.overscaledZ)),w=v[v.length-1].overscaledZ,I=v[0].overscaledZ-w+1;if(I>1){this.currentStencilSource=void 0,this.nextStencilID+I>256&&this.clearStencil();const k={};for(let B=0;B<I;B++)k[B+w]=new bn({func:f.GEQUAL,mask:255},B+this.nextStencilID,255,f.KEEP,f.KEEP,f.REPLACE);return this.nextStencilID+=I,[k,v]}return[{[w]:bn.disabled},v]}stencilConfigForOverlapTwoPass(l){const f=this.context.gl,v=l.sort(((k,B)=>B.overscaledZ-k.overscaledZ)),w=v[v.length-1].overscaledZ,I=v[0].overscaledZ-w+1;if(this.clearStencil(),I>1){const k={},B={};for(let W=0;W<I;W++)k[W+w]=new bn({func:f.GREATER,mask:255},I+1+W,255,f.KEEP,f.KEEP,f.REPLACE),B[W+w]=new bn({func:f.GREATER,mask:255},1+W,255,f.KEEP,f.KEEP,f.REPLACE);return this.nextStencilID=2*I+1,[k,B,v]}return this.nextStencilID=3,[{[w]:new bn({func:f.GREATER,mask:255},2,255,f.KEEP,f.KEEP,f.REPLACE)},{[w]:new bn({func:f.GREATER,mask:255},1,255,f.KEEP,f.KEEP,f.REPLACE)},v]}colorModeForRenderPass(){const l=this.context.gl;return this._showOverdrawInspector?new Nn([l.CONSTANT_COLOR,l.ONE],new s.bp(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Nn.unblended:Nn.alphaBlended}getDepthModeForSublayer(l,f,v){if(!this.opaquePassEnabledForLayer())return Ji.disabled;const w=1-((1+this.currentLayer)*this.numSublayers+l)*this.depthEpsilon;return new Ji(v||this.context.gl.LEQUAL,f,[w,w])}getDepthModeFor3D(){return new Ji(this.context.gl.LEQUAL,Ji.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(l,f){var v,w;this.style=l,this.options=f,this.lineAtlas=l.lineAtlas,this.imageManager=l.imageManager,this.glyphManager=l.glyphManager,this.symbolFadeChange=l.placement.symbolFadeChange(P()),this.imageManager.beginFrame();const I=this.style._order,k=this.style.tileManagers,B={},W={},Z={},J={isRenderingToTexture:!1,isRenderingGlobe:((v=l.projection)===null||v===void 0?void 0:v.transitionState)>0};for(const le in k){const _e=k[le];_e.used&&_e.prepare(this.context),B[le]=_e.getVisibleCoordinates(!1),W[le]=B[le].slice().reverse(),Z[le]=_e.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let le=0;le<I.length;le++)if(this.style._layers[I[le]].is3D()){this.opaquePassCutoff=le;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const le of I){const _e=this.style._layers[le];if(!_e.hasOffscreenPass()||_e.isHidden(this.transform.zoom))continue;const Ee=W[_e.source];(_e.type==="custom"||Ee.length)&&this.renderLayer(this,k[_e.source],_e,Ee,J)}if((w=this.style.projection)===null||w===void 0||w.updateGPUdependent({context:this.context,useProgram:le=>this.useProgram(le)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:f.showOverdrawInspector?s.bp.black:s.bp.transparent,depth:1}),this.clearStencil(),this.style.sky&&(function(le,_e){const Ee=le.context,ze=Ee.gl,$e=((lt,Qe,_t)=>{const Dt=Math.cos(Qe.rollInRadians),At=Math.sin(Qe.rollInRadians),Pt=un(Qe),It=Qe.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:lt.properties.get("sky-color"),u_horizon_color:lt.properties.get("horizon-color"),u_horizon:[(Qe.width/2-Pt*At)*_t,(Qe.height/2+Pt*Dt)*_t],u_horizon_normal:[-At,Dt],u_sky_horizon_blend:lt.properties.get("sky-horizon-blend")*Qe.height/2*_t,u_sky_blend:It}})(_e,le.style.map.transform,le.pixelRatio),Ne=new Ji(ze.LEQUAL,Ji.ReadWrite,[0,1]),Ze=bn.disabled,rt=le.colorModeForRenderPass(),We=le.useProgram("sky"),it=k_(Ee,_e);We.draw(Ee,ze.TRIANGLES,Ne,Ze,rt,_n.disabled,$e,null,void 0,"sky",it.vertexBuffer,it.indexBuffer,it.segments)})(this,this.style.sky),this._showOverdrawInspector=f.showOverdrawInspector,this.depthRangeFor3D=[0,1-(l._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=I.length-1;this.currentLayer>=0;this.currentLayer--){const le=this.style._layers[I[this.currentLayer]],_e=k[le.source],Ee=B[le.source];this._renderTileClippingMasks(le,Ee,!1),this.renderLayer(this,_e,le,Ee,J)}this.renderPass="translucent";let ue=!1;for(this.currentLayer=0;this.currentLayer<I.length;this.currentLayer++){const le=this.style._layers[I[this.currentLayer]],_e=k[le.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(le,J))continue;this.opaquePassEnabledForLayer()||ue||(ue=!0,J.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const Ee=(le.type==="symbol"?Z:W)[le.source];this._renderTileClippingMasks(le,B[le.source],!!this.renderToTexture),this.renderLayer(this,_e,le,Ee,J)}if(J.isRenderingGlobe&&(function(le,_e,Ee){const ze=le.context,$e=ze.gl,Ne=le.useProgram("atmosphere"),Ze=new Ji($e.LEQUAL,Ji.ReadOnly,[0,1]),rt=le.transform,We=(function(It,Qt){const ti=It.properties.get("position"),Xt=[-ti.x,-ti.y,-ti.z],oi=s.ar(new Float64Array(16));return It.properties.get("anchor")==="map"&&(s.bg(oi,oi,Qt.rollInRadians),s.bh(oi,oi,-Qt.pitchInRadians),s.bg(oi,oi,Qt.bearingInRadians),s.bh(oi,oi,Qt.center.lat*Math.PI/180),s.bJ(oi,oi,-Qt.center.lng*Math.PI/180)),s.cg(Xt,Xt,oi),Xt})(Ee,le.transform),it=rt.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),lt=_e.properties.get("atmosphere-blend")*it.projectionTransition;if(lt===0)return;const Qe=ec(rt.worldSize,rt.center.lat),_t=rt.inverseProjectionMatrix,Dt=new Float64Array(4);Dt[3]=1,s.aH(Dt,Dt,rt.modelViewProjectionMatrix),Dt[0]/=Dt[3],Dt[1]/=Dt[3],Dt[2]/=Dt[3],Dt[3]=1,s.aH(Dt,Dt,_t),Dt[0]/=Dt[3],Dt[1]/=Dt[3],Dt[2]/=Dt[3],Dt[3]=1;const At=((It,Qt,ti,Xt,oi)=>({u_sun_pos:It,u_atmosphere_blend:Qt,u_globe_position:ti,u_globe_radius:Xt,u_inv_proj_matrix:oi}))(We,lt,[Dt[0],Dt[1],Dt[2]],Qe,_t),Pt=k_(ze,_e);Ne.draw(ze,$e.TRIANGLES,Ze,bn.disabled,Nn.alphaBlended,_n.disabled,At,null,null,"atmosphere",Pt.vertexBuffer,Pt.indexBuffer,Pt.segments)})(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const le=(function(_e,Ee){let ze=null;const $e=Object.values(_e._layers).flatMap((We=>We.source&&!We.isHidden(Ee)?[_e.tileManagers[We.source]]:[])),Ne=$e.filter((We=>We.getSource().type==="vector")),Ze=$e.filter((We=>We.getSource().type!=="vector")),rt=We=>{(!ze||ze.getSource().maxzoom<We.getSource().maxzoom)&&(ze=We)};return Ne.forEach((We=>rt(We))),ze||Ze.forEach((We=>rt(We))),ze})(this.style,this.transform.zoom);le&&(function(_e,Ee,ze){for(let $e=0;$e<ze.length;$e++)z0(_e,Ee,ze[$e])})(this,le,le.getVisibleCoordinates())}this.options.showPadding&&(function(le){const _e=le.transform.padding;I_(le,le.transform.height-(_e.top||0),3,k0),I_(le,_e.bottom||0,3,D0),R_(le,_e.left||0,3,F0),R_(le,le.transform.width-(_e.right||0),3,O0);const Ee=le.transform.centerPoint;(function(ze,$e,Ne,Ze){_f(ze,$e-1,Ne-10,2,20,Ze),_f(ze,$e-10,Ne-1,20,2,Ze)})(le,Ee.x,le.transform.height-Ee.y,qc)})(this),this.context.setDefault()}maybeDrawDepthAndCoords(l){if(!this.style||!this.style.map||!this.style.map.terrain)return;const f=this.terrainFacilitator.matrix,v=this.transform.modelViewProjectionMatrix;let w=this.terrainFacilitator.dirty;w||(w=l?!s.cj(f,v):!s.ck(f,v)),w||(w=this.style.map.terrain.tileManager.anyTilesAfterTime(this.terrainFacilitator.renderTime)),w&&(s.cl(f,v),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,(function(I,k){const B=I.context,W=B.gl,Z=I.transform,J=Nn.unblended,ue=new Ji(W.LEQUAL,Ji.ReadWrite,[0,1]),le=k.tileManager.getRenderableTiles(),_e=I.useProgram("terrainDepth");B.bindFramebuffer.set(k.getFramebuffer("depth").framebuffer),B.viewport.set([0,0,I.width/devicePixelRatio,I.height/devicePixelRatio]),B.clear({color:s.bp.transparent,depth:1});for(const Ee of le){const ze=k.getTerrainMesh(Ee.tileID),$e=k.getTerrainData(Ee.tileID),Ne=Z.getProjectionData({overscaledTileID:Ee.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),Ze={u_ele_delta:k.getMeshFrameDelta(Z.zoom)};_e.draw(B,W.TRIANGLES,ue,bn.disabled,J,_n.backCCW,Ze,$e,Ne,"terrain",ze.vertexBuffer,ze.indexBuffer,ze.segments)}B.bindFramebuffer.set(null),B.viewport.set([0,0,I.width,I.height])})(this,this.style.map.terrain),(function(I,k){const B=I.context,W=B.gl,Z=I.transform,J=Nn.unblended,ue=new Ji(W.LEQUAL,Ji.ReadWrite,[0,1]),le=k.getCoordsTexture(),_e=k.tileManager.getRenderableTiles(),Ee=I.useProgram("terrainCoords");B.bindFramebuffer.set(k.getFramebuffer("coords").framebuffer),B.viewport.set([0,0,I.width/devicePixelRatio,I.height/devicePixelRatio]),B.clear({color:s.bp.transparent,depth:1}),k.coordsIndex=[];for(const ze of _e){const $e=k.getTerrainMesh(ze.tileID),Ne=k.getTerrainData(ze.tileID);B.activeTexture.set(W.TEXTURE0),W.bindTexture(W.TEXTURE_2D,le.texture);const Ze={u_terrain_coords_id:(255-k.coordsIndex.length)/255,u_texture:0,u_ele_delta:k.getMeshFrameDelta(Z.zoom)},rt=Z.getProjectionData({overscaledTileID:ze.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});Ee.draw(B,W.TRIANGLES,ue,bn.disabled,J,_n.backCCW,Ze,Ne,rt,"terrain",$e.vertexBuffer,$e.indexBuffer,$e.segments),k.coordsIndex.push(ze.tileID.key)}B.bindFramebuffer.set(null),B.viewport.set([0,0,I.width,I.height])})(this,this.style.map.terrain))}renderLayer(l,f,v,w,I){v.isHidden(this.transform.zoom)||(v.type==="background"||v.type==="custom"||(w||[]).length)&&(this.id=v.id,s.cm(v)?(function(k,B,W,Z,J,ue){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:le}=ue,_e=bn.disabled,Ee=k.colorModeForRenderPass();(W._unevaluatedLayout.hasValue("text-variable-anchor")||W._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&(function(ze,$e,Ne,Ze,rt,We,it,lt,Qe){const _t=$e.transform,Dt=$e.style.map.terrain,At=rt==="map",Pt=We==="map";for(const It of ze){const Qt=Ze.getTile(It),ti=Qt.getBucket(Ne);if(!ti||!ti.text||!ti.text.segments.get().length)continue;const Xt=s.ay(ti.textSizeData,_t.zoom),oi=s.aN(Qt,1,$e.transform.zoom),Yi=Wi(At,$e.transform,oi),Dn=Ne.layout.get("icon-text-fit")!=="none"&&ti.hasIconData();if(Xt){const mr=Math.pow(2,_t.zoom-Qt.tileID.overscaledZ),Qn=Dt?(xr,er)=>Dt.getElevation(It,xr,er):null;L1(ti,At,Pt,Qe,_t,Yi,mr,Xt,Dn,s.aO(_t,Qt,it,lt),It.toUnwrapped(),Qn)}}})(Z,k,W,B,W.layout.get("text-rotation-alignment"),W.layout.get("text-pitch-alignment"),W.paint.get("text-translate"),W.paint.get("text-translate-anchor"),J),W.paint.get("icon-opacity").constantOr(1)!==0&&ff(k,B,W,Z,!1,W.paint.get("icon-translate"),W.paint.get("icon-translate-anchor"),W.layout.get("icon-rotation-alignment"),W.layout.get("icon-pitch-alignment"),W.layout.get("icon-keep-upright"),_e,Ee,le),W.paint.get("text-opacity").constantOr(1)!==0&&ff(k,B,W,Z,!0,W.paint.get("text-translate"),W.paint.get("text-translate-anchor"),W.layout.get("text-rotation-alignment"),W.layout.get("text-pitch-alignment"),W.layout.get("text-keep-upright"),_e,Ee,le),B.map.showCollisionBoxes&&(Vu(k,B,W,Z,!0),Vu(k,B,W,Z,!1))})(l,f,v,w,this.style.placement.variableOffsets,I):s.cn(v)?(function(k,B,W,Z,J){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:ue}=J,le=W.paint.get("circle-opacity"),_e=W.paint.get("circle-stroke-width"),Ee=W.paint.get("circle-stroke-opacity"),ze=!W.layout.get("circle-sort-key").isConstant();if(le.constantOr(1)===0&&(_e.constantOr(1)===0||Ee.constantOr(1)===0))return;const $e=k.context,Ne=$e.gl,Ze=k.transform,rt=k.getDepthModeForSublayer(0,Ji.ReadOnly),We=bn.disabled,it=k.colorModeForRenderPass(),lt=[],Qe=Ze.getCircleRadiusCorrection();for(let _t=0;_t<Z.length;_t++){const Dt=Z[_t],At=B.getTile(Dt),Pt=At.getBucket(W);if(!Pt)continue;const It=W.paint.get("circle-translate"),Qt=W.paint.get("circle-translate-anchor"),ti=s.aO(Ze,At,It,Qt),Xt=Pt.programConfigurations.get(W.id),oi=k.useProgram("circle",Xt),Yi=Pt.layoutVertexBuffer,Dn=Pt.indexBuffer,mr=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Dt),Qn={programConfiguration:Xt,program:oi,layoutVertexBuffer:Yi,indexBuffer:Dn,uniformValues:jp(k,At,W,ti,Qe),terrainData:mr,projectionData:Ze.getProjectionData({overscaledTileID:Dt,applyGlobeMatrix:!ue,applyTerrainMatrix:!0})};if(ze){const xr=Pt.segments.get();for(const er of xr)lt.push({segments:new s.aX([er]),sortKey:er.sortKey,state:Qn})}else lt.push({segments:Pt.segments,sortKey:0,state:Qn})}ze&&lt.sort(((_t,Dt)=>_t.sortKey-Dt.sortKey));for(const _t of lt){const{programConfiguration:Dt,program:At,layoutVertexBuffer:Pt,indexBuffer:It,uniformValues:Qt,terrainData:ti,projectionData:Xt}=_t.state;At.draw($e,Ne.TRIANGLES,rt,We,it,_n.backCCW,Qt,ti,Xt,W.id,Pt,It,_t.segments,W.paint,k.transform.zoom,Dt)}})(l,f,v,w,I):s.co(v)?(function(k,B,W,Z,J){if(W.paint.get("heatmap-opacity")===0)return;const ue=k.context,{isRenderingToTexture:le,isRenderingGlobe:_e}=J;if(k.style.map.terrain){for(const Ee of Z){const ze=B.getTile(Ee);B.hasRenderableParent(Ee)||(k.renderPass==="offscreen"?A0(k,ze,W,Ee,_e):k.renderPass==="translucent"&&P0(k,W,Ee,le,_e))}ue.viewport.set([0,0,k.width,k.height])}else k.renderPass==="offscreen"?(function(Ee,ze,$e,Ne){const Ze=Ee.context,rt=Ze.gl,We=Ee.transform,it=bn.disabled,lt=new Nn([rt.ONE,rt.ONE],s.bp.transparent,[!0,!0,!0,!0]);(function(Qe,_t,Dt){const At=Qe.gl;Qe.activeTexture.set(At.TEXTURE1),Qe.viewport.set([0,0,_t.width/4,_t.height/4]);let Pt=Dt.heatmapFbos.get(s.cd);Pt?(At.bindTexture(At.TEXTURE_2D,Pt.colorAttachment.get()),Qe.bindFramebuffer.set(Pt.framebuffer)):(Pt=pf(Qe,_t.width/4,_t.height/4),Dt.heatmapFbos.set(s.cd,Pt))})(Ze,Ee,$e),Ze.clear({color:s.bp.transparent});for(let Qe=0;Qe<Ne.length;Qe++){const _t=Ne[Qe];if(ze.hasRenderableParent(_t))continue;const Dt=ze.getTile(_t),At=Dt.getBucket($e);if(!At)continue;const Pt=At.programConfigurations.get($e.id),It=Ee.useProgram("heatmap",Pt),Qt=We.getProjectionData({overscaledTileID:_t,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),ti=We.getCircleRadiusCorrection();It.draw(Ze,rt.TRIANGLES,Ji.disabled,it,lt,_n.backCCW,$c(Dt,We.zoom,$e.paint.get("heatmap-intensity"),ti),null,Qt,$e.id,At.layoutVertexBuffer,At.indexBuffer,At.segments,$e.paint,We.zoom,Pt)}Ze.viewport.set([0,0,Ee.width,Ee.height])})(k,B,W,Z):k.renderPass==="translucent"&&(function(Ee,ze){const $e=Ee.context,Ne=$e.gl;$e.setColorMode(Ee.colorModeForRenderPass());const Ze=ze.heatmapFbos.get(s.cd);Ze&&($e.activeTexture.set(Ne.TEXTURE0),Ne.bindTexture(Ne.TEXTURE_2D,Ze.colorAttachment.get()),$e.activeTexture.set(Ne.TEXTURE1),im($e,ze).bind(Ne.LINEAR,Ne.CLAMP_TO_EDGE),Ee.useProgram("heatmapTexture").draw($e,Ne.TRIANGLES,Ji.disabled,bn.disabled,Ee.colorModeForRenderPass(),_n.disabled,Gp(Ee,ze,0,1),null,null,ze.id,Ee.viewportBuffer,Ee.quadTriangleIndexBuffer,Ee.viewportSegments,ze.paint,Ee.transform.zoom))})(k,W)})(l,f,v,w,I):s.cp(v)?(function(k,B,W,Z,J){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:ue}=J,le=W.paint.get("line-opacity"),_e=W.paint.get("line-width");if(le.constantOr(1)===0||_e.constantOr(1)===0)return;const Ee=k.getDepthModeForSublayer(0,Ji.ReadOnly),ze=k.colorModeForRenderPass(),$e=W.paint.get("line-dasharray"),Ne=$e.constantOr(1),Ze=W.paint.get("line-pattern"),rt=Ze.constantOr(1),We=W.paint.get("line-gradient"),it=W.getCrossfadeParameters();let lt;lt=rt?"linePattern":Ne&&We?"lineGradientSDF":Ne?"lineSDF":We?"lineGradient":"line";const Qe=k.context,_t=Qe.gl,Dt=k.transform;let At=!0;for(const Pt of Z){const It=B.getTile(Pt);if(rt&&!It.patternsLoaded())continue;const Qt=It.getBucket(W);if(!Qt)continue;const ti=Qt.programConfigurations.get(W.id),Xt=k.context.program.get(),oi=k.useProgram(lt,ti),Yi=At||oi.program!==Xt,Dn=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Pt),mr=Ze.constantOr(null),Qn=$e&&$e.constantOr(null);if(mr&&It.imageAtlas){const Es=It.imageAtlas,rs=Es.patternPositions[mr.to.toString()],Xr=Es.patternPositions[mr.from.toString()];rs&&Xr&&ti.setConstantPatternPositions(rs,Xr)}else if(Qn){const Es=W.layout.get("line-cap")==="round",rs=k.lineAtlas.getDash(Qn.to,Es),Xr=k.lineAtlas.getDash(Qn.from,Es);ti.setConstantDashPositions(rs,Xr)}const xr=Dt.getProjectionData({overscaledTileID:Pt,applyGlobeMatrix:!ue,applyTerrainMatrix:!0}),er=Dt.getPixelScale();let Br;rt?(Br=qh(k,It,W,er,it),R0(Qe,_t,It,ti,it)):Ne&&We?(Br=Fu(k,It,W,er,it,Qt.lineClipsArray.length),Zo(k,B,Qe,_t,W,Qt,Pt,ti,it)):Ne?(Br=Hp(k,It,W,er,it),Hr(k,Qe,_t,ti,Yi,it)):We?(Br=Wp(k,It,W,er,Qt.lineClipsArray.length),Uu(k,B,Qe,_t,W,Qt,Pt)):Br=Du(k,It,W,er);const wr=k.stencilModeForClipping(Pt);oi.draw(Qe,_t.TRIANGLES,Ee,wr,ze,_n.disabled,Br,Dn,xr,W.id,Qt.layoutVertexBuffer,Qt.indexBuffer,Qt.segments,W.paint,k.transform.zoom,ti,Qt.layoutVertexBuffer2),At=!1}})(l,f,v,w,I):s.cq(v)?(function(k,B,W,Z,J){const ue=W.paint.get("fill-color"),le=W.paint.get("fill-opacity");if(le.constantOr(1)===0)return;const{isRenderingToTexture:_e}=J,Ee=k.colorModeForRenderPass(),ze=W.paint.get("fill-pattern"),$e=k.opaquePassEnabledForLayer()&&!ze.constantOr(1)&&ue.constantOr(s.bp.transparent).a===1&&le.constantOr(0)===1?"opaque":"translucent";if(k.renderPass===$e){const Ne=k.getDepthModeForSublayer(1,k.renderPass==="opaque"?Ji.ReadWrite:Ji.ReadOnly);mf(k,B,W,Z,Ne,Ee,!1,_e)}if(k.renderPass==="translucent"&&W.paint.get("fill-antialias")){const Ne=k.getDepthModeForSublayer(W.getPaintProperty("fill-outline-color")?2:0,Ji.ReadOnly);mf(k,B,W,Z,Ne,Ee,!0,_e)}})(l,f,v,w,I):s.cr(v)?(function(k,B,W,Z,J){const ue=W.paint.get("fill-extrusion-opacity");if(ue===0)return;const{isRenderingToTexture:le}=J;if(k.renderPass==="translucent"){const _e=new Ji(k.context.gl.LEQUAL,Ji.ReadWrite,k.depthRangeFor3D);if(ue!==1||W.paint.get("fill-extrusion-pattern").constantOr(1))rm(k,B,W,Z,_e,bn.disabled,Nn.disabled,le),rm(k,B,W,Z,_e,k.stencilModeFor3D(),k.colorModeForRenderPass(),le);else{const Ee=k.colorModeForRenderPass();rm(k,B,W,Z,_e,bn.disabled,Ee,le)}}})(l,f,v,w,I):s.cs(v)?(function(k,B,W,Z,J){if(k.renderPass!=="offscreen"&&k.renderPass!=="translucent")return;const{isRenderingToTexture:ue}=J,le=k.context,_e=k.style.projection.useSubdivision,Ee=k.getDepthModeForSublayer(0,Ji.ReadOnly),ze=k.colorModeForRenderPass();if(k.renderPass==="offscreen")(function($e,Ne,Ze,rt,We,it,lt){const Qe=$e.context,_t=Qe.gl;for(const Dt of Ze){const At=Ne.getTile(Dt),Pt=At.dem;if(!Pt||!Pt.data||!At.needsHillshadePrepare)continue;const It=Pt.dim,Qt=Pt.stride,ti=Pt.getPixels();if(Qe.activeTexture.set(_t.TEXTURE1),Qe.pixelStoreUnpackPremultiplyAlpha.set(!1),At.demTexture=At.demTexture||$e.getTileTexture(Qt),At.demTexture){const oi=At.demTexture;oi.update(ti,{premultiply:!1}),oi.bind(_t.NEAREST,_t.CLAMP_TO_EDGE)}else At.demTexture=new s.T(Qe,ti,_t.RGBA,{premultiply:!1}),At.demTexture.bind(_t.NEAREST,_t.CLAMP_TO_EDGE);Qe.activeTexture.set(_t.TEXTURE0);let Xt=At.fbo;if(!Xt){const oi=new s.T(Qe,{width:It,height:It,data:null},_t.RGBA);oi.bind(_t.LINEAR,_t.CLAMP_TO_EDGE),Xt=At.fbo=Qe.createFramebuffer(It,It,!0,!1),Xt.colorAttachment.set(oi.texture)}Qe.bindFramebuffer.set(Xt.framebuffer),Qe.viewport.set([0,0,It,It]),$e.useProgram("hillshadePrepare").draw(Qe,_t.TRIANGLES,We,it,lt,_n.disabled,S_(At.tileID,Pt),null,null,rt.id,$e.rasterBoundsBuffer,$e.quadTriangleIndexBuffer,$e.rasterBoundsSegments),At.needsHillshadePrepare=!1}})(k,B,Z,W,Ee,bn.disabled,ze),le.viewport.set([0,0,k.width,k.height]);else if(k.renderPass==="translucent")if(_e){const[$e,Ne,Ze]=k.stencilConfigForOverlapTwoPass(Z);Gc(k,B,W,Ze,$e,Ee,ze,!1,ue),Gc(k,B,W,Ze,Ne,Ee,ze,!0,ue)}else{const[$e,Ne]=k.getStencilConfigForOverlapAndUpdateStencilID(Z);Gc(k,B,W,Ne,$e,Ee,ze,!1,ue)}})(l,f,v,w,I):s.ct(v)?(function(k,B,W,Z,J){if(k.renderPass!=="translucent"||!Z.length)return;const{isRenderingToTexture:ue}=J,le=k.style.projection.useSubdivision,_e=k.getDepthModeForSublayer(0,Ji.ReadOnly),Ee=k.colorModeForRenderPass();if(le){const[ze,$e,Ne]=k.stencilConfigForOverlapTwoPass(Z);gf(k,B,W,Ne,ze,_e,Ee,!1,ue),gf(k,B,W,Ne,$e,_e,Ee,!0,ue)}else{const[ze,$e]=k.getStencilConfigForOverlapAndUpdateStencilID(Z);gf(k,B,W,$e,ze,_e,Ee,!1,ue)}})(l,f,v,w,I):s.bU(v)?(function(k,B,W,Z,J){if(k.renderPass!=="translucent"||W.paint.get("raster-opacity")===0||!Z.length)return;const{isRenderingToTexture:ue}=J,le=B.getSource(),_e=k.style.projection.useSubdivision;if(le instanceof bt)Kh(k,B,W,Z,null,!1,!1,le.tileCoords,le.flippedWindingOrder,ue);else if(_e){const[Ee,ze,$e]=k.stencilConfigForOverlapTwoPass(Z);Kh(k,B,W,$e,Ee,!1,!0,ju,!1,ue),Kh(k,B,W,$e,ze,!0,!0,ju,!1,ue)}else{const[Ee,ze]=k.getStencilConfigForOverlapAndUpdateStencilID(Z);Kh(k,B,W,ze,Ee,!1,!0,ju,!1,ue)}})(l,f,v,w,I):s.cu(v)?(function(k,B,W,Z,J){const ue=W.paint.get("background-color"),le=W.paint.get("background-opacity");if(le===0)return;const{isRenderingToTexture:_e}=J,Ee=k.context,ze=Ee.gl,$e=k.style.projection,Ne=k.transform,Ze=Ne.tileSize,rt=W.paint.get("background-pattern");if(k.isPatternMissing(rt))return;const We=!rt&&ue.a===1&&le===1&&k.opaquePassEnabledForLayer()?"opaque":"translucent";if(k.renderPass!==We)return;const it=bn.disabled,lt=k.getDepthModeForSublayer(0,We==="opaque"?Ji.ReadWrite:Ji.ReadOnly),Qe=k.colorModeForRenderPass(),_t=k.useProgram(rt?"backgroundPattern":"background"),Dt=Z||kn(Ne,{tileSize:Ze,terrain:k.style.map.terrain});rt&&(Ee.activeTexture.set(ze.TEXTURE0),k.imageManager.bind(k.context));const At=W.getCrossfadeParameters();for(const Pt of Dt){const It=Ne.getProjectionData({overscaledTileID:Pt,applyGlobeMatrix:!_e,applyTerrainMatrix:!0}),Qt=rt?cf(le,k,rt,{tileID:Pt,tileSize:Ze},At):Hh(le,ue),ti=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Pt),Xt=$e.getMeshFromTileID(Ee,Pt.canonical,!1,!0,"raster");_t.draw(Ee,ze.TRIANGLES,lt,it,Qe,_n.backCCW,Qt,ti,It,W.id,Xt.vertexBuffer,Xt.indexBuffer,Xt.segments)}})(l,0,v,w,I):s.cv(v)&&(function(k,B,W,Z){const{isRenderingGlobe:J}=Z,ue=k.context,le=W.implementation,_e=k.style.projection,Ee=k.transform,ze=Ee.getProjectionDataForCustomLayer(J),$e={farZ:Ee.farZ,nearZ:Ee.nearZ,fov:Ee.fov*Math.PI/180,modelViewProjectionMatrix:Ee.modelViewProjectionMatrix,projectionMatrix:Ee.projectionMatrix,shaderData:{variantName:_e.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${_e.shaderPreludeCode.vertexSource}`,define:_e.shaderDefine},defaultProjectionData:ze},Ne=le.renderingMode?le.renderingMode:"2d";if(k.renderPass==="offscreen"){const Ze=le.prerender;Ze&&(k.setCustomLayerDefaults(),ue.setColorMode(k.colorModeForRenderPass()),Ze.call(le,ue.gl,$e),ue.setDirty(),k.setBaseState())}else if(k.renderPass==="translucent"){k.setCustomLayerDefaults(),ue.setColorMode(k.colorModeForRenderPass()),ue.setStencilMode(bn.disabled);const Ze=Ne==="3d"?k.getDepthModeFor3D():k.getDepthModeForSublayer(0,Ji.ReadOnly);ue.setDepthMode(Ze),le.render(ue.gl,$e),ue.setDirty(),k.setBaseState(),ue.bindFramebuffer.set(null)}})(l,0,v,I))}saveTileTexture(l){const f=this._tileTextures[l.size[0]];f?f.push(l):this._tileTextures[l.size[0]]=[l]}getTileTexture(l){const f=this._tileTextures[l];return f&&f.length>0?f.pop():null}isPatternMissing(l){if(!l)return!1;if(!l.from||!l.to)return!0;const f=this.imageManager.getPattern(l.from.toString()),v=this.imageManager.getPattern(l.to.toString());return!f||!v}useProgram(l,f,v=!1,w=[]){this.cache=this.cache||{};const I=!!this.style.map.terrain,k=this.style.projection,B=v?xn.projectionMercator:k.shaderPreludeCode,W=v?Ss:k.shaderDefine,Z=l+(f?f.cacheKey:"")+`/${v?ao:k.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(I?"/terrain":"")+(w?`/${w.join("/")}`:"");return this.cache[Z]||(this.cache[Z]=new Vp(this.context,xn[l],f,rc[l],this._showOverdrawInspector,I,B,W,w)),this.cache[Z]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const l=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(l.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){var l,f;if(this._tileTextures){for(const v in this._tileTextures){const w=this._tileTextures[v];if(w)for(const I of w)I.destroy()}this._tileTextures={}}if(this.tileExtentBuffer&&this.tileExtentBuffer.destroy(),this.debugBuffer&&this.debugBuffer.destroy(),this.rasterBoundsBuffer&&this.rasterBoundsBuffer.destroy(),this.rasterBoundsBufferPosOnly&&this.rasterBoundsBufferPosOnly.destroy(),this.viewportBuffer&&this.viewportBuffer.destroy(),this.tileBorderIndexBuffer&&this.tileBorderIndexBuffer.destroy(),this.quadTriangleIndexBuffer&&this.quadTriangleIndexBuffer.destroy(),this.tileExtentMesh&&((l=this.tileExtentMesh.vertexBuffer)===null||l===void 0||l.destroy()),this.tileExtentMesh&&((f=this.tileExtentMesh.indexBuffer)===null||f===void 0||f.destroy()),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this.cache){for(const v in this.cache){const w=this.cache[v];w&&w.program&&this.context.gl.deleteProgram(w.program)}this.cache={}}this.context&&this.context.setDefault()}overLimit(){const{drawingBufferWidth:l,drawingBufferHeight:f}=this.context.gl;return this.width!==l||this.height!==f}}function D_(A,l){let f,v=!1,w=null,I=null;const k=()=>{w=null,v&&(A.apply(I,f),w=setTimeout(k,l),v=!1)};return(...B)=>(v=!0,I=this,f=B,w||k(),w)}class F_{constructor(l){this._getCurrentHash=()=>{const f=window.location.hash.replace("#","");if(this._hashName){let v;return f.split("&").map((w=>w.split("="))).forEach((w=>{w[0]===this._hashName&&(v=w)})),(v&&v[1]||"").split("/")}return f.split("/")},this._onHashChange=()=>{const f=this._getCurrentHash();if(!this._isValidHash(f))return!1;const v=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(f[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+f[2],+f[1]],zoom:+f[0],bearing:v,pitch:+(f[4]||0)}),!0},this._updateHashUnthrottled=()=>{const f=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,f)},this._removeHash=()=>{const f=this._getCurrentHash();if(f.length===0)return;const v=f.join("/");let w=v;w.split("&").length>0&&(w=w.split("&")[0]),this._hashName&&(w=`${this._hashName}=${v}`);let I=window.location.hash.replace(w,"");I.startsWith("#&")?I=I.slice(0,1)+I.slice(2):I==="#"&&(I="");let k=window.location.href.replace(/(#.+)?$/,I);k=k.replace("&&","&"),window.history.replaceState(window.history.state,null,k)},this._updateHash=D_(this._updateHashUnthrottled,300),this._hashName=l&&encodeURIComponent(l)}addTo(l){return this._map=l,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(l){const f=this._map.getCenter(),v=Math.round(100*this._map.getZoom())/100,w=Math.ceil((v*Math.LN2+Math.log(512/360/.5))/Math.LN10),I=Math.pow(10,w),k=Math.round(f.lng*I)/I,B=Math.round(f.lat*I)/I,W=this._map.getBearing(),Z=this._map.getPitch();let J="";if(J+=l?`/${k}/${B}/${v}`:`${v}/${B}/${k}`,(W||Z)&&(J+="/"+Math.round(10*W)/10),Z&&(J+=`/${Math.round(Z)}`),this._hashName){const ue=this._hashName;let le=!1;const _e=window.location.hash.slice(1).split("&").map((Ee=>{const ze=Ee.split("=")[0];return ze===ue?(le=!0,`${ze}=${J}`):Ee})).filter((Ee=>Ee));return le||_e.push(`${ue}=${J}`),`#${_e.join("&")}`}return`#${J}`}_isValidHash(l){if(l.length<3||l.some(isNaN))return!1;try{new s.V(+l[2],+l[1])}catch{return!1}const f=+l[0],v=+(l[3]||0),w=+(l[4]||0);return f>=this._map.getMinZoom()&&f<=this._map.getMaxZoom()&&v>=-180&&v<=180&&w>=this._map.getMinPitch()&&w<=this._map.getMaxPitch()}}const Wc={linearity:.3,easing:s.cw(0,0,.3,1)},N0=s.e({deceleration:2500,maxSpeed:1400},Wc),da=s.e({deceleration:20,maxSpeed:1400},Wc),za=s.e({deceleration:1e3,maxSpeed:360},Wc),$0=s.e({deceleration:1e3,maxSpeed:90},Wc),Ba=s.e({deceleration:1e3,maxSpeed:360},Wc);class k1{constructor(l){this._map=l,this.clear()}clear(){this._inertiaBuffer=[]}record(l){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:P(),settings:l})}_drainInertiaBuffer(){const l=this._inertiaBuffer,f=P();for(;l.length>0&&f-l[0].time>160;)l.shift()}_onMoveEnd(l){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const f={zoom:0,bearing:0,pitch:0,roll:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:I}of this._inertiaBuffer)f.zoom+=I.zoomDelta||0,f.bearing+=I.bearingDelta||0,f.pitch+=I.pitchDelta||0,f.roll+=I.rollDelta||0,I.panDelta&&f.pan._add(I.panDelta),I.around&&(f.around=I.around),I.pinchAround&&(f.pinchAround=I.pinchAround);const v=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,w={};if(f.pan.mag()){const I=yf(f.pan.mag(),v,s.e({},N0,l||{})),k=f.pan.mult(I.amount/f.pan.mag()),B=this._map.cameraHelper.handlePanInertia(k,this._map.transform);w.center=B.easingCenter,w.offset=B.easingOffset,vf(w,I)}if(f.zoom){const I=yf(f.zoom,v,da);w.zoom=this._map.transform.zoom+I.amount,vf(w,I)}if(f.bearing){const I=yf(f.bearing,v,za);w.bearing=this._map.transform.bearing+s.an(I.amount,-179,179),vf(w,I)}if(f.pitch){const I=yf(f.pitch,v,$0);w.pitch=this._map.transform.pitch+I.amount,vf(w,I)}if(f.roll){const I=yf(f.roll,v,Ba);w.roll=this._map.transform.roll+s.an(I.amount,-179,179),vf(w,I)}if(w.zoom||w.bearing){const I=f.pinchAround===void 0?f.around:f.pinchAround;w.around=I?this._map.unproject(I):this._map.getCenter()}return this.clear(),s.e(w,{noMoveStart:!0})}}function vf(A,l){(!A.duration||A.duration<l.duration)&&(A.duration=l.duration,A.easing=l.easing)}function yf(A,l,f){const{maxSpeed:v,linearity:w,deceleration:I}=f,k=s.an(A*w/(l/1e3),-v,v),B=Math.abs(k)/(I*w);return{easing:f.easing,duration:1e3*B,amount:k*(B/2)}}class Cs extends s.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(l,f,v,w={}){v=v instanceof MouseEvent?v:new MouseEvent(l,v);const I=L.mousePos(f.getCanvas(),v),k=f.unproject(I);super(l,s.e({point:I,lngLat:k,originalEvent:v},w)),this._defaultPrevented=!1,this.target=f}}class bf extends s.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(l,f,v){const w=l==="touchend"?v.changedTouches:v.touches,I=L.touchPos(f.getCanvasContainer(),w),k=I.map((W=>f.unproject(W))),B=I.reduce(((W,Z,J,ue)=>W.add(Z.div(ue.length))),new s.P(0,0));super(l,{points:I,point:B,lngLats:k,lngLat:f.unproject(B),originalEvent:v}),this._defaultPrevented=!1}}class V0 extends s.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(l,f,v){super(l,{originalEvent:v}),this._defaultPrevented=!1}}class D1{constructor(l,f){this._map=l,this._clickTolerance=f.clickTolerance}reset(){delete this._mousedownPos}wheel(l){return this._firePreventable(new V0(l.type,this._map,l))}mousedown(l,f){return this._mousedownPos=f,this._firePreventable(new Cs(l.type,this._map,l))}mouseup(l){this._map.fire(new Cs(l.type,this._map,l))}click(l,f){this._mousedownPos&&this._mousedownPos.dist(f)>=this._clickTolerance||this._map.fire(new Cs(l.type,this._map,l))}dblclick(l){return this._firePreventable(new Cs(l.type,this._map,l))}mouseover(l){this._map.fire(new Cs(l.type,this._map,l))}mouseout(l){this._map.fire(new Cs(l.type,this._map,l))}touchstart(l){return this._firePreventable(new bf(l.type,this._map,l))}touchmove(l){this._map.fire(new bf(l.type,this._map,l))}touchend(l){this._map.fire(new bf(l.type,this._map,l))}touchcancel(l){this._map.fire(new bf(l.type,this._map,l))}_firePreventable(l){if(this._map.fire(l),l.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class F1{constructor(l){this._map=l}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(l){this._map.fire(new Cs(l.type,this._map,l))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Cs("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(l){this._delayContextMenu?this._contextMenuEvent=l:this._ignoreContextMenu||this._map.fire(new Cs(l.type,this._map,l)),this._map.listens("contextmenu")&&l.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Jh{constructor(l){this._map=l}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(l){return this.transform.screenPointToLocation(s.P.convert(l),this._map.terrain)}}class Qh{constructor(l,f){this._map=l,this._tr=new Jh(l),this._el=l.getCanvasContainer(),this._container=l.getContainer(),this._clickTolerance=f.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(l,f){this.isEnabled()&&l.shiftKey&&l.button===0&&(L.disableDrag(),this._startPos=this._lastPos=f,this._active=!0)}mousemoveWindow(l,f){if(!this._active)return;const v=f;if(this._lastPos.equals(v)||!this._box&&v.dist(this._startPos)<this._clickTolerance)return;const w=this._startPos;this._lastPos=v,this._box||(this._box=L.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",l));const I=Math.min(w.x,v.x),k=Math.max(w.x,v.x),B=Math.min(w.y,v.y),W=Math.max(w.y,v.y);L.setTransform(this._box,`translate(${I}px,${B}px)`),this._box.style.width=k-I+"px",this._box.style.height=W-B+"px"}mouseupWindow(l,f){if(!this._active||l.button!==0)return;const v=this._startPos,w=f;if(this.reset(),L.suppressClick(),v.x!==w.x||v.y!==w.y)return this._map.fire(new s.l("boxzoomend",{originalEvent:l})),{cameraAnimation:I=>I.fitScreenCoordinates(v,w,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",l)}keydown(l){this._active&&l.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",l))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(L.remove(this._box),this._box=null),L.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(l,f){return this._map.fire(new s.l(l,{originalEvent:f}))}}function Na(A,l){if(A.length!==l.length)throw new Error(`The number of touches and points are not equal - touches ${A.length}, points ${l.length}`);const f={};for(let v=0;v<A.length;v++)f[A[v].identifier]=l[v];return f}class mi{constructor(l){this.reset(),this.numTouches=l.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(l,f,v){(this.centroid||v.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=l.timeStamp),v.length===this.numTouches&&(this.centroid=(function(w){const I=new s.P(0,0);for(const k of w)I._add(k);return I.div(w.length)})(f),this.touches=Na(v,f)))}touchmove(l,f,v){if(this.aborted||!this.centroid)return;const w=Na(v,f);for(const I in this.touches){const k=w[I];(!k||k.dist(this.touches[I])>30)&&(this.aborted=!0)}}touchend(l,f,v){if((!this.centroid||l.timeStamp-this.startTime>500)&&(this.aborted=!0),v.length===0){const w=!this.aborted&&this.centroid;if(this.reset(),w)return w}}}class sm{constructor(l){this.singleTap=new mi(l),this.numTaps=l.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(l,f,v){this.singleTap.touchstart(l,f,v)}touchmove(l,f,v){this.singleTap.touchmove(l,f,v)}touchend(l,f,v){const w=this.singleTap.touchend(l,f,v);if(w){const I=l.timeStamp-this.lastTime<500,k=!this.lastTap||this.lastTap.dist(w)<30;if(I&&k||this.reset(),this.count++,this.lastTime=l.timeStamp,this.lastTap=w,this.count===this.numTaps)return this.reset(),w}}}class O_{constructor(l){this._tr=new Jh(l),this._zoomIn=new sm({numTouches:1,numTaps:2}),this._zoomOut=new sm({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(l,f,v){this._zoomIn.touchstart(l,f,v),this._zoomOut.touchstart(l,f,v)}touchmove(l,f,v){this._zoomIn.touchmove(l,f,v),this._zoomOut.touchmove(l,f,v)}touchend(l,f,v){const w=this._zoomIn.touchend(l,f,v),I=this._zoomOut.touchend(l,f,v),k=this._tr;return w?(this._active=!0,l.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:B=>B.easeTo({duration:300,zoom:k.zoom+1,around:k.unproject(w)},{originalEvent:l})}):I?(this._active=!0,l.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:B=>B.easeTo({duration:300,zoom:k.zoom-1,around:k.unproject(I)},{originalEvent:l})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ed{constructor(l){this._enabled=!!l.enable,this._moveStateManager=l.moveStateManager,this._clickTolerance=l.clickTolerance||1,this._moveFunction=l.move,this._activateOnStart=!!l.activateOnStart,l.assignEvents(this),this.reset()}reset(l){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(l)}_move(...l){const f=this._moveFunction(...l);if(f.bearingDelta||f.pitchDelta||f.rollDelta||f.around||f.panDelta)return this._active=!0,f}dragStart(l,f){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(l)&&(this._moveStateManager.startMove(l),this._lastPoint=Array.isArray(f)?f[0]:f,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(l,f){if(!this.isEnabled())return;const v=this._lastPoint;if(!v)return;if(l.preventDefault(),!this._moveStateManager.isValidMoveEvent(l))return void this.reset(l);const w=Array.isArray(f)?f[0]:f;return!this._moved&&w.dist(v)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=w,this._move(v,w))}dragEnd(l){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(l)&&(this._moved&&L.suppressClick(),this.reset(l))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const xf=0,wf=2,z_={[xf]:1,[wf]:2};class Sf{constructor(l){this._correctEvent=l.checkCorrectEvent}startMove(l){const f=L.mouseButton(l);this._eventButton=f}endMove(l){delete this._eventButton}isValidStartEvent(l){return this._correctEvent(l)}isValidMoveEvent(l){return!(function(f,v){const w=z_[v];return f.buttons===void 0||(f.buttons&w)!==w})(l,this._eventButton)}isValidEndEvent(l){return L.mouseButton(l)===this._eventButton}}class B_{constructor(){this._firstTouch=void 0}_isOneFingerTouch(l){return l.targetTouches.length===1}_isSameTouchEvent(l){return l.targetTouches[0].identifier===this._firstTouch}startMove(l){this._firstTouch=l.targetTouches[0].identifier}endMove(l){delete this._firstTouch}isValidStartEvent(l){return this._isOneFingerTouch(l)}isValidMoveEvent(l){return this._isOneFingerTouch(l)&&this._isSameTouchEvent(l)}isValidEndEvent(l){return this._isOneFingerTouch(l)&&this._isSameTouchEvent(l)}}class U0{constructor(l=new Sf({checkCorrectEvent:()=>!0}),f=new B_){this.mouseMoveStateManager=l,this.oneFingerTouchMoveStateManager=f}_executeRelevantHandler(l,f,v){return l instanceof MouseEvent?f(l):typeof TouchEvent<"u"&&l instanceof TouchEvent?v(l):void 0}startMove(l){this._executeRelevantHandler(l,(f=>this.mouseMoveStateManager.startMove(f)),(f=>this.oneFingerTouchMoveStateManager.startMove(f)))}endMove(l){this._executeRelevantHandler(l,(f=>this.mouseMoveStateManager.endMove(f)),(f=>this.oneFingerTouchMoveStateManager.endMove(f)))}isValidStartEvent(l){return this._executeRelevantHandler(l,(f=>this.mouseMoveStateManager.isValidStartEvent(f)),(f=>this.oneFingerTouchMoveStateManager.isValidStartEvent(f)))}isValidMoveEvent(l){return this._executeRelevantHandler(l,(f=>this.mouseMoveStateManager.isValidMoveEvent(f)),(f=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(f)))}isValidEndEvent(l){return this._executeRelevantHandler(l,(f=>this.mouseMoveStateManager.isValidEndEvent(f)),(f=>this.oneFingerTouchMoveStateManager.isValidEndEvent(f)))}}const td=A=>{A.mousedown=A.dragStart,A.mousemoveWindow=A.dragMove,A.mouseup=A.dragEnd,A.contextmenu=l=>{l.preventDefault()}};class O1{constructor(l,f){this._clickTolerance=l.clickTolerance||1,this._map=f,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}_shouldBePrevented(l){return l<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(l,f,v){return this._calculateTransform(l,f,v)}touchmove(l,f,v){if(this._active){if(!this._shouldBePrevented(v.length))return l.preventDefault(),this._calculateTransform(l,f,v);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",l)}}touchend(l,f,v){this._calculateTransform(l,f,v),this._active&&this._shouldBePrevented(v.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(l,f,v){v.length>0&&(this._active=!0);const w=Na(v,f),I=new s.P(0,0),k=new s.P(0,0);let B=0;for(const Z in w){const J=w[Z],ue=this._touches[Z];ue&&(I._add(J),k._add(J.sub(ue)),B++,w[Z]=J)}if(this._touches=w,this._shouldBePrevented(B)||!k.mag())return;const W=k.div(B);return this._sum._add(W),this._sum.mag()<this._clickTolerance?void 0:{around:I.div(B),panDelta:W}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class om{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(l,f,v){this._firstTwoTouches||v.length<2||(this._firstTwoTouches=[v[0].identifier,v[1].identifier],this._start([f[0],f[1]]))}touchmove(l,f,v){if(!this._firstTwoTouches)return;l.preventDefault();const[w,I]=this._firstTwoTouches,k=am(v,f,w),B=am(v,f,I);if(!k||!B)return;const W=this._aroundCenter?null:k.add(B).div(2);return this._move([k,B],W,l)}touchend(l,f,v){if(!this._firstTwoTouches)return;const[w,I]=this._firstTwoTouches,k=am(v,f,w),B=am(v,f,I);k&&B||(this._active&&L.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(l){this._enabled=!0,this._aroundCenter=!!l&&l.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function am(A,l,f){for(let v=0;v<A.length;v++)if(A[v].identifier===f)return l[v]}function j0(A,l){return Math.log(A/l)/Math.LN2}class N_ extends om{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(l){this._startDistance=this._distance=l[0].dist(l[1])}_move(l,f){const v=this._distance;if(this._distance=l[0].dist(l[1]),this._active||!(Math.abs(j0(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:j0(this._distance,v),pinchAround:f}}}function G0(A,l){return 180*A.angleWith(l)/Math.PI}class $_ extends om{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(l){this._startVector=this._vector=l[0].sub(l[1]),this._minDiameter=l[0].dist(l[1])}_move(l,f,v){const w=this._vector;if(this._vector=l[0].sub(l[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:G0(this._vector,w),pinchAround:f}}_isBelowThreshold(l){this._minDiameter=Math.min(this._minDiameter,l.mag());const f=25/(Math.PI*this._minDiameter)*360,v=G0(l,this._startVector);return Math.abs(v)<f}}function V_(A){return Math.abs(A.y)>Math.abs(A.x)}class q0 extends om{constructor(l){super(),this._currentTouchCount=0,this._map=l}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(l,f,v){super.touchstart(l,f,v),this._currentTouchCount=v.length}_start(l){this._lastPoints=l,V_(l[0].sub(l[1]))&&(this._valid=!1)}_move(l,f,v){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const w=l[0].sub(this._lastPoints[0]),I=l[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(w,I,v.timeStamp),this._valid?(this._lastPoints=l,this._active=!0,{pitchDelta:(w.y+I.y)/2*-.5}):void 0}gestureBeginsVertically(l,f,v){if(this._valid!==void 0)return this._valid;const w=l.mag()>=2,I=f.mag()>=2;if(!w&&!I)return;if(!w||!I)return this._firstMove===void 0&&(this._firstMove=v),v-this._firstMove<100&&void 0;const k=l.y>0==f.y>0;return V_(l)&&V_(f)&&k}}const Hc={panStep:100,bearingStep:15,pitchStep:10};class Wn{constructor(l){this._tr=new Jh(l);const f=Hc;this._panStep=f.panStep,this._bearingStep=f.bearingStep,this._pitchStep=f.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(l){if(l.altKey||l.ctrlKey||l.metaKey)return;let f=0,v=0,w=0,I=0,k=0;switch(l.keyCode){case 61:case 107:case 171:case 187:f=1;break;case 189:case 109:case 173:f=-1;break;case 37:l.shiftKey?v=-1:(l.preventDefault(),I=-1);break;case 39:l.shiftKey?v=1:(l.preventDefault(),I=1);break;case 38:l.shiftKey?w=1:(l.preventDefault(),k=-1);break;case 40:l.shiftKey?w=-1:(l.preventDefault(),k=1);break;default:return}return this._rotationDisabled&&(v=0,w=0),{cameraAnimation:B=>{const W=this._tr;B.easeTo({duration:300,easeId:"keyboardHandler",easing:z1,zoom:f?Math.round(W.zoom)+f*(l.shiftKey?2:1):W.zoom,bearing:W.bearing+v*this._bearingStep,pitch:W.pitch+w*this._pitchStep,offset:[-I*this._panStep,-k*this._panStep],center:W.center},{originalEvent:l})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function z1(A){return A*(2-A)}const Tf=4.000244140625,lm=1/450;class cm{constructor(l,f){this._onTimeout=v=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(v)},this._map=l,this._tr=new Jh(l),this._triggerRenderFrame=f,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=lm}setZoomRate(l){this._defaultZoomRate=l}setWheelZoomRate(l){this._wheelZoomRate=l}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(l){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!l&&l.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(l){return!!this._map.cooperativeGestures.isEnabled()&&!(l.ctrlKey||this._map.cooperativeGestures.isBypassed(l))}wheel(l){if(!this.isEnabled())return;if(this._shouldBePrevented(l))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",l);let f=l.deltaMode===WheelEvent.DOM_DELTA_LINE?40*l.deltaY:l.deltaY;const v=P(),w=v-(this._lastWheelEventTime||0);this._lastWheelEventTime=v,f!==0&&f%Tf==0?this._type="wheel":f!==0&&Math.abs(f)<4?this._type="trackpad":w>400?(this._type=null,this._lastValue=f,this._timeout=setTimeout(this._onTimeout,40,l)):this._type||(this._type=Math.abs(w*f)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,f+=this._lastValue)),l.shiftKey&&f&&(f/=4),this._type&&(this._lastWheelEvent=l,this._delta-=f,this._active||this._start(l)),l.preventDefault()}_start(l){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const f=L.mousePos(this._map.getCanvas(),l),v=this._tr;this._aroundPoint=this._aroundCenter?v.transform.locationToScreenPoint(s.V.convert(v.center)):f,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const l=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){const B=l.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=B),typeof this._targetZoom=="number"&&(this._targetZoom+=B)}if(this._delta!==0){const B=this._type==="wheel"&&Math.abs(this._delta)>Tf?this._wheelZoomRate:this._defaultZoomRate;let W=2/(1+Math.exp(-Math.abs(this._delta*B)));this._delta<0&&W!==0&&(W=1/W);const Z=typeof this._targetZoom!="number"?l.scale:s.aq(this._targetZoom);this._targetZoom=l.applyConstrain(l.getCameraLngLat(),s.at(Z*W)).zoom,this._type==="wheel"&&(this._startZoom=l.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const f=typeof this._targetZoom!="number"?l.zoom:this._targetZoom,v=this._startZoom,w=this._easing;let I,k=!1;if(this._type==="wheel"&&v&&w){const B=P()-this._lastWheelEventTime,W=Math.min((B+5)/200,1),Z=w(W);I=s.G.number(v,f,Z),W<1?this._frameId||(this._frameId=!0):k=!0}else I=f,k=!0;return this._active=!0,k&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout}),200)),this._lastExpectedZoom=I,{noInertia:!0,needsRenderFrame:!k,zoomDelta:I-l.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(l){let f=s.cy;if(this._prevEase){const v=this._prevEase,w=(P()-v.start)/v.duration,I=v.easing(w+.01)-v.easing(w),k=.27/Math.sqrt(I*I+1e-4)*.01,B=Math.sqrt(.0729-k*k);f=s.cw(k,B,.25,1)}return this._prevEase={start:P(),duration:l,easing:f},f}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class U_{constructor(l,f){this._clickZoom=l,this._tapZoom=f}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class W0{constructor(l){this._tr=new Jh(l),this.reset()}reset(){this._active=!1}dblclick(l,f){return l.preventDefault(),{cameraAnimation:v=>{v.easeTo({duration:300,zoom:this._tr.zoom+(l.shiftKey?-1:1),around:this._tr.unproject(f)},{originalEvent:l})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class H0{constructor(){this._tap=new sm({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(l,f,v){if(!this._swipePoint)if(this._tapTime){const w=f[0],I=l.timeStamp-this._tapTime<500,k=this._tapPoint.dist(w)<30;I&&k?v.length>0&&(this._swipePoint=w,this._swipeTouch=v[0].identifier):this.reset()}else this._tap.touchstart(l,f,v)}touchmove(l,f,v){if(this._tapTime){if(this._swipePoint){if(v[0].identifier!==this._swipeTouch)return;const w=f[0],I=w.y-this._swipePoint.y;return this._swipePoint=w,l.preventDefault(),this._active=!0,{zoomDelta:I/128}}}else this._tap.touchmove(l,f,v)}touchend(l,f,v){if(this._tapTime)this._swipePoint&&v.length===0&&this.reset();else{const w=this._tap.touchend(l,f,v);w&&(this._tapTime=l.timeStamp,this._tapPoint=w)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Z0{constructor(l,f,v){this._el=l,this._mousePan=f,this._touchPan=v}enable(l){this._inertiaOptions=l||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class $a{constructor(l,f,v,w){this._pitchWithRotate=l.pitchWithRotate,this._rollEnabled=l.rollEnabled,this._mouseRotate=f,this._mousePitch=v,this._mouseRoll=w}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class Mf{constructor(l,f,v,w){this._el=l,this._touchZoom=f,this._touchRotate=v,this._tapDragZoom=w,this._rotationDisabled=!1,this._enabled=!0}enable(l){this._touchZoom.enable(l),this._rotationDisabled||this._touchRotate.enable(l),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class Mi{constructor(l,f){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=l,this._options=f,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const l=this._map.getCanvasContainer();l.classList.add("maplibregl-cooperative-gestures"),this._container=L.create("div","maplibregl-cooperative-gesture-screen",l);let f=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(f=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const v=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),w=document.createElement("div");w.className="maplibregl-desktop-message",w.textContent=f,this._container.appendChild(w);const I=document.createElement("div");I.className="maplibregl-mobile-message",I.textContent=v,this._container.appendChild(I),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(L.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(l){return l[this._bypassKey]}notifyGestureBlocked(l,f){this._enabled&&(this._map.fire(new s.l("cooperativegestureprevented",{gestureType:l,originalEvent:f})),this._container.classList.add("maplibregl-show"),setTimeout((()=>{this._container.classList.remove("maplibregl-show")}),100))}}const Oi=A=>A.zoom||A.drag||A.roll||A.pitch||A.rotate;class Cf extends s.l{}function um(A){return A.panDelta&&A.panDelta.mag()||A.zoomDelta||A.bearingDelta||A.pitchDelta||A.rollDelta}class hm{constructor(l,f){this.handleWindowEvent=w=>{this.handleEvent(w,`${w.type}Window`)},this.handleEvent=(w,I)=>{if(w.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const k=w.type==="renderFrame"?void 0:w,B={needsRenderFrame:!1},W={},Z={};for(const{handlerName:le,handler:_e,allowed:Ee}of this._handlers){if(!_e.isEnabled())continue;let ze;if(this._blockedByActive(Z,Ee,le))_e.reset();else if(_e[I||w.type]){if(s.cz(w,I||w.type)){const $e=L.mousePos(this._map.getCanvas(),w);ze=_e[I||w.type](w,$e)}else if(s.cA(w,I||w.type)){const $e=this._getMapTouches(w.touches),Ne=L.touchPos(this._map.getCanvas(),$e);ze=_e[I||w.type](w,Ne,$e)}else s.cB(I||w.type)||(ze=_e[I||w.type](w));this.mergeHandlerResult(B,W,ze,le,k),ze&&ze.needsRenderFrame&&this._triggerRenderFrame()}(ze||_e.isActive())&&(Z[le]=_e)}const J={};for(const le in this._previousActiveHandlers)Z[le]||(J[le]=k);this._previousActiveHandlers=Z,(Object.keys(J).length||um(B))&&(this._changes.push([B,W,J]),this._triggerRenderFrame()),(Object.keys(Z).length||um(B))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ue}=B;ue&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ue(this._map))},this._map=l,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new k1(l),this._bearingSnap=f.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(f);const v=this._el;this._listeners=[[v,"touchstart",{passive:!0}],[v,"touchmove",{passive:!1}],[v,"touchend",void 0],[v,"touchcancel",void 0],[v,"mousedown",void 0],[v,"mousemove",void 0],[v,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[v,"mouseover",void 0],[v,"mouseout",void 0],[v,"dblclick",void 0],[v,"click",void 0],[v,"keydown",{capture:!1}],[v,"keyup",void 0],[v,"wheel",{passive:!1}],[v,"contextmenu",void 0],[window,"blur",void 0]];for(const[w,I,k]of this._listeners)L.addEventListener(w,I,w===document?this.handleWindowEvent:this.handleEvent,k)}destroy(){for(const[l,f,v]of this._listeners)L.removeEventListener(l,f,l===document?this.handleWindowEvent:this.handleEvent,v)}_addDefaultHandlers(l){const f=this._map,v=f.getCanvasContainer();this._add("mapEvent",new D1(f,l));const w=f.boxZoom=new Qh(f,l);this._add("boxZoom",w),l.interactive&&l.boxZoom&&w.enable();const I=f.cooperativeGestures=new Mi(f,l.cooperativeGestures);this._add("cooperativeGestures",I),l.cooperativeGestures&&I.enable();const k=new O_(f),B=new W0(f);f.doubleClickZoom=new U_(B,k),this._add("tapZoom",k),this._add("clickZoom",B),l.interactive&&l.doubleClickZoom&&f.doubleClickZoom.enable();const W=new H0;this._add("tapDragZoom",W);const Z=f.touchPitch=new q0(f);this._add("touchPitch",Z),l.interactive&&l.touchPitch&&f.touchPitch.enable(l.touchPitch);const J=()=>f.project(f.getCenter()),ue=(function({enable:We,clickTolerance:it,aroundCenter:lt=!0,minPixelCenterThreshold:Qe=100,rotateDegreesPerPixelMoved:_t=.8},Dt){const At=new Sf({checkCorrectEvent:Pt=>L.mouseButton(Pt)===0&&Pt.ctrlKey||L.mouseButton(Pt)===2&&!Pt.ctrlKey});return new ed({clickTolerance:it,move:(Pt,It)=>{const Qt=Dt();if(lt&&Math.abs(Qt.y-Pt.y)>Qe)return{bearingDelta:s.cx(new s.P(Pt.x,It.y),It,Qt)};let ti=(It.x-Pt.x)*_t;return lt&&It.y<Qt.y&&(ti=-ti),{bearingDelta:ti}},moveStateManager:At,enable:We,assignEvents:td})})(l,J),le=(function({enable:We,clickTolerance:it,pitchDegreesPerPixelMoved:lt=-.5}){const Qe=new Sf({checkCorrectEvent:_t=>L.mouseButton(_t)===0&&_t.ctrlKey||L.mouseButton(_t)===2});return new ed({clickTolerance:it,move:(_t,Dt)=>({pitchDelta:(Dt.y-_t.y)*lt}),moveStateManager:Qe,enable:We,assignEvents:td})})(l),_e=(function({enable:We,clickTolerance:it,rollDegreesPerPixelMoved:lt=.3},Qe){const _t=new Sf({checkCorrectEvent:Dt=>L.mouseButton(Dt)===2&&Dt.ctrlKey});return new ed({clickTolerance:it,move:(Dt,At)=>{const Pt=Qe();let It=(At.x-Dt.x)*lt;return At.y<Pt.y&&(It=-It),{rollDelta:It}},moveStateManager:_t,enable:We,assignEvents:td})})(l,J);f.dragRotate=new $a(l,ue,le,_e),this._add("mouseRotate",ue,["mousePitch"]),this._add("mousePitch",le,["mouseRotate","mouseRoll"]),this._add("mouseRoll",_e,["mousePitch"]),l.interactive&&l.dragRotate&&f.dragRotate.enable();const Ee=(function({enable:We,clickTolerance:it}){const lt=new Sf({checkCorrectEvent:Qe=>L.mouseButton(Qe)===0&&!Qe.ctrlKey});return new ed({clickTolerance:it,move:(Qe,_t)=>({around:_t,panDelta:_t.sub(Qe)}),activateOnStart:!0,moveStateManager:lt,enable:We,assignEvents:td})})(l),ze=new O1(l,f);f.dragPan=new Z0(v,Ee,ze),this._add("mousePan",Ee),this._add("touchPan",ze,["touchZoom","touchRotate"]),l.interactive&&l.dragPan&&f.dragPan.enable(l.dragPan);const $e=new $_,Ne=new N_;f.touchZoomRotate=new Mf(v,Ne,$e,W),this._add("touchRotate",$e,["touchPan","touchZoom"]),this._add("touchZoom",Ne,["touchPan","touchRotate"]),l.interactive&&l.touchZoomRotate&&f.touchZoomRotate.enable(l.touchZoomRotate),this._add("blockableMapEvent",new F1(f));const Ze=f.scrollZoom=new cm(f,(()=>this._triggerRenderFrame()));this._add("scrollZoom",Ze,["mousePan"]),l.interactive&&l.scrollZoom&&f.scrollZoom.enable(l.scrollZoom);const rt=f.keyboard=new Wn(f);this._add("keyboard",rt),l.interactive&&l.keyboard&&f.keyboard.enable()}_add(l,f,v){this._handlers.push({handlerName:l,handler:f,allowed:v}),this._handlersById[l]=f}stop(l){if(!this._updatingCamera){for(const{handler:f}of this._handlers)f.reset();this._inertia.clear(),this._fireEvents({},{},l),this._changes=[]}}isActive(){for(const{handler:l}of this._handlers)if(l.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Oi(this._eventsInProgress)||this.isZooming()}_blockedByActive(l,f,v){for(const w in l)if(w!==v&&(!f||f.indexOf(w)<0))return!0;return!1}_getMapTouches(l){const f=[];for(const v of l)this._el.contains(v.target)&&f.push(v);return f}mergeHandlerResult(l,f,v,w,I){if(!v)return;s.e(l,v);const k={handlerName:w,originalEvent:v.originalEvent||I};v.zoomDelta!==void 0&&(f.zoom=k),v.panDelta!==void 0&&(f.drag=k),v.rollDelta!==void 0&&(f.roll=k),v.pitchDelta!==void 0&&(f.pitch=k),v.bearingDelta!==void 0&&(f.rotate=k)}_applyChanges(){const l={},f={},v={};for(const[w,I,k]of this._changes)w.panDelta&&(l.panDelta=(l.panDelta||new s.P(0,0))._add(w.panDelta)),w.zoomDelta&&(l.zoomDelta=(l.zoomDelta||0)+w.zoomDelta),w.bearingDelta&&(l.bearingDelta=(l.bearingDelta||0)+w.bearingDelta),w.pitchDelta&&(l.pitchDelta=(l.pitchDelta||0)+w.pitchDelta),w.rollDelta&&(l.rollDelta=(l.rollDelta||0)+w.rollDelta),w.around!==void 0&&(l.around=w.around),w.pinchAround!==void 0&&(l.pinchAround=w.pinchAround),w.noInertia&&(l.noInertia=w.noInertia),s.e(f,I),s.e(v,k);this._updateMapTransform(l,f,v),this._changes=[]}_updateMapTransform(l,f,v){const w=this._map,I=w._getTransformForUpdate(),k=w.terrain;if(!(um(l)||k&&this._terrainMovement))return this._fireEvents(f,v,!0);w._stop(!0);let{panDelta:B,zoomDelta:W,bearingDelta:Z,pitchDelta:J,rollDelta:ue,around:le,pinchAround:_e}=l;_e!==void 0&&(le=_e),le=le||w.transform.centerPoint,k&&!I.isPointOnMapSurface(le)&&(le=I.centerPoint);const Ee={panDelta:B,zoomDelta:W,rollDelta:ue,pitchDelta:J,bearingDelta:Z,around:le};this._map.cameraHelper.useGlobeControls&&!I.isPointOnMapSurface(le)&&(le=I.centerPoint);const ze=le.distSqr(I.centerPoint)<.01?I.center:I.screenPointToLocation(B?le.sub(B):le);this._handleMapControls({terrain:k,tr:I,deltasForHelper:Ee,preZoomAroundLoc:ze,combinedEventsInProgress:f,panDelta:B}),w._applyUpdatedTransform(I),this._map._update(),l.noInertia||this._inertia.record(l),this._fireEvents(f,v,!0)}_handleMapControls({terrain:l,tr:f,deltasForHelper:v,preZoomAroundLoc:w,combinedEventsInProgress:I,panDelta:k}){const B=this._map.cameraHelper;if(B.handleMapControlsRollPitchBearingZoom(v,f),l)return B.useGlobeControls?(this._terrainMovement||!I.drag&&!I.zoom||(this._terrainMovement=!0,this._map._elevationFreeze=!0),void B.handleMapControlsPan(v,f,w)):this._terrainMovement||!I.drag&&!I.zoom?void(I.drag&&this._terrainMovement&&k?f.setCenter(f.screenPointToLocation(f.centerPoint.sub(k))):B.handleMapControlsPan(v,f,w)):(this._terrainMovement=!0,this._map._elevationFreeze=!0,void B.handleMapControlsPan(v,f,w));B.handleMapControlsPan(v,f,w)}_fireEvents(l,f,v){const w=Oi(this._eventsInProgress),I=Oi(l),k={};for(const ue in l){const{originalEvent:le}=l[ue];this._eventsInProgress[ue]||(k[`${ue}start`]=le),this._eventsInProgress[ue]=l[ue]}!w&&I&&this._fireEvent("movestart",I.originalEvent);for(const ue in k)this._fireEvent(ue,k[ue]);I&&this._fireEvent("move",I.originalEvent);for(const ue in l){const{originalEvent:le}=l[ue];this._fireEvent(ue,le)}const B={};let W;for(const ue in this._eventsInProgress){const{handlerName:le,originalEvent:_e}=this._eventsInProgress[ue];this._handlersById[le].isActive()||(delete this._eventsInProgress[ue],W=f[le]||_e,B[`${ue}end`]=W)}for(const ue in B)this._fireEvent(ue,B[ue]);const Z=Oi(this._eventsInProgress),J=(w||I)&&!Z;if(J&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const ue=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&ue.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(ue)}if(v&&J){this._updatingCamera=!0;const ue=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),le=_e=>_e!==0&&-this._bearingSnap<_e&&_e<this._bearingSnap;!ue||!ue.essential&&b.prefersReducedMotion?(this._map.fire(new s.l("moveend",{originalEvent:W})),le(this._map.getBearing())&&this._map.resetNorth()):(le(ue.bearing||this._map.getBearing())&&(ue.bearing=0),ue.freezeElevation=!0,this._map.easeTo(ue,{originalEvent:W})),this._updatingCamera=!1}}_fireEvent(l,f){this._map.fire(new s.l(l,f?{originalEvent:f}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((l=>{delete this._frameId,this.handleEvent(new Cf("renderFrame",{timeStamp:l})),this._applyChanges()}))}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class co extends s.E{constructor(l,f,v){super(),this._renderFrameCallback=()=>{const w=Math.min((P()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(w)),w<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=l,this._bearingSnap=v.bearingSnap,this.cameraHelper=f,this.on("moveend",(()=>{delete this._requestedCameraState}))}migrateProjection(l,f){l.apply(this.transform),this.transform=l,this.cameraHelper=f}getCenter(){return new s.V(this.transform.center.lng,this.transform.center.lat)}setCenter(l,f){return this.jumpTo({center:l},f)}getCenterElevation(){return this.transform.elevation}setCenterElevation(l,f){return this.jumpTo({elevation:l},f),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(l){this._centerClampedToGround=l}panBy(l,f,v){return l=s.P.convert(l).mult(-1),this.panTo(this.transform.center,s.e({offset:l},f),v)}panTo(l,f,v){return this.easeTo(s.e({center:l},f),v)}getZoom(){return this.transform.zoom}setZoom(l,f){return this.jumpTo({zoom:l},f),this}zoomTo(l,f,v){return this.easeTo(s.e({zoom:l},f),v)}zoomIn(l,f){return this.zoomTo(this.getZoom()+1,l,f),this}zoomOut(l,f){return this.zoomTo(this.getZoom()-1,l,f),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(l,f){return l!=this.transform.fov&&(this.transform.setFov(l),this.fire(new s.l("movestart",f)).fire(new s.l("move",f)).fire(new s.l("moveend",f))),this}getBearing(){return this.transform.bearing}setBearing(l,f){return this.jumpTo({bearing:l},f),this}getPadding(){return this.transform.padding}setPadding(l,f){return this.jumpTo({padding:l},f),this}rotateTo(l,f,v){return this.easeTo(s.e({bearing:l},f),v)}resetNorth(l,f){return this.rotateTo(0,s.e({duration:1e3},l),f),this}resetNorthPitch(l,f){return this.easeTo(s.e({bearing:0,pitch:0,roll:0,duration:1e3},l),f),this}snapToNorth(l,f){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(l,f):this}getPitch(){return this.transform.pitch}setPitch(l,f){return this.jumpTo({pitch:l},f),this}getRoll(){return this.transform.roll}setRoll(l,f){return this.jumpTo({roll:l},f),this}cameraForBounds(l,f){l=Ce.convert(l).adjustAntiMeridian();const v=f&&f.bearing||0;return this._cameraForBoxAndBearing(l.getNorthWest(),l.getSouthEast(),v,f)}_cameraForBoxAndBearing(l,f,v,w){const I={top:0,bottom:0,right:0,left:0};if(typeof(w=s.e({padding:I,offset:[0,0],maxZoom:this.transform.maxZoom},w)).padding=="number"){const Z=w.padding;w.padding={top:Z,bottom:Z,right:Z,left:Z}}const k=s.e(I,w.padding);w.padding=k;const B=this.transform,W=new Ce(l,f);return this.cameraHelper.cameraForBoxAndBearing(w,k,W,v,B)}fitBounds(l,f,v){return this._fitInternal(this.cameraForBounds(l,f),f,v)}fitScreenCoordinates(l,f,v,w,I){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(s.P.convert(l)),this.transform.screenPointToLocation(s.P.convert(f)),v,w),w,I)}_fitInternal(l,f,v){return l?(delete(f=s.e(l,f)).padding,f.linear?this.easeTo(f,v):this.flyTo(f,v)):this}jumpTo(l,f){this.stop();const v=this._getTransformForUpdate();let w=!1,I=!1,k=!1;const B=v.zoom;this.cameraHelper.handleJumpToCenterZoom(v,l);const W=v.zoom!==B;return"elevation"in l&&v.elevation!==+l.elevation&&v.setElevation(+l.elevation),"bearing"in l&&v.bearing!==+l.bearing&&(w=!0,v.setBearing(+l.bearing)),"pitch"in l&&v.pitch!==+l.pitch&&(I=!0,v.setPitch(+l.pitch)),"roll"in l&&v.roll!==+l.roll&&(k=!0,v.setRoll(+l.roll)),l.padding==null||v.isPaddingEqual(l.padding)||v.setPadding(l.padding),this._applyUpdatedTransform(v),this.fire(new s.l("movestart",f)).fire(new s.l("move",f)),W&&this.fire(new s.l("zoomstart",f)).fire(new s.l("zoom",f)).fire(new s.l("zoomend",f)),w&&this.fire(new s.l("rotatestart",f)).fire(new s.l("rotate",f)).fire(new s.l("rotateend",f)),I&&this.fire(new s.l("pitchstart",f)).fire(new s.l("pitch",f)).fire(new s.l("pitchend",f)),k&&this.fire(new s.l("rollstart",f)).fire(new s.l("roll",f)).fire(new s.l("rollend",f)),this.fire(new s.l("moveend",f))}calculateCameraOptionsFromTo(l,f,v,w=0){const I=s.a9.fromLngLat(l,f),k=s.a9.fromLngLat(v,w),B=k.x-I.x,W=k.y-I.y,Z=k.z-I.z,J=Math.hypot(B,W,Z);if(J===0)throw new Error("Can't calculate camera options with same From and To");const ue=Math.hypot(B,W),le=s.at(this.transform.cameraToCenterDistance/J/this.transform.tileSize),_e=180*Math.atan2(B,-W)/Math.PI;let Ee=180*Math.acos(ue/J)/Math.PI;return Ee=Z<0?90-Ee:90+Ee,{center:k.toLngLat(),elevation:w,zoom:le,pitch:Ee,bearing:_e}}calculateCameraOptionsFromCameraLngLatAltRotation(l,f,v,w,I){const k=this.transform.calculateCenterFromCameraLngLatAlt(l,f,v,w);return{center:k.center,elevation:k.elevation,zoom:k.zoom,bearing:v,pitch:w,roll:I}}easeTo(l,f){this._stop(!1,l.easeId),((l=s.e({offset:[0,0],duration:500,easing:s.cy},l)).animate===!1||!l.essential&&b.prefersReducedMotion)&&(l.duration=0);const v=this._getTransformForUpdate(),w=this.getBearing(),I=v.pitch,k=v.roll,B="bearing"in l?this._normalizeBearing(l.bearing,w):w,W="pitch"in l?+l.pitch:I,Z="roll"in l?this._normalizeBearing(l.roll,k):k,J="padding"in l?l.padding:v.padding,ue=s.P.convert(l.offset);let le,_e;l.around&&(le=s.V.convert(l.around),_e=v.locationToScreenPoint(le));const Ee={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},ze=this.cameraHelper.handleEaseTo(v,{bearing:B,pitch:W,roll:Z,padding:J,around:le,aroundPoint:_e,offsetAsPoint:ue,offset:l.offset,zoom:l.zoom,center:l.center});return this._rotating=this._rotating||w!==B,this._pitching=this._pitching||W!==I,this._rolling=this._rolling||Z!==k,this._padding=!v.isPaddingEqual(J),this._zooming=this._zooming||ze.isZooming,this._easeId=l.easeId,this._prepareEase(f,l.noMoveStart,Ee),this.terrain&&this._prepareElevation(ze.elevationCenter),this._ease(($e=>{ze.easeFunc($e),this.terrain&&!l.freezeElevation&&this._updateElevation($e),this._applyUpdatedTransform(v),this._fireMoveEvents(f)}),($e=>{this.terrain&&l.freezeElevation&&this._finalizeElevation(),this._afterEase(f,$e)}),l),this}_prepareEase(l,f,v={}){this._moving=!0,f||v.moving||this.fire(new s.l("movestart",l)),this._zooming&&!v.zooming&&this.fire(new s.l("zoomstart",l)),this._rotating&&!v.rotating&&this.fire(new s.l("rotatestart",l)),this._pitching&&!v.pitching&&this.fire(new s.l("pitchstart",l)),this._rolling&&!v.rolling&&this.fire(new s.l("rollstart",l))}_prepareElevation(l){this._elevationCenter=l,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(l,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(l){this._elevationStart!==void 0&&this._elevationCenter!==void 0||this._prepareElevation(this.transform.center),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const f=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(l<1&&f!==this._elevationTarget){const v=this._elevationTarget-this._elevationStart;this._elevationStart+=l*(v-(f-(v*l+this._elevationStart))/(1-l)),this._elevationTarget=f}this.transform.setElevation(s.G.number(this._elevationStart,this._elevationTarget,l))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(l){if(!this.terrain&&l.elevation>=0&&l.pitch<=90)return{};const f=l.getCameraLngLat(),v=l.getCameraAltitude(),w=this.terrain?this.terrain.getElevationForLngLatZoom(f,l.zoom):0;if(v<w){const I=this.calculateCameraOptionsFromTo(f,w,l.center,l.elevation);return{pitch:I.pitch,zoom:I.zoom}}return{}}_applyUpdatedTransform(l){const f=[];if(f.push((w=>this._elevateCameraIfInsideTerrain(w))),this.transformCameraUpdate&&f.push((w=>this.transformCameraUpdate(w))),!f.length)return;const v=l.clone();for(const w of f){const I=v.clone(),{center:k,zoom:B,roll:W,pitch:Z,bearing:J,elevation:ue}=w(I);k&&I.setCenter(k),ue!==void 0&&I.setElevation(ue),B!==void 0&&I.setZoom(B),W!==void 0&&I.setRoll(W),Z!==void 0&&I.setPitch(Z),J!==void 0&&I.setBearing(J),v.apply(I)}this.transform.apply(v)}_fireMoveEvents(l){this.fire(new s.l("move",l)),this._zooming&&this.fire(new s.l("zoom",l)),this._rotating&&this.fire(new s.l("rotate",l)),this._pitching&&this.fire(new s.l("pitch",l)),this._rolling&&this.fire(new s.l("roll",l))}_afterEase(l,f){if(this._easeId&&f&&this._easeId===f)return;delete this._easeId;const v=this._zooming,w=this._rotating,I=this._pitching,k=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,v&&this.fire(new s.l("zoomend",l)),w&&this.fire(new s.l("rotateend",l)),I&&this.fire(new s.l("pitchend",l)),k&&this.fire(new s.l("rollend",l)),this.fire(new s.l("moveend",l))}flyTo(l,f){if(!l.essential&&b.prefersReducedMotion){const It=s.U(l,["center","zoom","bearing","pitch","roll","elevation","padding"]);return this.jumpTo(It,f)}this.stop(),l=s.e({offset:[0,0],speed:1.2,curve:1.42,easing:s.cy},l);const v=this._getTransformForUpdate(),w=v.bearing,I=v.pitch,k=v.roll,B=v.padding,W="bearing"in l?this._normalizeBearing(l.bearing,w):w,Z="pitch"in l?+l.pitch:I,J="roll"in l?this._normalizeBearing(l.roll,k):k,ue="padding"in l?l.padding:v.padding,le=s.P.convert(l.offset);let _e=v.centerPoint.add(le);const Ee=v.screenPointToLocation(_e),ze=this.cameraHelper.handleFlyTo(v,{bearing:W,pitch:Z,roll:J,padding:ue,locationAtOffset:Ee,offsetAsPoint:le,center:l.center,minZoom:l.minZoom,zoom:l.zoom});let $e=l.curve;const Ne=Math.max(v.width,v.height),Ze=Ne/ze.scaleOfZoom,rt=ze.pixelPathLength;typeof ze.scaleOfMinZoom=="number"&&($e=Math.sqrt(Ne/ze.scaleOfMinZoom/rt*2));const We=$e*$e;function it(It){const Qt=(Ze*Ze-Ne*Ne+(It?-1:1)*We*We*rt*rt)/(2*(It?Ze:Ne)*We*rt);return Math.log(Math.sqrt(Qt*Qt+1)-Qt)}function lt(It){return(Math.exp(It)-Math.exp(-It))/2}function Qe(It){return(Math.exp(It)+Math.exp(-It))/2}const _t=it(!1);let Dt=function(It){return Qe(_t)/Qe(_t+$e*It)},At=function(It){return Ne*((Qe(_t)*(lt(Qt=_t+$e*It)/Qe(Qt))-lt(_t))/We)/rt;var Qt},Pt=(it(!0)-_t)/$e;if(Math.abs(rt)<2e-6||!isFinite(Pt)){if(Math.abs(Ne-Ze)<1e-6)return this.easeTo(l,f);const It=Ze<Ne?-1:1;Pt=Math.abs(Math.log(Ze/Ne))/$e,At=()=>0,Dt=Qt=>Math.exp(It*$e*Qt)}return l.duration="duration"in l?+l.duration:1e3*Pt/("screenSpeed"in l?+l.screenSpeed/$e:+l.speed),l.maxDuration&&l.duration>l.maxDuration&&(l.duration=0),this._zooming=!0,this._rotating=w!==W,this._pitching=Z!==I,this._rolling=J!==k,this._padding=!v.isPaddingEqual(ue),this._prepareEase(f,!1),this.terrain&&this._prepareElevation(ze.targetCenter),this._ease((It=>{const Qt=It*Pt,ti=1/Dt(Qt),Xt=At(Qt);this._rotating&&v.setBearing(s.G.number(w,W,It)),this._pitching&&v.setPitch(s.G.number(I,Z,It)),this._rolling&&v.setRoll(s.G.number(k,J,It)),this._padding&&(v.interpolatePadding(B,ue,It),_e=v.centerPoint.add(le)),ze.easeFunc(It,ti,Xt,_e),this.terrain&&!l.freezeElevation&&this._updateElevation(It),this._applyUpdatedTransform(v),this._fireMoveEvents(f)}),(()=>{this.terrain&&l.freezeElevation&&this._finalizeElevation(),this._afterEase(f)}),l),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(l,f){var v;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const w=this._onEaseEnd;delete this._onEaseEnd,w.call(this,f)}return l||(v=this.handlers)===null||v===void 0||v.stop(!1),this}_ease(l,f,v){v.animate===!1||v.duration===0?(l(1),f()):(this._easeStart=P(),this._easeOptions=v,this._onEaseFrame=l,this._onEaseEnd=f,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(l,f){l=s.W(l,-180,180);const v=Math.abs(l-f);return Math.abs(l-360-f)<v&&(l-=360),Math.abs(l+360-f)<v&&(l+=360),l}queryTerrainElevation(l){return this.terrain?this.terrain.getElevationForLngLat(s.V.convert(l),this.transform):null}}const fa={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class j_{constructor(l=fa){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=f=>{!f||f.sourceDataType!=="metadata"&&f.sourceDataType!=="visibility"&&f.dataType!=="style"&&f.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=l}getDefaultPosition(){return"bottom-right"}onAdd(l){return this._map=l,this._compact=this.options.compact,this._container=L.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=L.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=L.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){L.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(l,f){const v=this._map._getUIString(`AttributionControl.${f}`);l.title=v,l.setAttribute("aria-label",v)}_updateAttributions(){if(!this._map.style)return;let l=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?l=l.concat(this.options.customAttribution.map((w=>typeof w!="string"?"":w))):typeof this.options.customAttribution=="string"&&l.push(this.options.customAttribution)),this._map.style.stylesheet){const w=this._map.style.stylesheet;this.styleOwner=w.owner,this.styleId=w.id}const f=this._map.style.tileManagers;for(const w in f){const I=f[w];if(I.used||I.usedForTerrain){const k=I.getSource();k.attribution&&l.indexOf(k.attribution)<0&&l.push(k.attribution)}}l=l.filter((w=>String(w).trim())),l.sort(((w,I)=>w.length-I.length)),l=l.filter(((w,I)=>{for(let k=I+1;k<l.length;k++)if(l[k].indexOf(w)>=0)return!1;return!0}));const v=l.join(" | ");v!==this._attribHTML&&(this._attribHTML=v,l.length?(this._innerContainer.innerHTML=L.sanitize(v),this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class X0{constructor(l={}){this._updateCompact=()=>{const f=this._container.children;if(f.length){const v=f[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&v.classList.add("maplibregl-compact"):v.classList.remove("maplibregl-compact")}},this.options=l}getDefaultPosition(){return"bottom-left"}onAdd(l){this._map=l,this._compact=this.options&&this.options.compact,this._container=L.create("div","maplibregl-ctrl");const f=L.create("a","maplibregl-ctrl-logo");return f.target="_blank",f.rel="noopener nofollow",f.href="https://maplibre.org/",f.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),f.setAttribute("rel","noopener nofollow"),this._container.appendChild(f),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){L.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class B1{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(l){const f=++this._id;return this._queue.push({callback:l,id:f,cancelled:!1}),f}remove(l){const f=this._currentlyRunning,v=f?this._queue.concat(f):this._queue;for(const w of v)if(w.id===l)return void(w.cancelled=!0)}run(l=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const f=this._currentlyRunning=this._queue;this._queue=[];for(const v of f)if(!v.cancelled&&(v.callback(l),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var N1=s.aU([{name:"a_pos3d",type:"Int16",components:3}]);class Ef extends s.E{constructor(l){super(),this._lastTilesetChange=P(),this.tileManager=l,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=l._source.tileSize*2**this.deltaZoom,l.usedForTerrain=!0,l.tileSize=this.tileSize}destruct(){this.tileManager.usedForTerrain=!1,this.tileManager.tileSize=null}getSource(){return this.tileManager._source}update(l,f){this.tileManager.update(l,f),this._renderableTilesKeys=[];const v={};for(const w of kn(l,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:f,calculateTileZoom:this.tileManager._source.calculateTileZoom}))v[w.key]=!0,this._renderableTilesKeys.push(w.key),this._tiles[w.key]||(w.terrainRttPosMatrix32f=new Float64Array(16),s.c7(w.terrainRttPosMatrix32f,0,s.a5,s.a5,0,0,1),this._tiles[w.key]=new Lt(w,this.tileSize),this._lastTilesetChange=P());for(const w in this._tiles)v[w]||delete this._tiles[w]}freeRtt(l){for(const f in this._tiles){const v=this._tiles[f];(!l||v.tileID.equals(l)||v.tileID.isChildOf(l)||l.isChildOf(v.tileID))&&(v.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map((l=>this.getTileByID(l)))}getTileByID(l){return this._tiles[l]}getTerrainCoords(l,f){return f?this._getTerrainCoordsForTileRanges(l,f):this._getTerrainCoordsForRegularTile(l)}_getTerrainCoordsForRegularTile(l){const f={};for(const v of this._renderableTilesKeys){const w=this._tiles[v].tileID,I=l.clone(),k=s.bk();if(w.canonical.equals(l.canonical))s.c7(k,0,s.a5,s.a5,0,0,1);else if(w.canonical.isChildOf(l.canonical)){const B=w.canonical.z-l.canonical.z,W=w.canonical.x-(w.canonical.x>>B<<B),Z=w.canonical.y-(w.canonical.y>>B<<B),J=s.a5>>B;s.c7(k,0,J,J,0,0,1),s.O(k,k,[-W*J,-Z*J,0])}else{if(!l.canonical.isChildOf(w.canonical))continue;{const B=l.canonical.z-w.canonical.z,W=l.canonical.x-(l.canonical.x>>B<<B),Z=l.canonical.y-(l.canonical.y>>B<<B),J=s.a5>>B;s.c7(k,0,s.a5,s.a5,0,0,1),s.O(k,k,[W*J,Z*J,0]),s.Q(k,k,[1/2**B,1/2**B,0])}}I.terrainRttPosMatrix32f=new Float32Array(k),f[v]=I}return f}_getTerrainCoordsForTileRanges(l,f){const v={};for(const w of this._renderableTilesKeys){const I=this._tiles[w].tileID;if(!this._isWithinTileRanges(I,f))continue;const k=l.clone(),B=s.bk();if(I.canonical.z===l.canonical.z){const W=l.canonical.x-I.canonical.x,Z=l.canonical.y-I.canonical.y;s.c7(B,0,s.a5,s.a5,0,0,1),s.O(B,B,[W*s.a5,Z*s.a5,0])}else if(I.canonical.z>l.canonical.z){const W=I.canonical.z-l.canonical.z,Z=I.canonical.x-(I.canonical.x>>W<<W),J=I.canonical.y-(I.canonical.y>>W<<W),ue=l.canonical.x-(I.canonical.x>>W),le=l.canonical.y-(I.canonical.y>>W),_e=s.a5>>W;s.c7(B,0,_e,_e,0,0,1),s.O(B,B,[-Z*_e+ue*s.a5,-J*_e+le*s.a5,0])}else{const W=l.canonical.z-I.canonical.z,Z=l.canonical.x-(l.canonical.x>>W<<W),J=l.canonical.y-(l.canonical.y>>W<<W),ue=(l.canonical.x>>W)-I.canonical.x,le=(l.canonical.y>>W)-I.canonical.y,_e=s.a5<<W;s.c7(B,0,_e,_e,0,0,1),s.O(B,B,[Z*s.a5+ue*_e,J*s.a5+le*_e,0])}k.terrainRttPosMatrix32f=new Float32Array(B),v[w]=k}return v}getSourceTile(l,f){const v=this.tileManager._source;let w=l.overscaledZ-this.deltaZoom;if(w>v.maxzoom&&(w=v.maxzoom),w<v.minzoom)return;this._sourceTileCache[l.key]||(this._sourceTileCache[l.key]=l.scaledTo(w).key);let I=this.findTileInCaches(this._sourceTileCache[l.key]);if(!I?.dem&&f)for(;w>=v.minzoom&&!I?.dem;)I=this.findTileInCaches(l.scaledTo(w--).key);return I}findTileInCaches(l){let f=this.tileManager.getTileByID(l);return f||(f=this.tileManager._outOfViewCache.getByKey(l),f)}anyTilesAfterTime(l=Date.now()){return this._lastTilesetChange>=l}_isWithinTileRanges(l,f){return f[l.canonical.z]&&l.canonical.x>=f[l.canonical.z].minTileX&&l.canonical.x<=f[l.canonical.z].maxTileX&&l.canonical.y>=f[l.canonical.z].minTileY&&l.canonical.y<=f[l.canonical.z].maxTileY}}class Ir{constructor(l,f,v){this._meshCache={},this.painter=l,this.tileManager=new Ef(f),this.options=v,this.exaggeration=typeof v.exaggeration=="number"?v.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(l,f,v,w=s.a5){var I;if(!(f>=0&&f<w&&v>=0&&v<w))return 0;const k=this.getTerrainData(l),B=(I=k.tile)===null||I===void 0?void 0:I.dem;if(!B)return 0;const W=s.cC([],[f/w*s.a5,v/w*s.a5],k.u_terrain_matrix),Z=[W[0]*B.dim,W[1]*B.dim],J=Math.floor(Z[0]),ue=Math.floor(Z[1]),le=Z[0]-J,_e=Z[1]-ue;return B.get(J,ue)*(1-le)*(1-_e)+B.get(J+1,ue)*le*(1-_e)+B.get(J,ue+1)*(1-le)*_e+B.get(J+1,ue+1)*le*_e}getElevationForLngLatZoom(l,f){if(!s.cD(f,l.wrap()))return 0;const{tileID:v,mercatorX:w,mercatorY:I}=this._getOverscaledTileIDFromLngLatZoom(l,f);return this.getElevation(v,w%s.a5,I%s.a5,s.a5)}getElevationForLngLat(l,f){const v=kn(f,{maxzoom:this.tileManager.maxzoom,minzoom:this.tileManager.minzoom,tileSize:512,terrain:this});let w=0;for(const I of v)I.canonical.z>w&&(w=Math.min(I.canonical.z,this.tileManager.maxzoom));return this.getElevationForLngLatZoom(l,w)}getElevation(l,f,v,w=s.a5){return this.getDEMElevation(l,f,v,w)*this.exaggeration}getTerrainData(l){if(!this._emptyDemTexture){const w=this.painter.context,I=new s.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new s.T(w,I,w.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new s.T(w,new s.R({width:1,height:1}),w.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(w.gl.NEAREST,w.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=s.ar([])}const f=this.tileManager.getSourceTile(l,!0);if(f&&f.dem&&(!f.demTexture||f.needsTerrainPrepare)){const w=this.painter.context;f.demTexture=this.painter.getTileTexture(f.dem.stride),f.demTexture?f.demTexture.update(f.dem.getPixels(),{premultiply:!1}):f.demTexture=new s.T(w,f.dem.getPixels(),w.gl.RGBA,{premultiply:!1}),f.demTexture.bind(w.gl.NEAREST,w.gl.CLAMP_TO_EDGE),f.needsTerrainPrepare=!1}const v=f&&f.toString()+f.tileID.key+l.key;if(v&&!this._demMatrixCache[v]){const w=this.tileManager.getSource().maxzoom;let I=l.canonical.z-f.tileID.canonical.z;l.overscaledZ>l.canonical.z&&(l.canonical.z>=w?I=l.canonical.z-w:s.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const k=l.canonical.x-(l.canonical.x>>I<<I),B=l.canonical.y-(l.canonical.y>>I<<I),W=s.cE(new Float64Array(16),[1/(s.a5<<I),1/(s.a5<<I),0]);s.O(W,W,[k*s.a5,B*s.a5,0]),this._demMatrixCache[l.key]={matrix:W,coord:l}}return{u_depth:2,u_terrain:3,u_terrain_dim:f&&f.dem&&f.dem.dim||1,u_terrain_matrix:v?this._demMatrixCache[l.key].matrix:this._emptyDemMatrix,u_terrain_unpack:f&&f.dem&&f.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(f&&f.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:f}}getFramebuffer(l){const f=this.painter,v=f.width/devicePixelRatio,w=f.height/devicePixelRatio;return!this._fbo||this._fbo.width===v&&this._fbo.height===w||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new s.T(f.context,{width:v,height:w,data:null},f.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(f.context.gl.NEAREST,f.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new s.T(f.context,{width:v,height:w,data:null},f.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(f.context.gl.NEAREST,f.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=f.context.createFramebuffer(v,w,!0,!1),this._fbo.depthAttachment.set(f.context.createRenderbuffer(f.context.gl.DEPTH_COMPONENT16,v,w))),this._fbo.colorAttachment.set(l==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const l=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const f=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let I=0,k=0;I<this._coordsTextureSize;I++)for(let B=0;B<this._coordsTextureSize;B++,k+=4)f[k+0]=255&B,f[k+1]=255&I,f[k+2]=B>>8<<4|I>>8,f[k+3]=0;const v=new s.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(f.buffer)),w=new s.T(l,v,l.gl.RGBA,{premultiply:!1});return w.bind(l.gl.NEAREST,l.gl.CLAMP_TO_EDGE),this._coordsTexture=w,w}pointCoordinate(l){this.painter.maybeDrawDepthAndCoords(!0);const f=new Uint8Array(4),v=this.painter.context,w=v.gl,I=Math.round(l.x*this.painter.pixelRatio/devicePixelRatio),k=Math.round(l.y*this.painter.pixelRatio/devicePixelRatio),B=Math.round(this.painter.height/devicePixelRatio);v.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),w.readPixels(I,B-k-1,1,1,w.RGBA,w.UNSIGNED_BYTE,f),v.bindFramebuffer.set(null);const W=f[0]+(f[2]>>4<<8),Z=f[1]+((15&f[2])<<8),J=this.coordsIndex[255-f[3]],ue=J&&this.tileManager.getTileByID(J);if(!ue)return null;const le=this._coordsTextureSize,_e=(1<<ue.tileID.canonical.z)*le;return new s.a9((ue.tileID.canonical.x*le+W)/_e+ue.tileID.wrap,(ue.tileID.canonical.y*le+Z)/_e,this.getElevation(ue.tileID,W,Z,le))}depthAtPoint(l){const f=new Uint8Array(4),v=this.painter.context,w=v.gl;return v.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),w.readPixels(l.x,this.painter.height/devicePixelRatio-l.y-1,1,1,w.RGBA,w.UNSIGNED_BYTE,f),v.bindFramebuffer.set(null),(f[0]/16777216+f[1]/65536+f[2]/256+f[3])/256}getTerrainMesh(l){var f;const v=((f=this.painter.style.projection)===null||f===void 0?void 0:f.transitionState)>0,w=v&&l.canonical.y===0,I=v&&l.canonical.y===(1<<l.canonical.z)-1,k=`m_${w?"n":""}_${I?"s":""}`;if(this._meshCache[k])return this._meshCache[k];const B=this.painter.context,W=new s.cF,Z=new s.aY,J=this.meshSize,ue=s.a5/J,le=J*J;for(let Qe=0;Qe<=J;Qe++)for(let _t=0;_t<=J;_t++)W.emplaceBack(_t*ue,Qe*ue,0);for(let Qe=0;Qe<le;Qe+=J+1)for(let _t=0;_t<J;_t++)Z.emplaceBack(_t+Qe,J+_t+Qe+1,J+_t+Qe+2),Z.emplaceBack(_t+Qe,J+_t+Qe+2,_t+Qe+1);const _e=W.length,Ee=_e+(J+1),ze=(J+1)*J,$e=w?s.br:0,Ne=w?0:1,Ze=I?s.bs:s.a5,rt=I?0:1;for(let Qe=0;Qe<=J;Qe++)W.emplaceBack(Qe*ue,$e,Ne);for(let Qe=0;Qe<=J;Qe++)W.emplaceBack(Qe*ue,Ze,rt);for(let Qe=0;Qe<J;Qe++)Z.emplaceBack(ze+Qe,Ee+Qe,Ee+Qe+1),Z.emplaceBack(ze+Qe,Ee+Qe+1,ze+Qe+1),Z.emplaceBack(0+Qe,_e+Qe+1,_e+Qe),Z.emplaceBack(0+Qe,0+Qe+1,_e+Qe+1);const We=W.length,it=We+2*(J+1);for(const Qe of[0,1])for(let _t=0;_t<=J;_t++)for(const Dt of[0,1])W.emplaceBack(Qe*s.a5,_t*ue,Dt);for(let Qe=0;Qe<2*J;Qe+=2)Z.emplaceBack(We+Qe,We+Qe+1,We+Qe+3),Z.emplaceBack(We+Qe,We+Qe+3,We+Qe+2),Z.emplaceBack(it+Qe,it+Qe+3,it+Qe+1),Z.emplaceBack(it+Qe,it+Qe+2,it+Qe+3);const lt=new Bn(B.createVertexBuffer(W,N1.members),B.createIndexBuffer(Z),s.aX.simpleSegment(0,0,W.length,Z.length));return this._meshCache[k]=lt,lt}getMeshFrameDelta(l){return 2*Math.PI*s.bE/Math.pow(2,Math.max(l,0))/5}getMinTileElevationForLngLatZoom(l,f){var v;if(!s.cD(f,l.wrap()))return 0;const{tileID:w}=this._getOverscaledTileIDFromLngLatZoom(l,f);return(v=this.getMinMaxElevation(w).minElevation)!==null&&v!==void 0?v:0}getMinMaxElevation(l){const f=this.getTerrainData(l).tile,v={minElevation:null,maxElevation:null};return f&&f.dem&&(v.minElevation=f.dem.min*this.exaggeration,v.maxElevation=f.dem.max*this.exaggeration),v}_getOverscaledTileIDFromLngLatZoom(l,f){const v=s.a9.fromLngLat(l.wrap()),w=(1<<f)*s.a5,I=v.x*w,k=v.y*w,B=Math.floor(I/s.a5),W=Math.floor(k/s.a5);return{tileID:new s.a2(f,0,f,B,W),mercatorX:I,mercatorY:k}}}class Zr{constructor(l,f,v){this._context=l,this._size=f,this._tileSize=v,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const l of this._objects)l.texture.destroy(),l.fbo.destroy()}_createObject(l){const f=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),v=new s.T(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return v.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),f.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),f.colorAttachment.set(v.texture),{id:l,fbo:f,texture:v,stamp:-1,inUse:!1}}getObjectForId(l){return this._objects[l]}useObject(l){l.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter((f=>l.id!==f)),this._recentlyUsed.push(l.id)}stampObject(l){l.stamp=++this._stamp}getOrCreateFreeObject(){for(const f of this._recentlyUsed)if(!this._objects[f].inUse)return this._objects[f];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const l=this._createObject(this._objects.length);return this._objects.push(l),l}freeObject(l){l.inUse=!1}freeAllObjects(){for(const l of this._objects)this.freeObject(l)}isFull(){return!(this._objects.length<this._size)&&this._objects.some((l=>!l.inUse))===!1}}const Gu={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0,"color-relief":!0};class Af{constructor(l,f){this.painter=l,this.terrain=f,this.pool=new Zr(l.context,30,f.tileManager.tileSize*f.qualityFactor)}destruct(){this.pool.destruct()}getTexture(l){return this.pool.getObjectForId(l.rtt[this._stacks.length-1].id).texture}prepareForRender(l,f){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.tileManager.getRenderableTiles(),this._renderableLayerIds=l._order.filter((v=>!l._layers[v].isHidden(f))),this._coordsAscending={};for(const v in l.tileManagers){this._coordsAscending[v]={};const w=l.tileManagers[v].getVisibleCoordinates(),I=l.tileManagers[v].getSource(),k=I instanceof bt?I.terrainTileRanges:null;for(const B of w){const W=this.terrain.tileManager.getTerrainCoords(B,k);for(const Z in W)this._coordsAscending[v][Z]||(this._coordsAscending[v][Z]=[]),this._coordsAscending[v][Z].push(W[Z])}}this._coordsAscendingStr={};for(const v of l._order){const w=l._layers[v],I=w.source;if(Gu[w.type]&&!this._coordsAscendingStr[I]){this._coordsAscendingStr[I]={};for(const k in this._coordsAscending[I])this._coordsAscendingStr[I][k]=this._coordsAscending[I][k].map((B=>B.key)).sort().join()}}for(const v of this._renderableTiles)for(const w in this._coordsAscendingStr){const I=this._coordsAscendingStr[w][v.tileID.key];I&&I!==v.rttCoords[w]&&(v.rtt=[])}}renderLayer(l,f){if(l.isHidden(this.painter.transform.zoom))return!1;const v=Object.assign(Object.assign({},f),{isRenderingToTexture:!0}),w=l.type,I=this.painter,k=this._renderableLayerIds[this._renderableLayerIds.length-1]===l.id;if(Gu[w]&&(this._prevType&&Gu[this._prevType]||this._stacks.push([]),this._prevType=w,this._stacks[this._stacks.length-1].push(l.id),!k))return!0;if(Gu[this._prevType]||Gu[w]&&k){this._prevType=w;const B=this._stacks.length-1,W=this._stacks[B]||[];for(const Z of this._renderableTiles){if(this.pool.isFull()&&(L_(this.painter,this.terrain,this._rttTiles,v),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(Z),Z.rtt[B]){const ue=this.pool.getObjectForId(Z.rtt[B].id);if(ue.stamp===Z.rtt[B].stamp){this.pool.useObject(ue);continue}}const J=this.pool.getOrCreateFreeObject();this.pool.useObject(J),this.pool.stampObject(J),Z.rtt[B]={id:J.id,stamp:J.stamp},I.context.bindFramebuffer.set(J.fbo.framebuffer),I.context.clear({color:s.bp.transparent,stencil:0}),I.currentStencilSource=void 0;for(let ue=0;ue<W.length;ue++){const le=I.style._layers[W[ue]],_e=le.source?this._coordsAscending[le.source][Z.tileID.key]:[Z.tileID];I.context.viewport.set([0,0,J.fbo.width,J.fbo.height]),I._renderTileClippingMasks(le,_e,!0),I.renderLayer(I,I.style.tileManagers[le.source],le,_e,v),le.source&&(Z.rttCoords[le.source]=this._coordsAscendingStr[le.source][Z.tileID.key])}}return L_(this.painter,this.terrain,this._rttTiles,v),this._rttTiles=[],this.pool.freeAllObjects(),Gu[w]}return!1}}const dm={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use â + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},G_=d,fm={hash:!1,interactive:!0,bearingSnap:7,attributionControl:fa,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:s.c.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,transformConstrain:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,reduceMotion:void 0,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0,experimentalZoomLevelsToOverscale:void 0},q_={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class Pf{constructor(l,f,v=!1){this.mousedown=I=>{this.startMove(I,L.mousePos(this.element,I)),L.addEventListener(window,"mousemove",this.mousemove),L.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=I=>{this.move(I,L.mousePos(this.element,I))},this.mouseup=I=>{this._rotatePitchHandler.dragEnd(I),this.offTemp()},this.touchstart=I=>{I.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=L.touchPos(this.element,I.targetTouches)[0],this.startMove(I,this._startPos),L.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),L.addEventListener(window,"touchend",this.touchend))},this.touchmove=I=>{I.targetTouches.length!==1?this.reset():(this._lastPos=L.touchPos(this.element,I.targetTouches)[0],this.move(I,this._lastPos))},this.touchend=I=>{I.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHandler.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=f;const w=new U0;this._rotatePitchHandler=new ed({clickTolerance:3,move:(I,k)=>{const B=f.getBoundingClientRect(),W=new s.P((B.bottom-B.top)/2,(B.right-B.left)/2);return{bearingDelta:s.cx(new s.P(I.x,k.y),k,W),pitchDelta:v?-.5*(k.y-I.y):void 0}},moveStateManager:w,enable:!0,assignEvents:()=>{}}),this.map=l,L.addEventListener(f,"mousedown",this.mousedown),L.addEventListener(f,"touchstart",this.touchstart,{passive:!1}),L.addEventListener(f,"touchcancel",this.reset)}startMove(l,f){this._rotatePitchHandler.dragStart(l,f),L.disableDrag()}move(l,f){const v=this.map,{bearingDelta:w,pitchDelta:I}=this._rotatePitchHandler.dragMove(l,f)||{};w&&v.setBearing(v.getBearing()+w),I&&v.setPitch(v.getPitch()+I)}off(){const l=this.element;L.removeEventListener(l,"mousedown",this.mousedown),L.removeEventListener(l,"touchstart",this.touchstart,{passive:!1}),L.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),L.removeEventListener(window,"touchend",this.touchend),L.removeEventListener(l,"touchcancel",this.reset),this.offTemp()}offTemp(){L.enableDrag(),L.removeEventListener(window,"mousemove",this.mousemove),L.removeEventListener(window,"mouseup",this.mouseup),L.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),L.removeEventListener(window,"touchend",this.touchend)}}let ac;function pm(A,l,f,v=!1){if(v||!f.getCoveringTilesDetailsProvider().allowWorldCopies())return A?.wrap();const w=new s.V(A.lng,A.lat);if(A=new s.V(A.lng,A.lat),l){const I=new s.V(A.lng-360,A.lat),k=new s.V(A.lng+360,A.lat),B=f.locationToScreenPoint(A).distSqr(l);f.locationToScreenPoint(I).distSqr(l)<B?A=I:f.locationToScreenPoint(k).distSqr(l)<B&&(A=k)}for(;Math.abs(A.lng-f.center.lng)>180;){const I=f.locationToScreenPoint(A);if(I.x>=0&&I.y>=0&&I.x<=f.width&&I.y<=f.height)break;A.lng>f.center.lng?A.lng-=360:A.lng+=360}return A.lng!==w.lng&&f.isPointOnMapSurface(f.locationToScreenPoint(A))?A:w}const If={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function mm(A,l,f){const v=A.classList;for(const w in If)v.remove(`maplibregl-${f}-anchor-${w}`);v.add(`maplibregl-${f}-anchor-${l}`)}class Rf extends s.E{constructor(l){if(super(),this._onKeyPress=f=>{const v=f.code,w=f.charCode||f.keyCode;v!=="Space"&&v!=="Enter"&&w!==32&&w!==13||this.togglePopup()},this._onMapClick=f=>{const v=f.originalEvent.target,w=this._element;this._popup&&(v===w||w.contains(v))&&this.togglePopup()},this._update=f=>{if(!this._map)return;const v=this._map.loaded()&&!this._map.isMoving();(f?.type==="terrain"||f?.type==="render"&&!v)&&this._map.once("render",this._update),this._lngLat=pm(this._lngLat,this._flatPos,this._map.transform),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let w="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?w=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(w=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let I="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?I="rotateX(0deg)":this._pitchAlignment==="map"&&(I=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||f&&f.type!=="moveend"||(this._pos=this._pos.round()),L.setTransform(this._element,`${If[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${I} ${w}`),b.frameAsync(new AbortController).then((()=>{this._updateOpacity(f&&f.type==="moveend")})).catch((()=>{}))},this._onMove=f=>{if(!this._isDragging){const v=this._clickTolerance||this._map._clickTolerance;this._isDragging=f.point.dist(this._pointerdownPos)>=v}this._isDragging&&(this._pos=f.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.l("dragstart"))),this.fire(new s.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new s.l("dragend")),this._state="inactive"},this._addDragHandler=f=>{this._element.contains(f.originalEvent.target)&&(f.preventDefault(),this._positionDelta=f.point.sub(this._pos).add(this._offset),this._pointerdownPos=f.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=l&&l.anchor||"center",this._color=l&&l.color||"#3FB1CE",this._scale=l&&l.scale||1,this._draggable=l&&l.draggable||!1,this._clickTolerance=l&&l.clickTolerance||0,this._subpixelPositioning=l&&l.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=l&&l.rotation||0,this._rotationAlignment=l&&l.rotationAlignment||"auto",this._pitchAlignment=l&&l.pitchAlignment&&l.pitchAlignment!=="auto"?l.pitchAlignment:this._rotationAlignment,this.setOpacity(l?.opacity,l?.opacityWhenCovered),l&&l.element)this._element=l.element,this._offset=s.P.convert(l&&l.offset||[0,0]);else{this._defaultMarker=!0,this._element=L.create("div");const f=L.createNS("http://www.w3.org/2000/svg","svg"),v=41,w=27;f.setAttributeNS(null,"display","block"),f.setAttributeNS(null,"height",`${v}px`),f.setAttributeNS(null,"width",`${w}px`),f.setAttributeNS(null,"viewBox",`0 0 ${w} ${v}`);const I=L.createNS("http://www.w3.org/2000/svg","g");I.setAttributeNS(null,"stroke","none"),I.setAttributeNS(null,"stroke-width","1"),I.setAttributeNS(null,"fill","none"),I.setAttributeNS(null,"fill-rule","evenodd");const k=L.createNS("http://www.w3.org/2000/svg","g");k.setAttributeNS(null,"fill-rule","nonzero");const B=L.createNS("http://www.w3.org/2000/svg","g");B.setAttributeNS(null,"transform","translate(3.0, 29.0)"),B.setAttributeNS(null,"fill","#000000");const W=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const Ne of W){const Ze=L.createNS("http://www.w3.org/2000/svg","ellipse");Ze.setAttributeNS(null,"opacity","0.04"),Ze.setAttributeNS(null,"cx","10.5"),Ze.setAttributeNS(null,"cy","5.80029008"),Ze.setAttributeNS(null,"rx",Ne.rx),Ze.setAttributeNS(null,"ry",Ne.ry),B.appendChild(Ze)}const Z=L.createNS("http://www.w3.org/2000/svg","g");Z.setAttributeNS(null,"fill",this._color);const J=L.createNS("http://www.w3.org/2000/svg","path");J.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),Z.appendChild(J);const ue=L.createNS("http://www.w3.org/2000/svg","g");ue.setAttributeNS(null,"opacity","0.25"),ue.setAttributeNS(null,"fill","#000000");const le=L.createNS("http://www.w3.org/2000/svg","path");le.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),ue.appendChild(le);const _e=L.createNS("http://www.w3.org/2000/svg","g");_e.setAttributeNS(null,"transform","translate(6.0, 7.0)"),_e.setAttributeNS(null,"fill","#FFFFFF");const Ee=L.createNS("http://www.w3.org/2000/svg","g");Ee.setAttributeNS(null,"transform","translate(8.0, 8.0)");const ze=L.createNS("http://www.w3.org/2000/svg","circle");ze.setAttributeNS(null,"fill","#000000"),ze.setAttributeNS(null,"opacity","0.25"),ze.setAttributeNS(null,"cx","5.5"),ze.setAttributeNS(null,"cy","5.5"),ze.setAttributeNS(null,"r","5.4999962");const $e=L.createNS("http://www.w3.org/2000/svg","circle");$e.setAttributeNS(null,"fill","#FFFFFF"),$e.setAttributeNS(null,"cx","5.5"),$e.setAttributeNS(null,"cy","5.5"),$e.setAttributeNS(null,"r","5.4999962"),Ee.appendChild(ze),Ee.appendChild($e),k.appendChild(B),k.appendChild(Z),k.appendChild(ue),k.appendChild(_e),k.appendChild(Ee),f.appendChild(k),f.setAttributeNS(null,"height",v*this._scale+"px"),f.setAttributeNS(null,"width",w*this._scale+"px"),this._element.appendChild(f),this._offset=s.P.convert(l&&l.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",(f=>{f.preventDefault()})),this._element.addEventListener("mousedown",(f=>{f.preventDefault()})),mm(this._element,this._anchor,"marker"),l&&l.className)for(const f of l.className.split(" "))this._element.classList.add(f);this._popup=null}addTo(l){return this.remove(),this._map=l,this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label",l._getUIString("Marker.Title")),this._element.hasAttribute("role")||this._element.setAttribute("role","button"),l.getCanvasContainer().appendChild(this._element),l.on("move",this._update),l.on("moveend",this._update),l.on("terrain",this._update),l.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),L.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(l){return this._lngLat=s.V.convert(l),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(l){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),l){if(!("offset"in l.options)){const w=Math.abs(13.5)/Math.SQRT2;l.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[w,-1*(38.1-13.5+w)],"bottom-right":[-w,-1*(38.1-13.5+w)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=l,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(l){return this._subpixelPositioning=l,this}getPopup(){return this._popup}togglePopup(){const l=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:l?(l.isOpen()?l.remove():(l.setLngLat(this._lngLat),l.addTo(this._map)),this):this}_updateOpacity(l=!1){var f,v;const w=(f=this._map)===null||f===void 0?void 0:f.terrain,I=this._map.transform.isLocationOccluded(this._lngLat);if(!w||I){const _e=I?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==_e&&(this._element.style.opacity=_e))}if(l)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout((()=>{this._opacityTimeout=null}),100)}const k=this._map,B=k.terrain.depthAtPoint(this._pos),W=k.terrain.getElevationForLngLat(this._lngLat,k.transform);if(k.transform.lngLatToCameraDepth(this._lngLat,W)-B<.006)return void(this._element.style.opacity=this._opacity);const Z=-this._offset.y/k.transform.pixelsPerMeter,J=Math.sin(k.getPitch()*Math.PI/180)*Z,ue=k.terrain.depthAtPoint(new s.P(this._pos.x,this._pos.y-this._offset.y)),le=k.transform.lngLatToCameraDepth(this._lngLat,W+J)-ue>.006;!((v=this._popup)===null||v===void 0)&&v.isOpen()&&le&&this._popup.remove(),this._element.style.opacity=le?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(l){return this._offset=s.P.convert(l),this._update(),this}addClassName(l){this._element.classList.add(l)}removeClassName(l){this._element.classList.remove(l)}toggleClassName(l){return this._element.classList.toggle(l)}setDraggable(l){return this._draggable=!!l,this._map&&(l?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(l){return this._rotation=l||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(l){return this._rotationAlignment=l||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(l){return this._pitchAlignment=l&&l!=="auto"?l:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(l,f){return(this._opacity===void 0||l===void 0&&f===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),l!==void 0&&(this._opacity=l),f!==void 0&&(this._opacityWhenCovered=f),this._map&&this._updateOpacity(!0),this}}const W_={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let id=0,qu=!1;const H_={maxWidth:100,unit:"metric"};function Lf(A,l,f){const v=f&&f.maxWidth||100,w=A._container.clientHeight/2,I=A._container.clientWidth/2,k=A.unproject([I-v/2,w]),B=A.unproject([I+v/2,w]),W=Math.round(A.project(B).x-A.project(k).x),Z=Math.min(v,W,A._container.clientWidth),J=k.distanceTo(B);if(f&&f.unit==="imperial"){const ue=3.2808*J;ue>5280?Wu(l,Z,ue/5280,A._getUIString("ScaleControl.Miles")):Wu(l,Z,ue,A._getUIString("ScaleControl.Feet"))}else f&&f.unit==="nautical"?Wu(l,Z,J/1852,A._getUIString("ScaleControl.NauticalMiles")):J>=1e3?Wu(l,Z,J/1e3,A._getUIString("ScaleControl.Kilometers")):Wu(l,Z,J,A._getUIString("ScaleControl.Meters"))}function Wu(A,l,f,v){const w=(function(I){const k=Math.pow(10,`${Math.floor(I)}`.length-1);let B=I/k;return B=B>=10?10:B>=5?5:B>=3?3:B>=2?2:B>=1?1:(function(W){const Z=Math.pow(10,Math.ceil(-Math.log(W)/Math.LN10));return Math.round(W*Z)/Z})(B),k*B})(f);A.style.width=l*(w/f)+"px",A.innerHTML=`${w}&nbsp;${v}`}const Z_={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},gm=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function _m(A){if(A){if(typeof A=="number"){const l=Math.round(Math.abs(A)/Math.SQRT2);return{center:new s.P(0,0),top:new s.P(0,A),"top-left":new s.P(l,l),"top-right":new s.P(-l,l),bottom:new s.P(0,-A),"bottom-left":new s.P(l,-l),"bottom-right":new s.P(-l,-l),left:new s.P(A,0),right:new s.P(-A,0)}}if(A instanceof s.P||Array.isArray(A)){const l=s.P.convert(A);return{center:l,top:l,"top-left":l,"top-right":l,bottom:l,"bottom-left":l,"bottom-right":l,left:l,right:l}}return{center:s.P.convert(A.center||[0,0]),top:s.P.convert(A.top||[0,0]),"top-left":s.P.convert(A["top-left"]||[0,0]),"top-right":s.P.convert(A["top-right"]||[0,0]),bottom:s.P.convert(A.bottom||[0,0]),"bottom-left":s.P.convert(A["bottom-left"]||[0,0]),"bottom-right":s.P.convert(A["bottom-right"]||[0,0]),left:s.P.convert(A.left||[0,0]),right:s.P.convert(A.right||[0,0])}}return _m(new s.P(0,0))}const X_=d;c.AJAXError=s.cI,c.Event=s.l,c.Evented=s.E,c.LngLat=s.V,c.MercatorCoordinate=s.a9,c.Point=s.P,c.addProtocol=s.cJ,c.config=s.c,c.removeProtocol=s.cK,c.AttributionControl=j_,c.BoxZoomHandler=Qh,c.CanvasSource=te,c.CooperativeGesturesHandler=Mi,c.DoubleClickZoomHandler=U_,c.DragPanHandler=Z0,c.DragRotateHandler=$a,c.EdgeInsets=Oc,c.FullscreenControl=class extends s.E{constructor(A={}){super(),this._onFullscreenChange=()=>{var l;let f=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((l=f?.shadowRoot)===null||l===void 0)&&l.fullscreenElement;)f=f.shadowRoot.fullscreenElement;f===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,A&&A.container&&(A.container instanceof HTMLElement?this._container=A.container:s.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(A){return this._map=A,this._container||(this._container=this._map.getContainer()),this._controlContainer=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){L.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const A=this._fullscreenButton=L.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);L.create("span","maplibregl-ctrl-icon",A).setAttribute("aria-hidden","true"),A.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const A=this._getTitle();this._fullscreenButton.setAttribute("aria-label",A),this._fullscreenButton.title=A}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new s.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new s.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},c.GeoJSONSource=Xe,c.GeolocateControl=class extends s.E{constructor(A){super(),this._onSuccess=l=>{if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new s.l("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new s.l("geolocate",l)),this._finish()}},this._updateCamera=l=>{const f=new s.V(l.coords.longitude,l.coords.latitude),v=l.coords.accuracy,w=this._map.getBearing(),I=s.e({bearing:w},this.options.fitBoundsOptions),k=Ce.fromLngLat(f,v);this._map.fitBounds(k,I,{geolocateSource:!0})},this._updateMarker=l=>{if(l){const f=new s.V(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(f).addTo(this._map),this._userLocationDotMarker.setLngLat(f).addTo(this._map),this._accuracy=l.coords.accuracy,this._updateCircleRadiusIfNeeded()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onUpdate=()=>{this._updateCircleRadiusIfNeeded()},this._onError=l=>{if(this._map){if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const f=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=f,this._geolocateButton.setAttribute("aria-label",f),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&qu)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new s.l("error",l)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",(l=>l.preventDefault())),this._geolocateButton=L.create("button","maplibregl-ctrl-geolocate",this._container),L.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=l=>{if(this._map){if(l===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const f=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=f,this._geolocateButton.setAttribute("aria-label",f)}else{const f=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=f,this._geolocateButton.setAttribute("aria-label",f)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=L.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Rf({element:this._dotElement}),this._circleElement=L.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Rf({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onUpdate),this._map.on("move",this._onUpdate),this._map.on("rotate",this._onUpdate),this._map.on("pitch",this._onUpdate)),this._geolocateButton.addEventListener("click",(()=>this.trigger())),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(f=>{const v=f?.[0]instanceof ResizeObserverEntry;f.geolocateSource||this._watchState!=="ACTIVE_LOCK"||v||this._map.isZooming()||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new s.l("trackuserlocationend")),this.fire(new s.l("userlocationlostfocus")))}))}},this.options=s.e({},W_,A)}onAdd(A){return this._map=A,this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),(function(){return s._(this,arguments,void 0,(function*(l=!1){if(ac!==void 0&&!l)return ac;if(window.navigator.permissions===void 0)return ac=!!window.navigator.geolocation,ac;try{ac=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{ac=!!window.navigator.geolocation}return ac}))})().then((l=>this._finishSetupUI(l))),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),L.remove(this._container),this._map.off("zoom",this._onUpdate),this._map.off("move",this._onUpdate),this._map.off("rotate",this._onUpdate),this._map.off("pitch",this._onUpdate),this._map=void 0,id=0,qu=!1}_isOutOfMapMaxBounds(A){const l=this._map.getMaxBounds(),f=A.coords;return l&&(f.longitude<l.getWest()||f.longitude>l.getEast()||f.latitude<l.getSouth()||f.latitude>l.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":case"BACKGROUND_ERROR":case"OFF":case void 0:break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadiusIfNeeded(){const A=this._userLocationDotMarker.getLngLat();if(!(this.options.showUserLocation&&this.options.showAccuracyCircle&&this._accuracy&&A))return;const l=this._map.project(A),f=this._map.unproject([l.x+100,l.y]),v=A.distanceTo(f)/100,w=2*this._accuracy/v;this._circleElement.style.width=`${w.toFixed(2)}px`,this._circleElement.style.height=`${w.toFixed(2)}px`}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":id--,qu=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new s.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.l("trackuserlocationstart")),this.fire(new s.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let A;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),id++,id>1?(A={maximumAge:6e5,timeout:0},qu=!0):(A=this.options.positionOptions,qu=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,A)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},c.GlobeControl=class{constructor(){this._toggleProjection=()=>{var A;const l=(A=this._map.getProjection())===null||A===void 0?void 0:A.type;this._map.setProjection(l!=="mercator"&&l?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var A;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((A=this._map.getProjection())===null||A===void 0?void 0:A.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(A){return this._map=A,this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=L.create("button","maplibregl-ctrl-globe",this._container),L.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){L.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},c.Hash=F_,c.ImageSource=bt,c.KeyboardHandler=Wn,c.LngLatBounds=Ce,c.LogoControl=X0,c.Map=class extends co{constructor(A){var l,f;s.cG.mark(s.cH.create);const v=Object.assign(Object.assign(Object.assign({},fm),A),{canvasContextAttributes:Object.assign(Object.assign({},fm.canvasContextAttributes),A.canvasContextAttributes)});if(v.minZoom!=null&&v.maxZoom!=null&&v.minZoom>v.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(v.minPitch!=null&&v.maxPitch!=null&&v.minPitch>v.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(v.minPitch!=null&&v.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(v.maxPitch!=null&&v.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const w=new Yl,I=new vl;if(v.minZoom!==void 0&&w.setMinZoom(v.minZoom),v.maxZoom!==void 0&&w.setMaxZoom(v.maxZoom),v.minPitch!==void 0&&w.setMinPitch(v.minPitch),v.maxPitch!==void 0&&w.setMaxPitch(v.maxPitch),v.renderWorldCopies!==void 0&&w.setRenderWorldCopies(v.renderWorldCopies),v.transformConstrain!==null&&w.setConstrainOverride(v.transformConstrain),super(w,I,{bearingSnap:v.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new B1,this._controls=[],this._mapId=s.af(),this._lostContextStyle={style:null,images:null},this._contextLost=B=>{B.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.painter.destroy();for(const W of Object.values(this.style._layers))if(W.type==="custom"&&console.warn(`Custom layer with id '${W.id}' cannot be restored after WebGL context loss. You will need to re-add it manually after context restoration.`),W._listeners)for(const[Z]of Object.entries(W._listeners))console.warn(`Custom layer with id '${W.id}' had event listeners for event '${Z}' which cannot be restored after WebGL context loss. You will need to re-add them manually after context restoration.`);this._lostContextStyle=this._getStyleAndImages(),this.style.destroy(),this.style=null,this.fire(new s.l("webglcontextlost",{originalEvent:B}))},this._contextRestored=B=>{this._lostContextStyle.style&&this.setStyle(this._lostContextStyle.style,{diff:!1}),this._lostContextStyle.images&&(this.style.imageManager.images=this._lostContextStyle.images),this._setupPainter(),this.resize(),this._update(),this.fire(new s.l("webglcontextrestored",{originalEvent:B}))},this._onMapScroll=B=>{if(B.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=v.interactive,this._maxTileCacheSize=v.maxTileCacheSize,this._maxTileCacheZoomLevels=v.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},v.canvasContextAttributes),this._trackResize=v.trackResize===!0,this._bearingSnap=v.bearingSnap,this._centerClampedToGround=v.centerClampedToGround,this._refreshExpiredTiles=v.refreshExpiredTiles===!0,this._fadeDuration=v.fadeDuration,this._crossSourceCollisions=v.crossSourceCollisions===!0,this._collectResourceTiming=v.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},dm),v.locale),this._clickTolerance=v.clickTolerance,this._overridePixelRatio=v.pixelRatio,this._maxCanvasSize=v.maxCanvasSize,this._zoomLevelsToOverscale=v.experimentalZoomLevelsToOverscale,this.transformCameraUpdate=v.transformCameraUpdate,this.transformConstrain=v.transformConstrain,this.cancelPendingTileRequestsWhileZooming=v.cancelPendingTileRequestsWhileZooming===!0,v.reduceMotion!==void 0&&(b.prefersReducedMotion=v.reduceMotion),this._imageQueueHandle=G.addThrottleControl((()=>this.isMoving())),this._requestManager=new N(v.transformRequest),typeof v.container=="string"){if(this._container=document.getElementById(v.container),!this._container)throw new Error(`Container '${v.container}' not found.`)}else{if(!(v.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=v.container}if(v.maxBounds&&this.setMaxBounds(v.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this.on("terrain",(()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)})),this.once("idle",(()=>{this._idleTriggered=!0})),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let B=!1;const W=D_((Z=>{this._trackResize&&!this._removed&&(this.resize(Z),this.redraw())}),50);this._resizeObserver=new ResizeObserver((Z=>{B?W(Z):B=!0})),this._resizeObserver.observe(this._container)}this.handlers=new hm(this,v),this._hash=v.hash&&new F_(typeof v.hash=="string"&&v.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:v.center,elevation:v.elevation,zoom:v.zoom,bearing:v.bearing,pitch:v.pitch,roll:v.roll}),v.bounds&&(this.resize(),this.fitBounds(v.bounds,s.e({},v.fitBoundsOptions,{duration:0}))));const k=typeof v.style=="string"||((f=(l=v.style)===null||l===void 0?void 0:l.projection)===null||f===void 0?void 0:f.type)!=="globe";this.resize(null,k),this._localIdeographFontFamily=v.localIdeographFontFamily,this._validateStyle=v.validateStyle,v.style&&this.setStyle(v.style,{localIdeographFontFamily:v.localIdeographFontFamily}),v.attributionControl&&this.addControl(new j_(typeof v.attributionControl=="boolean"?void 0:v.attributionControl)),v.maplibreLogo&&this.addControl(new X0,v.logoPosition),this.on("style.load",(()=>{if(k||this._resizeTransform(),this.transform.unmodified){const B=s.U(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(B)}})),this.on("data",(B=>{this._update(B.dataType==="style"),this.fire(new s.l(`${B.dataType}data`,B))})),this.on("dataloading",(B=>{this.fire(new s.l(`${B.dataType}dataloading`,B))})),this.on("dataabort",(B=>{this.fire(new s.l("sourcedataabort",B))}))}_getMapId(){return this._mapId}setGlobalStateProperty(A,l){return this.style.setGlobalStateProperty(A,l),this._update(!0)}getGlobalState(){return this.style.getGlobalState()}addControl(A,l){if(l===void 0&&(l=A.getDefaultPosition?A.getDefaultPosition():"top-right"),!A||!A.onAdd)return this.fire(new s.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const f=A.onAdd(this);this._controls.push(A);const v=this._controlPositions[l];return l.indexOf("bottom")!==-1?v.insertBefore(f,v.firstChild):v.appendChild(f),this}removeControl(A){if(!A||!A.onRemove)return this.fire(new s.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const l=this._controls.indexOf(A);return l>-1&&this._controls.splice(l,1),A.onRemove(this),this}hasControl(A){return this._controls.indexOf(A)>-1}coveringTiles(A){return kn(this.transform,A)}calculateCameraOptionsFromTo(A,l,f,v){return v==null&&this.terrain&&(v=this.terrain.getElevationForLngLat(f,this.transform)),super.calculateCameraOptionsFromTo(A,l,f,v)}resize(A,l=!0){const[f,v]=this._containerDimensions(),w=this._getClampedPixelRatio(f,v);if(this._resizeCanvas(f,v,w),this.painter.resize(f,v,w),this.painter.overLimit()){const k=this.painter.context.gl;this._maxCanvasSize=[k.drawingBufferWidth,k.drawingBufferHeight];const B=this._getClampedPixelRatio(f,v);this._resizeCanvas(f,v,B),this.painter.resize(f,v,B)}this._resizeTransform(l);const I=!this._moving;return I&&(this.stop(),this.fire(new s.l("movestart",A)).fire(new s.l("move",A))),this.fire(new s.l("resize",A)),I&&this.fire(new s.l("moveend",A)),this}_resizeTransform(A=!0){var l;const[f,v]=this._containerDimensions();this.transform.resize(f,v,A),(l=this._requestedCameraState)===null||l===void 0||l.resize(f,v,A)}_getClampedPixelRatio(A,l){const{0:f,1:v}=this._maxCanvasSize,w=this.getPixelRatio(),I=A*w,k=l*w;return Math.min(I>f?f/I:1,k>v?v/k:1)*w}getPixelRatio(){var A;return(A=this._overridePixelRatio)!==null&&A!==void 0?A:devicePixelRatio}setPixelRatio(A){this._overridePixelRatio=A,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(A){return this.transform.setMaxBounds(Ce.convert(A)),this._update()}setMinZoom(A){if((A=A??-2)>=-2&&A<=this.transform.maxZoom){const l=this._getTransformForUpdate();return l.setMinZoom(A),this._applyUpdatedTransform(l),this._update(),this}throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(A){if((A=A??22)>=this.transform.minZoom){const l=this._getTransformForUpdate();return l.setMaxZoom(A),this._applyUpdatedTransform(l),this._update(),this}throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(A){if((A=A??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(A>=0&&A<=this.transform.maxPitch)return this.transform.setMinPitch(A),this._update(),this.getPitch()<A&&this.setPitch(A),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(A){if((A=A??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(A>=this.transform.minPitch)return this.transform.setMaxPitch(A),this._update(),this.getPitch()>A&&this.setPitch(A),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(A){return this.transform.setRenderWorldCopies(A),this._update()}setTransformConstrain(A){return this.transform.setConstrainOverride(A),this._update()}project(A){return this.transform.locationToScreenPoint(s.V.convert(A),this.style&&this.terrain)}unproject(A){return this.transform.screenPointToLocation(s.P.convert(A),this.terrain)}isMoving(){var A;return this._moving||((A=this.handlers)===null||A===void 0?void 0:A.isMoving())}isZooming(){var A;return this._zooming||((A=this.handlers)===null||A===void 0?void 0:A.isZooming())}isRotating(){var A;return this._rotating||((A=this.handlers)===null||A===void 0?void 0:A.isRotating())}_createDelegatedListener(A,l,f){if(A==="mouseenter"||A==="mouseover"){let v=!1;return{layers:l,listener:f,delegates:{mousemove:I=>{const k=l.filter((W=>this.getLayer(W))),B=k.length!==0?this.queryRenderedFeatures(I.point,{layers:k}):[];B.length?v||(v=!0,f.call(this,new Cs(A,this,I.originalEvent,{features:B}))):v=!1},mouseout:()=>{v=!1}}}}if(A==="mouseleave"||A==="mouseout"){let v=!1;return{layers:l,listener:f,delegates:{mousemove:k=>{const B=l.filter((W=>this.getLayer(W)));(B.length!==0?this.queryRenderedFeatures(k.point,{layers:B}):[]).length?v=!0:v&&(v=!1,f.call(this,new Cs(A,this,k.originalEvent)))},mouseout:k=>{v&&(v=!1,f.call(this,new Cs(A,this,k.originalEvent)))}}}}{const v=w=>{const I=l.filter((B=>this.getLayer(B))),k=I.length!==0?this.queryRenderedFeatures(w.point,{layers:I}):[];k.length&&(w.features=k,f.call(this,w),delete w.features)};return{layers:l,listener:f,delegates:{[A]:v}}}}_saveDelegatedListener(A,l){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[A]=this._delegatedListeners[A]||[],this._delegatedListeners[A].push(l)}_removeDelegatedListener(A,l,f){if(!this._delegatedListeners||!this._delegatedListeners[A])return;const v=this._delegatedListeners[A];for(let w=0;w<v.length;w++){const I=v[w];if(I.listener===f&&I.layers.length===l.length&&I.layers.every((k=>l.includes(k)))){for(const k in I.delegates)this.off(k,I.delegates[k]);return void v.splice(w,1)}}}on(A,l,f){if(f===void 0)return super.on(A,l);const v=typeof l=="string"?[l]:l,w=this._createDelegatedListener(A,v,f);this._saveDelegatedListener(A,w);for(const I in w.delegates)this.on(I,w.delegates[I]);return{unsubscribe:()=>{this._removeDelegatedListener(A,v,f)}}}once(A,l,f){if(f===void 0)return super.once(A,l);const v=typeof l=="string"?[l]:l,w=this._createDelegatedListener(A,v,f);for(const I in w.delegates){const k=w.delegates[I];w.delegates[I]=(...B)=>{this._removeDelegatedListener(A,v,f),k(...B)}}this._saveDelegatedListener(A,w);for(const I in w.delegates)this.once(I,w.delegates[I]);return this}off(A,l,f){return f===void 0?super.off(A,l):(this._removeDelegatedListener(A,typeof l=="string"?[l]:l,f),this)}queryRenderedFeatures(A,l){if(!this.style)return[];let f;const v=A instanceof s.P||Array.isArray(A),w=v?A:[[0,0],[this.transform.width,this.transform.height]];if(l=l||(v?{}:A)||{},w instanceof s.P||typeof w[0]=="number")f=[s.P.convert(w)];else{const I=s.P.convert(w[0]),k=s.P.convert(w[1]);f=[I,new s.P(k.x,I.y),k,new s.P(I.x,k.y),I]}return this.style.queryRenderedFeatures(f,l,this.transform)}querySourceFeatures(A,l){return this.style.querySourceFeatures(A,l)}setStyle(A,l){return(l=s.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},l)).diff!==!1&&l.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&A?(this._diffStyle(A,l),this):(this._localIdeographFontFamily=l.localIdeographFontFamily,this._updateStyle(A,l))}setTransformRequest(A){return this._requestManager.setTransformRequest(A),this}_getUIString(A){const l=this._locale[A];if(l==null)throw new Error(`Missing UI string '${A}'`);return l}_updateStyle(A,l){var f,v;if(l.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",(()=>this._updateStyle(A,l)));const w=this.style&&l.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!A)),A?(this.style=new ic(this,l||{}),this.style.setEventedParent(this,{style:this.style}),typeof A=="string"?this.style.loadURL(A,l,w):this.style.loadJSON(A,l,w),this):((v=(f=this.style)===null||f===void 0?void 0:f.projection)===null||v===void 0||v.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new ic(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(A,l){if(typeof A=="string"){const f=this._requestManager.transformRequest(A,"Style");s.j(f,new AbortController).then((v=>{this._updateDiff(v.data,l)})).catch((v=>{v&&this.fire(new s.k(v))}))}else typeof A=="object"&&this._updateDiff(A,l)}_updateDiff(A,l){try{this.style.setState(A,l)&&this._update(!0)}catch(f){s.w(`Unable to perform style diff: ${f.message||f.error||f}.  Rebuilding the style from scratch.`),this._updateStyle(A,l)}}getStyle(){if(this.style)return this.style.serialize()}_getStyleAndImages(){return this.style?{style:this.style.serialize(),images:this.style.imageManager.cloneImages()}:{style:null,images:{}}}isStyleLoaded(){return this.style?this.style.loaded():s.w("There is no style added to the map.")}addSource(A,l){return this._lazyInitEmptyStyle(),this.style.addSource(A,l),this._update(!0)}isSourceLoaded(A){const l=this.style&&this.style.tileManagers[A];if(l!==void 0)return l.loaded();this.fire(new s.k(new Error(`There is no tile manager with ID '${A}'`)))}setTerrain(A){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),A){const l=this.style.tileManagers[A.source];if(!l)throw new Error(`cannot load terrain, because there exists no source with ID: ${A.source}`);this.terrain===null&&l.reload();for(const f in this.style._layers){const v=this.style._layers[f];v.type==="hillshade"&&v.source===A.source&&s.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality."),v.type==="color-relief"&&v.source===A.source&&s.w("You are using the same source for a color-relief layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new Ir(this.painter,l,A),this.painter.renderToTexture=new Af(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=f=>{var v;f.dataType==="style"?this.terrain.tileManager.freeRtt():f.dataType==="source"&&f.tile&&(f.sourceId!==A.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),((v=f.source)===null||v===void 0?void 0:v.type)==="image"?this.terrain.tileManager.freeRtt():this.terrain.tileManager.freeRtt(f.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.tileManager.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new s.l("terrain",{terrain:A})),this}getTerrain(){var A,l;return(l=(A=this.terrain)===null||A===void 0?void 0:A.options)!==null&&l!==void 0?l:null}areTilesLoaded(){const A=this.style&&this.style.tileManagers;for(const l of Object.values(A))if(!l.areTilesLoaded())return!1;return!0}removeSource(A){return this.style.removeSource(A),this._update(!0)}getSource(A){return this.style.getSource(A)}setSourceTileLodParams(A,l,f){if(f){const v=this.getSource(f);if(!v)throw new Error(`There is no source with ID "${f}", cannot set LOD parameters`);v.calculateTileZoom=gn(Math.max(1,A),Math.max(1,l))}else for(const v in this.style.tileManagers)this.style.tileManagers[v].getSource().calculateTileZoom=gn(Math.max(1,A),Math.max(1,l));return this._update(!0),this}refreshTiles(A,l){const f=this.style.tileManagers[A];if(!f)throw new Error(`There is no tile manager with ID "${A}", cannot refresh tile`);l===void 0?f.reload(!0):f.refreshTiles(l.map((v=>new s.ac(v.z,v.x,v.y))))}addImage(A,l,f={}){const{pixelRatio:v=1,sdf:w=!1,stretchX:I,stretchY:k,content:B,textFitWidth:W,textFitHeight:Z}=f;if(this._lazyInitEmptyStyle(),!(l instanceof HTMLImageElement||s.b(l))){if(l.width===void 0||l.height===void 0)return this.fire(new s.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:J,height:ue,data:le}=l,_e=l;return this.style.addImage(A,{data:new s.R({width:J,height:ue},new Uint8Array(le)),pixelRatio:v,stretchX:I,stretchY:k,content:B,textFitWidth:W,textFitHeight:Z,sdf:w,version:0,userImage:_e}),_e.onAdd&&_e.onAdd(this,A),this}}{const{width:J,height:ue,data:le}=b.getImageData(l);this.style.addImage(A,{data:new s.R({width:J,height:ue},le),pixelRatio:v,stretchX:I,stretchY:k,content:B,textFitWidth:W,textFitHeight:Z,sdf:w,version:0})}}updateImage(A,l){const f=this.style.getImage(A);if(!f)return this.fire(new s.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const v=l instanceof HTMLImageElement||s.b(l)?b.getImageData(l):l,{width:w,height:I,data:k}=v;if(w===void 0||I===void 0)return this.fire(new s.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(w!==f.data.width||I!==f.data.height)return this.fire(new s.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const B=!(l instanceof HTMLImageElement||s.b(l));return f.data.replace(k,B),this.style.updateImage(A,f),this}getImage(A){return this.style.getImage(A)}hasImage(A){return A?!!this.style.getImage(A):(this.fire(new s.k(new Error("Missing required image id"))),!1)}removeImage(A){this.style.removeImage(A)}loadImage(A){return G.getImage(this._requestManager.transformRequest(A,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(A,l){return this._lazyInitEmptyStyle(),this.style.addLayer(A,l),this._update(!0)}moveLayer(A,l){return this.style.moveLayer(A,l),this._update(!0)}removeLayer(A){return this.style.removeLayer(A),this._update(!0)}getLayer(A){return this.style.getLayer(A)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(A,l,f){return this.style.setLayerZoomRange(A,l,f),this._update(!0)}setFilter(A,l,f={}){return this.style.setFilter(A,l,f),this._update(!0)}getFilter(A){return this.style.getFilter(A)}setPaintProperty(A,l,f,v={}){return this.style.setPaintProperty(A,l,f,v),this._update(!0)}getPaintProperty(A,l){return this.style.getPaintProperty(A,l)}setLayoutProperty(A,l,f,v={}){return this.style.setLayoutProperty(A,l,f,v),this._update(!0)}getLayoutProperty(A,l){return this.style.getLayoutProperty(A,l)}setGlyphs(A,l={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(A,l),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(A,l,f={}){return this._lazyInitEmptyStyle(),this.style.addSprite(A,l,f,(v=>{v||this._update(!0)})),this}removeSprite(A){return this._lazyInitEmptyStyle(),this.style.removeSprite(A),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(A,l={}){return this._lazyInitEmptyStyle(),this.style.setSprite(A,l,(f=>{f||this._update(!0)})),this}setLight(A,l={}){return this._lazyInitEmptyStyle(),this.style.setLight(A,l),this._update(!0)}getLight(){return this.style.getLight()}setSky(A,l={}){return this._lazyInitEmptyStyle(),this.style.setSky(A,l),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(A,l){return this.style.setFeatureState(A,l),this._update()}removeFeatureState(A,l){return this.style.removeFeatureState(A,l),this._update()}getFeatureState(A){return this.style.getFeatureState(A)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let A=0,l=0;return this._container&&(A=this._container.clientWidth||400,l=this._container.clientHeight||300),[A,l]}_setupContainer(){const A=this._container;A.classList.add("maplibregl-map");const l=this._canvasContainer=L.create("div","maplibregl-canvas-container",A);this._interactive&&l.classList.add("maplibregl-interactive"),this._canvas=L.create("canvas","maplibregl-canvas",l),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const f=this._containerDimensions(),v=this._getClampedPixelRatio(f[0],f[1]);this._resizeCanvas(f[0],f[1],v);const w=this._controlContainer=L.create("div","maplibregl-control-container",A),I=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((k=>{I[k]=L.create("div",`maplibregl-ctrl-${k} `,w)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(A,l,f){this._canvas.width=Math.floor(f*A),this._canvas.height=Math.floor(f*l),this._canvas.style.width=`${A}px`,this._canvas.style.height=`${l}px`}_setupPainter(){const A=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let l=null;this._canvas.addEventListener("webglcontextcreationerror",(v=>{l={requestedAttributes:A},v&&(l.statusMessage=v.statusMessage,l.type=v.type)}),{once:!0});let f=null;if(f=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,A):this._canvas.getContext("webgl2",A)||this._canvas.getContext("webgl",A),!f){const v="Failed to initialize WebGL";throw l?(l.message=v,new Error(JSON.stringify(l))):new Error(v)}this.painter=new B0(f,this.transform),E.testSupport(f)}migrateProjection(A,l){super.migrateProjection(A,l),this.painter.transform=A,this.fire(new s.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(A){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||A,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(A){return this._update(),this._renderTaskQueue.add(A)}_cancelRenderFrame(A){this._renderTaskQueue.remove(A)}_render(A){var l,f,v,w,I;const k=this._idleTriggered?this._fadeDuration:0,B=((l=this.style.projection)===null||l===void 0?void 0:l.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(A),this._removed)return;let W=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const ue=this.transform.zoom,le=P();this.style.zoomHistory.update(ue,le);const _e=new s.H(ue,{now:le,fadeDuration:k,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),Ee=_e.crossFadingFactor();Ee===1&&Ee===this._crossFadingFactor||(W=!0,this._crossFadingFactor=Ee),this.style.update(_e)}const Z=((f=this.style.projection)===null||f===void 0?void 0:f.transitionState)>0!==B;(v=this.style.projection)===null||v===void 0||v.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((w=this.style.projection)===null||w===void 0?void 0:w.transitionState,(I=this.style.projection)===null||I===void 0?void 0:I.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||Z)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.tileManager.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,k,this._crossSourceCollisions,Z),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:k,showPadding:this.showPadding}),this.fire(new s.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,s.cG.mark(s.cH.load),this.fire(new s.l("load"))),this.style&&(this.style.hasTransitions()||W)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const J=this._sourcesDirty||this._styleDirty||this._placementDirty;return J||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new s.l("idle")),!this._loaded||this._fullyLoaded||J||(this._fullyLoaded=!0,s.cG.mark(s.cH.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var A;this._hash&&this._hash.remove();for(const f of this._controls)f.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),G.removeThrottleControl(this._imageQueueHandle),(A=this._resizeObserver)===null||A===void 0||A.disconnect();const l=this.painter.context.gl.getExtension("WEBGL_lose_context");l?.loseContext&&l.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),L.remove(this._canvasContainer),L.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),s.cG.clearMetrics(),this._removed=!0,this.fire(new s.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,b.frame(this._frameRequest,(A=>{s.cG.frame(A),this._frameRequest=null;try{this._render(A)}catch(l){if(!s.Z(l)&&!(function(f){return f.message===A_})(l))throw l}}),(()=>{})))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(A){this._showTileBoundaries!==A&&(this._showTileBoundaries=A,this._update())}get showPadding(){return!!this._showPadding}set showPadding(A){this._showPadding!==A&&(this._showPadding=A,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(A){this._showCollisionBoxes!==A&&(this._showCollisionBoxes=A,A?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(A){this._showOverdrawInspector!==A&&(this._showOverdrawInspector=A,this._update())}get repaint(){return!!this._repaint}set repaint(A){this._repaint!==A&&(this._repaint=A,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(A){this._vertices=A,this._update()}get version(){return G_}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(A){return this._lazyInitEmptyStyle(),this.style.setProjection(A),this._update(!0)}},c.MapMouseEvent=Cs,c.MapTouchEvent=bf,c.MapWheelEvent=V0,c.Marker=Rf,c.NavigationControl=class{constructor(A){this._updateZoomButtons=()=>{const l=this._map.getZoom(),f=l===this._map.getMaxZoom(),v=l===this._map.getMinZoom();this._zoomInButton.disabled=f,this._zoomOutButton.disabled=v,this._zoomInButton.setAttribute("aria-disabled",f.toString()),this._zoomOutButton.setAttribute("aria-disabled",v.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(l,f)=>{const v=this._map._getUIString(`NavigationControl.${f}`);l.title=v,l.setAttribute("aria-label",v)},this.options=s.e({},q_,A),this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",(l=>l.preventDefault())),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",(l=>this._map.zoomIn({},{originalEvent:l}))),L.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",(l=>this._map.zoomOut({},{originalEvent:l}))),L.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",(l=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:l}):this._map.resetNorth({},{originalEvent:l})})),this._compassIcon=L.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(A){return this._map=A,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Pf(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){L.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(A,l){const f=L.create("button",A,this._container);return f.type="button",f.addEventListener("click",l),f}},c.Popup=class extends s.E{constructor(A){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:"")},this.remove=()=>(this._content&&L.remove(this._content),this._container&&(L.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new s.l("close"))),this),this._onMouseUp=l=>{this._update(l.point)},this._onMouseMove=l=>{this._update(l.point)},this._onDrag=l=>{this._update(l.point)},this._update=l=>{if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=L.create("div","maplibregl-popup",this._map.getContainer()),this._tip=L.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const k of this.options.className.split(" "))this._container.classList.add(k);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=pm(this._lngLat,this._flatPos,this._map.transform,this._trackPointer),this._trackPointer&&!l)return;const f=this._flatPos=this._pos=this._trackPointer&&l?l:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&l?l:this._map.transform.locationToScreenPoint(this._lngLat));let v=this.options.anchor;const w=_m(this.options.offset);if(!v){const k=this._container.offsetWidth,B=this._container.offsetHeight;let W;W=f.y+w.bottom.y<B?["top"]:f.y>this._map.transform.height-B?["bottom"]:[],f.x<k/2?W.push("left"):f.x>this._map.transform.width-k/2&&W.push("right"),v=W.length===0?"bottom":W.join("-")}let I=f.add(w[v]);this.options.subpixelPositioning||(I=I.round()),L.setTransform(this._container,`${If[v]} translate(${I.x}px,${I.y}px)`),mm(this._container,v,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=s.e(Object.create(Z_),A)}addTo(A){return this._map&&this.remove(),this._map=A,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new s.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(A){return this._lngLat=s.V.convert(A),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(A){return this.setDOMContent(document.createTextNode(A))}setHTML(A){const l=document.createDocumentFragment(),f=document.createElement("body");let v;for(f.innerHTML=A;v=f.firstChild,v;)l.appendChild(v);return this.setDOMContent(l)}getMaxWidth(){var A;return(A=this._container)===null||A===void 0?void 0:A.style.maxWidth}setMaxWidth(A){return this.options.maxWidth=A,this._update(),this}setDOMContent(A){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=L.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(A),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(A){return this._container&&this._container.classList.add(A),this}removeClassName(A){return this._container&&this._container.classList.remove(A),this}setOffset(A){return this.options.offset=A,this._update(),this}toggleClassName(A){if(this._container)return this._container.classList.toggle(A)}setSubpixelPositioning(A){this.options.subpixelPositioning=A}_createCloseButton(){this.options.closeButton&&(this._closeButton=L.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const A=this._container.querySelector(gm);A&&A.focus()}},c.RasterDEMTileSource=ie,c.RasterTileSource=be,c.ScaleControl=class{constructor(A){this._onMove=()=>{Lf(this._map,this._container,this.options)},this.setUnit=l=>{this.options.unit=l,Lf(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},H_),A)}getDefaultPosition(){return"bottom-left"}onAdd(A){return this._map=A,this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-scale",A.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){L.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},c.ScrollZoomHandler=cm,c.Style=ic,c.TerrainControl=class{constructor(A){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=A}onAdd(A){return this._map=A,this._container=L.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=L.create("button","maplibregl-ctrl-terrain",this._container),L.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){L.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},c.TwoFingersTouchPitchHandler=q0,c.TwoFingersTouchRotateHandler=$_,c.TwoFingersTouchZoomHandler=N_,c.TwoFingersTouchZoomRotateHandler=Mf,c.VectorTileSource=vt,c.VideoSource=Te,c.addSourceType=(A,l)=>s._(void 0,void 0,void 0,(function*(){if(pe(A))throw new Error(`A source type called "${A}" already exists.`);((f,v)=>{he[f]=v})(A,l)})),c.clearPrewarmedResources=function(){const A=Be;A&&(A.isPreloaded()&&A.numActive()===1?(A.release(ke),Be=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},c.createTileMesh=Op,c.getMaxParallelImageRequests=function(){return s.c.MAX_PARALLEL_IMAGE_REQUESTS},c.getRTLTextPluginStatus=function(){return pt().getRTLTextPluginStatus()},c.getVersion=function(){return X_},c.getWorkerCount=function(){return et.workerCount},c.getWorkerUrl=function(){return s.c.WORKER_URL},c.importScriptInWorkers=function(A){return we().broadcast("IS",A)},c.isTimeFrozen=function(){return S.isFrozen()},c.now=P,c.prewarm=function(){ct().acquire(ke)},c.restoreNow=function(){S.restoreNow()},c.setMaxParallelImageRequests=function(A){s.c.MAX_PARALLEL_IMAGE_REQUESTS=A},c.setNow=function(A){S.setNow(A)},c.setRTLTextPlugin=function(A,l){return pt().setRTLTextPlugin(A,l)},c.setWorkerCount=function(A){et.workerCount=A},c.setWorkerUrl=function(A){s.c.WORKER_URL=A}}));var o=t;return o}))})(Vx)),Vx.exports}var uC=T8();const Lo=CD(uC),M8=u5({__proto__:null,default:Lo},[uC]);function Ey(n){return Object.fromEntries(Object.entries(n).filter(([e,t])=>t!=null))}function dI(n){let e;return t=>{if(t)for(let i in t){let r=e?.[i],o=t[i];r!==o&&n(i,o,r)}else if(e)for(let i in e)n(i,void 0,e[i]);e=t}}function C8(n,...e){let t=[n];for(let i of e)if(i)Array.isArray(i)&&i[0]===n?t.push(...i.slice(1)):t.push(i);else continue;if(t.length!==1)return t.length===2?t[1]:t}function E8(n){return n===!0?["has","point_count"]:n===!1?["!",["has","point_count"]]:void 0}function Gg(n,e){return["case",["boolean",["feature-state","hover"],!1],e,n]}function i1(n,e){en(e,!0);let t=ft(e,"id",19,()=>Sp("layer")),i=ft(e,"source",3,void 0),r=ft(e,"sourceLayer",3,void 0),o=ft(e,"beforeId",3,void 0),c=ft(e,"beforeLayerType",3,void 0),s=ft(e,"paint",3,void 0),d=ft(e,"layout",3,void 0),p=ft(e,"filter",3,void 0),g=ft(e,"applyToClusters",3,void 0),_=ft(e,"requireSource",3,!0),x=ft(e,"minzoom",3,void 0),b=ft(e,"maxzoom",3,void 0),S=ft(e,"manageHoverState",3,!1),P=ft(e,"hovered",15),L=ft(e,"interactive",3,!0),E=ft(e,"hoverCursor",3,void 0),C=ft(e,"eventsIfTopMost",3,!1),D=ft(e,"children",3,void 0),O=ft(e,"onclick",3,void 0),U=ft(e,"ondblclick",3,void 0),j=ft(e,"oncontextmenu",3,void 0),G=ft(e,"onmouseenter",3,void 0),N=ft(e,"onmousemove",3,void 0),V=ft(e,"onmouseleave",3,void 0);const q=h8(),z=Kt(Ac),Q=Kt(()=>ee(z).loaded),{layer:X}=b8(),re=Kt(Ac),oe=Kt(()=>ee(re).map),de=Kt(()=>ee(re).eventTopMost),ce=Kt(()=>ee(re).layerInfo),Se=Kt(()=>ee(re).minzoom),Pe=Kt(()=>ee(re).maxzoom);Ta(()=>{X.value&&ee(oe)&&(ee(ce).delete(X.value),ee(oe).removeLayer(X.value))});let je;function Fe(Ce){if(!L()||!X.value||!ee(oe)||C()&&ee(de)(Ce)!==X.value)return;let xe=Ce.features??[],vt=xe[0]?.properties?.cluster_id,be={event:Ce,map:ee(oe),clusterId:vt,layer:X.value,source:ee(we),features:xe};switch(Ce.type){case"click":O()?.(be);break;case"dblclick":U()?.(be);break;case"contextmenu":j()?.(be);break}}function qe(Ce){if(!L()||!X.value||!ee(oe)||C()&&ee(de)(Ce)!==X.value)return;E()&&(ee(oe).getCanvas().style.cursor=E());let xe=Ce.features??[];P(xe[0]??void 0);let vt=xe[0]?.properties?.cluster_id,be={event:Ce,map:ee(oe),clusterId:vt,layer:X.value,source:ee(we),features:xe};G()?.(be)}function Ue(Ce){if(!L()||!ee(oe))return;if(C()&&ee(de)(Ce)!==X.value){P(void 0),S()&&je!==void 0&&(ee(oe).setFeatureState({source:ee(we),sourceLayer:r(),id:je},{hover:!1}),je=void 0);return}E()&&(ee(oe).getCanvas().style.cursor=E());let xe=Ce.features??[],vt=xe[0]?.properties?.cluster_id,be=xe[0]?.id;be!==je&&(S()&&(je!==void 0&&ee(oe).setFeatureState({source:ee(we),id:je,sourceLayer:r()},{hover:!1}),ee(oe).setFeatureState({source:ee(we),id:be,sourceLayer:r()},{hover:!0})),je=be,P(xe[0]??void 0)),N()?.({event:Ce,map:ee(oe),clusterId:vt,layer:X.value,source:ee(we),features:xe})}function ke(Ce){if(!(!L()||!X.value||!ee(oe))){if(E()&&(ee(oe).getCanvas().style.cursor=""),P(void 0),S()&&je!==void 0){const xe={source:ee(we),id:je,sourceLayer:r()};ee(oe).setFeatureState(xe,{hover:!1}),je=void 0}V()?.({map:ee(oe),layer:X.value,source:ee(we)})}}let et=ii(!0);function ye(Ce){ee(oe)&&(ee(oe).off("click",Ce,Fe),ee(oe).off("dblclick",Ce,Fe),ee(oe).off("contextmenu",Ce,Fe),ee(oe).off("mouseenter",Ce,qe),ee(oe).off("mousemove",Ce,Ue),ee(oe).off("mouseleave",Ce,ke))}Ta(()=>{X.value&&ye(X.value)});let Be=Kt(()=>E8(g())),Je=Kt(()=>C8("all",ee(Be),p())),ct=Kt(()=>x()??ee(Se)),yt=Kt(()=>b()??ee(Pe)),we=Kt(()=>i()||q?.value);cn(()=>{if(ee(oe)&&X.value!==t()&&ee(Q)&&(ee(we)||!_())){X.value&&(ye(X.value),ee(ce).delete(X.value));let Ce=o();if(!o()&&c()){let xe=ee(oe).getStyle().layers,vt=typeof c()=="function"?c():ie=>ie.type===c(),be=xe?.find(vt);be&&(Ce=be.id)}X.value=t(),ee(oe).addLayer(Ey({id:X.value,type:e.type,source:ee(we),"source-layer":r(),filter:ee(Je),paint:s(),layout:d(),minzoom:ee(ct),maxzoom:ee(yt)}),Ce),Et(et,!0),ee(oe).on("click",X.value,Fe),ee(oe).on("dblclick",X.value,Fe),ee(oe).on("contextmenu",X.value,Fe),ee(oe).on("mouseenter",X.value,qe),ee(oe).on("mousemove",X.value,Ue),ee(oe).on("mouseleave",X.value,ke)}}),cn(()=>{X.value&&ee(ce).set(X.value,{interactive:L()})});let fe=Kt(()=>X.value?dI((Ce,xe)=>{ee(oe)&&(ee(oe).style._loaded?ee(oe).setPaintProperty(X.value,Ce,xe):ee(oe).once("styledata",()=>ee(oe).setPaintProperty(X.value,Ce,xe)))}):void 0),Ve=Kt(()=>X.value?dI((Ce,xe)=>{ee(oe)&&(ee(oe).style._loaded?ee(oe).setLayoutProperty(X.value,Ce,xe):ee(oe).once("styledata",()=>ee(oe).setLayoutProperty(X.value,Ce,xe)))}):void 0);cn(()=>{ee(fe)?.(s())}),cn(()=>{ee(Ve)?.(d())}),cn(()=>{X.value&&ee(oe)&&ee(oe).setLayerZoomRange(X.value,ee(ct),ee(yt))}),cn(()=>{X.value&&ee(oe)&&(ee(et)?Et(et,!1):ee(oe).setFilter(X.value,ee(Je)))});var tt=ir(),Mt=ci(tt);{var mt=Ce=>{var xe=ir(),vt=ci(xe);a0(vt,()=>X.value,be=>{var ie=ir(),ae=ci(ie);hs(ae,()=>D()??is),xt(be,ie)}),xt(Ce,xe)};Ki(Mt,Ce=>{X.value&&Ce(mt)})}xt(n,tt),tn()}function cu(n,e){en(e,!0);let t=ft(e,"id",19,()=>Sp("circle")),i=ft(e,"source",3,void 0),r=ft(e,"sourceLayer",3,void 0),o=ft(e,"beforeId",3,void 0),c=ft(e,"beforeLayerType",3,void 0),s=ft(e,"layout",3,void 0),d=ft(e,"filter",3,void 0),p=ft(e,"applyToClusters",3,void 0),g=ft(e,"minzoom",3,void 0),_=ft(e,"maxzoom",3,void 0),x=ft(e,"hoverCursor",3,void 0),b=ft(e,"manageHoverState",3,!1),S=ft(e,"hovered",15),P=ft(e,"eventsIfTopMost",3,!1),L=ft(e,"interactive",3,!0),E=ft(e,"children",3,void 0),C=ft(e,"onclick",3,void 0),D=ft(e,"ondblclick",3,void 0),O=ft(e,"oncontextmenu",3,void 0),U=ft(e,"onmouseenter",3,void 0),j=ft(e,"onmousemove",3,void 0),G=ft(e,"onmouseleave",3,void 0);i1(n,{get id(){return t()},type:"circle",get source(){return i()},get sourceLayer(){return r()},get beforeId(){return o()},get beforeLayerType(){return c()},get paint(){return e.paint},get layout(){return s()},get filter(){return d()},get applyToClusters(){return p()},get minzoom(){return g()},get maxzoom(){return _()},get hoverCursor(){return x()},get manageHoverState(){return b()},get eventsIfTopMost(){return P()},get interactive(){return L()},get onclick(){return C()},get ondblclick(){return D()},get oncontextmenu(){return O()},get onmouseenter(){return U()},get onmousemove(){return j()},get onmouseleave(){return G()},get hovered(){return S()},set hovered(N){S(N)},children:(N,V)=>{var q=ir(),z=ci(q);hs(z,()=>E()??is),xt(N,q)},$$slots:{default:!0}}),tn()}var A8=Wt("<div><!></div>");function hF(n,e){en(e,!0);let t=ft(e,"defaultStyling",3,!0),i=ft(e,"position",3,"top-right"),r=ft(e,"class",3,void 0);const o=Kt(Ac),c=Kt(()=>ee(o).map);let s=ii(void 0),d={onAdd(){return ee(s)},onRemove(){ee(s)?.parentNode?.removeChild(ee(s))}};cn(()=>{ee(c)?.addControl(d,i())}),Ta(()=>{ee(c)?.removeControl(d)});var p=A8();let g;var _=Ft(p);hs(_,()=>e.children??is),Sc(p,x=>Et(s,x),()=>ee(s)),Zi(()=>g=Ds(p,1,wD(r()),null,g,{"maplibregl-ctrl":t()})),xt(n,p),tn()}ds(["click"]);function hC(n,e){en(e,!0);let t=ft(e,"id",19,()=>Sp("fill")),i=ft(e,"source",3,void 0),r=ft(e,"sourceLayer",3,void 0),o=ft(e,"beforeId",3,void 0),c=ft(e,"beforeLayerType",3,void 0),s=ft(e,"layout",3,void 0),d=ft(e,"filter",3,void 0),p=ft(e,"minzoom",3,void 0),g=ft(e,"maxzoom",3,void 0),_=ft(e,"hoverCursor",3,void 0),x=ft(e,"manageHoverState",3,!1),b=ft(e,"hovered",15),S=ft(e,"eventsIfTopMost",3,!1),P=ft(e,"interactive",3,!0),L=ft(e,"onclick",3,void 0),E=ft(e,"ondblclick",3,void 0),C=ft(e,"oncontextmenu",3,void 0),D=ft(e,"onmouseenter",3,void 0),O=ft(e,"onmousemove",3,void 0),U=ft(e,"onmouseleave",3,void 0);i1(n,{get id(){return t()},type:"fill",get source(){return i()},get sourceLayer(){return r()},get beforeId(){return o()},get beforeLayerType(){return c()},get paint(){return e.paint},get layout(){return s()},get filter(){return d()},get minzoom(){return p()},get maxzoom(){return g()},get hoverCursor(){return _()},get manageHoverState(){return x()},get eventsIfTopMost(){return S()},get interactive(){return P()},get onclick(){return L()},get ondblclick(){return E()},get oncontextmenu(){return C()},get onmouseenter(){return D()},get onmousemove(){return O()},get onmouseleave(){return U()},get hovered(){return b()},set hovered(j){b(j)},children:(j,G)=>{var N=ir(),V=ci(N);hs(V,()=>e.children??is),xt(j,N)},$$slots:{default:!0}}),tn()}function P8(n,e){en(e,!0);const t=Kt(Ac),i=Kt(()=>ee(t).map),r=Kt(()=>ee(t).loaded);let o=ft(e,"position",3,"top-left"),c=ft(e,"container",3,void 0),s=ii(void 0),d=Kt(()=>typeof c()=="string"?document.querySelector(c())??void 0:c());cn(()=>{ee(i)&&!ee(s)&&(ee(d)?Et(s,new Lo.FullscreenControl({container:ee(d)}),!0):Et(s,new Lo.FullscreenControl,!0),ee(i).addControl(ee(s),o()))}),Ta(()=>{ee(r)&&ee(s)&&ee(i)?.removeControl(ee(s))}),tn()}function dF(n,e,t,i,r){let o=!1;n.getSource(e)&&(o=!0,n.removeSource(e));const c=()=>{i(e)&&(n.addSource(e,t),r())};if(o){const s=()=>{e&&(n.getSource(e)?setTimeout(s,1):c())};s()}else c()}function fF(n,e,t){_D().then(()=>{if(!n.loaded())return;n.getSource(e)===t&&n.removeSource(e)})}function Ws(n,e){en(e,!0);let t=ft(e,"id",19,()=>Sp("geojson")),i=ft(e,"generateId",3,!1),r=ft(e,"promoteId",3,void 0),o=ft(e,"filter",3,void 0),c=ft(e,"lineMetrics",3,void 0),s=ft(e,"cluster",3,void 0),d=ft(e,"maxzoom",3,void 0),p=ft(e,"attribution",3,void 0),g=ft(e,"buffer",3,void 0),_=ft(e,"tolerance",3,void 0);const x=Kt(Ac),b=Kt(()=>ee(x).map),S=Kt(()=>ee(x).loaded),{source:P}=cF();let L=ii(void 0),E=ii(!0);cn(()=>{ee(b)&&ee(S)&&P.value!==t()&&(P.value=t(),dF(ee(b),P.value,Ey({type:"geojson",data:e.data,filter:o(),lineMetrics:c(),generateId:i(),promoteId:r(),cluster:!!s(),clusterMinPoints:s()?.minPoints,clusterMaxZoom:s()?.maxZoom,clusterRadius:s()?.radius,clusterProperties:s()?.properties,maxzoom:d(),attribution:p(),buffer:g(),tolerance:_()}),j=>ee(b)&&j===P.value,()=>{P.value&&(Et(L,ee(b).getSource(P.value),!0),Et(E,!0))}),ee(L))}),cn(()=>{ee(L)&&(ee(E)?Et(E,!1):ee(L).setData(e.data))});function C(){ee(b)&&Et(L,ee(b).getSource(t()),!0)}cn(()=>{ee(b)?.on("style.load",C)}),cn(()=>{ee(L)?.setClusterOptions(Ey({cluster:!!s(),clusterMaxZoom:s()?.maxZoom,clusterRadius:s()?.radius}))}),Ta(()=>{P.value&&ee(L)&&ee(b)&&(fF(ee(b),P.value,ee(L)),P.value=void 0,Et(L,void 0))});var D=ir(),O=ci(D);{var U=j=>{var G=ir(),N=ci(G);a0(N,()=>P.value,V=>{var q=ir(),z=ci(q);hs(z,()=>e.children??is),xt(V,q)}),xt(j,G)};Ki(O,j=>{P.value&&j(U)})}xt(n,D),tn()}function I8(n,e){en(e,!0);const t=Kt(Ac),i=Kt(()=>ee(t).map),r=Kt(()=>ee(t).loaded);let o=ft(e,"position",3,"top-left"),c=ft(e,"positionOptions",3,void 0),s=ft(e,"fitBoundsOptions",3,void 0),d=ft(e,"trackUserLocation",3,!1),p=ft(e,"showAccuracyCircle",3,!0),g=ft(e,"showUserLocation",3,!0),_=ft(e,"control",15);cn(()=>{ee(i)&&!_()&&(_(new Lo.GeolocateControl({positionOptions:c(),fitBoundsOptions:s(),trackUserLocation:d(),showAccuracyCircle:p(),showUserLocation:g()})),ee(i).addControl(_(),o()))}),Ta(()=>{ee(r)&&_()&&ee(i)?.removeControl(_())}),tn()}function tl(n,e){en(e,!0);let t=ft(e,"id",19,()=>Sp("line")),i=ft(e,"source",3,void 0),r=ft(e,"sourceLayer",3,void 0),o=ft(e,"beforeId",3,void 0),c=ft(e,"beforeLayerType",3,void 0),s=ft(e,"layout",3,void 0),d=ft(e,"filter",3,void 0),p=ft(e,"minzoom",3,void 0),g=ft(e,"maxzoom",3,void 0),_=ft(e,"hoverCursor",3,void 0),x=ft(e,"manageHoverState",3,!1),b=ft(e,"hovered",15),S=ft(e,"eventsIfTopMost",3,!1),P=ft(e,"interactive",3,!0),L=ft(e,"children",3,void 0),E=ft(e,"onclick",3,void 0),C=ft(e,"ondblclick",3,void 0),D=ft(e,"oncontextmenu",3,void 0),O=ft(e,"onmouseenter",3,void 0),U=ft(e,"onmousemove",3,void 0),j=ft(e,"onmouseleave",3,void 0);i1(n,{get id(){return t()},type:"line",get source(){return i()},get sourceLayer(){return r()},get beforeId(){return o()},get beforeLayerType(){return c()},get paint(){return e.paint},get layout(){return s()},get filter(){return d()},get minzoom(){return p()},get maxzoom(){return g()},get hoverCursor(){return _()},get manageHoverState(){return x()},get eventsIfTopMost(){return S()},get interactive(){return P()},get onclick(){return E()},get ondblclick(){return C()},get oncontextmenu(){return D()},get onmouseenter(){return O()},get onmousemove(){return U()},get onmouseleave(){return j()},get hovered(){return b()},set hovered(G){b(G)},children:(G,N)=>{var V=ir(),q=ci(V);hs(q,()=>L()??is),xt(G,V)},$$slots:{default:!0}}),tn()}function pF(n,e){en(e,!0);let t=ft(e,"layer",3,void 0),i=$6(e,["$$slots","$$events","$$legacy","layer"]);const r=Kt(Ac),o=Kt(()=>ee(r).map);function c(g){return i["on"+g]}function s(g){c(g.type)?.(g)}const d=["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","contextmenu","mouseover","mouseout"],p=["click","dblclick","contextmenu","mousemove","movestart","moveend","zoomstart","zoom","zoomend","pitch","rotate","wheel","data","styledata","idle"];cn(()=>{if(ee(o))if(t())for(const g of d)c(g)&&ee(o).on(g,t(),s);else for(const g of p)c(g)&&ee(o).on(g,s)}),Ta(()=>{if(ee(o))if(t())for(const g of d)c(g)&&ee(o).off(g,t(),s);else for(const g of p)c(g)&&ee(o).off(g,s)}),tn()}function R8(n){let e=n.getCenter(),t=Math.round(n.getZoom()*100)/100,i=Math.ceil((t*Math.LN2+Math.log(512/360/.5))/Math.LN10),r=Math.pow(10,i),o=Math.round(e.lat*r)/r,c=Math.round(e.lng*r)/r,s=`${t}/${o}/${c}`,d=n.getBearing(),p=n.getPitch();return(d||p)&&(s+=`/${Math.round(d*10)/10}`),p&&(s+=`/${Math.round(p)}`),`#${s}`}function L8(n){const e=n.replace("#","").split("/").map(parseFloat);return e.some(isNaN)?[]:e}var vv=dC;function dC(n,e){return n===e||n!==n&&e!==e?!0:typeof n!=typeof e||{}.toString.call(n)!={}.toString.call(e)||n!==Object(n)||!n?!1:Array.isArray(n)?fI(n,e):{}.toString.call(n)=="[object Set]"?fI(Array.from(n),Array.from(e)):{}.toString.call(n)=="[object Object]"?D8(n,e):k8(n,e)}function k8(n,e){return n.toString()===e.toString()}function fI(n,e){var t=n.length;if(t!=e.length)return!1;for(var i=0;i<t;i++)if(!dC(n[i],e[i]))return!1;return!0}function D8(n,e){var t=Object.keys(n),i=t.length;if(i!=Object.keys(e).length)return!1;for(var r=0;r<i;r++){var o=t[r];if(!(e.hasOwnProperty(o)&&dC(n[o],e[o])))return!1}return!0}const{LngLatBounds:F8,LngLat:O8}=Lo;function Ab(n,e){return Math.abs(n-e)<1e-6}function z8(n,e){let t=F8.convert(n);if(!e)return{equal:!1,bounds:t};let i=t.getNorthEast(),r=e.getNorthEast();if(!Ab(i.lat,r.lat)||!Ab(i.wrap().lng,r.wrap().lng))return{equal:!1,bounds:t};let o=t.getSouthWest(),c=e.getSouthWest();return!Ab(o.lat,c.lat)||!Ab(o.wrap().lng,c.wrap().lng)?{equal:!1,bounds:t}:{equal:!0,bounds:t}}function B8(n,e){const t=n.getSouthWest(),i=n.getNorthEast();if(Array.isArray(e)){if(e.length===4)return[t.lng,t.lat,i.lng,i.lat];if(e.length===2)return e[0]instanceof O8?[t,i]:[[t.lng,t.lat],[i.lng,i.lat]]}return n}function mF(n,e){en(e,!0);const t=Kt(Ac),i=Kt(()=>ee(t).map),r=Kt(()=>ee(t).loaded);let o=ft(e,"position",3,"top-left"),c=ft(e,"showCompass",3,!0),s=ft(e,"showZoom",3,!0),d=ft(e,"visualizePitch",3,!1),p=ii(void 0);G2(()=>{ee(i)&&!ee(p)&&(Et(p,new Lo.NavigationControl({showCompass:c(),showZoom:s(),visualizePitch:d()}),!0),ee(i).addControl(ee(p),o()))}),Ta(()=>{ee(r)&&ee(p)&&ee(i)?.removeControl(ee(p))}),tn()}function gF(n,e){en(e,!0);const t=Kt(Ac),i=Kt(()=>ee(t).map),r=Kt(()=>ee(t).loaded);let o=ft(e,"position",3,"bottom-left"),c=ft(e,"maxWidth",3,void 0),s=ft(e,"unit",3,"metric"),d=ii(void 0);cn(()=>{ee(i)&&!ee(d)&&(Et(d,new Lo.ScaleControl({maxWidth:c(),unit:s()}),!0),ee(i).addControl(ee(d),o()))}),Ta(()=>{ee(r)&&ee(d)&&ee(i)?.removeControl(ee(d))}),tn()}var N8=Wt("<!> <!> <!> <!>",1),$8=Wt("<!> <!>",1),V8=Wt('<div data-testid="map-container"><!></div>');function U8(n,e){en(e,!0);let t=ft(e,"map",15,void 0),i=ft(e,"mapContainer",15,void 0),r=ft(e,"class",3,void 0),o=ft(e,"diffStyleUpdates",3,!1),c=ft(e,"center",15,void 0),s=ft(e,"zoom",15,void 0),d=ft(e,"pitch",15,0),p=ft(e,"bearing",15,0),g=ft(e,"bearingSnap",3,7),_=ft(e,"bounds",15,void 0),x=ft(e,"fitBoundsOptions",19,()=>({})),b=ft(e,"hash",3,!1),S=ft(e,"projection",3,void 0),P=ft(e,"updateHash",3,xe=>{window.history.replaceState(window.history.state,"",xe)}),L=ft(e,"loaded",15,!1),E=ft(e,"minZoom",3,0),C=ft(e,"maxZoom",3,22),D=ft(e,"minPitch",3,0),O=ft(e,"maxPitch",3,60),U=ft(e,"renderWorldCopies",3,void 0),j=ft(e,"dragPan",3,void 0),G=ft(e,"dragRotate",3,void 0),N=ft(e,"pitchWithRotate",3,void 0),V=ft(e,"antialias",3,void 0),q=ft(e,"zoomOnDoubleClick",3,!0),z=ft(e,"locale",3,void 0),Q=ft(e,"interactive",3,!0),X=ft(e,"attributionControl",3,void 0),re=ft(e,"cooperativeGestures",3,!1),oe=ft(e,"preserveDrawingBuffer",3,!1),de=ft(e,"maxBounds",3,void 0),ce=ft(e,"images",19,()=>[]),Se=ft(e,"standardControls",3,!1),Pe=ft(e,"filterLayers",3,void 0),je=ft(e,"transformRequest",3,void 0),Fe=Kt(()=>typeof Se()=="boolean"?void 0:Se());const qe=y8();nF(new Cy(void 0));let Ue=ii(xs(new Set));async function ke(xe,vt=!1){if(t()&&!(!t()?.loaded()&&!vt))if("url"in xe){ee(Ue).add(xe.id);try{let be=await t().loadImage(xe.url);t().addImage(xe.id,be.data,xe.options),qe.loadedImages.add(xe.id)}catch(be){e.onerror?e.onerror({error:be}):console.error(be)}finally{ee(Ue).delete(xe.id)}}else t().addImage(xe.id,xe.data,xe.options),qe.loadedImages.add(xe.id)}cn(()=>{if(L()&&t()?.loaded())for(let xe of ce())!qe.loadedImages.has(xe.id)&&!ee(Ue).has(xe.id)&&!t().hasImage(xe.id)&&ke(xe)});let et=Kt(()=>ce().every(xe=>qe.loadedImages.has(xe.id))),ye=ii(void 0),Be=ii(void 0),Je=ii(void 0),ct=ii(void 0);function yt(xe){e.onerror?e.onerror(xe):xe.error.name!=="AbortError"&&console.error(xe.error)}function we(xe){return Ve(),t(qe.map=new Lo.Map(Ey({container:xe,style:e.style,locale:z(),center:c(),zoom:s(),pitch:d(),bearing:p(),bearingSnap:g(),minZoom:E(),maxZoom:C(),minPitch:D(),maxPitch:O(),renderWorldCopies:U(),dragPan:j(),dragRotate:G(),pitchWithRotate:N(),antialias:V(),interactive:Q(),preserveDrawingBuffer:oe(),maxBounds:de(),bounds:_(),attributionControl:X(),transformRequest:je(),cooperativeGestures:re()}))),t().on("load",vt=>{vt.target.getContainer().setAttribute("data-testid","map"),vt.target.getCanvas().setAttribute("data-testid","map-canvas"),e.onload&&e.onload(t()),qe.loaded=!0,L(!0)}),t().on("error",yt),e.onmovestart&&t().on("movestart",e.onmovestart),t().on("moveend",vt=>{if(c(vt.target.getCenter()),s(vt.target.getZoom()),d(vt.target.getPitch()),p(vt.target.getBearing()),_(B8(vt.target.getBounds(),_())),e.onmoveend?.(vt),b()){let be=new URL(window.location.href.replace(/(#.+)?$/,R8(vt.target)));P()(be)}}),e.onclick&&t().on("click",e.onclick),e.ondblclick&&t().on("dblclick",e.ondblclick),e.oncontextmenu&&t().on("contextmenu",e.oncontextmenu),e.onmousemove&&t().on("mousemove",e.onmousemove),e.onzoomstart&&t().on("zoomstart",e.onzoomstart),e.onzoom&&t().on("zoom",e.onzoom),e.onzoomend&&t().on("zoomend",e.onzoomend),e.onpitch&&t().on("pitch",e.onpitch),e.onrotate&&t().on("rotate",e.onrotate),e.onwheel&&t().on("wheel",e.onwheel),e.ondata&&t().on("data",e.ondata),e.onidle&&t().on("idle",e.onidle),t().on("style.load",vt=>{if(t()){S()&&t().setProjection(S()),qe.loaded=!0,L(!0);const be=t().getStyle();if(Et(ye,be.layers.map(ie=>ie.id),!0),Et(Be,Object.keys(be.sources),!0),ee(ct))for(const[ie,ae]of Object.entries(ee(ct)))t().addSource(ie,ae);if(ee(Je))for(const ie of ee(Je))t().addLayer(ie);for(const ie of ce())ke(ie,!0);e.onstyleload?.(vt)}}),t().on("styledata",vt=>{if(t()&&Pe()){const be=t().getStyle().layers;if(be)for(let ie of be)Pe()(ie)||t().setLayoutProperty(ie.id,"visibility","none")}e.onstyledata?.(vt)}),{destroy(){L(!1),qe.loaded=!1,t()?.remove()}}}let fe=ii(xs(e.style));cn(()=>{if(t()&&!vv(e.style,ee(fe))){const xe=t().getStyle();if(ee(ye)&&Et(Je,xe.layers.filter(vt=>!ee(ye).includes(vt.id)),!0),ee(Be)){const vt=Object.keys(xe.sources).filter(be=>!ee(Be).includes(be));Et(ct,{},!0);for(const be of vt)ee(ct)[be]=xe.sources[be]}Et(fe,e.style,!0),t().setStyle(e.style,{diff:o()}),qe.loadedImages.clear(),Et(Ue,new Set,!0)}}),cn(()=>{if(t()){let xe={};c()!=null&&!vv(c(),t().getCenter())&&(xe.center=c()),s()!=null&&!vv(s(),t().getZoom())&&(xe.zoom=s()),p()!=null&&!vv(p(),t().getBearing())&&(xe.bearing=p()),d()!=null&&!vv(d(),t().getPitch())&&(xe.pitch=d()),Object.keys(xe).length&&t().easeTo(xe)}}),cn(()=>{S()&&L()&&t()?.setProjection(S())}),cn(()=>{if(_()){const{equal:xe,bounds:vt}=z8(_(),t()?.getBounds());xe||t()?.fitBounds(vt,x())}}),cn(()=>{q()?t()?.doubleClickZoom.enable():t()?.doubleClickZoom.disable()});function Ve(){if(b()){let xe=L8(window.location.hash);xe.length>=3&&(s(xe[0]),c([xe[2],xe[1]])),xe.length==5&&(p(xe[3]),d(xe[4]))}}var tt=V8();Kw("hashchange",wy,Ve);let Mt;var mt=Ft(tt);{var Ce=xe=>{var vt=$8(),be=ci(vt);{var ie=De=>{var Xe=N8(),bt=ci(Xe);mF(bt,{get position(){return ee(Fe)}});var Te=gt(bt,2);{let pe=Kt(()=>({...x(),maxZoom:12}));I8(Te,{get position(){return ee(Fe)},get fitBoundsOptions(){return ee(pe)}})}var te=gt(Te,2);P8(te,{get position(){return ee(Fe)}});var he=gt(te,2);gF(he,{get position(){return ee(Fe)}}),xt(De,Xe)};Ki(be,De=>{Se()&&De(ie)})}var ae=gt(be,2);hs(ae,()=>e.children??is,()=>({map:t(),loaded:L(),loadedImages:qe.loadedImages,allImagesLoaded:ee(et)})),xt(xe,vt)};Ki(mt,xe=>{t()&&xe(Ce)})}Sc(tt,xe=>i(xe),()=>i()),C6(tt,xe=>we?.(xe)),Zi(()=>Mt=Ds(tt,1,wD(r()),"svelte-xbukvd",Mt,{"expand-map":!r()})),xt(n,tt),tn()}ds(["click","dblclick","contextmenu","mousemove","keydown"]);var j8=Wt('<div class="sv-popup"><!></div>');function fC(n,e){en(e,!0);let t=ft(e,"closeButton",3,void 0),i=ft(e,"closeOnClickOutside",3,!0),r=ft(e,"closeOnClickInside",3,!1),o=ft(e,"closeOnMove",3,!1),c=ft(e,"openOn",3,"click"),s=ft(e,"openIfTopMost",3,!0),d=ft(e,"focusAfterOpen",3,!0),p=ft(e,"anchor",3,void 0),g=ft(e,"offset",3,void 0),_=ft(e,"popupClass",3,void 0),x=ft(e,"maxWidth",3,void 0),b=ft(e,"lngLat",15,void 0),S=ft(e,"html",3,void 0),P=ft(e,"open",15,!1),L=ft(e,"onopen",3,void 0),E=ft(e,"onclose",3,void 0),C=ft(e,"onhover",3,void 0),D=g8();const O=Kt(Ac),U=Kt(()=>ee(O).map),j=Kt(()=>ee(O).eventTopMost),G=Kt(()=>ee(O).markerClickManager),N=Kt(()=>ee(O).loaded),V=c8(),q=m8(),z=f8(),Q=["click","dblclick","contextmenu"];let X=ii(void 0),re=ii(!1),oe=ii(void 0);function de(){if(!ee(X))return;let mt=ee(X).getElement();!mt||mt===ee(oe)||(Et(oe,mt,!0),c()==="hover"&&(ee(oe).style.pointerEvents="none"),ee(oe).addEventListener("mouseenter",()=>{Et(re,!0)},{passive:!0}),ee(oe).addEventListener("mouseleave",()=>{Et(re,!1)},{passive:!0}),ee(oe).addEventListener("click",()=>{r()&&P(!1)},{passive:!0}))}G2(()=>{ee(U)&&(ee(U).on("click",Je),ee(U).on("contextmenu",Je),ee(G).add(ct),typeof z?.value=="string"&&(ee(U).on("click",z.value,qe),ee(U).on("dblclick",z.value,qe),ee(U).on("contextmenu",z.value,qe),ee(U).on("mousemove",z.value,Be),ee(U).on("mouseleave",z.value,ye),ee(U).on("touchstart",z.value,ke),ee(U).on("touchend",z.value,et)))}),Ta(()=>{ee(N)&&ee(U)&&(ee(X)?.remove(),ee(U).off("click",Je),ee(U).off("contextmenu",Je),ee(G).remove(ct),z?.value instanceof Lo.Marker?z.value.getPopup()===ee(X)&&z.value.setPopup(void 0):typeof z?.value=="string"&&(ee(U).off("click",z.value,qe),ee(U).off("dblclick",z.value,qe),ee(U).off("contextmenu",z.value,qe),ee(U).off("mousemove",z.value,Be),ee(U).off("mouseleave",z.value,ye),ee(U).off("touchstart",z.value,ke),ee(U).off("touchend",z.value,et)))});function ce(){if(e.canOpen&&!e.canOpen(ee(Pe))){P(!1);return}P(!0)}function Se(mt){return s()?!("marker"in mt)&&!x8(mt)&&ee(j)(mt)!==V?.value:!1}let Pe=ii(void 0),je=ii("normal");function Fe(mt){"layerType"in mt&&mt.layerType==="deckgl"?(b(mt.coordinate),Et(Pe,mt.object?[mt.object]:void 0,!0)):(b(mt.lngLat),Et(Pe,mt.features??[],!0))}function qe(mt){mt.type!==c()||Se(mt)||(Fe(mt),setTimeout(ce))}let Ue;function ke(mt){Ue=mt.point}function et(mt){if(!Ue||c()!=="hover")return;let Ce=Ue.dist(mt.point);Ue=void 0,Ce<3&&(b(mt.lngLat),Et(Pe,mt.features??[],!0),ee(X)?.isOpen()?Et(je,"justOpened"):(Et(je,"opening"),ce()))}function ye(mt){c()!=="hover"||Ue||ee(je)!=="normal"||(P(!1),Et(Pe,void 0))}function Be(mt){if(!(c()!=="hover"||Ue||ee(je)!=="normal")){if(Se(mt)){P(!1),Et(Pe,void 0);return}Et(Pe,mt.features??[],!0),b(mt.lngLat),ce()}}function Je(mt){if(ee(je)==="justOpened"){Et(je,"normal");return}if(!i())return;let Ce=[ee(oe),z?.value instanceof Lo.Marker?z.value?.getElement():void 0];P()&&ee(X)?.isOpen()&&!Ce.some(xe=>xe?.contains(mt.originalEvent.target))&&(mt.type==="contextmenu"&&c()==="contextmenu"||mt.type!=="contextmenu")&&P(!1)}function ct(mt){i()&&P()&&ee(X)?.isOpen()&&mt.marker!==z?.value&&P(!1)}Ta(()=>{ee(N)&&ee(X)?.isOpen()&&ee(X).remove()});let yt=ii(void 0),we=Kt(()=>t()??(!i()&&!r()));cn(()=>{if(!ee(X)){let mt=_()?`${_()} sv-maplibregl-popup`:"sv-maplibregl-popup";Et(X,new Lo.Popup({closeButton:ee(we),closeOnClick:!1,closeOnMove:o(),focusAfterOpen:d(),maxWidth:x(),className:mt,anchor:p(),offset:g()}),!0),Et(oe,ee(X).getElement(),!0),ee(X).on("open",()=>{ce(),P()&&(de(),L()?.(ee(X)))}),ee(X).on("close",()=>{P(!1),E()?.(ee(X))}),C()&&ee(X).on("hover",()=>{C()?.(ee(X))})}}),cn(()=>{ee(X)&&z?.value instanceof Lo.Marker&&(c()==="click"?z.value.setPopup(ee(X)):z.value.getPopup()===ee(X)&&z.value.setPopup(void 0))}),cn(()=>{Q.includes(c())&&q.value?.type===c()&&(qe(q.value),q.value=void 0)});let fe=Kt(()=>c()==="hover"&&(q.value?.type==="mousemove"||q.value?.type==="mouseenter"));cn(()=>{c()==="hover"&&q&&(ee(fe)&&q.value&&Fe(q.value),ee(fe)||ee(re)?ce():P(!1))}),cn(()=>{ee(yt)?ee(X)?.setDOMContent(ee(yt)):S()&&ee(X)?.setHTML(S())}),cn(()=>{let mt=b()??D?.value??void 0;mt&&ee(X)?.setLngLat(mt)}),cn(()=>{if(ee(U)&&ee(X)){let mt=ee(X).isOpen();P()&&!mt?(ee(X).addTo(ee(U)),ee(je)==="opening"&&Et(je,"justOpened")):!P()&&mt&&ee(X).remove()}});var Ve=ir(),tt=ci(Ve);{var Mt=mt=>{var Ce=j8(),xe=Ft(Ce);{var vt=be=>{var ie=ir(),ae=ci(ie);hs(ae,()=>e.children??is,()=>({features:ee(Pe),data:ee(Pe)?.[0]??void 0,map:ee(U),close:()=>P(!1),isOpen:P()})),xt(be,ie)};Ki(xe,be=>{(ee(Pe)?.length||z?.value instanceof Lo.Marker||!z&&P())&&be(vt)})}Sc(Ce,be=>Et(yt,be),()=>ee(yt)),xt(mt,Ce)};Ki(tt,mt=>{e.children&&mt(Mt)})}xt(n,Ve),tn()}var Cg=Math.pow,_o=(n,e,t)=>new Promise((i,r)=>{var o=d=>{try{s(t.next(d))}catch(p){r(p)}},c=d=>{try{s(t.throw(d))}catch(p){r(p)}},s=d=>d.done?i(d.value):Promise.resolve(d.value).then(o,c);s((t=t.apply(n,e)).next())}),il=Uint8Array,ly=Uint16Array,G8=Int32Array,_F=new il([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),vF=new il([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),q8=new il([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),yF=function(n,e){for(var t=new ly(31),i=0;i<31;++i)t[i]=e+=1<<n[i-1];for(var r=new G8(t[30]),i=1;i<30;++i)for(var o=t[i];o<t[i+1];++o)r[o]=o-t[i]<<5|i;return{b:t,r}},bF=yF(_F,2),xF=bF.b,W8=bF.r;xF[28]=258,W8[258]=28;var H8=yF(vF,0),Z8=H8.b,wF=new ly(32768);for(Zn=0;Zn<32768;++Zn)eh=(Zn&43690)>>1|(Zn&21845)<<1,eh=(eh&52428)>>2|(eh&13107)<<2,eh=(eh&61680)>>4|(eh&3855)<<4,wF[Zn]=((eh&65280)>>8|(eh&255)<<8)>>1;var eh,Zn,cy=function(n,e,t){for(var i=n.length,r=0,o=new ly(e);r<i;++r)n[r]&&++o[n[r]-1];var c=new ly(e);for(r=1;r<e;++r)c[r]=c[r-1]+o[r-1]<<1;var s;{s=new ly(1<<e);var d=15-e;for(r=0;r<i;++r)if(n[r])for(var p=r<<4|n[r],g=e-n[r],_=c[n[r]-1]++<<g,x=_|(1<<g)-1;_<=x;++_)s[wF[_]>>d]=p}return s},c0=new il(288);for(Zn=0;Zn<144;++Zn)c0[Zn]=8;var Zn;for(Zn=144;Zn<256;++Zn)c0[Zn]=9;var Zn;for(Zn=256;Zn<280;++Zn)c0[Zn]=7;var Zn;for(Zn=280;Zn<288;++Zn)c0[Zn]=8;var Zn,SF=new il(32);for(Zn=0;Zn<32;++Zn)SF[Zn]=5;var Zn,X8=cy(c0,9),Y8=cy(SF,5),HS=function(n){for(var e=n[0],t=1;t<n.length;++t)n[t]>e&&(e=n[t]);return e},pc=function(n,e,t){var i=e/8|0;return(n[i]|n[i+1]<<8)>>(e&7)&t},ZS=function(n,e){var t=e/8|0;return(n[t]|n[t+1]<<8|n[t+2]<<16)>>(e&7)},K8=function(n){return(n+7)/8|0},J8=function(n,e,t){(t==null||t>n.length)&&(t=n.length);var i=new il(t-e);return i.set(n.subarray(e,t)),i},Q8=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ka=function(n,e,t){var i=new Error(e||Q8[n]);if(i.code=n,Error.captureStackTrace&&Error.captureStackTrace(i,Ka),!t)throw i;return i},pC=function(n,e,t,i){var r=n.length,o=0;if(!r||e.f&&!e.l)return t||new il(0);var c=!t||e.i!=2,s=e.i;t||(t=new il(r*3));var d=function(yt){var we=t.length;if(yt>we){var fe=new il(Math.max(we*2,yt));fe.set(t),t=fe}},p=e.f||0,g=e.p||0,_=e.b||0,x=e.l,b=e.d,S=e.m,P=e.n,L=r*8;do{if(!x){p=pc(n,g,1);var E=pc(n,g+1,3);if(g+=3,E)if(E==1)x=X8,b=Y8,S=9,P=5;else if(E==2){var U=pc(n,g,31)+257,j=pc(n,g+10,15)+4,G=U+pc(n,g+5,31)+1;g+=14;for(var N=new il(G),V=new il(19),q=0;q<j;++q)V[q8[q]]=pc(n,g+q*3,7);g+=j*3;for(var z=HS(V),Q=(1<<z)-1,X=cy(V,z),q=0;q<G;){var re=X[pc(n,g,Q)];g+=re&15;var C=re>>4;if(C<16)N[q++]=C;else{var oe=0,de=0;for(C==16?(de=3+pc(n,g,3),g+=2,oe=N[q-1]):C==17?(de=3+pc(n,g,7),g+=3):C==18&&(de=11+pc(n,g,127),g+=7);de--;)N[q++]=oe}}var ce=N.subarray(0,U),Se=N.subarray(U);S=HS(ce),P=HS(Se),x=cy(ce,S),b=cy(Se,P)}else Ka(1);else{var C=K8(g)+4,D=n[C-4]|n[C-3]<<8,O=C+D;if(O>r){s&&Ka(0);break}c&&d(_+D),t.set(n.subarray(C,O),_),e.b=_+=D,e.p=g=O*8,e.f=p;continue}if(g>L){s&&Ka(0);break}}c&&d(_+131072);for(var Pe=(1<<S)-1,je=(1<<P)-1,Fe=g;;Fe=g){var oe=x[ZS(n,g)&Pe],qe=oe>>4;if(g+=oe&15,g>L){s&&Ka(0);break}if(oe||Ka(2),qe<256)t[_++]=qe;else if(qe==256){Fe=g,x=null;break}else{var Ue=qe-254;if(qe>264){var q=qe-257,ke=_F[q];Ue=pc(n,g,(1<<ke)-1)+xF[q],g+=ke}var et=b[ZS(n,g)&je],ye=et>>4;et||Ka(3),g+=et&15;var Se=Z8[ye];if(ye>3){var ke=vF[ye];Se+=ZS(n,g)&(1<<ke)-1,g+=ke}if(g>L){s&&Ka(0);break}c&&d(_+131072);var Be=_+Ue;if(_<Se){var Je=o-Se,ct=Math.min(Se,Be);for(Je+_<0&&Ka(3);_<ct;++_)t[_]=i[Je+_]}for(;_<Be;_+=4)t[_]=t[_-Se],t[_+1]=t[_+1-Se],t[_+2]=t[_+2-Se],t[_+3]=t[_+3-Se];_=Be}}e.l=x,e.p=Fe,e.b=_,e.f=p,x&&(p=1,e.m=S,e.d=b,e.n=P)}while(!p);return _==t.length?t:J8(t,0,_)},eU=new il(0),tU=function(n){(n[0]!=31||n[1]!=139||n[2]!=8)&&Ka(6,"invalid gzip data");var e=n[3],t=10;e&4&&(t+=(n[10]|n[11]<<8)+2);for(var i=(e>>3&1)+(e>>4&1);i>0;i-=!n[t++]);return t+(e&2)},iU=function(n){var e=n.length;return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0},nU=function(n,e){return((n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31)&&Ka(6,"invalid zlib data"),(n[1]>>5&1)==1&&Ka(6,"invalid zlib data: "+(n[1]&32?"need":"unexpected")+" dictionary"),(n[1]>>3&4)+2};function rU(n,e){return pC(n,{i:2},e,e)}function sU(n,e){var t=tU(n);return t+8>n.length&&Ka(6,"invalid gzip data"),pC(n.subarray(t,-8),{i:2},new il(iU(n)),e)}function oU(n,e){return pC(n.subarray(nU(n),-4),{i:2},e,e)}function $M(n,e){return n[0]==31&&n[1]==139&&n[2]==8?sU(n,e):(n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31?rU(n,e):oU(n,e)}var aU=typeof TextDecoder<"u"&&new TextDecoder,lU=0;try{aU.decode(eU,{stream:!0}),lU=1}catch{}var TF=(n,e)=>n*Cg(2,e),yv=(n,e)=>Math.floor(n/Cg(2,e)),cw=(n,e)=>TF(n.getUint16(e+1,!0),8)+n.getUint8(e),MF=(n,e)=>TF(n.getUint32(e+2,!0),16)+n.getUint16(e,!0),cU=(n,e,t,i,r)=>{if(n!==i.getUint8(r))return n-i.getUint8(r);const o=cw(i,r+1);if(e!==o)return e-o;const c=cw(i,r+4);return t!==c?t-c:0},uU=(n,e,t,i)=>{const r=CF(n,e|128,t,i);return r?{z:e,x:t,y:i,offset:r[0],length:r[1],isDir:!0}:null},pI=(n,e,t,i)=>{const r=CF(n,e,t,i);return r?{z:e,x:t,y:i,offset:r[0],length:r[1],isDir:!1}:null},CF=(n,e,t,i)=>{let r=0,o=n.byteLength/17-1;for(;r<=o;){const c=o+r>>1,s=cU(e,t,i,n,c*17);if(s>0)r=c+1;else if(s<0)o=c-1;else return[MF(n,c*17+7),n.getUint32(c*17+13,!0)]}return null},hU=(n,e)=>n.isDir&&!e.isDir?1:!n.isDir&&e.isDir?-1:n.z!==e.z?n.z-e.z:n.x!==e.x?n.x-e.x:n.y-e.y,EF=(n,e)=>{const t=n.getUint8(e*17);return{z:t&127,x:cw(n,e*17+1),y:cw(n,e*17+4),offset:MF(n,e*17+7),length:n.getUint32(e*17+13,!0),isDir:t>>7===1}},mI=n=>{const e=[],t=new DataView(n);for(let i=0;i<t.byteLength/17;i++)e.push(EF(t,i));return dU(e)},dU=n=>{n.sort(hU);const e=new ArrayBuffer(17*n.length),t=new Uint8Array(e);for(let i=0;i<n.length;i++){const r=n[i];let o=r.z;r.isDir&&(o=o|128),t[i*17]=o,t[i*17+1]=r.x&255,t[i*17+2]=r.x>>8&255,t[i*17+3]=r.x>>16&255,t[i*17+4]=r.y&255,t[i*17+5]=r.y>>8&255,t[i*17+6]=r.y>>16&255,t[i*17+7]=r.offset&255,t[i*17+8]=yv(r.offset,8)&255,t[i*17+9]=yv(r.offset,16)&255,t[i*17+10]=yv(r.offset,24)&255,t[i*17+11]=yv(r.offset,32)&255,t[i*17+12]=yv(r.offset,48)&255,t[i*17+13]=r.length&255,t[i*17+14]=r.length>>8&255,t[i*17+15]=r.length>>16&255,t[i*17+16]=r.length>>24&255}return e},fU=(n,e)=>{if(n.byteLength<17)return null;const t=n.byteLength/17,i=EF(n,t-1);if(i.isDir){const r=i.z,o=e.z-r,c=Math.trunc(e.x/(1<<o)),s=Math.trunc(e.y/(1<<o));return{z:r,x:c,y:s}}return null};function pU(n){return _o(this,null,function*(){const e=yield n.getBytes(0,512e3),t=new DataView(e.data),i=t.getUint32(4,!0),r=t.getUint16(8,!0),o=new TextDecoder("utf-8"),c=JSON.parse(o.decode(new DataView(e.data,10,i)));let s=0;c.compression==="gzip"&&(s=2);let d=0;"minzoom"in c&&(d=+c.minzoom);let p=0;"maxzoom"in c&&(p=+c.maxzoom);let g=0,_=0,x=0,b=-180,S=-85,P=180,L=85;if(c.bounds){const C=c.bounds.split(",");b=+C[0],S=+C[1],P=+C[2],L=+C[3]}if(c.center){const C=c.center.split(",");g=+C[0],_=+C[1],x=+C[2]}return{specVersion:t.getUint16(2,!0),rootDirectoryOffset:10+i,rootDirectoryLength:r*17,jsonMetadataOffset:10,jsonMetadataLength:i,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:s,tileType:1,minZoom:d,maxZoom:p,minLon:b,minLat:S,maxLon:P,maxLat:L,centerZoom:x,centerLon:g,centerLat:_,etag:e.etag}})}function mU(n,e,t,i,r,o,c){return _o(this,null,function*(){let s=yield t.getArrayBuffer(e,n.rootDirectoryOffset,n.rootDirectoryLength,n);n.specVersion===1&&(s=mI(s));const d=pI(new DataView(s),i,r,o);if(d){let _=(yield e.getBytes(d.offset,d.length,c)).data;const x=new DataView(_);return x.getUint8(0)===31&&x.getUint8(1)===139&&(_=$M(new Uint8Array(_))),{data:_}}const p=fU(new DataView(s),{z:i,x:r,y:o});if(p){const g=uU(new DataView(s),p.z,p.x,p.y);if(g){let _=yield t.getArrayBuffer(e,g.offset,g.length,n);n.specVersion===1&&(_=mI(_));const x=pI(new DataView(_),i,r,o);if(x){let S=(yield e.getBytes(x.offset,x.length,c)).data;const P=new DataView(S);return P.getUint8(0)===31&&P.getUint8(1)===139&&(S=$M(new Uint8Array(S))),{data:S}}}}})}var AF={getHeader:pU,getZxy:mU},gU=n=>(e,t)=>{if(t instanceof AbortController)return n(e,t);const i=new AbortController;return n(e,i).then(r=>t(void 0,r.data,r.cacheControl||"",r.expires||""),r=>t(r)).catch(r=>t(r)),{cancel:()=>i.abort()}},_U=class{constructor(n){this.tilev4=(e,t)=>_o(this,null,function*(){if(e.type==="json"){const x=e.url.substr(10);let b=this.tiles.get(x);if(b||(b=new gI(x),this.tiles.set(x,b)),this.metadata)return{data:yield b.getTileJson(e.url)};const S=yield b.getHeader();return{data:{tiles:[`${e.url}/{z}/{x}/{y}`],minzoom:S.minZoom,maxzoom:S.maxZoom,bounds:[S.minLon,S.minLat,S.maxLon,S.maxLat]}}}const i=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),r=e.url.match(i);if(!r)throw new Error("Invalid PMTiles protocol URL");const o=r[1];let c=this.tiles.get(o);c||(c=new gI(o),this.tiles.set(o,c));const s=r[2],d=r[3],p=r[4],g=yield c.getHeader(),_=yield c?.getZxy(+s,+d,+p,t.signal);return _?{data:new Uint8Array(_.data),cacheControl:_.cacheControl,expires:_.expires}:g.tileType===1?{data:new Uint8Array}:{data:null}}),this.tile=gU(this.tilev4),this.tiles=new Map,this.metadata=n?.metadata||!1}add(n){this.tiles.set(n.source.getKey(),n)}get(n){return this.tiles.get(n)}};function Nm(n,e){return(e>>>0)*4294967296+(n>>>0)}function vU(n,e){const t=e.buf;let i=t[e.pos++],r=(i&112)>>4;if(i<128||(i=t[e.pos++],r|=(i&127)<<3,i<128)||(i=t[e.pos++],r|=(i&127)<<10,i<128)||(i=t[e.pos++],r|=(i&127)<<17,i<128)||(i=t[e.pos++],r|=(i&127)<<24,i<128)||(i=t[e.pos++],r|=(i&1)<<31,i<128))return Nm(n,r);throw new Error("Expected varint not more than 10 bytes")}function bv(n){const e=n.buf;let t=e[n.pos++],i=t&127;return t<128||(t=e[n.pos++],i|=(t&127)<<7,t<128)||(t=e[n.pos++],i|=(t&127)<<14,t<128)||(t=e[n.pos++],i|=(t&127)<<21,t<128)?i:(t=e[n.pos],i|=(t&15)<<28,vU(i,n))}function yU(n,e,t,i){if(i===0){t===1&&(e[0]=n-1-e[0],e[1]=n-1-e[1]);const r=e[0];e[0]=e[1],e[1]=r}}var bU=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function xU(n,e,t){if(n>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>Cg(2,n)-1||t>Cg(2,n)-1)throw Error("tile x/y outside zoom level bounds");const i=bU[n],r=Cg(2,n);let o=0,c=0,s=0;const d=[e,t];let p=r/2;for(;p>0;)o=(d[0]&p)>0?1:0,c=(d[1]&p)>0?1:0,s+=p*p*(3*o^c),yU(p,d,o,c),p=p/2;return i+s}function PF(n,e){return _o(this,null,function*(){if(e===1||e===0)return n;if(e===2){if(typeof globalThis.DecompressionStream>"u")return $M(new Uint8Array(n));const t=new Response(n).body;if(!t)throw Error("Failed to read response stream");const i=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(i).arrayBuffer()}throw Error("Compression method not supported")})}function wU(n){return n===1?".mvt":n===2?".png":n===3?".jpg":n===4?".webp":n===5?".avif":""}var SU=127;function TU(n,e){let t=0,i=n.length-1;for(;t<=i;){const r=i+t>>1,o=e-n[r].tileId;if(o>0)t=r+1;else if(o<0)i=r-1;else return n[r]}return i>=0&&(n[i].runLength===0||e-n[i].tileId<n[i].runLength)?n[i]:null}var MU=class{constructor(n,e=new Headers){this.url=n,this.customHeaders=e,this.mustReload=!1;let t="";"navigator"in globalThis&&(t=globalThis.navigator.userAgent||"");const i=t.indexOf("Windows")>-1,r=/Chrome|Chromium|Edg|OPR|Brave/.test(t);this.chromeWindowsNoCache=!1,i&&r&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(n){this.customHeaders=n}getBytes(n,e,t,i){return _o(this,null,function*(){let r,o;t?o=t:(r=new AbortController,o=r.signal);const c=new Headers(this.customHeaders);c.set("range",`bytes=${n}-${n+e-1}`);let s;this.mustReload?s="reload":this.chromeWindowsNoCache&&(s="no-store");let d=yield fetch(this.url,{signal:o,cache:s,headers:c});if(n===0&&d.status===416){const x=d.headers.get("Content-Range");if(!x||!x.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const b=+x.substr(8);d=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${b-1}`}})}let p=d.headers.get("Etag");if(p?.startsWith("W/")&&(p=null),d.status===416||i&&p&&p!==i)throw this.mustReload=!0,new VM(`Server returned non-matching ETag ${i} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(d.status>=300)throw Error(`Bad response code: ${d.status}`);const g=d.headers.get("Content-Length");if(d.status===200&&(!g||+g>e))throw r&&r.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield d.arrayBuffer(),etag:p||void 0,cacheControl:d.headers.get("Cache-Control")||void 0,expires:d.headers.get("Expires")||void 0}})}};function mc(n,e){const t=n.getUint32(e+4,!0),i=n.getUint32(e+0,!0);return t*Cg(2,32)+i}function CU(n,e){const t=new DataView(n),i=t.getUint8(7);if(i>3)throw Error(`Archive is spec version ${i} but this library supports up to spec version 3`);return{specVersion:i,rootDirectoryOffset:mc(t,8),rootDirectoryLength:mc(t,16),jsonMetadataOffset:mc(t,24),jsonMetadataLength:mc(t,32),leafDirectoryOffset:mc(t,40),leafDirectoryLength:mc(t,48),tileDataOffset:mc(t,56),tileDataLength:mc(t,64),numAddressedTiles:mc(t,72),numTileEntries:mc(t,80),numTileContents:mc(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}function IF(n){const e={buf:new Uint8Array(n),pos:0},t=bv(e),i=[];let r=0;for(let o=0;o<t;o++){const c=bv(e);i.push({tileId:r+c,offset:0,length:0,runLength:1}),r+=c}for(let o=0;o<t;o++)i[o].runLength=bv(e);for(let o=0;o<t;o++)i[o].length=bv(e);for(let o=0;o<t;o++){const c=bv(e);c===0&&o>0?i[o].offset=i[o-1].offset+i[o-1].length:i[o].offset=c-1}return i}function EU(n){const e=new DataView(n);return e.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):e.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var VM=class extends Error{};function AU(n,e){return _o(this,null,function*(){const t=yield n.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(EU(t.data)<3)return[yield AF.getHeader(n)];const r=t.data.slice(0,SU),o=CU(r,t.etag),c=t.data.slice(o.rootDirectoryOffset,o.rootDirectoryOffset+o.rootDirectoryLength),s=`${n.getKey()}|${o.etag||""}|${o.rootDirectoryOffset}|${o.rootDirectoryLength}`,d=IF(yield e(c,o.internalCompression));return[o,[s,d.length,d]]})}function PU(n,e,t,i,r){return _o(this,null,function*(){const o=yield n.getBytes(t,i,void 0,r.etag),c=yield e(o.data,r.internalCompression),s=IF(c);if(s.length===0)throw new Error("Empty directory is invalid");return s})}var IU=class{constructor(n=100,e=!0,t=PF){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=n,this.counter=1,this.decompress=t}getHeader(n){return _o(this,null,function*(){const e=n.getKey(),t=this.cache.get(e);if(t)return t.lastUsed=this.counter++,yield t.data;const i=new Promise((r,o)=>{AU(n,this.decompress).then(c=>{c[1]&&this.cache.set(c[1][0],{lastUsed:this.counter++,data:Promise.resolve(c[1][2])}),r(c[0]),this.prune()}).catch(c=>{o(c)})});return this.cache.set(e,{lastUsed:this.counter++,data:i}),i})}getDirectory(n,e,t,i){return _o(this,null,function*(){const r=`${n.getKey()}|${i.etag||""}|${e}|${t}`,o=this.cache.get(r);if(o)return o.lastUsed=this.counter++,yield o.data;const c=new Promise((s,d)=>{PU(n,this.decompress,e,t,i).then(p=>{s(p),this.prune()}).catch(p=>{d(p)})});return this.cache.set(r,{lastUsed:this.counter++,data:c}),c})}getArrayBuffer(n,e,t,i){return _o(this,null,function*(){const r=`${n.getKey()}|${i.etag||""}|${e}|${t}`,o=this.cache.get(r);if(o)return o.lastUsed=this.counter++,yield o.data;const c=new Promise((s,d)=>{n.getBytes(e,t,void 0,i.etag).then(p=>{s(p.data),this.cache.has(r),this.prune()}).catch(p=>{d(p)})});return this.cache.set(r,{lastUsed:this.counter++,data:c}),c})}prune(){if(this.cache.size>=this.maxCacheEntries){let n=1/0,e;this.cache.forEach((t,i)=>{t.lastUsed<n&&(n=t.lastUsed,e=i)}),e&&this.cache.delete(e)}}invalidate(n){return _o(this,null,function*(){const e=n.getKey();if(this.invalidations.get(e))return yield this.invalidations.get(e);this.cache.delete(n.getKey());const t=new Promise((i,r)=>{this.getHeader(n).then(o=>{i(),this.invalidations.delete(e)}).catch(o=>{r(o)})});this.invalidations.set(e,t)})}},gI=class{constructor(n,e,t){typeof n=="string"?this.source=new MU(n):this.source=n,t?this.decompress=t:this.decompress=PF,e?this.cache=e:this.cache=new IU}getHeader(){return _o(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(n,e,t,i){return _o(this,null,function*(){const r=xU(n,e,t),o=yield this.cache.getHeader(this.source);if(o.specVersion<3)return AF.getZxy(o,this.source,this.cache,n,e,t,i);if(n<o.minZoom||n>o.maxZoom)return;let c=o.rootDirectoryOffset,s=o.rootDirectoryLength;for(let d=0;d<=3;d++){const p=yield this.cache.getDirectory(this.source,c,s,o),g=TU(p,r);if(g){if(g.runLength>0){const _=yield this.source.getBytes(o.tileDataOffset+g.offset,g.length,i,o.etag);return{data:yield this.decompress(_.data,o.tileCompression),cacheControl:_.cacheControl,expires:_.expires}}c=o.leafDirectoryOffset+g.offset,s=g.length}else return}throw Error("Maximum directory depth exceeded")})}getZxy(n,e,t,i){return _o(this,null,function*(){try{return yield this.getZxyAttempt(n,e,t,i)}catch(r){if(r instanceof VM)return this.cache.invalidate(this.source),yield this.getZxyAttempt(n,e,t,i);throw r}})}getMetadataAttempt(){return _o(this,null,function*(){const n=yield this.cache.getHeader(this.source),e=yield this.source.getBytes(n.jsonMetadataOffset,n.jsonMetadataLength,void 0,n.etag),t=yield this.decompress(e.data,n.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(t))})}getMetadata(){return _o(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(n){if(n instanceof VM)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw n}})}getTileJson(n){return _o(this,null,function*(){const e=yield this.getHeader(),t=yield this.getMetadata(),i=wU(e.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${n}/{z}/{x}/{y}${i}`],vector_layers:t.vector_layers,attribution:t.attribution,description:t.description,name:t.name,version:t.version,bounds:[e.minLon,e.minLat,e.maxLon,e.maxLat],center:[e.centerLon,e.centerLat,e.centerZoom],minzoom:e.minZoom,maxzoom:e.maxZoom}})}};function Uv(n,e){en(e,!0);let t=ft(e,"id",19,()=>Sp("symbol")),i=ft(e,"source",3,void 0),r=ft(e,"sourceLayer",3,void 0),o=ft(e,"beforeId",3,void 0),c=ft(e,"beforeLayerType",3,void 0),s=ft(e,"paint",3,void 0),d=ft(e,"layout",3,void 0),p=ft(e,"filter",3,void 0),g=ft(e,"applyToClusters",3,void 0),_=ft(e,"minzoom",3,void 0),x=ft(e,"maxzoom",3,void 0),b=ft(e,"hoverCursor",3,void 0),S=ft(e,"manageHoverState",3,!1),P=ft(e,"hovered",15),L=ft(e,"eventsIfTopMost",3,!1),E=ft(e,"interactive",3,!0),C=ft(e,"children",3,void 0),D=ft(e,"onclick",3,void 0),O=ft(e,"ondblclick",3,void 0),U=ft(e,"oncontextmenu",3,void 0),j=ft(e,"onmouseenter",3,void 0),G=ft(e,"onmousemove",3,void 0),N=ft(e,"onmouseleave",3,void 0);i1(n,{get id(){return t()},type:"symbol",get source(){return i()},get sourceLayer(){return r()},get beforeId(){return o()},get beforeLayerType(){return c()},get paint(){return s()},get layout(){return d()},get filter(){return p()},get applyToClusters(){return g()},get minzoom(){return _()},get maxzoom(){return x()},get hoverCursor(){return b()},get manageHoverState(){return S()},get eventsIfTopMost(){return L()},get interactive(){return E()},get onclick(){return D()},get ondblclick(){return O()},get oncontextmenu(){return U()},get onmouseenter(){return j()},get onmousemove(){return G()},get onmouseleave(){return N()},get hovered(){return P()},set hovered(V){P(V)},children:(V,q)=>{var z=ir(),Q=ci(z);hs(Q,()=>C()??is),xt(V,z)},$$slots:{default:!0}}),tn()}function RU(n,e){en(e,!0);let t=ft(e,"id",19,()=>Sp("vector")),i=ft(e,"url",3,void 0),r=ft(e,"tiles",3,void 0),o=ft(e,"promoteId",3,void 0),c=ft(e,"bounds",3,void 0),s=ft(e,"scheme",3,void 0),d=ft(e,"attribution",3,void 0),p=ft(e,"minzoom",3,void 0),g=ft(e,"maxzoom",3,void 0),_=ft(e,"volatile",3,void 0);if(i()&&i().includes("pmtiles://")&&!Object.hasOwn(Lo.config.REGISTERED_PROTOCOLS,"pmtiles")){let U=new _U;Lo.addProtocol("pmtiles",U.tile)}const x=Kt(Ac),b=Kt(()=>ee(x).map),S=Kt(()=>ee(x).loaded),{source:P}=cF();let L=ii(void 0);cn(()=>{ee(b)&&ee(S)&&P.value!==t()&&(P.value=t(),dF(ee(b),P.value,Ey({type:"vector",url:i(),tiles:r(),promoteId:o(),bounds:c(),scheme:s(),attribution:d(),minzoom:p(),maxzoom:g(),volatile:_()}),U=>ee(b)&&U===P.value,()=>{P.value&&Et(L,ee(b).getSource(P.value),!0)}))});function E(){ee(b)&&Et(L,ee(b).getSource(t()),!0)}cn(()=>{ee(b)&&ee(b).on("style.load",E)}),Ta(()=>{ee(b)?.off("style.load",E),P.value&&ee(b)&&(fF(ee(b),P.value,ee(L)),P.value=void 0,Et(L,void 0))});var C=ir(),D=ci(C);{var O=U=>{var j=ir(),G=ci(j);a0(G,()=>P.value,N=>{var V=ir(),q=ci(V);hs(q,()=>e.children??is),xt(N,V)}),xt(U,j)};Ki(D,U=>{P.value&&U(O)})}xt(n,C),tn()}var LU=Wt("<!> <!> <!>",1);function kU(n){const e=()=>Qi(tF,"$polygonToolGj",t),[t,i]=qr();Ws(n,{get data(){return e()},children:(r,o)=>{var c=LU(),s=ci(c);hC(s,{id:"edit-polygon-fill",get filter(){return YV},paint:{"fill-color":"red","fill-opacity":["case",["boolean",["get","hover"],"false"],1,.5]}});var d=gt(s,2);tl(d,{id:"edit-polygon-lines",get filter(){return KV},paint:{"line-color":"black","line-width":8,"line-opacity":.5}});var p=gt(d,2);cu(p,{id:"edit-polygon-vertices",get filter(){return JV},paint:{"circle-color":"black","circle-opacity":["case",["has","hovered"],1,.5],"circle-radius":10}}),xt(r,c)},$$slots:{default:!0}}),i()}var DU=Wt('<div class="flex-container svelte-eqsjzd"><div class="top svelte-eqsjzd"><!></div> <div class="content svelte-eqsjzd"><div class="left svelte-eqsjzd"><!></div> <div class="main svelte-eqsjzd"><!></div></div></div>');function FU(n,e){en(e,!0),cn(()=>{XS.value&&uw.value&&(XS.value.innerHTML="",XS.value.appendChild(uw.value))}),cn(()=>{uy.value&&hw.value&&(uy.value.innerHTML="",uy.value.appendChild(hw.value))}),cn(()=>{YS.value&&dw.value&&(YS.value.innerHTML="",YS.value.appendChild(dw.value))});var t=DU(),i=Ft(t),r=Ft(i);hs(r,()=>e.top??is);var o=gt(i,2),c=Ft(o),s=Ft(c);hs(s,()=>e.left??is);var d=gt(c,2),p=Ft(d);hs(p,()=>e.main??is),xt(n,t),tn()}var OU=Wt("<div><!></div> <div><!></div> <div><!></div>",1);function u0(n,e){en(e,!0);var t=OU(),i=ci(t),r=Ft(i);hs(r,()=>e.top??is),Sc(i,p=>uw.value=p,()=>uw?.value);var o=gt(i,2),c=Ft(o);hs(c,()=>e.left??is),Sc(o,p=>hw.value=p,()=>hw?.value);var s=gt(o,2),d=Ft(s);hs(d,()=>e.main??is),Sc(s,p=>dw.value=p,()=>dw?.value),xt(n,t),tn()}let uw=xs({value:void 0}),hw=xs({value:void 0}),dw=xs({value:void 0}),XS=xs({value:void 0}),uy=xs({value:void 0}),YS=xs({value:void 0});function zU(n,e={}){if(n.bbox!=null&&e.recompute!==!0)return n.bbox;const t=[1/0,1/0,-1/0,-1/0];return JD(n,i=>{t[0]>i[0]&&(t[0]=i[0]),t[1]>i[1]&&(t[1]=i[1]),t[2]<i[0]&&(t[2]=i[0]),t[3]<i[1]&&(t[3]=i[1])}),t}var BU=zU,NU=Object.defineProperty,RF=n=>{throw TypeError(n)},$U=(n,e,t)=>e in n?NU(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ai=(n,e,t)=>$U(n,typeof e!="symbol"?e+"":e,t),LF=(n,e,t)=>e.has(n)||RF("Cannot "+t),vs=(n,e,t)=>(LF(n,e,"read from private field"),e.get(n)),KS=(n,e,t)=>e.has(n)?RF("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Pb=(n,e,t,i)=>(LF(n,e,"write to private field"),e.set(n,t),t);function jr(){}function VU(n,e){for(const t in e)n[t]=e[t];return n}function kF(n){return n()}function _I(){return Object.create(null)}function Dh(n){n.forEach(kF)}function DF(n){return typeof n=="function"}function Xd(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}let Ib;function zo(n,e){return n===e?!0:(Ib||(Ib=document.createElement("a")),Ib.href=e,n===Ib.href)}function UU(n){return Object.keys(n).length===0}function jU(n,e,t,i){if(n){const r=FF(n,e,t,i);return n[0](r)}}function FF(n,e,t,i){return n[1]&&i?VU(t.ctx.slice(),n[1](i(e))):t.ctx}function GU(n,e,t,i){return n[2],e.dirty}function qU(n,e,t,i,r,o){if(r){const c=FF(e,t,i,o);n.p(c,r)}}function WU(n){if(n.ctx.length>32){const e=[],t=n.ctx.length/32;for(let i=0;i<t;i++)e[i]=-1;return e}return-1}function fw(n){return n??""}function Rn(n,e){n.appendChild(e)}function Or(n,e,t){n.insertBefore(e,t||null)}function Er(n){n.parentNode&&n.parentNode.removeChild(n)}function hr(n){return document.createElement(n)}function Tc(n){return document.createElementNS("http://www.w3.org/2000/svg",n)}function zd(n){return document.createTextNode(n)}function Ja(){return zd(" ")}function HU(){return zd("")}function qs(n,e,t,i){return n.addEventListener(e,t,i),()=>n.removeEventListener(e,t,i)}function ZU(n){return function(e){return e.preventDefault(),n.call(this,e)}}function jt(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function XU(n){return Array.from(n.childNodes)}function Ay(n,e){e=""+e,n.data!==e&&(n.data=e)}function vI(n,e){n.value=e??""}function uu(n,e,t){n.classList.toggle(e,!!t)}function YU(n,e,{bubbles:t=!1,cancelable:i=!1}={}){return new CustomEvent(n,{detail:e,bubbles:t,cancelable:i})}let Py;function hy(n){Py=n}function OF(){if(!Py)throw new Error("Function called outside component initialization");return Py}function KU(n){OF().$$.on_destroy.push(n)}function zF(){const n=OF();return(e,t,{cancelable:i=!1}={})=>{const r=n.$$.callbacks[e];if(r){const o=YU(e,t,{cancelable:i});return r.slice().forEach(c=>{c.call(n,o)}),!o.defaultPrevented}return!0}}function JU(n,e){const t=n.$$.callbacks[e.type];t&&t.slice().forEach(i=>i.call(this,e))}const dg=[],UM=[];let Eg=[];const yI=[],QU=Promise.resolve();let jM=!1;function ej(){jM||(jM=!0,QU.then(BF))}function GM(n){Eg.push(n)}const JS=new Set;let $m=0;function BF(){if($m!==0)return;const n=Py;do{try{for(;$m<dg.length;){const e=dg[$m];$m++,hy(e),tj(e.$$)}}catch(e){throw dg.length=0,$m=0,e}for(hy(null),dg.length=0,$m=0;UM.length;)UM.pop()();for(let e=0;e<Eg.length;e+=1){const t=Eg[e];JS.has(t)||(JS.add(t),t())}Eg.length=0}while(dg.length);for(;yI.length;)yI.pop()();jM=!1,JS.clear(),hy(n)}function tj(n){if(n.fragment!==null){n.update(),Dh(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(GM)}}function ij(n){const e=[],t=[];Eg.forEach(i=>n.indexOf(i)===-1?e.push(i):t.push(i)),t.forEach(i=>i()),Eg=e}const Ux=new Set;let ep;function jv(){ep={r:0,c:[],p:ep}}function Gv(){ep.r||Dh(ep.c),ep=ep.p}function Qr(n,e){n&&n.i&&(Ux.delete(n),n.i(e))}function Fs(n,e,t,i){if(n&&n.o){if(Ux.has(n))return;Ux.add(n),ep.c.push(()=>{Ux.delete(n),i&&(t&&n.d(1),i())}),n.o(e)}else i&&i()}function bI(n){return n?.length!==void 0?n:Array.from(n)}function nj(n,e){Fs(n,1,1,()=>{e.delete(n.key)})}function rj(n,e,t,i,r,o,c,s,d,p,g,_){let x=n.length,b=o.length,S=x;const P={};for(;S--;)P[n[S].key]=S;const L=[],E=new Map,C=new Map,D=[];for(S=b;S--;){const G=_(r,o,S),N=t(G);let V=c.get(N);V?D.push(()=>V.p(G,e)):(V=p(N,G),V.c()),E.set(N,L[S]=V),N in P&&C.set(N,Math.abs(S-P[N]))}const O=new Set,U=new Set;function j(G){Qr(G,1),G.m(s,g),c.set(G.key,G),g=G.first,b--}for(;x&&b;){const G=L[b-1],N=n[x-1],V=G.key,q=N.key;G===N?(g=G.first,x--,b--):E.has(q)?!c.has(V)||O.has(V)?j(G):U.has(q)?x--:C.get(V)>C.get(q)?(U.add(V),j(G)):(O.add(q),x--):(d(N,c),x--)}for(;x--;){const G=n[x];E.has(G.key)||d(G,c)}for(;b;)j(L[b-1]);return Dh(D),L}function Bd(n){n&&n.c()}function Mh(n,e,t){const{fragment:i,after_update:r}=n.$$;i&&i.m(e,t),GM(()=>{const o=n.$$.on_mount.map(kF).filter(DF);n.$$.on_destroy?n.$$.on_destroy.push(...o):Dh(o),n.$$.on_mount=[]}),r.forEach(GM)}function Ch(n,e){const t=n.$$;t.fragment!==null&&(ij(t.after_update),Dh(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function sj(n,e){n.$$.dirty[0]===-1&&(dg.push(n),ej(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function Yd(n,e,t,i,r,o,c=null,s=[-1]){const d=Py;hy(n);const p=n.$$={fragment:null,ctx:[],props:o,update:jr,not_equal:r,bound:_I(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(d?d.$$.context:[])),callbacks:_I(),dirty:s,skip_bound:!1,root:e.target||d.$$.root};c&&c(p.root);let g=!1;if(p.ctx=t?t(n,e.props||{},(_,x,...b)=>{const S=b.length?b[0]:x;return p.ctx&&r(p.ctx[_],p.ctx[_]=S)&&(!p.skip_bound&&p.bound[_]&&p.bound[_](S),g&&sj(n,_)),x}):[],p.update(),g=!0,Dh(p.before_update),p.fragment=i?i(p.ctx):!1,e.target){if(e.hydrate){const _=XU(e.target);p.fragment&&p.fragment.l(_),_.forEach(Er)}else p.fragment&&p.fragment.c();e.intro&&Qr(n.$$.fragment),Mh(n,e.target,e.anchor),BF()}hy(d)}class Kd{constructor(){Ai(this,"$$"),Ai(this,"$$set")}$destroy(){Ch(this,1),this.$destroy=jr}$on(e,t){if(!DF(t))return jr;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(t),()=>{const r=i.indexOf(t);r!==-1&&i.splice(r,1)}}$set(e){this.$$set&&!UU(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const oj="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(oj);function aj(n){let e,t;return{c(){e=Tc("svg"),t=Tc("path"),jt(t,"d","M13.12.706a.982.982 0 0 0-1.391 0L6.907 5.517 2.087.696a.982.982 0 1 0-1.391 1.39l4.821 4.821L.696 11.73a.982.982 0 1 0 1.39 1.39l4.821-4.821 4.822 4.821a.982.982 0 1 0 1.39-1.39L8.298 6.908l4.821-4.822a.988.988 0 0 0 0-1.38Z"),jt(e,"viewBox","0 0 14 14"),jt(e,"width","13"),jt(e,"height","13"),jt(e,"class","svelte-en2qvf")},m(i,r){Or(i,e,r),Rn(e,t)},p:jr,i:jr,o:jr,d(i){i&&Er(e)}}}class NF extends Kd{constructor(e){super(),Yd(this,e,null,aj,Xd,{})}}function lj(n){let e,t;return{c(){e=Tc("svg"),t=Tc("path"),jt(t,"d","M15 0C6.705 0 0 6.705 0 15C0 23.295 6.705 30 15 30C23.295 30 30 23.295 30 15C30 6.705 23.295 0 15 0ZM22.5 20.385L20.385 22.5L15 17.115L9.615 22.5L7.5 20.385L12.885 15L7.5 9.615L9.615 7.5L15 12.885L20.385 7.5L22.5 9.615L17.115 15L22.5 20.385Z"),jt(e,"viewBox","0 0 30 30"),jt(e,"fill","none"),jt(e,"xmlns","http://www.w3.org/2000/svg"),jt(e,"class","svelte-d2loi5")},m(i,r){Or(i,e,r),Rn(e,t)},p:jr,i:jr,o:jr,d(i){i&&Er(e)}}}class $F extends Kd{constructor(e){super(),Yd(this,e,null,lj,Xd,{})}}function cj(n){let e,t;return{c(){e=hr("img"),zo(e.src,t=n[3]+"area.svg")||jt(e,"src",t),jt(e,"alt",n[7]),jt(e,"title",n[7]),jt(e,"class","svelte-w9y5n9")},m(i,r){Or(i,e,r)},p(i,r){r&8&&!zo(e.src,t=i[3]+"area.svg")&&jt(e,"src",t),r&128&&jt(e,"alt",i[7]),r&128&&jt(e,"title",i[7])},d(i){i&&Er(e)}}}function uj(n){let e,t;return{c(){e=hr("img"),zo(e.src,t=n[3]+"reverse.svg")||jt(e,"src",t),jt(e,"alt",n[7]),jt(e,"title",n[7]),jt(e,"class","svelte-w9y5n9")},m(i,r){Or(i,e,r)},p(i,r){r&8&&!zo(e.src,t=i[3]+"reverse.svg")&&jt(e,"src",t),r&128&&jt(e,"alt",i[7]),r&128&&jt(e,"title",i[7])},d(i){i&&Er(e)}}}function hj(n){let e,t;return{c(){e=hr("img"),zo(e.src,t=n[3]+"poi.svg")||jt(e,"src",t),jt(e,"alt",n[7]),jt(e,"title",n[7]),jt(e,"class","svelte-w9y5n9")},m(i,r){Or(i,e,r)},p(i,r){r&8&&!zo(e.src,t=i[3]+"poi.svg")&&jt(e,"src",t),r&128&&jt(e,"alt",i[7]),r&128&&jt(e,"title",i[7])},d(i){i&&Er(e)}}}function dj(n){let e,t;return{c(){e=hr("img"),zo(e.src,t=n[3]+"postal_code.svg")||jt(e,"src",t),jt(e,"alt",n[7]),jt(e,"title",n[7]),jt(e,"class","svelte-w9y5n9")},m(i,r){Or(i,e,r)},p(i,r){r&8&&!zo(e.src,t=i[3]+"postal_code.svg")&&jt(e,"src",t),r&128&&jt(e,"alt",i[7]),r&128&&jt(e,"title",i[7])},d(i){i&&Er(e)}}}function fj(n){let e,t;return{c(){e=hr("img"),zo(e.src,t=n[3]+"street.svg")||jt(e,"src",t),jt(e,"alt",n[7]),jt(e,"title",n[7]),jt(e,"class","svelte-w9y5n9")},m(i,r){Or(i,e,r)},p(i,r){r&8&&!zo(e.src,t=i[3]+"street.svg")&&jt(e,"src",t),r&128&&jt(e,"alt",i[7]),r&128&&jt(e,"title",i[7])},d(i){i&&Er(e)}}}function pj(n){let e,t;return{c(){e=hr("img"),zo(e.src,t=n[3]+"road.svg")||jt(e,"src",t),jt(e,"alt",n[7]),jt(e,"title",n[7]),jt(e,"class","svelte-w9y5n9")},m(i,r){Or(i,e,r)},p(i,r){r&8&&!zo(e.src,t=i[3]+"road.svg")&&jt(e,"src",t),r&128&&jt(e,"alt",i[7]),r&128&&jt(e,"title",i[7])},d(i){i&&Er(e)}}}function mj(n){let e,t;return{c(){e=hr("img"),zo(e.src,t=n[3]+"housenumber.svg")||jt(e,"src",t),jt(e,"alt",n[7]),jt(e,"title",n[7]),jt(e,"class","svelte-w9y5n9")},m(i,r){Or(i,e,r)},p(i,r){r&8&&!zo(e.src,t=i[3]+"housenumber.svg")&&jt(e,"src",t),r&128&&jt(e,"alt",i[7]),r&128&&jt(e,"title",i[7])},d(i){i&&Er(e)}}}function gj(n){let e,t,i,r;return{c(){e=hr("img"),zo(e.src,t=n[5])||jt(e,"src",t),jt(e,"alt",n[4]),jt(e,"title",n[7]),jt(e,"class","svelte-w9y5n9")},m(o,c){Or(o,e,c),i||(r=qs(e,"error",n[14]),i=!0)},p(o,c){c&32&&!zo(e.src,t=o[5])&&jt(e,"src",t),c&16&&jt(e,"alt",o[4]),c&128&&jt(e,"title",o[7])},d(o){o&&Er(e),i=!1,r()}}}function _j(n){let e,t;return{c(){e=hr("div"),jt(e,"class","sprite-icon svelte-w9y5n9"),jt(e,"style",t=`
        width: ${n[6].width/Cl}px;
        height: ${n[6].height/Cl}px;
        background-image: url(${n[3]}sprite${qM}.png);
        background-position: -${n[6].x/Cl}px -${n[6].y/Cl}px;
        background-size: ${su.width/Cl}px ${su.height/Cl}px;
      `),jt(e,"title",n[7])},m(i,r){Or(i,e,r)},p(i,r){r&72&&t!==(t=`
        width: ${i[6].width/Cl}px;
        height: ${i[6].height/Cl}px;
        background-image: url(${i[3]}sprite${qM}.png);
        background-position: -${i[6].x/Cl}px -${i[6].y/Cl}px;
        background-size: ${su.width/Cl}px ${su.height/Cl}px;
      `)&&jt(e,"style",t),r&128&&jt(e,"title",i[7])},d(i){i&&Er(e)}}}function xI(n){let e,t;return{c(){e=hr("span"),t=zd(n[7]),jt(e,"class","secondary svelte-w9y5n9")},m(i,r){Or(i,e,r),Rn(e,t)},p(i,r){r&128&&Ay(t,i[7])},d(i){i&&Er(e)}}}function vj(n){let e,t,i,r,o,c,s,d,p,g=(n[8]?n[0].place_name:n[0].place_name.replace(/,.*/,""))+"",_,x,b=n[2]==="always"||n[2]!=="never"&&!n[0].address&&!n[0].id.startsWith("road.")&&!n[0].id.startsWith("address.")&&!n[0].id.startsWith("postal_code.")&&(!n[0].id.startsWith("poi.")||!n[5])&&!n[8],S,P,L=(n[8]?"":n[0].place_name.replace(/[^,]*,?\s*/,""))+"",E,C,D,O,U,j;function G(z,Q){return Q&1&&(t=null),Q&1&&(i=null),Q&1&&(r=null),Q&1&&(o=null),su&&z[6]?_j:z[5]?gj:z[0].address?mj:(t==null&&(t=!!z[0].id.startsWith("road.")),t?pj:(i==null&&(i=!!z[0].id.startsWith("address.")),i?fj:(r==null&&(r=!!z[0].id.startsWith("postal_code.")),r?dj:(o==null&&(o=!!z[0].id.startsWith("poi.")),o?hj:z[8]?uj:cj))))}let N=G(n,-1),V=N(n),q=b&&xI(n);return{c(){e=hr("li"),V.c(),c=Ja(),s=hr("span"),d=hr("span"),p=hr("span"),_=zd(g),x=Ja(),q&&q.c(),S=Ja(),P=hr("span"),E=zd(L),jt(p,"class","primary svelte-w9y5n9"),jt(d,"class","svelte-w9y5n9"),jt(P,"class","line2 svelte-w9y5n9"),jt(s,"class","texts svelte-w9y5n9"),jt(e,"tabindex","-1"),jt(e,"role","option"),jt(e,"aria-selected",C=n[1]==="selected"),jt(e,"aria-checked",D=n[1]==="picked"),jt(e,"class",O=fw(n[1])+" svelte-w9y5n9")},m(z,Q){Or(z,e,Q),V.m(e,null),Rn(e,c),Rn(e,s),Rn(s,d),Rn(d,p),Rn(p,_),Rn(d,x),q&&q.m(d,null),Rn(s,S),Rn(s,P),Rn(P,E),U||(j=[qs(e,"mouseenter",n[13]),qs(e,"focus",n[15]),qs(e,"click",n[16])],U=!0)},p(z,[Q]){N===(N=G(z,Q))&&V?V.p(z,Q):(V.d(1),V=N(z),V&&(V.c(),V.m(e,c))),Q&257&&g!==(g=(z[8]?z[0].place_name:z[0].place_name.replace(/,.*/,""))+"")&&Ay(_,g),Q&293&&(b=z[2]==="always"||z[2]!=="never"&&!z[0].address&&!z[0].id.startsWith("road.")&&!z[0].id.startsWith("address.")&&!z[0].id.startsWith("postal_code.")&&(!z[0].id.startsWith("poi.")||!z[5])&&!z[8]),b?q?q.p(z,Q):(q=xI(z),q.c(),q.m(d,null)):q&&(q.d(1),q=null),Q&257&&L!==(L=(z[8]?"":z[0].place_name.replace(/[^,]*,?\s*/,""))+"")&&Ay(E,L),Q&2&&C!==(C=z[1]==="selected")&&jt(e,"aria-selected",C),Q&2&&D!==(D=z[1]==="picked")&&jt(e,"aria-checked",D),Q&2&&O!==(O=fw(z[1])+" svelte-w9y5n9")&&jt(e,"class",O)},i:jr,o:jr,d(z){z&&Er(e),V.d(),q&&q.d(),U=!1,Dh(j)}}}const VF=typeof devicePixelRatio>"u"?1:devicePixelRatio>1.25,qM=VF?"@2x":"",Cl=VF?2:1;let su,Rb;function yj(n,e,t){let i,r,o,{feature:c}=e,{style:s="default"}=e,{showPlaceType:d}=e,{missingIconsCache:p}=e,{iconsBaseUrl:g}=e;const _=zF();let x,b,S,P;function L(){Rb??(Rb=fetch(`${g}sprite${qM}.json`).then(N=>N.json()).then(N=>{su=N}).catch(()=>{su=null}))}function E(){b&&p.add(b),C()}function C(){su!==void 0?D():(L(),Rb?.then(D))}function D(){do{if(P--,t(4,x=i?.[P]),t(6,S=x?su?.icons[x]:void 0),S)break;t(5,b=x?g+x.replace(/ /g,"_")+".svg":void 0)}while(P>-1&&(!b||p.has(b)))}function O(N){JU.call(this,n,N)}const U=()=>E(),j=()=>_("select",void 0),G=N=>{document.activeElement!==N.target&&_("select",void 0)};return n.$$set=N=>{"feature"in N&&t(0,c=N.feature),"style"in N&&t(1,s=N.style),"showPlaceType"in N&&t(2,d=N.showPlaceType),"missingIconsCache"in N&&t(11,p=N.missingIconsCache),"iconsBaseUrl"in N&&t(3,g=N.iconsBaseUrl)},n.$$.update=()=>{var N,V,q,z,Q;n.$$.dirty&1&&t(12,i=(N=c.properties)==null?void 0:N.categories),n.$$.dirty&1&&t(8,r=c.place_type[0]==="reverse"),n.$$.dirty&1&&t(7,o=((q=(V=c.properties)==null?void 0:V.categories)==null?void 0:q.join(", "))??((Q=(z=c.properties)==null?void 0:z.place_type_name)==null?void 0:Q[0])??c.place_type[0]),n.$$.dirty&4096&&(P=i?.length??0,C())},[c,s,d,g,x,b,S,o,r,_,E,p,i,O,U,j,G]}class bj extends Kd{constructor(e){super(),Yd(this,e,yj,vj,Xd,{feature:0,style:1,showPlaceType:2,missingIconsCache:11,iconsBaseUrl:3})}}function xj(n){let e;return{c(){e=hr("div"),e.innerHTML='<svg viewBox="0 0 18 18" width="24" height="24" class="loading-icon svelte-1ocfouu"><path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"></path><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"></path></svg>',jt(e,"class","svelte-1ocfouu")},m(t,i){Or(t,e,i)},p:jr,i:jr,o:jr,d(t){t&&Er(e)}}}class wj extends Kd{constructor(e){super(),Yd(this,e,null,xj,Xd,{})}}function Sj(n){let e,t,i;return{c(){e=Tc("svg"),t=Tc("path"),jt(t,"stroke-width","4"),jt(t,"d","M 5,33.103579 C 5,17.607779 18.457,5 35,5 C 51.543,5 65,17.607779 65,33.103579 C 65,56.388679 40.4668,76.048179 36.6112,79.137779 C 36.3714,79.329879 36.2116,79.457979 36.1427,79.518879 C 35.8203,79.800879 35.4102,79.942779 35,79.942779 C 34.5899,79.942779 34.1797,79.800879 33.8575,79.518879 C 33.7886,79.457979 33.6289,79.330079 33.3893,79.138079 C 29.5346,76.049279 5,56.389379 5,33.103579 Z M 35.0001,49.386379 C 43.1917,49.386379 49.8323,42.646079 49.8323,34.331379 C 49.8323,26.016779 43.1917,19.276479 35.0001,19.276479 C 26.8085,19.276479 20.1679,26.016779 20.1679,34.331379 C 20.1679,42.646079 26.8085,49.386379 35.0001,49.386379 Z"),jt(t,"class","svelte-gzo3ar"),jt(e,"width",i=n[0]==="list"?20:void 0),jt(e,"viewBox","0 0 70 85"),jt(e,"fill","none"),jt(e,"class","svelte-gzo3ar"),uu(e,"in-map",n[0]!=="list"),uu(e,"list-icon",n[0]==="list")},m(r,o){Or(r,e,o),Rn(e,t)},p(r,[o]){o&1&&i!==(i=r[0]==="list"?20:void 0)&&jt(e,"width",i),o&1&&uu(e,"in-map",r[0]!=="list"),o&1&&uu(e,"list-icon",r[0]==="list")},i:jr,o:jr,d(r){r&&Er(e)}}}function Tj(n,e,t){let{displayIn:i}=e;return n.$$set=r=>{"displayIn"in r&&t(0,i=r.displayIn)},[i]}class Mj extends Kd{constructor(e){super(),Yd(this,e,Tj,Sj,Xd,{displayIn:0})}}function Cj(n){let e,t;return{c(){e=Tc("svg"),t=Tc("path"),jt(t,"d","M30.003-26.765C13.46-26.765 0-14.158 0 1.337c0 23.286 24.535 42.952 28.39 46.04.24.192.402.316.471.376.323.282.732.424 1.142.424.41 0 .82-.142 1.142-.424.068-.06.231-.183.471-.376 3.856-3.09 28.39-22.754 28.39-46.04 0-15.495-13.46-28.102-30.003-28.102Zm1.757 12.469c4.38 0 7.858 1.052 10.431 3.158 2.595 2.105 3.89 4.913 3.89 8.422 0 2.34-.53 4.362-1.593 6.063-1.063 1.702-3.086 3.616-6.063 5.742-2.042 1.51-3.337 2.659-3.89 3.446-.532.787-.8 1.82-.8 3.096v1.914h-8.449V15.18c0-2.041.434-3.815 1.306-5.325.872-1.51 2.467-3.118 4.785-4.82 2.233-1.594 3.7-2.89 4.402-3.889a5.582 5.582 0 0 0 1.087-3.35c0-1.382-.51-2.435-1.531-3.158-1.02-.723-2.45-1.087-4.28-1.087-3.19 0-6.826 1.047-10.91 3.131l-3.472-6.986c4.742-2.659 9.77-3.992 15.087-3.992Zm-1.88 37.324c1.765 0 3.124.472 4.08 1.408.98.936 1.47 2.276 1.47 4.02 0 1.68-.49 3.007-1.47 3.985-.977.957-2.336 1.435-4.08 1.435-1.787 0-3.171-.465-4.15-1.4-.978-.958-1.47-2.298-1.47-4.02 0-1.787.48-3.14 1.436-4.054.957-.915 2.355-1.374 4.184-1.374Z"),jt(e,"viewBox","0 0 60.006 21.412"),jt(e,"width","14"),jt(e,"height","20"),jt(e,"class","svelte-en2qvf")},m(i,r){Or(i,e,r),Rn(e,t)},p:jr,i:jr,o:jr,d(i){i&&Er(e)}}}class Ej extends Kd{constructor(e){super(),Yd(this,e,null,Cj,Xd,{})}}function Aj(n){let e,t,i;return{c(){e=Tc("svg"),t=Tc("circle"),i=Tc("path"),jt(t,"cx","4.789"),jt(t,"cy","4.787"),jt(t,"r","3.85"),jt(t,"class","svelte-1aq105l"),jt(i,"d","M12.063 12.063 7.635 7.635"),jt(i,"class","svelte-1aq105l"),jt(e,"xmlns","http://www.w3.org/2000/svg"),jt(e,"width","13"),jt(e,"height","13"),jt(e,"viewBox","0 0 13 13"),jt(e,"class","svelte-1aq105l")},m(r,o){Or(r,e,o),Rn(e,t),Rn(e,i)},p:jr,i:jr,o:jr,d(r){r&&Er(e)}}}class Pj extends Kd{constructor(e){super(),Yd(this,e,null,Aj,Xd,{})}}function Ij(n,e,t){const i=e[1],r=e[0],o=i-r;return n===i&&t?n:((n-r)%o+o)%o+r}function pw(n){const e=[...n];return e[2]<e[0]&&(Math.abs((e[0]+e[2]+360)/2)>Math.abs((e[0]-360+e[2])/2)?e[0]-=360:e[2]+=360),e}let xv;async function Rj(n,e,t){const i=n?.getCenterAndZoom();for(const r of e??[])if(!(i&&(r.minZoom!=null&&r.minZoom>i[0]||r.maxZoom!=null&&r.maxZoom<i[0]))){if(r.type==="fixed")return r.coordinates.join(",");e:if(r.type==="client-geolocation"){if(xv&&r.cachedLocationExpiry&&xv.time+r.cachedLocationExpiry>Date.now()){if(!xv.coords)break e;return xv.coords}let o;try{return o=await new Promise((c,s)=>{t.signal.addEventListener("abort",()=>{s(Error("aborted"))}),navigator.geolocation.getCurrentPosition(d=>{c([d.coords.longitude,d.coords.latitude].map(p=>p.toFixed(6)).join(","))},d=>{s(d)},r)}),o}catch{}finally{r.cachedLocationExpiry&&(xv={time:Date.now(),coords:o})}if(t.signal.aborted)return}if(r.type==="server-geolocation")return"ip";if(i&&r.type==="map-center")return i[1].toFixed(6)+","+i[2].toFixed(6)}}const Lj=/^(NORTH|SOUTH|[NS])?\s*([+-]?[0-8]?[0-9])\s*([â¢ÂºÂ°\.:]|D(?:EG)?(?:REES)?)?\s*,?([6-9][0-9])\s*(['â²Â´â\.:]|M(?:IN)?(?:UTES)?)?\s*(NORTH|SOUTH|[NS])?(?:\s*[,/;]\s*|\s*)(EAST|WEST|[EW])?\s*([+-]?[0-1]?[0-9]?[0-9])\s*([â¢ÂºÂ°\.:]|D(?:EG)?(?:REES)?)?\s*,?([6-9][0-9])\s*(['â²Â´â\.:]|M(?:IN)?(?:UTES)?)?\s*(EAST|WEST|[EW])?$/i,wI=/^([+-]?[0-8]?[0-9])\s+([0-5]?[0-9]\.\d{3,})[\s,]{1,}([+-]?[0-1]?[0-9]?[0-9])\s+([0-5]?[0-9]\.\d{3,})$/,SI=/^(NORTH|SOUTH|[NS])?[\s]*([+-]?[0-8]?[0-9](?:[\.,]\d{3,}))[\s]*([â¢ÂºÂ°]?)[\s]*(NORTH|SOUTH|[NS])?[\s]*[,/;]?[\s]*(EAST|WEST|[EW])?[\s]*([+-]?[0-1]?[0-9]?[0-9](?:[\.,]\d{3,}))[\s]*([â¢ÂºÂ°]?)[\s]*(EAST|WEST|[EW])?$/i,TI=/^(NORTH|SOUTH|[NS])?\s*([+-]?[0-8]?[0-9])\s*(\.)\s*([0-5]?[0-9])\s*(\.)\s*((?:[0-5]?[0-9])(?:[\.,]\d{1,3})?)?\s*(NORTH|SOUTH|[NS])?(?:\s*[,/;]\s*|\s*)(EAST|WEST|[EW])?\s*([+-]?[0-1]?[0-9]?[0-9])\s*(\.)\s*([0-5]?[0-9])\s*(\.)\s*((?:[0-5]?[0-9])(?:[\.,]\d{1,3})?)?\s*(EAST|WEST|[EW])?$/i,MI=/^(NORTH|SOUTH|[NS])?\s*([+-]?[0-8]?[0-9])\s*(D(?:EG)?(?:REES)?)\s*([0-5]?[0-9])\s*(M(?:IN)?(?:UTES)?)\s*((?:[0-5]?[0-9])(?:[\.,]\d{1,3})?)?\s*(S(?:EC)?(?:ONDS)?)?\s*(NORTH|SOUTH|[NS])?(?:\s*[,/;]\s*|\s*)(EAST|WEST|[EW])?\s*([+-]?[0-1]?[0-9]?[0-9])\s*(D(?:EG)?(?:REES)?)\s*([0-5]?[0-9])\s*(M(?:IN)?(?:UTES)?)\s*((?:[0-5]?[0-9])(?:[\.,]\d{1,3})?)?\s*(S(?:EC)?(?:ONDS)?)\s*(EAST|WEST|[EW])?$/i,CI=/^(NORTH|SOUTH|[NS])?\s*([+-]?[0-8]?[0-9])\s*([â¢ÂºÂ°\.:]|D(?:EG)?(?:REES)?)?\s*,?([0-5]?[0-9](?:[\.,]\d{1,})?)?\s*(['â²Â´â\.:]|M(?:IN)?(?:UTES)?)?\s*,?((?:[0-5]?[0-9])(?:[\.,]\d{1,3})?)?\s*(''|â²â²|ââ|Â´Â´|["â³â\.])?\s*(NORTH|SOUTH|[NS])?(?:\s*[,/;]\s*|\s*)(EAST|WEST|[EW])?\s*([+-]?[0-1]?[0-9]?[0-9])\s*([â¢ÂºÂ°\.:]|D(?:EG)?(?:REES)?)?\s*,?([0-5]?[0-9](?:[\.,]\d{1,})?)?\s*(['â²Â´â\.:]|M(?:IN)?(?:UTES)?)?\s*,?((?:[0-5]?[0-9])(?:[\.,]\d{1,3})?)?\s*(''|â²â²|Â´Â´|ââ|["â³â\.])?\s*(EAST|WEST|[EW])?$/i;function kj(n){if(!["DMS","DM","DD"].includes(n))throw new Error("invalid format specified");if(this.decimalCoordinates&&this.decimalCoordinates.trim()){const e=this.decimalCoordinates.split(",").map(b=>Number(b.trim())),t=Number(e[0]),i=Number(e[1]),r=Math.abs(t),o=Math.abs(i),c=t>0?"N":"S",s=i>0?"E":"W";let d;n=="DD"&&(d=`${r}Â° ${c}, ${o}Â° ${s}`);const p=Math.floor(r),g=Math.floor(o),_=(r-p)*60,x=(o-g)*60;if(n=="DM"){let b=EI(_,3).toFixed(3).padStart(6,"0"),S=EI(x,3).toFixed(3).padStart(6,"0");b.endsWith(".000")&&S.endsWith(".000")&&(b=b.replace(/\.000$/,""),S=S.replace(/\.000$/,"")),d=`${p}Â° ${b}' ${c}, ${g}Â° ${S}' ${s}`}if(n=="DMS"){const b=Math.floor(_),S=Math.floor(x);let P=((_-b)*60).toFixed(1).padStart(4,"0"),L=((x-S)*60).toFixed(1).padStart(4,"0");const E=b.toString().padStart(2,"0"),C=S.toString().padStart(2,"0");P.endsWith(".0")&&L.endsWith(".0")&&(P=P.replace(/\.0$/,""),L=L.replace(/\.0$/,"")),d=`${p}Â° ${E}' ${P}" ${c}, ${g}Â° ${C}' ${L}" ${s}`}return d}else throw new Error("no decimal coordinates to convert")}function EI(n,e){const t=Math.pow(10,e);return Math.round((n+Number.EPSILON)*t)/t}function mC(n,e){e||(e=5),n=n.replace(/\s+/g," ").trim();let t=null,i=null,r="",o="",c=null,s=[],d=!1;if(Lj.test(n))throw new Error("invalid coordinate value");if(wI.test(n))if(s=wI.exec(n),d=wv(s),d)t=Math.abs(s[1])+s[2]/60,Number(s[1])<0&&(t*=-1),i=Math.abs(s[3])+s[4]/60,Number(s[3])<0&&(i*=-1),c="DM";else throw new Error("invalid coordinate format");else if(SI.test(n))if(s=SI.exec(n),d=wv(s),d){if(t=s[2],i=s[6],t.includes(",")&&(t=t.replace(",",".")),i.includes(",")&&(i=i.replace(",",".")),c="DD",Number(Math.round(t))==Number(t))throw new Error("integer only coordinate provided");if(Number(Math.round(i))==Number(i))throw new Error("integer only coordinate provided");s[1]?(r=s[1],o=s[5]):s[4]&&(r=s[4],o=s[8])}else throw new Error("invalid decimal coordinate format");else if(TI.test(n))if(s=TI.exec(n),d=wv(s),d)t=Math.abs(parseInt(s[2])),s[4]&&(t+=s[4]/60,c="DM"),s[6]&&(t+=s[6].replace(",",".")/3600,c="DMS"),parseInt(s[2])<0&&(t=-1*t),i=Math.abs(parseInt(s[9])),s[11]&&(i+=s[11]/60),s[13]&&(i+=s[13].replace(",",".")/3600),parseInt(s[9])<0&&(i=-1*i),s[1]?(r=s[1],o=s[8]):s[7]&&(r=s[7],o=s[14]);else throw new Error("invalid DMS coordinates format");else if(MI.test(n))if(s=MI.exec(n),d=wv(s),d)t=Math.abs(parseInt(s[2])),s[4]&&(t+=s[4]/60,c="DM"),s[6]&&(t+=s[6]/3600,c="DMS"),parseInt(s[2])<0&&(t=-1*t),i=Math.abs(parseInt(s[10])),s[12]&&(i+=s[12]/60),s[14]&&(i+=s[14]/3600),parseInt(s[10])<0&&(i=-1*i),s[1]?(r=s[1],o=s[9]):s[8]&&(r=s[8],o=s[16]);else throw new Error("invalid DMS coordinates format");else if(CI.test(n)){if(s=CI.exec(n),d=wv(s),s.filter(p=>p).length<=5)throw new Error("invalid coordinates format");if(d)t=Math.abs(parseInt(s[2])),s[4]&&(t+=s[4].replace(",",".")/60,c="DM"),s[6]&&(t+=s[6].replace(",",".")/3600,c="DMS"),parseInt(s[2])<0&&(t=-1*t),i=Math.abs(parseInt(s[10])),s[12]&&(i+=s[12].replace(",",".")/60),s[14]&&(i+=s[14].replace(",",".")/3600),parseInt(s[10])<0&&(i=-1*i),s[1]?(r=s[1],o=s[9]):s[8]&&(r=s[8],o=s[16]);else throw new Error("invalid coordinates format")}if(d){if(Math.abs(i)>=180)throw new Error("invalid longitude value");if(Math.abs(t)>=90)throw new Error("invalid latitude value");if(r&&!o||!r&&o)throw new Error("invalid coordinates value");if(r&&r==o)throw new Error("invalid coordinates format");t.toString().includes(",")&&(t=t.replace(",",".")),i.toString().includes(",")&&(i=i.replace(",","."));let p=/S|SOUTH/i;p.test(r)&&t>0&&(t=-1*t),p=/W|WEST/i,p.test(o)&&i>0&&(i=-1*i);const g=s[0].trim();let _,x;const b=/[,/;\u0020]/g,S=g.match(b);if(S==null){const E=Math.floor(n.length/2);_=g.substring(0,E).trim(),x=g.substring(E).trim()}else{let E;S.length%2==1?E=Math.floor(S.length/2):E=S.length/2-1;let C=0;if(E==0)C=g.indexOf(S[0]),_=g.substring(0,C).trim(),x=g.substring(C+1).trim();else{let D=0,O=0;for(;D<=E;)C=g.indexOf(S[D],O),O=C+1,D++;_=g.substring(0,C).trim(),x=g.substring(C+1).trim()}}const P=_.split(".");if(P.length==2&&P[1]==0&&P[1].length!=2)throw new Error("invalid coordinates format");const L=x.split(".");if(L.length==2&&L[1]==0&&L[1].length!=2)throw new Error("invalid coordinates format");if(/^\d+$/.test(_)||/^\d+$/.test(x))throw new Error("degree only coordinate/s provided");return t=Number(Number(t).toFixed(e)),i=Number(Number(i).toFixed(e)),Object.freeze({verbatimCoordinates:g,verbatimLatitude:_,verbatimLongitude:x,decimalLatitude:t,decimalLongitude:i,decimalCoordinates:`${t},${i}`,originalFormat:c,closeEnough:Dj,toCoordinateFormat:kj})}else throw new Error("coordinates pattern match failed")}function wv(n){if(!isNaN(n[0]))return!1;const e=[...n];if(e.shift(),e.length%2>0)return!1;const t=/^[-+]?\d+([\.,]\d+)?$/,i=/[eastsouthnorthwest]+/i,r=e.length/2;for(let o=0;o<r;o++){const c=e[o],s=e[o+r],d=t.test(c)&&t.test(s),p=i.test(c)&&i.test(s),g=c==s;if(!(c==null&&s==null)){if(c==null||s==null)return!1;if(d||p||g)continue;return!1}}return!0}function AI(n,e){const t=Math.abs(n-e);return Number(t.toFixed(6))<=1e-5}function Dj(n){if(!n)throw new Error("coords must be provided");if(n.includes(",")){const e=n.split(",");if(Number(e[0])==NaN||Number(e[1])==NaN)throw new Error("coords are not valid decimals");return AI(this.decimalLatitude,Number(e[0]))&&AI(this.decimalLongitude,e[1])}else throw new Error("coords being tested must be separated by a comma")}const Fj=Object.freeze({DMS:"DMS",DM:"DM",DD:"DD"});mC.to=Fj;const Oj=[{verbatimCoordinates:"40.123, -74.123",verbatimLatitude:"40.123",verbatimLongitude:"-74.123"},{verbatimCoordinates:"40.123Â° N 74.123Â° W",verbatimLatitude:"40.123Â° N",verbatimLongitude:"74.123Â° W"},{verbatimCoordinates:"40.123Â° N 74.123Â° W",verbatimLatitude:"40.123Â° N",verbatimLongitude:"74.123Â° W"},{verbatimCoordinates:'40Â° 7Â´ 22.8" N 74Â° 7Â´ 22.8" W',verbatimLatitude:'40Â° 7Â´ 22.8" N',verbatimLongitude:'74Â° 7Â´ 22.8" W'},{verbatimCoordinates:"40Â° 7.38â , -74Â° 7.38â",verbatimLatitude:"40Â° 7.38â",verbatimLongitude:"-74Â° 7.38â"},{verbatimCoordinates:"N40Â°7â22.8ââ, W74Â°7â22.8ââ",verbatimLatitude:"N40Â°7â22.8ââ",verbatimLongitude:"W74Â°7â22.8ââ"},{verbatimCoordinates:'40Â°7â22.8"N, 74Â°7â22.8"W',verbatimLatitude:'40Â°7â22.8"N',verbatimLongitude:'74Â°7â22.8"W'},{verbatimCoordinates:`40Â°7'22.8"N, 74Â°7'22.8"W`,verbatimLatitude:`40Â°7'22.8"N`,verbatimLongitude:`74Â°7'22.8"W`},{verbatimCoordinates:"40 7 22.8, -74 7 22.8",verbatimLatitude:"40 7 22.8",verbatimLongitude:"-74 7 22.8"},{verbatimCoordinates:"40.123 -74.123",verbatimLatitude:"40.123",verbatimLongitude:"-74.123"},{verbatimCoordinates:"40.123Â°,-74.123Â°",verbatimLatitude:"40.123Â°",verbatimLongitude:"-74.123Â°"},{verbatimCoordinates:"40.123N74.123W",verbatimLatitude:"40.123N",verbatimLongitude:"74.123W"},{verbatimCoordinates:"4007.38N7407.38W",verbatimLatitude:"4007.38N",verbatimLongitude:"7407.38W"},{verbatimCoordinates:'40Â°7â22.8"N, 74Â°7â22.8"W',verbatimLatitude:'40Â°7â22.8"N',verbatimLongitude:'74Â°7â22.8"W'},{verbatimCoordinates:"400722.8N740722.8W",verbatimLatitude:"400722.8N",verbatimLongitude:"740722.8W"},{verbatimCoordinates:"N 40 7.38 W 74 7.38",verbatimLatitude:"N 40 7.38",verbatimLongitude:"W 74 7.38"},{verbatimCoordinates:"40:7:22.8N 74:7:22.8W",verbatimLatitude:"40:7:22.8N",verbatimLongitude:"74:7:22.8W"},{verbatimCoordinates:"40:7:23N,74:7:23W",verbatimLatitude:"40:7:23N",verbatimLongitude:"74:7:23W",decimalLatitude:40.1230555555,decimalLongitude:-74.1230555555},{verbatimCoordinates:'40Â°7â23"N 74Â°7â23"W',verbatimLatitude:'40Â°7â23"N',verbatimLongitude:'74Â°7â23"W',decimalLatitude:40.1230555555,decimalLongitude:-74.12305555555555},{verbatimCoordinates:'40Â°7â23"S 74Â°7â23"E',verbatimLatitude:'40Â°7â23"S',verbatimLongitude:'74Â°7â23"E',decimalLatitude:-40.1230555555,decimalLongitude:74.12305555555555},{verbatimCoordinates:'40Â°7â23" -74Â°7â23"',verbatimLatitude:'40Â°7â23"',verbatimLongitude:'-74Â°7â23"',decimalLatitude:40.1230555555,decimalLongitude:-74.123055555},{verbatimCoordinates:'40d 7â 23" N 74d 7â 23" W',verbatimLatitude:'40d 7â 23" N',verbatimLongitude:'74d 7â 23" W',decimalLatitude:40.1230555555,decimalLongitude:-74.123055555},{verbatimCoordinates:"40.123N 74.123W",verbatimLatitude:"40.123N",verbatimLongitude:"74.123W"},{verbatimCoordinates:"40Â° 7.38, -74Â° 7.38",verbatimLatitude:"40Â° 7.38",verbatimLongitude:"-74Â° 7.38"},{verbatimCoordinates:"40Â° 7.38, -74Â° 7.38",verbatimLatitude:"40Â° 7.38",verbatimLongitude:"-74Â° 7.38"},{verbatimCoordinates:"40 7 22.8; -74 7 22.8",verbatimLatitude:"40 7 22.8",verbatimLongitude:"-74 7 22.8"}],zj={decimalLatitude:40.123,decimalLongitude:-74.123},Bj=[{verbatimCoordinates:`50Â°4'17.698"south, 14Â°24'2.826"east`,verbatimLatitude:`50Â°4'17.698"south`,verbatimLongitude:`14Â°24'2.826"east`,decimalLatitude:-50.07158277777778,decimalLongitude:14.400785},{verbatimCoordinates:"50d4m17.698S 14d24m2.826E",verbatimLatitude:"50d4m17.698S",verbatimLongitude:"14d24m2.826E",decimalLatitude:-50.07158277777778,decimalLongitude:14.400785},{verbatimCoordinates:"40:26:46N,79:56:55W",verbatimLatitude:"40:26:46N",verbatimLongitude:"79:56:55W",decimalLatitude:40.44611111111111,decimalLongitude:-79.9486111111111},{verbatimCoordinates:"40:26:46.302N 79:56:55.903W",verbatimLatitude:"40:26:46.302N",verbatimLongitude:"79:56:55.903W",decimalLatitude:40.446195,decimalLongitude:-79.94886194444445},{verbatimCoordinates:"40Â°26â²47â³N 79Â°58â²36â³W",verbatimLatitude:"40Â°26â²47â³N",verbatimLongitude:"79Â°58â²36â³W",decimalLatitude:40.44638888888889,decimalLongitude:-79.97666666666667},{verbatimCoordinates:"40d 26â² 47â³ N 79d 58â² 36â³ W",verbatimLatitude:"40d 26â² 47â³ N",verbatimLongitude:"79d 58â² 36â³ W",decimalLatitude:40.44638888888889,decimalLongitude:-79.97666666666667},{verbatimCoordinates:"40.446195N 79.948862W",verbatimLatitude:"40.446195N",verbatimLongitude:"79.948862W",decimalLatitude:40.446195,decimalLongitude:-79.948862},{verbatimCoordinates:"40,446195Â° 79,948862Â°",verbatimLatitude:"40,446195Â°",verbatimLongitude:"79,948862Â°",decimalLatitude:40.446195,decimalLongitude:79.948862},{verbatimCoordinates:"40Â° 26.7717, -79Â° 56.93172",verbatimLatitude:"40Â° 26.7717",verbatimLongitude:"-79Â° 56.93172",decimalLatitude:40.446195,decimalLongitude:-79.948862},{verbatimCoordinates:"40.446195, -79.948862",verbatimLatitude:"40.446195",verbatimLongitude:"-79.948862",decimalLatitude:40.446195,decimalLongitude:-79.948862},{verbatimCoordinates:"40.123256; -74.123256",verbatimLatitude:"40.123256",verbatimLongitude:"-74.123256",decimalLatitude:40.123256,decimalLongitude:-74.123256},{verbatimCoordinates:"18Â°24S 22Â°45E",verbatimLatitude:"18Â°24S",verbatimLongitude:"22Â°45E",decimalLatitude:-18.4,decimalLongitude:22.75}],Nj=[{verbatimCoordinates:"10.432342S 10.6345345E",verbatimLatitude:"10.432342S",verbatimLongitude:"10.6345345E",decimalLatitude:-10.432342,decimalLongitude:10.6345345},{verbatimCoordinates:"10.00S 10.00E",verbatimLatitude:"10.00S",verbatimLongitude:"10.00E",decimalLatitude:-10,decimalLongitude:10},{verbatimCoordinates:"00.00S 01.00E",verbatimLatitude:"00.00S",verbatimLongitude:"01.00E",decimalLatitude:0,decimalLongitude:1},{verbatimCoordinates:"18.24S 22.45E",verbatimLatitude:"18.24S",verbatimLongitude:"22.45E",decimalLatitude:-18.4,decimalLongitude:22.75},{verbatimCoordinates:"27deg 15min 45.2sec S 18deg 32min 53.7sec E",verbatimLatitude:"27deg 15min 45.2sec S",verbatimLongitude:"18deg 32min 53.7sec E",decimalLatitude:-27.262555555555554,decimalLongitude:18.54825},{verbatimCoordinates:"-23.3245Â° S / 28.2344Â° E",verbatimLatitude:"-23.3245Â° S",verbatimLongitude:"28.2344Â° E",decimalLatitude:-23.3245,decimalLongitude:28.2344},{verbatimCoordinates:"40Â° 26.7717 -79Â° 56.93172",verbatimLatitude:"40Â° 26.7717",verbatimLongitude:"-79Â° 56.93172",decimalLatitude:40.446195,decimalLongitude:-79.948862},{verbatimCoordinates:"27.15.45S 18.32.53E",verbatimLatitude:"27.15.45S",verbatimLongitude:"18.32.53E",decimalLatitude:-27.2625,decimalLongitude:18.548055},{verbatimCoordinates:"-27.15.45 18.32.53",verbatimLatitude:"-27.15.45",verbatimLongitude:"18.32.53",decimalLatitude:-27.2625,decimalLongitude:18.548055},{verbatimCoordinates:"27.15.45.2S 18.32.53.4E",verbatimLatitude:"27.15.45.2S",verbatimLongitude:"18.32.53.4E",decimalLatitude:-27.262556,decimalLongitude:18.548167},{verbatimCoordinates:"27.15.45,2S 18.32.53,4E",verbatimLatitude:"27.15.45,2S",verbatimLongitude:"18.32.53,4E",decimalLatitude:-27.262556,decimalLongitude:18.548167},{verbatimCoordinates:"S23.43563 Â°  E22.45634 Â°",verbatimLatitude:"S23.43563 Â°",verbatimLongitude:"E22.45634 Â°",decimalLatitude:-23.43563,decimalLongitude:22.45634},{verbatimCoordinates:"27,71372Â° S 23,07771Â° E",verbatimLatitude:"27,71372Â° S",verbatimLongitude:"23,07771Â° E",decimalLatitude:-27.71372,decimalLongitude:23.07771},{verbatimCoordinates:"27.45.34 S 23.23.23 E",verbatimLatitude:"27.45.34 S",verbatimLongitude:"23.23.23 E",decimalLatitude:-27.759444,decimalLongitude:23.38972222},{verbatimCoordinates:"S 27.45.34 E 23.23.23",verbatimLatitude:"S 27.45.34",verbatimLongitude:"E 23.23.23",decimalLatitude:-27.759444,decimalLongitude:23.38972222},{verbatimCoordinates:"53 16.3863,4 52.8171",verbatimLatitude:"53 16.3863",verbatimLongitude:"4 52.8171",decimalLatitude:53.273105,decimalLongitude:4.88029},{verbatimCoordinates:"50 8.2914,-5 2.4447",verbatimLatitude:"50 8.2914",verbatimLongitude:"-5 2.4447",decimalLatitude:50.13819,decimalLongitude:-5.040745},{verbatimCoordinates:"N 48Â° 30,6410', E 18Â° 57,4583'",verbatimLatitude:"N 48Â° 30,6410'",verbatimLongitude:"E 18Â° 57,4583'",decimalLatitude:48.51068,decimalLongitude:18.95764},{verbatimCoordinates:"1.23456, 18.33453",verbatimLatitude:"1.23456",verbatimLongitude:"18.33453",decimalLatitude:1.23456,decimalLongitude:18.33453}];function $j(){const n=[];return Oj.forEach(e=>{e.decimalLatitude?n.push(e):n.push({...e,...zj})}),[...n,...Bj,...Nj]}const Vj=$j();mC.formats=Vj.map(n=>n.verbatimCoordinates);const Uj=mC;function PI(n,e,t){const i=n.slice();return i[97]=e[t],i[99]=t,i}function II(n){let e,t,i,r,o;return t=new NF({}),{c(){e=hr("button"),Bd(t.$$.fragment),jt(e,"type","button"),jt(e,"title",n[3]),jt(e,"class","svelte-bz0zu3")},m(c,s){Or(c,e,s),Mh(t,e,null),i=!0,r||(o=qs(e,"click",n[78]),r=!0)},p(c,s){(!i||s[0]&8)&&jt(e,"title",c[3])},i(c){i||(Qr(t.$$.fragment,c),i=!0)},o(c){Fs(t.$$.fragment,c),i=!1},d(c){c&&Er(e),Ch(t),r=!1,o()}}}function RI(n){let e,t;return e=new wj({}),{c(){Bd(e.$$.fragment)},m(i,r){Mh(e,i,r),t=!0},i(i){t||(Qr(e.$$.fragment,i),t=!0)},o(i){Fs(e.$$.fragment,i),t=!1},d(i){Ch(e,i)}}}function LI(n){let e,t,i,r,o;return t=new Ej({}),{c(){e=hr("button"),Bd(t.$$.fragment),jt(e,"type","button"),jt(e,"title",n[10]),jt(e,"class","svelte-bz0zu3"),uu(e,"active",n[0])},m(c,s){Or(c,e,s),Mh(t,e,null),i=!0,r||(o=qs(e,"click",n[79]),r=!0)},p(c,s){(!i||s[0]&1024)&&jt(e,"title",c[10]),(!i||s[0]&1)&&uu(e,"active",c[0])},i(c){i||(Qr(t.$$.fragment,c),i=!0)},o(c){Fs(t.$$.fragment,c),i=!1},d(c){c&&Er(e),Ch(t),r=!1,o()}}}function jj(n){let e,t=[],i=new Map,r,o,c,s=bI(n[13]);const d=p=>p[97].id+(p[97].address?","+p[97].address:"");for(let p=0;p<s.length;p+=1){let g=PI(n,s,p),_=d(g);i.set(_,t[p]=kI(_,g))}return{c(){e=hr("ul");for(let p=0;p<t.length;p+=1)t[p].c();jt(e,"class","options svelte-bz0zu3"),jt(e,"role","listbox")},m(p,g){Or(p,e,g);for(let _=0;_<t.length;_+=1)t[_]&&t[_].m(e,null);r=!0,o||(c=[qs(e,"mouseleave",n[27]),qs(e,"blur",n[83]),qs(e,"keydown",n[23])],o=!0)},p(p,g){g[0]&102823936&&(s=bI(p[13]),jv(),t=rj(t,g,d,1,p,s,i,e,nj,kI,null,PI),Gv())},i(p){if(!r){for(let g=0;g<s.length;g+=1)Qr(t[g]);r=!0}},o(p){for(let g=0;g<t.length;g+=1)Fs(t[g]);r=!1},d(p){p&&Er(e);for(let g=0;g<t.length;g+=1)t[g].d();o=!1,Dh(c)}}}function Gj(n){let e,t,i,r,o,c;return t=new $F({}),{c(){e=hr("div"),Bd(t.$$.fragment),i=Ja(),r=hr("div"),o=zd(n[8]),jt(r,"class","svelte-bz0zu3"),jt(e,"class","no-results svelte-bz0zu3")},m(s,d){Or(s,e,d),Mh(t,e,null),Rn(e,i),Rn(e,r),Rn(r,o),c=!0},p(s,d){(!c||d[0]&256)&&Ay(o,s[8])},i(s){c||(Qr(t.$$.fragment,s),c=!0)},o(s){Fs(t.$$.fragment,s),c=!1},d(s){s&&Er(e),Ch(t)}}}function qj(n){let e="",t;return{c(){t=zd(e)},m(i,r){Or(i,t,r)},p:jr,i:jr,o:jr,d(i){i&&Er(t)}}}function Wj(n){let e,t,i,r,o,c,s,d,p,g,_;return t=new $F({}),d=new NF({}),{c(){e=hr("div"),Bd(t.$$.fragment),i=Ja(),r=hr("div"),o=zd(n[7]),c=Ja(),s=hr("button"),Bd(d.$$.fragment),jt(r,"class","svelte-bz0zu3"),jt(s,"class","svelte-bz0zu3"),jt(e,"class","error svelte-bz0zu3")},m(x,b){Or(x,e,b),Mh(t,e,null),Rn(e,i),Rn(e,r),Rn(r,o),Rn(e,c),Rn(e,s),Mh(d,s,null),p=!0,g||(_=qs(s,"click",n[80]),g=!0)},p(x,b){(!p||b[0]&128)&&Ay(o,x[7])},i(x){p||(Qr(t.$$.fragment,x),Qr(d.$$.fragment,x),p=!0)},o(x){Fs(t.$$.fragment,x),Fs(d.$$.fragment,x),p=!1},d(x){x&&Er(e),Ch(t),Ch(d),g=!1,_()}}}function kI(n,e){var t;let i,r,o;function c(){return e[81](e[99])}function s(){return e[82](e[97])}return r=new bj({props:{feature:e[97],showPlaceType:e[11],style:e[15]===e[99]?"selected":((t=e[14])==null?void 0:t.id)===e[97].id?"picked":"default",missingIconsCache:e[21],iconsBaseUrl:e[12]}}),r.$on("mouseenter",c),r.$on("select",s),{key:n,first:null,c(){i=HU(),Bd(r.$$.fragment),this.first=i},m(d,p){Or(d,i,p),Mh(r,d,p),o=!0},p(d,p){var g;e=d;const _={};p[0]&8192&&(_.feature=e[97]),p[0]&2048&&(_.showPlaceType=e[11]),p[0]&57344&&(_.style=e[15]===e[99]?"selected":((g=e[14])==null?void 0:g.id)===e[97].id?"picked":"default"),p[0]&4096&&(_.iconsBaseUrl=e[12]),r.$set(_)},i(d){o||(Qr(r.$$.fragment,d),o=!0)},o(d){Fs(r.$$.fragment,d),o=!1},d(d){d&&Er(i),Ch(r,d)}}}function Hj(n){let e,t,i,r,o,c,s,d,p,g,_,x,b,S,P,L,E,C,D,O=!1;o=new Pj({});let U=!n[20]&&II(n),j=n[20]&&RI(),G=n[6]==="button"&&LI(n);const N=n[70].default,V=jU(N,n,n[69],null),q=[Wj,qj,Gj,jj],z=[];function Q(X,re){var oe,de;return X[19]?0:!X[16]&&!X[4]?1:((oe=X[13])==null?void 0:oe.length)===0?2:(de=X[13])!=null&&de.length&&(X[16]||X[4])?3:-1}return~(S=Q(n))&&(P=z[S]=q[S](n)),{c(){e=Ja(),t=hr("form"),i=hr("div"),r=hr("button"),Bd(o.$$.fragment),c=Ja(),s=hr("input"),d=Ja(),p=hr("div"),U&&U.c(),g=Ja(),j&&j.c(),_=Ja(),G&&G.c(),x=Ja(),V&&V.c(),b=Ja(),P&&P.c(),jt(r,"class","search-button svelte-bz0zu3"),jt(r,"type","button"),jt(s,"placeholder",n[9]),jt(s,"aria-label",n[9]),jt(s,"class","svelte-bz0zu3"),jt(p,"class","clear-button-container svelte-bz0zu3"),uu(p,"displayable",n[1]!==""),jt(i,"class","input-group svelte-bz0zu3"),jt(t,"class",L=fw(n[2])+" svelte-bz0zu3"),uu(t,"can-collapse",n[5]&&n[1]==="")},m(X,re){Or(X,e,re),Or(X,t,re),Rn(t,i),Rn(i,r),Mh(o,r,null),Rn(i,c),Rn(i,s),n[72](s),vI(s,n[1]),Rn(i,d),Rn(i,p),U&&U.m(p,null),Rn(p,g),j&&j.m(p,null),Rn(i,_),G&&G.m(i,null),Rn(i,x),V&&V.m(i,null),Rn(t,b),~S&&z[S].m(t,null),E=!0,C||(D=[qs(r,"click",n[71]),qs(s,"input",n[73]),qs(s,"focus",n[74]),qs(s,"blur",n[75]),qs(s,"click",n[76]),qs(s,"keydown",n[23]),qs(s,"input",n[24]),qs(s,"change",n[77]),qs(t,"submit",ZU(n[22]))],C=!0)},p(X,re){(!E||re[0]&512)&&jt(s,"placeholder",X[9]),(!E||re[0]&512)&&jt(s,"aria-label",X[9]),re[0]&2&&s.value!==X[1]&&vI(s,X[1]),X[20]?U&&(jv(),Fs(U,1,1,()=>{U=null}),Gv()):U?(U.p(X,re),re[0]&1048576&&Qr(U,1)):(U=II(X),U.c(),Qr(U,1),U.m(p,g)),X[20]?j?re[0]&1048576&&Qr(j,1):(j=RI(),j.c(),Qr(j,1),j.m(p,null)):j&&(jv(),Fs(j,1,1,()=>{j=null}),Gv()),(!E||re[0]&2)&&uu(p,"displayable",X[1]!==""),X[6]==="button"?G?(G.p(X,re),re[0]&64&&Qr(G,1)):(G=LI(X),G.c(),Qr(G,1),G.m(i,x)):G&&(jv(),Fs(G,1,1,()=>{G=null}),Gv()),V&&V.p&&(!E||re[2]&128)&&qU(V,N,X,X[69],E?GU(N,X[69]):WU(X[69]),null);let oe=S;S=Q(X),S===oe?~S&&z[S].p(X,re):(P&&(jv(),Fs(z[oe],1,1,()=>{z[oe]=null}),Gv()),~S?(P=z[S],P?P.p(X,re):(P=z[S]=q[S](X),P.c()),Qr(P,1),P.m(t,null)):P=null),(!E||re[0]&4&&L!==(L=fw(X[2])+" svelte-bz0zu3"))&&jt(t,"class",L),(!E||re[0]&38)&&uu(t,"can-collapse",X[5]&&X[1]==="")},i(X){E||(Qr(O),Qr(o.$$.fragment,X),Qr(U),Qr(j),Qr(G),Qr(V,X),Qr(P),E=!0)},o(X){Fs(O),Fs(o.$$.fragment,X),Fs(U),Fs(j),Fs(G),Fs(V,X),Fs(P),E=!1},d(X){X&&(Er(e),Er(t)),Ch(o),n[72](null),U&&U.d(),j&&j.d(),G&&G.d(),V&&V.d(X),~S&&z[S].d(),C=!1,Dh(D)}}}function Zj(n,e,t){let i,r,o,{$$slots:c={},$$scope:s}=e;const d={continental_marine:4,country:4,major_landform:8,region:5,subregion:6,county:7,joint_municipality:8,joint_submunicipality:9,municipality:10,municipal_district:11,locality:12,neighbourhood:13,place:14,postal_code:14,road:16,poi:17,address:18,"poi.peak":15,"poi.shop":18,"poi.cafe":18,"poi.restaurant":18,"poi.aerodrome":13};let{class:p=void 0}=e,{apiKey:g=void 0}=e,{bbox:_=void 0}=e,{clearButtonTitle:x="clear"}=e,{clearOnBlur:b=!1}=e,{clearListOnPick:S=!1}=e,{keepListOpen:P=!1}=e,{collapsed:L=!1}=e,{country:E=void 0}=e,{debounceSearch:C=200}=e,{enableReverse:D="never"}=e,{errorMessage:O="Something went wrongâ¦"}=e,{filter:U=()=>!0}=e,{flyTo:j=!0}=e,{fuzzyMatch:G=!0}=e,{language:N=void 0}=e,{limit:V=void 0}=e;const q=41415112612;let{reverseGeocodingLimit:z=q}=e,{mapController:Q=void 0}=e,{minLength:X=2}=e,{noResultsMessage:re="Oops! Looks like you're trying to predict something that's not quite right. We can't seem to find what you're looking for. Maybe try double-checking your spelling or try a different search term. Keep on typing - we'll do our best to get you where you need to go!"}=e,{placeholder:oe="Search"}=e,{proximity:de=[{type:"server-geolocation"}]}=e,{reverseActive:ce=D==="always"}=e,{reverseButtonTitle:Se="toggle reverse geocoding"}=e,{searchValue:Pe=""}=e,{pickedResultStyle:je="full-geometry"}=e,{showPlaceType:Fe="if-needed"}=e,{showResultsWhileTyping:qe=!0}=e,{selectFirst:Ue=!0}=e,{flyToSelected:ke=!1}=e,{markerOnSelected:et=!0}=e,{types:ye=void 0}=e;const Be=[];let{reverseGeocodingTypes:Je=Be}=e,{exhaustiveReverseGeocoding:ct=!1}=e,{excludeTypes:yt=!1}=e;const we=void 0;let{reverseGeocodingExcludeTypes:fe=we}=e,{zoom:Ve=d}=e,{apiUrl:tt="https://api.maptiler.com/geocoding"}=e,{fetchParameters:Mt={}}=e,{iconsBaseUrl:mt="https://cdn.maptiler.com/maptiler-geocoding-control/v2.1.7/icons/"}=e,{adjustUrlQuery:Ce=()=>{}}=e,{adjustUrl:xe=()=>{}}=e;function vt(wt){he.focus(wt)}function be(){he.blur()}function ie(wt,Ri=!0,bi=!1){t(1,Pe=wt),Ri?(t(15,pe=-1),gi()):(gn(void 0,!bi,bi),setTimeout(()=>{he.focus(),he.select()}))}function ae(){t(13,Xe=void 0),t(14,Te=void 0),t(15,pe=-1)}function De(){t(64,bt=[]),t(14,Te=void 0)}let Xe,bt,Te,te="",he,pe=-1,Re,Oe=[],ht,pt,ot,St,Lt=!1;const zt=new Set,Jt=zF();KU(()=>{Q&&(Q.setEventHandler(void 0),Q.indicateReverse(!1),Q.setSelectedMarker(-1),Q.setFeatures(void 0,void 0,!1))});function gi(wt){if(t(17,Lt=!1),pt&&(clearTimeout(pt),pt=void 0),pe>-1&&Xe)t(14,Te=Xe[pe]),t(1,Pe=Te.place_type[0]==="reverse"?Te.place_name:Te.place_name.replace(/,.*/,"")),t(19,Re=void 0),t(64,bt=void 0),t(15,pe=-1);else if(Pe){const Ri=wt||!Fi(Pe);un(Pe,{exact:!0}).then(()=>{t(64,bt=Xe),t(14,Te=void 0),Ri&&nn()}).catch(bi=>t(19,Re=bi))}}function Fi(wt){try{return Uj(wt,6)}catch{return!1}}async function un(wt,{byId:Ri=!1,exact:bi=!1}={}){var Vi,Jn,Xi;t(19,Re=void 0),ht?.abort();const Gn=new AbortController;t(20,ht=Gn);try{const on=Fi(wt),zr=new URL(tt+"/"+encodeURIComponent(on?on.decimalLongitude+","+on.decimalLatitude:wt)+".json"),qn=zr.searchParams;N!==void 0&&qn.set("language",Array.isArray(N)?N.join(","):N??"");const[an]=Q?.getCenterAndZoom()??[];let rn=(Vi=!on||Je===Be?ye:Je)==null?void 0:Vi.map(rr=>typeof rr=="string"?rr:an===void 0||(rr[0]??0)<=an&&an<(rr[1]??1/0)?rr[2]:void 0).filter(rr=>rr!==void 0);rn&&(rn=[...new Set(rn)],qn.set("types",rn.join(",")));const ns=!on||fe===we?yt:fe;if(ns&&qn.set("excludeTypes",String(ns)),_&&qn.set("bbox",_.map(rr=>rr.toFixed(6)).join(",")),E&&qn.set("country",Array.isArray(E)?E.join(","):E),!Ri&&!on){const rr=await Rj(Q,de,Gn);rr&&qn.set("proximity",rr),(bi||!qe)&&qn.set("autocomplete","false"),qn.set("fuzzyMatch",String(G))}const so=z===q?V:z;so!==void 0&&so>1&&rn?.length!==1&&console.warn("For reverse geocoding when limit > 1 then types must contain single value."),on?(so===1||so!==void 0&&(ct||rn?.length===1))&&qn.set("limit",String(so)):V!==void 0&&qn.set("limit",String(V)),g&&qn.set("key",g),Ce(qn),xe(zr);const pl=zr.searchParams.get("types")===""&&zr.searchParams.get("excludeTypes")!=="true",To=zr.toString();if(To===te){Ri?(S&&t(13,Xe=void 0),t(14,Te=Oe[0])):(t(13,Xe=Oe),((Jn=Xe[pe])==null?void 0:Jn.id)!==r?.id&&t(15,pe=-1));return}te=To;let Ar;if(pl)Ar={type:"FeatureCollection",features:[]};else{const rr=await fetch(To,{signal:Gn.signal,...Mt});if(!rr.ok)throw new Error(await rr.text());Ar=await rr.json()}Jt("response",{url:To,featureCollection:Ar}),Ri?(S&&t(13,Xe=void 0),t(14,Te=Ar.features[0]),Oe=[Te]):(t(13,Xe=Ar.features.filter(U)),on&&Xe.unshift({type:"Feature",properties:{},id:"reverse_"+on.decimalLongitude+"_"+on.decimalLatitude,text:on.decimalLatitude+", "+on.decimalLongitude,place_name:on.decimalLatitude+", "+on.decimalLongitude,place_type:["reverse"],center:[on.decimalLongitude,on.decimalLatitude],bbox:[on.decimalLongitude,on.decimalLatitude,on.decimalLongitude,on.decimalLatitude],geometry:{type:"Point",coordinates:[on.decimalLongitude,on.decimalLatitude]}}),Oe=Xe,((Xi=Xe[pe])==null?void 0:Xi.id)!==r?.id&&t(15,pe=-1),on&&he.focus())}catch(on){if(on&&typeof on=="object"&&"name"in on&&on.name==="AbortError")return;throw on}finally{Gn===ht&&t(20,ht=void 0)}}function nn(){var wt;if(!(bt!=null&&bt.length)||!j)return;const Ri=[180,90,-180,-90],bi=!bt.some(Jn=>!Jn.matching_text);let Vi;for(const Jn of bt){const Xi=hn(Jn);if(Vi=Vi===void 0?Xi:Xi===void 0?Vi:Math.max(Vi,Xi),bi||!Jn.matching_text)for(const Gn of[0,1,2,3])Ri[Gn]=Math[Gn<2?"min":"max"](Ri[Gn],((wt=Jn.bbox)==null?void 0:wt[Gn])??Jn.center[Gn%2])}Q&&bt.length>0&&(Te&&Ri[0]===Ri[2]&&Ri[1]===Ri[3]?Q.flyTo(Te.center,hn(Te)):Q.fitBounds(pw(Ri),50,Vi))}function Tt(){!Te||!Q||(!Te.bbox||Te.bbox[0]===Te.bbox[2]&&Te.bbox[1]===Te.bbox[3]?Q.flyTo(Te.center,hn(Te)):Q.fitBounds(pw(Te.bbox),50,hn(Te)))}function hn(wt){var Ri;if(!wt.bbox||wt.bbox[0]!==wt.bbox[2]&&wt.bbox[1]!==wt.bbox[3])return;const bi=wt.id.replace(/\..*/,"");return(Array.isArray((Ri=wt.properties)==null?void 0:Ri.categories)?wt.properties.categories.reduce((Vi,Jn)=>{const Xi=Ve[bi+"."+Jn];return Vi===void 0?Xi:Xi===void 0?Vi:Math.max(Vi,Xi)},void 0):void 0)??Ve[bi]}function fr(wt){t(0,ce=D==="always"),t(13,Xe=void 0),t(14,Te=void 0),t(15,pe=-1),ie(wt[1].toFixed(6)+", "+Ij(wt[0],[-180,180],!0).toFixed(6),!1,!0)}function Li(wt){if(!Xe)return;let Ri=wt.key==="ArrowDown"?1:wt.key==="ArrowUp"?-1:0;Ri&&(he.focus(),t(17,Lt=!0),wt.preventDefault(),Te&&pe===-1&&t(15,pe=Xe.findIndex(bi=>bi.id===Te?.id)),pe===(Te||Ue?0:-1)&&Ri===-1&&t(15,pe=Xe.length),t(15,pe+=Ri),pe>=Xe.length&&t(15,pe=-1),pe<0&&(Te||Ue)&&t(15,pe=0))}function gn(wt,Ri=!0,bi=!1){if(t(19,Re=void 0),t(14,Te=void 0),t(17,Lt=!0),qe||bi){if(pt&&clearTimeout(pt),Pe.length<X)return;const Vi=Pe;pt=window.setTimeout(()=>{un(Vi).catch(Jn=>t(19,Re=Jn))},Ri?C:0)}else t(13,Xe=void 0),t(19,Re=void 0)}function zn(wt){Te&&Te?.id===wt?.id?Tt():(t(14,Te=wt),t(1,Pe=wt.place_name))}function wn(wt){t(15,pe=wt)}function kn(){(!Ue||Te)&&t(15,pe=-1),ke&&Tt()}const Sn=()=>he.focus();function Kn(wt){UM[wt?"unshift":"push"](()=>{he=wt,t(18,he)})}function Ye(){Pe=this.value,t(1,Pe),t(17,Lt),t(31,b),t(16,ot)}const kt=()=>t(17,Lt=!0),at=()=>t(17,Lt=!1),Ot=()=>t(17,Lt=!0),Gt=()=>t(14,Te=void 0),Gi=()=>{t(1,Pe=""),t(14,Te=void 0),he.focus()},Ci=()=>t(0,ce=!ce),Nt=()=>t(19,Re=void 0),si=wt=>wn(wt),pi=wt=>zn(wt),Wi=()=>{};return n.$$set=wt=>{"class"in wt&&t(2,p=wt.class),"apiKey"in wt&&t(29,g=wt.apiKey),"bbox"in wt&&t(30,_=wt.bbox),"clearButtonTitle"in wt&&t(3,x=wt.clearButtonTitle),"clearOnBlur"in wt&&t(31,b=wt.clearOnBlur),"clearListOnPick"in wt&&t(32,S=wt.clearListOnPick),"keepListOpen"in wt&&t(4,P=wt.keepListOpen),"collapsed"in wt&&t(5,L=wt.collapsed),"country"in wt&&t(33,E=wt.country),"debounceSearch"in wt&&t(34,C=wt.debounceSearch),"enableReverse"in wt&&t(6,D=wt.enableReverse),"errorMessage"in wt&&t(7,O=wt.errorMessage),"filter"in wt&&t(35,U=wt.filter),"flyTo"in wt&&t(36,j=wt.flyTo),"fuzzyMatch"in wt&&t(37,G=wt.fuzzyMatch),"language"in wt&&t(38,N=wt.language),"limit"in wt&&t(39,V=wt.limit),"reverseGeocodingLimit"in wt&&t(40,z=wt.reverseGeocodingLimit),"mapController"in wt&&t(41,Q=wt.mapController),"minLength"in wt&&t(42,X=wt.minLength),"noResultsMessage"in wt&&t(8,re=wt.noResultsMessage),"placeholder"in wt&&t(9,oe=wt.placeholder),"proximity"in wt&&t(43,de=wt.proximity),"reverseActive"in wt&&t(0,ce=wt.reverseActive),"reverseButtonTitle"in wt&&t(10,Se=wt.reverseButtonTitle),"searchValue"in wt&&t(1,Pe=wt.searchValue),"pickedResultStyle"in wt&&t(44,je=wt.pickedResultStyle),"showPlaceType"in wt&&t(11,Fe=wt.showPlaceType),"showResultsWhileTyping"in wt&&t(45,qe=wt.showResultsWhileTyping),"selectFirst"in wt&&t(46,Ue=wt.selectFirst),"flyToSelected"in wt&&t(47,ke=wt.flyToSelected),"markerOnSelected"in wt&&t(48,et=wt.markerOnSelected),"types"in wt&&t(49,ye=wt.types),"reverseGeocodingTypes"in wt&&t(50,Je=wt.reverseGeocodingTypes),"exhaustiveReverseGeocoding"in wt&&t(51,ct=wt.exhaustiveReverseGeocoding),"excludeTypes"in wt&&t(52,yt=wt.excludeTypes),"reverseGeocodingExcludeTypes"in wt&&t(53,fe=wt.reverseGeocodingExcludeTypes),"zoom"in wt&&t(54,Ve=wt.zoom),"apiUrl"in wt&&t(55,tt=wt.apiUrl),"fetchParameters"in wt&&t(56,Mt=wt.fetchParameters),"iconsBaseUrl"in wt&&t(12,mt=wt.iconsBaseUrl),"adjustUrlQuery"in wt&&t(57,Ce=wt.adjustUrlQuery),"adjustUrl"in wt&&t(58,xe=wt.adjustUrl),"$$scope"in wt&&t(69,s=wt.$$scope)},n.$$.update=()=>{if(n.$$.dirty[0]&64&&t(0,ce=D==="always"),n.$$.dirty[0]&16384|n.$$.dirty[1]&8192&&je!=="marker-only"&&Te&&!Te.address&&Te.geometry.type==="Point"&&Te.place_type[0]!=="reverse"&&un(Te.id,{byId:!0}).catch(wt=>t(19,Re=wt)),n.$$.dirty[0]&16384|n.$$.dirty[1]&1058|n.$$.dirty[2]&8&&(Q&&Te&&Te.id!==St&&j&&(Tt(),S&&t(13,Xe=void 0),t(64,bt=void 0),t(15,pe=-1)),t(65,St=Te?.id)),n.$$.dirty[0]&196608|n.$$.dirty[1]&1&&setTimeout(()=>{t(16,ot=Lt),b&&!ot&&t(1,Pe="")}),n.$$.dirty[0]&8194|n.$$.dirty[1]&2048&&Pe.length<X&&(t(13,Xe=void 0),t(19,Re=void 0),t(64,bt=Xe)),n.$$.dirty[0]&57344|n.$$.dirty[1]&32768&&Ue&&Xe!=null&&Xe.length&&pe==-1&&!Te&&t(15,pe=0),n.$$.dirty[0]&8192|n.$$.dirty[2]&4&&bt!==Xe&&t(64,bt=void 0),n.$$.dirty[0]&73729|n.$$.dirty[1]&1024|n.$$.dirty[2]&4&&Q&&Q.setEventHandler(wt=>{switch(wt.type){case"mapClick":ce&&fr(wt.coordinates);break;case"markerClick":{const Ri=Xe?.find(bi=>bi.id===wt.id);Ri&&zn(Ri)}break;case"markerMouseEnter":bt&&t(15,pe=ot?Xe?.findIndex(Ri=>Ri.id===wt.id)??-1:-1);break;case"markerMouseLeave":bt&&t(15,pe=-1);break}}),n.$$.dirty[0]&40960&&t(66,r=Xe?.[pe]),n.$$.dirty[1]&66592|n.$$.dirty[2]&16&&Q&&r&&j&&ke&&Q.flyTo(r.center,hn(r)),n.$$.dirty[1]&8192&&t(68,i=je==="full-geometry-including-polygon-center-marker"),n.$$.dirty[1]&132096|n.$$.dirty[2]&64&&(et||Q==null||Q.setFeatures(void 0,void 0,i)),n.$$.dirty[0]&16384|n.$$.dirty[1]&132096|n.$$.dirty[2]&84&&Q&&et&&!bt&&(Q.setFeatures(r?[r]:void 0,Te,i),Q.setSelectedMarker(r?0:-1)),n.$$.dirty[0]&16384|n.$$.dirty[1]&1024|n.$$.dirty[2]&68&&Q&&Q.setFeatures(bt,Te,i),n.$$.dirty[0]&32768|n.$$.dirty[1]&1024|n.$$.dirty[2]&4&&bt&&Q&&Q.setSelectedMarker(pe),n.$$.dirty[0]&2|n.$$.dirty[1]&1024&&Q){const wt=Fi(Pe);Q.setReverseMarker(wt?[wt.decimalLongitude,wt.decimalLatitude]:void 0)}n.$$.dirty[2]&16&&Jt("select",{feature:r}),n.$$.dirty[0]&16384&&Jt("pick",{feature:Te}),n.$$.dirty[0]&73744&&t(67,o=!!(Xe!=null&&Xe.length)&&(ot||P)),n.$$.dirty[2]&32&&Jt("optionsvisibilitychange",{optionsVisible:o}),n.$$.dirty[0]&8192&&Jt("featureslisted",{features:Xe}),n.$$.dirty[2]&4&&Jt("featuresmarked",{features:bt}),n.$$.dirty[0]&1&&Jt("reversetoggle",{reverse:ce}),n.$$.dirty[0]&2&&Jt("querychange",{query:Pe}),n.$$.dirty[0]&1|n.$$.dirty[1]&1024&&Q&&Q.indicateReverse(ce)},[ce,Pe,p,x,P,L,D,O,re,oe,Se,Fe,mt,Xe,Te,pe,ot,Lt,he,Re,ht,zt,gi,Li,gn,zn,wn,kn,d,g,_,b,S,E,C,U,j,G,N,V,z,Q,X,de,je,qe,Ue,ke,et,ye,Je,ct,yt,fe,Ve,tt,Mt,Ce,xe,vt,be,ie,ae,De,bt,St,r,o,i,s,c,Sn,Kn,Ye,kt,at,Ot,Gt,Gi,Ci,Nt,si,pi,Wi]}let Xj=class extends Kd{constructor(n){super(),Yd(this,n,Zj,Hj,Xd,{ZOOM_DEFAULTS:28,class:2,apiKey:29,bbox:30,clearButtonTitle:3,clearOnBlur:31,clearListOnPick:32,keepListOpen:4,collapsed:5,country:33,debounceSearch:34,enableReverse:6,errorMessage:7,filter:35,flyTo:36,fuzzyMatch:37,language:38,limit:39,reverseGeocodingLimit:40,mapController:41,minLength:42,noResultsMessage:8,placeholder:9,proximity:43,reverseActive:0,reverseButtonTitle:10,searchValue:1,pickedResultStyle:44,showPlaceType:11,showResultsWhileTyping:45,selectFirst:46,flyToSelected:47,markerOnSelected:48,types:49,reverseGeocodingTypes:50,exhaustiveReverseGeocoding:51,excludeTypes:52,reverseGeocodingExcludeTypes:53,zoom:54,apiUrl:55,fetchParameters:56,iconsBaseUrl:12,adjustUrlQuery:57,adjustUrl:58,focus:59,blur:60,setQuery:61,clearList:62,clearMap:63},null,[-1,-1,-1,-1])}get ZOOM_DEFAULTS(){return this.$$.ctx[28]}get focus(){return this.$$.ctx[59]}get blur(){return this.$$.ctx[60]}get setQuery(){return this.$$.ctx[61]}get clearList(){return this.$$.ctx[62]}get clearMap(){return this.$$.ctx[63]}};function Iy(n,e,t={}){const i={type:"Feature"};return(t.id===0||t.id)&&(i.id=t.id),t.bbox&&(i.bbox=t.bbox),i.properties=e||{},i.geometry=n,i}function gC(n,e,t={}){for(const i of n){if(i.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(i[i.length-1].length!==i[0].length)throw new Error("First and last Position are not equivalent.");for(let r=0;r<i[i.length-1].length;r++)if(i[i.length-1][r]!==i[0][r])throw new Error("First and last Position are not equivalent.")}return Iy({type:"Polygon",coordinates:n},e,t)}function Ry(n,e={}){const t={type:"FeatureCollection"};return e.id&&(t.id=e.id),e.bbox&&(t.bbox=e.bbox),t.features=n,t}function UF(n,e,t={}){return Iy({type:"MultiPolygon",coordinates:n},e,t)}var Yj=/^-?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?$/i,QS=Math.ceil,Pl=Math.floor,ga="[BigNumber Error] ",DI=ga+"Number primitive has more than 15 significant digits: ",gc=1e14,fn=14,FI=9007199254740991,eT=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11,1e12,1e13],ud=1e7,Ha=1e9;function jF(n){var e,t,i,r=C.prototype={constructor:C,toString:null,valueOf:null},o=new C(1),c=20,s=4,d=-7,p=21,g=-1e7,_=1e7,x=!1,b=1,S=0,P={prefix:"",groupSize:3,secondaryGroupSize:0,groupSeparator:",",decimalSeparator:".",fractionGroupSize:0,fractionGroupSeparator:"Â ",suffix:""},L="0123456789abcdefghijklmnopqrstuvwxyz",E=!0;function C(N,V){var q,z,Q,X,re,oe,de,ce,Se=this;if(!(Se instanceof C))return new C(N,V);if(V==null){if(N&&N._isBigNumber===!0){Se.s=N.s,!N.c||N.e>_?Se.c=Se.e=null:N.e<g?Se.c=[Se.e=0]:(Se.e=N.e,Se.c=N.c.slice());return}if((oe=typeof N=="number")&&N*0==0){if(Se.s=1/N<0?(N=-N,-1):1,N===~~N){for(X=0,re=N;re>=10;re/=10,X++);X>_?Se.c=Se.e=null:(Se.e=X,Se.c=[N]);return}ce=String(N)}else{if(!Yj.test(ce=String(N)))return i(Se,ce,oe);Se.s=ce.charCodeAt(0)==45?(ce=ce.slice(1),-1):1}(X=ce.indexOf("."))>-1&&(ce=ce.replace(".","")),(re=ce.search(/e/i))>0?(X<0&&(X=re),X+=+ce.slice(re+1),ce=ce.substring(0,re)):X<0&&(X=ce.length)}else{if(os(V,2,L.length,"Base"),V==10&&E)return Se=new C(N),j(Se,c+Se.e+1,s);if(ce=String(N),oe=typeof N=="number"){if(N*0!=0)return i(Se,ce,oe,V);if(Se.s=1/N<0?(ce=ce.slice(1),-1):1,C.DEBUG&&ce.replace(/^0\.0*|\./,"").length>15)throw Error(DI+N)}else Se.s=ce.charCodeAt(0)===45?(ce=ce.slice(1),-1):1;for(q=L.slice(0,V),X=re=0,de=ce.length;re<de;re++)if(q.indexOf(z=ce.charAt(re))<0){if(z=="."){if(re>X){X=de;continue}}else if(!Q&&(ce==ce.toUpperCase()&&(ce=ce.toLowerCase())||ce==ce.toLowerCase()&&(ce=ce.toUpperCase()))){Q=!0,re=-1,X=0;continue}return i(Se,String(N),oe,V)}oe=!1,ce=t(ce,V,10,Se.s),(X=ce.indexOf("."))>-1?ce=ce.replace(".",""):X=ce.length}for(re=0;ce.charCodeAt(re)===48;re++);for(de=ce.length;ce.charCodeAt(--de)===48;);if(ce=ce.slice(re,++de)){if(de-=re,oe&&C.DEBUG&&de>15&&(N>FI||N!==Pl(N)))throw Error(DI+Se.s*N);if((X=X-re-1)>_)Se.c=Se.e=null;else if(X<g)Se.c=[Se.e=0];else{if(Se.e=X,Se.c=[],re=(X+1)%fn,X<0&&(re+=fn),re<de){for(re&&Se.c.push(+ce.slice(0,re)),de-=fn;re<de;)Se.c.push(+ce.slice(re,re+=fn));re=fn-(ce=ce.slice(re)).length}else re-=de;for(;re--;ce+="0");Se.c.push(+ce)}}else Se.c=[Se.e=0]}C.clone=jF,C.ROUND_UP=0,C.ROUND_DOWN=1,C.ROUND_CEIL=2,C.ROUND_FLOOR=3,C.ROUND_HALF_UP=4,C.ROUND_HALF_DOWN=5,C.ROUND_HALF_EVEN=6,C.ROUND_HALF_CEIL=7,C.ROUND_HALF_FLOOR=8,C.EUCLID=9,C.config=C.set=function(N){var V,q;if(N!=null)if(typeof N=="object"){if(N.hasOwnProperty(V="DECIMAL_PLACES")&&(q=N[V],os(q,0,Ha,V),c=q),N.hasOwnProperty(V="ROUNDING_MODE")&&(q=N[V],os(q,0,8,V),s=q),N.hasOwnProperty(V="EXPONENTIAL_AT")&&(q=N[V],q&&q.pop?(os(q[0],-1e9,0,V),os(q[1],0,Ha,V),d=q[0],p=q[1]):(os(q,-1e9,Ha,V),d=-(p=q<0?-q:q))),N.hasOwnProperty(V="RANGE"))if(q=N[V],q&&q.pop)os(q[0],-1e9,-1,V),os(q[1],1,Ha,V),g=q[0],_=q[1];else if(os(q,-1e9,Ha,V),q)g=-(_=q<0?-q:q);else throw Error(ga+V+" cannot be zero: "+q);if(N.hasOwnProperty(V="CRYPTO"))if(q=N[V],q===!!q)if(q)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))x=q;else throw x=!q,Error(ga+"crypto unavailable");else x=q;else throw Error(ga+V+" not true or false: "+q);if(N.hasOwnProperty(V="MODULO_MODE")&&(q=N[V],os(q,0,9,V),b=q),N.hasOwnProperty(V="POW_PRECISION")&&(q=N[V],os(q,0,Ha,V),S=q),N.hasOwnProperty(V="FORMAT"))if(q=N[V],typeof q=="object")P=q;else throw Error(ga+V+" not an object: "+q);if(N.hasOwnProperty(V="ALPHABET"))if(q=N[V],typeof q=="string"&&!/^.?$|[+\-.\s]|(.).*\1/.test(q))E=q.slice(0,10)=="0123456789",L=q;else throw Error(ga+V+" invalid: "+q)}else throw Error(ga+"Object expected: "+N);return{DECIMAL_PLACES:c,ROUNDING_MODE:s,EXPONENTIAL_AT:[d,p],RANGE:[g,_],CRYPTO:x,MODULO_MODE:b,POW_PRECISION:S,FORMAT:P,ALPHABET:L}},C.isBigNumber=function(N){if(!N||N._isBigNumber!==!0)return!1;if(!C.DEBUG)return!0;var V,q,z=N.c,Q=N.e,X=N.s;e:if({}.toString.call(z)=="[object Array]"){if((X===1||X===-1)&&Q>=-1e9&&Q<=Ha&&Q===Pl(Q)){if(z[0]===0){if(Q===0&&z.length===1)return!0;break e}if(V=(Q+1)%fn,V<1&&(V+=fn),String(z[0]).length==V){for(V=0;V<z.length;V++)if(q=z[V],q<0||q>=gc||q!==Pl(q))break e;if(q!==0)return!0}}}else if(z===null&&Q===null&&(X===null||X===1||X===-1))return!0;throw Error(ga+"Invalid BigNumber: "+N)},C.maximum=C.max=function(){return O(arguments,-1)},C.minimum=C.min=function(){return O(arguments,1)},C.random=(function(){var N=9007199254740992,V=Math.random()*N&2097151?function(){return Pl(Math.random()*N)}:function(){return(Math.random()*1073741824|0)*8388608+(Math.random()*8388608|0)};return function(q){var z,Q,X,re,oe,de=0,ce=[],Se=new C(o);if(q==null?q=c:os(q,0,Ha),re=QS(q/fn),x)if(crypto.getRandomValues){for(z=crypto.getRandomValues(new Uint32Array(re*=2));de<re;)oe=z[de]*131072+(z[de+1]>>>11),oe>=9e15?(Q=crypto.getRandomValues(new Uint32Array(2)),z[de]=Q[0],z[de+1]=Q[1]):(ce.push(oe%1e14),de+=2);de=re/2}else if(crypto.randomBytes){for(z=crypto.randomBytes(re*=7);de<re;)oe=(z[de]&31)*281474976710656+z[de+1]*1099511627776+z[de+2]*4294967296+z[de+3]*16777216+(z[de+4]<<16)+(z[de+5]<<8)+z[de+6],oe>=9e15?crypto.randomBytes(7).copy(z,de):(ce.push(oe%1e14),de+=7);de=re/7}else throw x=!1,Error(ga+"crypto unavailable");if(!x)for(;de<re;)oe=V(),oe<9e15&&(ce[de++]=oe%1e14);for(re=ce[--de],q%=fn,re&&q&&(oe=eT[fn-q],ce[de]=Pl(re/oe)*oe);ce[de]===0;ce.pop(),de--);if(de<0)ce=[X=0];else{for(X=-1;ce[0]===0;ce.splice(0,1),X-=fn);for(de=1,oe=ce[0];oe>=10;oe/=10,de++);de<fn&&(X-=fn-de)}return Se.e=X,Se.c=ce,Se}})(),C.sum=function(){for(var N=1,V=arguments,q=new C(V[0]);N<V.length;)q=q.plus(V[N++]);return q},t=(function(){var N="0123456789";function V(q,z,Q,X){for(var re,oe=[0],de,ce=0,Se=q.length;ce<Se;){for(de=oe.length;de--;oe[de]*=z);for(oe[0]+=X.indexOf(q.charAt(ce++)),re=0;re<oe.length;re++)oe[re]>Q-1&&(oe[re+1]==null&&(oe[re+1]=0),oe[re+1]+=oe[re]/Q|0,oe[re]%=Q)}return oe.reverse()}return function(q,z,Q,X,re){var oe,de,ce,Se,Pe,je,Fe,qe,Ue=q.indexOf("."),ke=c,et=s;for(Ue>=0&&(Se=S,S=0,q=q.replace(".",""),qe=new C(z),je=qe.pow(q.length-Ue),S=Se,qe.c=V(th(El(je.c),je.e,"0"),10,Q,N),qe.e=qe.c.length),Fe=V(q,z,Q,re?(oe=L,N):(oe=N,L)),ce=Se=Fe.length;Fe[--Se]==0;Fe.pop());if(!Fe[0])return oe.charAt(0);if(Ue<0?--ce:(je.c=Fe,je.e=ce,je.s=X,je=e(je,qe,ke,et,Q),Fe=je.c,Pe=je.r,ce=je.e),de=ce+ke+1,Ue=Fe[de],Se=Q/2,Pe=Pe||de<0||Fe[de+1]!=null,Pe=et<4?(Ue!=null||Pe)&&(et==0||et==(je.s<0?3:2)):Ue>Se||Ue==Se&&(et==4||Pe||et==6&&Fe[de-1]&1||et==(je.s<0?8:7)),de<1||!Fe[0])q=Pe?th(oe.charAt(1),-ke,oe.charAt(0)):oe.charAt(0);else{if(Fe.length=de,Pe)for(--Q;++Fe[--de]>Q;)Fe[de]=0,de||(++ce,Fe=[1].concat(Fe));for(Se=Fe.length;!Fe[--Se];);for(Ue=0,q="";Ue<=Se;q+=oe.charAt(Fe[Ue++]));q=th(q,ce,oe.charAt(0))}return q}})(),e=(function(){function N(z,Q,X){var re,oe,de,ce,Se=0,Pe=z.length,je=Q%ud,Fe=Q/ud|0;for(z=z.slice();Pe--;)de=z[Pe]%ud,ce=z[Pe]/ud|0,re=Fe*de+ce*je,oe=je*de+re%ud*ud+Se,Se=(oe/X|0)+(re/ud|0)+Fe*ce,z[Pe]=oe%X;return Se&&(z=[Se].concat(z)),z}function V(z,Q,X,re){var oe,de;if(X!=re)de=X>re?1:-1;else for(oe=de=0;oe<X;oe++)if(z[oe]!=Q[oe]){de=z[oe]>Q[oe]?1:-1;break}return de}function q(z,Q,X,re){for(var oe=0;X--;)z[X]-=oe,oe=z[X]<Q[X]?1:0,z[X]=oe*re+z[X]-Q[X];for(;!z[0]&&z.length>1;z.splice(0,1));}return function(z,Q,X,re,oe){var de,ce,Se,Pe,je,Fe,qe,Ue,ke,et,ye,Be,Je,ct,yt,we,fe,Ve=z.s==Q.s?1:-1,tt=z.c,Mt=Q.c;if(!tt||!tt[0]||!Mt||!Mt[0])return new C(!z.s||!Q.s||(tt?Mt&&tt[0]==Mt[0]:!Mt)?NaN:tt&&tt[0]==0||!Mt?Ve*0:Ve/0);for(Ue=new C(Ve),ke=Ue.c=[],ce=z.e-Q.e,Ve=X+ce+1,oe||(oe=gc,ce=Il(z.e/fn)-Il(Q.e/fn),Ve=Ve/fn|0),Se=0;Mt[Se]==(tt[Se]||0);Se++);if(Mt[Se]>(tt[Se]||0)&&ce--,Ve<0)ke.push(1),Pe=!0;else{for(ct=tt.length,we=Mt.length,Se=0,Ve+=2,je=Pl(oe/(Mt[0]+1)),je>1&&(Mt=N(Mt,je,oe),tt=N(tt,je,oe),we=Mt.length,ct=tt.length),Je=we,et=tt.slice(0,we),ye=et.length;ye<we;et[ye++]=0);fe=Mt.slice(),fe=[0].concat(fe),yt=Mt[0],Mt[1]>=oe/2&&yt++;do{if(je=0,de=V(Mt,et,we,ye),de<0){if(Be=et[0],we!=ye&&(Be=Be*oe+(et[1]||0)),je=Pl(Be/yt),je>1)for(je>=oe&&(je=oe-1),Fe=N(Mt,je,oe),qe=Fe.length,ye=et.length;V(Fe,et,qe,ye)==1;)je--,q(Fe,we<qe?fe:Mt,qe,oe),qe=Fe.length,de=1;else je==0&&(de=je=1),Fe=Mt.slice(),qe=Fe.length;if(qe<ye&&(Fe=[0].concat(Fe)),q(et,Fe,ye,oe),ye=et.length,de==-1)for(;V(Mt,et,we,ye)<1;)je++,q(et,we<ye?fe:Mt,ye,oe),ye=et.length}else de===0&&(je++,et=[0]);ke[Se++]=je,et[0]?et[ye++]=tt[Je]||0:(et=[tt[Je]],ye=1)}while((Je++<ct||et[0]!=null)&&Ve--);Pe=et[0]!=null,ke[0]||ke.splice(0,1)}if(oe==gc){for(Se=1,Ve=ke[0];Ve>=10;Ve/=10,Se++);j(Ue,X+(Ue.e=Se+ce*fn-1)+1,re,Pe)}else Ue.e=ce,Ue.r=+Pe;return Ue}})();function D(N,V,q,z){var Q,X,re,oe,de;if(q==null?q=s:os(q,0,8),!N.c)return N.toString();if(Q=N.c[0],re=N.e,V==null)de=El(N.c),de=z==1||z==2&&(re<=d||re>=p)?kb(de,re):th(de,re,"0");else if(N=j(new C(N),V,q),X=N.e,de=El(N.c),oe=de.length,z==1||z==2&&(V<=X||X<=d)){for(;oe<V;de+="0",oe++);de=kb(de,X)}else if(V-=re,de=th(de,X,"0"),X+1>oe){if(--V>0)for(de+=".";V--;de+="0");}else if(V+=X-oe,V>0)for(X+1==oe&&(de+=".");V--;de+="0");return N.s<0&&Q?"-"+de:de}function O(N,V){for(var q,z,Q=1,X=new C(N[0]);Q<N.length;Q++)z=new C(N[Q]),(!z.s||(q=jf(X,z))===V||q===0&&X.s===V)&&(X=z);return X}function U(N,V,q){for(var z=1,Q=V.length;!V[--Q];V.pop());for(Q=V[0];Q>=10;Q/=10,z++);return(q=z+q*fn-1)>_?N.c=N.e=null:q<g?N.c=[N.e=0]:(N.e=q,N.c=V),N}i=(function(){var N=/^(-?)0([xbo])(?=\w[\w.]*$)/i,V=/^([^.]+)\.$/,q=/^\.([^.]+)$/,z=/^-?(Infinity|NaN)$/,Q=/^\s*\+(?=[\w.])|^\s+|\s+$/g;return function(X,re,oe,de){var ce,Se=oe?re:re.replace(Q,"");if(z.test(Se))X.s=isNaN(Se)?null:Se<0?-1:1;else{if(!oe&&(Se=Se.replace(N,function(Pe,je,Fe){return ce=(Fe=Fe.toLowerCase())=="x"?16:Fe=="b"?2:8,!de||de==ce?je:Pe}),de&&(ce=de,Se=Se.replace(V,"$1").replace(q,"0.$1")),re!=Se))return new C(Se,ce);if(C.DEBUG)throw Error(ga+"Not a"+(de?" base "+de:"")+" number: "+re);X.s=null}X.c=X.e=null}})();function j(N,V,q,z){var Q,X,re,oe,de,ce,Se,Pe=N.c,je=eT;if(Pe){e:{for(Q=1,oe=Pe[0];oe>=10;oe/=10,Q++);if(X=V-Q,X<0)X+=fn,re=V,de=Pe[ce=0],Se=Pl(de/je[Q-re-1]%10);else if(ce=QS((X+1)/fn),ce>=Pe.length)if(z){for(;Pe.length<=ce;Pe.push(0));de=Se=0,Q=1,X%=fn,re=X-fn+1}else break e;else{for(de=oe=Pe[ce],Q=1;oe>=10;oe/=10,Q++);X%=fn,re=X-fn+Q,Se=re<0?0:Pl(de/je[Q-re-1]%10)}if(z=z||V<0||Pe[ce+1]!=null||(re<0?de:de%je[Q-re-1]),z=q<4?(Se||z)&&(q==0||q==(N.s<0?3:2)):Se>5||Se==5&&(q==4||z||q==6&&(X>0?re>0?de/je[Q-re]:0:Pe[ce-1])%10&1||q==(N.s<0?8:7)),V<1||!Pe[0])return Pe.length=0,z?(V-=N.e+1,Pe[0]=je[(fn-V%fn)%fn],N.e=-V||0):Pe[0]=N.e=0,N;if(X==0?(Pe.length=ce,oe=1,ce--):(Pe.length=ce+1,oe=je[fn-X],Pe[ce]=re>0?Pl(de/je[Q-re]%je[re])*oe:0),z)for(;;)if(ce==0){for(X=1,re=Pe[0];re>=10;re/=10,X++);for(re=Pe[0]+=oe,oe=1;re>=10;re/=10,oe++);X!=oe&&(N.e++,Pe[0]==gc&&(Pe[0]=1));break}else{if(Pe[ce]+=oe,Pe[ce]!=gc)break;Pe[ce--]=0,oe=1}for(X=Pe.length;Pe[--X]===0;Pe.pop());}N.e>_?N.c=N.e=null:N.e<g&&(N.c=[N.e=0])}return N}function G(N){var V,q=N.e;return q===null?N.toString():(V=El(N.c),V=q<=d||q>=p?kb(V,q):th(V,q,"0"),N.s<0?"-"+V:V)}return r.absoluteValue=r.abs=function(){var N=new C(this);return N.s<0&&(N.s=1),N},r.comparedTo=function(N,V){return jf(this,new C(N,V))},r.decimalPlaces=r.dp=function(N,V){var q,z,Q,X=this;if(N!=null)return os(N,0,Ha),V==null?V=s:os(V,0,8),j(new C(X),N+X.e+1,V);if(!(q=X.c))return null;if(z=((Q=q.length-1)-Il(this.e/fn))*fn,Q=q[Q])for(;Q%10==0;Q/=10,z--);return z<0&&(z=0),z},r.dividedBy=r.div=function(N,V){return e(this,new C(N,V),c,s)},r.dividedToIntegerBy=r.idiv=function(N,V){return e(this,new C(N,V),0,1)},r.exponentiatedBy=r.pow=function(N,V){var q,z,Q,X,re,oe,de,ce,Se,Pe=this;if(N=new C(N),N.c&&!N.isInteger())throw Error(ga+"Exponent not an integer: "+G(N));if(V!=null&&(V=new C(V)),oe=N.e>14,!Pe.c||!Pe.c[0]||Pe.c[0]==1&&!Pe.e&&Pe.c.length==1||!N.c||!N.c[0])return Se=new C(Math.pow(+G(Pe),oe?N.s*(2-Lb(N)):+G(N))),V?Se.mod(V):Se;if(de=N.s<0,V){if(V.c?!V.c[0]:!V.s)return new C(NaN);z=!de&&Pe.isInteger()&&V.isInteger(),z&&(Pe=Pe.mod(V))}else{if(N.e>9&&(Pe.e>0||Pe.e<-1||(Pe.e==0?Pe.c[0]>1||oe&&Pe.c[1]>=24e7:Pe.c[0]<8e13||oe&&Pe.c[0]<=9999975e7)))return X=Pe.s<0&&Lb(N)?-0:0,Pe.e>-1&&(X=1/X),new C(de?1/X:X);S&&(X=QS(S/fn+2))}for(oe?(q=new C(.5),de&&(N.s=1),ce=Lb(N)):(Q=Math.abs(+G(N)),ce=Q%2),Se=new C(o);;){if(ce){if(Se=Se.times(Pe),!Se.c)break;X?Se.c.length>X&&(Se.c.length=X):z&&(Se=Se.mod(V))}if(Q){if(Q=Pl(Q/2),Q===0)break;ce=Q%2}else if(N=N.times(q),j(N,N.e+1,1),N.e>14)ce=Lb(N);else{if(Q=+G(N),Q===0)break;ce=Q%2}Pe=Pe.times(Pe),X?Pe.c&&Pe.c.length>X&&(Pe.c.length=X):z&&(Pe=Pe.mod(V))}return z?Se:(de&&(Se=o.div(Se)),V?Se.mod(V):X?j(Se,S,s,re):Se)},r.integerValue=function(N){var V=new C(this);return N==null?N=s:os(N,0,8),j(V,V.e+1,N)},r.isEqualTo=r.eq=function(N,V){return jf(this,new C(N,V))===0},r.isFinite=function(){return!!this.c},r.isGreaterThan=r.gt=function(N,V){return jf(this,new C(N,V))>0},r.isGreaterThanOrEqualTo=r.gte=function(N,V){return(V=jf(this,new C(N,V)))===1||V===0},r.isInteger=function(){return!!this.c&&Il(this.e/fn)>this.c.length-2},r.isLessThan=r.lt=function(N,V){return jf(this,new C(N,V))<0},r.isLessThanOrEqualTo=r.lte=function(N,V){return(V=jf(this,new C(N,V)))===-1||V===0},r.isNaN=function(){return!this.s},r.isNegative=function(){return this.s<0},r.isPositive=function(){return this.s>0},r.isZero=function(){return!!this.c&&this.c[0]==0},r.minus=function(N,V){var q,z,Q,X,re=this,oe=re.s;if(N=new C(N,V),V=N.s,!oe||!V)return new C(NaN);if(oe!=V)return N.s=-V,re.plus(N);var de=re.e/fn,ce=N.e/fn,Se=re.c,Pe=N.c;if(!de||!ce){if(!Se||!Pe)return Se?(N.s=-V,N):new C(Pe?re:NaN);if(!Se[0]||!Pe[0])return Pe[0]?(N.s=-V,N):new C(Se[0]?re:s==3?-0:0)}if(de=Il(de),ce=Il(ce),Se=Se.slice(),oe=de-ce){for((X=oe<0)?(oe=-oe,Q=Se):(ce=de,Q=Pe),Q.reverse(),V=oe;V--;Q.push(0));Q.reverse()}else for(z=(X=(oe=Se.length)<(V=Pe.length))?oe:V,oe=V=0;V<z;V++)if(Se[V]!=Pe[V]){X=Se[V]<Pe[V];break}if(X&&(Q=Se,Se=Pe,Pe=Q,N.s=-N.s),V=(z=Pe.length)-(q=Se.length),V>0)for(;V--;Se[q++]=0);for(V=gc-1;z>oe;){if(Se[--z]<Pe[z]){for(q=z;q&&!Se[--q];Se[q]=V);--Se[q],Se[z]+=gc}Se[z]-=Pe[z]}for(;Se[0]==0;Se.splice(0,1),--ce);return Se[0]?U(N,Se,ce):(N.s=s==3?-1:1,N.c=[N.e=0],N)},r.modulo=r.mod=function(N,V){var q,z,Q=this;return N=new C(N,V),!Q.c||!N.s||N.c&&!N.c[0]?new C(NaN):!N.c||Q.c&&!Q.c[0]?new C(Q):(b==9?(z=N.s,N.s=1,q=e(Q,N,0,3),N.s=z,q.s*=z):q=e(Q,N,0,b),N=Q.minus(q.times(N)),!N.c[0]&&b==1&&(N.s=Q.s),N)},r.multipliedBy=r.times=function(N,V){var q,z,Q,X,re,oe,de,ce,Se,Pe,je,Fe,qe,Ue,ke,et=this,ye=et.c,Be=(N=new C(N,V)).c;if(!ye||!Be||!ye[0]||!Be[0])return!et.s||!N.s||ye&&!ye[0]&&!Be||Be&&!Be[0]&&!ye?N.c=N.e=N.s=null:(N.s*=et.s,!ye||!Be?N.c=N.e=null:(N.c=[0],N.e=0)),N;for(z=Il(et.e/fn)+Il(N.e/fn),N.s*=et.s,de=ye.length,Pe=Be.length,de<Pe&&(qe=ye,ye=Be,Be=qe,Q=de,de=Pe,Pe=Q),Q=de+Pe,qe=[];Q--;qe.push(0));for(Ue=gc,ke=ud,Q=Pe;--Q>=0;){for(q=0,je=Be[Q]%ke,Fe=Be[Q]/ke|0,re=de,X=Q+re;X>Q;)ce=ye[--re]%ke,Se=ye[re]/ke|0,oe=Fe*ce+Se*je,ce=je*ce+oe%ke*ke+qe[X]+q,q=(ce/Ue|0)+(oe/ke|0)+Fe*Se,qe[X--]=ce%Ue;qe[X]=q}return q?++z:qe.splice(0,1),U(N,qe,z)},r.negated=function(){var N=new C(this);return N.s=-N.s||null,N},r.plus=function(N,V){var q,z=this,Q=z.s;if(N=new C(N,V),V=N.s,!Q||!V)return new C(NaN);if(Q!=V)return N.s=-V,z.minus(N);var X=z.e/fn,re=N.e/fn,oe=z.c,de=N.c;if(!X||!re){if(!oe||!de)return new C(Q/0);if(!oe[0]||!de[0])return de[0]?N:new C(oe[0]?z:Q*0)}if(X=Il(X),re=Il(re),oe=oe.slice(),Q=X-re){for(Q>0?(re=X,q=de):(Q=-Q,q=oe),q.reverse();Q--;q.push(0));q.reverse()}for(Q=oe.length,V=de.length,Q-V<0&&(q=de,de=oe,oe=q,V=Q),Q=0;V;)Q=(oe[--V]=oe[V]+de[V]+Q)/gc|0,oe[V]=gc===oe[V]?0:oe[V]%gc;return Q&&(oe=[Q].concat(oe),++re),U(N,oe,re)},r.precision=r.sd=function(N,V){var q,z,Q,X=this;if(N!=null&&N!==!!N)return os(N,1,Ha),V==null?V=s:os(V,0,8),j(new C(X),N,V);if(!(q=X.c))return null;if(Q=q.length-1,z=Q*fn+1,Q=q[Q]){for(;Q%10==0;Q/=10,z--);for(Q=q[0];Q>=10;Q/=10,z++);}return N&&X.e+1>z&&(z=X.e+1),z},r.shiftedBy=function(N){return os(N,-9007199254740991,FI),this.times("1e"+N)},r.squareRoot=r.sqrt=function(){var N,V,q,z,Q,X=this,re=X.c,oe=X.s,de=X.e,ce=c+4,Se=new C("0.5");if(oe!==1||!re||!re[0])return new C(!oe||oe<0&&(!re||re[0])?NaN:re?X:1/0);if(oe=Math.sqrt(+G(X)),oe==0||oe==1/0?(V=El(re),(V.length+de)%2==0&&(V+="0"),oe=Math.sqrt(+V),de=Il((de+1)/2)-(de<0||de%2),oe==1/0?V="5e"+de:(V=oe.toExponential(),V=V.slice(0,V.indexOf("e")+1)+de),q=new C(V)):q=new C(oe+""),q.c[0]){for(de=q.e,oe=de+ce,oe<3&&(oe=0);;)if(Q=q,q=Se.times(Q.plus(e(X,Q,ce,1))),El(Q.c).slice(0,oe)===(V=El(q.c)).slice(0,oe))if(q.e<de&&--oe,V=V.slice(oe-3,oe+1),V=="9999"||!z&&V=="4999"){if(!z&&(j(Q,Q.e+c+2,0),Q.times(Q).eq(X))){q=Q;break}ce+=4,oe+=4,z=1}else{(!+V||!+V.slice(1)&&V.charAt(0)=="5")&&(j(q,q.e+c+2,1),N=!q.times(q).eq(X));break}}return j(q,q.e+c+1,s,N)},r.toExponential=function(N,V){return N!=null&&(os(N,0,Ha),N++),D(this,N,V,1)},r.toFixed=function(N,V){return N!=null&&(os(N,0,Ha),N=N+this.e+1),D(this,N,V)},r.toFormat=function(N,V,q){var z,Q=this;if(q==null)N!=null&&V&&typeof V=="object"?(q=V,V=null):N&&typeof N=="object"?(q=N,N=V=null):q=P;else if(typeof q!="object")throw Error(ga+"Argument not an object: "+q);if(z=Q.toFixed(N,V),Q.c){var X,re=z.split("."),oe=+q.groupSize,de=+q.secondaryGroupSize,ce=q.groupSeparator||"",Se=re[0],Pe=re[1],je=Q.s<0,Fe=je?Se.slice(1):Se,qe=Fe.length;if(de&&(X=oe,oe=de,de=X,qe-=X),oe>0&&qe>0){for(X=qe%oe||oe,Se=Fe.substr(0,X);X<qe;X+=oe)Se+=ce+Fe.substr(X,oe);de>0&&(Se+=ce+Fe.slice(X)),je&&(Se="-"+Se)}z=Pe?Se+(q.decimalSeparator||"")+((de=+q.fractionGroupSize)?Pe.replace(new RegExp("\\d{"+de+"}\\B","g"),"$&"+(q.fractionGroupSeparator||"")):Pe):Se}return(q.prefix||"")+z+(q.suffix||"")},r.toFraction=function(N){var V,q,z,Q,X,re,oe,de,ce,Se,Pe,je,Fe=this,qe=Fe.c;if(N!=null&&(oe=new C(N),!oe.isInteger()&&(oe.c||oe.s!==1)||oe.lt(o)))throw Error(ga+"Argument "+(oe.isInteger()?"out of range: ":"not an integer: ")+G(oe));if(!qe)return new C(Fe);for(V=new C(o),ce=q=new C(o),z=de=new C(o),je=El(qe),X=V.e=je.length-Fe.e-1,V.c[0]=eT[(re=X%fn)<0?fn+re:re],N=!N||oe.comparedTo(V)>0?X>0?V:ce:oe,re=_,_=1/0,oe=new C(je),de.c[0]=0;Se=e(oe,V,0,1),Q=q.plus(Se.times(z)),Q.comparedTo(N)!=1;)q=z,z=Q,ce=de.plus(Se.times(Q=ce)),de=Q,V=oe.minus(Se.times(Q=V)),oe=Q;return Q=e(N.minus(q),z,0,1),de=de.plus(Q.times(ce)),q=q.plus(Q.times(z)),de.s=ce.s=Fe.s,X=X*2,Pe=e(ce,z,X,s).minus(Fe).abs().comparedTo(e(de,q,X,s).minus(Fe).abs())<1?[ce,z]:[de,q],_=re,Pe},r.toNumber=function(){return+G(this)},r.toPrecision=function(N,V){return N!=null&&os(N,1,Ha),D(this,N,V,2)},r.toString=function(N){var V,q=this,z=q.s,Q=q.e;return Q===null?z?(V="Infinity",z<0&&(V="-"+V)):V="NaN":(N==null?V=Q<=d||Q>=p?kb(El(q.c),Q):th(El(q.c),Q,"0"):N===10&&E?(q=j(new C(q),c+Q+1,s),V=th(El(q.c),q.e,"0")):(os(N,2,L.length,"Base"),V=t(th(El(q.c),Q,"0"),10,N,z,!0)),z<0&&q.c[0]&&(V="-"+V)),V},r.valueOf=r.toJSON=function(){return G(this)},r._isBigNumber=!0,r[Symbol.toStringTag]="BigNumber",r[Symbol.for("nodejs.util.inspect.custom")]=r.valueOf,n!=null&&C.set(n),C}function Il(n){var e=n|0;return n>0||n===e?e:e-1}function El(n){for(var e,t,i=1,r=n.length,o=n[0]+"";i<r;){for(e=n[i++]+"",t=fn-e.length;t--;e="0"+e);o+=e}for(r=o.length;o.charCodeAt(--r)===48;);return o.slice(0,r+1||1)}function jf(n,e){var t,i,r=n.c,o=e.c,c=n.s,s=e.s,d=n.e,p=e.e;if(!c||!s)return null;if(t=r&&!r[0],i=o&&!o[0],t||i)return t?i?0:-s:c;if(c!=s)return c;if(t=c<0,i=d==p,!r||!o)return i?0:!r^t?1:-1;if(!i)return d>p^t?1:-1;for(s=(d=r.length)<(p=o.length)?d:p,c=0;c<s;c++)if(r[c]!=o[c])return r[c]>o[c]^t?1:-1;return d==p?0:d>p^t?1:-1}function os(n,e,t,i){if(n<e||n>t||n!==Pl(n))throw Error(ga+(i||"Argument")+(typeof n=="number"?n<e||n>t?" out of range: ":" not an integer: ":" not a primitive number: ")+String(n))}function Lb(n){var e=n.c.length-1;return Il(n.e/fn)==e&&n.c[e]%2!=0}function kb(n,e){return(n.length>1?n.charAt(0)+"."+n.slice(1):n)+(e<0?"e":"e+")+e}function th(n,e,t){var i,r;if(e<0){for(r=t+".";++e;r+=t);n=r+n}else if(i=n.length,++e>i){for(r=t,e-=i;--e;r+=t);n+=r}else e<i&&(n=n.slice(0,e)+"."+n.slice(e));return n}var hu=jF(),Kj=class{constructor(n){Ai(this,"key"),Ai(this,"left",null),Ai(this,"right",null),this.key=n}},Sv=class extends Kj{constructor(n){super(n)}},Jj=class{constructor(){Ai(this,"size",0),Ai(this,"modificationCount",0),Ai(this,"splayCount",0)}splay(n){const e=this.root;if(e==null)return this.compare(n,n),-1;let t=null,i=null,r=null,o=null,c=e;const s=this.compare;let d;for(;;)if(d=s(c.key,n),d>0){let p=c.left;if(p==null||(d=s(p.key,n),d>0&&(c.left=p.right,p.right=c,c=p,p=c.left,p==null)))break;t==null?i=c:t.left=c,t=c,c=p}else if(d<0){let p=c.right;if(p==null||(d=s(p.key,n),d<0&&(c.right=p.left,p.left=c,c=p,p=c.right,p==null)))break;r==null?o=c:r.right=c,r=c,c=p}else break;return r!=null&&(r.right=c.left,c.left=o),t!=null&&(t.left=c.right,c.right=i),this.root!==c&&(this.root=c,this.splayCount++),d}splayMin(n){let e=n,t=e.left;for(;t!=null;){const i=t;e.left=i.right,i.right=e,e=i,t=e.left}return e}splayMax(n){let e=n,t=e.right;for(;t!=null;){const i=t;e.right=i.left,i.left=e,e=i,t=e.right}return e}_delete(n){if(this.root==null||this.splay(n)!=0)return null;let e=this.root;const t=e,i=e.left;if(this.size--,i==null)this.root=e.right;else{const r=e.right;e=this.splayMax(i),e.right=r,this.root=e}return this.modificationCount++,t}addNewRoot(n,e){this.size++,this.modificationCount++;const t=this.root;if(t==null){this.root=n;return}e<0?(n.left=t,n.right=t.right,t.right=null):(n.right=t,n.left=t.left,t.left=null),this.root=n}_first(){const n=this.root;return n==null?null:(this.root=this.splayMin(n),this.root)}_last(){const n=this.root;return n==null?null:(this.root=this.splayMax(n),this.root)}clear(){this.root=null,this.size=0,this.modificationCount++}has(n){return this.validKey(n)&&this.splay(n)==0}defaultCompare(){return(n,e)=>n<e?-1:n>e?1:0}wrap(){return{getRoot:()=>this.root,setRoot:n=>{this.root=n},getSize:()=>this.size,getModificationCount:()=>this.modificationCount,getSplayCount:()=>this.splayCount,setSplayCount:n=>{this.splayCount=n},splay:n=>this.splay(n),has:n=>this.has(n)}}},OI,zI,mw=class qv extends Jj{constructor(e,t){super(),Ai(this,"root",null),Ai(this,"compare"),Ai(this,"validKey"),Ai(this,OI,"[object Set]"),this.compare=e??this.defaultCompare(),this.validKey=t??(i=>i!=null&&i!=null)}delete(e){return this.validKey(e)?this._delete(e)!=null:!1}deleteAll(e){for(const t of e)this.delete(t)}forEach(e){const t=this[Symbol.iterator]();let i;for(;i=t.next(),!i.done;)e(i.value,i.value,this)}add(e){const t=this.splay(e);return t!=0&&this.addNewRoot(new Sv(e),t),this}addAndReturn(e){const t=this.splay(e);return t!=0&&this.addNewRoot(new Sv(e),t),this.root.key}addAll(e){for(const t of e)this.add(t)}isEmpty(){return this.root==null}isNotEmpty(){return this.root!=null}single(){if(this.size==0)throw"Bad state: No element";if(this.size>1)throw"Bad state: Too many element";return this.root.key}first(){if(this.size==0)throw"Bad state: No element";return this._first().key}last(){if(this.size==0)throw"Bad state: No element";return this._last().key}lastBefore(e){if(e==null)throw"Invalid arguments(s)";if(this.root==null)return null;if(this.splay(e)<0)return this.root.key;let t=this.root.left;if(t==null)return null;let i=t.right;for(;i!=null;)t=i,i=t.right;return t.key}firstAfter(e){if(e==null)throw"Invalid arguments(s)";if(this.root==null)return null;if(this.splay(e)>0)return this.root.key;let t=this.root.right;if(t==null)return null;let i=t.left;for(;i!=null;)t=i,i=t.left;return t.key}retainAll(e){const t=new qv(this.compare,this.validKey),i=this.modificationCount;for(const r of e){if(i!=this.modificationCount)throw"Concurrent modification during iteration.";this.validKey(r)&&this.splay(r)==0&&t.add(this.root.key)}t.size!=this.size&&(this.root=t.root,this.size=t.size,this.modificationCount++)}lookup(e){return!this.validKey(e)||this.splay(e)!=0?null:this.root.key}intersection(e){const t=new qv(this.compare,this.validKey);for(const i of this)e.has(i)&&t.add(i);return t}difference(e){const t=new qv(this.compare,this.validKey);for(const i of this)e.has(i)||t.add(i);return t}union(e){const t=this.clone();return t.addAll(e),t}clone(){const e=new qv(this.compare,this.validKey);return e.size=this.size,e.root=this.copyNode(this.root),e}copyNode(e){if(e==null)return null;function t(r,o){let c,s;do{if(c=r.left,s=r.right,c!=null){const d=new Sv(c.key);o.left=d,t(c,d)}if(s!=null){const d=new Sv(s.key);o.right=d,r=s,o=d}}while(s!=null)}const i=new Sv(e.key);return t(e,i),i}toSet(){return this.clone()}entries(){return new eG(this.wrap())}keys(){return this[Symbol.iterator]()}values(){return this[Symbol.iterator]()}[(zI=Symbol.iterator,OI=Symbol.toStringTag,zI)](){return new Qj(this.wrap())}},GF=class{constructor(n){Ai(this,"tree"),Ai(this,"path",new Array),Ai(this,"modificationCount",null),Ai(this,"splayCount"),this.tree=n,this.splayCount=n.getSplayCount()}[Symbol.iterator](){return this}next(){return this.moveNext()?{done:!1,value:this.current()}:{done:!0,value:null}}current(){if(!this.path.length)return null;const n=this.path[this.path.length-1];return this.getValue(n)}rebuildPath(n){this.path.splice(0,this.path.length),this.tree.splay(n),this.path.push(this.tree.getRoot()),this.splayCount=this.tree.getSplayCount()}findLeftMostDescendent(n){for(;n!=null;)this.path.push(n),n=n.left}moveNext(){if(this.modificationCount!=this.tree.getModificationCount()){if(this.modificationCount==null){this.modificationCount=this.tree.getModificationCount();let t=this.tree.getRoot();for(;t!=null;)this.path.push(t),t=t.left;return this.path.length>0}throw"Concurrent modification during iteration."}if(!this.path.length)return!1;this.splayCount!=this.tree.getSplayCount()&&this.rebuildPath(this.path[this.path.length-1].key);let n=this.path[this.path.length-1],e=n.right;if(e!=null){for(;e!=null;)this.path.push(e),e=e.left;return!0}for(this.path.pop();this.path.length&&this.path[this.path.length-1].right===n;)n=this.path.pop();return this.path.length>0}},Qj=class extends GF{getValue(n){return n.key}},eG=class extends GF{getValue(n){return[n.key,n.key]}},qF=n=>()=>n,WM=n=>{const e=n?(t,i)=>i.minus(t).abs().isLessThanOrEqualTo(n):qF(!1);return(t,i)=>e(t,i)?0:t.comparedTo(i)};function tG(n){const e=n?(t,i,r,o,c)=>t.exponentiatedBy(2).isLessThanOrEqualTo(o.minus(i).exponentiatedBy(2).plus(c.minus(r).exponentiatedBy(2)).times(n)):qF(!1);return(t,i,r)=>{const o=t.x,c=t.y,s=r.x,d=r.y,p=c.minus(d).times(i.x.minus(s)).minus(o.minus(s).times(i.y.minus(d)));return e(p,o,c,s,d)?0:p.comparedTo(0)}}var iG=n=>n,nG=n=>{if(n){const e=new mw(WM(n)),t=new mw(WM(n)),i=(o,c)=>c.addAndReturn(o),r=o=>({x:i(o.x,e),y:i(o.y,t)});return r({x:new hu(0),y:new hu(0)}),r}return iG},HM=n=>({set:e=>{Eh=HM(e)},reset:()=>HM(n),compare:WM(n),snap:nG(n),orient:tG(n)}),Eh=HM(),Tv=(n,e)=>n.ll.x.isLessThanOrEqualTo(e.x)&&e.x.isLessThanOrEqualTo(n.ur.x)&&n.ll.y.isLessThanOrEqualTo(e.y)&&e.y.isLessThanOrEqualTo(n.ur.y),ZM=(n,e)=>{if(e.ur.x.isLessThan(n.ll.x)||n.ur.x.isLessThan(e.ll.x)||e.ur.y.isLessThan(n.ll.y)||n.ur.y.isLessThan(e.ll.y))return null;const t=n.ll.x.isLessThan(e.ll.x)?e.ll.x:n.ll.x,i=n.ur.x.isLessThan(e.ur.x)?n.ur.x:e.ur.x,r=n.ll.y.isLessThan(e.ll.y)?e.ll.y:n.ll.y,o=n.ur.y.isLessThan(e.ur.y)?n.ur.y:e.ur.y;return{ll:{x:t,y:r},ur:{x:i,y:o}}},jx=(n,e)=>n.x.times(e.y).minus(n.y.times(e.x)),WF=(n,e)=>n.x.times(e.x).plus(n.y.times(e.y)),gw=n=>WF(n,n).sqrt(),rG=(n,e,t)=>{const i={x:e.x.minus(n.x),y:e.y.minus(n.y)},r={x:t.x.minus(n.x),y:t.y.minus(n.y)};return jx(r,i).div(gw(r)).div(gw(i))},sG=(n,e,t)=>{const i={x:e.x.minus(n.x),y:e.y.minus(n.y)},r={x:t.x.minus(n.x),y:t.y.minus(n.y)};return WF(r,i).div(gw(r)).div(gw(i))},BI=(n,e,t)=>e.y.isZero()?null:{x:n.x.plus(e.x.div(e.y).times(t.minus(n.y))),y:t},NI=(n,e,t)=>e.x.isZero()?null:{x:t,y:n.y.plus(e.y.div(e.x).times(t.minus(n.x)))},oG=(n,e,t,i)=>{if(e.x.isZero())return NI(t,i,n.x);if(i.x.isZero())return NI(n,e,t.x);if(e.y.isZero())return BI(t,i,n.y);if(i.y.isZero())return BI(n,e,t.y);const r=jx(e,i);if(r.isZero())return null;const o={x:t.x.minus(n.x),y:t.y.minus(n.y)},c=jx(o,e).div(r),s=jx(o,i).div(r),d=n.x.plus(s.times(e.x)),p=t.x.plus(c.times(i.x)),g=n.y.plus(s.times(e.y)),_=t.y.plus(c.times(i.y)),x=d.plus(p).div(2),b=g.plus(_).div(2);return{x,y:b}},nu=class HF{constructor(e,t){Ai(this,"point"),Ai(this,"isLeft"),Ai(this,"segment"),Ai(this,"otherSE"),Ai(this,"consumedBy"),e.events===void 0?e.events=[this]:e.events.push(this),this.point=e,this.isLeft=t}static compare(e,t){const i=HF.comparePoints(e.point,t.point);return i!==0?i:(e.point!==t.point&&e.link(t),e.isLeft!==t.isLeft?e.isLeft?1:-1:vw.compare(e.segment,t.segment))}static comparePoints(e,t){return e.x.isLessThan(t.x)?-1:e.x.isGreaterThan(t.x)?1:e.y.isLessThan(t.y)?-1:e.y.isGreaterThan(t.y)?1:0}link(e){if(e.point===this.point)throw new Error("Tried to link already linked events");const t=e.point.events;for(let i=0,r=t.length;i<r;i++){const o=t[i];this.point.events.push(o),o.point=this.point}this.checkForConsuming()}checkForConsuming(){const e=this.point.events.length;for(let t=0;t<e;t++){const i=this.point.events[t];if(i.segment.consumedBy===void 0)for(let r=t+1;r<e;r++){const o=this.point.events[r];o.consumedBy===void 0&&i.otherSE.point.events===o.otherSE.point.events&&i.segment.consume(o.segment)}}}getAvailableLinkedEvents(){const e=[];for(let t=0,i=this.point.events.length;t<i;t++){const r=this.point.events[t];r!==this&&!r.segment.ringOut&&r.segment.isInResult()&&e.push(r)}return e}getLeftmostComparator(e){const t=new Map,i=r=>{const o=r.otherSE;t.set(r,{sine:rG(this.point,e.point,o.point),cosine:sG(this.point,e.point,o.point)})};return(r,o)=>{t.has(r)||i(r),t.has(o)||i(o);const{sine:c,cosine:s}=t.get(r),{sine:d,cosine:p}=t.get(o);return c.isGreaterThanOrEqualTo(0)&&d.isGreaterThanOrEqualTo(0)?s.isLessThan(p)?1:s.isGreaterThan(p)?-1:0:c.isLessThan(0)&&d.isLessThan(0)?s.isLessThan(p)?-1:s.isGreaterThan(p)?1:0:d.isLessThan(c)?-1:d.isGreaterThan(c)?1:0}}},aG=class XM{constructor(e){Ai(this,"events"),Ai(this,"poly"),Ai(this,"_isExteriorRing"),Ai(this,"_enclosingRing"),this.events=e;for(let t=0,i=e.length;t<i;t++)e[t].segment.ringOut=this;this.poly=null}static factory(e){const t=[];for(let i=0,r=e.length;i<r;i++){const o=e[i];if(!o.isInResult()||o.ringOut)continue;let c=null,s=o.leftSE,d=o.rightSE;const p=[s],g=s.point,_=[];for(;c=s,s=d,p.push(s),s.point!==g;)for(;;){const x=s.getAvailableLinkedEvents();if(x.length===0){const P=p[0].point,L=p[p.length-1].point;throw new Error(`Unable to complete output ring starting at [${P.x}, ${P.y}]. Last matching segment found ends at [${L.x}, ${L.y}].`)}if(x.length===1){d=x[0].otherSE;break}let b=null;for(let P=0,L=_.length;P<L;P++)if(_[P].point===s.point){b=P;break}if(b!==null){const P=_.splice(b)[0],L=p.splice(P.index);L.unshift(L[0].otherSE),t.push(new XM(L.reverse()));continue}_.push({index:p.length,point:s.point});const S=s.getLeftmostComparator(c);d=x.sort(S)[0].otherSE;break}t.push(new XM(p))}return t}getGeom(){let e=this.events[0].point;const t=[e];for(let p=1,g=this.events.length-1;p<g;p++){const _=this.events[p].point,x=this.events[p+1].point;Eh.orient(_,e,x)!==0&&(t.push(_),e=_)}if(t.length===1)return null;const i=t[0],r=t[1];Eh.orient(i,e,r)===0&&t.shift(),t.push(t[0]);const o=this.isExteriorRing()?1:-1,c=this.isExteriorRing()?0:t.length-1,s=this.isExteriorRing()?t.length:-1,d=[];for(let p=c;p!=s;p+=o)d.push([t[p].x.toNumber(),t[p].y.toNumber()]);return d}isExteriorRing(){if(this._isExteriorRing===void 0){const e=this.enclosingRing();this._isExteriorRing=e?!e.isExteriorRing():!0}return this._isExteriorRing}enclosingRing(){return this._enclosingRing===void 0&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}_calcEnclosingRing(){var e,t;let i=this.events[0];for(let c=1,s=this.events.length;c<s;c++){const d=this.events[c];nu.compare(i,d)>0&&(i=d)}let r=i.segment.prevInResult(),o=r?r.prevInResult():null;for(;;){if(!r)return null;if(!o)return r.ringOut;if(o.ringOut!==r.ringOut)return((e=o.ringOut)==null?void 0:e.enclosingRing())!==r.ringOut?r.ringOut:(t=r.ringOut)==null?void 0:t.enclosingRing();r=o.prevInResult(),o=r?r.prevInResult():null}}},$I=class{constructor(n){Ai(this,"exteriorRing"),Ai(this,"interiorRings"),this.exteriorRing=n,n.poly=this,this.interiorRings=[]}addInterior(n){this.interiorRings.push(n),n.poly=this}getGeom(){const n=this.exteriorRing.getGeom();if(n===null)return null;const e=[n];for(let t=0,i=this.interiorRings.length;t<i;t++){const r=this.interiorRings[t].getGeom();r!==null&&e.push(r)}return e}},lG=class{constructor(n){Ai(this,"rings"),Ai(this,"polys"),this.rings=n,this.polys=this._composePolys(n)}getGeom(){const n=[];for(let e=0,t=this.polys.length;e<t;e++){const i=this.polys[e].getGeom();i!==null&&n.push(i)}return n}_composePolys(n){var e;const t=[];for(let i=0,r=n.length;i<r;i++){const o=n[i];if(!o.poly)if(o.isExteriorRing())t.push(new $I(o));else{const c=o.enclosingRing();c!=null&&c.poly||t.push(new $I(c)),(e=c?.poly)==null||e.addInterior(o)}}return t}},cG=class{constructor(n,e=vw.compare){Ai(this,"queue"),Ai(this,"tree"),Ai(this,"segments"),this.queue=n,this.tree=new mw(e),this.segments=[]}process(n){const e=n.segment,t=[];if(n.consumedBy)return n.isLeft?this.queue.delete(n.otherSE):this.tree.delete(e),t;n.isLeft&&this.tree.add(e);let i=e,r=e;do i=this.tree.lastBefore(i);while(i!=null&&i.consumedBy!=null);do r=this.tree.firstAfter(r);while(r!=null&&r.consumedBy!=null);if(n.isLeft){let o=null;if(i){const s=i.getIntersection(e);if(s!==null&&(e.isAnEndpoint(s)||(o=s),!i.isAnEndpoint(s))){const d=this._splitSafely(i,s);for(let p=0,g=d.length;p<g;p++)t.push(d[p])}}let c=null;if(r){const s=r.getIntersection(e);if(s!==null&&(e.isAnEndpoint(s)||(c=s),!r.isAnEndpoint(s))){const d=this._splitSafely(r,s);for(let p=0,g=d.length;p<g;p++)t.push(d[p])}}if(o!==null||c!==null){let s=null;o===null?s=c:c===null?s=o:s=nu.comparePoints(o,c)<=0?o:c,this.queue.delete(e.rightSE),t.push(e.rightSE);const d=e.split(s);for(let p=0,g=d.length;p<g;p++)t.push(d[p])}t.length>0?(this.tree.delete(e),t.push(n)):(this.segments.push(e),e.prev=i)}else{if(i&&r){const o=i.getIntersection(r);if(o!==null){if(!i.isAnEndpoint(o)){const c=this._splitSafely(i,o);for(let s=0,d=c.length;s<d;s++)t.push(c[s])}if(!r.isAnEndpoint(o)){const c=this._splitSafely(r,o);for(let s=0,d=c.length;s<d;s++)t.push(c[s])}}}this.tree.delete(e)}return t}_splitSafely(n,e){this.tree.delete(n);const t=n.rightSE;this.queue.delete(t);const i=n.split(e);return i.push(t),n.consumedBy===void 0&&this.tree.add(n),i}},uG=class{constructor(){Ai(this,"type"),Ai(this,"numMultiPolys")}run(n,e,t){Wv.type=n;const i=[new UI(e,!0)];for(let d=0,p=t.length;d<p;d++)i.push(new UI(t[d],!1));if(Wv.numMultiPolys=i.length,Wv.type==="difference"){const d=i[0];let p=1;for(;p<i.length;)ZM(i[p].bbox,d.bbox)!==null?p++:i.splice(p,1)}if(Wv.type==="intersection")for(let d=0,p=i.length;d<p;d++){const g=i[d];for(let _=d+1,x=i.length;_<x;_++)if(ZM(g.bbox,i[_].bbox)===null)return[]}const r=new mw(nu.compare);for(let d=0,p=i.length;d<p;d++){const g=i[d].getSweepEvents();for(let _=0,x=g.length;_<x;_++)r.add(g[_])}const o=new cG(r);let c=null;for(r.size!=0&&(c=r.first(),r.delete(c));c;){const d=o.process(c);for(let p=0,g=d.length;p<g;p++){const _=d[p];_.consumedBy===void 0&&r.add(_)}r.size!=0?(c=r.first(),r.delete(c)):c=null}Eh.reset();const s=aG.factory(o.segments);return new lG(s).getGeom()}},Wv=new uG,_w=Wv,hG=0,vw=class Gx{constructor(e,t,i,r){Ai(this,"id"),Ai(this,"leftSE"),Ai(this,"rightSE"),Ai(this,"rings"),Ai(this,"windings"),Ai(this,"ringOut"),Ai(this,"consumedBy"),Ai(this,"prev"),Ai(this,"_prevInResult"),Ai(this,"_beforeState"),Ai(this,"_afterState"),Ai(this,"_isInResult"),this.id=++hG,this.leftSE=e,e.segment=this,e.otherSE=t,this.rightSE=t,t.segment=this,t.otherSE=e,this.rings=i,this.windings=r}static compare(e,t){const i=e.leftSE.point.x,r=t.leftSE.point.x,o=e.rightSE.point.x,c=t.rightSE.point.x;if(c.isLessThan(i))return 1;if(o.isLessThan(r))return-1;const s=e.leftSE.point.y,d=t.leftSE.point.y,p=e.rightSE.point.y,g=t.rightSE.point.y;if(i.isLessThan(r)){if(d.isLessThan(s)&&d.isLessThan(p))return 1;if(d.isGreaterThan(s)&&d.isGreaterThan(p))return-1;const _=e.comparePoint(t.leftSE.point);if(_<0)return 1;if(_>0)return-1;const x=t.comparePoint(e.rightSE.point);return x!==0?x:-1}if(i.isGreaterThan(r)){if(s.isLessThan(d)&&s.isLessThan(g))return-1;if(s.isGreaterThan(d)&&s.isGreaterThan(g))return 1;const _=t.comparePoint(e.leftSE.point);if(_!==0)return _;const x=e.comparePoint(t.rightSE.point);return x<0?1:x>0?-1:1}if(s.isLessThan(d))return-1;if(s.isGreaterThan(d))return 1;if(o.isLessThan(c)){const _=t.comparePoint(e.rightSE.point);if(_!==0)return _}if(o.isGreaterThan(c)){const _=e.comparePoint(t.rightSE.point);if(_<0)return 1;if(_>0)return-1}if(!o.eq(c)){const _=p.minus(s),x=o.minus(i),b=g.minus(d),S=c.minus(r);if(_.isGreaterThan(x)&&b.isLessThan(S))return 1;if(_.isLessThan(x)&&b.isGreaterThan(S))return-1}return o.isGreaterThan(c)?1:o.isLessThan(c)||p.isLessThan(g)?-1:p.isGreaterThan(g)?1:e.id<t.id?-1:e.id>t.id?1:0}static fromRing(e,t,i){let r,o,c;const s=nu.comparePoints(e,t);if(s<0)r=e,o=t,c=1;else if(s>0)r=t,o=e,c=-1;else throw new Error(`Tried to create degenerate segment at [${e.x}, ${e.y}]`);const d=new nu(r,!0),p=new nu(o,!1);return new Gx(d,p,[i],[c])}replaceRightSE(e){this.rightSE=e,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}bbox(){const e=this.leftSE.point.y,t=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:e.isLessThan(t)?e:t},ur:{x:this.rightSE.point.x,y:e.isGreaterThan(t)?e:t}}}vector(){return{x:this.rightSE.point.x.minus(this.leftSE.point.x),y:this.rightSE.point.y.minus(this.leftSE.point.y)}}isAnEndpoint(e){return e.x.eq(this.leftSE.point.x)&&e.y.eq(this.leftSE.point.y)||e.x.eq(this.rightSE.point.x)&&e.y.eq(this.rightSE.point.y)}comparePoint(e){return Eh.orient(this.leftSE.point,e,this.rightSE.point)}getIntersection(e){const t=this.bbox(),i=e.bbox(),r=ZM(t,i);if(r===null)return null;const o=this.leftSE.point,c=this.rightSE.point,s=e.leftSE.point,d=e.rightSE.point,p=Tv(t,s)&&this.comparePoint(s)===0,g=Tv(i,o)&&e.comparePoint(o)===0,_=Tv(t,d)&&this.comparePoint(d)===0,x=Tv(i,c)&&e.comparePoint(c)===0;if(g&&p)return x&&!_?c:!x&&_?d:null;if(g)return _&&o.x.eq(d.x)&&o.y.eq(d.y)?null:o;if(p)return x&&c.x.eq(s.x)&&c.y.eq(s.y)?null:s;if(x&&_)return null;if(x)return c;if(_)return d;const b=oG(o,this.vector(),s,e.vector());return b===null||!Tv(r,b)?null:Eh.snap(b)}split(e){const t=[],i=e.events!==void 0,r=new nu(e,!0),o=new nu(e,!1),c=this.rightSE;this.replaceRightSE(o),t.push(o),t.push(r);const s=new Gx(r,c,this.rings.slice(),this.windings.slice());return nu.comparePoints(s.leftSE.point,s.rightSE.point)>0&&s.swapEvents(),nu.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),i&&(r.checkForConsuming(),o.checkForConsuming()),t}swapEvents(){const e=this.rightSE;this.rightSE=this.leftSE,this.leftSE=e,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(let t=0,i=this.windings.length;t<i;t++)this.windings[t]*=-1}consume(e){let t=this,i=e;for(;t.consumedBy;)t=t.consumedBy;for(;i.consumedBy;)i=i.consumedBy;const r=Gx.compare(t,i);if(r!==0){if(r>0){const o=t;t=i,i=o}if(t.prev===i){const o=t;t=i,i=o}for(let o=0,c=i.rings.length;o<c;o++){const s=i.rings[o],d=i.windings[o],p=t.rings.indexOf(s);p===-1?(t.rings.push(s),t.windings.push(d)):t.windings[p]+=d}i.rings=null,i.windings=null,i.consumedBy=t,i.leftSE.consumedBy=t.leftSE,i.rightSE.consumedBy=t.rightSE}}prevInResult(){return this._prevInResult!==void 0?this._prevInResult:(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null,this._prevInResult)}beforeState(){if(this._beforeState!==void 0)return this._beforeState;if(!this.prev)this._beforeState={rings:[],windings:[],multiPolys:[]};else{const e=this.prev.consumedBy||this.prev;this._beforeState=e.afterState()}return this._beforeState}afterState(){if(this._afterState!==void 0)return this._afterState;const e=this.beforeState();this._afterState={rings:e.rings.slice(0),windings:e.windings.slice(0),multiPolys:[]};const t=this._afterState.rings,i=this._afterState.windings,r=this._afterState.multiPolys;for(let s=0,d=this.rings.length;s<d;s++){const p=this.rings[s],g=this.windings[s],_=t.indexOf(p);_===-1?(t.push(p),i.push(g)):i[_]+=g}const o=[],c=[];for(let s=0,d=t.length;s<d;s++){if(i[s]===0)continue;const p=t[s],g=p.poly;if(c.indexOf(g)===-1)if(p.isExterior)o.push(g);else{c.indexOf(g)===-1&&c.push(g);const _=o.indexOf(p.poly);_!==-1&&o.splice(_,1)}}for(let s=0,d=o.length;s<d;s++){const p=o[s].multiPoly;r.indexOf(p)===-1&&r.push(p)}return this._afterState}isInResult(){if(this.consumedBy)return!1;if(this._isInResult!==void 0)return this._isInResult;const e=this.beforeState().multiPolys,t=this.afterState().multiPolys;switch(_w.type){case"union":{const i=e.length===0,r=t.length===0;this._isInResult=i!==r;break}case"intersection":{let i,r;e.length<t.length?(i=e.length,r=t.length):(i=t.length,r=e.length),this._isInResult=r===_w.numMultiPolys&&i<r;break}case"xor":{const i=Math.abs(e.length-t.length);this._isInResult=i%2===1;break}case"difference":{const i=r=>r.length===1&&r[0].isSubject;this._isInResult=i(e)!==i(t);break}}return this._isInResult}},VI=class{constructor(n,e,t){if(Ai(this,"poly"),Ai(this,"isExterior"),Ai(this,"segments"),Ai(this,"bbox"),!Array.isArray(n)||n.length===0)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=e,this.isExterior=t,this.segments=[],typeof n[0][0]!="number"||typeof n[0][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");const i=Eh.snap({x:new hu(n[0][0]),y:new hu(n[0][1])});this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};let r=i;for(let o=1,c=n.length;o<c;o++){if(typeof n[o][0]!="number"||typeof n[o][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");const s=Eh.snap({x:new hu(n[o][0]),y:new hu(n[o][1])});s.x.eq(r.x)&&s.y.eq(r.y)||(this.segments.push(vw.fromRing(r,s,this)),s.x.isLessThan(this.bbox.ll.x)&&(this.bbox.ll.x=s.x),s.y.isLessThan(this.bbox.ll.y)&&(this.bbox.ll.y=s.y),s.x.isGreaterThan(this.bbox.ur.x)&&(this.bbox.ur.x=s.x),s.y.isGreaterThan(this.bbox.ur.y)&&(this.bbox.ur.y=s.y),r=s)}(!i.x.eq(r.x)||!i.y.eq(r.y))&&this.segments.push(vw.fromRing(r,i,this))}getSweepEvents(){const n=[];for(let e=0,t=this.segments.length;e<t;e++){const i=this.segments[e];n.push(i.leftSE),n.push(i.rightSE)}return n}},dG=class{constructor(n,e){if(Ai(this,"multiPoly"),Ai(this,"exteriorRing"),Ai(this,"interiorRings"),Ai(this,"bbox"),!Array.isArray(n))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new VI(n[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(let t=1,i=n.length;t<i;t++){const r=new VI(n[t],this,!1);r.bbox.ll.x.isLessThan(this.bbox.ll.x)&&(this.bbox.ll.x=r.bbox.ll.x),r.bbox.ll.y.isLessThan(this.bbox.ll.y)&&(this.bbox.ll.y=r.bbox.ll.y),r.bbox.ur.x.isGreaterThan(this.bbox.ur.x)&&(this.bbox.ur.x=r.bbox.ur.x),r.bbox.ur.y.isGreaterThan(this.bbox.ur.y)&&(this.bbox.ur.y=r.bbox.ur.y),this.interiorRings.push(r)}this.multiPoly=e}getSweepEvents(){const n=this.exteriorRing.getSweepEvents();for(let e=0,t=this.interiorRings.length;e<t;e++){const i=this.interiorRings[e].getSweepEvents();for(let r=0,o=i.length;r<o;r++)n.push(i[r])}return n}},UI=class{constructor(n,e){if(Ai(this,"isSubject"),Ai(this,"polys"),Ai(this,"bbox"),!Array.isArray(n))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{typeof n[0][0][0]=="number"&&(n=[n])}catch{}this.polys=[],this.bbox={ll:{x:new hu(Number.POSITIVE_INFINITY),y:new hu(Number.POSITIVE_INFINITY)},ur:{x:new hu(Number.NEGATIVE_INFINITY),y:new hu(Number.NEGATIVE_INFINITY)}};for(let t=0,i=n.length;t<i;t++){const r=new dG(n[t],this);r.bbox.ll.x.isLessThan(this.bbox.ll.x)&&(this.bbox.ll.x=r.bbox.ll.x),r.bbox.ll.y.isLessThan(this.bbox.ll.y)&&(this.bbox.ll.y=r.bbox.ll.y),r.bbox.ur.x.isGreaterThan(this.bbox.ur.x)&&(this.bbox.ur.x=r.bbox.ur.x),r.bbox.ur.y.isGreaterThan(this.bbox.ur.y)&&(this.bbox.ur.y=r.bbox.ur.y),this.polys.push(r)}this.isSubject=e}getSweepEvents(){const n=[];for(let e=0,t=this.polys.length;e<t;e++){const i=this.polys[e].getSweepEvents();for(let r=0,o=i.length;r<o;r++)n.push(i[r])}return n}},fG=(n,...e)=>_w.run("union",n,e),pG=(n,...e)=>_w.run("difference",n,e);Eh.set;function ZF(n,e,t){if(n!==null)for(var i,r,o,c,s,d,p,g=0,_=0,x,b=n.type,S=b==="FeatureCollection",P=b==="Feature",L=S?n.features.length:1,E=0;E<L;E++){p=S?n.features[E].geometry:P?n.geometry:n,x=p?p.type==="GeometryCollection":!1,s=x?p.geometries.length:1;for(var C=0;C<s;C++){var D=0,O=0;if(c=x?p.geometries[C]:p,c!==null){d=c.coordinates;var U=c.type;switch(g=0,U){case null:break;case"Point":if(e(d,_,E,D,O)===!1)return!1;_++,D++;break;case"LineString":case"MultiPoint":for(i=0;i<d.length;i++){if(e(d[i],_,E,D,O)===!1)return!1;_++,U==="MultiPoint"&&D++}U==="LineString"&&D++;break;case"Polygon":case"MultiLineString":for(i=0;i<d.length;i++){for(r=0;r<d[i].length-g;r++){if(e(d[i][r],_,E,D,O)===!1)return!1;_++}U==="MultiLineString"&&D++,U==="Polygon"&&O++}U==="Polygon"&&D++;break;case"MultiPolygon":for(i=0;i<d.length;i++){for(O=0,r=0;r<d[i].length;r++){for(o=0;o<d[i][r].length-g;o++){if(e(d[i][r][o],_,E,D,O)===!1)return!1;_++}O++}D++}break;case"GeometryCollection":for(i=0;i<c.geometries.length;i++)if(ZF(c.geometries[i],e)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function _C(n,e){var t,i,r,o,c,s,d,p,g,_,x=0,b=n.type==="FeatureCollection",S=n.type==="Feature",P=b?n.features.length:1;for(t=0;t<P;t++){for(s=b?n.features[t].geometry:S?n.geometry:n,p=b?n.features[t].properties:S?n.properties:{},g=b?n.features[t].bbox:S?n.bbox:void 0,_=b?n.features[t].id:S?n.id:void 0,d=s?s.type==="GeometryCollection":!1,c=d?s.geometries.length:1,r=0;r<c;r++){if(o=d?s.geometries[r]:s,o===null){if(e(null,x,p,g,_)===!1)return!1;continue}switch(o.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(e(o,x,p,g,_)===!1)return!1;break}case"GeometryCollection":{for(i=0;i<o.geometries.length;i++)if(e(o.geometries[i],x,p,g,_)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}x++}}function mG(n,e){_C(n,function(t,i,r,o,c){var s=t===null?null:t.type;switch(s){case null:case"Point":case"LineString":case"Polygon":return e(Iy(t,r,{bbox:o,id:c}),i,0)===!1?!1:void 0}var d;switch(s){case"MultiPoint":d="Point";break;case"MultiLineString":d="LineString";break;case"MultiPolygon":d="Polygon";break}for(var p=0;p<t.coordinates.length;p++){var g=t.coordinates[p],_={type:d,coordinates:g};if(e(Iy(_,r),i,p)===!1)return!1}})}function gG(n,e={}){const t=[];if(_C(n,r=>{t.push(r.coordinates)}),t.length<2)throw new Error("Must have at least 2 geometries");const i=fG(t[0],...t.slice(1));return i.length===0?null:i.length===1?gC(i[0],e.properties):UF(i,e.properties)}var XF=gG;function _G(n,e={}){if(n.bbox!=null&&e.recompute!==!0)return n.bbox;const t=[1/0,1/0,-1/0,-1/0];return ZF(n,i=>{t[0]>i[0]&&(t[0]=i[0]),t[1]>i[1]&&(t[1]=i[1]),t[2]<i[0]&&(t[2]=i[0]),t[3]<i[1]&&(t[3]=i[1])}),t}var jI=_G;function vG(n){const e=[];if(_C(n,r=>{e.push(r.coordinates)}),e.length<2)throw new Error("Must have at least two features");const t=n.features[0].properties||{},i=pG(e[0],...e.slice(1));return i.length===0?null:i.length===1?gC(i[0],t):UF(i,t)}var yG=vG;function bG(n){if(!n)throw new Error("geojson is required");var e=[];return mG(n,function(t){e.push(t)}),Ry(e)}var xG=bG;function GI(n,e){const t=yG(Ry([gC([[[180,90],[-180,90],[-180,-90],[180,-90],[180,90]]]),n]));if(!t)return;t.properties={isMask:!0};const i=pw(jI(n)),r=(i[2]-i[0])/360/1e3,o=i[0]<-180,c=i[2]>180,s=xG(n);if(s.features.length>1&&(o||c))for(const d of s.features){const p=pw(jI(d));if(c&&p[0]<-180+r)for(const g of d.geometry.coordinates)for(const _ of g)_[0]+=360-r;if(o&&p[2]>180-r)for(const g of d.geometry.coordinates)for(const _ of g)_[0]-=360-r}e(Ry([s.features.length<2?n:XF(s)??n,t]))}const qI={fill:{paint:{"fill-color":"#000","fill-opacity":.1},filter:["all",["==",["geometry-type"],"Polygon"],["has","isMask"]]},line:{layout:{"line-cap":"square"},paint:{"line-width":["case",["==",["geometry-type"],"Polygon"],2,3],"line-dasharray":[1,1],"line-color":"#3170fe"},filter:["!",["has","isMask"]]}},Db="mtlr-gc-full-geom",WI="mtlr-gc-full-geom-fill",HI="mtlr-gc-full-geom-line";function wG(n,e,t=!0,i=!0,r={},o={},c=qI){let s;const d=[];let p,g,_;function x(){if(!n.loaded){n.once("load",x);return}const L=c?c===!0?qI:c:void 0;if(!(L!=null&&L.fill)&&!(L!=null&&L.line))return;const E=n.getSource(Db);if(E)E.setData(_??Ry([]));else if(_)n.addSource(Db,{type:"geojson",data:_});else return;!n.getLayer(WI)&&L!=null&&L.fill&&n.addLayer({...L?.fill,id:WI,type:"fill",source:Db}),!n.getLayer(HI)&&L!=null&&L.line&&n.addLayer({...L?.line,id:HI,type:"line",source:Db})}function b(L){_=L,x()}n.on("styledata",()=>{setTimeout(()=>{_&&x()})});const S=L=>{s?.({type:"mapClick",coordinates:[L.lngLat.lng,L.lngLat.lat]})};function P(L=!1){if(!e)throw new Error;const E=document.createElement("div");return L&&E.classList.add("marker-interactive"),new Mj({props:{displayIn:"maplibre"},target:E}),new e.Marker({element:E,offset:[1,-13]})}return{setEventHandler(L){L?(s=L,n.on("click",S)):(s=void 0,n.off("click",S))},flyTo(L,E){n.flyTo({center:L,...E?{zoom:E}:{},...r})},fitBounds(L,E,C){n.fitBounds([[L[0],L[1]],[L[2],L[3]]],{padding:E,...C?{maxZoom:C}:{},...o})},indicateReverse(L){n.getCanvasContainer().style.cursor=L?"crosshair":""},setReverseMarker(L){!e||!t||(g?L?g.setLngLat(L):(g.remove(),g=void 0):L&&(t instanceof Function?g=t(n)??void 0:(g=(typeof t=="object"?new e.Marker(t):P()).setLngLat(L).addTo(n),g.getElement().classList.add("marker-reverse"))))},setFeatures(L,E,C){for(const D of d)D.remove();if(d.length=0,b(void 0),!!e){e:if(E){let D=!1;if(E.geometry.type==="GeometryCollection"){const O=E.geometry.geometries.filter(U=>U.type==="Polygon"||U.type==="MultiPolygon");t:if(O.length>0){const U=XF(Ry(O.map(j=>Iy(j))));if(!U)break t;GI({...E,geometry:U.geometry},b),D=!0}else{const U=E.geometry.geometries.filter(j=>j.type==="LineString"||j.type==="MultiLineString");U.length>0&&(b({...E,geometry:{type:"GeometryCollection",geometries:U}}),D=!0)}}if(!D){if(E.geometry.type==="Polygon"||E.geometry.type==="MultiPolygon")GI(E,b);else if(E.geometry.type==="LineString"||E.geometry.type==="MultiLineString"){b(E);break e}}if(!C&&!E.geometry.type.endsWith("Point"))break e;if(t instanceof Function){const O=t(n,E);O&&d.push(O)}else t&&d.push(typeof t=="object"?new e.Marker(t):P().setLngLat(E.center).addTo(n))}if(i)for(const D of L??[]){if(D===E)continue;let O;if(i instanceof Function){if(O=i(n,D),!O)continue}else O=(typeof i=="object"?new e.Marker(i):P(!0)).setLngLat(D.center).setPopup(new e.Popup({offset:[1,-27],closeButton:!1,closeOnMove:!0,className:"maptiler-gc-popup"}).setText(D.place_type[0]==="reverse"?D.place_name:D.place_name.replace(/,.*/,""))).addTo(n);const U=O.getElement();U.addEventListener("click",j=>{j.stopPropagation(),s?.({type:"markerClick",id:D.id})}),U.addEventListener("mouseenter",()=>{s?.({type:"markerMouseEnter",id:D.id}),O.togglePopup()}),U.addEventListener("mouseleave",()=>{s?.({type:"markerMouseLeave",id:D.id}),O.togglePopup()}),d.push(O)}}},setSelectedMarker(L){p&&p.getElement().classList.toggle("marker-selected",!1),p=L>-1?d[L]:void 0,p?.getElement().classList.toggle("marker-selected",!0)},getCenterAndZoom(){const L=n.getCenter();return[n.getZoom(),L.lng,L.lat]}}}function SG(n,e,t){var i,r,o;class c{constructor(E,C){Ai(this,"type"),Ai(this,"target"),this.type=C,this.target=E}}class s extends c{constructor(E,C){super(E,"select"),Ai(this,"feature"),Object.assign(this,C)}}class d extends c{constructor(E,C){super(E,"featureslisted"),Ai(this,"features"),this.features=C}}class p extends c{constructor(E,C){super(E,"featuresmarked"),Ai(this,"features"),this.features=C}}class g extends c{constructor(E,C){super(E,"optionsvisibilitychange"),Ai(this,"optionsVisible"),this.optionsVisible=C}}class _ extends c{constructor(E,C){super(E,"pick"),Ai(this,"feature"),this.feature=C}}class x extends c{constructor(E,C){super(E,"querychange"),Ai(this,"query"),this.query=C}}class b extends c{constructor(E,C,D){super(E,"response"),Ai(this,"url"),Ai(this,"featureCollection"),this.url=C,this.featureCollection=D}}class S extends c{constructor(E,C){super(E,"reversetoggle"),Ai(this,"reverse"),this.reverse=C}}class P extends n{constructor(E={}){super(),KS(this,i),KS(this,r),KS(this,o),Pb(this,r,E)}onAddInt(E){const C=document.createElement("div");C.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl maplibregl-ctrl-geocoder maplibregl-ctrl mapboxgl-ctrl-group";const{marker:D,showResultMarkers:O,flyTo:U,fullGeometryStyle:j,...G}=vs(this,r),N=typeof U=="boolean"?{}:U,V={mapController:wG(E,e,D,O,N,N,j),flyTo:U===void 0?!0:!!U,apiKey:"",...G};return V.apiKey||console.warn("No MapTiler Cloud API key was provided, some or all geocoding requests may fail"),Pb(this,i,new Xj({target:C,props:V})),vs(this,i).$on("select",q=>{this.fire(new s(this,q.detail))}),vs(this,i).$on("pick",q=>{this.fire(new _(this,q.detail.feature))}),vs(this,i).$on("featureslisted",q=>{this.fire(new d(this,q.detail.features))}),vs(this,i).$on("featuresmarked",q=>{this.fire(new p(this,q.detail.features))}),vs(this,i).$on("response",q=>{this.fire(new b(this,q.detail.url,q.detail.featureCollection))}),vs(this,i).$on("optionsvisibilitychange",q=>{this.fire(new g(this,q.detail.optionsVisible))}),vs(this,i).$on("reversetoggle",q=>{this.fire(new S(this,q.detail.reverse))}),vs(this,i).$on("querychange",q=>{this.fire(new x(this,q.detail.query))}),Pb(this,o,C),C}on(E,C){return super.on(E,C)}once(E,C){return super.once(E,C)}off(E,C){return super.off(E,C)}listens(E){return super.listens(E)}setOptions(E){var C;Object.assign(vs(this,r),E);const{marker:D,showResultMarkers:O,flyTo:U,fullGeometryStyle:j,...G}=vs(this,r);(C=vs(this,i))==null||C.$set(G)}setQuery(E,C=!0){var D;(D=vs(this,i))==null||D.setQuery(E,C)}clearMap(){var E;(E=vs(this,i))==null||E.clearMap()}clearList(){var E;(E=vs(this,i))==null||E.clearList()}setReverseMode(E){var C;(C=vs(this,i))==null||C.$set({reverseActive:E})}focus(E){var C;(C=vs(this,i))==null||C.focus(E)}blur(){var E;(E=vs(this,i))==null||E.blur()}onRemove(){var E,C,D;(E=vs(this,i))==null||E.$destroy(),Pb(this,i,void 0),(D=(C=vs(this,o))==null?void 0:C.parentNode)==null||D.removeChild(vs(this,o))}}return i=new WeakMap,r=new WeakMap,o=new WeakMap,{MapLibreBasedGeocodingControl:P,events:{SelectEvent:s,FeaturesListedEvent:d,FeaturesMarkedEvent:p,OptionsVisibilityChangeEvent:g,PickEvent:_,QueryChangeEvent:x,ResponseEvent:b,ReverseToggleEvent:S}}}const{MapLibreBasedGeocodingControl:TG}=SG(uC.Evented,M8);class MG extends TG{onAdd(e){return super.onAddInt(e)}}function CG(n,e){en(e,!0);let t=ii(void 0),i=["continental_marine","country","major_landform","region","subregion","county","joint_municipality","joint_submunicipality","municipality","municipal_district","locality","neighbourhood","place","postal_code","address","road","poi"];Ta(()=>{ee(t)&&(e.map?.removeControl(ee(t)),Et(t,void 0))}),cn(()=>{e.map&&e.loaded&&!ee(t)&&(Et(t,new MG({apiKey:xd,maplibregl:Lo,proximity:[{type:"map-center"}],types:i,country:e.country,marker:!0,showResultMarkers:!0,flyToOptions:{duration:1e3},fitBoundsOptions:{duration:1e3}}),!0),e.map.addControl(ee(t),"top-left"))}),tn()}ds(["click"]);var EG=Wt("<!> <!>",1);function AG(n,e){en(e,!0),cn(()=>{e.map&&(e.map.keyboard.disableRotation(),e.map.dragRotate.disable(),e.map.touchZoomRotate.disableRotation())});var t=EG(),i=ci(t);mF(i,{showCompass:!1});var r=gt(i,2);gF(r,{}),xt(n,t),tn()}const YM=["==",["geometry-type"],"LineString"],YF=["==",["geometry-type"],"Point"];function Ly(n,e,t){let i=["match",n];for(let[r,o]of Object.entries(e))i.push(r),i.push(o);return i.push(t),i}function ro(){return{type:"FeatureCollection",features:[]}}function KF(n){return BU(n)}let xd="MZEJTanw3WpxRvt7qDfo",ZI=`https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=${xd}`,op=new s8([["Blank",{version:8,sources:{},layers:[],glyphs:ZI}],["Maptiler Streets",`https://api.maptiler.com/maps/streets-v2/style.json?key=${xd}`],["Maptiler Dataviz",`https://api.maptiler.com/maps/dataviz/style.json?key=${xd}`],["Maptiler Dark",`https://api.maptiler.com/maps/dataviz-dark/style.json?key=${xd}`],["Maptiler Hybrid",`https://api.maptiler.com/maps/hybrid/style.json?key=${xd}`],["Maptiler OpenStreetMap",`https://api.maptiler.com/maps/openstreetmap/style.json?key=${xd}`],["Maptiler OS Open Zoomstack",`https://api.maptiler.com/maps/uk-openzoomstack-light/style.json?key=${xd}`],["ESRI World Imagery",{version:8,sources:{"raster-tiles":{type:"raster",tiles:["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],tileSize:256,attribution:"ESRI &copy; <a href='https://www.esri.com' target='_blank'>ESRI</a>",minzoom:0,maxzoom:18}},layers:[{id:"raster-basemap",type:"raster",source:"raster-tiles"}],glyphs:ZI}]]);var PG=Wt('<div class="form-check"><label class="form-check-label"><input class="form-check-input" type="checkbox"/> <!></label></div>');function ls(n,e){en(e,!0);let t=ft(e,"checked",15);var i=PG(),r=Ft(i),o=Ft(r),c=gt(o,2);hs(c,()=>e.children??is),O6(o,t),xt(n,i),tn()}var IG=Wt("<div><progress></progress></div>"),RG=Wt('<div class="cover svelte-ca01h2"> <!></div>');function Jd(n,e){let t=ft(e,"progress",3,null);var i=ir(),r=ci(i);{var o=c=>{var s=RG(),d=Ft(s),p=gt(d);{var g=_=>{var x=IG(),b=Ft(x);go(b,"",{},{width:"100%"}),Zi(()=>D6(b,t())),xt(_,x)};Ki(p,_=>{t()!=null&&_(g)})}Zi(()=>ln(d,`${e.loading??""} `)),xt(c,s)};Ki(r,c=>{e.loading&&c(o)})}xt(n,i)}var LG=Wt('<div style="display: flex; align-items: center; gap: 6px;"><!> <i class="fa-solid fa-hard-drive" style="font-size: 0.85em; color: #6c757d; cursor: help; flex-shrink: 0;" title="This setting is saved locally" aria-label="This setting is saved locally"></i></div>');function n1(n,e){var t=LG(),i=Ft(t);hs(i,()=>e.children),xt(n,t)}var kG=Wt('<dialog closedby="none" class="svelte-1f8bzsb"><div class="svelte-1f8bzsb"><!></div></dialog>');function _p(n,e){en(e,!0);let t=ft(e,"show",15,!1),i=ft(e,"closeable",3,!0),r=ii(void 0);cn(()=>{ee(r)&&(t()?ee(r).showModal():ee(r).close())});function o(g){g.target==ee(r)&&(g.stopPropagation(),i()&&t(!1))}function c(g){(g.key=="Escape"||g.key=="Enter")&&(g.stopPropagation(),i()&&t(!1))}var s=kG();s.__click=o,s.__keydown=c;var d=Ft(s),p=Ft(d);hs(p,()=>e.children),Sc(s,g=>Et(r,g),()=>ee(r)),xt(n,s),tn()}ds(["click","keydown"]);var DG=Wt('<div style="display: flex; align-items: center; gap: 6px;"><span></span> </div>'),FG=Wt("<div></div>");function vC(n,e){let t=ft(e,"swatchClass",3,"rectangle"),i=ft(e,"itemsPerRow",3,2),r=Kt(()=>`${100/i()}%`);var o=FG();Ys(o,21,()=>Object.entries(e.labelColors),Xs,(c,s)=>{var d=Kt(()=>xc(ee(s),2));let p=()=>ee(d)[0],g=()=>ee(d)[1];var _=DG(),x=Ft(_);let b;var S=gt(x);Zi(()=>{Ds(x,1,`color-swatch ${t()??""}`,"svelte-kgsne0"),b=go(x,"",b,{background:g()}),ln(S,` ${p()??""}`)}),xt(c,_)}),Zi(()=>go(o,`display: grid; grid-template-columns: repeat(auto-fill, calc(${ee(r)??""} - 10px)); gap: 10px;`)),xt(n,o)}function h0(n,e){let t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download",n),document.body.appendChild(t),t.click(),document.body.removeChild(t)}function yC(n,e){let t=e;try{const r=localStorage.getItem(n);r!==null&&(t=JSON.parse(r))}catch(r){console.warn(`Failed to read ${n} from localStorage:`,r)}const i=Ic(t);return i.subscribe(r=>{try{localStorage.setItem(n,JSON.stringify(r))}catch(o){o instanceof DOMException&&o.name==="QuotaExceededError"?console.warn(`localStorage quota exceeded for ${n}`):console.warn(`Failed to write ${n} to localStorage:`,o)}}),i}var OG=Wt('<button class="btn btn-primary" type="button">Import current view</button> <p class="fst-italic my-3">or...</p> <button class="btn btn-primary" type="button">Draw an area to import on the map</button> <!>',1),zG=Wt('<div><label class="form-label">Load an osm.pbf or osm.xml file <input class="form-control" type="file"/></label></div> <p class="fst-italic my-3">or...</p> <!> <hr class="my-3"/> <!> <!>',1);function BG(n,e){en(e,!0);const t=()=>Qi(ky,"$saveCopy",i),[i,r]=qr();let o=ii(null),c=ii(void 0);async function s(j){try{e.onloading?.("Loading from file");let G=await ee(c).files[0].arrayBuffer();e.onload(new Uint8Array(G),null)}catch(G){e.onerror?.(`Bad input file: ${G}`)}}async function d(j){try{e.onloading?.("Loading from Overpass");let G=await r1(bC(j));if(!G.ok)throw new Error(`Overpass response is not OK: ${G.status}. The API is often overloaded; try again in a few seconds.`);let N=await G.bytes();if(t()){let V=new TextDecoder().decode(N);h0("osm.xml",V)}e.onload(new Uint8Array(N),j)}catch(G){e.onerror?.(G.toString())}}function p(j){return[j.lng,j.lat]}function g(){let j=e.map.getBounds();return{type:"Feature",properties:{},geometry:{coordinates:[[p(j.getSouthWest()),p(j.getNorthWest()),p(j.getNorthEast()),p(j.getSouthEast()),p(j.getSouthWest())]],type:"Polygon"}}}async function _(){if(e.map){if(e.map.getZoom()<13){e.onerror?.("Zoom in more to import");return}await d(g())}}function x(){e.map&&(Et(o,new e8(e.map),!0),ee(o).startNew(),ee(o).addEventListenerSuccess(async j=>{Et(o,null),await d(j)}),ee(o).addEventListenerFailure(()=>{Et(o,null)}))}var b=zG(),S=ci(b),P=Ft(S),L=gt(Ft(P));L.__change=s,Sc(L,j=>Et(c,j),()=>ee(c));var E=gt(S,4);{var C=j=>{i8(j,{get polygonTool(){return ee(o)}})},D=j=>{var G=OG(),N=ci(G);N.__click=_;var V=gt(N,4);V.__click=x;var q=gt(V,2);hs(q,()=>e.children??is),xt(j,G)};Ki(E,j=>{ee(o)?j(C):j(D,!1)})}var O=gt(E,4);n1(O,{children:(j,G)=>{ls(j,{get checked(){return X2(),t()},set checked(N){Do(ky,N)},children:(N,V)=>{var q=Vn("Save a copy of the osm.xml after importing");xt(N,q)},$$slots:{default:!0}})}});var U=gt(O,2);JF(U),xt(n,b),tn(),r()}ds(["change","click"]);var NG=Wt('<div class="form-check"><input class="form-check-input" type="radio" name="overpass-server"/> <label class="form-check-label"> </label></div>'),$G=Wt('<details class="mt-3"><summary>Change Overpass server</summary> <div class="mt-2"></div></details>');function JF(n){const e=()=>Qi(KM,"$overpassServer",t),[t,i]=qr(),r=[];var o=$G(),c=gt(Ft(o),2);Ys(c,5,()=>UG,Xs,(s,d)=>{var p=NG(),g=Ft(p),_,x=gt(g,2),b=Ft(x);Zi(()=>{Nl(g,"id",`server-${ee(d)??""}`),_!==(_=ee(d))&&(g.value=(g.__value=ee(d))??""),Nl(x,"for",`server-${ee(d)??""}`),ln(b,ee(d))}),Bx(r,[],g,()=>(ee(d),e()),S=>Do(KM,S)),xt(s,p)}),xt(n,o),i()}function bC(n){let e='poly:"';if(n.geometry.type=="Polygon")for(let[t,i]of n.geometry.coordinates[0])e+=`${i} ${t} `;else if(n.geometry.type=="MultiPolygon")for(let[t,i]of n.geometry.coordinates[0][0])e+=`${i} ${t} `;else throw new Error("overpassQueryForPolygon needs a Polygon or MultiPolygon");return e=e.slice(0,-1)+'"',`(nwr(${e}); node(w)->.x; <;); out meta;`}const VG="https://overpass-api.de/api/",UG=["https://overpass-api.de/api/","https://maps.mail.ru/osm/tools/overpass/api/","https://overpass.openstreetmap.ru/api/","https://overpass.kumi.systems/api/"],KM=yC("overpass-server",VG),ky=yC("save-osm-copy",!1);async function r1(n){let e=await fetch(`${Z2(KM)}interpreter`,{method:"POST",body:n,headers:{"Content-Type":"text/plain"}});if(!e.ok)throw e.status===504?new Error("Overpass API timed out. The query might be too large. Try again later or switch to a different Overpass server."):new Error(`Overpass failed: ${e.status}. Try again or switch to a different Overpass server.`);return e}let zi,Hv=null;function Ag(){return(Hv===null||Hv.byteLength===0)&&(Hv=new Uint8Array(zi.memory.buffer)),Hv}let qx=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});qx.decode();const jG=2146435072;let tT=0;function GG(n,e){return tT+=e,tT>=jG&&(qx=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),qx.decode(),tT=e),qx.decode(Ag().subarray(n,n+e))}function mo(n,e){return n=n>>>0,GG(n,e)}function wd(n){return n==null}let Zf=null;function Qc(){return(Zf===null||Zf.buffer.detached===!0||Zf.buffer.detached===void 0&&Zf.buffer!==zi.memory.buffer)&&(Zf=new DataView(zi.memory.buffer)),Zf}function JM(n){const e=typeof n;if(e=="number"||e=="boolean"||n==null)return`${n}`;if(e=="string")return`"${n}"`;if(e=="symbol"){const r=n.description;return r==null?"Symbol":`Symbol(${r})`}if(e=="function"){const r=n.name;return typeof r=="string"&&r.length>0?`Function(${r})`:"Function"}if(Array.isArray(n)){const r=n.length;let o="[";r>0&&(o+=JM(n[0]));for(let c=1;c<r;c++)o+=", "+JM(n[c]);return o+="]",o}const t=/\[object ([^\]]+)\]/.exec(toString.call(n));let i;if(t&&t.length>1)i=t[1];else return toString.call(n);if(i=="Object")try{return"Object("+JSON.stringify(n)+")"}catch{return"Object"}return n instanceof Error?`${n.name}: ${n.message}
${n.stack}`:i}let ap=0;const dy=new TextEncoder;"encodeInto"in dy||(dy.encodeInto=function(n,e){const t=dy.encode(n);return e.set(t),{read:n.length,written:t.length}});function iT(n,e,t){if(t===void 0){const s=dy.encode(n),d=e(s.length,1)>>>0;return Ag().subarray(d,d+s.length).set(s),ap=s.length,d}let i=n.length,r=e(i,1)>>>0;const o=Ag();let c=0;for(;c<i;c++){const s=n.charCodeAt(c);if(s>127)break;o[r+c]=s}if(c!==i){c!==0&&(n=n.slice(c)),r=t(r,i,i=c+n.length*3,1)>>>0;const s=Ag().subarray(r+c,r+i),d=dy.encodeInto(n,s);c+=d.written,r=t(r,i,c,1)>>>0}return ap=c,r}function qG(n){const e=zi.__externref_table_alloc();return zi.__wbindgen_externrefs.set(e,n),e}function nT(n,e){try{return n.apply(this,e)}catch(t){const i=qG(t);zi.__wbindgen_exn_store(i)}}function WG(n,e){return n=n>>>0,Ag().subarray(n/1,n/1+e)}function ks(n){const e=zi.__wbindgen_externrefs.get(n);return zi.__externref_table_dealloc(n),e}function HG(n,e){const t=e(n.length*1,1)>>>0;return Ag().set(n,t/1),ap=n.length,t}const XI=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>zi.__wbg_speedwalk_free(n>>>0,1));class Dy{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,XI.unregister(this),e}free(){const e=this.__destroy_into_raw();zi.__wbg_speedwalk_free(e,0)}get timestamp(){const e=zi.__wbg_get_speedwalk_timestamp(this.__wbg_ptr);return e[0]===0?void 0:e[1]}set timestamp(e){zi.__wbg_set_speedwalk_timestamp(this.__wbg_ptr,!wd(e),wd(e)?BigInt(0):e)}editClear(){zi.speedwalk_editClear(this.__wbg_ptr)}getMetrics(){let e,t;try{const o=zi.speedwalk_getMetrics(this.__wbg_ptr);var i=o[0],r=o[1];if(o[3])throw i=0,r=0,ks(o[2]);return e=i,t=r,mo(i,r)}finally{zi.__wbindgen_free(e,t,1)}}getBoundary(){let e,t;try{const o=zi.speedwalk_getBoundary(this.__wbg_ptr);var i=o[0],r=o[1];if(o[3])throw i=0,r=0,ks(o[2]);return e=i,t=r,mo(i,r)}finally{zi.__wbindgen_free(e,t,1)}}editSetTags(e,t){const i=zi.speedwalk_editSetTags(this.__wbg_ptr,e,t);if(i[1])throw ks(i[0])}getRoadSides(){let e,t;try{const o=zi.speedwalk_getRoadSides(this.__wbg_ptr);var i=o[0],r=o[1];if(o[3])throw i=0,r=0,ks(o[2]);return e=i,t=r,mo(i,r)}finally{zi.__wbindgen_free(e,t,1)}}editAssumeTags(e){const t=zi.speedwalk_editAssumeTags(this.__wbg_ptr,e);if(t[1])throw ks(t[0])}getOsmTimestamp(){const e=zi.speedwalk_getOsmTimestamp(this.__wbg_ptr);return e[0]===0?void 0:e[1]}toOsmChangeJson(){let e,t;try{const o=zi.speedwalk_toOsmChangeJson(this.__wbg_ptr);var i=o[0],r=o[1];if(o[3])throw i=0,r=0,ks(o[2]);return e=i,t=r,mo(i,r)}finally{zi.__wbindgen_free(e,t,1)}}getSideLocations(e){let t,i;try{const c=zi.speedwalk_getSideLocations(this.__wbg_ptr,e);var r=c[0],o=c[1];if(c[3])throw r=0,o=0,ks(c[2]);return t=r,i=o,mo(r,o)}finally{zi.__wbindgen_free(t,i,1)}}exportNetwork(e){let t,i;try{const c=zi.speedwalk_exportNetwork(this.__wbg_ptr,e);var r=c[0],o=c[1];if(c[3])throw r=0,o=0,ks(c[2]);return t=r,i=o,mo(r,o)}finally{zi.__wbindgen_free(t,i,1)}}auditCrossings(e){let t,i;try{const c=zi.speedwalk_auditCrossings(this.__wbg_ptr,e);var r=c[0],o=c[1];if(c[3])throw r=0,o=0,ks(c[2]);return t=r,i=o,mo(r,o)}finally{zi.__wbindgen_free(t,i,1)}}editAddNewCrossing(e,t){const i=zi.speedwalk_editAddNewCrossing(this.__wbg_ptr,e,t);if(i[1])throw ks(i[0])}editMakeAllSidewalks(e){const t=zi.speedwalk_editMakeAllSidewalks(this.__wbg_ptr,e);if(t[1])throw ks(t[0])}normalizeSidewalkTags(e){let t,i;try{const c=zi.speedwalk_normalizeSidewalkTags(this.__wbg_ptr,e);var r=c[0],o=c[1];if(c[3])throw r=0,o=0,ks(c[2]);return t=r,i=o,mo(r,o)}finally{zi.__wbindgen_free(t,i,1)}}editConnectAllCrossings(e){const t=zi.speedwalk_editConnectAllCrossings(this.__wbg_ptr,e);if(t[1])throw ks(t[0])}findConnectedComponents(e){let t,i;try{const c=zi.speedwalk_findConnectedComponents(this.__wbg_ptr,e);var r=c[0],o=c[1];if(c[3])throw r=0,o=0,ks(c[2]);return t=r,i=o,mo(r,o)}finally{zi.__wbindgen_free(t,i,1)}}editGenerateMissingCrossings(e){const t=zi.speedwalk_editGenerateMissingCrossings(this.__wbg_ptr,e);if(t[1])throw ks(t[0])}constructor(e,t){const i=HG(e,zi.__wbindgen_malloc),r=ap,o=zi.speedwalk_new(i,r,t);if(o[2])throw ks(o[1]);return this.__wbg_ptr=o[0]>>>0,XI.register(this,this.__wbg_ptr,this),this}toOsc(){let e,t;try{const i=zi.speedwalk_toOsc(this.__wbg_ptr);return e=i[0],t=i[1],mo(i[0],i[1])}finally{zi.__wbindgen_free(e,t,1)}}getWays(){let e,t;try{const o=zi.speedwalk_getWays(this.__wbg_ptr);var i=o[0],r=o[1];if(o[3])throw i=0,r=0,ks(o[2]);return e=i,t=r,mo(i,r)}finally{zi.__wbindgen_free(e,t,1)}}editUndo(){const e=zi.speedwalk_editUndo(this.__wbg_ptr);if(e[1])throw ks(e[0])}getEdits(){let e,t;try{const o=zi.speedwalk_getEdits(this.__wbg_ptr);var i=o[0],r=o[1];if(o[3])throw i=0,r=0,ks(o[2]);return e=i,t=r,mo(i,r)}finally{zi.__wbindgen_free(e,t,1)}}getNodes(){let e,t;try{const o=zi.speedwalk_getNodes(this.__wbg_ptr);var i=o[0],r=o[1];if(o[3])throw i=0,r=0,ks(o[2]);return e=i,t=r,mo(i,r)}finally{zi.__wbindgen_free(e,t,1)}}}Symbol.dispose&&(Dy.prototype[Symbol.dispose]=Dy.prototype.free);const ZG=new Set(["basic","cors","default"]);async function XG(n,e){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,e)}catch(i){if(n.ok&&ZG.has(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",i);else throw i}const t=await n.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(n,e);return t instanceof WebAssembly.Instance?{instance:t,module:n}:t}}function YG(){const n={};return n.wbg={},n.wbg.__wbg_Error_e83987f665cf5504=function(e,t){return Error(mo(e,t))},n.wbg.__wbg___wbindgen_bigint_get_as_i64_f3ebc5a755000afd=function(e,t){const i=t,r=typeof i=="bigint"?i:void 0;Qc().setBigInt64(e+8,wd(r)?BigInt(0):r,!0),Qc().setInt32(e+0,!wd(r),!0)},n.wbg.__wbg___wbindgen_boolean_get_6d5a1ee65bab5f68=function(e){const t=e,i=typeof t=="boolean"?t:void 0;return wd(i)?16777215:i?1:0},n.wbg.__wbg___wbindgen_debug_string_df47ffb5e35e6763=function(e,t){const i=JM(t),r=iT(i,zi.__wbindgen_malloc,zi.__wbindgen_realloc),o=ap;Qc().setInt32(e+4,o,!0),Qc().setInt32(e+0,r,!0)},n.wbg.__wbg___wbindgen_in_bb933bd9e1b3bc0f=function(e,t){return e in t},n.wbg.__wbg___wbindgen_is_bigint_cb320707dcd35f0b=function(e){return typeof e=="bigint"},n.wbg.__wbg___wbindgen_is_function_ee8a6c5833c90377=function(e){return typeof e=="function"},n.wbg.__wbg___wbindgen_is_object_c818261d21f283a4=function(e){const t=e;return typeof t=="object"&&t!==null},n.wbg.__wbg___wbindgen_is_string_fbb76cb2940daafd=function(e){return typeof e=="string"},n.wbg.__wbg___wbindgen_is_undefined_2d472862bd29a478=function(e){return e===void 0},n.wbg.__wbg___wbindgen_jsval_eq_6b13ab83478b1c50=function(e,t){return e===t},n.wbg.__wbg___wbindgen_jsval_loose_eq_b664b38a2f582147=function(e,t){return e==t},n.wbg.__wbg___wbindgen_number_get_a20bf9b85341449d=function(e,t){const i=t,r=typeof i=="number"?i:void 0;Qc().setFloat64(e+8,wd(r)?0:r,!0),Qc().setInt32(e+0,!wd(r),!0)},n.wbg.__wbg___wbindgen_string_get_e4f06c90489ad01b=function(e,t){const i=t,r=typeof i=="string"?i:void 0;var o=wd(r)?0:iT(r,zi.__wbindgen_malloc,zi.__wbindgen_realloc),c=ap;Qc().setInt32(e+4,c,!0),Qc().setInt32(e+0,o,!0)},n.wbg.__wbg___wbindgen_throw_b855445ff6a94295=function(e,t){throw new Error(mo(e,t))},n.wbg.__wbg_call_e762c39fa8ea36bf=function(){return nT(function(e,t){return e.call(t)},arguments)},n.wbg.__wbg_debug_f4b0c59db649db48=function(e){console.debug(e)},n.wbg.__wbg_done_2042aa2670fb1db1=function(e){return e.done},n.wbg.__wbg_entries_e171b586f8f6bdbf=function(e){return Object.entries(e)},n.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let i,r;try{i=e,r=t,console.error(mo(e,t))}finally{zi.__wbindgen_free(i,r,1)}},n.wbg.__wbg_error_a7f8fbb0523dae15=function(e){console.error(e)},n.wbg.__wbg_get_7bed016f185add81=function(e,t){return e[t>>>0]},n.wbg.__wbg_get_efcb449f58ec27c2=function(){return nT(function(e,t){return Reflect.get(e,t)},arguments)},n.wbg.__wbg_get_with_ref_key_1dc361bd10053bfe=function(e,t){return e[t]},n.wbg.__wbg_info_e674a11f4f50cc0c=function(e){console.info(e)},n.wbg.__wbg_instanceof_ArrayBuffer_70beb1189ca63b38=function(e){let t;try{t=e instanceof ArrayBuffer}catch{t=!1}return t},n.wbg.__wbg_instanceof_Map_8579b5e2ab5437c7=function(e){let t;try{t=e instanceof Map}catch{t=!1}return t},n.wbg.__wbg_instanceof_Uint8Array_20c8e73002f7af98=function(e){let t;try{t=e instanceof Uint8Array}catch{t=!1}return t},n.wbg.__wbg_isArray_96e0af9891d0945d=function(e){return Array.isArray(e)},n.wbg.__wbg_isSafeInteger_d216eda7911dde36=function(e){return Number.isSafeInteger(e)},n.wbg.__wbg_iterator_e5822695327a3c39=function(){return Symbol.iterator},n.wbg.__wbg_length_69bca3cb64fc8748=function(e){return e.length},n.wbg.__wbg_length_cdd215e10d9dd507=function(e){return e.length},n.wbg.__wbg_log_8cec76766b8c0e33=function(e){console.log(e)},n.wbg.__wbg_new_5a79be3ab53b8aa5=function(e){return new Uint8Array(e)},n.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},n.wbg.__wbg_next_020810e0ae8ebcb0=function(){return nT(function(e){return e.next()},arguments)},n.wbg.__wbg_next_2c826fe5dfec6b6a=function(e){return e.next},n.wbg.__wbg_prototypesetcall_2a6620b6922694b2=function(e,t,i){Uint8Array.prototype.set.call(WG(e,t),i)},n.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const i=t.stack,r=iT(i,zi.__wbindgen_malloc,zi.__wbindgen_realloc),o=ap;Qc().setInt32(e+4,o,!0),Qc().setInt32(e+0,r,!0)},n.wbg.__wbg_value_692627309814bb8c=function(e){return e.value},n.wbg.__wbg_warn_1d74dddbe2fd1dbb=function(e){console.warn(e)},n.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,t){return mo(e,t)},n.wbg.__wbindgen_cast_4625c577ab2ec9ee=function(e){return BigInt.asUintN(64,e)},n.wbg.__wbindgen_cast_9ae0607507abb057=function(e){return e},n.wbg.__wbindgen_init_externref_table=function(){const e=zi.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},n}function KG(n,e){return zi=n.exports,QF.__wbindgen_wasm_module=e,Zf=null,Hv=null,zi.__wbindgen_start(),zi}async function QF(n){if(zi!==void 0)return zi;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof n>"u"&&(n=new URL("/speedwalk/assets/backend_bg-CKCXLp4W.wasm",import.meta.url));const e=YG();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:t,module:i}=await XG(await n,e);return KG(t,i)}let Fh=Ic(null),zs=Ic(null),sa=Ic(0),yw=Ic(!1),fy=Ic(),QM=Ic({kind:"sidewalks"}),bw=yC("speedwalk-enabledBulkOps",!1),xw=Ic(!1),Yf=Ic({include:"OnlyExplicitFootways",ignore_deadends:!0});function JG(n){return n.reduce((e,t)=>e+t,0)}function ww(n){return n<1e3?Math.round(n)+" m":(n/1e3).toFixed(1)+" km"}async function al(){await new Promise(n=>{requestAnimationFrame(()=>{requestAnimationFrame(n)})})}let YI=new Set(op.keys());function QG(n,e,t={}){const i={type:"Feature"};return(t.id===0||t.id)&&(i.id=t.id),t.bbox&&(i.bbox=t.bbox),i.properties={},i.geometry=n,i}function eq(n,e,t={}){for(const r of n){if(r.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(r[r.length-1].length!==r[0].length)throw new Error("First and last Position are not equivalent.");for(let o=0;o<r[r.length-1].length;o++)if(r[r.length-1][o]!==r[0][o])throw new Error("First and last Position are not equivalent.")}return QG({type:"Polygon",coordinates:n},e,t)}function eO(n,e,t){if(n!==null)for(var i,r,o,c,s,d,p,g=0,_=0,x,b=n.type,S=b==="FeatureCollection",P=b==="Feature",L=S?n.features.length:1,E=0;E<L;E++){p=S?n.features[E].geometry:P?n.geometry:n,x=p?p.type==="GeometryCollection":!1,s=x?p.geometries.length:1;for(var C=0;C<s;C++){var D=0,O=0;if(c=x?p.geometries[C]:p,c!==null){d=c.coordinates;var U=c.type;switch(g=0,U){case null:break;case"Point":if(e(d,_,E,D,O)===!1)return!1;_++,D++;break;case"LineString":case"MultiPoint":for(i=0;i<d.length;i++){if(e(d[i],_,E,D,O)===!1)return!1;_++,U==="MultiPoint"&&D++}U==="LineString"&&D++;break;case"Polygon":case"MultiLineString":for(i=0;i<d.length;i++){for(r=0;r<d[i].length-g;r++){if(e(d[i][r],_,E,D,O)===!1)return!1;_++}U==="MultiLineString"&&D++,U==="Polygon"&&O++}U==="Polygon"&&D++;break;case"MultiPolygon":for(i=0;i<d.length;i++){for(O=0,r=0;r<d[i].length;r++){for(o=0;o<d[i][r].length-g;o++){if(e(d[i][r][o],_,E,D,O)===!1)return!1;_++}O++}D++}break;case"GeometryCollection":for(i=0;i<c.geometries.length;i++)if(eO(c.geometries[i],e)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}var Fb={exports:{}},Wx={exports:{}},tq=Wx.exports,KI;function iq(){return KI||(KI=1,(function(n,e){(function(t,i){n.exports=i()})(tq,function(){function t(C,D,O,U,j){(function G(N,V,q,z,Q){for(;z>q;){if(z-q>600){var X=z-q+1,re=V-q+1,oe=Math.log(X),de=.5*Math.exp(2*oe/3),ce=.5*Math.sqrt(oe*de*(X-de)/X)*(re-X/2<0?-1:1),Se=Math.max(q,Math.floor(V-re*de/X+ce)),Pe=Math.min(z,Math.floor(V+(X-re)*de/X+ce));G(N,V,Se,Pe,Q)}var je=N[V],Fe=q,qe=z;for(i(N,q,V),Q(N[z],je)>0&&i(N,q,z);Fe<qe;){for(i(N,Fe,qe),Fe++,qe--;Q(N[Fe],je)<0;)Fe++;for(;Q(N[qe],je)>0;)qe--}Q(N[q],je)===0?i(N,q,qe):i(N,++qe,z),qe<=V&&(q=qe+1),V<=qe&&(z=qe-1)}})(C,D,O||0,U||C.length-1,j||r)}function i(C,D,O){var U=C[D];C[D]=C[O],C[O]=U}function r(C,D){return C<D?-1:C>D?1:0}var o=function(C){C===void 0&&(C=9),this._maxEntries=Math.max(4,C),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function c(C,D,O){if(!O)return D.indexOf(C);for(var U=0;U<D.length;U++)if(O(C,D[U]))return U;return-1}function s(C,D){d(C,0,C.children.length,D,C)}function d(C,D,O,U,j){j||(j=L(null)),j.minX=1/0,j.minY=1/0,j.maxX=-1/0,j.maxY=-1/0;for(var G=D;G<O;G++){var N=C.children[G];p(j,C.leaf?U(N):N)}return j}function p(C,D){return C.minX=Math.min(C.minX,D.minX),C.minY=Math.min(C.minY,D.minY),C.maxX=Math.max(C.maxX,D.maxX),C.maxY=Math.max(C.maxY,D.maxY),C}function g(C,D){return C.minX-D.minX}function _(C,D){return C.minY-D.minY}function x(C){return(C.maxX-C.minX)*(C.maxY-C.minY)}function b(C){return C.maxX-C.minX+(C.maxY-C.minY)}function S(C,D){return C.minX<=D.minX&&C.minY<=D.minY&&D.maxX<=C.maxX&&D.maxY<=C.maxY}function P(C,D){return D.minX<=C.maxX&&D.minY<=C.maxY&&D.maxX>=C.minX&&D.maxY>=C.minY}function L(C){return{children:C,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function E(C,D,O,U,j){for(var G=[D,O];G.length;)if(!((O=G.pop())-(D=G.pop())<=U)){var N=D+Math.ceil((O-D)/U/2)*U;t(C,N,D,O,j),G.push(D,N,N,O)}}return o.prototype.all=function(){return this._all(this.data,[])},o.prototype.search=function(C){var D=this.data,O=[];if(!P(C,D))return O;for(var U=this.toBBox,j=[];D;){for(var G=0;G<D.children.length;G++){var N=D.children[G],V=D.leaf?U(N):N;P(C,V)&&(D.leaf?O.push(N):S(C,V)?this._all(N,O):j.push(N))}D=j.pop()}return O},o.prototype.collides=function(C){var D=this.data;if(!P(C,D))return!1;for(var O=[];D;){for(var U=0;U<D.children.length;U++){var j=D.children[U],G=D.leaf?this.toBBox(j):j;if(P(C,G)){if(D.leaf||S(C,G))return!0;O.push(j)}}D=O.pop()}return!1},o.prototype.load=function(C){if(!C||!C.length)return this;if(C.length<this._minEntries){for(var D=0;D<C.length;D++)this.insert(C[D]);return this}var O=this._build(C.slice(),0,C.length-1,0);if(this.data.children.length)if(this.data.height===O.height)this._splitRoot(this.data,O);else{if(this.data.height<O.height){var U=this.data;this.data=O,O=U}this._insert(O,this.data.height-O.height-1,!0)}else this.data=O;return this},o.prototype.insert=function(C){return C&&this._insert(C,this.data.height-1),this},o.prototype.clear=function(){return this.data=L([]),this},o.prototype.remove=function(C,D){if(!C)return this;for(var O,U,j,G=this.data,N=this.toBBox(C),V=[],q=[];G||V.length;){if(G||(G=V.pop(),U=V[V.length-1],O=q.pop(),j=!0),G.leaf){var z=c(C,G.children,D);if(z!==-1)return G.children.splice(z,1),V.push(G),this._condense(V),this}j||G.leaf||!S(G,N)?U?(O++,G=U.children[O],j=!1):G=null:(V.push(G),q.push(O),O=0,U=G,G=G.children[0])}return this},o.prototype.toBBox=function(C){return C},o.prototype.compareMinX=function(C,D){return C.minX-D.minX},o.prototype.compareMinY=function(C,D){return C.minY-D.minY},o.prototype.toJSON=function(){return this.data},o.prototype.fromJSON=function(C){return this.data=C,this},o.prototype._all=function(C,D){for(var O=[];C;)C.leaf?D.push.apply(D,C.children):O.push.apply(O,C.children),C=O.pop();return D},o.prototype._build=function(C,D,O,U){var j,G=O-D+1,N=this._maxEntries;if(G<=N)return s(j=L(C.slice(D,O+1)),this.toBBox),j;U||(U=Math.ceil(Math.log(G)/Math.log(N)),N=Math.ceil(G/Math.pow(N,U-1))),(j=L([])).leaf=!1,j.height=U;var V=Math.ceil(G/N),q=V*Math.ceil(Math.sqrt(N));E(C,D,O,q,this.compareMinX);for(var z=D;z<=O;z+=q){var Q=Math.min(z+q-1,O);E(C,z,Q,V,this.compareMinY);for(var X=z;X<=Q;X+=V){var re=Math.min(X+V-1,Q);j.children.push(this._build(C,X,re,U-1))}}return s(j,this.toBBox),j},o.prototype._chooseSubtree=function(C,D,O,U){for(;U.push(D),!D.leaf&&U.length-1!==O;){for(var j=1/0,G=1/0,N=void 0,V=0;V<D.children.length;V++){var q=D.children[V],z=x(q),Q=(X=C,re=q,(Math.max(re.maxX,X.maxX)-Math.min(re.minX,X.minX))*(Math.max(re.maxY,X.maxY)-Math.min(re.minY,X.minY))-z);Q<G?(G=Q,j=z<j?z:j,N=q):Q===G&&z<j&&(j=z,N=q)}D=N||D.children[0]}var X,re;return D},o.prototype._insert=function(C,D,O){var U=O?C:this.toBBox(C),j=[],G=this._chooseSubtree(U,this.data,D,j);for(G.children.push(C),p(G,U);D>=0&&j[D].children.length>this._maxEntries;)this._split(j,D),D--;this._adjustParentBBoxes(U,j,D)},o.prototype._split=function(C,D){var O=C[D],U=O.children.length,j=this._minEntries;this._chooseSplitAxis(O,j,U);var G=this._chooseSplitIndex(O,j,U),N=L(O.children.splice(G,O.children.length-G));N.height=O.height,N.leaf=O.leaf,s(O,this.toBBox),s(N,this.toBBox),D?C[D-1].children.push(N):this._splitRoot(O,N)},o.prototype._splitRoot=function(C,D){this.data=L([C,D]),this.data.height=C.height+1,this.data.leaf=!1,s(this.data,this.toBBox)},o.prototype._chooseSplitIndex=function(C,D,O){for(var U,j,G,N,V,q,z,Q=1/0,X=1/0,re=D;re<=O-D;re++){var oe=d(C,0,re,this.toBBox),de=d(C,re,O,this.toBBox),ce=(j=oe,G=de,N=void 0,V=void 0,q=void 0,z=void 0,N=Math.max(j.minX,G.minX),V=Math.max(j.minY,G.minY),q=Math.min(j.maxX,G.maxX),z=Math.min(j.maxY,G.maxY),Math.max(0,q-N)*Math.max(0,z-V)),Se=x(oe)+x(de);ce<Q?(Q=ce,U=re,X=Se<X?Se:X):ce===Q&&Se<X&&(X=Se,U=re)}return U||O-D},o.prototype._chooseSplitAxis=function(C,D,O){var U=C.leaf?this.compareMinX:g,j=C.leaf?this.compareMinY:_;this._allDistMargin(C,D,O,U)<this._allDistMargin(C,D,O,j)&&C.children.sort(U)},o.prototype._allDistMargin=function(C,D,O,U){C.children.sort(U);for(var j=this.toBBox,G=d(C,0,D,j),N=d(C,O-D,O,j),V=b(G)+b(N),q=D;q<O-D;q++){var z=C.children[q];p(G,C.leaf?j(z):z),V+=b(G)}for(var Q=O-D-1;Q>=D;Q--){var X=C.children[Q];p(N,C.leaf?j(X):X),V+=b(N)}return V},o.prototype._adjustParentBBoxes=function(C,D,O){for(var U=O;U>=0;U--)p(D[U],C)},o.prototype._condense=function(C){for(var D=C.length-1,O=void 0;D>=0;D--)C[D].children.length===0?D>0?(O=C[D-1].children).splice(O.indexOf(C[D]),1):this.clear():s(C[D],this.toBBox)},o})})(Wx)),Wx.exports}let nq=class{constructor(e=[],t=rq){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let i=(this.length>>1)-1;i>=0;i--)this._down(i)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],t=this.data.pop();return this.length--,this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:i}=this,r=t[e];for(;e>0;){const o=e-1>>1,c=t[o];if(i(r,c)>=0)break;t[e]=c,e=o}t[e]=r}_down(e){const{data:t,compare:i}=this,r=this.length>>1,o=t[e];for(;e<r;){let c=(e<<1)+1,s=t[c];const d=c+1;if(d<this.length&&i(t[d],s)<0&&(c=d,s=t[d]),i(s,o)>=0)break;t[e]=s,e=c}t[e]=o}};function rq(n,e){return n<e?-1:n>e?1:0}const sq=Object.freeze(Object.defineProperty({__proto__:null,default:nq},Symbol.toStringTag,{value:"Module"})),oq=K2(sq);var Mv={exports:{}},rT,JI;function aq(){return JI||(JI=1,rT=function(e,t,i,r){var o=e[0],c=e[1],s=!1;i===void 0&&(i=0),r===void 0&&(r=t.length);for(var d=(r-i)/2,p=0,g=d-1;p<d;g=p++){var _=t[i+p*2+0],x=t[i+p*2+1],b=t[i+g*2+0],S=t[i+g*2+1],P=x>c!=S>c&&o<(b-_)*(c-x)/(S-x)+_;P&&(s=!s)}return s}),rT}var sT,QI;function lq(){return QI||(QI=1,sT=function(e,t,i,r){var o=e[0],c=e[1],s=!1;i===void 0&&(i=0),r===void 0&&(r=t.length);for(var d=r-i,p=0,g=d-1;p<d;g=p++){var _=t[p+i][0],x=t[p+i][1],b=t[g+i][0],S=t[g+i][1],P=x>c!=S>c&&o<(b-_)*(c-x)/(S-x)+_;P&&(s=!s)}return s}),sT}var eR;function cq(){if(eR)return Mv.exports;eR=1;var n=aq(),e=lq();return Mv.exports=function(i,r,o,c){return r.length>0&&Array.isArray(r[0])?e(i,r,o,c):n(i,r,o,c)},Mv.exports.nested=e,Mv.exports.flat=n,Mv.exports}var Zv={exports:{}},uq=Zv.exports,tR;function hq(){return tR||(tR=1,(function(n,e){(function(t,i){i(e)})(uq,function(t){const r=33306690738754706e-32;function o(P,L,E,C,D){let O,U,j,G,N=L[0],V=C[0],q=0,z=0;V>N==V>-N?(O=N,N=L[++q]):(O=V,V=C[++z]);let Q=0;if(q<P&&z<E)for(V>N==V>-N?(j=O-((U=N+O)-N),N=L[++q]):(j=O-((U=V+O)-V),V=C[++z]),O=U,j!==0&&(D[Q++]=j);q<P&&z<E;)V>N==V>-N?(j=O-((U=O+N)-(G=U-O))+(N-G),N=L[++q]):(j=O-((U=O+V)-(G=U-O))+(V-G),V=C[++z]),O=U,j!==0&&(D[Q++]=j);for(;q<P;)j=O-((U=O+N)-(G=U-O))+(N-G),N=L[++q],O=U,j!==0&&(D[Q++]=j);for(;z<E;)j=O-((U=O+V)-(G=U-O))+(V-G),V=C[++z],O=U,j!==0&&(D[Q++]=j);return O===0&&Q!==0||(D[Q++]=O),Q}function c(P){return new Float64Array(P)}const s=33306690738754716e-32,d=22204460492503146e-32,p=11093356479670487e-47,g=c(4),_=c(8),x=c(12),b=c(16),S=c(4);t.orient2d=function(P,L,E,C,D,O){const U=(L-O)*(E-D),j=(P-D)*(C-O),G=U-j;if(U===0||j===0||U>0!=j>0)return G;const N=Math.abs(U+j);return Math.abs(G)>=s*N?G:-(function(V,q,z,Q,X,re,oe){let de,ce,Se,Pe,je,Fe,qe,Ue,ke,et,ye,Be,Je,ct,yt,we,fe,Ve;const tt=V-X,Mt=z-X,mt=q-re,Ce=Q-re;je=(yt=(Ue=tt-(qe=(Fe=134217729*tt)-(Fe-tt)))*(et=Ce-(ke=(Fe=134217729*Ce)-(Fe-Ce)))-((ct=tt*Ce)-qe*ke-Ue*ke-qe*et))-(ye=yt-(fe=(Ue=mt-(qe=(Fe=134217729*mt)-(Fe-mt)))*(et=Mt-(ke=(Fe=134217729*Mt)-(Fe-Mt)))-((we=mt*Mt)-qe*ke-Ue*ke-qe*et))),g[0]=yt-(ye+je)+(je-fe),je=(Je=ct-((Be=ct+ye)-(je=Be-ct))+(ye-je))-(ye=Je-we),g[1]=Je-(ye+je)+(je-we),je=(Ve=Be+ye)-Be,g[2]=Be-(Ve-je)+(ye-je),g[3]=Ve;let xe=(function(De,Xe){let bt=Xe[0];for(let Te=1;Te<De;Te++)bt+=Xe[Te];return bt})(4,g),vt=d*oe;if(xe>=vt||-xe>=vt||(de=V-(tt+(je=V-tt))+(je-X),Se=z-(Mt+(je=z-Mt))+(je-X),ce=q-(mt+(je=q-mt))+(je-re),Pe=Q-(Ce+(je=Q-Ce))+(je-re),de===0&&ce===0&&Se===0&&Pe===0)||(vt=p*oe+r*Math.abs(xe),(xe+=tt*Pe+Ce*de-(mt*Se+Mt*ce))>=vt||-xe>=vt))return xe;je=(yt=(Ue=de-(qe=(Fe=134217729*de)-(Fe-de)))*(et=Ce-(ke=(Fe=134217729*Ce)-(Fe-Ce)))-((ct=de*Ce)-qe*ke-Ue*ke-qe*et))-(ye=yt-(fe=(Ue=ce-(qe=(Fe=134217729*ce)-(Fe-ce)))*(et=Mt-(ke=(Fe=134217729*Mt)-(Fe-Mt)))-((we=ce*Mt)-qe*ke-Ue*ke-qe*et))),S[0]=yt-(ye+je)+(je-fe),je=(Je=ct-((Be=ct+ye)-(je=Be-ct))+(ye-je))-(ye=Je-we),S[1]=Je-(ye+je)+(je-we),je=(Ve=Be+ye)-Be,S[2]=Be-(Ve-je)+(ye-je),S[3]=Ve;const be=o(4,g,4,S,_);je=(yt=(Ue=tt-(qe=(Fe=134217729*tt)-(Fe-tt)))*(et=Pe-(ke=(Fe=134217729*Pe)-(Fe-Pe)))-((ct=tt*Pe)-qe*ke-Ue*ke-qe*et))-(ye=yt-(fe=(Ue=mt-(qe=(Fe=134217729*mt)-(Fe-mt)))*(et=Se-(ke=(Fe=134217729*Se)-(Fe-Se)))-((we=mt*Se)-qe*ke-Ue*ke-qe*et))),S[0]=yt-(ye+je)+(je-fe),je=(Je=ct-((Be=ct+ye)-(je=Be-ct))+(ye-je))-(ye=Je-we),S[1]=Je-(ye+je)+(je-we),je=(Ve=Be+ye)-Be,S[2]=Be-(Ve-je)+(ye-je),S[3]=Ve;const ie=o(be,_,4,S,x);je=(yt=(Ue=de-(qe=(Fe=134217729*de)-(Fe-de)))*(et=Pe-(ke=(Fe=134217729*Pe)-(Fe-Pe)))-((ct=de*Pe)-qe*ke-Ue*ke-qe*et))-(ye=yt-(fe=(Ue=ce-(qe=(Fe=134217729*ce)-(Fe-ce)))*(et=Se-(ke=(Fe=134217729*Se)-(Fe-Se)))-((we=ce*Se)-qe*ke-Ue*ke-qe*et))),S[0]=yt-(ye+je)+(je-fe),je=(Je=ct-((Be=ct+ye)-(je=Be-ct))+(ye-je))-(ye=Je-we),S[1]=Je-(ye+je)+(je-we),je=(Ve=Be+ye)-Be,S[2]=Be-(Ve-je)+(ye-je),S[3]=Ve;const ae=o(ie,x,4,S,b);return b[ae-1]})(P,L,E,C,D,O,N)},t.orient2dfast=function(P,L,E,C,D,O){return(L-O)*(E-D)-(P-D)*(C-O)},Object.defineProperty(t,"__esModule",{value:!0})})})(Zv,Zv.exports)),Zv.exports}var iR;function dq(){if(iR)return Fb.exports;iR=1;var n=iq(),e=oq,t=cq(),i=hq().orient2d;e.default&&(e=e.default),Fb.exports=r,Fb.exports.default=r;function r(O,U,j){U=Math.max(0,U===void 0?2:U),j=j||0;var G=b(O),N=new n(16);N.toBBox=function(qe){return{minX:qe[0],minY:qe[1],maxX:qe[0],maxY:qe[1]}},N.compareMinX=function(qe,Ue){return qe[0]-Ue[0]},N.compareMinY=function(qe,Ue){return qe[1]-Ue[1]},N.load(O);for(var V=[],q=0,z;q<G.length;q++){var Q=G[q];N.remove(Q),z=S(Q,z),V.push(z)}var X=new n(16);for(q=0;q<V.length;q++)X.insert(x(V[q]));for(var re=U*U,oe=j*j;V.length;){var de=V.shift(),ce=de.p,Se=de.next.p,Pe=P(ce,Se);if(!(Pe<oe)){var je=Pe/re;Q=o(N,de.prev.p,ce,Se,de.next.next.p,je,X),Q&&Math.min(P(Q,ce),P(Q,Se))<=je&&(V.push(de),V.push(S(Q,de)),N.remove(Q),X.remove(de),X.insert(x(de)),X.insert(x(de.next)))}}de=z;var Fe=[];do Fe.push(de.p),de=de.next;while(de!==z);return Fe.push(de.p),Fe}function o(O,U,j,G,N,V,q){for(var z=new e([],c),Q=O.data;Q;){for(var X=0;X<Q.children.length;X++){var re=Q.children[X],oe=Q.leaf?L(re,j,G):s(j,G,re);oe>V||z.push({node:re,dist:oe})}for(;z.length&&!z.peek().node.children;){var de=z.pop(),ce=de.node,Se=L(ce,U,j),Pe=L(ce,G,N);if(de.dist<Se&&de.dist<Pe&&p(j,ce,q)&&p(G,ce,q))return ce}Q=z.pop(),Q&&(Q=Q.node)}return null}function c(O,U){return O.dist-U.dist}function s(O,U,j){if(d(O,j)||d(U,j))return 0;var G=E(O[0],O[1],U[0],U[1],j.minX,j.minY,j.maxX,j.minY);if(G===0)return 0;var N=E(O[0],O[1],U[0],U[1],j.minX,j.minY,j.minX,j.maxY);if(N===0)return 0;var V=E(O[0],O[1],U[0],U[1],j.maxX,j.minY,j.maxX,j.maxY);if(V===0)return 0;var q=E(O[0],O[1],U[0],U[1],j.minX,j.maxY,j.maxX,j.maxY);return q===0?0:Math.min(G,N,V,q)}function d(O,U){return O[0]>=U.minX&&O[0]<=U.maxX&&O[1]>=U.minY&&O[1]<=U.maxY}function p(O,U,j){for(var G=Math.min(O[0],U[0]),N=Math.min(O[1],U[1]),V=Math.max(O[0],U[0]),q=Math.max(O[1],U[1]),z=j.search({minX:G,minY:N,maxX:V,maxY:q}),Q=0;Q<z.length;Q++)if(_(z[Q].p,z[Q].next.p,O,U))return!1;return!0}function g(O,U,j){return i(O[0],O[1],U[0],U[1],j[0],j[1])}function _(O,U,j,G){return O!==G&&U!==j&&g(O,U,j)>0!=g(O,U,G)>0&&g(j,G,O)>0!=g(j,G,U)>0}function x(O){var U=O.p,j=O.next.p;return O.minX=Math.min(U[0],j[0]),O.minY=Math.min(U[1],j[1]),O.maxX=Math.max(U[0],j[0]),O.maxY=Math.max(U[1],j[1]),O}function b(O){for(var U=O[0],j=O[0],G=O[0],N=O[0],V=0;V<O.length;V++){var q=O[V];q[0]<U[0]&&(U=q),q[0]>G[0]&&(G=q),q[1]<j[1]&&(j=q),q[1]>N[1]&&(N=q)}var z=[U,j,G,N],Q=z.slice();for(V=0;V<O.length;V++)t(O[V],z)||Q.push(O[V]);return D(Q)}function S(O,U){var j={p:O,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return U?(j.next=U.next,j.prev=U,U.next.prev=j,U.next=j):(j.prev=j,j.next=j),j}function P(O,U){var j=O[0]-U[0],G=O[1]-U[1];return j*j+G*G}function L(O,U,j){var G=U[0],N=U[1],V=j[0]-G,q=j[1]-N;if(V!==0||q!==0){var z=((O[0]-G)*V+(O[1]-N)*q)/(V*V+q*q);z>1?(G=j[0],N=j[1]):z>0&&(G+=V*z,N+=q*z)}return V=O[0]-G,q=O[1]-N,V*V+q*q}function E(O,U,j,G,N,V,q,z){var Q=j-O,X=G-U,re=q-N,oe=z-V,de=O-N,ce=U-V,Se=Q*Q+X*X,Pe=Q*re+X*oe,je=re*re+oe*oe,Fe=Q*de+X*ce,qe=re*de+oe*ce,Ue=Se*je-Pe*Pe,ke,et,ye,Be,Je=Ue,ct=Ue;Ue===0?(et=0,Je=1,Be=qe,ct=je):(et=Pe*qe-je*Fe,Be=Se*qe-Pe*Fe,et<0?(et=0,Be=qe,ct=je):et>Je&&(et=Je,Be=qe+Pe,ct=je)),Be<0?(Be=0,-Fe<0?et=0:-Fe>Se?et=Je:(et=-Fe,Je=Se)):Be>ct&&(Be=ct,-Fe+Pe<0?et=0:-Fe+Pe>Se?et=Je:(et=-Fe+Pe,Je=Se)),ke=et===0?0:et/Je,ye=Be===0?0:Be/ct;var yt=(1-ke)*O+ke*j,we=(1-ke)*U+ke*G,fe=(1-ye)*N+ye*q,Ve=(1-ye)*V+ye*z,tt=fe-yt,Mt=Ve-we;return tt*tt+Mt*Mt}function C(O,U){return O[0]===U[0]?O[1]-U[1]:O[0]-U[0]}function D(O){O.sort(C);for(var U=[],j=0;j<O.length;j++){for(;U.length>=2&&g(U[U.length-2],U[U.length-1],O[j])<=0;)U.pop();U.push(O[j])}for(var G=[],N=O.length-1;N>=0;N--){for(;G.length>=2&&g(G[G.length-2],G[G.length-1],O[N])<=0;)G.pop();G.push(O[N])}return G.pop(),U.pop(),U.concat(G)}return Fb.exports}var fq=dq();const pq=CD(fq);function mq(n,e={}){e.concavity=e.concavity||1/0;const t=[];if(eO(n,r=>{t.push([r[0],r[1]])}),!t.length)return null;const i=pq(t,e.concavity);return i.length>3?eq([i]):null}class gq extends Map{constructor(){super(),this.binders=[]}add(e,t){this.set(e,t)}addBinder(e){this.binders.push(e)}bindAll(){this.binders.forEach(e=>e.bind())}}function tp(n,e){if(n){const t=Object.assign({},n);if(e)for(const i of e)delete t[i];return t}return{}}function Kf(n){return n[0]}function fg(n){return n[n.length-1]}function Rl(n){return n.join(",")}function nR(n,e,t){const i=n[e];i?i.push(t):n[e]=[t]}function Ob(n,e,t){const i=n[e];let r=-1;i&&(r=i.indexOf(t)),r>=0&&i.splice(r,1)}function rR(n,e){const t=n[e];return t&&t.length>0?t[0]:null}function tO(n){return n.length>3&&Rl(Kf(n))===Rl(fg(n))}function iO(n,e,t){e=e||0,t=t||1;const i=n.reduce((b,S,P)=>n[b][e||0]>S[e||0]?b:P,0),r=i<=0?n.length-2:i-1,o=i>=n.length-1?1:i+1,c=n[r][e],s=n[i][e],d=n[o][e],p=n[r][t],g=n[i][t],_=n[o][t];return(s-c)*(_-p)-(d-c)*(g-p)<0?"clockwise":"counterclockwise"}function _q(n,e,t,i){t=t||0,i=i||1;let r=!1;for(let o=0,c=e.length-1;o<e.length;c=o++)(e[o][t]<=n[t]&&n[t]<e[c][t]||e[c][t]<=n[t]&&n[t]<e[o][t])&&n[i]<(e[c][i]-e[o][i])*(n[t]-e[o][t])/(e[c][t]-e[o][t])+e[o][i]&&(r=!r);return r}function nO(n){return n.map(s1)}function s1(n){return n.map(parseFloat)}class o1{constructor(e,t,i){this.type=e,this.id=t,this.refElems=i,this.tags={},this.meta={},this.refCount=0,this.hasTag=!1,i&&i.add(this.getCompositeId(),this)}addTags(e){this.tags=Object.assign(this.tags,e),this.hasTag=!0}addTag(e,t){this.tags[e]=t,this.hasTag=!0}addMeta(e,t){this.meta[e]=t}addMetas(e){this.meta=Object.assign(this.meta,e)}getCompositeId(){return`${this.type}/${this.id}`}getProps(){return{"@id":this.id,"@type":this.type,...Object.fromEntries(Object.entries(this.meta).map(([e,t])=>["@"+e,t])),...Object.fromEntries(Object.entries(this.tags).map(([e,t])=>[e.startsWith("@")?"@"+e:e,t]))}}}let xC=class extends o1{constructor(e,t){super("node",e,t)}setLatLng(e){this.latLng=e}toFeature(){if(this.latLng)return{type:"Feature",id:this.getCompositeId(),properties:this.getProps(),geometry:{type:"Point",coordinates:s1([this.latLng.lon,this.latLng.lat])}}}getLatLng(){return this.latLng}};class rO extends o1{constructor(e,t,i){super(e,t,i)}setGeometry(e){this.geometry=e}toFeature(){if(this.geometry)return{type:"Feature",id:this.getCompositeId(),properties:this.getProps(),geometry:this.geometry}}}class Hx{constructor(e,t,i,r){this.container=e,this.valueFunc=t,this.ctx=i,this.args=r}bind(){const e=this.valueFunc.apply(this.ctx,this.args),t=this.container.indexOf(this);if(t<0)return;const i=[t,1];e&&i.push(e),this.container.splice(...i)}}const vq={ignore:["no"]},yq={include:["services","rest_area","escape","elevator"]},bq={exclude:["coastline","cliff","ridge","arete","tree_row"]},xq={},wq={include:["riverbank","dock","boatyard","dam"]},Sq={},Tq={},Mq={include:["city_wall","ditch","hedge","retaining_wall","wall","spikes"]},Cq={include:["station","turntable","roundhouse","platform"]},Eq={},Aq={exclude:["cutline","embankment","pipeline"]},Pq={include:["plant","substation","generator","transformer"]},Iq={},Rq={},Lq={exclude:["taxiway"]},kq={},Dq={},Fq={},Oq={},zq={},Bq={},Nq={},$q={},Vq={ignore:["yes","no"]},Uq={exclude:["no"]},jq={building:vq,highway:yq,natural:bq,landuse:xq,waterway:wq,amenity:Sq,leisure:Tq,barrier:Mq,railway:Cq,boundary:Eq,man_made:Aq,power:Pq,"piste:type":{include:["downhill"]},place:Iq,shop:Rq,aeroway:Lq,tourism:kq,historic:Dq,public_transport:Fq,office:Oq,"building:part":{ignore:["no"]},military:zq,ruins:Bq,"area:highway":{},craft:Nq,golf:$q,indoor:Vq,area:Uq};class Sw extends o1{constructor(e,t){super("way",e,t),this.tainted=!1,this.latLngArray=[],this.center=null}addLatLng(e){this.latLngArray.push(e)}setCenter(e){this.center=e}setLatLngArray(e){this.latLngArray=e}addNodeRef(e){const t=new Hx(this.latLngArray,i=>{const r=this.refElems.get(`node/${i}`);if(r)return r.refCount++,r.getLatLng();this.tainted=!0},this,[e]);this.latLngArray.push(t),this.refElems.addBinder(t)}addTags(e){super.addTags(e)}addTag(e,t){super.addTag(e,t)}toCoordsArray(){return this.latLngArray.map(e=>[e.lon,e.lat])}toFeature(){let e=this.toCoordsArray();if(e.length>1){const t=nO(e),i={type:"Feature",id:this.getCompositeId(),properties:this.getProps(),geometry:{type:"LineString",coordinates:t}};return this.tainted&&(i.properties["@tainted"]=this.tainted),this.isPolygon&&tO(t)&&(iO(t)!=="counterclockwise"&&t.reverse(),i.geometry={type:"Polygon",coordinates:[t]},this.tainted&&(i.properties["@tainted"]=this.tainted)),i}else if(this.center!==null){const t={type:"Feature",id:this.getCompositeId(),properties:this.getProps(),geometry:{type:"Point",coordinates:s1([this.center.lon,this.center.lat])}};return this.tainted&&(t.properties["@tainted"]=this.tainted),t}}get isPolygon(){var e;let t=!1;for(const[i,r]of Object.entries(jq)){const o=this.tags[i];if(o&&r){if(!((e=r.ignore)===null||e===void 0)&&e.includes(o))continue;t=!0,r.include?t=r.include.includes(o):r.exclude&&(t=!r.exclude.includes(o))}}return t}}class oT extends Array{constructor(){super(),this.firstMap={},this.lastMap={}}addWay(e){const t=e.toCoordsArray();t.length>0&&(this.push(t),nR(this.firstMap,Rl(Kf(t)),t),nR(this.lastMap,Rl(fg(t)),t))}mergeWays(){const e=[];let t=this.shift();for(;t;){Ob(this.firstMap,Rl(Kf(t)),t),Ob(this.lastMap,Rl(fg(t)),t);let i=t,r;do{let o=this.getNextWay(i);r=o.next;let c=o.mergeType;if(r)switch(this.splice(this.indexOf(r),1),Ob(this.firstMap,Rl(Kf(r)),r),Ob(this.lastMap,Rl(fg(r)),r),c){case 0:i=i.concat(r.slice(1));break;case 1:r.reverse(),i=i.concat(r.slice(1));break;case 2:i.reverse(),i=i.concat(r.slice(1));break;case 3:i=r.concat(i.slice(1));break}}while(r);e.push(nO(i)),t=this.shift()}return e}getNextWay(e){const t=Rl(fg(e)),i=Rl(Kf(e));let r=this.length>0?this[0]:null;if(r){const o=Rl(Kf(r)),c=Rl(fg(r));if(t===o)return{next:r,mergeType:0};if(t===c)return{next:r,mergeType:1};if(i===o)return{next:r,mergeType:2};if(i===c)return{next:r,mergeType:3}}return r=rR(this.firstMap,t),r?{next:r,mergeType:0}:(r=rR(this.lastMap,t),{next:r,mergeType:1})}toRings(e){const t=this.mergeWays(),i=[];let r=t.shift();for(;r;)tO(r)&&(iO(r)!==e&&r.reverse(),i.push(r)),r=t.shift();return i}}class sO extends o1{constructor(e,t){super("relation",e,t),this.relations=[],this.nodes=[],this.bounds=void 0,this.center=null,this.ways=[],this.members=[]}setBounds(e){this.bounds=e}setCenter(e){this.center=e}addMember(e){switch(this.members.push(e),e.type){case"relation":let t=new Hx(this.relations,r=>{const o=this.refElems.get(`relation/${r}`);if(o)return o.refCount++,o},this,[e.ref]);this.relations.push(t),this.refElems.addBinder(t);break;case"way":if(e.geometry){const r=new Sw(e.ref,void 0);r.setLatLngArray(e.geometry),r.refCount++,this.ways.push(r)}else if(e.nodes){const r=new Sw(e.ref,this.refElems);for(const o of e.nodes)r.addNodeRef(o);r.refCount++,this.ways.push(r)}else{let r=new Hx(this.ways,o=>{const c=this.refElems.get(`way/${o}`);if(c)return c.refCount++,c},this,[e.ref]);this.ways.push(r),this.refElems.addBinder(r)}break;case"node":let i=null;if(e.lat&&e.lon){i=new xC(e.ref,void 0),i.setLatLng({lon:e.lon,lat:e.lat}),e.tags&&i.addTags(e.tags);for(const[r,o]of Object.entries(e))["id","type","lat","lon"].indexOf(r)<0&&i.addMeta(r,o);i.refCount++,this.nodes.push(i)}else{let r=new Hx(this.nodes,o=>{const c=this.refElems.get(`node/${o}`);if(c)return c.refCount++,c},this,[e.ref]);this.nodes.push(r),this.refElems.addBinder(r)}break}}constructStringGeometry(e){const t=e?e.mergeWays():[];return t.length===0?null:{type:"MultiLineString",coordinates:t}}constructPolygonGeometry(e,t){const i=e?e.toRings("counterclockwise"):[],r=t?t.toRings("clockwise"):[];if(i.length>0){const o=[];let c;for(c of i)o.push([c]);for(c=r.shift();c;){for(const s in i)if(_q(Kf(c),i[s])){o[s].push(c);break}c=r.shift()}return o.length===1?{type:"Polygon",coordinates:o[0]}:{type:"MultiPolygon",coordinates:o}}return null}toFeature(){const e=[];let t=!1;const i=[],r={type:"Feature",id:this.getCompositeId(),bbox:this.bounds,properties:this.getProps(),geometry:null};if(this.bounds||delete r.bbox,this.members.some(({role:o})=>o==="outer")){const o=new oT,c=new oT;for(const{type:d,ref:p,role:g}of this.members)if(d==="way"&&["inner","outer"].includes(g)){const _=`way/${p}`;i.push(_);const x=this.ways.find(b=>b.getCompositeId()===_);x?g==="outer"?o.addWay(x):g==="inner"&&c.addWay(x):t=!0}let s=this.constructPolygonGeometry(o,c);s&&e.push(s)}else if(["multilinestring","route","waterway"].includes(this.tags.type)){const o=new oT;for(const{type:s,ref:d,role:p}of this.members)if(s==="way"){const g=`way/${d}`;i.push(g);const _=this.ways.find(x=>x.getCompositeId()===g);_?o.addWay(_):t=!0}let c=this.constructStringGeometry(o);c&&e.push(c)}for(const{type:o,ref:c,role:s}of this.members){const d=`${o}/${c}`;if(i.includes(d))continue;let p;switch(o){case"node":p=this.nodes.find(g=>g.getCompositeId()===d);break;case"way":p=this.ways.find(g=>g.getCompositeId()===d);break;case"relation":p=this.relations.find(g=>g.getCompositeId()===d);break}if(p){const g=p.toFeature();g?.geometry&&e.push(g.geometry)}else t=!0}return this.center!==null&&e.push({type:"Point",coordinates:s1([this.center.lon,this.center.lat])}),t&&(r.properties["@tainted"]=t),e.length===1?r.geometry=e[0]:r.geometry={type:"GeometryCollection",geometries:e},r}}function Gq(n,e){var t;for(const i of n.elements){if(!((t=i.geometry)===null||t===void 0)&&t.type){const r=new rO(i.type,i.id,e);i.tags&&r.addTags(i.tags),r.addMetas(tp(i,["id","type","tags","geometry"])),r.setGeometry(i.geometry);continue}switch(i.type){case"node":const r=new xC(i.id,e);i.tags&&r.addTags(i.tags),r.addMetas(tp(i,["id","type","tags","lat","lon"])),r.setLatLng(i);break;case"way":const o=new Sw(i.id,e);if(i.tags&&o.addTags(i.tags),o.addMetas(tp(i,["id","type","tags","nodes","geometry"])),i.geometry)o.setLatLngArray(i.geometry);else if(i.center)o.setCenter(i.center);else if(i.nodes)for(const s of i.nodes)o.addNodeRef(s);break;case"relation":const c=new sO(i.id,e);if(i.bounds&&c.setBounds([parseFloat(i.bounds.minlon),parseFloat(i.bounds.minlat),parseFloat(i.bounds.maxlon),parseFloat(i.bounds.maxlat)]),i.tags&&c.addTags(i.tags),i.center&&c.setCenter(i.center),c.addMetas(tp(i,["id","type","tags","bounds","members"])),i.members)for(const s of i.members)c.addMember(s);break}}}function qq(n,e){"txml";e=e||{};var t=e.pos||0,i=!!e.keepComments,r=!!e.keepWhitespace,o="<",c=60,s=">",d=62,p=45,g=47,_=33,x=39,b=34,S=91,P=93;function L(V){for(var q=[];n[t];)if(n.charCodeAt(t)==c){if(n.charCodeAt(t+1)===g){var z=t+2;t=n.indexOf(s,t);var Q=n.substring(z,t);if(Q.indexOf(V)==-1){var X=n.substring(0,t).split(`
`);throw new Error(`Unexpected close tag
Line: `+(X.length-1)+`
Column: `+(X[X.length-1].length+1)+`
Char: `+n[t])}return t+1&&(t+=1),q}else if(n.charCodeAt(t+1)===_){if(n.charCodeAt(t+2)==p){const Pe=t;for(;t!==-1&&!(n.charCodeAt(t)===d&&n.charCodeAt(t-1)==p&&n.charCodeAt(t-2)==p&&t!=-1);)t=n.indexOf(s,t+1);t===-1&&(t=n.length),i&&q.push(n.substring(Pe,t+1))}else if(n.charCodeAt(t+2)===S&&n.charCodeAt(t+8)===S&&n.substr(t+3,5).toLowerCase()==="cdata"){var re=n.indexOf("]]>",t);re==-1?(q.push(n.substr(t+9)),t=n.length):(q.push(n.substring(t+9,re)),t=re+3);continue}else{const Pe=t+1;t+=2;for(var oe=!1;(n.charCodeAt(t)!==d||oe===!0)&&n[t];)n.charCodeAt(t)===S?oe=!0:oe===!0&&n.charCodeAt(t)===P&&(oe=!1),t++;q.push(n.substring(Pe,t))}t++;continue}var de=U();q.push(de),de.tagName[0]==="?"&&(q.push(...de.children),de.children=[])}else{var ce=E();if(r)ce.length>0&&q.push(ce);else{var Se=ce.trim();Se.length>0&&q.push(Se)}t++}return q}function E(){var V=t;return t=n.indexOf(o,t)-1,t===-2&&(t=n.length),n.slice(V,t+1)}var C=`\r
	>/= `;function D(){for(var V=t;C.indexOf(n[t])===-1&&n[t];)t++;return n.slice(V,t)}var O=e.noChildNodes||["img","br","input","meta","link","hr"];function U(){t++;const V=D(),q={};let z=[];for(;n.charCodeAt(t)!==d&&n[t];){var Q=n.charCodeAt(t);if(Q>64&&Q<91||Q>96&&Q<123){for(var X=D(),re=n.charCodeAt(t);re&&re!==x&&re!==b&&!(re>64&&re<91||re>96&&re<123)&&re!==d;)t++,re=n.charCodeAt(t);if(re===x||re===b){var oe=j();if(t===-1)return{tagName:V,attributes:q,children:z}}else oe=null,t--;q[X]=oe}t++}if(n.charCodeAt(t-1)!==g)if(V=="script"){var de=t+1;t=n.indexOf("<\/script>",t),z=[n.slice(de,t)],t+=9}else if(V=="style"){var de=t+1;t=n.indexOf("</style>",t),z=[n.slice(de,t)],t+=8}else O.indexOf(V)===-1?(t++,z=L(V)):t++;else t++;return{tagName:V,attributes:q,children:z}}function j(){var V=n[t],q=t+1;return t=n.indexOf(V,q),n.slice(q,t)}function G(){var V=new RegExp("\\s"+e.attrName+`\\s*=['"]`+e.attrValue+`['"]`).exec(n);return V?V.index:-1}var N=null;if(e.attrValue!==void 0){e.attrName=e.attrName||"id";for(var N=[];(t=G())!==-1;)t=n.lastIndexOf("<",t),t!==-1&&N.push(U()),n=n.substr(t),t=0}else e.parseNode?N=U():N=L("");return e.filter&&(N=aO(N,e.filter)),e.simplify?oO(Array.isArray(N)?N:[N]):(e.setPos&&(N.pos=t),N)}function oO(n){var e={};if(!n.length)return"";if(n.length===1&&typeof n[0]=="string")return n[0];n.forEach(function(i){if(typeof i=="object"){e[i.tagName]||(e[i.tagName]=[]);var r=oO(i.children);e[i.tagName].push(r),Object.keys(i.attributes).length&&typeof r!="string"&&(r._attributes=i.attributes)}});for(var t in e)e[t].length==1&&(e[t]=e[t][0]);return e}function aO(n,e,t=0,i=""){var r=[];return n.forEach(function(o,c){if(typeof o=="object"&&e(o,c,t,i)&&r.push(o),o.children){var s=aO(o.children,e,t+1,(i?i+".":"")+c+"."+o.tagName);r=r.concat(s)}}),r}var Cv={exports:{}},zb={exports:{}};const Wq={},Hq=Object.freeze(Object.defineProperty({__proto__:null,default:Wq},Symbol.toStringTag,{value:"Module"})),Id=K2(Hq);var aT,sR;function lO(){return sR||(sR=1,aT=Id.EventEmitter),aT}var lT,oR;function Zq(){if(oR)return lT;oR=1;function n(S,P){var L=Object.keys(S);if(Object.getOwnPropertySymbols){var E=Object.getOwnPropertySymbols(S);P&&(E=E.filter(function(C){return Object.getOwnPropertyDescriptor(S,C).enumerable})),L.push.apply(L,E)}return L}function e(S){for(var P=1;P<arguments.length;P++){var L=arguments[P]!=null?arguments[P]:{};P%2?n(Object(L),!0).forEach(function(E){t(S,E,L[E])}):Object.getOwnPropertyDescriptors?Object.defineProperties(S,Object.getOwnPropertyDescriptors(L)):n(Object(L)).forEach(function(E){Object.defineProperty(S,E,Object.getOwnPropertyDescriptor(L,E))})}return S}function t(S,P,L){return P=c(P),P in S?Object.defineProperty(S,P,{value:L,enumerable:!0,configurable:!0,writable:!0}):S[P]=L,S}function i(S,P){if(!(S instanceof P))throw new TypeError("Cannot call a class as a function")}function r(S,P){for(var L=0;L<P.length;L++){var E=P[L];E.enumerable=E.enumerable||!1,E.configurable=!0,"value"in E&&(E.writable=!0),Object.defineProperty(S,c(E.key),E)}}function o(S,P,L){return P&&r(S.prototype,P),Object.defineProperty(S,"prototype",{writable:!1}),S}function c(S){var P=s(S,"string");return typeof P=="symbol"?P:String(P)}function s(S,P){if(typeof S!="object"||S===null)return S;var L=S[Symbol.toPrimitive];if(L!==void 0){var E=L.call(S,P);if(typeof E!="object")return E;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(S)}var d=Id,p=d.Buffer,g=Id,_=g.inspect,x=_&&_.custom||"inspect";function b(S,P,L){p.prototype.copy.call(S,P,L)}return lT=(function(){function S(){i(this,S),this.head=null,this.tail=null,this.length=0}return o(S,[{key:"push",value:function(L){var E={data:L,next:null};this.length>0?this.tail.next=E:this.head=E,this.tail=E,++this.length}},{key:"unshift",value:function(L){var E={data:L,next:this.head};this.length===0&&(this.tail=E),this.head=E,++this.length}},{key:"shift",value:function(){if(this.length!==0){var L=this.head.data;return this.length===1?this.head=this.tail=null:this.head=this.head.next,--this.length,L}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(L){if(this.length===0)return"";for(var E=this.head,C=""+E.data;E=E.next;)C+=L+E.data;return C}},{key:"concat",value:function(L){if(this.length===0)return p.alloc(0);for(var E=p.allocUnsafe(L>>>0),C=this.head,D=0;C;)b(C.data,E,D),D+=C.data.length,C=C.next;return E}},{key:"consume",value:function(L,E){var C;return L<this.head.data.length?(C=this.head.data.slice(0,L),this.head.data=this.head.data.slice(L)):L===this.head.data.length?C=this.shift():C=E?this._getString(L):this._getBuffer(L),C}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(L){var E=this.head,C=1,D=E.data;for(L-=D.length;E=E.next;){var O=E.data,U=L>O.length?O.length:L;if(U===O.length?D+=O:D+=O.slice(0,L),L-=U,L===0){U===O.length?(++C,E.next?this.head=E.next:this.head=this.tail=null):(this.head=E,E.data=O.slice(U));break}++C}return this.length-=C,D}},{key:"_getBuffer",value:function(L){var E=p.allocUnsafe(L),C=this.head,D=1;for(C.data.copy(E),L-=C.data.length;C=C.next;){var O=C.data,U=L>O.length?O.length:L;if(O.copy(E,E.length-L,0,U),L-=U,L===0){U===O.length?(++D,C.next?this.head=C.next:this.head=this.tail=null):(this.head=C,C.data=O.slice(U));break}++D}return this.length-=D,E}},{key:x,value:function(L,E){return _(this,e(e({},E),{},{depth:0,customInspect:!1}))}}]),S})(),lT}var cT,aR;function cO(){if(aR)return cT;aR=1;function n(c,s){var d=this,p=this._readableState&&this._readableState.destroyed,g=this._writableState&&this._writableState.destroyed;return p||g?(s?s(c):c&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,process.nextTick(r,this,c)):process.nextTick(r,this,c)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(c||null,function(_){!s&&_?d._writableState?d._writableState.errorEmitted?process.nextTick(t,d):(d._writableState.errorEmitted=!0,process.nextTick(e,d,_)):process.nextTick(e,d,_):s?(process.nextTick(t,d),s(_)):process.nextTick(t,d)}),this)}function e(c,s){r(c,s),t(c)}function t(c){c._writableState&&!c._writableState.emitClose||c._readableState&&!c._readableState.emitClose||c.emit("close")}function i(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function r(c,s){c.emit("error",s)}function o(c,s){var d=c._readableState,p=c._writableState;d&&d.autoDestroy||p&&p.autoDestroy?c.destroy(s):c.emit("error",s)}return cT={destroy:n,undestroy:i,errorOrDestroy:o},cT}var uT={},lR;function c_(){if(lR)return uT;lR=1;function n(s,d){s.prototype=Object.create(d.prototype),s.prototype.constructor=s,s.__proto__=d}var e={};function t(s,d,p){p||(p=Error);function g(x,b,S){return typeof d=="string"?d:d(x,b,S)}var _=(function(x){n(b,x);function b(S,P,L){return x.call(this,g(S,P,L))||this}return b})(p);_.prototype.name=p.name,_.prototype.code=s,e[s]=_}function i(s,d){if(Array.isArray(s)){var p=s.length;return s=s.map(function(g){return String(g)}),p>2?"one of ".concat(d," ").concat(s.slice(0,p-1).join(", "),", or ")+s[p-1]:p===2?"one of ".concat(d," ").concat(s[0]," or ").concat(s[1]):"of ".concat(d," ").concat(s[0])}else return"of ".concat(d," ").concat(String(s))}function r(s,d,p){return s.substr(0,d.length)===d}function o(s,d,p){return(p===void 0||p>s.length)&&(p=s.length),s.substring(p-d.length,p)===d}function c(s,d,p){return typeof p!="number"&&(p=0),p+d.length>s.length?!1:s.indexOf(d,p)!==-1}return t("ERR_INVALID_OPT_VALUE",function(s,d){return'The value "'+d+'" is invalid for option "'+s+'"'},TypeError),t("ERR_INVALID_ARG_TYPE",function(s,d,p){var g;typeof d=="string"&&r(d,"not ")?(g="must not be",d=d.replace(/^not /,"")):g="must be";var _;if(o(s," argument"))_="The ".concat(s," ").concat(g," ").concat(i(d,"type"));else{var x=c(s,".")?"property":"argument";_='The "'.concat(s,'" ').concat(x," ").concat(g," ").concat(i(d,"type"))}return _+=". Received type ".concat(typeof p),_},TypeError),t("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),t("ERR_METHOD_NOT_IMPLEMENTED",function(s){return"The "+s+" method is not implemented"}),t("ERR_STREAM_PREMATURE_CLOSE","Premature close"),t("ERR_STREAM_DESTROYED",function(s){return"Cannot call "+s+" after a stream was destroyed"}),t("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),t("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),t("ERR_STREAM_WRITE_AFTER_END","write after end"),t("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),t("ERR_UNKNOWN_ENCODING",function(s){return"Unknown encoding: "+s},TypeError),t("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),uT.codes=e,uT}var hT,cR;function uO(){if(cR)return hT;cR=1;var n=c_().codes.ERR_INVALID_OPT_VALUE;function e(i,r,o){return i.highWaterMark!=null?i.highWaterMark:r?i[o]:null}function t(i,r,o,c){var s=e(r,c,o);if(s!=null){if(!(isFinite(s)&&Math.floor(s)===s)||s<0){var d=c?o:"highWaterMark";throw new n(d,s)}return Math.floor(s)}return i.objectMode?16:16*1024}return hT={getHighWaterMark:t},hT}var Bb={exports:{}},uR;function u_(){return uR||(uR=1,typeof Object.create=="function"?Bb.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:Bb.exports=function(e,t){if(t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}),Bb.exports}var dT,hR;function Xq(){if(hR)return dT;hR=1,dT=n;function n(t,i){if(e("noDeprecation"))return t;var r=!1;function o(){if(!r){if(e("throwDeprecation"))throw new Error(i);e("traceDeprecation")?console.trace(i):console.warn(i),r=!0}return t.apply(this,arguments)}return o}function e(t){try{if(!zg.localStorage)return!1}catch{return!1}var i=zg.localStorage[t];return i==null?!1:String(i).toLowerCase()==="true"}return dT}var fT,dR;function hO(){if(dR)return fT;dR=1,fT=N;function n(ye){var Be=this;this.next=null,this.entry=null,this.finish=function(){et(Be,ye)}}var e;N.WritableState=j;var t={deprecate:Xq()},i=lO(),r=Id.Buffer,o=(typeof zg<"u"?zg:typeof window<"u"?window:typeof self<"u"?self:{}).Uint8Array||function(){};function c(ye){return r.from(ye)}function s(ye){return r.isBuffer(ye)||ye instanceof o}var d=cO(),p=uO(),g=p.getHighWaterMark,_=c_().codes,x=_.ERR_INVALID_ARG_TYPE,b=_.ERR_METHOD_NOT_IMPLEMENTED,S=_.ERR_MULTIPLE_CALLBACK,P=_.ERR_STREAM_CANNOT_PIPE,L=_.ERR_STREAM_DESTROYED,E=_.ERR_STREAM_NULL_VALUES,C=_.ERR_STREAM_WRITE_AFTER_END,D=_.ERR_UNKNOWN_ENCODING,O=d.errorOrDestroy;u_()(N,i);function U(){}function j(ye,Be,Je){e=e||qg(),ye=ye||{},typeof Je!="boolean"&&(Je=Be instanceof e),this.objectMode=!!ye.objectMode,Je&&(this.objectMode=this.objectMode||!!ye.writableObjectMode),this.highWaterMark=g(this,ye,"writableHighWaterMark",Je),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var ct=ye.decodeStrings===!1;this.decodeStrings=!ct,this.defaultEncoding=ye.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(yt){de(Be,yt)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=ye.emitClose!==!1,this.autoDestroy=!!ye.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new n(this)}j.prototype.getBuffer=function(){for(var Be=this.bufferedRequest,Je=[];Be;)Je.push(Be),Be=Be.next;return Je},(function(){try{Object.defineProperty(j.prototype,"buffer",{get:t.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch{}})();var G;typeof Symbol=="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]=="function"?(G=Function.prototype[Symbol.hasInstance],Object.defineProperty(N,Symbol.hasInstance,{value:function(Be){return G.call(this,Be)?!0:this!==N?!1:Be&&Be._writableState instanceof j}})):G=function(Be){return Be instanceof this};function N(ye){e=e||qg();var Be=this instanceof e;if(!Be&&!G.call(N,this))return new N(ye);this._writableState=new j(ye,this,Be),this.writable=!0,ye&&(typeof ye.write=="function"&&(this._write=ye.write),typeof ye.writev=="function"&&(this._writev=ye.writev),typeof ye.destroy=="function"&&(this._destroy=ye.destroy),typeof ye.final=="function"&&(this._final=ye.final)),i.call(this)}N.prototype.pipe=function(){O(this,new P)};function V(ye,Be){var Je=new C;O(ye,Je),process.nextTick(Be,Je)}function q(ye,Be,Je,ct){var yt;return Je===null?yt=new E:typeof Je!="string"&&!Be.objectMode&&(yt=new x("chunk",["string","Buffer"],Je)),yt?(O(ye,yt),process.nextTick(ct,yt),!1):!0}N.prototype.write=function(ye,Be,Je){var ct=this._writableState,yt=!1,we=!ct.objectMode&&s(ye);return we&&!r.isBuffer(ye)&&(ye=c(ye)),typeof Be=="function"&&(Je=Be,Be=null),we?Be="buffer":Be||(Be=ct.defaultEncoding),typeof Je!="function"&&(Je=U),ct.ending?V(this,Je):(we||q(this,ct,ye,Je))&&(ct.pendingcb++,yt=Q(this,ct,we,ye,Be,Je)),yt},N.prototype.cork=function(){this._writableState.corked++},N.prototype.uncork=function(){var ye=this._writableState;ye.corked&&(ye.corked--,!ye.writing&&!ye.corked&&!ye.bufferProcessing&&ye.bufferedRequest&&Pe(this,ye))},N.prototype.setDefaultEncoding=function(Be){if(typeof Be=="string"&&(Be=Be.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((Be+"").toLowerCase())>-1))throw new D(Be);return this._writableState.defaultEncoding=Be,this},Object.defineProperty(N.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}});function z(ye,Be,Je){return!ye.objectMode&&ye.decodeStrings!==!1&&typeof Be=="string"&&(Be=r.from(Be,Je)),Be}Object.defineProperty(N.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}});function Q(ye,Be,Je,ct,yt,we){if(!Je){var fe=z(Be,ct,yt);ct!==fe&&(Je=!0,yt="buffer",ct=fe)}var Ve=Be.objectMode?1:ct.length;Be.length+=Ve;var tt=Be.length<Be.highWaterMark;if(tt||(Be.needDrain=!0),Be.writing||Be.corked){var Mt=Be.lastBufferedRequest;Be.lastBufferedRequest={chunk:ct,encoding:yt,isBuf:Je,callback:we,next:null},Mt?Mt.next=Be.lastBufferedRequest:Be.bufferedRequest=Be.lastBufferedRequest,Be.bufferedRequestCount+=1}else X(ye,Be,!1,Ve,ct,yt,we);return tt}function X(ye,Be,Je,ct,yt,we,fe){Be.writelen=ct,Be.writecb=fe,Be.writing=!0,Be.sync=!0,Be.destroyed?Be.onwrite(new L("write")):Je?ye._writev(yt,Be.onwrite):ye._write(yt,we,Be.onwrite),Be.sync=!1}function re(ye,Be,Je,ct,yt){--Be.pendingcb,Je?(process.nextTick(yt,ct),process.nextTick(Ue,ye,Be),ye._writableState.errorEmitted=!0,O(ye,ct)):(yt(ct),ye._writableState.errorEmitted=!0,O(ye,ct),Ue(ye,Be))}function oe(ye){ye.writing=!1,ye.writecb=null,ye.length-=ye.writelen,ye.writelen=0}function de(ye,Be){var Je=ye._writableState,ct=Je.sync,yt=Je.writecb;if(typeof yt!="function")throw new S;if(oe(Je),Be)re(ye,Je,ct,Be,yt);else{var we=je(Je)||ye.destroyed;!we&&!Je.corked&&!Je.bufferProcessing&&Je.bufferedRequest&&Pe(ye,Je),ct?process.nextTick(ce,ye,Je,we,yt):ce(ye,Je,we,yt)}}function ce(ye,Be,Je,ct){Je||Se(ye,Be),Be.pendingcb--,ct(),Ue(ye,Be)}function Se(ye,Be){Be.length===0&&Be.needDrain&&(Be.needDrain=!1,ye.emit("drain"))}function Pe(ye,Be){Be.bufferProcessing=!0;var Je=Be.bufferedRequest;if(ye._writev&&Je&&Je.next){var ct=Be.bufferedRequestCount,yt=new Array(ct),we=Be.corkedRequestsFree;we.entry=Je;for(var fe=0,Ve=!0;Je;)yt[fe]=Je,Je.isBuf||(Ve=!1),Je=Je.next,fe+=1;yt.allBuffers=Ve,X(ye,Be,!0,Be.length,yt,"",we.finish),Be.pendingcb++,Be.lastBufferedRequest=null,we.next?(Be.corkedRequestsFree=we.next,we.next=null):Be.corkedRequestsFree=new n(Be),Be.bufferedRequestCount=0}else{for(;Je;){var tt=Je.chunk,Mt=Je.encoding,mt=Je.callback,Ce=Be.objectMode?1:tt.length;if(X(ye,Be,!1,Ce,tt,Mt,mt),Je=Je.next,Be.bufferedRequestCount--,Be.writing)break}Je===null&&(Be.lastBufferedRequest=null)}Be.bufferedRequest=Je,Be.bufferProcessing=!1}N.prototype._write=function(ye,Be,Je){Je(new b("_write()"))},N.prototype._writev=null,N.prototype.end=function(ye,Be,Je){var ct=this._writableState;return typeof ye=="function"?(Je=ye,ye=null,Be=null):typeof Be=="function"&&(Je=Be,Be=null),ye!=null&&this.write(ye,Be),ct.corked&&(ct.corked=1,this.uncork()),ct.ending||ke(this,ct,Je),this},Object.defineProperty(N.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function je(ye){return ye.ending&&ye.length===0&&ye.bufferedRequest===null&&!ye.finished&&!ye.writing}function Fe(ye,Be){ye._final(function(Je){Be.pendingcb--,Je&&O(ye,Je),Be.prefinished=!0,ye.emit("prefinish"),Ue(ye,Be)})}function qe(ye,Be){!Be.prefinished&&!Be.finalCalled&&(typeof ye._final=="function"&&!Be.destroyed?(Be.pendingcb++,Be.finalCalled=!0,process.nextTick(Fe,ye,Be)):(Be.prefinished=!0,ye.emit("prefinish")))}function Ue(ye,Be){var Je=je(Be);if(Je&&(qe(ye,Be),Be.pendingcb===0&&(Be.finished=!0,ye.emit("finish"),Be.autoDestroy))){var ct=ye._readableState;(!ct||ct.autoDestroy&&ct.endEmitted)&&ye.destroy()}return Je}function ke(ye,Be,Je){Be.ending=!0,Ue(ye,Be),Je&&(Be.finished?process.nextTick(Je):ye.once("finish",Je)),Be.ended=!0,ye.writable=!1}function et(ye,Be,Je){var ct=ye.entry;for(ye.entry=null;ct;){var yt=ct.callback;Be.pendingcb--,yt(Je),ct=ct.next}Be.corkedRequestsFree.next=ye}return Object.defineProperty(N.prototype,"destroyed",{enumerable:!1,get:function(){return this._writableState===void 0?!1:this._writableState.destroyed},set:function(Be){this._writableState&&(this._writableState.destroyed=Be)}}),N.prototype.destroy=d.destroy,N.prototype._undestroy=d.undestroy,N.prototype._destroy=function(ye,Be){Be(ye)},fT}var pT,fR;function qg(){if(fR)return pT;fR=1;var n=Object.keys||function(p){var g=[];for(var _ in p)g.push(_);return g};pT=c;var e=dO(),t=hO();u_()(c,e);for(var i=n(t.prototype),r=0;r<i.length;r++){var o=i[r];c.prototype[o]||(c.prototype[o]=t.prototype[o])}function c(p){if(!(this instanceof c))return new c(p);e.call(this,p),t.call(this,p),this.allowHalfOpen=!0,p&&(p.readable===!1&&(this.readable=!1),p.writable===!1&&(this.writable=!1),p.allowHalfOpen===!1&&(this.allowHalfOpen=!1,this.once("end",s)))}Object.defineProperty(c.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(c.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(c.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function s(){this._writableState.ended||process.nextTick(d,this)}function d(p){p.end()}return Object.defineProperty(c.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0||this._writableState===void 0?!1:this._readableState.destroyed&&this._writableState.destroyed},set:function(g){this._readableState===void 0||this._writableState===void 0||(this._readableState.destroyed=g,this._writableState.destroyed=g)}}),pT}var mT={},Nb={exports:{}};var pR;function Yq(){return pR||(pR=1,(function(n,e){var t=Id,i=t.Buffer;function r(c,s){for(var d in c)s[d]=c[d]}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?n.exports=t:(r(t,e),e.Buffer=o);function o(c,s,d){return i(c,s,d)}o.prototype=Object.create(i.prototype),r(i,o),o.from=function(c,s,d){if(typeof c=="number")throw new TypeError("Argument must not be a number");return i(c,s,d)},o.alloc=function(c,s,d){if(typeof c!="number")throw new TypeError("Argument must be a number");var p=i(c);return s!==void 0?typeof d=="string"?p.fill(s,d):p.fill(s):p.fill(0),p},o.allocUnsafe=function(c){if(typeof c!="number")throw new TypeError("Argument must be a number");return i(c)},o.allocUnsafeSlow=function(c){if(typeof c!="number")throw new TypeError("Argument must be a number");return t.SlowBuffer(c)}})(Nb,Nb.exports)),Nb.exports}var mR;function gR(){if(mR)return mT;mR=1;var n=Yq().Buffer,e=n.isEncoding||function(E){switch(E=""+E,E&&E.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function t(E){if(!E)return"utf8";for(var C;;)switch(E){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return E;default:if(C)return;E=(""+E).toLowerCase(),C=!0}}function i(E){var C=t(E);if(typeof C!="string"&&(n.isEncoding===e||!e(E)))throw new Error("Unknown encoding: "+E);return C||E}mT.StringDecoder=r;function r(E){this.encoding=i(E);var C;switch(this.encoding){case"utf16le":this.text=_,this.end=x,C=4;break;case"utf8":this.fillLast=d,C=4;break;case"base64":this.text=b,this.end=S,C=3;break;default:this.write=P,this.end=L;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(C)}r.prototype.write=function(E){if(E.length===0)return"";var C,D;if(this.lastNeed){if(C=this.fillLast(E),C===void 0)return"";D=this.lastNeed,this.lastNeed=0}else D=0;return D<E.length?C?C+this.text(E,D):this.text(E,D):C||""},r.prototype.end=g,r.prototype.text=p,r.prototype.fillLast=function(E){if(this.lastNeed<=E.length)return E.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);E.copy(this.lastChar,this.lastTotal-this.lastNeed,0,E.length),this.lastNeed-=E.length};function o(E){return E<=127?0:E>>5===6?2:E>>4===14?3:E>>3===30?4:E>>6===2?-1:-2}function c(E,C,D){var O=C.length-1;if(O<D)return 0;var U=o(C[O]);return U>=0?(U>0&&(E.lastNeed=U-1),U):--O<D||U===-2?0:(U=o(C[O]),U>=0?(U>0&&(E.lastNeed=U-2),U):--O<D||U===-2?0:(U=o(C[O]),U>=0?(U>0&&(U===2?U=0:E.lastNeed=U-3),U):0))}function s(E,C,D){if((C[0]&192)!==128)return E.lastNeed=0,"ï¿½";if(E.lastNeed>1&&C.length>1){if((C[1]&192)!==128)return E.lastNeed=1,"ï¿½";if(E.lastNeed>2&&C.length>2&&(C[2]&192)!==128)return E.lastNeed=2,"ï¿½"}}function d(E){var C=this.lastTotal-this.lastNeed,D=s(this,E);if(D!==void 0)return D;if(this.lastNeed<=E.length)return E.copy(this.lastChar,C,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);E.copy(this.lastChar,C,0,E.length),this.lastNeed-=E.length}function p(E,C){var D=c(this,E,C);if(!this.lastNeed)return E.toString("utf8",C);this.lastTotal=D;var O=E.length-(D-this.lastNeed);return E.copy(this.lastChar,0,O),E.toString("utf8",C,O)}function g(E){var C=E&&E.length?this.write(E):"";return this.lastNeed?C+"ï¿½":C}function _(E,C){if((E.length-C)%2===0){var D=E.toString("utf16le",C);if(D){var O=D.charCodeAt(D.length-1);if(O>=55296&&O<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=E[E.length-2],this.lastChar[1]=E[E.length-1],D.slice(0,-1)}return D}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=E[E.length-1],E.toString("utf16le",C,E.length-1)}function x(E){var C=E&&E.length?this.write(E):"";if(this.lastNeed){var D=this.lastTotal-this.lastNeed;return C+this.lastChar.toString("utf16le",0,D)}return C}function b(E,C){var D=(E.length-C)%3;return D===0?E.toString("base64",C):(this.lastNeed=3-D,this.lastTotal=3,D===1?this.lastChar[0]=E[E.length-1]:(this.lastChar[0]=E[E.length-2],this.lastChar[1]=E[E.length-1]),E.toString("base64",C,E.length-D))}function S(E){var C=E&&E.length?this.write(E):"";return this.lastNeed?C+this.lastChar.toString("base64",0,3-this.lastNeed):C}function P(E){return E.toString(this.encoding)}function L(E){return E&&E.length?this.write(E):""}return mT}var gT,_R;function wC(){if(_R)return gT;_R=1;var n=c_().codes.ERR_STREAM_PREMATURE_CLOSE;function e(o){var c=!1;return function(){if(!c){c=!0;for(var s=arguments.length,d=new Array(s),p=0;p<s;p++)d[p]=arguments[p];o.apply(this,d)}}}function t(){}function i(o){return o.setHeader&&typeof o.abort=="function"}function r(o,c,s){if(typeof c=="function")return r(o,null,c);c||(c={}),s=e(s||t);var d=c.readable||c.readable!==!1&&o.readable,p=c.writable||c.writable!==!1&&o.writable,g=function(){o.writable||x()},_=o._writableState&&o._writableState.finished,x=function(){p=!1,_=!0,d||s.call(o)},b=o._readableState&&o._readableState.endEmitted,S=function(){d=!1,b=!0,p||s.call(o)},P=function(D){s.call(o,D)},L=function(){var D;if(d&&!b)return(!o._readableState||!o._readableState.ended)&&(D=new n),s.call(o,D);if(p&&!_)return(!o._writableState||!o._writableState.ended)&&(D=new n),s.call(o,D)},E=function(){o.req.on("finish",x)};return i(o)?(o.on("complete",x),o.on("abort",L),o.req?E():o.on("request",E)):p&&!o._writableState&&(o.on("end",g),o.on("close",g)),o.on("end",S),o.on("finish",x),c.error!==!1&&o.on("error",P),o.on("close",L),function(){o.removeListener("complete",x),o.removeListener("abort",L),o.removeListener("request",E),o.req&&o.req.removeListener("finish",x),o.removeListener("end",g),o.removeListener("close",g),o.removeListener("finish",x),o.removeListener("end",S),o.removeListener("error",P),o.removeListener("close",L)}}return gT=r,gT}var _T,vR;function Kq(){if(vR)return _T;vR=1;var n;function e(D,O,U){return O=t(O),O in D?Object.defineProperty(D,O,{value:U,enumerable:!0,configurable:!0,writable:!0}):D[O]=U,D}function t(D){var O=i(D,"string");return typeof O=="symbol"?O:String(O)}function i(D,O){if(typeof D!="object"||D===null)return D;var U=D[Symbol.toPrimitive];if(U!==void 0){var j=U.call(D,O);if(typeof j!="object")return j;throw new TypeError("@@toPrimitive must return a primitive value.")}return(O==="string"?String:Number)(D)}var r=wC(),o=Symbol("lastResolve"),c=Symbol("lastReject"),s=Symbol("error"),d=Symbol("ended"),p=Symbol("lastPromise"),g=Symbol("handlePromise"),_=Symbol("stream");function x(D,O){return{value:D,done:O}}function b(D){var O=D[o];if(O!==null){var U=D[_].read();U!==null&&(D[p]=null,D[o]=null,D[c]=null,O(x(U,!1)))}}function S(D){process.nextTick(b,D)}function P(D,O){return function(U,j){D.then(function(){if(O[d]){U(x(void 0,!0));return}O[g](U,j)},j)}}var L=Object.getPrototypeOf(function(){}),E=Object.setPrototypeOf((n={get stream(){return this[_]},next:function(){var O=this,U=this[s];if(U!==null)return Promise.reject(U);if(this[d])return Promise.resolve(x(void 0,!0));if(this[_].destroyed)return new Promise(function(V,q){process.nextTick(function(){O[s]?q(O[s]):V(x(void 0,!0))})});var j=this[p],G;if(j)G=new Promise(P(j,this));else{var N=this[_].read();if(N!==null)return Promise.resolve(x(N,!1));G=new Promise(this[g])}return this[p]=G,G}},e(n,Symbol.asyncIterator,function(){return this}),e(n,"return",function(){var O=this;return new Promise(function(U,j){O[_].destroy(null,function(G){if(G){j(G);return}U(x(void 0,!0))})})}),n),L),C=function(O){var U,j=Object.create(E,(U={},e(U,_,{value:O,writable:!0}),e(U,o,{value:null,writable:!0}),e(U,c,{value:null,writable:!0}),e(U,s,{value:null,writable:!0}),e(U,d,{value:O._readableState.endEmitted,writable:!0}),e(U,g,{value:function(N,V){var q=j[_].read();q?(j[p]=null,j[o]=null,j[c]=null,N(x(q,!1))):(j[o]=N,j[c]=V)},writable:!0}),U));return j[p]=null,r(O,function(G){if(G&&G.code!=="ERR_STREAM_PREMATURE_CLOSE"){var N=j[c];N!==null&&(j[p]=null,j[o]=null,j[c]=null,N(G)),j[s]=G;return}var V=j[o];V!==null&&(j[p]=null,j[o]=null,j[c]=null,V(x(void 0,!0))),j[d]=!0}),O.on("readable",S.bind(null,j)),j};return _T=C,_T}var vT,yR;function Jq(){return yR||(yR=1,vT=function(){throw new Error("Readable.from is not available in the browser")}),vT}var yT,bR;function dO(){if(bR)return yT;bR=1,yT=V;var n;V.ReadableState=N,Id.EventEmitter;var e=function(fe,Ve){return fe.listeners(Ve).length},t=lO(),i=Id.Buffer,r=(typeof zg<"u"?zg:typeof window<"u"?window:typeof self<"u"?self:{}).Uint8Array||function(){};function o(we){return i.from(we)}function c(we){return i.isBuffer(we)||we instanceof r}var s=Id,d;s&&s.debuglog?d=s.debuglog("stream"):d=function(){};var p=Zq(),g=cO(),_=uO(),x=_.getHighWaterMark,b=c_().codes,S=b.ERR_INVALID_ARG_TYPE,P=b.ERR_STREAM_PUSH_AFTER_EOF,L=b.ERR_METHOD_NOT_IMPLEMENTED,E=b.ERR_STREAM_UNSHIFT_AFTER_END_EVENT,C,D,O;u_()(V,t);var U=g.errorOrDestroy,j=["error","close","destroy","pause","resume"];function G(we,fe,Ve){if(typeof we.prependListener=="function")return we.prependListener(fe,Ve);!we._events||!we._events[fe]?we.on(fe,Ve):Array.isArray(we._events[fe])?we._events[fe].unshift(Ve):we._events[fe]=[Ve,we._events[fe]]}function N(we,fe,Ve){n=n||qg(),we=we||{},typeof Ve!="boolean"&&(Ve=fe instanceof n),this.objectMode=!!we.objectMode,Ve&&(this.objectMode=this.objectMode||!!we.readableObjectMode),this.highWaterMark=x(this,we,"readableHighWaterMark",Ve),this.buffer=new p,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=we.emitClose!==!1,this.autoDestroy=!!we.autoDestroy,this.destroyed=!1,this.defaultEncoding=we.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,we.encoding&&(C||(C=gR().StringDecoder),this.decoder=new C(we.encoding),this.encoding=we.encoding)}function V(we){if(n=n||qg(),!(this instanceof V))return new V(we);var fe=this instanceof n;this._readableState=new N(we,this,fe),this.readable=!0,we&&(typeof we.read=="function"&&(this._read=we.read),typeof we.destroy=="function"&&(this._destroy=we.destroy)),t.call(this)}Object.defineProperty(V.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0?!1:this._readableState.destroyed},set:function(fe){this._readableState&&(this._readableState.destroyed=fe)}}),V.prototype.destroy=g.destroy,V.prototype._undestroy=g.undestroy,V.prototype._destroy=function(we,fe){fe(we)},V.prototype.push=function(we,fe){var Ve=this._readableState,tt;return Ve.objectMode?tt=!0:typeof we=="string"&&(fe=fe||Ve.defaultEncoding,fe!==Ve.encoding&&(we=i.from(we,fe),fe=""),tt=!0),q(this,we,fe,!1,tt)},V.prototype.unshift=function(we){return q(this,we,null,!0,!1)};function q(we,fe,Ve,tt,Mt){d("readableAddChunk",fe);var mt=we._readableState;if(fe===null)mt.reading=!1,de(we,mt);else{var Ce;if(Mt||(Ce=Q(mt,fe)),Ce)U(we,Ce);else if(mt.objectMode||fe&&fe.length>0)if(typeof fe!="string"&&!mt.objectMode&&Object.getPrototypeOf(fe)!==i.prototype&&(fe=o(fe)),tt)mt.endEmitted?U(we,new E):z(we,mt,fe,!0);else if(mt.ended)U(we,new P);else{if(mt.destroyed)return!1;mt.reading=!1,mt.decoder&&!Ve?(fe=mt.decoder.write(fe),mt.objectMode||fe.length!==0?z(we,mt,fe,!1):Pe(we,mt)):z(we,mt,fe,!1)}else tt||(mt.reading=!1,Pe(we,mt))}return!mt.ended&&(mt.length<mt.highWaterMark||mt.length===0)}function z(we,fe,Ve,tt){fe.flowing&&fe.length===0&&!fe.sync?(fe.awaitDrain=0,we.emit("data",Ve)):(fe.length+=fe.objectMode?1:Ve.length,tt?fe.buffer.unshift(Ve):fe.buffer.push(Ve),fe.needReadable&&ce(we)),Pe(we,fe)}function Q(we,fe){var Ve;return!c(fe)&&typeof fe!="string"&&fe!==void 0&&!we.objectMode&&(Ve=new S("chunk",["string","Buffer","Uint8Array"],fe)),Ve}V.prototype.isPaused=function(){return this._readableState.flowing===!1},V.prototype.setEncoding=function(we){C||(C=gR().StringDecoder);var fe=new C(we);this._readableState.decoder=fe,this._readableState.encoding=this._readableState.decoder.encoding;for(var Ve=this._readableState.buffer.head,tt="";Ve!==null;)tt+=fe.write(Ve.data),Ve=Ve.next;return this._readableState.buffer.clear(),tt!==""&&this._readableState.buffer.push(tt),this._readableState.length=tt.length,this};var X=1073741824;function re(we){return we>=X?we=X:(we--,we|=we>>>1,we|=we>>>2,we|=we>>>4,we|=we>>>8,we|=we>>>16,we++),we}function oe(we,fe){return we<=0||fe.length===0&&fe.ended?0:fe.objectMode?1:we!==we?fe.flowing&&fe.length?fe.buffer.head.data.length:fe.length:(we>fe.highWaterMark&&(fe.highWaterMark=re(we)),we<=fe.length?we:fe.ended?fe.length:(fe.needReadable=!0,0))}V.prototype.read=function(we){d("read",we),we=parseInt(we,10);var fe=this._readableState,Ve=we;if(we!==0&&(fe.emittedReadable=!1),we===0&&fe.needReadable&&((fe.highWaterMark!==0?fe.length>=fe.highWaterMark:fe.length>0)||fe.ended))return d("read: emitReadable",fe.length,fe.ended),fe.length===0&&fe.ended?Je(this):ce(this),null;if(we=oe(we,fe),we===0&&fe.ended)return fe.length===0&&Je(this),null;var tt=fe.needReadable;d("need readable",tt),(fe.length===0||fe.length-we<fe.highWaterMark)&&(tt=!0,d("length less than watermark",tt)),fe.ended||fe.reading?(tt=!1,d("reading or ended",tt)):tt&&(d("do read"),fe.reading=!0,fe.sync=!0,fe.length===0&&(fe.needReadable=!0),this._read(fe.highWaterMark),fe.sync=!1,fe.reading||(we=oe(Ve,fe)));var Mt;return we>0?Mt=Be(we,fe):Mt=null,Mt===null?(fe.needReadable=fe.length<=fe.highWaterMark,we=0):(fe.length-=we,fe.awaitDrain=0),fe.length===0&&(fe.ended||(fe.needReadable=!0),Ve!==we&&fe.ended&&Je(this)),Mt!==null&&this.emit("data",Mt),Mt};function de(we,fe){if(d("onEofChunk"),!fe.ended){if(fe.decoder){var Ve=fe.decoder.end();Ve&&Ve.length&&(fe.buffer.push(Ve),fe.length+=fe.objectMode?1:Ve.length)}fe.ended=!0,fe.sync?ce(we):(fe.needReadable=!1,fe.emittedReadable||(fe.emittedReadable=!0,Se(we)))}}function ce(we){var fe=we._readableState;d("emitReadable",fe.needReadable,fe.emittedReadable),fe.needReadable=!1,fe.emittedReadable||(d("emitReadable",fe.flowing),fe.emittedReadable=!0,process.nextTick(Se,we))}function Se(we){var fe=we._readableState;d("emitReadable_",fe.destroyed,fe.length,fe.ended),!fe.destroyed&&(fe.length||fe.ended)&&(we.emit("readable"),fe.emittedReadable=!1),fe.needReadable=!fe.flowing&&!fe.ended&&fe.length<=fe.highWaterMark,ye(we)}function Pe(we,fe){fe.readingMore||(fe.readingMore=!0,process.nextTick(je,we,fe))}function je(we,fe){for(;!fe.reading&&!fe.ended&&(fe.length<fe.highWaterMark||fe.flowing&&fe.length===0);){var Ve=fe.length;if(d("maybeReadMore read 0"),we.read(0),Ve===fe.length)break}fe.readingMore=!1}V.prototype._read=function(we){U(this,new L("_read()"))},V.prototype.pipe=function(we,fe){var Ve=this,tt=this._readableState;switch(tt.pipesCount){case 0:tt.pipes=we;break;case 1:tt.pipes=[tt.pipes,we];break;default:tt.pipes.push(we);break}tt.pipesCount+=1,d("pipe count=%d opts=%j",tt.pipesCount,fe);var Mt=(!fe||fe.end!==!1)&&we!==process.stdout&&we!==process.stderr,mt=Mt?xe:Te;tt.endEmitted?process.nextTick(mt):Ve.once("end",mt),we.on("unpipe",Ce);function Ce(te,he){d("onunpipe"),te===Ve&&he&&he.hasUnpiped===!1&&(he.hasUnpiped=!0,ie())}function xe(){d("onend"),we.end()}var vt=Fe(Ve);we.on("drain",vt);var be=!1;function ie(){d("cleanup"),we.removeListener("close",Xe),we.removeListener("finish",bt),we.removeListener("drain",vt),we.removeListener("error",De),we.removeListener("unpipe",Ce),Ve.removeListener("end",xe),Ve.removeListener("end",Te),Ve.removeListener("data",ae),be=!0,tt.awaitDrain&&(!we._writableState||we._writableState.needDrain)&&vt()}Ve.on("data",ae);function ae(te){d("ondata");var he=we.write(te);d("dest.write",he),he===!1&&((tt.pipesCount===1&&tt.pipes===we||tt.pipesCount>1&&yt(tt.pipes,we)!==-1)&&!be&&(d("false write response, pause",tt.awaitDrain),tt.awaitDrain++),Ve.pause())}function De(te){d("onerror",te),Te(),we.removeListener("error",De),e(we,"error")===0&&U(we,te)}G(we,"error",De);function Xe(){we.removeListener("finish",bt),Te()}we.once("close",Xe);function bt(){d("onfinish"),we.removeListener("close",Xe),Te()}we.once("finish",bt);function Te(){d("unpipe"),Ve.unpipe(we)}return we.emit("pipe",Ve),tt.flowing||(d("pipe resume"),Ve.resume()),we};function Fe(we){return function(){var Ve=we._readableState;d("pipeOnDrain",Ve.awaitDrain),Ve.awaitDrain&&Ve.awaitDrain--,Ve.awaitDrain===0&&e(we,"data")&&(Ve.flowing=!0,ye(we))}}V.prototype.unpipe=function(we){var fe=this._readableState,Ve={hasUnpiped:!1};if(fe.pipesCount===0)return this;if(fe.pipesCount===1)return we&&we!==fe.pipes?this:(we||(we=fe.pipes),fe.pipes=null,fe.pipesCount=0,fe.flowing=!1,we&&we.emit("unpipe",this,Ve),this);if(!we){var tt=fe.pipes,Mt=fe.pipesCount;fe.pipes=null,fe.pipesCount=0,fe.flowing=!1;for(var mt=0;mt<Mt;mt++)tt[mt].emit("unpipe",this,{hasUnpiped:!1});return this}var Ce=yt(fe.pipes,we);return Ce===-1?this:(fe.pipes.splice(Ce,1),fe.pipesCount-=1,fe.pipesCount===1&&(fe.pipes=fe.pipes[0]),we.emit("unpipe",this,Ve),this)},V.prototype.on=function(we,fe){var Ve=t.prototype.on.call(this,we,fe),tt=this._readableState;return we==="data"?(tt.readableListening=this.listenerCount("readable")>0,tt.flowing!==!1&&this.resume()):we==="readable"&&!tt.endEmitted&&!tt.readableListening&&(tt.readableListening=tt.needReadable=!0,tt.flowing=!1,tt.emittedReadable=!1,d("on readable",tt.length,tt.reading),tt.length?ce(this):tt.reading||process.nextTick(Ue,this)),Ve},V.prototype.addListener=V.prototype.on,V.prototype.removeListener=function(we,fe){var Ve=t.prototype.removeListener.call(this,we,fe);return we==="readable"&&process.nextTick(qe,this),Ve},V.prototype.removeAllListeners=function(we){var fe=t.prototype.removeAllListeners.apply(this,arguments);return(we==="readable"||we===void 0)&&process.nextTick(qe,this),fe};function qe(we){var fe=we._readableState;fe.readableListening=we.listenerCount("readable")>0,fe.resumeScheduled&&!fe.paused?fe.flowing=!0:we.listenerCount("data")>0&&we.resume()}function Ue(we){d("readable nexttick read 0"),we.read(0)}V.prototype.resume=function(){var we=this._readableState;return we.flowing||(d("resume"),we.flowing=!we.readableListening,ke(this,we)),we.paused=!1,this};function ke(we,fe){fe.resumeScheduled||(fe.resumeScheduled=!0,process.nextTick(et,we,fe))}function et(we,fe){d("resume",fe.reading),fe.reading||we.read(0),fe.resumeScheduled=!1,we.emit("resume"),ye(we),fe.flowing&&!fe.reading&&we.read(0)}V.prototype.pause=function(){return d("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(d("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this};function ye(we){var fe=we._readableState;for(d("flow",fe.flowing);fe.flowing&&we.read()!==null;);}V.prototype.wrap=function(we){var fe=this,Ve=this._readableState,tt=!1;we.on("end",function(){if(d("wrapped end"),Ve.decoder&&!Ve.ended){var Ce=Ve.decoder.end();Ce&&Ce.length&&fe.push(Ce)}fe.push(null)}),we.on("data",function(Ce){if(d("wrapped data"),Ve.decoder&&(Ce=Ve.decoder.write(Ce)),!(Ve.objectMode&&Ce==null)&&!(!Ve.objectMode&&(!Ce||!Ce.length))){var xe=fe.push(Ce);xe||(tt=!0,we.pause())}});for(var Mt in we)this[Mt]===void 0&&typeof we[Mt]=="function"&&(this[Mt]=(function(xe){return function(){return we[xe].apply(we,arguments)}})(Mt));for(var mt=0;mt<j.length;mt++)we.on(j[mt],this.emit.bind(this,j[mt]));return this._read=function(Ce){d("wrapped _read",Ce),tt&&(tt=!1,we.resume())},this},typeof Symbol=="function"&&(V.prototype[Symbol.asyncIterator]=function(){return D===void 0&&(D=Kq()),D(this)}),Object.defineProperty(V.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(V.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(V.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(fe){this._readableState&&(this._readableState.flowing=fe)}}),V._fromList=Be,Object.defineProperty(V.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}});function Be(we,fe){if(fe.length===0)return null;var Ve;return fe.objectMode?Ve=fe.buffer.shift():!we||we>=fe.length?(fe.decoder?Ve=fe.buffer.join(""):fe.buffer.length===1?Ve=fe.buffer.first():Ve=fe.buffer.concat(fe.length),fe.buffer.clear()):Ve=fe.buffer.consume(we,fe.decoder),Ve}function Je(we){var fe=we._readableState;d("endReadable",fe.endEmitted),fe.endEmitted||(fe.ended=!0,process.nextTick(ct,fe,we))}function ct(we,fe){if(d("endReadableNT",we.endEmitted,we.length),!we.endEmitted&&we.length===0&&(we.endEmitted=!0,fe.readable=!1,fe.emit("end"),we.autoDestroy)){var Ve=fe._writableState;(!Ve||Ve.autoDestroy&&Ve.finished)&&fe.destroy()}}typeof Symbol=="function"&&(V.from=function(we,fe){return O===void 0&&(O=Jq()),O(V,we,fe)});function yt(we,fe){for(var Ve=0,tt=we.length;Ve<tt;Ve++)if(we[Ve]===fe)return Ve;return-1}return yT}var bT,xR;function fO(){if(xR)return bT;xR=1,bT=s;var n=c_().codes,e=n.ERR_METHOD_NOT_IMPLEMENTED,t=n.ERR_MULTIPLE_CALLBACK,i=n.ERR_TRANSFORM_ALREADY_TRANSFORMING,r=n.ERR_TRANSFORM_WITH_LENGTH_0,o=qg();u_()(s,o);function c(g,_){var x=this._transformState;x.transforming=!1;var b=x.writecb;if(b===null)return this.emit("error",new t);x.writechunk=null,x.writecb=null,_!=null&&this.push(_),b(g);var S=this._readableState;S.reading=!1,(S.needReadable||S.length<S.highWaterMark)&&this._read(S.highWaterMark)}function s(g){if(!(this instanceof s))return new s(g);o.call(this,g),this._transformState={afterTransform:c.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,g&&(typeof g.transform=="function"&&(this._transform=g.transform),typeof g.flush=="function"&&(this._flush=g.flush)),this.on("prefinish",d)}function d(){var g=this;typeof this._flush=="function"&&!this._readableState.destroyed?this._flush(function(_,x){p(g,_,x)}):p(this,null,null)}s.prototype.push=function(g,_){return this._transformState.needTransform=!1,o.prototype.push.call(this,g,_)},s.prototype._transform=function(g,_,x){x(new e("_transform()"))},s.prototype._write=function(g,_,x){var b=this._transformState;if(b.writecb=x,b.writechunk=g,b.writeencoding=_,!b.transforming){var S=this._readableState;(b.needTransform||S.needReadable||S.length<S.highWaterMark)&&this._read(S.highWaterMark)}},s.prototype._read=function(g){var _=this._transformState;_.writechunk!==null&&!_.transforming?(_.transforming=!0,this._transform(_.writechunk,_.writeencoding,_.afterTransform)):_.needTransform=!0},s.prototype._destroy=function(g,_){o.prototype._destroy.call(this,g,function(x){_(x)})};function p(g,_,x){if(_)return g.emit("error",_);if(x!=null&&g.push(x),g._writableState.length)throw new r;if(g._transformState.transforming)throw new i;return g.push(null)}return bT}var xT,wR;function Qq(){if(wR)return xT;wR=1,xT=e;var n=fO();u_()(e,n);function e(t){if(!(this instanceof e))return new e(t);n.call(this,t)}return e.prototype._transform=function(t,i,r){r(null,t)},xT}var wT,SR;function e7(){if(SR)return wT;SR=1;var n;function e(x){var b=!1;return function(){b||(b=!0,x.apply(void 0,arguments))}}var t=c_().codes,i=t.ERR_MISSING_ARGS,r=t.ERR_STREAM_DESTROYED;function o(x){if(x)throw x}function c(x){return x.setHeader&&typeof x.abort=="function"}function s(x,b,S,P){P=e(P);var L=!1;x.on("close",function(){L=!0}),n===void 0&&(n=wC()),n(x,{readable:b,writable:S},function(C){if(C)return P(C);L=!0,P()});var E=!1;return function(C){if(!L&&!E){if(E=!0,c(x))return x.abort();if(typeof x.destroy=="function")return x.destroy();P(C||new r("pipe"))}}}function d(x){x()}function p(x,b){return x.pipe(b)}function g(x){return!x.length||typeof x[x.length-1]!="function"?o:x.pop()}function _(){for(var x=arguments.length,b=new Array(x),S=0;S<x;S++)b[S]=arguments[S];var P=g(b);if(Array.isArray(b[0])&&(b=b[0]),b.length<2)throw new i("streams");var L,E=b.map(function(C,D){var O=D<b.length-1,U=D>0;return s(C,O,U,function(j){L||(L=j),j&&E.forEach(d),!O&&(E.forEach(d),P(L))})});return b.reduce(p)}return wT=_,wT}var TR;function t7(){return TR||(TR=1,(function(n,e){e=n.exports=dO(),e.Stream=e,e.Readable=e,e.Writable=hO(),e.Duplex=qg(),e.Transform=fO(),e.PassThrough=Qq(),e.finished=wC(),e.pipeline=e7()})(zb,zb.exports)),zb.exports}var MR;function i7(){if(MR)return Cv.exports;MR=1;var n=t7().Transform,e=u_();function t(o){n.call(this,o),this._destroyed=!1}e(t,n),t.prototype.destroy=function(o){if(!this._destroyed){this._destroyed=!0;var c=this;process.nextTick(function(){o&&c.emit("error",o),c.emit("close")})}};function i(o,c,s){s(null,o)}function r(o){return function(c,s,d){return typeof c=="function"&&(d=s,s=c,c={}),typeof s!="function"&&(s=i),typeof d!="function"&&(d=null),o(c,s,d)}}return Cv.exports=r(function(o,c,s){var d=new t(o);return d._transform=c,s&&(d._flush=s),d}),Cv.exports.ctor=r(function(o,c,s){function d(p){if(!(this instanceof d))return new d(p);this.options=Object.assign({},o,p),t.call(this,this.options)}return e(d,t),d.prototype._transform=c,s&&(d.prototype._flush=s),d}),Cv.exports.obj=r(function(o,c,s){var d=new t(Object.assign({objectMode:!0,highWaterMark:16},o));return d._transform=c,s&&(d._flush=s),d}),Cv.exports}i7();function $b(n,e){for(const t of n.children)t.tagName==="tag"&&e.addTag(t.attributes.k,t.attributes.v)}function n7(n,e){const t=qq(n,{noChildNodes:[]});for(const i of t)if(i.tagName==="osm")for(const r of i.children){if(r.children.find(o=>["point","vertex","linestring","group"].includes(o.tagName))){const o=new rO(r.tagName,r.attributes.id,e);o.addMetas(tp(r.attributes,["id","type","tags","geometry"])),$b(r,o);const c=[],s=[];for(const d of r.children)switch(d.tagName){case"point":o.setGeometry({type:"Point",coordinates:[parseFloat(d.attributes.lon),parseFloat(d.attributes.lat)]});break;case"vertex":c.push([parseFloat(d.attributes.lon),parseFloat(d.attributes.lat)]);break;case"linestring":const p=[];for(const _ of d.children)p.push([parseFloat(_.attributes.lon),parseFloat(_.attributes.lat)]);o.setGeometry({type:"Polygon",coordinates:[p]});break;case"group":const g=[];for(const _ of d.children)switch(_.tagName){case"point":s.push({type:"Point",coordinates:[parseFloat(_.attributes.lon),parseFloat(_.attributes.lat)]});break;case"vertex":g.push([parseFloat(_.attributes.lon),parseFloat(_.attributes.lat)]);break}g.length>0&&s.push({type:"LineString",coordinates:g});break}c.length>0?o.setGeometry({type:"LineString",coordinates:c}):s.length>0&&o.setGeometry({type:"GeometryCollection",geometries:s});continue}switch(r.tagName){case"node":const o=new xC(r.attributes.id,e);$b(r,o),o.addMetas(tp(r.attributes,["id","lon","lat"])),o.setLatLng(r.attributes);break;case"way":const c=new Sw(r.attributes.id,e);$b(r,c),c.addMetas(tp(r.attributes,["id","type"]));for(const d of r.children)switch(d.tagName){case"center":c.setCenter(d.attributes);break;case"nd":d.attributes.lon&&d.attributes.lat?c.addLatLng(d.attributes):c.addNodeRef(d.attributes.ref);break}break;case"relation":const s=new sO(r.attributes.id,e);$b(r,s);for(const d of r.children)switch(d.tagName){case"center":s.setCenter(d.attributes);break;case"member":const p={type:d.attributes.type,role:d.attributes.role||"",ref:d.attributes.ref};if(d.attributes.type==="node"&&d.attributes.lon&&d.attributes.lat)p.lon=d.attributes.lon,p.lat=d.attributes.lat;else{const g=[],_=[];for(const x of d.children)x.attributes.lon&&x.attributes.lat?g.push(x.attributes):x.attributes.ref&&_.push(x.attributes.ref);g.length>0?p.geometry=g:_.length>0&&(p.nodes=_)}s.addMember(p);break;case"bounds":s.setBounds([parseFloat(d.attributes.minlon),parseFloat(d.attributes.minlat),parseFloat(d.attributes.maxlon),parseFloat(d.attributes.maxlat)]);break}break}}}function r7(n){return n?{elementId:n.elementId}:{elementId:void 0}}function s7(n){return n.elements?"json":n.indexOf("<osm")>=0?"xml":n.trim().startsWith("{")?"json-raw":"invalid"}function o7(n,e){var t;let{elementId:i}=r7(e),r=s7(n);const o=new gq;if(r==="json-raw"&&(n=JSON.parse(n),n.elements?r="json":r="invalid"),r==="json"?Gq(n,o):r==="xml"&&n7(n,o),o.bindAll(),i)return(t=o.get(i))===null||t===void 0?void 0:t.toFeature();let c=[];for(const s of o.values()){if(s.refCount>0&&!s.hasTag)continue;const d=s.toFeature();d&&c.push(d)}return{type:"FeatureCollection",features:c}}async function a7(n){const e=`[out:json]; relation(${n}); out geom;`,i=await(await r1(e)).json();if(!i.elements||i.elements.length===0)throw new Error(`Relation ${n} not found`);if(i.elements[0].type!=="relation")throw new Error(`Object ${n} is not a relation`);const o=o7(i,{elementId:`relation/${n}`});return!o||!("geometry"in o)?null:o.geometry}function l7(n){const e=jg(n),t=mq(e);if(!t||t.geometry.type!=="Polygon")throw new Error("Failed to create convex hull");return t}async function c7(n){const e=await a7(n);if(!e)throw new Error("Relation has no geometry");await al();const t=l7(e);await al();const r=await(await r1(bC(t))).bytes();if(Z2(ky)){let o=new TextDecoder().decode(r);h0(`relation_${n}.osm.xml`,o)}await al(),zs.set(new Dy(new Uint8Array(r),t))}var u7=Wt('<!> <div class="mt-3"><p class="fst-italic my-3">orâ¦</p> <div class="mb-2"><label for="relation-id" class="form-label">Load from relation ID</label> <div class="input-group"><input id="relation-id" type="text" inputmode="numeric" pattern="[0-9]*" class="form-control" placeholder="e.g., 1310102"/> <button class="btn btn-primary" type="button">Load</button></div></div></div>',1);function h7(n,e){en(e,!0);let t=ii(""),i=ii(""),r=Kt(()=>{const b=ee(t).trim(),S=parseInt(b);return b!==""&&!isNaN(S)&&S>0});async function o(){const b=parseInt(ee(t).trim());if(!b||b<=0){window.alert("Please enter a valid relation ID");return}try{Et(i,"Loading relation..."),await c7(b),e.onSuccess?.()}catch(S){window.alert(`Failed to load relation: ${S}`)}finally{Et(i,"")}}var c=u7(),s=ci(c);Jd(s,{get loading(){return ee(i)}});var d=gt(s,2),p=gt(Ft(d),2),g=gt(Ft(p),2),_=Ft(g);_.__keydown=b=>{b.key==="Enter"&&ee(r)&&o()};var x=gt(_,2);x.__click=o,Zi(()=>x.disabled=!ee(r)),Kw("paste",_,b=>{setTimeout(()=>{Et(t,ee(t).trim(),!0)},0)}),Tg(_,()=>ee(t),b=>Et(t,b)),xt(n,c),tn()}ds(["keydown","click"]);var d7=Wt("<!> <!>",1);function f7(n,e){en(e,!0);const t=()=>Qi(zs,"$backend",r),i=()=>Qi(Fh,"$map",r),[r,o]=qr();let c=ii("");async function s(x,b){try{Et(c,"Importing OSM data"),await al(),Do(zs,new Dy(x,b)),d()}catch(S){window.alert(`Bad OSM input: ${S}`)}finally{Et(c,"")}}function d(){i().fitBounds(KF(JSON.parse(t().getNodes())),{animate:!1,padding:10})}var p=d7(),g=ci(p);Jd(g,{get loading(){return ee(c)}});var _=gt(g,2);u0(_,{left:S=>{BG(S,{get map(){return i()},onloading:P=>Et(c,P,!0),onload:s,onerror:P=>{window.alert(P),Et(c,"")},children:(P,L)=>{h7(P,{onSuccess:d})},$$slots:{default:!0}})},main:S=>{kU(S)},$$slots:{left:!0,main:!0}}),xt(n,p),tn(),o()}const p7="/speedwalk/assets/favicon-DMAVMD4u.ico",m7="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAApElEQVRIS+XUQQqAIBAFUOcgnaEIul/tO1kQdYau0AHsC64y4n9BIWozG/lPx0lzhT8rnO9+BnjvZ7T0NLOJbS3dIoQ3CD1i8MgiNBCCgbQou4JIQEQ61I1FZCAiPerKIFmAgmQDERlQl7eTJAAu0rMj+LAuma76gLJ7HFZvEQsgnJqkrEtmw8NmZQDh5X40NVw6Qa3HrtxzzU7XfZ18ySr0feACKA1QGcdX8MgAAAAASUVORK5CYII=",g7="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAu0lEQVRIS2NkoDFgpLH5DKMWEAxhUoOoHmpiI0GToQpIsQBkeANUH4gmyhJiLUA2HOZ4oiwhxgJkw42gpp8j1ieELEA23ABo6EWowfpA+gIxluCzANlwPaBhl9EiVhfIv0TIEnwWlAM1dwCxJhDfgBqEnoq0gOJXgbgCiDuxpSxCQSQA1PQByXBsqQhZDYYdhCyAaRhNRVgz/oCkInSXUDUVYfUmUJAqqQiX4QTFiU2mBA3CpWDUAoJBBwDGtiwZhFZ9ZQAAAABJRU5ErkJggg==";var _7=Wt('<div><button class="btn btn-danger mb-3"> </button></div>'),v7=Wt(`<h1>Customize basemaps</h1> <!> <div class="card"><div class="card-header">Add a basemap</div> <div class="card-body"><p>You can add custom basemaps if you know a tile URL and that the imagery
        has a license allowing it to be used for editing OSM.</p> <ul><li><a href="https://github.com/osmlab/editor-layer-index" target="_blank">editor-layer-index</a> is a great reference, or you could check in iD or JOSM and figure out which
          one you like to use for your area.</li> <li>If you copy a URL from there, you may need to manually substitute some
          parts of the URL to make it work.</li> <li><b>&lbrace;zoom&rbrace;</b> &rarr; <b>&lbrace;z&rbrace;</b></li> <li><b>&lbrace;proj&rbrace;</b> &rarr; <b>&lbrace;EPSG:3857&rbrace;</b></li> <li><b>&lbrace;width&rbrace;</b> &rarr; <b>256</b></li> <li><b>&lbrace;height&rbrace;</b> &rarr; <b>256</b></li> <li><b>&lbrace;bbox&rbrace;</b> &rarr; <b>&lbrace;bbox-epsg-3857&rbrace;</b></li> <li>Some sources have CORS restrictions and won't work</li></ul> <div><label class="form-label">Name: <input class="form-control" type="text"/></label></div> <div><label class="form-label">Tile URL: <textarea class="form-control" rows="3" cols="80"></textarea></label></div> <div><label class="form-label">Attribution: <input class="form-control" type="text"/></label></div> <button class="btn btn-primary">Add basemap</button></div></div> <div class="mt-5"><button class="btn btn-primary">Done</button></div>`,1);function y7(n,e){en(e,!0);let t=ft(e,"show",15),i="speedwalk-custom-basemaps",r=ii(xs(JSON.parse(window.localStorage.getItem(i)||"[]")));for(let _ of ee(r))op.set(_.name,d(_.tileURL,_.attribution));let o=ii(""),c=ii(""),s=ii("");function d(_,x){return{version:8,sources:{"raster-tiles":{type:"raster",tiles:[_],tileSize:256,attribution:x}},layers:[{id:"raster-basemap",type:"raster",source:"raster-tiles"},{id:"Road labels",type:"background",layout:{visibility:"none"}}],glyphs:"https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=MZEJTanw3WpxRvt7qDfo"}}function p(){ee(r).push({name:ee(o),tileURL:ee(c),attribution:ee(s)}),window.localStorage.setItem(i,JSON.stringify(ee(r))),op.set(ee(o),d(ee(c),ee(s))),Et(o,""),Et(c,""),Et(s,"")}function g(_){Et(r,ee(r).filter(x=>x.name!=_),!0),window.localStorage.setItem(i,JSON.stringify(ee(r))),op.delete(_)}_p(n,{get show(){return t()},set show(_){t(_)},children:(_,x)=>{var b=v7(),S=gt(ci(b),2);Ys(S,17,()=>ee(r),Xs,(X,re)=>{var oe=_7(),de=Ft(oe);de.__click=()=>g(ee(re).name);var ce=Ft(de);Zi(()=>ln(ce,`Remove ${ee(re).name??""}`)),xt(X,oe)});var P=gt(S,2),L=gt(Ft(P),2),E=gt(Ft(L),4),C=Ft(E),D=gt(Ft(C)),O=gt(E,2),U=Ft(O),j=gt(Ft(U)),G=gt(O,2),N=Ft(G),V=gt(Ft(N)),q=gt(G,2);q.__click=p;var z=gt(P,2),Q=Ft(z);Q.__click=()=>t(!1),Zi(()=>q.disabled=!ee(o)||!ee(c)||!ee(s)),Tg(D,()=>ee(o),X=>Et(o,X)),Tg(j,()=>ee(c),X=>Et(c,X)),Tg(V,()=>ee(s),X=>Et(s,X)),xt(_,b)},$$slots:{default:!0}}),tn()}ds(["click"]);var b7=Wt('<li><button type="button"> </button></li>'),x7=Wt('<li><button type="button"> </button></li>'),w7=Wt('<li><hr class="dropdown-divider"/></li> <!>',1),S7=Wt('<div class="basemap-selector svelte-1589rj1"><div class="btn-group"><button class="btn btn-outline-secondary dropdown-toggle basemap-button svelte-1589rj1" type="button" data-bs-toggle="dropdown" aria-expanded="false"> </button> <ul class="dropdown-menu"><!> <!> <li><hr class="dropdown-divider"/></li> <li><button class="dropdown-item" type="button"><i class="fa-solid fa-square-plus me-2"></i> Add custom basemap</button></li></ul></div></div> <!>',1);function T7(n,e){en(e,!0);let t=ft(e,"basemap",15),i=ii(!1),r=Kt(()=>[...op.keys().filter(E=>!YI.has(E))]);var o=S7(),c=ci(o),s=Ft(c),d=Ft(s),p=Ft(d),g=gt(d,2),_=Ft(g);Ys(_,17,()=>YI,Xs,(E,C)=>{var D=b7(),O=Ft(D);let U;O.__click=()=>t(ee(C));var j=Ft(O);Zi(()=>{U=Ds(O,1,"dropdown-item",null,U,{active:t()===ee(C)}),ln(j,ee(C))}),xt(E,D)});var x=gt(_,2);{var b=E=>{var C=w7(),D=gt(ci(C),2);Ys(D,17,()=>ee(r),Xs,(O,U)=>{var j=x7(),G=Ft(j);let N;G.__click=()=>t(ee(U));var V=Ft(G);Zi(()=>{N=Ds(G,1,"dropdown-item",null,N,{active:t()===ee(U)}),ln(V,ee(U))}),xt(O,j)}),xt(E,C)};Ki(x,E=>{ee(r).length>0&&E(b)})}var S=gt(x,4),P=Ft(S);P.__click=()=>Et(i,!0);var L=gt(c,2);y7(L,{get show(){return ee(i)},set show(E){Et(i,E,!0)}}),Zi(()=>ln(p,t())),xt(n,o),tn()}ds(["click"]);function pO(n){if(!n)return null;const e=n.getCenter();return{lat:e.lat,lng:e.lng,zoom:n.getZoom()}}function M7(n,e,t){const i=new URLSearchParams;return i.append("map",`${Math.round(n)}/${e.toFixed(6)}/${t.toFixed(6)}`),`https://www.openstreetmap.org/#${i.toString()}`}function mO(n,e,t){const i=new URLSearchParams;return i.append("map",`${Math.round(n)}/${e.toFixed(6)}/${t.toFixed(6)}`),`https://www.openstreetmap.org/edit?editor=id#${i.toString()}`}function C7(n,e,t){const i=new URLSearchParams;return i.append("map",`${Math.round(n)}/${e.toFixed(6)}/${t.toFixed(6)}`),i.append("disable_features","boundaries"),i.append("hashtags","Speedwalk"),`https://kyle.kiwi/iD/#${i.toString()}`}function E7(n,e,t){const i=new URLSearchParams;return i.append("map",`${Math.round(n)}/${e.toFixed(6)}/${t.toFixed(6)}`),i.append("disable_features","boundaries"),i.append("hashtags","Speedwalk"),`https://rapideditor.org/edit#${i.toString()}`}function A7(n,e,t,i){return`http://127.0.0.1:8111/load_and_zoom?left=${n.toFixed(6)}&right=${e.toFixed(6)}&top=${t.toFixed(6)}&bottom=${i.toFixed(6)}`}function P7(n){const e=n.getBounds();return A7(e.getWest(),e.getEast(),e.getNorth(),e.getSouth())}function I7(n,e,t){const i=new URL("https://www.mapillary.com/app/");return i.searchParams.set("lat",String(e)),i.searchParams.set("lng",String(t)),i.searchParams.set("z",String(Math.round(n))),i.toString()}var R7=Wt('<li><a class="dropdown-item" href="#"> </a></li>'),L7=Wt('<div class="btn-group"><button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Open in OSM editors"><i class="fa-solid fa-pen"></i></button> <ul class="dropdown-menu"></ul></div>');function k7(n,e){en(e,!1);const t=()=>Qi(Fh,"$map",i),[i,r]=qr(),o=["OSM","iD","Kiwid","Rapid","JOSM","Mapillary"];function c(p){const g=pO(t());if(!(!t()||!g))return{OSM:M7(g.zoom,g.lat,g.lng),iD:mO(g.zoom,g.lat,g.lng),Kiwid:C7(g.zoom,g.lat,g.lng),Rapid:E7(g.zoom,g.lat,g.lng),JOSM:P7(t()),Mapillary:I7(g.zoom,g.lat,g.lng)}[p]}Jw();var s=L7(),d=gt(Ft(s),2);Ys(d,5,()=>o,Xs,(p,g)=>{var _=R7(),x=Ft(_);x.__click=S=>{S.preventDefault(),window.open(c(ee(g)),"_blank","noopener,noreferrer")};var b=Ft(x);Zi(()=>ln(b,ee(g))),xt(p,_)}),xt(n,s),tn(),r()}ds(["click"]);var D7=Wt('<h2>Report a problem</h2> <p>Done, thank you for submitting. <!></p> <button class="btn btn-primary">OK</button>',1),F7=Wt('<img alt="Screenshot" class="svelte-10dd0dj"/>'),O7=Wt("<p>Loading screenshot... (sometimes you have to cancel and try again)</p>"),z7=Wt('<div class="img-container mb-3 svelte-10dd0dj"><!></div>'),B7=Wt('<button class="btn btn-primary me-3" disabled><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> Submit report</button>'),N7=Wt('<button class="btn btn-primary me-3">Submit report</button>'),$7=Wt(`<div class="d-flex justify-content-between"><h2>Report a problem</h2> <button class="btn-close" aria-label="Close"></button></div> <p>You can report a problem with Speedwalk.</p> <fieldset class="mb-3"><legend>Please describe the problem <br/> (if it's not obvious from the screenshot below)</legend> <textarea class="form-control" rows="4" placeholder="Details"></textarea></fieldset> <!> <!> <!> <div class="d-flex"><!> <button class="btn btn-secondary">Cancel</button></div>`,1),V7=Wt("<!> <!>",1);function U7(n,e){en(e,!0);const t=()=>Qi(Fh,"$map",r),i=()=>Qi(fy,"$loggedInUser",r),[r,o]=qr();let c=ii(!1),s=ii(!1),d=ii(!1);function p(){t()&&E()}let g=ii(""),_=ii(xs({})),x=ii(!1),b=ii(!0),S=ii(void 0),P=ii(void 0),L=Kt(()=>ee(g)||ee(P));async function E(){Et(c,!0),Et(_,{url:window.location.toString(),viewport:j(t())},!0),Et(S,await O(t()),!0),Et(P,URL.createObjectURL(ee(S)),!0)}async function C(){let Q=null;ee(x)&&i()&&(Q=i().name);let X=null;ee(b)&&ee(S)&&(X=await U(ee(S)));let re={...ee(_),details:ee(g),screenshot:X,username:Q};try{Et(s,!0);let oe=await fetch("https://walknet.abstreet.uk/problems/speedwalk_problems",{method:"POST",body:JSON.stringify(re),headers:{"Content-Type":"application/json"}});if(!oe.ok)throw new Error(`Bad response: ${oe.status}`)}catch(oe){window.alert(`Failed to report a problem: ${oe}`),Et(s,!1);return}Et(s,!1),D(),Et(d,!0)}function D(){Et(c,!1),Et(g,""),Et(_,{},!0),Et(S,void 0),ee(P)&&(URL.revokeObjectURL(ee(P)),Et(P,void 0))}function O(Q){return new Promise((X,re)=>{Q.redraw(),Q.once("idle",()=>{Q.getCanvas().toBlob(oe=>{oe?X(oe):re("no blob")})})})}function U(Q){return new Promise((X,re)=>{let oe=new FileReader;oe.readAsDataURL(Q),oe.onloadend=function(){oe.result?X(oe.result):re("base64 failed")}})}function j(Q){let X=Q.getCenter(),re=Math.round(Q.getZoom()*100)/100,oe=Math.ceil((re*Math.LN2+Math.log(512/360/.5))/Math.LN10),de=Math.pow(10,oe),ce=Math.round(X.lat*de)/de,Se=Math.round(X.lng*de)/de,Pe=`${re}/${ce}/${Se}`,je=Q.getBearing(),Fe=Q.getPitch();return(je||Fe)&&(Pe+=`/${Math.round(je*10)/10}`),Fe&&(Pe+=`/${Math.round(Fe)}`),`#${Pe}`}var G={triggerStart:p},N=V7(),V=ci(N);_p(V,{get show(){return ee(d)},set show(Q){Et(d,Q,!0)},children:(Q,X)=>{var re=D7(),oe=gt(ci(re),2),de=gt(Ft(oe));{var ce=Pe=>{var je=Vn("You may be contacted later when this problem has been fixed.");xt(Pe,je)};Ki(de,Pe=>{ee(x)&&i()&&Pe(ce)})}var Se=gt(oe,2);Se.__click=()=>Et(d,!1),xt(Q,re)},$$slots:{default:!0}});var q=gt(V,2);_p(q,{closeable:!1,get show(){return ee(c)},set show(Q){Et(c,Q,!0)},children:(Q,X)=>{var re=$7(),oe=ci(re),de=gt(Ft(oe),2);de.__click=D;var ce=gt(oe,4),Se=gt(Ft(ce),2),Pe=gt(ce,2);ls(Pe,{get checked(){return ee(b)},set checked(ct){Et(b,ct,!0)},children:(ct,yt)=>{var we=Vn("Include screenshot");xt(ct,we)},$$slots:{default:!0}});var je=gt(Pe,2);{var Fe=ct=>{ls(ct,{get checked(){return ee(x)},set checked(yt){Et(x,yt,!0)},children:(yt,we)=>{var fe=Vn();Zi(()=>ln(fe,`Include your OSM username (${i().name??""}) in the report and be
      contacted when the problem is fixed`)),xt(yt,fe)},$$slots:{default:!0}})};Ki(je,ct=>{i()&&ct(Fe)})}var qe=gt(je,2);{var Ue=ct=>{var yt=z7(),we=Ft(yt);{var fe=tt=>{var Mt=F7();Zi(()=>Nl(Mt,"src",ee(P))),xt(tt,Mt)},Ve=tt=>{var Mt=O7();xt(tt,Mt)};Ki(we,tt=>{ee(P)?tt(fe):tt(Ve,!1)})}xt(ct,yt)};Ki(qe,ct=>{ee(b)&&ct(Ue)})}var ke=gt(qe,2),et=Ft(ke);{var ye=ct=>{var yt=B7();xt(ct,yt)},Be=ct=>{var yt=N7();yt.__click=C,Zi(()=>yt.disabled=!ee(L)),xt(ct,yt)};Ki(et,ct=>{ee(s)?ct(ye):ct(Be,!1)})}var Je=gt(et,2);Je.__click=D,Tg(Se,()=>ee(g),ct=>Et(g,ct)),xt(Q,re)},$$slots:{default:!0}}),xt(n,N);var z=tn(G);return o(),z}ds(["click"]);var j7=Wt('<div class="report-problem-wrapper svelte-1f4xae4"><button class="btn btn-secondary report-problem-btn svelte-1f4xae4"><i class="fa-solid fa-triangle-exclamation"></i> <span class="report-problem-text svelte-1f4xae4">Report problem</span></button></div>'),G7=Wt("<!> <!>",1);function q7(n){const e=()=>Qi(Fh,"$map",t),[t,i]=qr();let r=ii(null);var o=G7(),c=ci(o);{var s=p=>{var g=j7(),_=Ft(g);_.__click=()=>{ee(r)?.triggerStart()},xt(p,g)};Ki(c,p=>{e()&&p(s)})}var d=gt(c,2);Sc(U7(d,{}),p=>Et(r,p,!0),()=>ee(r)),xt(n,o),i()}ds(["click"]);var e2=function(n,e){return e2=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])},e2(n,e)};function Rc(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");e2(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function W7(n,e,t,i){function r(o){return o instanceof t?o:new t(function(c){c(o)})}return new(t||(t=Promise))(function(o,c){function s(g){try{p(i.next(g))}catch(_){c(_)}}function d(g){try{p(i.throw(g))}catch(_){c(_)}}function p(g){g.done?o(g.value):r(g.value).then(s,d)}p((i=i.apply(n,[])).next())})}function gO(n,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,r,o,c;return c={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function s(p){return function(g){return d([p,g])}}function d(p){if(i)throw new TypeError("Generator is already executing.");for(;t;)try{if(i=1,r&&(o=p[0]&2?r.return:p[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,p[1])).done)return o;switch(r=0,o&&(p=[p[0]&2,o.value]),p[0]){case 0:case 1:o=p;break;case 4:return t.label++,{value:p[1],done:!1};case 5:t.label++,r=p[1],p=[0];continue;case 7:p=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(p[0]===6||p[0]===2)){t=0;continue}if(p[0]===3&&(!o||p[1]>o[0]&&p[1]<o[3])){t.label=p[1];break}if(p[0]===6&&t.label<o[1]){t.label=o[1],o=p;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(p);break}o[2]&&t.ops.pop(),t.trys.pop();continue}p=e.call(n,t)}catch(g){p=[6,g],r=0}finally{i=o=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}}function pu(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Pc(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var i=t.call(n),r,o=[],c;try{for(;(e===void 0||e-- >0)&&!(r=i.next()).done;)o.push(r.value)}catch(s){c={error:s}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(c)throw c.error}}return o}function vu(n,e){for(var t=0,i=e.length,r=n.length;t<i;t++,r++)n[r]=e[t];return n}function Pg(n){return this instanceof Pg?(this.v=n,this):new Pg(n)}function H7(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),r,o=[];return r={},c("next"),c("throw"),c("return"),r[Symbol.asyncIterator]=function(){return this},r;function c(x){i[x]&&(r[x]=function(b){return new Promise(function(S,P){o.push([x,b,S,P])>1||s(x,b)})})}function s(x,b){try{d(i[x](b))}catch(S){_(o[0][3],S)}}function d(x){x.value instanceof Pg?Promise.resolve(x.value.v).then(p,g):_(o[0][2],x)}function p(x){s("next",x)}function g(x){s("throw",x)}function _(x,b){x(b),o.shift(),o.length&&s(o[0][0],o[0][1])}}function Z7(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof pu=="function"?pu(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(o){t[o]=n[o]&&function(c){return new Promise(function(s,d){c=n[o](c),r(s,d,c.done,c.value)})}}function r(o,c,s,d){Promise.resolve(d).then(function(p){o({value:p,done:s})},c)}}function On(n){return typeof n=="function"}function a1(n){var e=function(i){Error.call(i),i.stack=new Error().stack},t=n(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var ST=a1(function(n){return function(t){n(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(i,r){return r+1+") "+i.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t}});function Fy(n,e){if(n){var t=n.indexOf(e);0<=t&&n.splice(t,1)}}var Ah=(function(){function n(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._teardowns=null}return n.prototype.unsubscribe=function(){var e,t,i,r,o;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var s=pu(c),d=s.next();!d.done;d=s.next()){var p=d.value;p.remove(this)}}catch(P){e={error:P}}finally{try{d&&!d.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}else c.remove(this);var g=this.initialTeardown;if(On(g))try{g()}catch(P){o=P instanceof ST?P.errors:[P]}var _=this._teardowns;if(_){this._teardowns=null;try{for(var x=pu(_),b=x.next();!b.done;b=x.next()){var S=b.value;try{CR(S)}catch(P){o=o??[],P instanceof ST?o=vu(vu([],Pc(o)),Pc(P.errors)):o.push(P)}}}catch(P){i={error:P}}finally{try{b&&!b.done&&(r=x.return)&&r.call(x)}finally{if(i)throw i.error}}}if(o)throw new ST(o)}},n.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)CR(e);else{if(e instanceof n){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._teardowns=(t=this._teardowns)!==null&&t!==void 0?t:[]).push(e)}},n.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},n.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},n.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Fy(t,e)},n.prototype.remove=function(e){var t=this._teardowns;t&&Fy(t,e),e instanceof n&&e._removeParent(this)},n.EMPTY=(function(){var e=new n;return e.closed=!0,e})(),n})(),_O=Ah.EMPTY;function vO(n){return n instanceof Ah||n&&"closed"in n&&On(n.remove)&&On(n.add)&&On(n.unsubscribe)}function CR(n){On(n)?n():n.unsubscribe()}var X7={Promise:void 0},Y7={setTimeout:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return setTimeout.apply(void 0,vu([],Pc(n)))},clearTimeout:function(n){return clearTimeout(n)},delegate:void 0};function yO(n){Y7.setTimeout(function(){throw n})}function Nd(){}function Zx(n){n()}var SC=(function(n){Rc(e,n);function e(t){var i=n.call(this)||this;return i.isStopped=!1,t?(i.destination=t,vO(t)&&t.add(i)):i.destination=K7,i}return e.create=function(t,i,r){return new TC(t,i,r)},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,n.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e})(Ah),TC=(function(n){Rc(e,n);function e(t,i,r){var o=n.call(this)||this,c;if(On(t))c=t;else if(t){c=t.next,i=t.error,r=t.complete;var s;s=t,c=c?.bind(s),i=i?.bind(s),r=r?.bind(s)}return o.destination={next:c?TT(c):Nd,error:TT(i??bO),complete:r?TT(r):Nd},o}return e})(SC);function TT(n,e){return function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];try{n.apply(void 0,vu([],Pc(t)))}catch(r){yO(r)}}}function bO(n){throw n}var K7={closed:!0,next:Nd,error:bO,complete:Nd},l1=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function wu(n){return n}function J7(n){return n.length===0?wu:n.length===1?n[0]:function(t){return n.reduce(function(i,r){return r(i)},t)}}var _r=(function(){function n(e){e&&(this._subscribe=e)}return n.prototype.lift=function(e){var t=new n;return t.source=this,t.operator=e,t},n.prototype.subscribe=function(e,t,i){var r=this,o=eW(e)?e:new TC(e,t,i);return Zx(function(){var c=r,s=c.operator,d=c.source;o.add(s?s.call(o,d):d?r._subscribe(o):r._trySubscribe(o))}),o},n.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},n.prototype.forEach=function(e,t){var i=this;return t=ER(t),new t(function(r,o){var c;c=i.subscribe(function(s){try{e(s)}catch(d){o(d),c?.unsubscribe()}},o,r)})},n.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},n.prototype[l1]=function(){return this},n.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return J7(e)(this)},n.prototype.toPromise=function(e){var t=this;return e=ER(e),new e(function(i,r){var o;t.subscribe(function(c){return o=c},function(c){return r(c)},function(){return i(o)})})},n.create=function(e){return new n(e)},n})();function ER(n){var e;return(e=n??X7.Promise)!==null&&e!==void 0?e:Promise}function Q7(n){return n&&On(n.next)&&On(n.error)&&On(n.complete)}function eW(n){return n&&n instanceof SC||Q7(n)&&vO(n)}function xO(n){return On(n?.lift)}function Yn(n){return function(e){if(xO(e))return e.lift(function(t){try{return n(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}var Pn=(function(n){Rc(e,n);function e(t,i,r,o,c){var s=n.call(this,t)||this;return s.onFinalize=c,s._next=i?function(d){try{i(d)}catch(p){t.error(p)}}:n.prototype._next,s._error=o?function(d){try{o(d)}catch(p){t.error(p)}finally{this.unsubscribe()}}:n.prototype._error,s._complete=r?function(){try{r()}catch(d){t.error(d)}finally{this.unsubscribe()}}:n.prototype._complete,s}return e.prototype.unsubscribe=function(){var t,i=this.closed;n.prototype.unsubscribe.call(this),!i&&((t=this.onFinalize)===null||t===void 0||t.call(this))},e})(SC);function _i(){return Yn(function(n,e){var t=null;n._refCount++;var i=new Pn(e,void 0,void 0,void 0,function(){if(!n||n._refCount<=0||0<--n._refCount){t=null;return}var r=n._connection,o=t;t=null,r&&(!o||r===o)&&r.unsubscribe(),e.unsubscribe()});n.subscribe(i),i.closed||(t=n.connect())})}var tW=(function(n){Rc(e,n);function e(t,i){var r=n.call(this)||this;return r.source=t,r.subjectFactory=i,r._subject=null,r._refCount=0,r._connection=null,xO(t)&&(r.lift=t.lift),r}return e.prototype._subscribe=function(t){return this.getSubject().subscribe(t)},e.prototype.getSubject=function(){var t=this._subject;return(!t||t.isStopped)&&(this._subject=this.subjectFactory()),this._subject},e.prototype._teardown=function(){this._refCount=0;var t=this._connection;this._subject=this._connection=null,t?.unsubscribe()},e.prototype.connect=function(){var t=this,i=this._connection;if(!i){i=this._connection=new Ah;var r=this.getSubject();i.add(this.source.subscribe(new Pn(r,void 0,function(){t._teardown(),r.complete()},function(o){t._teardown(),r.error(o)},function(){return t._teardown()}))),i.closed&&(this._connection=null,i=Ah.EMPTY)}return i},e.prototype.refCount=function(){return _i()(this)},e})(_r),iW=a1(function(n){return function(){n(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),ri=(function(n){Rc(e,n);function e(){var t=n.call(this)||this;return t.closed=!1,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var i=new AR(this,this);return i.operator=t,i},e.prototype._throwIfClosed=function(){if(this.closed)throw new iW},e.prototype.next=function(t){var i=this;Zx(function(){var r,o;if(i._throwIfClosed(),!i.isStopped){var c=i.observers.slice();try{for(var s=pu(c),d=s.next();!d.done;d=s.next()){var p=d.value;p.next(t)}}catch(g){r={error:g}}finally{try{d&&!d.done&&(o=s.return)&&o.call(s)}finally{if(r)throw r.error}}}})},e.prototype.error=function(t){var i=this;Zx(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=t;for(var r=i.observers;r.length;)r.shift().error(t)}})},e.prototype.complete=function(){var t=this;Zx(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var i=t.observers;i.length;)i.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),n.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var i=this,r=i.hasError,o=i.isStopped,c=i.observers;return r||o?_O:(c.push(t),new Ah(function(){return Fy(c,t)}))},e.prototype._checkFinalizedStatuses=function(t){var i=this,r=i.hasError,o=i.thrownError,c=i.isStopped;r?t.error(o):c&&t.complete()},e.prototype.asObservable=function(){var t=new _r;return t.source=this,t},e.create=function(t,i){return new AR(t,i)},e})(_r),AR=(function(n){Rc(e,n);function e(t,i){var r=n.call(this)||this;return r.destination=t,r.source=i,r}return e.prototype.next=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,t)},e.prototype.error=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,t)},e.prototype.complete=function(){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||i===void 0||i.call(t)},e.prototype._subscribe=function(t){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(t))!==null&&r!==void 0?r:_O},e})(ri),Ph=(function(n){Rc(e,n);function e(t){var i=n.call(this)||this;return i._value=t,i}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var i=n.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},e.prototype.getValue=function(){var t=this,i=t.hasError,r=t.thrownError,o=t._value;if(i)throw r;return this._throwIfClosed(),o},e.prototype.next=function(t){n.prototype.next.call(this,this._value=t)},e})(ri),MC={now:function(){return(MC.delegate||Date).now()},delegate:void 0},wO=(function(n){Rc(e,n);function e(t,i,r){t===void 0&&(t=1/0),i===void 0&&(i=1/0),r===void 0&&(r=MC);var o=n.call(this)||this;return o._bufferSize=t,o._windowTime=i,o._timestampProvider=r,o._buffer=[],o._infiniteTimeWindow=!0,o._infiniteTimeWindow=i===1/0,o._bufferSize=Math.max(1,t),o._windowTime=Math.max(1,i),o}return e.prototype.next=function(t){var i=this,r=i.isStopped,o=i._buffer,c=i._infiniteTimeWindow,s=i._timestampProvider,d=i._windowTime;r||(o.push(t),!c&&o.push(s.now()+d)),this._trimBuffer(),n.prototype.next.call(this,t)},e.prototype._subscribe=function(t){this._throwIfClosed(),this._trimBuffer();for(var i=this._innerSubscribe(t),r=this,o=r._infiniteTimeWindow,c=r._buffer,s=c.slice(),d=0;d<s.length&&!t.closed;d+=o?1:2)t.next(s[d]);return this._checkFinalizedStatuses(t),i},e.prototype._trimBuffer=function(){var t=this,i=t._bufferSize,r=t._timestampProvider,o=t._buffer,c=t._infiniteTimeWindow,s=(c?1:2)*i;if(i<1/0&&s<o.length&&o.splice(0,o.length-s),!c){for(var d=r.now(),p=0,g=1;g<o.length&&o[g]<=d;g+=2)p=g;p&&o.splice(0,p+1)}},e})(ri),nW=(function(n){Rc(e,n);function e(t,i){return n.call(this)||this}return e.prototype.schedule=function(t,i){return this},e})(Ah),t2={setInterval:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=t2.delegate;return(t?.setInterval||setInterval).apply(void 0,vu([],Pc(n)))},clearInterval:function(n){return clearInterval(n)},delegate:void 0},rW=(function(n){Rc(e,n);function e(t,i){var r=n.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return e.prototype.schedule=function(t,i){if(i===void 0&&(i=0),this.closed)return this;this.state=t;var r=this.id,o=this.scheduler;return r!=null&&(this.id=this.recycleAsyncId(o,r,i)),this.pending=!0,this.delay=i,this.id=this.id||this.requestAsyncId(o,this.id,i),this},e.prototype.requestAsyncId=function(t,i,r){return r===void 0&&(r=0),t2.setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,i,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return i;t2.clearInterval(i)},e.prototype.execute=function(t,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,i);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,i){var r=!1,o;try{this.work(t)}catch(c){r=!0,o=!!c&&c||new Error(c)}if(r)return this.unsubscribe(),o},e.prototype.unsubscribe=function(){if(!this.closed){var t=this,i=t.id,r=t.scheduler,o=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Fy(o,this),i!=null&&(this.id=this.recycleAsyncId(r,i,null)),this.delay=null,n.prototype.unsubscribe.call(this)}},e})(nW),PR=(function(){function n(e,t){t===void 0&&(t=n.now),this.schedulerActionCtor=e,this.now=t}return n.prototype.schedule=function(e,t,i){return t===void 0&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},n.now=MC.now,n})(),sW=(function(n){Rc(e,n);function e(t,i){i===void 0&&(i=PR.now);var r=n.call(this,t,i)||this;return r.actions=[],r._active=!1,r._scheduled=void 0,r}return e.prototype.flush=function(t){var i=this.actions;if(this._active){i.push(t);return}var r;this._active=!0;do if(r=t.execute(t.state,t.delay))break;while(t=i.shift());if(this._active=!1,r){for(;t=i.shift();)t.unsubscribe();throw r}},e})(PR),CC=new sW(rW),SO=CC,d0=new _r(function(n){return n.complete()});function Ni(n){return n?oW(n):d0}function oW(n){return new _r(function(e){return n.schedule(function(){return e.complete()})})}function EC(n,e){return new _r(function(t){var i=0;return e.schedule(function(){i===n.length?t.complete():(t.next(n[i++]),t.closed||this.schedule())})})}var AC=(function(n){return n&&typeof n.length=="number"&&typeof n!="function"});function TO(n){return On(n?.then)}function aW(n,e){return new _r(function(t){var i=new Ah;return i.add(e.schedule(function(){var r=n[l1]();i.add(r.subscribe({next:function(o){i.add(e.schedule(function(){return t.next(o)}))},error:function(o){i.add(e.schedule(function(){return t.error(o)}))},complete:function(){i.add(e.schedule(function(){return t.complete()}))}}))})),i})}function lW(n,e){return new _r(function(t){return e.schedule(function(){return n.then(function(i){t.add(e.schedule(function(){t.next(i),t.add(e.schedule(function(){return t.complete()}))}))},function(i){t.add(e.schedule(function(){return t.error(i)}))})})})}function cW(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var MO=cW();function CO(n,e,t,i){i===void 0&&(i=0);var r=e.schedule(function(){try{t.call(this)}catch(o){n.error(o)}},i);return n.add(r),r}function uW(n,e){return new _r(function(t){var i;return t.add(e.schedule(function(){i=n[MO](),CO(t,e,function(){var r=i.next(),o=r.value,c=r.done;c?t.complete():(t.next(o),this.schedule())})})),function(){return On(i?.return)&&i.return()}})}function EO(n,e){if(!n)throw new Error("Iterable cannot be null");return new _r(function(t){var i=new Ah;return i.add(e.schedule(function(){var r=n[Symbol.asyncIterator]();i.add(e.schedule(function(){var o=this;r.next().then(function(c){c.done?t.complete():(t.next(c.value),o.schedule())})}))})),i})}function AO(n){return On(n[l1])}function PO(n){return On(n?.[MO])}function IO(n){return Symbol.asyncIterator&&On(n?.[Symbol.asyncIterator])}function RO(n){return new TypeError("You provided "+(n!==null&&typeof n=="object"?"an invalid object":"'"+n+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function LO(n){return H7(this,arguments,function(){var t,i,r,o;return gO(this,function(c){switch(c.label){case 0:t=n.getReader(),c.label=1;case 1:c.trys.push([1,,9,10]),c.label=2;case 2:return[4,Pg(t.read())];case 3:return i=c.sent(),r=i.value,o=i.done,o?[4,Pg(void 0)]:[3,5];case 4:return[2,c.sent()];case 5:return[4,Pg(r)];case 6:return[4,c.sent()];case 7:return c.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function kO(n){return On(n?.getReader)}function hW(n,e){return EO(LO(n),e)}function dW(n,e){if(n!=null){if(AO(n))return aW(n,e);if(AC(n))return EC(n,e);if(TO(n))return lW(n,e);if(IO(n))return EO(n,e);if(PO(n))return uW(n,e);if(kO(n))return hW(n,e)}throw RO(n)}function Fr(n,e){return e?dW(n,e):hl(n)}function hl(n){if(n instanceof _r)return n;if(n!=null){if(AO(n))return fW(n);if(AC(n))return DO(n);if(TO(n))return pW(n);if(IO(n))return FO(n);if(PO(n))return mW(n);if(kO(n))return gW(n)}throw RO(n)}function fW(n){return new _r(function(e){var t=n[l1]();if(On(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function DO(n){return new _r(function(e){for(var t=0;t<n.length&&!e.closed;t++)e.next(n[t]);e.complete()})}function pW(n){return new _r(function(e){n.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,yO)})}function mW(n){return new _r(function(e){var t,i;try{for(var r=pu(n),o=r.next();!o.done;o=r.next()){var c=o.value;if(e.next(c),e.closed)return}}catch(s){t={error:s}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}e.complete()})}function FO(n){return new _r(function(e){_W(n,e).catch(function(t){return e.error(t)})})}function gW(n){return FO(LO(n))}function _W(n,e){var t,i,r,o;return W7(this,void 0,void 0,function(){var c,s;return gO(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),t=Z7(n),d.label=1;case 1:return[4,t.next()];case 2:if(i=d.sent(),!!i.done)return[3,4];if(c=i.value,e.next(c),e.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return s=d.sent(),r={error:s},[3,11];case 6:return d.trys.push([6,,9,10]),i&&!i.done&&(o=t.return)?[4,o.call(t)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function c1(n,e){return e?EC(n,e):DO(n)}function OO(n){return n&&On(n.schedule)}function PC(n){return n[n.length-1]}function IC(n){return On(PC(n))?n.pop():void 0}function f0(n){return OO(PC(n))?n.pop():void 0}function vW(n,e){return typeof PC(n)=="number"?n.pop():e}function Pi(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=f0(n);return t?EC(n,t):c1(n)}function Xx(n,e){var t=On(n)?n:function(){return n},i=function(r){return r.error(t())};return new _r(i)}var RC=a1(function(n){return function(){n(this),this.name="EmptyError",this.message="no elements in sequence"}});function zO(n){return n instanceof Date&&!isNaN(n)}var yW=a1(function(n){return function(t){t===void 0&&(t=null),n(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=t}});function i2(n,e){var t=zO(n)?{first:n}:{each:n},i=t.first,r=t.each,o=t.with,c=o===void 0?bW:o,s=t.scheduler,d=s===void 0?CC:s,p=t.meta,g=p===void 0?null:p;if(i==null&&r==null)throw new TypeError("No timeout provided.");return Yn(function(_,x){var b,S,P=null,L=0,E=function(C){S=CO(x,d,function(){b.unsubscribe(),hl(c({meta:g,lastValue:P,seen:L})).subscribe(x)},C)};b=_.subscribe(new Pn(x,function(C){S?.unsubscribe(),L++,x.next(P=C),r>0&&E(r)},void 0,void 0,function(){S?.closed||S?.unsubscribe(),P=null})),E(i!=null?typeof i=="number"?i:+i-d.now():r)})}function bW(n){throw new yW(n)}function st(n,e){return Yn(function(t,i){var r=0;t.subscribe(new Pn(i,function(o){i.next(n.call(e,o,r++))}))})}var xW=Array.isArray;function wW(n,e){return xW(e)?n.apply(void 0,vu([],Pc(e))):n(e)}function BO(n){return st(function(e){return wW(n,e)})}var SW=Array.isArray,TW=Object.getPrototypeOf,MW=Object.prototype,CW=Object.keys;function EW(n){if(n.length===1){var e=n[0];if(SW(e))return{args:e,keys:null};if(AW(e)){var t=CW(e);return{args:t.map(function(i){return e[i]}),keys:t}}}return{args:n,keys:null}}function AW(n){return n&&typeof n=="object"&&TW(n)===MW}function PW(n,e){return n.reduce(function(t,i,r){return t[i]=e[r],t},{})}function Si(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=f0(n),i=IC(n),r=EW(n),o=r.args,c=r.keys;if(o.length===0)return Fr([],t);var s=new _r(IW(o,t,c?function(d){return PW(c,d)}:wu));return i?s.pipe(BO(i)):s}function IW(n,e,t){return t===void 0&&(t=wu),function(i){IR(e,function(){for(var r=n.length,o=new Array(r),c=r,s=r,d=function(g){IR(e,function(){var _=Fr(n[g],e),x=!1;_.subscribe(new Pn(i,function(b){o[g]=b,x||(x=!0,s--),s||i.next(t(o.slice()))},function(){--c||i.complete()}))},i)},p=0;p<r;p++)d(p)},i)}}function IR(n,e,t){n?t.add(n.schedule(e)):e()}function NO(n,e,t,i,r,o,c,s){var d=[],p=0,g=0,_=!1,x=function(){_&&!d.length&&!p&&e.complete()},b=function(P){return p<i?S(P):d.push(P)},S=function(P){o&&e.next(P),p++;var L=!1;hl(t(P,g++)).subscribe(new Pn(e,function(E){o?b(E):e.next(E)},function(){L=!0},void 0,function(){if(L)try{p--;for(var E=function(){var C=d.shift();c?e.add(c.schedule(function(){return S(C)})):S(C)};d.length&&p<i;)E();x()}catch(C){e.error(C)}}))};return n.subscribe(new Pn(e,b,function(){_=!0,x()})),function(){}}function Hi(n,e,t){return t===void 0&&(t=1/0),On(e)?Hi(function(i,r){return st(function(o,c){return e(i,o,r,c)})(hl(n(i,r)))},t):(typeof e=="number"&&(t=e),Yn(function(i,r){return NO(i,r,n,t)}))}function lp(n){return n===void 0&&(n=1/0),Hi(wu,n)}function RW(){return lp(1)}function jl(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return RW()(c1(n,f0(n)))}var LW=["addListener","removeListener"],kW=["addEventListener","removeEventListener"],DW=["on","off"];function Mr(n,e,t,i){if(On(t)&&(i=t,t=void 0),i)return Mr(n,e,t).pipe(BO(i));var r=Pc(zW(n)?kW.map(function(s){return function(d){return n[s](e,d,t)}}):FW(n)?LW.map(RR(n,e)):OW(n)?DW.map(RR(n,e)):[],2),o=r[0],c=r[1];if(!o&&AC(n))return Hi(function(s){return Mr(s,e,t)})(c1(n));if(!o)throw new TypeError("Invalid event target");return new _r(function(s){var d=function(){for(var p=[],g=0;g<arguments.length;g++)p[g]=arguments[g];return s.next(1<p.length?p:p[0])};return o(d),function(){return c(d)}})}function RR(n,e){return function(t){return function(i){return n[t](e,i)}}}function FW(n){return On(n.addListener)&&On(n.removeListener)}function OW(n){return On(n.on)&&On(n.off)}function zW(n){return On(n.addEventListener)&&On(n.removeEventListener)}function LC(n,e,t){n===void 0&&(n=0),t===void 0&&(t=SO);var i=-1;return e!=null&&(OO(e)?t=e:i=e),new _r(function(r){var o=zO(n)?+n-t.now():n;o<0&&(o=0);var c=0;return t.schedule(function(){r.closed||(r.next(c++),0<=i?this.schedule(void 0,i):r.complete())},o)})}function mn(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=f0(n),i=vW(n,1/0),r=n;return r.length?r.length===1?hl(r[0]):lp(i)(c1(r,t)):d0}var BW=Array.isArray;function NW(n){return n.length===1&&BW(n[0])?n[0]:n}function ai(n,e){return Yn(function(t,i){var r=0;t.subscribe(new Pn(i,function(o){return n.call(e,o,r++)&&i.next(o)}))})}function Oy(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=IC(n),i=NW(n);return i.length?new _r(function(r){var o=i.map(function(){return[]}),c=i.map(function(){return!1});r.add(function(){o=c=null});for(var s=function(p){hl(i[p]).subscribe(new Pn(r,function(g){if(o[p].push(g),o.every(function(x){return x.length})){var _=o.map(function(x){return x.shift()});r.next(t?t.apply(void 0,vu([],Pc(_))):_),o.some(function(x,b){return!x.length&&c[b]})&&r.complete()}},function(){c[p]=!0,!o[p].length&&r.complete()}))},d=0;!r.closed&&d<i.length;d++)s(d);return function(){o=c=null}}):d0}function $W(n){return Yn(function(e,t){var i=!1,r=null,o=null,c=!1,s=function(){if(o?.unsubscribe(),o=null,i){i=!1;var p=r;r=null,t.next(p)}c&&t.complete()},d=function(){o=null,c&&t.complete()};e.subscribe(new Pn(t,function(p){i=!0,r=p,o||hl(n(p)).subscribe(o=new Pn(t,s,d))},function(){c=!0,(!i||!o||o.closed)&&t.complete()}))})}function $O(n,e){return e===void 0&&(e=SO),$W(function(){return LC(n,e)})}function Tw(n,e){return e===void 0&&(e=null),e=e??n,Yn(function(t,i){var r=[],o=0;t.subscribe(new Pn(i,function(c){var s,d,p,g,_=null;o++%e===0&&r.push([]);try{for(var x=pu(r),b=x.next();!b.done;b=x.next()){var S=b.value;S.push(c),n<=S.length&&(_=_??[],_.push(S))}}catch(E){s={error:E}}finally{try{b&&!b.done&&(d=x.return)&&d.call(x)}finally{if(s)throw s.error}}if(_)try{for(var P=pu(_),L=P.next();!L.done;L=P.next()){var S=L.value;Fy(r,S),i.next(S)}}catch(E){p={error:E}}finally{try{L&&!L.done&&(g=P.return)&&g.call(P)}finally{if(p)throw p.error}}},function(){var c,s;try{for(var d=pu(r),p=d.next();!p.done;p=d.next()){var g=p.value;i.next(g)}}catch(_){c={error:_}}finally{try{p&&!p.done&&(s=d.return)&&s.call(d)}finally{if(c)throw c.error}}i.complete()},void 0,function(){r=null}))})}function VW(n){return Yn(function(e,t){var i=null,r=null,o=function(){r?.unsubscribe();var c=i;i=[],c&&t.next(c),hl(n()).subscribe(r=new Pn(t,o,Nd))};o(),e.subscribe(new Pn(t,function(c){return i?.push(c)},function(){i&&t.next(i),t.complete()},void 0,function(){return i=r=null}))})}function Un(n){return Yn(function(e,t){var i=null,r=!1,o;i=e.subscribe(new Pn(t,void 0,void 0,function(c){o=hl(n(c,Un(n)(e))),i?(i.unsubscribe(),i=null,o.subscribe(t)):r=!0})),r&&(i.unsubscribe(),i=null,o.subscribe(t))})}function VO(n,e,t,i,r){return function(o,c){var s=t,d=e,p=0;o.subscribe(new Pn(c,function(g){var _=p++;d=s?n(d,g,_):(s=!0,g),i&&c.next(d)},r&&(function(){s&&c.next(d),c.complete()})))}}function LR(n,e){return Yn(VO(n,e,arguments.length>=2,!1,!0))}function MT(n,e){return On(e)?Hi(n,e,1):Hi(n,1)}function UW(n){return new _r(function(e){return n.subscribe(e)})}var jW={connector:function(){return new ri}};function UO(n,e){e===void 0&&(e=jW);var t=e.connector;return Yn(function(i,r){var o=t();Fr(n(UW(o))).subscribe(r),r.add(i.subscribe(o))})}function zy(n,e){return e===void 0&&(e=CC),Yn(function(t,i){var r=null,o=null,c=null,s=function(){if(r){r.unsubscribe(),r=null;var p=o;o=null,i.next(p)}};function d(){var p=c+n,g=e.now();if(g<p){r=this.schedule(void 0,p-g),i.add(r);return}s()}t.subscribe(new Pn(i,function(p){o=p,c=e.now(),r||(r=e.schedule(d,n),i.add(r))},function(){s(),i.complete()},void 0,function(){o=r=null}))})}function jO(n){return Yn(function(e,t){var i=!1;e.subscribe(new Pn(t,function(r){i=!0,t.next(r)},function(){i||t.next(n),t.complete()}))})}function Vl(n){return n<=0?function(){return d0}:Yn(function(e,t){var i=0;e.subscribe(new Pn(t,function(r){++i<=n&&(t.next(r),n<=i&&t.complete())}))})}function yi(n,e){return e===void 0&&(e=wu),n=n??GW,Yn(function(t,i){var r,o=!0;t.subscribe(new Pn(i,function(c){var s=e(c);(o||!n(r,s))&&(o=!1,r=s,i.next(c))}))})}function GW(n,e){return n===e}function GO(n){return n===void 0&&(n=qW),Yn(function(e,t){var i=!1;e.subscribe(new Pn(t,function(r){i=!0,t.next(r)},function(){return i?t.complete():t.error(n())}))})}function qW(){return new RC}function qO(n,e,t){return e===void 0&&(e=1/0),e=(e||0)<1?1/0:e,Yn(function(i,r){return NO(i,r,n,e,void 0,!0,t)})}function va(n){return Yn(function(e,t){try{e.subscribe(t)}finally{t.add(n)}})}function wi(n,e){var t=arguments.length>=2;return function(i){return i.pipe(n?ai(function(r,o){return n(r,o,i)}):wu,Vl(1),t?jO(e):GO(function(){return new RC}))}}function n2(n){return n<=0?function(){return d0}:Yn(function(e,t){var i=[];e.subscribe(new Pn(t,function(r){i.push(r),n<i.length&&i.shift()},function(){var r,o;try{for(var c=pu(i),s=c.next();!s.done;s=c.next()){var d=s.value;t.next(d)}}catch(p){r={error:p}}finally{try{s&&!s.done&&(o=c.return)&&o.call(c)}finally{if(r)throw r.error}}t.complete()},void 0,function(){i=null}))})}function Wg(n,e){var t=arguments.length>=2;return function(i){return i.pipe(n?ai(function(r,o){return n(r,o,i)}):wu,n2(1),t?jO(e):GO(function(){return new RC}))}}function WO(n,e){var t=On(n)?n:function(){return n};return On(e)?UO(e,{connector:t}):function(i){return new tW(i,t)}}function rl(){return Yn(function(n,e){var t,i=!1;n.subscribe(new Pn(e,function(r){var o=t;t=r,i&&e.next([o,r]),i=!0}))})}function WW(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=n.length;if(t===0)throw new Error("list of properties cannot be empty.");return st(function(i){for(var r=i,o=0;o<t;o++){var c=r?.[n[o]];if(typeof c<"u")r=c;else return}return r})}function Qa(n){return n?function(e){return UO(n)(e)}:function(e){return WO(new ri)(e)}}function Ii(n,e,t,i){var r=On(t)?t:void 0;return function(o){return WO(new wO(n,e,i),r)(o)}}function r2(n){var e;e={count:n};var t=e.count,i=t===void 0?1/0:t,r=e.delay,o=e.resetOnSuccess,c=o===void 0?!1:o;return i<=0?wu:Yn(function(s,d){var p=0,g,_=function(){var x=!1;g=s.subscribe(new Pn(d,function(b){c&&(p=0),d.next(b)},void 0,function(b){if(p++<i){var S=function(){g?(g.unsubscribe(),g=null,_()):x=!0};if(r!=null){var P=typeof r=="number"?LC(r):hl(r(b,p)),L=new Pn(d,function(){L.unsubscribe(),S()},function(){d.complete()});P.subscribe(L)}else S()}else d.error(b)})),x&&(g.unsubscribe(),g=null,_())};_()})}function HW(n){return Yn(function(e,t){var i=!1,r=null;e.subscribe(new Pn(t,function(c){i=!0,r=c}));var o=function(){if(i){i=!1;var c=r;r=null,t.next(c)}};n.subscribe(new Pn(t,o,Nd))})}function Vr(n,e){return Yn(VO(n,e,arguments.length>=2,!0))}function pn(n){n===void 0&&(n={});var e=n.connector,t=e===void 0?function(){return new ri}:e,i=n.resetOnError,r=i===void 0?!0:i,o=n.resetOnComplete,c=o===void 0?!0:o,s=n.resetOnRefCountZero,d=s===void 0?!0:s;return function(p){var g=null,_=null,x=null,b=0,S=!1,P=!1,L=function(){_?.unsubscribe(),_=null},E=function(){L(),g=x=null,S=P=!1},C=function(){var D=g;E(),D?.unsubscribe()};return Yn(function(D,O){b++,!P&&!S&&L();var U=x=x??t();O.add(function(){b--,b===0&&!P&&!S&&(_=CT(C,d))}),U.subscribe(O),g||(g=new TC({next:function(j){return U.next(j)},error:function(j){P=!0,L(),_=CT(E,r,j),U.error(j)},complete:function(){S=!0,L(),_=CT(E,c),U.complete()}}),Fr(D).subscribe(g))})(p)}}function CT(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return e===!0?(n(),null):e===!1?null:e.apply(void 0,vu([],Pc(t))).pipe(Vl(1)).subscribe(function(){return n()})}function Ks(n){return ai(function(e,t){return n<=t})}function s2(n){return Yn(function(e,t){var i=!1,r=0;e.subscribe(new Pn(t,function(o){return(i||(i=!n(o,r++)))&&t.next(o)}))})}function An(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=f0(n);return Yn(function(i,r){(t?jl(n,i,t):jl(n,i)).subscribe(r)})}function ei(n,e){return Yn(function(t,i){var r=null,o=0,c=!1,s=function(){return c&&!r&&i.complete()};t.subscribe(new Pn(i,function(d){r?.unsubscribe();var p=0,g=o++;hl(n(d,g)).subscribe(r=new Pn(i,function(_){return i.next(e?e(d,_,g,p++):_)},function(){r=null,s()}))},function(){c=!0,s()}))})}function Cd(n){return Yn(function(e,t){hl(n).subscribe(new Pn(t,function(){return t.complete()},Nd)),!t.closed&&e.subscribe(t)})}function HO(n,e){return e===void 0&&(e=!1),Yn(function(t,i){var r=0;t.subscribe(new Pn(i,function(o){var c=n(o,r++);(c||e)&&i.next(o),!c&&i.complete()}))})}function Dr(n,e,t){var i=On(n)||e||t?{next:n,error:e,complete:t}:n;return i?Yn(function(r,o){var c;(c=i.subscribe)===null||c===void 0||c.call(i);var s=!0;r.subscribe(new Pn(o,function(d){var p;(p=i.next)===null||p===void 0||p.call(i,d),o.next(d)},function(){var d;s=!1,(d=i.complete)===null||d===void 0||d.call(i),o.complete()},function(d){var p;s=!1,(p=i.error)===null||p===void 0||p.call(i,d),o.error(d)},function(){var d,p;s&&((d=i.unsubscribe)===null||d===void 0||d.call(i)),(p=i.finalize)===null||p===void 0||p.call(i)}))}):wu}function Ui(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=IC(n);return Yn(function(i,r){for(var o=n.length,c=new Array(o),s=n.map(function(){return!1}),d=!1,p=function(_){hl(n[_]).subscribe(new Pn(r,function(x){c[_]=x,!d&&!s[_]&&(s[_]=!0,(d=s.every(wu))&&(s=null))},Nd))},g=0;g<o;g++)p(g);i.subscribe(new Pn(r,function(_){if(d){var x=vu([_],Pc(c));r.next(t?t.apply(void 0,vu([],Pc(x))):x)}}))})}class ZW{createFilter(e){return new Function("node","return "+this._compile(e)+";")}_compile(e){if(e==null||e.length<=1)return"true";const t=e[0];return"("+(t==="=="?this._compileComparisonOp("===",e[1],e[2],!1):t==="!="?this._compileComparisonOp("!==",e[1],e[2],!1):t===">"||t===">="||t==="<"||t==="<="?this._compileComparisonOp(t,e[1],e[2],!0):t==="in"?this._compileInOp(e[1],e.slice(2)):t==="!in"?this._compileNegation(this._compileInOp(e[1],e.slice(2))):t==="all"?this._compileLogicalOp(e.slice(1),"&&"):"true")+")"}_compare(e,t){return e<t?-1:e>t?1:0}_compileComparisonOp(e,t,i,r){const o=this._compilePropertyReference(t),c=JSON.stringify(i);return(r?"typeof "+o+"===typeof "+c+"&&":"")+o+e+c}_compileInOp(e,t){const i=this._compare,r=JSON.stringify(t.sort(i)),o=this._compilePropertyReference(e);return r+".indexOf("+o+")!==-1"}_compileLogicalOp(e,t){const i=this._compile.bind(this);return e.map(i).join(t)}_compileNegation(e){return"!("+e+")"}_compilePropertyReference(e){return"node["+JSON.stringify(e)+"]"}}const ZO="134",XW=0,kR=1,YW=2,XO=1,KW=2,Xv=3,Hg=0,Gs=1,ea=2,YO=1,Rd=0,py=1,DR=2,FR=3,OR=4,JW=5,pg=100,QW=101,eH=102,zR=103,BR=104,tH=200,iH=201,nH=202,rH=203,KO=204,JO=205,sH=206,oH=207,aH=208,lH=209,cH=210,uH=0,hH=1,dH=2,o2=3,fH=4,pH=5,mH=6,gH=7,u1=0,_H=1,vH=2,cp=0,yH=1,bH=2,xH=3,wH=4,SH=5,QO=300,p0=301,m0=302,a2=303,l2=304,h1=306,kC=307,c2=1e3,nl=1001,u2=1002,Hs=1003,NR=1004,$R=1005,Fo=1006,TH=1007,d1=1008,$d=1009,MH=1010,CH=1011,Mw=1012,EH=1013,Yx=1014,Td=1015,Ig=1016,AH=1017,PH=1018,IH=1019,my=1020,RH=1021,up=1022,ca=1023,LH=1024,kH=1025,DH=ca,Rg=1026,By=1027,FH=1028,OH=1029,zH=1030,BH=1031,NH=1032,$H=1033,VR=33776,UR=33777,jR=33778,GR=33779,qR=35840,WR=35841,HR=35842,ZR=35843,VH=36196,XR=37492,YR=37496,UH=37808,jH=37809,GH=37810,qH=37811,WH=37812,HH=37813,ZH=37814,XH=37815,YH=37816,KH=37817,JH=37818,QH=37819,e9=37820,t9=37821,i9=36492,n9=37840,r9=37841,s9=37842,o9=37843,a9=37844,l9=37845,c9=37846,u9=37847,h9=37848,d9=37849,f9=37850,p9=37851,m9=37852,g9=37853,_9=2200,v9=2201,y9=2202,Cw=2300,Ew=2301,ET=2302,vg=2400,yg=2401,Aw=2402,DC=2500,ez=2501,b9=0,Bo=3e3,Tp=3001,FC=3007,OC=3002,x9=3003,tz=3004,iz=3005,nz=3006,w9=3200,S9=3201,h_=0,T9=1,AT=7680,M9=519,Ny=35044,Pw=35048,KR="300 es";class Mp{addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){if(this._listeners===void 0)return!1;const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){if(this._listeners===void 0)return;const r=this._listeners[e];if(r!==void 0){const o=r.indexOf(t);o!==-1&&r.splice(o,1)}}dispatchEvent(e){if(this._listeners===void 0)return;const i=this._listeners[e.type];if(i!==void 0){e.target=this;const r=i.slice(0);for(let o=0,c=r.length;o<c;o++)r[o].call(this,e);e.target=null}}}let Vb=1234567;const gy=Math.PI/180,$y=180/Math.PI,ho=[];for(let n=0;n<256;n++)ho[n]=(n<16?"0":"")+n.toString(16);const C9=typeof crypto<"u"&&"randomUUID"in crypto;function Mc(){if(C9)return crypto.randomUUID().toUpperCase();const n=Math.random()*4294967295|0,e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return(ho[n&255]+ho[n>>8&255]+ho[n>>16&255]+ho[n>>24&255]+"-"+ho[e&255]+ho[e>>8&255]+"-"+ho[e>>16&15|64]+ho[e>>24&255]+"-"+ho[t&63|128]+ho[t>>8&255]+"-"+ho[t>>16&255]+ho[t>>24&255]+ho[i&255]+ho[i>>8&255]+ho[i>>16&255]+ho[i>>24&255]).toUpperCase()}function ya(n,e,t){return Math.max(e,Math.min(t,n))}function zC(n,e){return(n%e+e)%e}function E9(n,e,t,i,r){return i+(n-e)*(r-i)/(t-e)}function A9(n,e,t){return n!==e?(t-n)/(e-n):0}function _y(n,e,t){return(1-t)*n+t*e}function P9(n,e,t,i){return _y(n,e,1-Math.exp(-t*i))}function I9(n,e=1){return e-Math.abs(zC(n,e*2)-e)}function R9(n,e,t){return n<=e?0:n>=t?1:(n=(n-e)/(t-e),n*n*(3-2*n))}function L9(n,e,t){return n<=e?0:n>=t?1:(n=(n-e)/(t-e),n*n*n*(n*(n*6-15)+10))}function k9(n,e){return n+Math.floor(Math.random()*(e-n+1))}function D9(n,e){return n+Math.random()*(e-n)}function F9(n){return n*(.5-Math.random())}function O9(n){return n!==void 0&&(Vb=n%2147483647),Vb=Vb*16807%2147483647,(Vb-1)/2147483646}function z9(n){return n*gy}function B9(n){return n*$y}function h2(n){return(n&n-1)===0&&n!==0}function N9(n){return Math.pow(2,Math.ceil(Math.log(n)/Math.LN2))}function rz(n){return Math.pow(2,Math.floor(Math.log(n)/Math.LN2))}function $9(n,e,t,i,r){const o=Math.cos,c=Math.sin,s=o(t/2),d=c(t/2),p=o((e+i)/2),g=c((e+i)/2),_=o((e-i)/2),x=c((e-i)/2),b=o((i-e)/2),S=c((i-e)/2);switch(r){case"XYX":n.set(s*g,d*_,d*x,s*p);break;case"YZY":n.set(d*x,s*g,d*_,s*p);break;case"ZXZ":n.set(d*_,d*x,s*g,s*p);break;case"XZX":n.set(s*g,d*S,d*b,s*p);break;case"YXY":n.set(d*b,s*g,d*S,s*p);break;case"ZYZ":n.set(d*S,d*b,s*g,s*p);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}var Zg=Object.freeze({__proto__:null,DEG2RAD:gy,RAD2DEG:$y,generateUUID:Mc,clamp:ya,euclideanModulo:zC,mapLinear:E9,inverseLerp:A9,lerp:_y,damp:P9,pingpong:I9,smoothstep:R9,smootherstep:L9,randInt:k9,randFloat:D9,randFloatSpread:F9,seededRandom:O9,degToRad:z9,radToDeg:B9,isPowerOfTwo:h2,ceilPowerOfTwo:N9,floorPowerOfTwo:rz,setQuaternionFromProperEuler:$9});class li{constructor(e=0,t=0){this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e,t){return t!==void 0?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e,t){return t!==void 0?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,r=e.elements;return this.x=r[0]*t+r[3]*i+r[6],this.y=r[1]*t+r[4]*i+r[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t,i){return i!==void 0&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),r=Math.sin(t),o=this.x-e.x,c=this.y-e.y;return this.x=o*i-c*r+e.x,this.y=o*r+c*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}li.prototype.isVector2=!0;class vo{constructor(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(e,t,i,r,o,c,s,d,p){const g=this.elements;return g[0]=e,g[1]=r,g[2]=s,g[3]=t,g[4]=o,g[5]=d,g[6]=i,g[7]=c,g[8]=p,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,r=t.elements,o=this.elements,c=i[0],s=i[3],d=i[6],p=i[1],g=i[4],_=i[7],x=i[2],b=i[5],S=i[8],P=r[0],L=r[3],E=r[6],C=r[1],D=r[4],O=r[7],U=r[2],j=r[5],G=r[8];return o[0]=c*P+s*C+d*U,o[3]=c*L+s*D+d*j,o[6]=c*E+s*O+d*G,o[1]=p*P+g*C+_*U,o[4]=p*L+g*D+_*j,o[7]=p*E+g*O+_*G,o[2]=x*P+b*C+S*U,o[5]=x*L+b*D+S*j,o[8]=x*E+b*O+S*G,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[1],r=e[2],o=e[3],c=e[4],s=e[5],d=e[6],p=e[7],g=e[8];return t*c*g-t*s*p-i*o*g+i*s*d+r*o*p-r*c*d}invert(){const e=this.elements,t=e[0],i=e[1],r=e[2],o=e[3],c=e[4],s=e[5],d=e[6],p=e[7],g=e[8],_=g*c-s*p,x=s*d-g*o,b=p*o-c*d,S=t*_+i*x+r*b;if(S===0)return this.set(0,0,0,0,0,0,0,0,0);const P=1/S;return e[0]=_*P,e[1]=(r*p-g*i)*P,e[2]=(s*i-r*c)*P,e[3]=x*P,e[4]=(g*t-r*d)*P,e[5]=(r*o-s*t)*P,e[6]=b*P,e[7]=(i*d-p*t)*P,e[8]=(c*t-i*o)*P,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,r,o,c,s){const d=Math.cos(o),p=Math.sin(o);return this.set(i*d,i*p,-i*(d*c+p*s)+c+e,-r*p,r*d,-r*(-p*c+d*s)+s+t,0,0,1),this}scale(e,t){const i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=t,i[4]*=t,i[7]*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),r=this.elements,o=r[0],c=r[3],s=r[6],d=r[1],p=r[4],g=r[7];return r[0]=t*o+i*d,r[3]=t*c+i*p,r[6]=t*s+i*g,r[1]=-i*o+t*d,r[4]=-i*c+t*p,r[7]=-i*s+t*g,this}translate(e,t){const i=this.elements;return i[0]+=e*i[2],i[3]+=e*i[5],i[6]+=e*i[8],i[1]+=t*i[2],i[4]+=t*i[5],i[7]+=t*i[8],this}equals(e){const t=this.elements,i=e.elements;for(let r=0;r<9;r++)if(t[r]!==i[r])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return new this.constructor().fromArray(this.elements)}}vo.prototype.isMatrix3=!0;function sz(n){if(n.length===0)return-1/0;let e=n[0];for(let t=1,i=n.length;t<i;++t)n[t]>e&&(e=n[t]);return e}function f1(n){return document.createElementNS("http://www.w3.org/1999/xhtml",n)}function JR(n,e=0){let t=3735928559^e,i=1103547991^e;for(let r=0,o;r<n.length;r++)o=n.charCodeAt(r),t=Math.imul(t^o,2654435761),i=Math.imul(i^o,1597334677);return t=Math.imul(t^t>>>16,2246822507)^Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507)^Math.imul(t^t>>>13,3266489909),4294967296*(2097151&i)+(t>>>0)}let Vm;class d_{static getDataURL(e){if(/^data:/i.test(e.src)||typeof HTMLCanvasElement>"u")return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{Vm===void 0&&(Vm=f1("canvas")),Vm.width=e.width,Vm.height=e.height;const i=Vm.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),t=Vm}return t.width>2048||t.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}}let V9=0;class Bs extends Mp{constructor(e=Bs.DEFAULT_IMAGE,t=Bs.DEFAULT_MAPPING,i=nl,r=nl,o=Fo,c=d1,s=ca,d=$d,p=1,g=Bo){super(),Object.defineProperty(this,"id",{value:V9++}),this.uuid=Mc(),this.name="",this.image=e,this.mipmaps=[],this.mapping=t,this.wrapS=i,this.wrapT=r,this.magFilter=o,this.minFilter=c,this.anisotropy=p,this.format=s,this.internalFormat=null,this.type=d,this.offset=new li(0,0),this.repeat=new li(1,1),this.center=new li(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new vo,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=g,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this.userData=JSON.parse(JSON.stringify(e.userData)),this}toJSON(e){const t=e===void 0||typeof e=="string";if(!t&&e.textures[this.uuid]!==void 0)return e.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(this.image!==void 0){const r=this.image;if(r.uuid===void 0&&(r.uuid=Mc()),!t&&e.images[r.uuid]===void 0){let o;if(Array.isArray(r)){o=[];for(let c=0,s=r.length;c<s;c++)r[c].isDataTexture?o.push(PT(r[c].image)):o.push(PT(r[c]))}else o=PT(r);e.images[r.uuid]={uuid:r.uuid,url:o}}i.image=r.uuid}return JSON.stringify(this.userData)!=="{}"&&(i.userData=this.userData),t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==QO)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case c2:e.x=e.x-Math.floor(e.x);break;case nl:e.x=e.x<0?0:1;break;case u2:Math.abs(Math.floor(e.x)%2)===1?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x);break}if(e.y<0||e.y>1)switch(this.wrapT){case c2:e.y=e.y-Math.floor(e.y);break;case nl:e.y=e.y<0?0:1;break;case u2:Math.abs(Math.floor(e.y)%2)===1?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y);break}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){e===!0&&this.version++}}Bs.DEFAULT_IMAGE=void 0;Bs.DEFAULT_MAPPING=QO;Bs.prototype.isTexture=!0;function PT(n){return typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&n instanceof ImageBitmap?d_.getDataURL(n):n.data?{data:Array.prototype.slice.call(n.data),width:n.width,height:n.height,type:n.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}class Xn{constructor(e=0,t=0,i=0,r=1){this.x=e,this.y=t,this.z=i,this.w=r}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==void 0?e.w:1,this}add(e,t){return t!==void 0?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e,t){return t!==void 0?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,r=this.z,o=this.w,c=e.elements;return this.x=c[0]*t+c[4]*i+c[8]*r+c[12]*o,this.y=c[1]*t+c[5]*i+c[9]*r+c[13]*o,this.z=c[2]*t+c[6]*i+c[10]*r+c[14]*o,this.w=c[3]*t+c[7]*i+c[11]*r+c[15]*o,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,r,o;const d=e.elements,p=d[0],g=d[4],_=d[8],x=d[1],b=d[5],S=d[9],P=d[2],L=d[6],E=d[10];if(Math.abs(g-x)<.01&&Math.abs(_-P)<.01&&Math.abs(S-L)<.01){if(Math.abs(g+x)<.1&&Math.abs(_+P)<.1&&Math.abs(S+L)<.1&&Math.abs(p+b+E-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;const D=(p+1)/2,O=(b+1)/2,U=(E+1)/2,j=(g+x)/4,G=(_+P)/4,N=(S+L)/4;return D>O&&D>U?D<.01?(i=0,r=.707106781,o=.707106781):(i=Math.sqrt(D),r=j/i,o=G/i):O>U?O<.01?(i=.707106781,r=0,o=.707106781):(r=Math.sqrt(O),i=j/r,o=N/r):U<.01?(i=.707106781,r=.707106781,o=0):(o=Math.sqrt(U),i=G/o,r=N/o),this.set(i,r,o,t),this}let C=Math.sqrt((L-S)*(L-S)+(_-P)*(_-P)+(x-g)*(x-g));return Math.abs(C)<.001&&(C=1),this.x=(L-S)/C,this.y=(_-P)/C,this.z=(x-g)/C,this.w=Math.acos((p+b+E-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t,i){return i!==void 0&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}Xn.prototype.isVector4=!0;class Cc extends Mp{constructor(e,t,i={}){super(),this.width=e,this.height=t,this.depth=1,this.scissor=new Xn(0,0,e,t),this.scissorTest=!1,this.viewport=new Xn(0,0,e,t),this.texture=new Bs(void 0,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.isRenderTargetTexture=!0,this.texture.image={width:e,height:t,depth:1},this.texture.generateMipmaps=i.generateMipmaps!==void 0?i.generateMipmaps:!1,this.texture.internalFormat=i.internalFormat!==void 0?i.internalFormat:null,this.texture.minFilter=i.minFilter!==void 0?i.minFilter:Fo,this.depthBuffer=i.depthBuffer!==void 0?i.depthBuffer:!0,this.stencilBuffer=i.stencilBuffer!==void 0?i.stencilBuffer:!1,this.depthTexture=i.depthTexture!==void 0?i.depthTexture:null}setTexture(e){e.image={width:this.width,height:this.height,depth:this.depth},this.texture=e}setSize(e,t,i=1){(this.width!==e||this.height!==t||this.depth!==i)&&(this.width=e,this.height=t,this.depth=i,this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=i,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return new this.constructor().copy(this)}copy(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.texture.image={...this.texture.image},this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this}dispose(){this.dispatchEvent({type:"dispose"})}}Cc.prototype.isWebGLRenderTarget=!0;class U9 extends Cc{constructor(e,t,i){super(e,t);const r=this.texture;this.texture=[];for(let o=0;o<i;o++)this.texture[o]=r.clone()}setSize(e,t,i=1){if(this.width!==e||this.height!==t||this.depth!==i){this.width=e,this.height=t,this.depth=i;for(let r=0,o=this.texture.length;r<o;r++)this.texture[r].image.width=e,this.texture[r].image.height=t,this.texture[r].image.depth=i;this.dispose()}return this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t),this}copy(e){this.dispose(),this.width=e.width,this.height=e.height,this.depth=e.depth,this.viewport.set(0,0,this.width,this.height),this.scissor.set(0,0,this.width,this.height),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this.texture.length=0;for(let t=0,i=e.texture.length;t<i;t++)this.texture[t]=e.texture[t].clone();return this}}U9.prototype.isWebGLMultipleRenderTargets=!0;class oz extends Cc{constructor(e,t,i){super(e,t,i),this.samples=4}copy(e){return super.copy.call(this,e),this.samples=e.samples,this}}oz.prototype.isWebGLMultisampleRenderTarget=!0;class yo{constructor(e=0,t=0,i=0,r=1){this._x=e,this._y=t,this._z=i,this._w=r}static slerp(e,t,i,r){return console.warn("THREE.Quaternion: Static .slerp() has been deprecated. Use qm.slerpQuaternions( qa, qb, t ) instead."),i.slerpQuaternions(e,t,r)}static slerpFlat(e,t,i,r,o,c,s){let d=i[r+0],p=i[r+1],g=i[r+2],_=i[r+3];const x=o[c+0],b=o[c+1],S=o[c+2],P=o[c+3];if(s===0){e[t+0]=d,e[t+1]=p,e[t+2]=g,e[t+3]=_;return}if(s===1){e[t+0]=x,e[t+1]=b,e[t+2]=S,e[t+3]=P;return}if(_!==P||d!==x||p!==b||g!==S){let L=1-s;const E=d*x+p*b+g*S+_*P,C=E>=0?1:-1,D=1-E*E;if(D>Number.EPSILON){const U=Math.sqrt(D),j=Math.atan2(U,E*C);L=Math.sin(L*j)/U,s=Math.sin(s*j)/U}const O=s*C;if(d=d*L+x*O,p=p*L+b*O,g=g*L+S*O,_=_*L+P*O,L===1-s){const U=1/Math.sqrt(d*d+p*p+g*g+_*_);d*=U,p*=U,g*=U,_*=U}}e[t]=d,e[t+1]=p,e[t+2]=g,e[t+3]=_}static multiplyQuaternionsFlat(e,t,i,r,o,c){const s=i[r],d=i[r+1],p=i[r+2],g=i[r+3],_=o[c],x=o[c+1],b=o[c+2],S=o[c+3];return e[t]=s*S+g*_+d*b-p*x,e[t+1]=d*S+g*x+p*_-s*b,e[t+2]=p*S+g*b+s*x-d*_,e[t+3]=g*S-s*_-d*x-p*b,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){if(!(e&&e.isEuler))throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=e._x,r=e._y,o=e._z,c=e._order,s=Math.cos,d=Math.sin,p=s(i/2),g=s(r/2),_=s(o/2),x=d(i/2),b=d(r/2),S=d(o/2);switch(c){case"XYZ":this._x=x*g*_+p*b*S,this._y=p*b*_-x*g*S,this._z=p*g*S+x*b*_,this._w=p*g*_-x*b*S;break;case"YXZ":this._x=x*g*_+p*b*S,this._y=p*b*_-x*g*S,this._z=p*g*S-x*b*_,this._w=p*g*_+x*b*S;break;case"ZXY":this._x=x*g*_-p*b*S,this._y=p*b*_+x*g*S,this._z=p*g*S+x*b*_,this._w=p*g*_-x*b*S;break;case"ZYX":this._x=x*g*_-p*b*S,this._y=p*b*_+x*g*S,this._z=p*g*S-x*b*_,this._w=p*g*_+x*b*S;break;case"YZX":this._x=x*g*_+p*b*S,this._y=p*b*_+x*g*S,this._z=p*g*S-x*b*_,this._w=p*g*_-x*b*S;break;case"XZY":this._x=x*g*_-p*b*S,this._y=p*b*_-x*g*S,this._z=p*g*S+x*b*_,this._w=p*g*_+x*b*S;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+c)}return t!==!1&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,r=Math.sin(i);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],r=t[4],o=t[8],c=t[1],s=t[5],d=t[9],p=t[2],g=t[6],_=t[10],x=i+s+_;if(x>0){const b=.5/Math.sqrt(x+1);this._w=.25/b,this._x=(g-d)*b,this._y=(o-p)*b,this._z=(c-r)*b}else if(i>s&&i>_){const b=2*Math.sqrt(1+i-s-_);this._w=(g-d)/b,this._x=.25*b,this._y=(r+c)/b,this._z=(o+p)/b}else if(s>_){const b=2*Math.sqrt(1+s-i-_);this._w=(o-p)/b,this._x=(r+c)/b,this._y=.25*b,this._z=(d+g)/b}else{const b=2*Math.sqrt(1+_-i-s);this._w=(c-r)/b,this._x=(o+p)/b,this._y=(d+g)/b,this._z=.25*b}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(ya(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(i===0)return this;const r=Math.min(1,t/i);return this.slerp(e,r),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return e===0?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e,t){return t!==void 0?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,r=e._y,o=e._z,c=e._w,s=t._x,d=t._y,p=t._z,g=t._w;return this._x=i*g+c*s+r*p-o*d,this._y=r*g+c*d+o*s-i*p,this._z=o*g+c*p+i*d-r*s,this._w=c*g-i*s-r*d-o*p,this._onChangeCallback(),this}slerp(e,t){if(t===0)return this;if(t===1)return this.copy(e);const i=this._x,r=this._y,o=this._z,c=this._w;let s=c*e._w+i*e._x+r*e._y+o*e._z;if(s<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,s=-s):this.copy(e),s>=1)return this._w=c,this._x=i,this._y=r,this._z=o,this;const d=1-s*s;if(d<=Number.EPSILON){const b=1-t;return this._w=b*c+t*this._w,this._x=b*i+t*this._x,this._y=b*r+t*this._y,this._z=b*o+t*this._z,this.normalize(),this._onChangeCallback(),this}const p=Math.sqrt(d),g=Math.atan2(p,s),_=Math.sin((1-t)*g)/p,x=Math.sin(t*g)/p;return this._w=c*_+this._w*x,this._x=i*_+this._x*x,this._y=r*_+this._y*x,this._z=o*_+this._z*x,this._onChangeCallback(),this}slerpQuaternions(e,t,i){this.copy(e).slerp(t,i)}random(){const e=Math.random(),t=Math.sqrt(1-e),i=Math.sqrt(e),r=2*Math.PI*Math.random(),o=2*Math.PI*Math.random();return this.set(t*Math.cos(r),i*Math.sin(o),i*Math.cos(o),t*Math.sin(r))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}yo.prototype.isQuaternion=!0;class Ge{constructor(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}set(e,t,i){return i===void 0&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e,t){return t!==void 0?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e,t){return t!==void 0?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e,t){return t!==void 0?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(QR.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(QR.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,r=this.z,o=e.elements;return this.x=o[0]*t+o[3]*i+o[6]*r,this.y=o[1]*t+o[4]*i+o[7]*r,this.z=o[2]*t+o[5]*i+o[8]*r,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,r=this.z,o=e.elements,c=1/(o[3]*t+o[7]*i+o[11]*r+o[15]);return this.x=(o[0]*t+o[4]*i+o[8]*r+o[12])*c,this.y=(o[1]*t+o[5]*i+o[9]*r+o[13])*c,this.z=(o[2]*t+o[6]*i+o[10]*r+o[14])*c,this}applyQuaternion(e){const t=this.x,i=this.y,r=this.z,o=e.x,c=e.y,s=e.z,d=e.w,p=d*t+c*r-s*i,g=d*i+s*t-o*r,_=d*r+o*i-c*t,x=-o*t-c*i-s*r;return this.x=p*d+x*-o+g*-s-_*-c,this.y=g*d+x*-c+_*-o-p*-s,this.z=_*d+x*-s+p*-c-g*-o,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,r=this.z,o=e.elements;return this.x=o[0]*t+o[4]*i+o[8]*r,this.y=o[1]*t+o[5]*i+o[9]*r,this.z=o[2]*t+o[6]*i+o[10]*r,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e,t){return t!==void 0?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,r=e.y,o=e.z,c=t.x,s=t.y,d=t.z;return this.x=r*d-o*s,this.y=o*c-i*d,this.z=i*s-r*c,this}projectOnVector(e){const t=e.lengthSq();if(t===0)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return IT.copy(this).projectOnVector(e),this.sub(IT)}reflect(e){return this.sub(IT.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(t===0)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(ya(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,r=this.z-e.z;return t*t+i*i+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const r=Math.sin(t)*e;return this.x=r*Math.sin(i),this.y=Math.cos(t)*e,this.z=r*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),r=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=r,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,t*4)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,t*3)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t,i){return i!==void 0&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=(Math.random()-.5)*2,t=Math.random()*Math.PI*2,i=Math.sqrt(1-e**2);return this.x=i*Math.cos(t),this.y=i*Math.sin(t),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}Ge.prototype.isVector3=!0;const IT=new Ge,QR=new yo;class dl{constructor(e=new Ge(1/0,1/0,1/0),t=new Ge(-1/0,-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){let t=1/0,i=1/0,r=1/0,o=-1/0,c=-1/0,s=-1/0;for(let d=0,p=e.length;d<p;d+=3){const g=e[d],_=e[d+1],x=e[d+2];g<t&&(t=g),_<i&&(i=_),x<r&&(r=x),g>o&&(o=g),_>c&&(c=_),x>s&&(s=x)}return this.min.set(t,i,r),this.max.set(o,c,s),this}setFromBufferAttribute(e){let t=1/0,i=1/0,r=1/0,o=-1/0,c=-1/0,s=-1/0;for(let d=0,p=e.count;d<p;d++){const g=e.getX(d),_=e.getY(d),x=e.getZ(d);g<t&&(t=g),_<i&&(i=_),x<r&&(r=x),g>o&&(o=g),_>c&&(c=_),x>s&&(s=x)}return this.min.set(t,i,r),this.max.set(o,c,s),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=Ev.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e){return this.makeEmpty(),this.expandByObject(e)}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e){e.updateWorldMatrix(!1,!1);const t=e.geometry;t!==void 0&&(t.boundingBox===null&&t.computeBoundingBox(),RT.copy(t.boundingBox),RT.applyMatrix4(e.matrixWorld),this.union(RT));const i=e.children;for(let r=0,o=i.length;r<o;r++)this.expandByObject(i[r]);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,Ev),Ev.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Av),Ub.subVectors(this.max,Av),Um.subVectors(e.a,Av),jm.subVectors(e.b,Av),Gm.subVectors(e.c,Av),hd.subVectors(jm,Um),dd.subVectors(Gm,jm),Gf.subVectors(Um,Gm);let t=[0,-hd.z,hd.y,0,-dd.z,dd.y,0,-Gf.z,Gf.y,hd.z,0,-hd.x,dd.z,0,-dd.x,Gf.z,0,-Gf.x,-hd.y,hd.x,0,-dd.y,dd.x,0,-Gf.y,Gf.x,0];return!LT(t,Um,jm,Gm,Ub)||(t=[1,0,0,0,1,0,0,0,1],!LT(t,Um,jm,Gm,Ub))?!1:(jb.crossVectors(hd,dd),t=[jb.x,jb.y,jb.z],LT(t,Um,jm,Gm,Ub))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return Ev.copy(e).clamp(this.min,this.max).sub(e).length()}getBoundingSphere(e){return this.getCenter(e.center),e.radius=this.getSize(Ev).length()*.5,e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()?this:(ih[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),ih[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),ih[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),ih[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),ih[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),ih[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),ih[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),ih[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(ih),this)}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}dl.prototype.isBox3=!0;const ih=[new Ge,new Ge,new Ge,new Ge,new Ge,new Ge,new Ge,new Ge],Ev=new Ge,RT=new dl,Um=new Ge,jm=new Ge,Gm=new Ge,hd=new Ge,dd=new Ge,Gf=new Ge,Av=new Ge,Ub=new Ge,jb=new Ge,qf=new Ge;function LT(n,e,t,i,r){for(let o=0,c=n.length-3;o<=c;o+=3){qf.fromArray(n,o);const s=r.x*Math.abs(qf.x)+r.y*Math.abs(qf.y)+r.z*Math.abs(qf.z),d=e.dot(qf),p=t.dot(qf),g=i.dot(qf);if(Math.max(-Math.max(d,p,g),Math.min(d,p,g))>s)return!1}return!0}const j9=new dl,eL=new Ge,kT=new Ge,DT=new Ge;class f_{constructor(e=new Ge,t=-1){this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const i=this.center;t!==void 0?i.copy(t):j9.setFromPoints(e).getCenter(i);let r=0;for(let o=0,c=e.length;o<c;o++)r=Math.max(r,i.distanceToSquared(e[o]));return this.radius=Math.sqrt(r),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const i=this.center.distanceToSquared(e);return t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){DT.subVectors(e,this.center);const t=DT.lengthSq();if(t>this.radius*this.radius){const i=Math.sqrt(t),r=(i-this.radius)*.5;this.center.add(DT.multiplyScalar(r/i)),this.radius+=r}return this}union(e){return kT.subVectors(e.center,this.center).normalize().multiplyScalar(e.radius),this.expandByPoint(eL.copy(e.center).add(kT)),this.expandByPoint(eL.copy(e.center).sub(kT)),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new this.constructor().copy(this)}}const nh=new Ge,FT=new Ge,Gb=new Ge,fd=new Ge,OT=new Ge,qb=new Ge,zT=new Ge;class Cp{constructor(e=new Ge,t=new Ge(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.direction).multiplyScalar(e).add(this.origin)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,nh)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.direction).multiplyScalar(i).add(this.origin)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=nh.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(nh.copy(this.direction).multiplyScalar(t).add(this.origin),nh.distanceToSquared(e))}distanceSqToSegment(e,t,i,r){FT.copy(e).add(t).multiplyScalar(.5),Gb.copy(t).sub(e).normalize(),fd.copy(this.origin).sub(FT);const o=e.distanceTo(t)*.5,c=-this.direction.dot(Gb),s=fd.dot(this.direction),d=-fd.dot(Gb),p=fd.lengthSq(),g=Math.abs(1-c*c);let _,x,b,S;if(g>0)if(_=c*d-s,x=c*s-d,S=o*g,_>=0)if(x>=-S)if(x<=S){const P=1/g;_*=P,x*=P,b=_*(_+c*x+2*s)+x*(c*_+x+2*d)+p}else x=o,_=Math.max(0,-(c*x+s)),b=-_*_+x*(x+2*d)+p;else x=-o,_=Math.max(0,-(c*x+s)),b=-_*_+x*(x+2*d)+p;else x<=-S?(_=Math.max(0,-(-c*o+s)),x=_>0?-o:Math.min(Math.max(-o,-d),o),b=-_*_+x*(x+2*d)+p):x<=S?(_=0,x=Math.min(Math.max(-o,-d),o),b=x*(x+2*d)+p):(_=Math.max(0,-(c*o+s)),x=_>0?o:Math.min(Math.max(-o,-d),o),b=-_*_+x*(x+2*d)+p);else x=c>0?-o:o,_=Math.max(0,-(c*x+s)),b=-_*_+x*(x+2*d)+p;return i&&i.copy(this.direction).multiplyScalar(_).add(this.origin),r&&r.copy(Gb).multiplyScalar(x).add(FT),b}intersectSphere(e,t){nh.subVectors(e.center,this.origin);const i=nh.dot(this.direction),r=nh.dot(nh)-i*i,o=e.radius*e.radius;if(r>o)return null;const c=Math.sqrt(o-r),s=i-c,d=i+c;return s<0&&d<0?null:s<0?this.at(d,t):this.at(s,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(t===0)return e.distanceToPoint(this.origin)===0?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){const i=this.distanceToPlane(e);return i===null?null:this.at(i,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);return t===0||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let i,r,o,c,s,d;const p=1/this.direction.x,g=1/this.direction.y,_=1/this.direction.z,x=this.origin;return p>=0?(i=(e.min.x-x.x)*p,r=(e.max.x-x.x)*p):(i=(e.max.x-x.x)*p,r=(e.min.x-x.x)*p),g>=0?(o=(e.min.y-x.y)*g,c=(e.max.y-x.y)*g):(o=(e.max.y-x.y)*g,c=(e.min.y-x.y)*g),i>c||o>r||((o>i||i!==i)&&(i=o),(c<r||r!==r)&&(r=c),_>=0?(s=(e.min.z-x.z)*_,d=(e.max.z-x.z)*_):(s=(e.max.z-x.z)*_,d=(e.min.z-x.z)*_),i>d||s>r)||((s>i||i!==i)&&(i=s),(d<r||r!==r)&&(r=d),r<0)?null:this.at(i>=0?i:r,t)}intersectsBox(e){return this.intersectBox(e,nh)!==null}intersectTriangle(e,t,i,r,o){OT.subVectors(t,e),qb.subVectors(i,e),zT.crossVectors(OT,qb);let c=this.direction.dot(zT),s;if(c>0){if(r)return null;s=1}else if(c<0)s=-1,c=-c;else return null;fd.subVectors(this.origin,e);const d=s*this.direction.dot(qb.crossVectors(fd,qb));if(d<0)return null;const p=s*this.direction.dot(OT.cross(fd));if(p<0||d+p>c)return null;const g=-s*fd.dot(zT);return g<0?null:this.at(g/c,o)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class ki{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(e,t,i,r,o,c,s,d,p,g,_,x,b,S,P,L){const E=this.elements;return E[0]=e,E[4]=t,E[8]=i,E[12]=r,E[1]=o,E[5]=c,E[9]=s,E[13]=d,E[2]=p,E[6]=g,E[10]=_,E[14]=x,E[3]=b,E[7]=S,E[11]=P,E[15]=L,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new ki().fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,i=e.elements,r=1/qm.setFromMatrixColumn(e,0).length(),o=1/qm.setFromMatrixColumn(e,1).length(),c=1/qm.setFromMatrixColumn(e,2).length();return t[0]=i[0]*r,t[1]=i[1]*r,t[2]=i[2]*r,t[3]=0,t[4]=i[4]*o,t[5]=i[5]*o,t[6]=i[6]*o,t[7]=0,t[8]=i[8]*c,t[9]=i[9]*c,t[10]=i[10]*c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const t=this.elements,i=e.x,r=e.y,o=e.z,c=Math.cos(i),s=Math.sin(i),d=Math.cos(r),p=Math.sin(r),g=Math.cos(o),_=Math.sin(o);if(e.order==="XYZ"){const x=c*g,b=c*_,S=s*g,P=s*_;t[0]=d*g,t[4]=-d*_,t[8]=p,t[1]=b+S*p,t[5]=x-P*p,t[9]=-s*d,t[2]=P-x*p,t[6]=S+b*p,t[10]=c*d}else if(e.order==="YXZ"){const x=d*g,b=d*_,S=p*g,P=p*_;t[0]=x+P*s,t[4]=S*s-b,t[8]=c*p,t[1]=c*_,t[5]=c*g,t[9]=-s,t[2]=b*s-S,t[6]=P+x*s,t[10]=c*d}else if(e.order==="ZXY"){const x=d*g,b=d*_,S=p*g,P=p*_;t[0]=x-P*s,t[4]=-c*_,t[8]=S+b*s,t[1]=b+S*s,t[5]=c*g,t[9]=P-x*s,t[2]=-c*p,t[6]=s,t[10]=c*d}else if(e.order==="ZYX"){const x=c*g,b=c*_,S=s*g,P=s*_;t[0]=d*g,t[4]=S*p-b,t[8]=x*p+P,t[1]=d*_,t[5]=P*p+x,t[9]=b*p-S,t[2]=-p,t[6]=s*d,t[10]=c*d}else if(e.order==="YZX"){const x=c*d,b=c*p,S=s*d,P=s*p;t[0]=d*g,t[4]=P-x*_,t[8]=S*_+b,t[1]=_,t[5]=c*g,t[9]=-s*g,t[2]=-p*g,t[6]=b*_+S,t[10]=x-P*_}else if(e.order==="XZY"){const x=c*d,b=c*p,S=s*d,P=s*p;t[0]=d*g,t[4]=-_,t[8]=p*g,t[1]=x*_+P,t[5]=c*g,t[9]=b*_-S,t[2]=S*_-b,t[6]=s*g,t[10]=P*_+x}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(G9,e,q9)}lookAt(e,t,i){const r=this.elements;return Za.subVectors(e,t),Za.lengthSq()===0&&(Za.z=1),Za.normalize(),pd.crossVectors(i,Za),pd.lengthSq()===0&&(Math.abs(i.z)===1?Za.x+=1e-4:Za.z+=1e-4,Za.normalize(),pd.crossVectors(i,Za)),pd.normalize(),Wb.crossVectors(Za,pd),r[0]=pd.x,r[4]=Wb.x,r[8]=Za.x,r[1]=pd.y,r[5]=Wb.y,r[9]=Za.y,r[2]=pd.z,r[6]=Wb.z,r[10]=Za.z,this}multiply(e,t){return t!==void 0?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,r=t.elements,o=this.elements,c=i[0],s=i[4],d=i[8],p=i[12],g=i[1],_=i[5],x=i[9],b=i[13],S=i[2],P=i[6],L=i[10],E=i[14],C=i[3],D=i[7],O=i[11],U=i[15],j=r[0],G=r[4],N=r[8],V=r[12],q=r[1],z=r[5],Q=r[9],X=r[13],re=r[2],oe=r[6],de=r[10],ce=r[14],Se=r[3],Pe=r[7],je=r[11],Fe=r[15];return o[0]=c*j+s*q+d*re+p*Se,o[4]=c*G+s*z+d*oe+p*Pe,o[8]=c*N+s*Q+d*de+p*je,o[12]=c*V+s*X+d*ce+p*Fe,o[1]=g*j+_*q+x*re+b*Se,o[5]=g*G+_*z+x*oe+b*Pe,o[9]=g*N+_*Q+x*de+b*je,o[13]=g*V+_*X+x*ce+b*Fe,o[2]=S*j+P*q+L*re+E*Se,o[6]=S*G+P*z+L*oe+E*Pe,o[10]=S*N+P*Q+L*de+E*je,o[14]=S*V+P*X+L*ce+E*Fe,o[3]=C*j+D*q+O*re+U*Se,o[7]=C*G+D*z+O*oe+U*Pe,o[11]=C*N+D*Q+O*de+U*je,o[15]=C*V+D*X+O*ce+U*Fe,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[4],r=e[8],o=e[12],c=e[1],s=e[5],d=e[9],p=e[13],g=e[2],_=e[6],x=e[10],b=e[14],S=e[3],P=e[7],L=e[11],E=e[15];return S*(+o*d*_-r*p*_-o*s*x+i*p*x+r*s*b-i*d*b)+P*(+t*d*b-t*p*x+o*c*x-r*c*b+r*p*g-o*d*g)+L*(+t*p*_-t*s*b-o*c*_+i*c*b+o*s*g-i*p*g)+E*(-r*s*g-t*d*_+t*s*x+r*c*_-i*c*x+i*d*g)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,i){const r=this.elements;return e.isVector3?(r[12]=e.x,r[13]=e.y,r[14]=e.z):(r[12]=e,r[13]=t,r[14]=i),this}invert(){const e=this.elements,t=e[0],i=e[1],r=e[2],o=e[3],c=e[4],s=e[5],d=e[6],p=e[7],g=e[8],_=e[9],x=e[10],b=e[11],S=e[12],P=e[13],L=e[14],E=e[15],C=_*L*p-P*x*p+P*d*b-s*L*b-_*d*E+s*x*E,D=S*x*p-g*L*p-S*d*b+c*L*b+g*d*E-c*x*E,O=g*P*p-S*_*p+S*s*b-c*P*b-g*s*E+c*_*E,U=S*_*d-g*P*d-S*s*x+c*P*x+g*s*L-c*_*L,j=t*C+i*D+r*O+o*U;if(j===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const G=1/j;return e[0]=C*G,e[1]=(P*x*o-_*L*o-P*r*b+i*L*b+_*r*E-i*x*E)*G,e[2]=(s*L*o-P*d*o+P*r*p-i*L*p-s*r*E+i*d*E)*G,e[3]=(_*d*o-s*x*o-_*r*p+i*x*p+s*r*b-i*d*b)*G,e[4]=D*G,e[5]=(g*L*o-S*x*o+S*r*b-t*L*b-g*r*E+t*x*E)*G,e[6]=(S*d*o-c*L*o-S*r*p+t*L*p+c*r*E-t*d*E)*G,e[7]=(c*x*o-g*d*o+g*r*p-t*x*p-c*r*b+t*d*b)*G,e[8]=O*G,e[9]=(S*_*o-g*P*o-S*i*b+t*P*b+g*i*E-t*_*E)*G,e[10]=(c*P*o-S*s*o+S*i*p-t*P*p-c*i*E+t*s*E)*G,e[11]=(g*s*o-c*_*o-g*i*p+t*_*p+c*i*b-t*s*b)*G,e[12]=U*G,e[13]=(g*P*r-S*_*r+S*i*x-t*P*x-g*i*L+t*_*L)*G,e[14]=(S*s*r-c*P*r-S*i*d+t*P*d+c*i*L-t*s*L)*G,e[15]=(c*_*r-g*s*r+g*i*d-t*_*d-c*i*x+t*s*x)*G,this}scale(e){const t=this.elements,i=e.x,r=e.y,o=e.z;return t[0]*=i,t[4]*=r,t[8]*=o,t[1]*=i,t[5]*=r,t[9]*=o,t[2]*=i,t[6]*=r,t[10]*=o,t[3]*=i,t[7]*=r,t[11]*=o,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))}makeTranslation(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),r=Math.sin(t),o=1-i,c=e.x,s=e.y,d=e.z,p=o*c,g=o*s;return this.set(p*c+i,p*s-r*d,p*d+r*s,0,p*s+r*d,g*s+i,g*d-r*c,0,p*d-r*s,g*d+r*c,o*d*d+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,r,o,c){return this.set(1,i,o,0,e,1,c,0,t,r,1,0,0,0,0,1),this}compose(e,t,i){const r=this.elements,o=t._x,c=t._y,s=t._z,d=t._w,p=o+o,g=c+c,_=s+s,x=o*p,b=o*g,S=o*_,P=c*g,L=c*_,E=s*_,C=d*p,D=d*g,O=d*_,U=i.x,j=i.y,G=i.z;return r[0]=(1-(P+E))*U,r[1]=(b+O)*U,r[2]=(S-D)*U,r[3]=0,r[4]=(b-O)*j,r[5]=(1-(x+E))*j,r[6]=(L+C)*j,r[7]=0,r[8]=(S+D)*G,r[9]=(L-C)*G,r[10]=(1-(x+P))*G,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1,this}decompose(e,t,i){const r=this.elements;let o=qm.set(r[0],r[1],r[2]).length();const c=qm.set(r[4],r[5],r[6]).length(),s=qm.set(r[8],r[9],r[10]).length();this.determinant()<0&&(o=-o),e.x=r[12],e.y=r[13],e.z=r[14],_c.copy(this);const p=1/o,g=1/c,_=1/s;return _c.elements[0]*=p,_c.elements[1]*=p,_c.elements[2]*=p,_c.elements[4]*=g,_c.elements[5]*=g,_c.elements[6]*=g,_c.elements[8]*=_,_c.elements[9]*=_,_c.elements[10]*=_,t.setFromRotationMatrix(_c),i.x=o,i.y=c,i.z=s,this}makePerspective(e,t,i,r,o,c){c===void 0&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const s=this.elements,d=2*o/(t-e),p=2*o/(i-r),g=(t+e)/(t-e),_=(i+r)/(i-r),x=-(c+o)/(c-o),b=-2*c*o/(c-o);return s[0]=d,s[4]=0,s[8]=g,s[12]=0,s[1]=0,s[5]=p,s[9]=_,s[13]=0,s[2]=0,s[6]=0,s[10]=x,s[14]=b,s[3]=0,s[7]=0,s[11]=-1,s[15]=0,this}makeOrthographic(e,t,i,r,o,c){const s=this.elements,d=1/(t-e),p=1/(i-r),g=1/(c-o),_=(t+e)*d,x=(i+r)*p,b=(c+o)*g;return s[0]=2*d,s[4]=0,s[8]=0,s[12]=-_,s[1]=0,s[5]=2*p,s[9]=0,s[13]=-x,s[2]=0,s[6]=0,s[10]=-2*g,s[14]=-b,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let r=0;r<16;r++)if(t[r]!==i[r])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}ki.prototype.isMatrix4=!0;const qm=new Ge,_c=new ki,G9=new Ge(0,0,0),q9=new Ge(1,1,1),pd=new Ge,Wb=new Ge,Za=new Ge,tL=new ki,iL=new yo;class Ep{constructor(e=0,t=0,i=0,r=Ep.DefaultOrder){this._x=e,this._y=t,this._z=i,this._order=r}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,r=this._order){return this._x=e,this._y=t,this._z=i,this._order=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,i=!0){const r=e.elements,o=r[0],c=r[4],s=r[8],d=r[1],p=r[5],g=r[9],_=r[2],x=r[6],b=r[10];switch(t){case"XYZ":this._y=Math.asin(ya(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(-g,b),this._z=Math.atan2(-c,o)):(this._x=Math.atan2(x,p),this._z=0);break;case"YXZ":this._x=Math.asin(-ya(g,-1,1)),Math.abs(g)<.9999999?(this._y=Math.atan2(s,b),this._z=Math.atan2(d,p)):(this._y=Math.atan2(-_,o),this._z=0);break;case"ZXY":this._x=Math.asin(ya(x,-1,1)),Math.abs(x)<.9999999?(this._y=Math.atan2(-_,b),this._z=Math.atan2(-c,p)):(this._y=0,this._z=Math.atan2(d,o));break;case"ZYX":this._y=Math.asin(-ya(_,-1,1)),Math.abs(_)<.9999999?(this._x=Math.atan2(x,b),this._z=Math.atan2(d,o)):(this._x=0,this._z=Math.atan2(-c,p));break;case"YZX":this._z=Math.asin(ya(d,-1,1)),Math.abs(d)<.9999999?(this._x=Math.atan2(-g,p),this._y=Math.atan2(-_,o)):(this._x=0,this._y=Math.atan2(s,b));break;case"XZY":this._z=Math.asin(-ya(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(x,p),this._y=Math.atan2(s,o)):(this._x=Math.atan2(-g,b),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,i===!0&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return tL.makeRotationFromQuaternion(e),this.setFromRotationMatrix(tL,t,i)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return iL.setFromEuler(this),this.setFromQuaternion(iL,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],e[3]!==void 0&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}toVector3(e){return e?e.set(this._x,this._y,this._z):new Ge(this._x,this._y,this._z)}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}Ep.prototype.isEuler=!0;Ep.DefaultOrder="XYZ";Ep.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class az{constructor(){this.mask=1}set(e){this.mask=1<<e|0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return(this.mask&e.mask)!==0}}let W9=0;const nL=new Ge,Wm=new yo,rh=new ki,Hb=new Ge,Pv=new Ge,H9=new Ge,Z9=new yo,rL=new Ge(1,0,0),sL=new Ge(0,1,0),oL=new Ge(0,0,1),X9={type:"added"},aL={type:"removed"};class Ln extends Mp{constructor(){super(),Object.defineProperty(this,"id",{value:W9++}),this.uuid=Mc(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Ln.DefaultUp.clone();const e=new Ge,t=new Ep,i=new yo,r=new Ge(1,1,1);function o(){i.setFromEuler(t,!1)}function c(){t.setFromQuaternion(i,void 0,!1)}t._onChange(o),i._onChange(c),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new ki},normalMatrix:{value:new vo}}),this.matrix=new ki,this.matrixWorld=new ki,this.matrixAutoUpdate=Ln.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new az,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return Wm.setFromAxisAngle(e,t),this.quaternion.multiply(Wm),this}rotateOnWorldAxis(e,t){return Wm.setFromAxisAngle(e,t),this.quaternion.premultiply(Wm),this}rotateX(e){return this.rotateOnAxis(rL,e)}rotateY(e){return this.rotateOnAxis(sL,e)}rotateZ(e){return this.rotateOnAxis(oL,e)}translateOnAxis(e,t){return nL.copy(e).applyQuaternion(this.quaternion),this.position.add(nL.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(rL,e)}translateY(e){return this.translateOnAxis(sL,e)}translateZ(e){return this.translateOnAxis(oL,e)}localToWorld(e){return e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return e.applyMatrix4(rh.copy(this.matrixWorld).invert())}lookAt(e,t,i){e.isVector3?Hb.copy(e):Hb.set(e,t,i);const r=this.parent;this.updateWorldMatrix(!0,!1),Pv.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?rh.lookAt(Pv,Hb,this.up):rh.lookAt(Hb,Pv,this.up),this.quaternion.setFromRotationMatrix(rh),r&&(rh.extractRotation(r.matrixWorld),Wm.setFromRotationMatrix(rh),this.quaternion.premultiply(Wm.invert()))}add(e){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.parent!==null&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(X9)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.remove(arguments[i]);return this}const t=this.children.indexOf(e);return t!==-1&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(aL)),this}removeFromParent(){const e=this.parent;return e!==null&&e.remove(this),this}clear(){for(let e=0;e<this.children.length;e++){const t=this.children[e];t.parent=null,t.dispatchEvent(aL)}return this.children.length=0,this}attach(e){return this.updateWorldMatrix(!0,!1),rh.copy(this.matrixWorld).invert(),e.parent!==null&&(e.parent.updateWorldMatrix(!0,!1),rh.multiply(e.parent.matrixWorld)),e.applyMatrix4(rh),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let i=0,r=this.children.length;i<r;i++){const c=this.children[i].getObjectByProperty(e,t);if(c!==void 0)return c}}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Pv,e,H9),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Pv,Z9,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let i=0,r=t.length;i<r;i++)t[i].traverse(e)}traverseVisible(e){if(this.visible===!1)return;e(this);const t=this.children;for(let i=0,r=t.length;i<r;i++)t[i].traverseVisible(e)}traverseAncestors(e){const t=this.parent;t!==null&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,r=t.length;i<r;i++)t[i].updateMatrixWorld(e)}updateWorldMatrix(e,t){const i=this.parent;if(e===!0&&i!==null&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),t===!0){const r=this.children;for(let o=0,c=r.length;o<c;o++)r[o].updateWorldMatrix(!1,!0)}}toJSON(e){const t=e===void 0||typeof e=="string",i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const r={};r.uuid=this.uuid,r.type=this.type,this.name!==""&&(r.name=this.name),this.castShadow===!0&&(r.castShadow=!0),this.receiveShadow===!0&&(r.receiveShadow=!0),this.visible===!1&&(r.visible=!1),this.frustumCulled===!1&&(r.frustumCulled=!1),this.renderOrder!==0&&(r.renderOrder=this.renderOrder),JSON.stringify(this.userData)!=="{}"&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),this.matrixAutoUpdate===!1&&(r.matrixAutoUpdate=!1),this.isInstancedMesh&&(r.type="InstancedMesh",r.count=this.count,r.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(r.instanceColor=this.instanceColor.toJSON()));function o(s,d){return s[d.uuid]===void 0&&(s[d.uuid]=d.toJSON(e)),d.uuid}if(this.isScene)this.background&&(this.background.isColor?r.background=this.background.toJSON():this.background.isTexture&&(r.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&(r.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){r.geometry=o(e.geometries,this.geometry);const s=this.geometry.parameters;if(s!==void 0&&s.shapes!==void 0){const d=s.shapes;if(Array.isArray(d))for(let p=0,g=d.length;p<g;p++){const _=d[p];o(e.shapes,_)}else o(e.shapes,d)}}if(this.isSkinnedMesh&&(r.bindMode=this.bindMode,r.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(o(e.skeletons,this.skeleton),r.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const s=[];for(let d=0,p=this.material.length;d<p;d++)s.push(o(e.materials,this.material[d]));r.material=s}else r.material=o(e.materials,this.material);if(this.children.length>0){r.children=[];for(let s=0;s<this.children.length;s++)r.children.push(this.children[s].toJSON(e).object)}if(this.animations.length>0){r.animations=[];for(let s=0;s<this.animations.length;s++){const d=this.animations[s];r.animations.push(o(e.animations,d))}}if(t){const s=c(e.geometries),d=c(e.materials),p=c(e.textures),g=c(e.images),_=c(e.shapes),x=c(e.skeletons),b=c(e.animations);s.length>0&&(i.geometries=s),d.length>0&&(i.materials=d),p.length>0&&(i.textures=p),g.length>0&&(i.images=g),_.length>0&&(i.shapes=_),x.length>0&&(i.skeletons=x),b.length>0&&(i.animations=b)}return i.object=r,i;function c(s){const d=[];for(const p in s){const g=s[p];delete g.metadata,d.push(g)}return d}}clone(e){return new this.constructor().copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),t===!0)for(let i=0;i<e.children.length;i++){const r=e.children[i];this.add(r.clone())}return this}}Ln.DefaultUp=new Ge(0,1,0);Ln.DefaultMatrixAutoUpdate=!0;Ln.prototype.isObject3D=!0;const vc=new Ge,sh=new Ge,BT=new Ge,oh=new Ge,Hm=new Ge,Zm=new Ge,lL=new Ge,NT=new Ge,$T=new Ge,VT=new Ge;class Zs{constructor(e=new Ge,t=new Ge,i=new Ge){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,r){r.subVectors(i,t),vc.subVectors(e,t),r.cross(vc);const o=r.lengthSq();return o>0?r.multiplyScalar(1/Math.sqrt(o)):r.set(0,0,0)}static getBarycoord(e,t,i,r,o){vc.subVectors(r,t),sh.subVectors(i,t),BT.subVectors(e,t);const c=vc.dot(vc),s=vc.dot(sh),d=vc.dot(BT),p=sh.dot(sh),g=sh.dot(BT),_=c*p-s*s;if(_===0)return o.set(-2,-1,-1);const x=1/_,b=(p*d-s*g)*x,S=(c*g-s*d)*x;return o.set(1-b-S,S,b)}static containsPoint(e,t,i,r){return this.getBarycoord(e,t,i,r,oh),oh.x>=0&&oh.y>=0&&oh.x+oh.y<=1}static getUV(e,t,i,r,o,c,s,d){return this.getBarycoord(e,t,i,r,oh),d.set(0,0),d.addScaledVector(o,oh.x),d.addScaledVector(c,oh.y),d.addScaledVector(s,oh.z),d}static isFrontFacing(e,t,i,r){return vc.subVectors(i,t),sh.subVectors(e,t),vc.cross(sh).dot(r)<0}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,r){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[r]),this}setFromAttributeAndIndices(e,t,i,r){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,i),this.c.fromBufferAttribute(e,r),this}clone(){return new this.constructor().copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return vc.subVectors(this.c,this.b),sh.subVectors(this.a,this.b),vc.cross(sh).length()*.5}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Zs.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Zs.getBarycoord(e,this.a,this.b,this.c,t)}getUV(e,t,i,r,o){return Zs.getUV(e,this.a,this.b,this.c,t,i,r,o)}containsPoint(e){return Zs.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Zs.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const i=this.a,r=this.b,o=this.c;let c,s;Hm.subVectors(r,i),Zm.subVectors(o,i),NT.subVectors(e,i);const d=Hm.dot(NT),p=Zm.dot(NT);if(d<=0&&p<=0)return t.copy(i);$T.subVectors(e,r);const g=Hm.dot($T),_=Zm.dot($T);if(g>=0&&_<=g)return t.copy(r);const x=d*_-g*p;if(x<=0&&d>=0&&g<=0)return c=d/(d-g),t.copy(i).addScaledVector(Hm,c);VT.subVectors(e,o);const b=Hm.dot(VT),S=Zm.dot(VT);if(S>=0&&b<=S)return t.copy(o);const P=b*p-d*S;if(P<=0&&p>=0&&S<=0)return s=p/(p-S),t.copy(i).addScaledVector(Zm,s);const L=g*S-b*_;if(L<=0&&_-g>=0&&b-S>=0)return lL.subVectors(o,r),s=(_-g)/(_-g+(b-S)),t.copy(r).addScaledVector(lL,s);const E=1/(L+P+x);return c=P*E,s=x*E,t.copy(i).addScaledVector(Hm,c).addScaledVector(Zm,s)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let Y9=0;class Vo extends Mp{constructor(){super(),Object.defineProperty(this,"id",{value:Y9++}),this.uuid=Mc(),this.name="",this.type="Material",this.fog=!0,this.blending=py,this.side=Hg,this.vertexColors=!1,this.opacity=1,this.format=ca,this.transparent=!1,this.blendSrc=KO,this.blendDst=JO,this.blendEquation=pg,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=o2,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=M9,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=AT,this.stencilZFail=AT,this.stencilZPass=AT,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(e!==void 0)for(const t in e){const i=e[t];if(i===void 0){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}if(t==="shading"){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=i===YO;continue}const r=this[t];if(r===void 0){console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.");continue}r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]=i}}toJSON(e){const t=e===void 0||typeof e=="string";t&&(e={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};i.uuid=this.uuid,i.type=this.type,this.name!==""&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),this.roughness!==void 0&&(i.roughness=this.roughness),this.metalness!==void 0&&(i.metalness=this.metalness),this.sheen!==void 0&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),this.sheenRoughness!==void 0&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&this.emissiveIntensity!==1&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),this.shininess!==void 0&&(i.shininess=this.shininess),this.clearcoat!==void 0&&(i.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,this.combine!==void 0&&(i.combine=this.combine)),this.envMapIntensity!==void 0&&(i.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(i.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),this.transmission!==void 0&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(e).uuid),this.thickness!==void 0&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(e).uuid),this.attenuationDistance!==void 0&&(i.attenuationDistance=this.attenuationDistance),this.attenuationColor!==void 0&&(i.attenuationColor=this.attenuationColor.getHex()),this.size!==void 0&&(i.size=this.size),this.shadowSide!==null&&(i.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==py&&(i.blending=this.blending),this.side!==Hg&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),this.format!==ca&&(i.format=this.format),this.transparent===!0&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.colorWrite=this.colorWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,this.rotation&&this.rotation!==0&&(i.rotation=this.rotation),this.polygonOffset===!0&&(i.polygonOffset=!0),this.polygonOffsetFactor!==0&&(i.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&this.linewidth!==1&&(i.linewidth=this.linewidth),this.dashSize!==void 0&&(i.dashSize=this.dashSize),this.gapSize!==void 0&&(i.gapSize=this.gapSize),this.scale!==void 0&&(i.scale=this.scale),this.dithering===!0&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),this.alphaToCoverage===!0&&(i.alphaToCoverage=this.alphaToCoverage),this.premultipliedAlpha===!0&&(i.premultipliedAlpha=this.premultipliedAlpha),this.wireframe===!0&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(i.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(i.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(i.flatShading=this.flatShading),this.visible===!1&&(i.visible=!1),this.toneMapped===!1&&(i.toneMapped=!1),JSON.stringify(this.userData)!=="{}"&&(i.userData=this.userData);function r(o){const c=[];for(const s in o){const d=o[s];delete d.metadata,c.push(d)}return c}if(t){const o=r(e.textures),c=r(e.images);o.length>0&&(i.textures=o),c.length>0&&(i.images=c)}return i}clone(){return new this.constructor().copy(this)}copy(e){this.name=e.name,this.fog=e.fog,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.format=e.format,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(t!==null){const r=t.length;i=new Array(r);for(let o=0;o!==r;++o)i[o]=t[o].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){e===!0&&this.version++}}Vo.prototype.isMaterial=!0;const lz={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},yc={h:0,s:0,l:0},Zb={h:0,s:0,l:0};function UT(n,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?n+(e-n)*6*t:t<1/2?e:t<2/3?n+(e-n)*6*(2/3-t):n}function jT(n){return n<.04045?n*.0773993808:Math.pow(n*.9478672986+.0521327014,2.4)}function GT(n){return n<.0031308?n*12.92:1.055*Math.pow(n,.41666)-.055}class $i{constructor(e,t,i){return t===void 0&&i===void 0?this.set(e):this.setRGB(e,t,i)}set(e){return e&&e.isColor?this.copy(e):typeof e=="number"?this.setHex(e):typeof e=="string"&&this.setStyle(e),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,this}setRGB(e,t,i){return this.r=e,this.g=t,this.b=i,this}setHSL(e,t,i){if(e=zC(e,1),t=ya(t,0,1),i=ya(i,0,1),t===0)this.r=this.g=this.b=i;else{const r=i<=.5?i*(1+t):i+t-i*t,o=2*i-r;this.r=UT(o,r,e+1/3),this.g=UT(o,r,e),this.b=UT(o,r,e-1/3)}return this}setStyle(e){function t(r){r!==void 0&&parseFloat(r)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(e)){let r;const o=i[1],c=i[2];switch(o){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(c))return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,t(r[4]),this;if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(c))return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,t(r[4]),this;break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(c)){const s=parseFloat(r[1])/360,d=parseInt(r[2],10)/100,p=parseInt(r[3],10)/100;return t(r[4]),this.setHSL(s,d,p)}break}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const r=i[1],o=r.length;if(o===3)return this.r=parseInt(r.charAt(0)+r.charAt(0),16)/255,this.g=parseInt(r.charAt(1)+r.charAt(1),16)/255,this.b=parseInt(r.charAt(2)+r.charAt(2),16)/255,this;if(o===6)return this.r=parseInt(r.charAt(0)+r.charAt(1),16)/255,this.g=parseInt(r.charAt(2)+r.charAt(3),16)/255,this.b=parseInt(r.charAt(4)+r.charAt(5),16)/255,this}return e&&e.length>0?this.setColorName(e):this}setColorName(e){const t=lz[e.toLowerCase()];return t!==void 0?this.setHex(t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyGammaToLinear(e,t=2){return this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this}copyLinearToGamma(e,t=2){const i=t>0?1/t:1;return this.r=Math.pow(e.r,i),this.g=Math.pow(e.g,i),this.b=Math.pow(e.b,i),this}convertGammaToLinear(e){return this.copyGammaToLinear(this,e),this}convertLinearToGamma(e){return this.copyLinearToGamma(this,e),this}copySRGBToLinear(e){return this.r=jT(e.r),this.g=jT(e.g),this.b=jT(e.b),this}copyLinearToSRGB(e){return this.r=GT(e.r),this.g=GT(e.g),this.b=GT(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return this.r*255<<16^this.g*255<<8^this.b*255<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(e){const t=this.r,i=this.g,r=this.b,o=Math.max(t,i,r),c=Math.min(t,i,r);let s,d;const p=(c+o)/2;if(c===o)s=0,d=0;else{const g=o-c;switch(d=p<=.5?g/(o+c):g/(2-o-c),o){case t:s=(i-r)/g+(i<r?6:0);break;case i:s=(r-t)/g+2;break;case r:s=(t-i)/g+4;break}s/=6}return e.h=s,e.s=d,e.l=p,e}getStyle(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"}offsetHSL(e,t,i){return this.getHSL(yc),yc.h+=e,yc.s+=t,yc.l+=i,this.setHSL(yc.h,yc.s,yc.l),this}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(yc),e.getHSL(Zb);const i=_y(yc.h,Zb.h,t),r=_y(yc.s,Zb.s,t),o=_y(yc.l,Zb.l,t);return this.setHSL(i,r,o),this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),e.normalized===!0&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}$i.NAMES=lz;$i.prototype.isColor=!0;$i.prototype.r=1;$i.prototype.g=1;$i.prototype.b=1;class g0 extends Vo{constructor(e){super(),this.type="MeshBasicMaterial",this.color=new $i(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=u1,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this}}g0.prototype.isMeshBasicMaterial=!0;const Lr=new Ge,Xb=new li;class En{constructor(e,t,i){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=e,this.itemSize=t,this.count=e!==void 0?e.length/t:0,this.normalized=i===!0,this.usage=Ny,this.updateRange={offset:0,count:-1},this.version=0}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this}copyAt(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let r=0,o=this.itemSize;r<o;r++)this.array[e+r]=t.array[i+r];return this}copyArray(e){return this.array.set(e),this}copyColorsArray(e){const t=this.array;let i=0;for(let r=0,o=e.length;r<o;r++){let c=e[r];c===void 0&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",r),c=new $i),t[i++]=c.r,t[i++]=c.g,t[i++]=c.b}return this}copyVector2sArray(e){const t=this.array;let i=0;for(let r=0,o=e.length;r<o;r++){let c=e[r];c===void 0&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",r),c=new li),t[i++]=c.x,t[i++]=c.y}return this}copyVector3sArray(e){const t=this.array;let i=0;for(let r=0,o=e.length;r<o;r++){let c=e[r];c===void 0&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",r),c=new Ge),t[i++]=c.x,t[i++]=c.y,t[i++]=c.z}return this}copyVector4sArray(e){const t=this.array;let i=0;for(let r=0,o=e.length;r<o;r++){let c=e[r];c===void 0&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",r),c=new Xn),t[i++]=c.x,t[i++]=c.y,t[i++]=c.z,t[i++]=c.w}return this}applyMatrix3(e){if(this.itemSize===2)for(let t=0,i=this.count;t<i;t++)Xb.fromBufferAttribute(this,t),Xb.applyMatrix3(e),this.setXY(t,Xb.x,Xb.y);else if(this.itemSize===3)for(let t=0,i=this.count;t<i;t++)Lr.fromBufferAttribute(this,t),Lr.applyMatrix3(e),this.setXYZ(t,Lr.x,Lr.y,Lr.z);return this}applyMatrix4(e){for(let t=0,i=this.count;t<i;t++)Lr.x=this.getX(t),Lr.y=this.getY(t),Lr.z=this.getZ(t),Lr.applyMatrix4(e),this.setXYZ(t,Lr.x,Lr.y,Lr.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)Lr.x=this.getX(t),Lr.y=this.getY(t),Lr.z=this.getZ(t),Lr.applyNormalMatrix(e),this.setXYZ(t,Lr.x,Lr.y,Lr.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)Lr.x=this.getX(t),Lr.y=this.getY(t),Lr.z=this.getZ(t),Lr.transformDirection(e),this.setXYZ(t,Lr.x,Lr.y,Lr.z);return this}set(e,t=0){return this.array.set(e,t),this}getX(e){return this.array[e*this.itemSize]}setX(e,t){return this.array[e*this.itemSize]=t,this}getY(e){return this.array[e*this.itemSize+1]}setY(e,t){return this.array[e*this.itemSize+1]=t,this}getZ(e){return this.array[e*this.itemSize+2]}setZ(e,t){return this.array[e*this.itemSize+2]=t,this}getW(e){return this.array[e*this.itemSize+3]}setW(e,t){return this.array[e*this.itemSize+3]=t,this}setXY(e,t,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this}setXYZ(e,t,i,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=r,this}setXYZW(e,t,i,r,o){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=r,this.array[e+3]=o,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized};return this.name!==""&&(e.name=this.name),this.usage!==Ny&&(e.usage=this.usage),(this.updateRange.offset!==0||this.updateRange.count!==-1)&&(e.updateRange=this.updateRange),e}}En.prototype.isBufferAttribute=!0;class cz extends En{constructor(e,t,i){super(new Uint16Array(e),t,i)}}class uz extends En{constructor(e,t,i){super(new Uint32Array(e),t,i)}}class K9 extends En{constructor(e,t,i){super(new Uint16Array(e),t,i)}}K9.prototype.isFloat16BufferAttribute=!0;class ws extends En{constructor(e,t,i){super(new Float32Array(e),t,i)}}let J9=0;const Al=new ki,qT=new Ln,Xm=new Ge,Xa=new dl,Iv=new dl,no=new Ge;class jn extends Mp{constructor(){super(),Object.defineProperty(this,"id",{value:J9++}),this.uuid=Mc(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(sz(e)>65535?uz:cz)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return this.attributes[e]!==void 0}addGroup(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;t!==void 0&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(i!==void 0){const o=new vo().getNormalMatrix(e);i.applyNormalMatrix(o),i.needsUpdate=!0}const r=this.attributes.tangent;return r!==void 0&&(r.transformDirection(e),r.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(e){return Al.makeRotationFromQuaternion(e),this.applyMatrix4(Al),this}rotateX(e){return Al.makeRotationX(e),this.applyMatrix4(Al),this}rotateY(e){return Al.makeRotationY(e),this.applyMatrix4(Al),this}rotateZ(e){return Al.makeRotationZ(e),this.applyMatrix4(Al),this}translate(e,t,i){return Al.makeTranslation(e,t,i),this.applyMatrix4(Al),this}scale(e,t,i){return Al.makeScale(e,t,i),this.applyMatrix4(Al),this}lookAt(e){return qT.lookAt(e),qT.updateMatrix(),this.applyMatrix4(qT.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Xm).negate(),this.translate(Xm.x,Xm.y,Xm.z),this}setFromPoints(e){const t=[];for(let i=0,r=e.length;i<r;i++){const o=e[i];t.push(o.x,o.y,o.z||0)}return this.setAttribute("position",new ws(t,3)),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new dl);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),this.boundingBox.set(new Ge(-1/0,-1/0,-1/0),new Ge(1/0,1/0,1/0));return}if(e!==void 0){if(this.boundingBox.setFromBufferAttribute(e),t)for(let i=0,r=t.length;i<r;i++){const o=t[i];Xa.setFromBufferAttribute(o),this.morphTargetsRelative?(no.addVectors(this.boundingBox.min,Xa.min),this.boundingBox.expandByPoint(no),no.addVectors(this.boundingBox.max,Xa.max),this.boundingBox.expandByPoint(no)):(this.boundingBox.expandByPoint(Xa.min),this.boundingBox.expandByPoint(Xa.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new f_);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),this.boundingSphere.set(new Ge,1/0);return}if(e){const i=this.boundingSphere.center;if(Xa.setFromBufferAttribute(e),t)for(let o=0,c=t.length;o<c;o++){const s=t[o];Iv.setFromBufferAttribute(s),this.morphTargetsRelative?(no.addVectors(Xa.min,Iv.min),Xa.expandByPoint(no),no.addVectors(Xa.max,Iv.max),Xa.expandByPoint(no)):(Xa.expandByPoint(Iv.min),Xa.expandByPoint(Iv.max))}Xa.getCenter(i);let r=0;for(let o=0,c=e.count;o<c;o++)no.fromBufferAttribute(e,o),r=Math.max(r,i.distanceToSquared(no));if(t)for(let o=0,c=t.length;o<c;o++){const s=t[o],d=this.morphTargetsRelative;for(let p=0,g=s.count;p<g;p++)no.fromBufferAttribute(s,p),d&&(Xm.fromBufferAttribute(e,p),no.add(Xm)),r=Math.max(r,i.distanceToSquared(no))}this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(e===null||t.position===void 0||t.normal===void 0||t.uv===void 0){console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}const i=e.array,r=t.position.array,o=t.normal.array,c=t.uv.array,s=r.length/3;t.tangent===void 0&&this.setAttribute("tangent",new En(new Float32Array(4*s),4));const d=t.tangent.array,p=[],g=[];for(let q=0;q<s;q++)p[q]=new Ge,g[q]=new Ge;const _=new Ge,x=new Ge,b=new Ge,S=new li,P=new li,L=new li,E=new Ge,C=new Ge;function D(q,z,Q){_.fromArray(r,q*3),x.fromArray(r,z*3),b.fromArray(r,Q*3),S.fromArray(c,q*2),P.fromArray(c,z*2),L.fromArray(c,Q*2),x.sub(_),b.sub(_),P.sub(S),L.sub(S);const X=1/(P.x*L.y-L.x*P.y);isFinite(X)&&(E.copy(x).multiplyScalar(L.y).addScaledVector(b,-P.y).multiplyScalar(X),C.copy(b).multiplyScalar(P.x).addScaledVector(x,-L.x).multiplyScalar(X),p[q].add(E),p[z].add(E),p[Q].add(E),g[q].add(C),g[z].add(C),g[Q].add(C))}let O=this.groups;O.length===0&&(O=[{start:0,count:i.length}]);for(let q=0,z=O.length;q<z;++q){const Q=O[q],X=Q.start,re=Q.count;for(let oe=X,de=X+re;oe<de;oe+=3)D(i[oe+0],i[oe+1],i[oe+2])}const U=new Ge,j=new Ge,G=new Ge,N=new Ge;function V(q){G.fromArray(o,q*3),N.copy(G);const z=p[q];U.copy(z),U.sub(G.multiplyScalar(G.dot(z))).normalize(),j.crossVectors(N,z);const X=j.dot(g[q])<0?-1:1;d[q*4]=U.x,d[q*4+1]=U.y,d[q*4+2]=U.z,d[q*4+3]=X}for(let q=0,z=O.length;q<z;++q){const Q=O[q],X=Q.start,re=Q.count;for(let oe=X,de=X+re;oe<de;oe+=3)V(i[oe+0]),V(i[oe+1]),V(i[oe+2])}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(t!==void 0){let i=this.getAttribute("normal");if(i===void 0)i=new En(new Float32Array(t.count*3),3),this.setAttribute("normal",i);else for(let x=0,b=i.count;x<b;x++)i.setXYZ(x,0,0,0);const r=new Ge,o=new Ge,c=new Ge,s=new Ge,d=new Ge,p=new Ge,g=new Ge,_=new Ge;if(e)for(let x=0,b=e.count;x<b;x+=3){const S=e.getX(x+0),P=e.getX(x+1),L=e.getX(x+2);r.fromBufferAttribute(t,S),o.fromBufferAttribute(t,P),c.fromBufferAttribute(t,L),g.subVectors(c,o),_.subVectors(r,o),g.cross(_),s.fromBufferAttribute(i,S),d.fromBufferAttribute(i,P),p.fromBufferAttribute(i,L),s.add(g),d.add(g),p.add(g),i.setXYZ(S,s.x,s.y,s.z),i.setXYZ(P,d.x,d.y,d.z),i.setXYZ(L,p.x,p.y,p.z)}else for(let x=0,b=t.count;x<b;x+=3)r.fromBufferAttribute(t,x+0),o.fromBufferAttribute(t,x+1),c.fromBufferAttribute(t,x+2),g.subVectors(c,o),_.subVectors(r,o),g.cross(_),i.setXYZ(x+0,g.x,g.y,g.z),i.setXYZ(x+1,g.x,g.y,g.z),i.setXYZ(x+2,g.x,g.y,g.z);this.normalizeNormals(),i.needsUpdate=!0}}merge(e,t){if(!(e&&e.isBufferGeometry)){console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);return}t===void 0&&(t=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const i=this.attributes;for(const r in i){if(e.attributes[r]===void 0)continue;const c=i[r].array,s=e.attributes[r],d=s.array,p=s.itemSize*t,g=Math.min(d.length,c.length-p);for(let _=0,x=p;_<g;_++,x++)c[x]=d[_]}return this}normalizeNormals(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)no.fromBufferAttribute(e,t),no.normalize(),e.setXYZ(t,no.x,no.y,no.z)}toNonIndexed(){function e(s,d){const p=s.array,g=s.itemSize,_=s.normalized,x=new p.constructor(d.length*g);let b=0,S=0;for(let P=0,L=d.length;P<L;P++){s.isInterleavedBufferAttribute?b=d[P]*s.data.stride+s.offset:b=d[P]*g;for(let E=0;E<g;E++)x[S++]=p[b++]}return new En(x,g,_)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new jn,i=this.index.array,r=this.attributes;for(const s in r){const d=r[s],p=e(d,i);t.setAttribute(s,p)}const o=this.morphAttributes;for(const s in o){const d=[],p=o[s];for(let g=0,_=p.length;g<_;g++){const x=p[g],b=e(x,i);d.push(b)}t.morphAttributes[s]=d}t.morphTargetsRelative=this.morphTargetsRelative;const c=this.groups;for(let s=0,d=c.length;s<d;s++){const p=c[s];t.addGroup(p.start,p.count,p.materialIndex)}return t}toJSON(){const e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,this.name!==""&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),this.parameters!==void 0){const d=this.parameters;for(const p in d)d[p]!==void 0&&(e[p]=d[p]);return e}e.data={attributes:{}};const t=this.index;t!==null&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const d in i){const p=i[d];e.data.attributes[d]=p.toJSON(e.data)}const r={};let o=!1;for(const d in this.morphAttributes){const p=this.morphAttributes[d],g=[];for(let _=0,x=p.length;_<x;_++){const b=p[_];g.push(b.toJSON(e.data))}g.length>0&&(r[d]=g,o=!0)}o&&(e.data.morphAttributes=r,e.data.morphTargetsRelative=this.morphTargetsRelative);const c=this.groups;c.length>0&&(e.data.groups=JSON.parse(JSON.stringify(c)));const s=this.boundingSphere;return s!==null&&(e.data.boundingSphere={center:s.center.toArray(),radius:s.radius}),e}clone(){return new this.constructor().copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;i!==null&&this.setIndex(i.clone(t));const r=e.attributes;for(const p in r){const g=r[p];this.setAttribute(p,g.clone(t))}const o=e.morphAttributes;for(const p in o){const g=[],_=o[p];for(let x=0,b=_.length;x<b;x++)g.push(_[x].clone(t));this.morphAttributes[p]=g}this.morphTargetsRelative=e.morphTargetsRelative;const c=e.groups;for(let p=0,g=c.length;p<g;p++){const _=c[p];this.addGroup(_.start,_.count,_.materialIndex)}const s=e.boundingBox;s!==null&&(this.boundingBox=s.clone());const d=e.boundingSphere;return d!==null&&(this.boundingSphere=d.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,e.parameters!==void 0&&(this.parameters=Object.assign({},e.parameters)),this}dispose(){this.dispatchEvent({type:"dispose"})}}jn.prototype.isBufferGeometry=!0;const cL=new ki,Ym=new Cp,WT=new f_,md=new Ge,gd=new Ge,_d=new Ge,HT=new Ge,ZT=new Ge,XT=new Ge,Yb=new Ge,Kb=new Ge,Jb=new Ge,Qb=new li,ex=new li,tx=new li,YT=new Ge,ix=new Ge;class kr extends Ln{constructor(e=new jn,t=new g0){super(),this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),e.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),e.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const r=t[i[0]];if(r!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let o=0,c=r.length;o<c;o++){const s=r[o].name||String(o);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=o}}}}else{const t=e.morphTargets;t!==void 0&&t.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}raycast(e,t){const i=this.geometry,r=this.material,o=this.matrixWorld;if(r===void 0||(i.boundingSphere===null&&i.computeBoundingSphere(),WT.copy(i.boundingSphere),WT.applyMatrix4(o),e.ray.intersectsSphere(WT)===!1)||(cL.copy(o).invert(),Ym.copy(e.ray).applyMatrix4(cL),i.boundingBox!==null&&Ym.intersectsBox(i.boundingBox)===!1))return;let c;if(i.isBufferGeometry){const s=i.index,d=i.attributes.position,p=i.morphAttributes.position,g=i.morphTargetsRelative,_=i.attributes.uv,x=i.attributes.uv2,b=i.groups,S=i.drawRange;if(s!==null)if(Array.isArray(r))for(let P=0,L=b.length;P<L;P++){const E=b[P],C=r[E.materialIndex],D=Math.max(E.start,S.start),O=Math.min(s.count,Math.min(E.start+E.count,S.start+S.count));for(let U=D,j=O;U<j;U+=3){const G=s.getX(U),N=s.getX(U+1),V=s.getX(U+2);c=nx(this,C,e,Ym,d,p,g,_,x,G,N,V),c&&(c.faceIndex=Math.floor(U/3),c.face.materialIndex=E.materialIndex,t.push(c))}}else{const P=Math.max(0,S.start),L=Math.min(s.count,S.start+S.count);for(let E=P,C=L;E<C;E+=3){const D=s.getX(E),O=s.getX(E+1),U=s.getX(E+2);c=nx(this,r,e,Ym,d,p,g,_,x,D,O,U),c&&(c.faceIndex=Math.floor(E/3),t.push(c))}}else if(d!==void 0)if(Array.isArray(r))for(let P=0,L=b.length;P<L;P++){const E=b[P],C=r[E.materialIndex],D=Math.max(E.start,S.start),O=Math.min(d.count,Math.min(E.start+E.count,S.start+S.count));for(let U=D,j=O;U<j;U+=3){const G=U,N=U+1,V=U+2;c=nx(this,C,e,Ym,d,p,g,_,x,G,N,V),c&&(c.faceIndex=Math.floor(U/3),c.face.materialIndex=E.materialIndex,t.push(c))}}else{const P=Math.max(0,S.start),L=Math.min(d.count,S.start+S.count);for(let E=P,C=L;E<C;E+=3){const D=E,O=E+1,U=E+2;c=nx(this,r,e,Ym,d,p,g,_,x,D,O,U),c&&(c.faceIndex=Math.floor(E/3),t.push(c))}}}else i.isGeometry&&console.error("THREE.Mesh.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}kr.prototype.isMesh=!0;function Q9(n,e,t,i,r,o,c,s){let d;if(e.side===Gs?d=i.intersectTriangle(c,o,r,!0,s):d=i.intersectTriangle(r,o,c,e.side!==ea,s),d===null)return null;ix.copy(s),ix.applyMatrix4(n.matrixWorld);const p=t.ray.origin.distanceTo(ix);return p<t.near||p>t.far?null:{distance:p,point:ix.clone(),object:n}}function nx(n,e,t,i,r,o,c,s,d,p,g,_){md.fromBufferAttribute(r,p),gd.fromBufferAttribute(r,g),_d.fromBufferAttribute(r,_);const x=n.morphTargetInfluences;if(o&&x){Yb.set(0,0,0),Kb.set(0,0,0),Jb.set(0,0,0);for(let S=0,P=o.length;S<P;S++){const L=x[S],E=o[S];L!==0&&(HT.fromBufferAttribute(E,p),ZT.fromBufferAttribute(E,g),XT.fromBufferAttribute(E,_),c?(Yb.addScaledVector(HT,L),Kb.addScaledVector(ZT,L),Jb.addScaledVector(XT,L)):(Yb.addScaledVector(HT.sub(md),L),Kb.addScaledVector(ZT.sub(gd),L),Jb.addScaledVector(XT.sub(_d),L)))}md.add(Yb),gd.add(Kb),_d.add(Jb)}n.isSkinnedMesh&&(n.boneTransform(p,md),n.boneTransform(g,gd),n.boneTransform(_,_d));const b=Q9(n,e,t,i,md,gd,_d,YT);if(b){s&&(Qb.fromBufferAttribute(s,p),ex.fromBufferAttribute(s,g),tx.fromBufferAttribute(s,_),b.uv=Zs.getUV(YT,md,gd,_d,Qb,ex,tx,new li)),d&&(Qb.fromBufferAttribute(d,p),ex.fromBufferAttribute(d,g),tx.fromBufferAttribute(d,_),b.uv2=Zs.getUV(YT,md,gd,_d,Qb,ex,tx,new li));const S={a:p,b:g,c:_,normal:new Ge,materialIndex:0};Zs.getNormal(md,gd,_d,S.normal),b.face=S}return b}class _0 extends jn{constructor(e=1,t=1,i=1,r=1,o=1,c=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:r,heightSegments:o,depthSegments:c};const s=this;r=Math.floor(r),o=Math.floor(o),c=Math.floor(c);const d=[],p=[],g=[],_=[];let x=0,b=0;S("z","y","x",-1,-1,i,t,e,c,o,0),S("z","y","x",1,-1,i,t,-e,c,o,1),S("x","z","y",1,1,e,i,t,r,c,2),S("x","z","y",1,-1,e,i,-t,r,c,3),S("x","y","z",1,-1,e,t,i,r,o,4),S("x","y","z",-1,-1,e,t,-i,r,o,5),this.setIndex(d),this.setAttribute("position",new ws(p,3)),this.setAttribute("normal",new ws(g,3)),this.setAttribute("uv",new ws(_,2));function S(P,L,E,C,D,O,U,j,G,N,V){const q=O/G,z=U/N,Q=O/2,X=U/2,re=j/2,oe=G+1,de=N+1;let ce=0,Se=0;const Pe=new Ge;for(let je=0;je<de;je++){const Fe=je*z-X;for(let qe=0;qe<oe;qe++){const Ue=qe*q-Q;Pe[P]=Ue*C,Pe[L]=Fe*D,Pe[E]=re,p.push(Pe.x,Pe.y,Pe.z),Pe[P]=0,Pe[L]=0,Pe[E]=j>0?1:-1,g.push(Pe.x,Pe.y,Pe.z),_.push(qe/G),_.push(1-je/N),ce+=1}}for(let je=0;je<N;je++)for(let Fe=0;Fe<G;Fe++){const qe=x+Fe+oe*je,Ue=x+Fe+oe*(je+1),ke=x+(Fe+1)+oe*(je+1),et=x+(Fe+1)+oe*je;d.push(qe,Ue,et),d.push(Ue,ke,et),Se+=6}s.addGroup(b,Se,V),b+=Se,x+=ce}}static fromJSON(e){return new _0(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function Xg(n){const e={};for(const t in n){e[t]={};for(const i in n[t]){const r=n[t][i];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?e[t][i]=r.clone():Array.isArray(r)?e[t][i]=r.slice():e[t][i]=r}}return e}function Io(n){const e={};for(let t=0;t<n.length;t++){const i=Xg(n[t]);for(const r in i)e[r]=i[r]}return e}const eZ={clone:Xg,merge:Io};var tZ=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,iZ=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`;class ta extends Vo{constructor(e){super(),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader=tZ,this.fragmentShader=iZ,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,e!==void 0&&(e.attributes!==void 0&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Xg(e.uniforms),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const r in this.uniforms){const c=this.uniforms[r].value;c&&c.isTexture?t.uniforms[r]={type:"t",value:c.toJSON(e).uuid}:c&&c.isColor?t.uniforms[r]={type:"c",value:c.getHex()}:c&&c.isVector2?t.uniforms[r]={type:"v2",value:c.toArray()}:c&&c.isVector3?t.uniforms[r]={type:"v3",value:c.toArray()}:c&&c.isVector4?t.uniforms[r]={type:"v4",value:c.toArray()}:c&&c.isMatrix3?t.uniforms[r]={type:"m3",value:c.toArray()}:c&&c.isMatrix4?t.uniforms[r]={type:"m4",value:c.toArray()}:t.uniforms[r]={value:c}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader;const i={};for(const r in this.extensions)this.extensions[r]===!0&&(i[r]=!0);return Object.keys(i).length>0&&(t.extensions=i),t}}ta.prototype.isShaderMaterial=!0;class v0 extends Ln{constructor(){super(),this.type="Camera",this.matrixWorldInverse=new ki,this.projectionMatrix=new ki,this.projectionMatrixInverse=new ki}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(-t[8],-t[9],-t[10]).normalize()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}v0.prototype.isCamera=!0;class na extends v0{constructor(e=50,t=1,i=.1,r=2e3){super(),this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=r,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=e.view===null?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=$y*2*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(gy*.5*this.fov);return .5*this.getFilmHeight()/e}getEffectiveFOV(){return $y*2*Math.atan(Math.tan(gy*.5*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(e,t,i,r,o,c){this.aspect=e/t,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=r,this.view.width=o,this.view.height=c,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(gy*.5*this.fov)/this.zoom,i=2*t,r=this.aspect*i,o=-.5*r;const c=this.view;if(this.view!==null&&this.view.enabled){const d=c.fullWidth,p=c.fullHeight;o+=c.offsetX*r/d,t-=c.offsetY*i/p,r*=c.width/d,i*=c.height/p}const s=this.filmOffset;s!==0&&(o+=e*s/this.getFilmWidth()),this.projectionMatrix.makePerspective(o,o+r,t,t-i,e,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,this.view!==null&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}na.prototype.isPerspectiveCamera=!0;const Km=90,Jm=1;class BC extends Ln{constructor(e,t,i){if(super(),this.type="CubeCamera",i.isWebGLCubeRenderTarget!==!0){console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");return}this.renderTarget=i;const r=new na(Km,Jm,e,t);r.layers=this.layers,r.up.set(0,-1,0),r.lookAt(new Ge(1,0,0)),this.add(r);const o=new na(Km,Jm,e,t);o.layers=this.layers,o.up.set(0,-1,0),o.lookAt(new Ge(-1,0,0)),this.add(o);const c=new na(Km,Jm,e,t);c.layers=this.layers,c.up.set(0,0,1),c.lookAt(new Ge(0,1,0)),this.add(c);const s=new na(Km,Jm,e,t);s.layers=this.layers,s.up.set(0,0,-1),s.lookAt(new Ge(0,-1,0)),this.add(s);const d=new na(Km,Jm,e,t);d.layers=this.layers,d.up.set(0,-1,0),d.lookAt(new Ge(0,0,1)),this.add(d);const p=new na(Km,Jm,e,t);p.layers=this.layers,p.up.set(0,-1,0),p.lookAt(new Ge(0,0,-1)),this.add(p)}update(e,t){this.parent===null&&this.updateMatrixWorld();const i=this.renderTarget,[r,o,c,s,d,p]=this.children,g=e.xr.enabled,_=e.getRenderTarget();e.xr.enabled=!1;const x=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0),e.render(t,r),e.setRenderTarget(i,1),e.render(t,o),e.setRenderTarget(i,2),e.render(t,c),e.setRenderTarget(i,3),e.render(t,s),e.setRenderTarget(i,4),e.render(t,d),i.texture.generateMipmaps=x,e.setRenderTarget(i,5),e.render(t,p),e.setRenderTarget(_),e.xr.enabled=g}}class p1 extends Bs{constructor(e,t,i,r,o,c,s,d,p,g){e=e!==void 0?e:[],t=t!==void 0?t:p0,super(e,t,i,r,o,c,s,d,p,g),this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}p1.prototype.isCubeTexture=!0;class hz extends Cc{constructor(e,t,i){Number.isInteger(t)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),t=i),super(e,e,t),t=t||{},this.texture=new p1(void 0,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.encoding),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=t.generateMipmaps!==void 0?t.generateMipmaps:!1,this.texture.minFilter=t.minFilter!==void 0?t.minFilter:Fo,this.texture._needsFlipEnvMap=!1}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.format=ca,this.texture.encoding=t.encoding,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},r=new _0(5,5,5),o=new ta({name:"CubemapFromEquirect",uniforms:Xg(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:Gs,blending:Rd});o.uniforms.tEquirect.value=t;const c=new kr(r,o),s=t.minFilter;return t.minFilter===d1&&(t.minFilter=Fo),new BC(1,10,this).update(e,c),t.minFilter=s,c.geometry.dispose(),c.material.dispose(),this}clear(e,t,i,r){const o=e.getRenderTarget();for(let c=0;c<6;c++)e.setRenderTarget(this,c),e.clear(t,i,r);e.setRenderTarget(o)}}hz.prototype.isWebGLCubeRenderTarget=!0;const KT=new Ge,nZ=new Ge,rZ=new vo;class dh{constructor(e=new Ge(1,0,0),t=0){this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,r){return this.normal.set(e,t,i),this.constant=r,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const r=KT.subVectors(i,t).cross(nZ.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(r,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)}intersectLine(e,t){const i=e.delta(KT),r=this.normal.dot(i);if(r===0)return this.distanceToPoint(e.start)===0?t.copy(e.start):null;const o=-(e.start.dot(this.normal)+this.constant)/r;return o<0||o>1?null:t.copy(i).multiplyScalar(o).add(e.start)}intersectsLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||rZ.getNormalMatrix(e),r=this.coplanarPoint(KT).applyMatrix4(e),o=this.normal.applyMatrix3(i).normalize();return this.constant=-r.dot(o),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new this.constructor().copy(this)}}dh.prototype.isPlane=!0;const Qm=new f_,rx=new Ge;class m1{constructor(e=new dh,t=new dh,i=new dh,r=new dh,o=new dh,c=new dh){this.planes=[e,t,i,r,o,c]}set(e,t,i,r,o,c){const s=this.planes;return s[0].copy(e),s[1].copy(t),s[2].copy(i),s[3].copy(r),s[4].copy(o),s[5].copy(c),this}copy(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e){const t=this.planes,i=e.elements,r=i[0],o=i[1],c=i[2],s=i[3],d=i[4],p=i[5],g=i[6],_=i[7],x=i[8],b=i[9],S=i[10],P=i[11],L=i[12],E=i[13],C=i[14],D=i[15];return t[0].setComponents(s-r,_-d,P-x,D-L).normalize(),t[1].setComponents(s+r,_+d,P+x,D+L).normalize(),t[2].setComponents(s+o,_+p,P+b,D+E).normalize(),t[3].setComponents(s-o,_-p,P-b,D-E).normalize(),t[4].setComponents(s-c,_-g,P-S,D-C).normalize(),t[5].setComponents(s+c,_+g,P+S,D+C).normalize(),this}intersectsObject(e){const t=e.geometry;return t.boundingSphere===null&&t.computeBoundingSphere(),Qm.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(Qm)}intersectsSprite(e){return Qm.center.set(0,0,0),Qm.radius=.7071067811865476,Qm.applyMatrix4(e.matrixWorld),this.intersectsSphere(Qm)}intersectsSphere(e){const t=this.planes,i=e.center,r=-e.radius;for(let o=0;o<6;o++)if(t[o].distanceToPoint(i)<r)return!1;return!0}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const r=t[i];if(rx.x=r.normal.x>0?e.max.x:e.min.x,rx.y=r.normal.y>0?e.max.y:e.min.y,rx.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(rx)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}function dz(){let n=null,e=!1,t=null,i=null;function r(o,c){t(o,c),i=n.requestAnimationFrame(r)}return{start:function(){e!==!0&&t!==null&&(i=n.requestAnimationFrame(r),e=!0)},stop:function(){n.cancelAnimationFrame(i),e=!1},setAnimationLoop:function(o){t=o},setContext:function(o){n=o}}}function sZ(n,e){const t=e.isWebGL2,i=new WeakMap;function r(p,g){const _=p.array,x=p.usage,b=n.createBuffer();n.bindBuffer(g,b),n.bufferData(g,_,x),p.onUploadCallback();let S=5126;return _ instanceof Float32Array?S=5126:_ instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):_ instanceof Uint16Array?p.isFloat16BufferAttribute?t?S=5131:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):S=5123:_ instanceof Int16Array?S=5122:_ instanceof Uint32Array?S=5125:_ instanceof Int32Array?S=5124:_ instanceof Int8Array?S=5120:(_ instanceof Uint8Array||_ instanceof Uint8ClampedArray)&&(S=5121),{buffer:b,type:S,bytesPerElement:_.BYTES_PER_ELEMENT,version:p.version}}function o(p,g,_){const x=g.array,b=g.updateRange;n.bindBuffer(_,p),b.count===-1?n.bufferSubData(_,0,x):(t?n.bufferSubData(_,b.offset*x.BYTES_PER_ELEMENT,x,b.offset,b.count):n.bufferSubData(_,b.offset*x.BYTES_PER_ELEMENT,x.subarray(b.offset,b.offset+b.count)),b.count=-1)}function c(p){return p.isInterleavedBufferAttribute&&(p=p.data),i.get(p)}function s(p){p.isInterleavedBufferAttribute&&(p=p.data);const g=i.get(p);g&&(n.deleteBuffer(g.buffer),i.delete(p))}function d(p,g){if(p.isGLBufferAttribute){const x=i.get(p);(!x||x.version<p.version)&&i.set(p,{buffer:p.buffer,type:p.type,bytesPerElement:p.elementSize,version:p.version});return}p.isInterleavedBufferAttribute&&(p=p.data);const _=i.get(p);_===void 0?i.set(p,r(p,g)):_.version<p.version&&(o(_.buffer,p,g),_.version=p.version)}return{get:c,remove:s,update:d}}class g1 extends jn{constructor(e=1,t=1,i=1,r=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:r};const o=e/2,c=t/2,s=Math.floor(i),d=Math.floor(r),p=s+1,g=d+1,_=e/s,x=t/d,b=[],S=[],P=[],L=[];for(let E=0;E<g;E++){const C=E*x-c;for(let D=0;D<p;D++){const O=D*_-o;S.push(O,-C,0),P.push(0,0,1),L.push(D/s),L.push(1-E/d)}}for(let E=0;E<d;E++)for(let C=0;C<s;C++){const D=C+p*E,O=C+p*(E+1),U=C+1+p*(E+1),j=C+1+p*E;b.push(D,O,j),b.push(O,U,j)}this.setIndex(b),this.setAttribute("position",new ws(S,3)),this.setAttribute("normal",new ws(P,3)),this.setAttribute("uv",new ws(L,2))}static fromJSON(e){return new g1(e.width,e.height,e.widthSegments,e.heightSegments)}}var oZ=`#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, vUv ).g;
#endif`,aZ=`#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,lZ=`#ifdef USE_ALPHATEST
	if ( diffuseColor.a < alphaTest ) discard;
#endif`,cZ=`#ifdef USE_ALPHATEST
	uniform float alphaTest;
#endif`,uZ=`#ifdef USE_AOMAP
	float ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;
	reflectedLight.indirectDiffuse *= ambientOcclusion;
	#if defined( USE_ENVMAP ) && defined( STANDARD )
		float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );
		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );
	#endif
#endif`,hZ=`#ifdef USE_AOMAP
	uniform sampler2D aoMap;
	uniform float aoMapIntensity;
#endif`,dZ="vec3 transformed = vec3( position );",fZ=`vec3 objectNormal = vec3( normal );
#ifdef USE_TANGENT
	vec3 objectTangent = vec3( tangent.xyz );
#endif`,pZ=`vec3 BRDF_Lambert( const in vec3 diffuseColor ) {
	return RECIPROCAL_PI * diffuseColor;
}
vec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
}
float V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	return 0.5 / max( gv + gl, EPSILON );
}
float D_GGX( const in float alpha, const in float dotNH ) {
	float a2 = pow2( alpha );
	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;
	return RECIPROCAL_PI * a2 / pow2( denom );
}
vec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 f0, const in float f90, const in float roughness ) {
	float alpha = pow2( roughness );
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( f0, f90, dotVH );
	float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
	float D = D_GGX( alpha, dotNH );
	return F * ( V * D );
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );
	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return vec3( result );
}
float G_BlinnPhong_Implicit( ) {
	return 0.25;
}
float D_BlinnPhong( const in float shininess, const in float dotNH ) {
	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );
}
vec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( specularColor, 1.0, dotVH );
	float G = G_BlinnPhong_Implicit( );
	float D = D_BlinnPhong( shininess, dotNH );
	return F * ( G * D );
}
#if defined( USE_SHEEN )
float D_Charlie( float roughness, float dotNH ) {
	float alpha = pow2( roughness );
	float invAlpha = 1.0 / alpha;
	float cos2h = dotNH * dotNH;
	float sin2h = max( 1.0 - cos2h, 0.0078125 );
	return ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );
}
float V_Neubelt( float dotNV, float dotNL ) {
	return saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );
}
vec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float D = D_Charlie( sheenRoughness, dotNH );
	float V = V_Neubelt( dotNV, dotNL );
	return sheenColor * ( D * V );
}
#endif`,mZ=`#ifdef USE_BUMPMAP
	uniform sampler2D bumpMap;
	uniform float bumpScale;
	vec2 dHdxy_fwd() {
		vec2 dSTdx = dFdx( vUv );
		vec2 dSTdy = dFdy( vUv );
		float Hll = bumpScale * texture2D( bumpMap, vUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;
		return vec2( dBx, dBy );
	}
	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {
		vec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );
		vec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );
		vec3 vN = surf_norm;
		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );
		float fDet = dot( vSigmaX, R1 ) * faceDirection;
		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );
	}
#endif`,gZ=`#if NUM_CLIPPING_PLANES > 0
	vec4 plane;
	#pragma unroll_loop_start
	for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
		plane = clippingPlanes[ i ];
		if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;
	}
	#pragma unroll_loop_end
	#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
		bool clipped = true;
		#pragma unroll_loop_start
		for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;
		}
		#pragma unroll_loop_end
		if ( clipped ) discard;
	#endif
#endif`,_Z=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
#endif`,vZ=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
#endif`,yZ=`#if NUM_CLIPPING_PLANES > 0
	vClipPosition = - mvPosition.xyz;
#endif`,bZ=`#if defined( USE_COLOR_ALPHA )
	diffuseColor *= vColor;
#elif defined( USE_COLOR )
	diffuseColor.rgb *= vColor;
#endif`,xZ=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR )
	varying vec3 vColor;
#endif`,wZ=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	varying vec3 vColor;
#endif`,SZ=`#if defined( USE_COLOR_ALPHA )
	vColor = vec4( 1.0 );
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	vColor = vec3( 1.0 );
#endif
#ifdef USE_COLOR
	vColor *= color;
#endif
#ifdef USE_INSTANCING_COLOR
	vColor.xyz *= instanceColor.xyz;
#endif`,TZ=`#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6
#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement( a ) ( 1.0 - saturate( a ) )
float pow2( const in float x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }
float average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }
highp float rand( const in vec2 uv ) {
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
	return fract( sin( sn ) * c );
}
#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif
struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};
struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};
struct GeometricContext {
	vec3 position;
	vec3 normal;
	vec3 viewDir;
#ifdef USE_CLEARCOAT
	vec3 clearcoatNormal;
#endif
};
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
}
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
float linearToRelativeLuminance( const in vec3 color ) {
	vec3 weights = vec3( 0.2126, 0.7152, 0.0722 );
	return dot( weights, color.rgb );
}
bool isPerspectiveMatrix( mat4 m ) {
	return m[ 2 ][ 3 ] == - 1.0;
}
vec2 equirectUv( in vec3 dir ) {
	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;
	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;
	return vec2( u, v );
}`,MZ=`#ifdef ENVMAP_TYPE_CUBE_UV
	#define cubeUV_maxMipLevel 8.0
	#define cubeUV_minMipLevel 4.0
	#define cubeUV_maxTileSize 256.0
	#define cubeUV_minTileSize 16.0
	float getFace( vec3 direction ) {
		vec3 absDirection = abs( direction );
		float face = - 1.0;
		if ( absDirection.x > absDirection.z ) {
			if ( absDirection.x > absDirection.y )
				face = direction.x > 0.0 ? 0.0 : 3.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		} else {
			if ( absDirection.z > absDirection.y )
				face = direction.z > 0.0 ? 2.0 : 5.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		}
		return face;
	}
	vec2 getUV( vec3 direction, float face ) {
		vec2 uv;
		if ( face == 0.0 ) {
			uv = vec2( direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 1.0 ) {
			uv = vec2( - direction.x, - direction.z ) / abs( direction.y );
		} else if ( face == 2.0 ) {
			uv = vec2( - direction.x, direction.y ) / abs( direction.z );
		} else if ( face == 3.0 ) {
			uv = vec2( - direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 4.0 ) {
			uv = vec2( - direction.x, direction.z ) / abs( direction.y );
		} else {
			uv = vec2( direction.x, direction.y ) / abs( direction.z );
		}
		return 0.5 * ( uv + 1.0 );
	}
	vec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {
		float face = getFace( direction );
		float filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );
		mipInt = max( mipInt, cubeUV_minMipLevel );
		float faceSize = exp2( mipInt );
		float texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );
		vec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );
		vec2 f = fract( uv );
		uv += 0.5 - f;
		if ( face > 2.0 ) {
			uv.y += faceSize;
			face -= 3.0;
		}
		uv.x += face * faceSize;
		if ( mipInt < cubeUV_maxMipLevel ) {
			uv.y += 2.0 * cubeUV_maxTileSize;
		}
		uv.y += filterInt * 2.0 * cubeUV_minTileSize;
		uv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );
		uv *= texelSize;
		vec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.x += texelSize;
		vec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.y += texelSize;
		vec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.x -= texelSize;
		vec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		vec3 tm = mix( tl, tr, f.x );
		vec3 bm = mix( bl, br, f.x );
		return mix( tm, bm, f.y );
	}
	#define r0 1.0
	#define v0 0.339
	#define m0 - 2.0
	#define r1 0.8
	#define v1 0.276
	#define m1 - 1.0
	#define r4 0.4
	#define v4 0.046
	#define m4 2.0
	#define r5 0.305
	#define v5 0.016
	#define m5 3.0
	#define r6 0.21
	#define v6 0.0038
	#define m6 4.0
	float roughnessToMip( float roughness ) {
		float mip = 0.0;
		if ( roughness >= r1 ) {
			mip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;
		} else if ( roughness >= r4 ) {
			mip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;
		} else if ( roughness >= r5 ) {
			mip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;
		} else if ( roughness >= r6 ) {
			mip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;
		} else {
			mip = - 2.0 * log2( 1.16 * roughness );		}
		return mip;
	}
	vec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {
		float mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );
		float mipF = fract( mip );
		float mipInt = floor( mip );
		vec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );
		if ( mipF == 0.0 ) {
			return vec4( color0, 1.0 );
		} else {
			vec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );
			return vec4( mix( color0, color1, mipF ), 1.0 );
		}
	}
#endif`,CZ=`vec3 transformedNormal = objectNormal;
#ifdef USE_INSTANCING
	mat3 m = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );
	transformedNormal = m * transformedNormal;
#endif
transformedNormal = normalMatrix * transformedNormal;
#ifdef FLIP_SIDED
	transformedNormal = - transformedNormal;
#endif
#ifdef USE_TANGENT
	vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#ifdef FLIP_SIDED
		transformedTangent = - transformedTangent;
	#endif
#endif`,EZ=`#ifdef USE_DISPLACEMENTMAP
	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;
#endif`,AZ=`#ifdef USE_DISPLACEMENTMAP
	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );
#endif`,PZ=`#ifdef USE_EMISSIVEMAP
	vec4 emissiveColor = texture2D( emissiveMap, vUv );
	emissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;
	totalEmissiveRadiance *= emissiveColor.rgb;
#endif`,IZ=`#ifdef USE_EMISSIVEMAP
	uniform sampler2D emissiveMap;
#endif`,RZ="gl_FragColor = linearToOutputTexel( gl_FragColor );",LZ=`
vec4 LinearToLinear( in vec4 value ) {
	return value;
}
vec4 GammaToLinear( in vec4 value, in float gammaFactor ) {
	return vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );
}
vec4 LinearToGamma( in vec4 value, in float gammaFactor ) {
	return vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );
}
vec4 sRGBToLinear( in vec4 value ) {
	return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
}
vec4 LinearTosRGB( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}
vec4 RGBEToLinear( in vec4 value ) {
	return vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );
}
vec4 LinearToRGBE( in vec4 value ) {
	float maxComponent = max( max( value.r, value.g ), value.b );
	float fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );
	return vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );
}
vec4 RGBMToLinear( in vec4 value, in float maxRange ) {
	return vec4( value.rgb * value.a * maxRange, 1.0 );
}
vec4 LinearToRGBM( in vec4 value, in float maxRange ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float M = clamp( maxRGB / maxRange, 0.0, 1.0 );
	M = ceil( M * 255.0 ) / 255.0;
	return vec4( value.rgb / ( M * maxRange ), M );
}
vec4 RGBDToLinear( in vec4 value, in float maxRange ) {
	return vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );
}
vec4 LinearToRGBD( in vec4 value, in float maxRange ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float D = max( maxRange / maxRGB, 1.0 );
	D = clamp( floor( D ) / 255.0, 0.0, 1.0 );
	return vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );
}
const mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );
vec4 LinearToLogLuv( in vec4 value ) {
	vec3 Xp_Y_XYZp = cLogLuvM * value.rgb;
	Xp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );
	vec4 vResult;
	vResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;
	float Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;
	vResult.w = fract( Le );
	vResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;
	return vResult;
}
const mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );
vec4 LogLuvToLinear( in vec4 value ) {
	float Le = value.z * 255.0 + value.w;
	vec3 Xp_Y_XYZp;
	Xp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );
	Xp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;
	Xp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;
	vec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;
	return vec4( max( vRGB, 0.0 ), 1.0 );
}`,kZ=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vec3 cameraToFrag;
		if ( isOrthographic ) {
			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToFrag = normalize( vWorldPosition - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( cameraToFrag, worldNormal );
		#else
			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );
		#endif
	#else
		vec3 reflectVec = vReflect;
	#endif
	#ifdef ENVMAP_TYPE_CUBE
		vec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );
		envColor = envMapTexelToLinear( envColor );
	#elif defined( ENVMAP_TYPE_CUBE_UV )
		vec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );
	#else
		vec4 envColor = vec4( 0.0 );
	#endif
	#ifdef ENVMAP_BLENDING_MULTIPLY
		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_MIX )
		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_ADD )
		outgoingLight += envColor.xyz * specularStrength * reflectivity;
	#endif
#endif`,DZ=`#ifdef USE_ENVMAP
	uniform float envMapIntensity;
	uniform float flipEnvMap;
	uniform int maxMipLevel;
	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
	
#endif`,FZ=`#ifdef USE_ENVMAP
	uniform float reflectivity;
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
#endif`,OZ=`#ifdef USE_ENVMAP
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;
	#else
		varying vec3 vReflect;
		uniform float refractionRatio;
	#endif
#endif`,zZ=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vWorldPosition = worldPosition.xyz;
	#else
		vec3 cameraToVertex;
		if ( isOrthographic ) {
			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vReflect = reflect( cameraToVertex, worldNormal );
		#else
			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );
		#endif
	#endif
#endif`,BZ=`#ifdef USE_FOG
	vFogDepth = - mvPosition.z;
#endif`,NZ=`#ifdef USE_FOG
	varying float vFogDepth;
#endif`,$Z=`#ifdef USE_FOG
	#ifdef FOG_EXP2
		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );
	#else
		float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );
	#endif
	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`,VZ=`#ifdef USE_FOG
	uniform vec3 fogColor;
	varying float vFogDepth;
	#ifdef FOG_EXP2
		uniform float fogDensity;
	#else
		uniform float fogNear;
		uniform float fogFar;
	#endif
#endif`,UZ=`#ifdef USE_GRADIENTMAP
	uniform sampler2D gradientMap;
#endif
vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );
	#ifdef USE_GRADIENTMAP
		return texture2D( gradientMap, coord ).rgb;
	#else
		return ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );
	#endif
}`,jZ=`#ifdef USE_LIGHTMAP
	vec4 lightMapTexel = texture2D( lightMap, vUv2 );
	vec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		lightMapIrradiance *= PI;
	#endif
	reflectedLight.indirectDiffuse += lightMapIrradiance;
#endif`,GZ=`#ifdef USE_LIGHTMAP
	uniform sampler2D lightMap;
	uniform float lightMapIntensity;
#endif`,qZ=`vec3 diffuse = vec3( 1.0 );
GeometricContext geometry;
geometry.position = mvPosition.xyz;
geometry.normal = normalize( transformedNormal );
geometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );
GeometricContext backGeometry;
backGeometry.position = geometry.position;
backGeometry.normal = -geometry.normal;
backGeometry.viewDir = geometry.viewDir;
vLightFront = vec3( 0.0 );
vIndirectFront = vec3( 0.0 );
#ifdef DOUBLE_SIDED
	vLightBack = vec3( 0.0 );
	vIndirectBack = vec3( 0.0 );
#endif
IncidentLight directLight;
float dotNL;
vec3 directLightColor_Diffuse;
vIndirectFront += getAmbientLightIrradiance( ambientLightColor );
vIndirectFront += getLightProbeIrradiance( lightProbe, geometry.normal );
#ifdef DOUBLE_SIDED
	vIndirectBack += getAmbientLightIrradiance( ambientLightColor );
	vIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry.normal );
#endif
#if NUM_POINT_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		getPointLightInfo( pointLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( - dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_SPOT_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		getSpotLightInfo( spotLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( - dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_DIR_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		getDirectionalLightInfo( directionalLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( - dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_HEMI_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
		vIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry.normal );
		#ifdef DOUBLE_SIDED
			vIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry.normal );
		#endif
	}
	#pragma unroll_loop_end
#endif`,WZ=`uniform bool receiveShadow;
uniform vec3 ambientLightColor;
uniform vec3 lightProbe[ 9 ];
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {
	float x = normal.x, y = normal.y, z = normal.z;
	vec3 result = shCoefficients[ 0 ] * 0.886227;
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );
	return result;
}
vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {
	vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );
	return irradiance;
}
vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {
	vec3 irradiance = ambientLightColor;
	return irradiance;
}
float getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
	#if defined ( PHYSICALLY_CORRECT_LIGHTS )
		float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
		if ( cutoffDistance > 0.0 ) {
			distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
		}
		return distanceFalloff;
	#else
		if ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {
			return pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );
		}
		return 1.0;
	#endif
}
float getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {
	return smoothstep( coneCosine, penumbraCosine, angleCosine );
}
#if NUM_DIR_LIGHTS > 0
	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};
	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];
	void getDirectionalLightInfo( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight light ) {
		light.color = directionalLight.color;
		light.direction = directionalLight.direction;
		light.visible = true;
	}
#endif
#if NUM_POINT_LIGHTS > 0
	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};
	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];
	void getPointLightInfo( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight light ) {
		vec3 lVector = pointLight.position - geometry.position;
		light.direction = normalize( lVector );
		float lightDistance = length( lVector );
		light.color = pointLight.color;
		light.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );
		light.visible = ( light.color != vec3( 0.0 ) );
	}
#endif
#if NUM_SPOT_LIGHTS > 0
	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};
	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];
	void getSpotLightInfo( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight light ) {
		vec3 lVector = spotLight.position - geometry.position;
		light.direction = normalize( lVector );
		float angleCos = dot( light.direction, spotLight.direction );
		float spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );
		if ( spotAttenuation > 0.0 ) {
			float lightDistance = length( lVector );
			light.color = spotLight.color * spotAttenuation;
			light.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );
			light.visible = ( light.color != vec3( 0.0 ) );
		} else {
			light.color = vec3( 0.0 );
			light.visible = false;
		}
	}
#endif
#if NUM_RECT_AREA_LIGHTS > 0
	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};
	uniform sampler2D ltc_1;	uniform sampler2D ltc_2;
	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];
#endif
#if NUM_HEMI_LIGHTS > 0
	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};
	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];
	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {
		float dotNL = dot( normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;
		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );
		return irradiance;
	}
#endif`,HZ=`#if defined( USE_ENVMAP )
	#ifdef ENVMAP_MODE_REFRACTION
		uniform float refractionRatio;
	#endif
	vec3 getIBLIrradiance( const in vec3 normal ) {
		#if defined( ENVMAP_TYPE_CUBE_UV )
			vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );
			return PI * envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	vec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {
		#if defined( ENVMAP_TYPE_CUBE_UV )
			vec3 reflectVec;
			#ifdef ENVMAP_MODE_REFLECTION
				reflectVec = reflect( - viewDir, normal );
				reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );
			#else
				reflectVec = refract( - viewDir, normal, refractionRatio );
			#endif
			reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );
			return envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
#endif`,ZZ=`ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;`,XZ=`varying vec3 vViewPosition;
struct ToonMaterial {
	vec3 diffuseColor;
};
void RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon
#define Material_LightProbeLOD( material )	(0)`,YZ=`BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;`,KZ=`varying vec3 vViewPosition;
struct BlinnPhongMaterial {
	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;
};
void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometry.normal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
	reflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularShininess ) * material.specularStrength;
}
void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong
#define Material_LightProbeLOD( material )	(0)`,JZ=`PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );
vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );
material.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;
material.roughness = min( material.roughness, 1.0 );
#ifdef IOR
	#ifdef SPECULAR
		float specularIntensityFactor = specularIntensity;
		vec3 specularColorFactor = specularColor;
		#ifdef USE_SPECULARINTENSITYMAP
			specularIntensityFactor *= texture2D( specularIntensityMap, vUv ).a;
		#endif
		#ifdef USE_SPECULARCOLORMAP
			specularColorFactor *= specularColorMapTexelToLinear( texture2D( specularColorMap, vUv ) ).rgb;
		#endif
		material.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );
	#else
		float specularIntensityFactor = 1.0;
		vec3 specularColorFactor = vec3( 1.0 );
		material.specularF90 = 1.0;
	#endif
	material.specularColor = mix( min( pow2( ( ior - 1.0 ) / ( ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );
#else
	material.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );
	material.specularF90 = 1.0;
#endif
#ifdef USE_CLEARCOAT
	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	material.clearcoatF0 = vec3( 0.04 );
	material.clearcoatF90 = 1.0;
	#ifdef USE_CLEARCOATMAP
		material.clearcoat *= texture2D( clearcoatMap, vUv ).x;
	#endif
	#ifdef USE_CLEARCOAT_ROUGHNESSMAP
		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;
	#endif
	material.clearcoat = saturate( material.clearcoat );	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );
#endif
#ifdef USE_SHEEN
	material.sheenColor = sheenColor;
	#ifdef USE_SHEENCOLORMAP
		material.sheenColor *= sheenColorMapTexelToLinear( texture2D( sheenColorMap, vUv ) ).rgb;
	#endif
	material.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );
	#ifdef USE_SHEENROUGHNESSMAP
		material.sheenRoughness *= texture2D( sheenRoughnessMap, vUv ).a;
	#endif
#endif`,QZ=`struct PhysicalMaterial {
	vec3 diffuseColor;
	float roughness;
	vec3 specularColor;
	float specularF90;
	#ifdef USE_CLEARCOAT
		float clearcoat;
		float clearcoatRoughness;
		vec3 clearcoatF0;
		float clearcoatF90;
	#endif
	#ifdef USE_SHEEN
		vec3 sheenColor;
		float sheenRoughness;
	#endif
};
vec3 clearcoatSpecular = vec3( 0.0 );
vec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );
	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );
	vec4 r = roughness * c0 + c1;
	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;
	vec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;
	return fab;
}
vec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	return specularColor * fab.x + specularF90 * fab.y;
}
void computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	vec3 FssEss = specularColor * fab.x + specularF90 * fab.y;
	float Ess = fab.x + fab.y;
	float Ems = 1.0 - Ess;
	vec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );
	singleScatter += FssEss;
	multiScatter += Fms * Ems;
}
#if NUM_RECT_AREA_LIGHTS > 0
	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
		vec3 normal = geometry.normal;
		vec3 viewDir = geometry.viewDir;
		vec3 position = geometry.position;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.roughness;
		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight;		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;
		vec2 uv = LTC_Uv( normal, viewDir, roughness );
		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );
		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );
		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );
		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );
	}
#endif
void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometry.normal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifdef USE_CLEARCOAT
		float dotNLcc = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );
		vec3 ccIrradiance = dotNLcc * directLight.color;
		clearcoatSpecular += ccIrradiance * BRDF_GGX( directLight.direction, geometry.viewDir, geometry.clearcoatNormal, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );
	#endif
	#ifdef USE_SHEEN
		reflectedLight.directSpecular += irradiance * BRDF_Sheen( directLight.direction, geometry.viewDir, geometry.normal, material.sheenColor, material.sheenRoughness );
	#endif
	reflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularF90, material.roughness );
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
	#ifdef USE_CLEARCOAT
		clearcoatSpecular += clearcoatRadiance * EnvironmentBRDF( geometry.clearcoatNormal, geometry.viewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );
	#endif
	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
	computeMultiscattering( geometry.normal, geometry.viewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );
	vec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );
	reflectedLight.indirectSpecular += radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;
	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;
}
#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {
	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );
}`,eX=`
GeometricContext geometry;
geometry.position = - vViewPosition;
geometry.normal = normal;
geometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );
#ifdef USE_CLEARCOAT
	geometry.clearcoatNormal = clearcoatNormal;
#endif
IncidentLight directLight;
#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )
	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		pointLight = pointLights[ i ];
		getPointLightInfo( pointLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )
	SpotLight spotLight;
	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		spotLight = spotLights[ i ];
		getSpotLightInfo( spotLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		directionalLight = directionalLights[ i ];
		getDirectionalLightInfo( directionalLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )
	RectAreaLight rectAreaLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {
		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if defined( RE_IndirectDiffuse )
	vec3 iblIrradiance = vec3( 0.0 );
	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );
	irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
	#if ( NUM_HEMI_LIGHTS > 0 )
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry.normal );
		}
		#pragma unroll_loop_end
	#endif
#endif
#if defined( RE_IndirectSpecular )
	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );
#endif`,tX=`#if defined( RE_IndirectDiffuse )
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vUv2 );
		vec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
		#ifndef PHYSICALLY_CORRECT_LIGHTS
			lightMapIrradiance *= PI;
		#endif
		irradiance += lightMapIrradiance;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )
		iblIrradiance += getIBLIrradiance( geometry.normal );
	#endif
#endif
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
	radiance += getIBLRadiance( geometry.viewDir, geometry.normal, material.roughness );
	#ifdef USE_CLEARCOAT
		clearcoatRadiance += getIBLRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness );
	#endif
#endif`,iX=`#if defined( RE_IndirectDiffuse )
	RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );
#endif
#if defined( RE_IndirectSpecular )
	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );
#endif`,nX=`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	gl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;
#endif`,rX=`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,sX=`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		varying float vFragDepth;
		varying float vIsPerspective;
	#else
		uniform float logDepthBufFC;
	#endif
#endif`,oX=`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		vFragDepth = 1.0 + gl_Position.w;
		vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );
	#else
		if ( isPerspectiveMatrix( projectionMatrix ) ) {
			gl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;
			gl_Position.z *= gl_Position.w;
		}
	#endif
#endif`,aX=`#ifdef USE_MAP
	vec4 texelColor = texture2D( map, vUv );
	texelColor = mapTexelToLinear( texelColor );
	diffuseColor *= texelColor;
#endif`,lX=`#ifdef USE_MAP
	uniform sampler2D map;
#endif`,cX=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;
#endif
#ifdef USE_MAP
	vec4 mapTexel = texture2D( map, uv );
	diffuseColor *= mapTexelToLinear( mapTexel );
#endif
#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, uv ).g;
#endif`,uX=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	uniform mat3 uvTransform;
#endif
#ifdef USE_MAP
	uniform sampler2D map;
#endif
#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,hX=`float metalnessFactor = metalness;
#ifdef USE_METALNESSMAP
	vec4 texelMetalness = texture2D( metalnessMap, vUv );
	metalnessFactor *= texelMetalness.b;
#endif`,dX=`#ifdef USE_METALNESSMAP
	uniform sampler2D metalnessMap;
#endif`,fX=`#ifdef USE_MORPHNORMALS
	objectNormal *= morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
			if ( morphTargetInfluences[ i ] > 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1, 2 ) * morphTargetInfluences[ i ];
		}
	#else
		objectNormal += morphNormal0 * morphTargetInfluences[ 0 ];
		objectNormal += morphNormal1 * morphTargetInfluences[ 1 ];
		objectNormal += morphNormal2 * morphTargetInfluences[ 2 ];
		objectNormal += morphNormal3 * morphTargetInfluences[ 3 ];
	#endif
#endif`,pX=`#ifdef USE_MORPHTARGETS
	uniform float morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		uniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];
		uniform sampler2DArray morphTargetsTexture;
		uniform vec2 morphTargetsTextureSize;
		vec3 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset, const in int stride ) {
			float texelIndex = float( vertexIndex * stride + offset );
			float y = floor( texelIndex / morphTargetsTextureSize.x );
			float x = texelIndex - y * morphTargetsTextureSize.x;
			vec3 morphUV = vec3( ( x + 0.5 ) / morphTargetsTextureSize.x, y / morphTargetsTextureSize.y, morphTargetIndex );
			return texture( morphTargetsTexture, morphUV ).xyz;
		}
	#else
		#ifndef USE_MORPHNORMALS
			uniform float morphTargetInfluences[ 8 ];
		#else
			uniform float morphTargetInfluences[ 4 ];
		#endif
	#endif
#endif`,mX=`#ifdef USE_MORPHTARGETS
	transformed *= morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
			#ifndef USE_MORPHNORMALS
				if ( morphTargetInfluences[ i ] > 0.0 ) transformed += getMorph( gl_VertexID, i, 0, 1 ) * morphTargetInfluences[ i ];
			#else
				if ( morphTargetInfluences[ i ] > 0.0 ) transformed += getMorph( gl_VertexID, i, 0, 2 ) * morphTargetInfluences[ i ];
			#endif
		}
	#else
		transformed += morphTarget0 * morphTargetInfluences[ 0 ];
		transformed += morphTarget1 * morphTargetInfluences[ 1 ];
		transformed += morphTarget2 * morphTargetInfluences[ 2 ];
		transformed += morphTarget3 * morphTargetInfluences[ 3 ];
		#ifndef USE_MORPHNORMALS
			transformed += morphTarget4 * morphTargetInfluences[ 4 ];
			transformed += morphTarget5 * morphTargetInfluences[ 5 ];
			transformed += morphTarget6 * morphTargetInfluences[ 6 ];
			transformed += morphTarget7 * morphTargetInfluences[ 7 ];
		#endif
	#endif
#endif`,gX=`float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;
#ifdef FLAT_SHADED
	vec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );
	vec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );
	vec3 normal = normalize( cross( fdx, fdy ) );
#else
	vec3 normal = normalize( vNormal );
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	#ifdef USE_TANGENT
		vec3 tangent = normalize( vTangent );
		vec3 bitangent = normalize( vBitangent );
		#ifdef DOUBLE_SIDED
			tangent = tangent * faceDirection;
			bitangent = bitangent * faceDirection;
		#endif
		#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )
			mat3 vTBN = mat3( tangent, bitangent, normal );
		#endif
	#endif
#endif
vec3 geometryNormal = normal;`,_X=`#ifdef OBJECTSPACE_NORMALMAP
	normal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
	#ifdef FLIP_SIDED
		normal = - normal;
	#endif
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	normal = normalize( normalMatrix * normal );
#elif defined( TANGENTSPACE_NORMALMAP )
	vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;
	#ifdef USE_TANGENT
		normal = normalize( vTBN * mapN );
	#else
		normal = perturbNormal2Arb( - vViewPosition, normal, mapN, faceDirection );
	#endif
#elif defined( USE_BUMPMAP )
	normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );
#endif`,vX=`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,yX=`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,bX=`#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif`,xX=`#ifdef USE_NORMALMAP
	uniform sampler2D normalMap;
	uniform vec2 normalScale;
#endif
#ifdef OBJECTSPACE_NORMALMAP
	uniform mat3 normalMatrix;
#endif
#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )
	vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN, float faceDirection ) {
		vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );
		vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );
		vec2 st0 = dFdx( vUv.st );
		vec2 st1 = dFdy( vUv.st );
		vec3 N = surf_norm;
		vec3 q1perp = cross( q1, N );
		vec3 q0perp = cross( N, q0 );
		vec3 T = q1perp * st0.x + q0perp * st1.x;
		vec3 B = q1perp * st0.y + q0perp * st1.y;
		float det = max( dot( T, T ), dot( B, B ) );
		float scale = ( det == 0.0 ) ? 0.0 : faceDirection * inversesqrt( det );
		return normalize( T * ( mapN.x * scale ) + B * ( mapN.y * scale ) + N * mapN.z );
	}
#endif`,wX=`#ifdef USE_CLEARCOAT
	vec3 clearcoatNormal = geometryNormal;
#endif`,SX=`#ifdef USE_CLEARCOAT_NORMALMAP
	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;
	#ifdef USE_TANGENT
		clearcoatNormal = normalize( vTBN * clearcoatMapN );
	#else
		clearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN, faceDirection );
	#endif
#endif`,TX=`#ifdef USE_CLEARCOATMAP
	uniform sampler2D clearcoatMap;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform sampler2D clearcoatRoughnessMap;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;
#endif`,MX=`#ifdef OPAQUE
diffuseColor.a = 1.0;
#endif
#ifdef USE_TRANSMISSION
diffuseColor.a *= transmissionAlpha + 0.1;
#endif
gl_FragColor = vec4( outgoingLight, diffuseColor.a );`,CX=`vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}
vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}
const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;
const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );
const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );
const float ShiftRight8 = 1. / 256.;
vec4 packDepthToRGBA( const in float v ) {
	vec4 r = vec4( fract( v * PackFactors ), v );
	r.yzw -= r.xyz * ShiftRight8;	return r * PackUpscale;
}
float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors );
}
vec4 pack2HalfToRGBA( vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );
}
vec2 unpackRGBATo2Half( vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}
float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	return ( viewZ + near ) / ( near - far );
}
float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {
	return linearClipZ * ( near - far ) - near;
}
float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	return ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );
}
float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {
	return ( near * far ) / ( ( far - near ) * invClipZ - far );
}`,EX=`#ifdef PREMULTIPLIED_ALPHA
	gl_FragColor.rgb *= gl_FragColor.a;
#endif`,AX=`vec4 mvPosition = vec4( transformed, 1.0 );
#ifdef USE_INSTANCING
	mvPosition = instanceMatrix * mvPosition;
#endif
mvPosition = modelViewMatrix * mvPosition;
gl_Position = projectionMatrix * mvPosition;`,PX=`#ifdef DITHERING
	gl_FragColor.rgb = dithering( gl_FragColor.rgb );
#endif`,IX=`#ifdef DITHERING
	vec3 dithering( vec3 color ) {
		float grid_position = rand( gl_FragCoord.xy );
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );
		return color + dither_shift_RGB;
	}
#endif`,RX=`float roughnessFactor = roughness;
#ifdef USE_ROUGHNESSMAP
	vec4 texelRoughness = texture2D( roughnessMap, vUv );
	roughnessFactor *= texelRoughness.g;
#endif`,LX=`#ifdef USE_ROUGHNESSMAP
	uniform sampler2D roughnessMap;
#endif`,kX=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {
		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );
	}
	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {
		return unpackRGBATo2Half( texture2D( shadow, uv ) );
	}
	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){
		float occlusion = 1.0;
		vec2 distribution = texture2DDistribution( shadow, uv );
		float hard_shadow = step( compare , distribution.x );
		if (hard_shadow != 1.0 ) {
			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance );			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );
		}
		return occlusion;
	}
	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
		float shadow = 1.0;
		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;
		bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );
		bool inFrustum = all( inFrustumVec );
		bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );
		bool frustumTest = all( frustumTestVec );
		if ( frustumTest ) {
		#if defined( SHADOWMAP_TYPE_PCF )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;
			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );
		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;
			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;
			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), 
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
						  f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), 
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
						  f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );
		#elif defined( SHADOWMAP_TYPE_VSM )
			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );
		#else
			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );
		#endif
		}
		return shadow;
	}
	vec2 cubeToUV( vec3 v, float texelSizeY ) {
		vec3 absV = abs( v );
		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );
		vec2 planar = v.xy;
		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;
		if ( absV.z >= almostOne ) {
			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;
		} else if ( absV.x >= almostOne ) {
			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;
		} else if ( absV.y >= almostOne ) {
			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;
		}
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );
	}
	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );
		vec3 lightToPosition = shadowCoord.xyz;
		float dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );		dp += shadowBias;
		vec3 bd3D = normalize( lightToPosition );
		#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )
			vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;
			return (
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
			) * ( 1.0 / 9.0 );
		#else
			return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );
		#endif
	}
#endif`,DX=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];
		varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
#endif`,FX=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0
		vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		vec4 shadowWorldPosition;
	#endif
	#if NUM_DIR_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
		vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );
		vSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
		vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
#endif`,OX=`float getShadowMask() {
	float shadow = 1.0;
	#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#endif
	return shadow;
}`,zX=`#ifdef USE_SKINNING
	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );
#endif`,BX=`#ifdef USE_SKINNING
	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;
	#ifdef BONE_TEXTURE
		uniform highp sampler2D boneTexture;
		uniform int boneTextureSize;
		mat4 getBoneMatrix( const in float i ) {
			float j = i * 4.0;
			float x = mod( j, float( boneTextureSize ) );
			float y = floor( j / float( boneTextureSize ) );
			float dx = 1.0 / float( boneTextureSize );
			float dy = 1.0 / float( boneTextureSize );
			y = dy * ( y + 0.5 );
			vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );
			vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );
			vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );
			vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );
			mat4 bone = mat4( v1, v2, v3, v4 );
			return bone;
		}
	#else
		uniform mat4 boneMatrices[ MAX_BONES ];
		mat4 getBoneMatrix( const in float i ) {
			mat4 bone = boneMatrices[ int(i) ];
			return bone;
		}
	#endif
#endif`,NX=`#ifdef USE_SKINNING
	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );
	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;
	transformed = ( bindMatrixInverse * skinned ).xyz;
#endif`,$X=`#ifdef USE_SKINNING
	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;
	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;
	#ifdef USE_TANGENT
		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#endif
#endif`,VX=`float specularStrength;
#ifdef USE_SPECULARMAP
	vec4 texelSpecular = texture2D( specularMap, vUv );
	specularStrength = texelSpecular.r;
#else
	specularStrength = 1.0;
#endif`,UX=`#ifdef USE_SPECULARMAP
	uniform sampler2D specularMap;
#endif`,jX=`#if defined( TONE_MAPPING )
	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );
#endif`,GX=`#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
uniform float toneMappingExposure;
vec3 LinearToneMapping( vec3 color ) {
	return toneMappingExposure * color;
}
vec3 ReinhardToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );
}
vec3 OptimizedCineonToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );
}
vec3 RRTAndODTFit( vec3 v ) {
	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;
}
vec3 ACESFilmicToneMapping( vec3 color ) {
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ),		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);
	const mat3 ACESOutputMat = mat3(
		vec3(  1.60475, -0.10208, -0.00327 ),		vec3( -0.53108,  1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,  1.07602 )
	);
	color *= toneMappingExposure / 0.6;
	color = ACESInputMat * color;
	color = RRTAndODTFit( color );
	color = ACESOutputMat * color;
	return saturate( color );
}
vec3 CustomToneMapping( vec3 color ) { return color; }`,qX=`#ifdef USE_TRANSMISSION
	float transmissionAlpha = 1.0;
	float transmissionFactor = transmission;
	float thicknessFactor = thickness;
	#ifdef USE_TRANSMISSIONMAP
		transmissionFactor *= texture2D( transmissionMap, vUv ).r;
	#endif
	#ifdef USE_THICKNESSMAP
		thicknessFactor *= texture2D( thicknessMap, vUv ).g;
	#endif
	vec3 pos = vWorldPosition;
	vec3 v = normalize( cameraPosition - pos );
	vec3 n = inverseTransformDirection( normal, viewMatrix );
	vec4 transmission = getIBLVolumeRefraction(
		n, v, roughnessFactor, material.diffuseColor, material.specularColor, material.specularF90,
		pos, modelMatrix, viewMatrix, projectionMatrix, ior, thicknessFactor,
		attenuationColor, attenuationDistance );
	totalDiffuse = mix( totalDiffuse, transmission.rgb, transmissionFactor );
	transmissionAlpha = mix( transmissionAlpha, transmission.a, transmissionFactor );
#endif`,WX=`#ifdef USE_TRANSMISSION
	uniform float transmission;
	uniform float thickness;
	uniform float attenuationDistance;
	uniform vec3 attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		uniform sampler2D transmissionMap;
	#endif
	#ifdef USE_THICKNESSMAP
		uniform sampler2D thicknessMap;
	#endif
	uniform vec2 transmissionSamplerSize;
	uniform sampler2D transmissionSamplerMap;
	uniform mat4 modelMatrix;
	uniform mat4 projectionMatrix;
	varying vec3 vWorldPosition;
	vec3 getVolumeTransmissionRay( vec3 n, vec3 v, float thickness, float ior, mat4 modelMatrix ) {
		vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
		vec3 modelScale;
		modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
		modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
		modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
		return normalize( refractionVector ) * thickness * modelScale;
	}
	float applyIorToRoughness( float roughness, float ior ) {
		return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
	}
	vec4 getTransmissionSample( vec2 fragCoord, float roughness, float ior ) {
		float framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );
		#ifdef TEXTURE_LOD_EXT
			return texture2DLodEXT( transmissionSamplerMap, fragCoord.xy, framebufferLod );
		#else
			return texture2D( transmissionSamplerMap, fragCoord.xy, framebufferLod );
		#endif
	}
	vec3 applyVolumeAttenuation( vec3 radiance, float transmissionDistance, vec3 attenuationColor, float attenuationDistance ) {
		if ( attenuationDistance == 0.0 ) {
			return radiance;
		} else {
			vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
			vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );			return transmittance * radiance;
		}
	}
	vec4 getIBLVolumeRefraction( vec3 n, vec3 v, float roughness, vec3 diffuseColor, vec3 specularColor, float specularF90,
		vec3 position, mat4 modelMatrix, mat4 viewMatrix, mat4 projMatrix, float ior, float thickness,
		vec3 attenuationColor, float attenuationDistance ) {
		vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
		vec3 refractedRayExit = position + transmissionRay;
		vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
		vec2 refractionCoords = ndcPos.xy / ndcPos.w;
		refractionCoords += 1.0;
		refractionCoords /= 2.0;
		vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
		vec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );
		vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
		return vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );
	}
#endif`,HX=`#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )
	varying vec2 vUv;
#endif`,ZX=`#ifdef USE_UV
	#ifdef UVS_VERTEX_ONLY
		vec2 vUv;
	#else
		varying vec2 vUv;
	#endif
	uniform mat3 uvTransform;
#endif`,XX=`#ifdef USE_UV
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
#endif`,YX=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	varying vec2 vUv2;
#endif`,KX=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	attribute vec2 uv2;
	varying vec2 vUv2;
	uniform mat3 uv2Transform;
#endif`,JX=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	vUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;
#endif`,QX=`#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION )
	vec4 worldPosition = vec4( transformed, 1.0 );
	#ifdef USE_INSTANCING
		worldPosition = instanceMatrix * worldPosition;
	#endif
	worldPosition = modelMatrix * worldPosition;
#endif`;const eY=`varying vec2 vUv;
uniform mat3 uvTransform;
void main() {
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	gl_Position = vec4( position.xy, 1.0, 1.0 );
}`,tY=`uniform sampler2D t2D;
varying vec2 vUv;
void main() {
	vec4 texColor = texture2D( t2D, vUv );
	gl_FragColor = mapTexelToLinear( texColor );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,iY=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,nY=`#include <envmap_common_pars_fragment>
uniform float opacity;
varying vec3 vWorldDirection;
#include <cube_uv_reflection_fragment>
void main() {
	vec3 vReflect = vWorldDirection;
	#include <envmap_fragment>
	gl_FragColor = envColor;
	gl_FragColor.a *= opacity;
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,rY=`#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec2 vHighPrecisionZW;
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vHighPrecisionZW = gl_Position.zw;
}`,sY=`#if DEPTH_PACKING == 3200
	uniform float opacity;
#endif
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
varying vec2 vHighPrecisionZW;
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#if DEPTH_PACKING == 3200
		diffuseColor.a = opacity;
	#endif
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <logdepthbuf_fragment>
	float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;
	#if DEPTH_PACKING == 3200
		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );
	#elif DEPTH_PACKING == 3201
		gl_FragColor = packDepthToRGBA( fragCoordZ );
	#endif
}`,oY=`#define DISTANCE
varying vec3 vWorldPosition;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	vWorldPosition = worldPosition.xyz;
}`,aY=`#define DISTANCE
uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <clipping_planes_pars_fragment>
void main () {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist );
	gl_FragColor = packDepthToRGBA( dist );
}`,lY=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
}`,cY=`uniform sampler2D tEquirect;
varying vec3 vWorldDirection;
#include <common>
void main() {
	vec3 direction = normalize( vWorldDirection );
	vec2 sampleUV = equirectUv( direction );
	vec4 texColor = texture2D( tEquirect, sampleUV );
	gl_FragColor = mapTexelToLinear( texColor );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,uY=`uniform float scale;
attribute float lineDistance;
varying float vLineDistance;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	vLineDistance = scale * lineDistance;
	#include <color_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,hY=`uniform vec3 diffuse;
uniform float opacity;
uniform float dashSize;
uniform float totalSize;
varying float vLineDistance;
#include <common>
#include <color_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	if ( mod( vLineDistance, totalSize ) > dashSize ) {
		discard;
	}
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <color_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,dY=`#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>
}`,fY=`uniform vec3 diffuse;
uniform float opacity;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel= texture2D( lightMap, vUv2 );
		reflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
	#else
		reflectedLight.indirectDiffuse += vec3( 1.0 );
	#endif
	#include <aomap_fragment>
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	#include <envmap_fragment>
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,pY=`#define LAMBERT
varying vec3 vLightFront;
varying vec3 vIndirectFront;
#ifdef DOUBLE_SIDED
	varying vec3 vLightBack;
	varying vec3 vIndirectBack;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <envmap_pars_vertex>
#include <bsdfs>
#include <lights_pars_begin>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <lights_lambert_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,mY=`uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
varying vec3 vLightFront;
varying vec3 vIndirectFront;
#ifdef DOUBLE_SIDED
	varying vec3 vLightBack;
	varying vec3 vIndirectBack;
#endif
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <fog_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	#include <emissivemap_fragment>
	#ifdef DOUBLE_SIDED
		reflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;
	#else
		reflectedLight.indirectDiffuse += vIndirectFront;
	#endif
	#include <lightmap_fragment>
	reflectedLight.indirectDiffuse *= BRDF_Lambert( diffuseColor.rgb );
	#ifdef DOUBLE_SIDED
		reflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;
	#else
		reflectedLight.directDiffuse = vLightFront;
	#endif
	reflectedLight.directDiffuse *= BRDF_Lambert( diffuseColor.rgb ) * getShadowMask();
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,gY=`#define MATCAP
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
	vViewPosition = - mvPosition.xyz;
}`,_Y=`#define MATCAP
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;
varying vec3 vViewPosition;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <fog_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;
	#ifdef USE_MATCAP
		vec4 matcapColor = texture2D( matcap, uv );
		matcapColor = matcapTexelToLinear( matcapColor );
	#else
		vec4 matcapColor = vec4( 1.0 );
	#endif
	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,vY=`#define NORMAL
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	varying vec3 vViewPosition;
#endif
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	vViewPosition = - mvPosition.xyz;
#endif
}`,yY=`#define NORMAL
uniform float opacity;
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	varying vec3 vViewPosition;
#endif
#include <packing>
#include <uv_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	gl_FragColor = vec4( packNormalToRGB( normal ), opacity );
}`,bY=`#define PHONG
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,xY=`#define PHONG
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,wY=`#define STANDARD
varying vec3 vViewPosition;
#ifdef USE_TRANSMISSION
	varying vec3 vWorldPosition;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
#ifdef USE_TRANSMISSION
	vWorldPosition = worldPosition.xyz;
#endif
}`,SY=`#define STANDARD
#ifdef PHYSICAL
	#define IOR
	#define SPECULAR
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef IOR
	uniform float ior;
#endif
#ifdef SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularColor;
	#ifdef USE_SPECULARINTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
	#ifdef USE_SPECULARCOLORMAP
		uniform sampler2D specularColorMap;
	#endif
#endif
#ifdef USE_CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif
#ifdef USE_SHEEN
	uniform vec3 sheenColor;
	uniform float sheenRoughness;
	#ifdef USE_SHEENCOLORMAP
		uniform sampler2D sheenColorMap;
	#endif
	#ifdef USE_SHEENROUGHNESSMAP
		uniform sampler2D sheenRoughnessMap;
	#endif
#endif
varying vec3 vViewPosition;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <bsdfs>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;
	#include <transmission_fragment>
	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
	#ifdef USE_CLEARCOAT
		float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );
		vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );
		outgoingLight = outgoingLight * ( 1.0 - clearcoat * Fcc ) + clearcoatSpecular * clearcoat;
	#endif
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,TY=`#define TOON
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,MY=`#define TOON
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,CY=`uniform float size;
uniform float scale;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <color_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	gl_PointSize = size;
	#ifdef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );
	#endif
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>
}`,EY=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <alphatest_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,AY=`#include <common>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
void main() {
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,PY=`uniform vec3 color;
uniform float opacity;
#include <common>
#include <packing>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
void main() {
	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
}`,IY=`uniform float rotation;
uniform vec2 center;
#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec2 scale;
	scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
	scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );
	#ifndef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) scale *= - mvPosition.z;
	#endif
	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;
	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
	mvPosition.xy += rotatedPosition;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,RY=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <output_fragment>
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
}`,Cn={alphamap_fragment:oZ,alphamap_pars_fragment:aZ,alphatest_fragment:lZ,alphatest_pars_fragment:cZ,aomap_fragment:uZ,aomap_pars_fragment:hZ,begin_vertex:dZ,beginnormal_vertex:fZ,bsdfs:pZ,bumpmap_pars_fragment:mZ,clipping_planes_fragment:gZ,clipping_planes_pars_fragment:_Z,clipping_planes_pars_vertex:vZ,clipping_planes_vertex:yZ,color_fragment:bZ,color_pars_fragment:xZ,color_pars_vertex:wZ,color_vertex:SZ,common:TZ,cube_uv_reflection_fragment:MZ,defaultnormal_vertex:CZ,displacementmap_pars_vertex:EZ,displacementmap_vertex:AZ,emissivemap_fragment:PZ,emissivemap_pars_fragment:IZ,encodings_fragment:RZ,encodings_pars_fragment:LZ,envmap_fragment:kZ,envmap_common_pars_fragment:DZ,envmap_pars_fragment:FZ,envmap_pars_vertex:OZ,envmap_physical_pars_fragment:HZ,envmap_vertex:zZ,fog_vertex:BZ,fog_pars_vertex:NZ,fog_fragment:$Z,fog_pars_fragment:VZ,gradientmap_pars_fragment:UZ,lightmap_fragment:jZ,lightmap_pars_fragment:GZ,lights_lambert_vertex:qZ,lights_pars_begin:WZ,lights_toon_fragment:ZZ,lights_toon_pars_fragment:XZ,lights_phong_fragment:YZ,lights_phong_pars_fragment:KZ,lights_physical_fragment:JZ,lights_physical_pars_fragment:QZ,lights_fragment_begin:eX,lights_fragment_maps:tX,lights_fragment_end:iX,logdepthbuf_fragment:nX,logdepthbuf_pars_fragment:rX,logdepthbuf_pars_vertex:sX,logdepthbuf_vertex:oX,map_fragment:aX,map_pars_fragment:lX,map_particle_fragment:cX,map_particle_pars_fragment:uX,metalnessmap_fragment:hX,metalnessmap_pars_fragment:dX,morphnormal_vertex:fX,morphtarget_pars_vertex:pX,morphtarget_vertex:mX,normal_fragment_begin:gX,normal_fragment_maps:_X,normal_pars_fragment:vX,normal_pars_vertex:yX,normal_vertex:bX,normalmap_pars_fragment:xX,clearcoat_normal_fragment_begin:wX,clearcoat_normal_fragment_maps:SX,clearcoat_pars_fragment:TX,output_fragment:MX,packing:CX,premultiplied_alpha_fragment:EX,project_vertex:AX,dithering_fragment:PX,dithering_pars_fragment:IX,roughnessmap_fragment:RX,roughnessmap_pars_fragment:LX,shadowmap_pars_fragment:kX,shadowmap_pars_vertex:DX,shadowmap_vertex:FX,shadowmask_pars_fragment:OX,skinbase_vertex:zX,skinning_pars_vertex:BX,skinning_vertex:NX,skinnormal_vertex:$X,specularmap_fragment:VX,specularmap_pars_fragment:UX,tonemapping_fragment:jX,tonemapping_pars_fragment:GX,transmission_fragment:qX,transmission_pars_fragment:WX,uv_pars_fragment:HX,uv_pars_vertex:ZX,uv_vertex:XX,uv2_pars_fragment:YX,uv2_pars_vertex:KX,uv2_vertex:JX,worldpos_vertex:QX,background_vert:eY,background_frag:tY,cube_vert:iY,cube_frag:nY,depth_vert:rY,depth_frag:sY,distanceRGBA_vert:oY,distanceRGBA_frag:aY,equirect_vert:lY,equirect_frag:cY,linedashed_vert:uY,linedashed_frag:hY,meshbasic_vert:dY,meshbasic_frag:fY,meshlambert_vert:pY,meshlambert_frag:mY,meshmatcap_vert:gY,meshmatcap_frag:_Y,meshnormal_vert:vY,meshnormal_frag:yY,meshphong_vert:bY,meshphong_frag:xY,meshphysical_vert:wY,meshphysical_frag:SY,meshtoon_vert:TY,meshtoon_frag:MY,points_vert:CY,points_frag:EY,shadow_vert:AY,shadow_frag:PY,sprite_vert:IY,sprite_frag:RY},xi={common:{diffuse:{value:new $i(16777215)},opacity:{value:1},map:{value:null},uvTransform:{value:new vo},uv2Transform:{value:new vo},alphaMap:{value:null},alphaTest:{value:0}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new li(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new $i(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new $i(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new vo}},sprite:{diffuse:{value:new $i(16777215)},opacity:{value:1},center:{value:new li(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new vo}}},ru={basic:{uniforms:Io([xi.common,xi.specularmap,xi.envmap,xi.aomap,xi.lightmap,xi.fog]),vertexShader:Cn.meshbasic_vert,fragmentShader:Cn.meshbasic_frag},lambert:{uniforms:Io([xi.common,xi.specularmap,xi.envmap,xi.aomap,xi.lightmap,xi.emissivemap,xi.fog,xi.lights,{emissive:{value:new $i(0)}}]),vertexShader:Cn.meshlambert_vert,fragmentShader:Cn.meshlambert_frag},phong:{uniforms:Io([xi.common,xi.specularmap,xi.envmap,xi.aomap,xi.lightmap,xi.emissivemap,xi.bumpmap,xi.normalmap,xi.displacementmap,xi.fog,xi.lights,{emissive:{value:new $i(0)},specular:{value:new $i(1118481)},shininess:{value:30}}]),vertexShader:Cn.meshphong_vert,fragmentShader:Cn.meshphong_frag},standard:{uniforms:Io([xi.common,xi.envmap,xi.aomap,xi.lightmap,xi.emissivemap,xi.bumpmap,xi.normalmap,xi.displacementmap,xi.roughnessmap,xi.metalnessmap,xi.fog,xi.lights,{emissive:{value:new $i(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Cn.meshphysical_vert,fragmentShader:Cn.meshphysical_frag},toon:{uniforms:Io([xi.common,xi.aomap,xi.lightmap,xi.emissivemap,xi.bumpmap,xi.normalmap,xi.displacementmap,xi.gradientmap,xi.fog,xi.lights,{emissive:{value:new $i(0)}}]),vertexShader:Cn.meshtoon_vert,fragmentShader:Cn.meshtoon_frag},matcap:{uniforms:Io([xi.common,xi.bumpmap,xi.normalmap,xi.displacementmap,xi.fog,{matcap:{value:null}}]),vertexShader:Cn.meshmatcap_vert,fragmentShader:Cn.meshmatcap_frag},points:{uniforms:Io([xi.points,xi.fog]),vertexShader:Cn.points_vert,fragmentShader:Cn.points_frag},dashed:{uniforms:Io([xi.common,xi.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Cn.linedashed_vert,fragmentShader:Cn.linedashed_frag},depth:{uniforms:Io([xi.common,xi.displacementmap]),vertexShader:Cn.depth_vert,fragmentShader:Cn.depth_frag},normal:{uniforms:Io([xi.common,xi.bumpmap,xi.normalmap,xi.displacementmap,{opacity:{value:1}}]),vertexShader:Cn.meshnormal_vert,fragmentShader:Cn.meshnormal_frag},sprite:{uniforms:Io([xi.sprite,xi.fog]),vertexShader:Cn.sprite_vert,fragmentShader:Cn.sprite_frag},background:{uniforms:{uvTransform:{value:new vo},t2D:{value:null}},vertexShader:Cn.background_vert,fragmentShader:Cn.background_frag},cube:{uniforms:Io([xi.envmap,{opacity:{value:1}}]),vertexShader:Cn.cube_vert,fragmentShader:Cn.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Cn.equirect_vert,fragmentShader:Cn.equirect_frag},distanceRGBA:{uniforms:Io([xi.common,xi.displacementmap,{referencePosition:{value:new Ge},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Cn.distanceRGBA_vert,fragmentShader:Cn.distanceRGBA_frag},shadow:{uniforms:Io([xi.lights,xi.fog,{color:{value:new $i(0)},opacity:{value:1}}]),vertexShader:Cn.shadow_vert,fragmentShader:Cn.shadow_frag}};ru.physical={uniforms:Io([ru.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new li(1,1)},clearcoatNormalMap:{value:null},sheen:{value:0},sheenColor:{value:new $i(0)},sheenColorMap:{value:null},sheenRoughness:{value:0},sheenRoughnessMap:{value:null},transmission:{value:0},transmissionMap:{value:null},transmissionSamplerSize:{value:new li},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:0},attenuationColor:{value:new $i(0)},specularIntensity:{value:0},specularIntensityMap:{value:null},specularColor:{value:new $i(1,1,1)},specularColorMap:{value:null}}]),vertexShader:Cn.meshphysical_vert,fragmentShader:Cn.meshphysical_frag};function LY(n,e,t,i,r){const o=new $i(0);let c=0,s,d,p=null,g=0,_=null;function x(S,P){let L=!1,E=P.isScene===!0?P.background:null;E&&E.isTexture&&(E=e.get(E));const C=n.xr,D=C.getSession&&C.getSession();D&&D.environmentBlendMode==="additive"&&(E=null),E===null?b(o,c):E&&E.isColor&&(b(E,1),L=!0),(n.autoClear||L)&&n.clear(n.autoClearColor,n.autoClearDepth,n.autoClearStencil),E&&(E.isCubeTexture||E.mapping===h1)?(d===void 0&&(d=new kr(new _0(1,1,1),new ta({name:"BackgroundCubeMaterial",uniforms:Xg(ru.cube.uniforms),vertexShader:ru.cube.vertexShader,fragmentShader:ru.cube.fragmentShader,side:Gs,depthTest:!1,depthWrite:!1,fog:!1})),d.geometry.deleteAttribute("normal"),d.geometry.deleteAttribute("uv"),d.onBeforeRender=function(O,U,j){this.matrixWorld.copyPosition(j.matrixWorld)},Object.defineProperty(d.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),i.update(d)),d.material.uniforms.envMap.value=E,d.material.uniforms.flipEnvMap.value=E.isCubeTexture&&E.isRenderTargetTexture===!1?-1:1,(p!==E||g!==E.version||_!==n.toneMapping)&&(d.material.needsUpdate=!0,p=E,g=E.version,_=n.toneMapping),S.unshift(d,d.geometry,d.material,0,0,null)):E&&E.isTexture&&(s===void 0&&(s=new kr(new g1(2,2),new ta({name:"BackgroundMaterial",uniforms:Xg(ru.background.uniforms),vertexShader:ru.background.vertexShader,fragmentShader:ru.background.fragmentShader,side:Hg,depthTest:!1,depthWrite:!1,fog:!1})),s.geometry.deleteAttribute("normal"),Object.defineProperty(s.material,"map",{get:function(){return this.uniforms.t2D.value}}),i.update(s)),s.material.uniforms.t2D.value=E,E.matrixAutoUpdate===!0&&E.updateMatrix(),s.material.uniforms.uvTransform.value.copy(E.matrix),(p!==E||g!==E.version||_!==n.toneMapping)&&(s.material.needsUpdate=!0,p=E,g=E.version,_=n.toneMapping),S.unshift(s,s.geometry,s.material,0,0,null))}function b(S,P){t.buffers.color.setClear(S.r,S.g,S.b,P,r)}return{getClearColor:function(){return o},setClearColor:function(S,P=1){o.set(S),c=P,b(o,c)},getClearAlpha:function(){return c},setClearAlpha:function(S){c=S,b(o,c)},render:x}}function kY(n,e,t,i){const r=n.getParameter(34921),o=i.isWebGL2?null:e.get("OES_vertex_array_object"),c=i.isWebGL2||o!==null,s={},d=P(null);let p=d;function g(X,re,oe,de,ce){let Se=!1;if(c){const Pe=S(de,oe,re);p!==Pe&&(p=Pe,x(p.object)),Se=L(de,ce),Se&&E(de,ce)}else{const Pe=re.wireframe===!0;(p.geometry!==de.id||p.program!==oe.id||p.wireframe!==Pe)&&(p.geometry=de.id,p.program=oe.id,p.wireframe=Pe,Se=!0)}X.isInstancedMesh===!0&&(Se=!0),ce!==null&&t.update(ce,34963),Se&&(G(X,re,oe,de),ce!==null&&n.bindBuffer(34963,t.get(ce).buffer))}function _(){return i.isWebGL2?n.createVertexArray():o.createVertexArrayOES()}function x(X){return i.isWebGL2?n.bindVertexArray(X):o.bindVertexArrayOES(X)}function b(X){return i.isWebGL2?n.deleteVertexArray(X):o.deleteVertexArrayOES(X)}function S(X,re,oe){const de=oe.wireframe===!0;let ce=s[X.id];ce===void 0&&(ce={},s[X.id]=ce);let Se=ce[re.id];Se===void 0&&(Se={},ce[re.id]=Se);let Pe=Se[de];return Pe===void 0&&(Pe=P(_()),Se[de]=Pe),Pe}function P(X){const re=[],oe=[],de=[];for(let ce=0;ce<r;ce++)re[ce]=0,oe[ce]=0,de[ce]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:re,enabledAttributes:oe,attributeDivisors:de,object:X,attributes:{},index:null}}function L(X,re){const oe=p.attributes,de=X.attributes;let ce=0;for(const Se in de){const Pe=oe[Se],je=de[Se];if(Pe===void 0||Pe.attribute!==je||Pe.data!==je.data)return!0;ce++}return p.attributesNum!==ce||p.index!==re}function E(X,re){const oe={},de=X.attributes;let ce=0;for(const Se in de){const Pe=de[Se],je={};je.attribute=Pe,Pe.data&&(je.data=Pe.data),oe[Se]=je,ce++}p.attributes=oe,p.attributesNum=ce,p.index=re}function C(){const X=p.newAttributes;for(let re=0,oe=X.length;re<oe;re++)X[re]=0}function D(X){O(X,0)}function O(X,re){const oe=p.newAttributes,de=p.enabledAttributes,ce=p.attributeDivisors;oe[X]=1,de[X]===0&&(n.enableVertexAttribArray(X),de[X]=1),ce[X]!==re&&((i.isWebGL2?n:e.get("ANGLE_instanced_arrays"))[i.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](X,re),ce[X]=re)}function U(){const X=p.newAttributes,re=p.enabledAttributes;for(let oe=0,de=re.length;oe<de;oe++)re[oe]!==X[oe]&&(n.disableVertexAttribArray(oe),re[oe]=0)}function j(X,re,oe,de,ce,Se){i.isWebGL2===!0&&(oe===5124||oe===5125)?n.vertexAttribIPointer(X,re,oe,ce,Se):n.vertexAttribPointer(X,re,oe,de,ce,Se)}function G(X,re,oe,de){if(i.isWebGL2===!1&&(X.isInstancedMesh||de.isInstancedBufferGeometry)&&e.get("ANGLE_instanced_arrays")===null)return;C();const ce=de.attributes,Se=oe.getAttributes(),Pe=re.defaultAttributeValues;for(const je in Se){const Fe=Se[je];if(Fe.location>=0){let qe=ce[je];if(qe===void 0&&(je==="instanceMatrix"&&X.instanceMatrix&&(qe=X.instanceMatrix),je==="instanceColor"&&X.instanceColor&&(qe=X.instanceColor)),qe!==void 0){const Ue=qe.normalized,ke=qe.itemSize,et=t.get(qe);if(et===void 0)continue;const ye=et.buffer,Be=et.type,Je=et.bytesPerElement;if(qe.isInterleavedBufferAttribute){const ct=qe.data,yt=ct.stride,we=qe.offset;if(ct&&ct.isInstancedInterleavedBuffer){for(let fe=0;fe<Fe.locationSize;fe++)O(Fe.location+fe,ct.meshPerAttribute);X.isInstancedMesh!==!0&&de._maxInstanceCount===void 0&&(de._maxInstanceCount=ct.meshPerAttribute*ct.count)}else for(let fe=0;fe<Fe.locationSize;fe++)D(Fe.location+fe);n.bindBuffer(34962,ye);for(let fe=0;fe<Fe.locationSize;fe++)j(Fe.location+fe,ke/Fe.locationSize,Be,Ue,yt*Je,(we+ke/Fe.locationSize*fe)*Je)}else{if(qe.isInstancedBufferAttribute){for(let ct=0;ct<Fe.locationSize;ct++)O(Fe.location+ct,qe.meshPerAttribute);X.isInstancedMesh!==!0&&de._maxInstanceCount===void 0&&(de._maxInstanceCount=qe.meshPerAttribute*qe.count)}else for(let ct=0;ct<Fe.locationSize;ct++)D(Fe.location+ct);n.bindBuffer(34962,ye);for(let ct=0;ct<Fe.locationSize;ct++)j(Fe.location+ct,ke/Fe.locationSize,Be,Ue,ke*Je,ke/Fe.locationSize*ct*Je)}}else if(Pe!==void 0){const Ue=Pe[je];if(Ue!==void 0)switch(Ue.length){case 2:n.vertexAttrib2fv(Fe.location,Ue);break;case 3:n.vertexAttrib3fv(Fe.location,Ue);break;case 4:n.vertexAttrib4fv(Fe.location,Ue);break;default:n.vertexAttrib1fv(Fe.location,Ue)}}}}U()}function N(){z();for(const X in s){const re=s[X];for(const oe in re){const de=re[oe];for(const ce in de)b(de[ce].object),delete de[ce];delete re[oe]}delete s[X]}}function V(X){if(s[X.id]===void 0)return;const re=s[X.id];for(const oe in re){const de=re[oe];for(const ce in de)b(de[ce].object),delete de[ce];delete re[oe]}delete s[X.id]}function q(X){for(const re in s){const oe=s[re];if(oe[X.id]===void 0)continue;const de=oe[X.id];for(const ce in de)b(de[ce].object),delete de[ce];delete oe[X.id]}}function z(){Q(),p!==d&&(p=d,x(p.object))}function Q(){d.geometry=null,d.program=null,d.wireframe=!1}return{setup:g,reset:z,resetDefaultState:Q,dispose:N,releaseStatesOfGeometry:V,releaseStatesOfProgram:q,initAttributes:C,enableAttribute:D,disableUnusedAttributes:U}}function DY(n,e,t,i){const r=i.isWebGL2;let o;function c(p){o=p}function s(p,g){n.drawArrays(o,p,g),t.update(g,o,1)}function d(p,g,_){if(_===0)return;let x,b;if(r)x=n,b="drawArraysInstanced";else if(x=e.get("ANGLE_instanced_arrays"),b="drawArraysInstancedANGLE",x===null){console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");return}x[b](o,p,g,_),t.update(g,o,_)}this.setMode=c,this.render=s,this.renderInstances=d}function FY(n,e,t){let i;function r(){if(i!==void 0)return i;if(e.has("EXT_texture_filter_anisotropic")===!0){const G=e.get("EXT_texture_filter_anisotropic");i=n.getParameter(G.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else i=0;return i}function o(G){if(G==="highp"){if(n.getShaderPrecisionFormat(35633,36338).precision>0&&n.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";G="mediump"}return G==="mediump"&&n.getShaderPrecisionFormat(35633,36337).precision>0&&n.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const c=typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext||typeof WebGL2ComputeRenderingContext<"u"&&n instanceof WebGL2ComputeRenderingContext;let s=t.precision!==void 0?t.precision:"highp";const d=o(s);d!==s&&(console.warn("THREE.WebGLRenderer:",s,"not supported, using",d,"instead."),s=d);const p=c||e.has("WEBGL_draw_buffers"),g=t.logarithmicDepthBuffer===!0,_=n.getParameter(34930),x=n.getParameter(35660),b=n.getParameter(3379),S=n.getParameter(34076),P=n.getParameter(34921),L=n.getParameter(36347),E=n.getParameter(36348),C=n.getParameter(36349),D=x>0,O=c||e.has("OES_texture_float"),U=D&&O,j=c?n.getParameter(36183):0;return{isWebGL2:c,drawBuffers:p,getMaxAnisotropy:r,getMaxPrecision:o,precision:s,logarithmicDepthBuffer:g,maxTextures:_,maxVertexTextures:x,maxTextureSize:b,maxCubemapSize:S,maxAttributes:P,maxVertexUniforms:L,maxVaryings:E,maxFragmentUniforms:C,vertexTextures:D,floatFragmentTextures:O,floatVertexTextures:U,maxSamples:j}}function OY(n){const e=this;let t=null,i=0,r=!1,o=!1;const c=new dh,s=new vo,d={value:null,needsUpdate:!1};this.uniform=d,this.numPlanes=0,this.numIntersection=0,this.init=function(_,x,b){const S=_.length!==0||x||i!==0||r;return r=x,t=g(_,b,0),i=_.length,S},this.beginShadows=function(){o=!0,g(null)},this.endShadows=function(){o=!1,p()},this.setState=function(_,x,b){const S=_.clippingPlanes,P=_.clipIntersection,L=_.clipShadows,E=n.get(_);if(!r||S===null||S.length===0||o&&!L)o?g(null):p();else{const C=o?0:i,D=C*4;let O=E.clippingState||null;d.value=O,O=g(S,x,D,b);for(let U=0;U!==D;++U)O[U]=t[U];E.clippingState=O,this.numIntersection=P?this.numPlanes:0,this.numPlanes+=C}};function p(){d.value!==t&&(d.value=t,d.needsUpdate=i>0),e.numPlanes=i,e.numIntersection=0}function g(_,x,b,S){const P=_!==null?_.length:0;let L=null;if(P!==0){if(L=d.value,S!==!0||L===null){const E=b+P*4,C=x.matrixWorldInverse;s.getNormalMatrix(C),(L===null||L.length<E)&&(L=new Float32Array(E));for(let D=0,O=b;D!==P;++D,O+=4)c.copy(_[D]).applyMatrix4(C,s),c.normal.toArray(L,O),L[O+3]=c.constant}d.value=L,d.needsUpdate=!0}return e.numPlanes=P,e.numIntersection=0,L}}function zY(n){let e=new WeakMap;function t(c,s){return s===a2?c.mapping=p0:s===l2&&(c.mapping=m0),c}function i(c){if(c&&c.isTexture&&c.isRenderTargetTexture===!1){const s=c.mapping;if(s===a2||s===l2)if(e.has(c)){const d=e.get(c).texture;return t(d,c.mapping)}else{const d=c.image;if(d&&d.height>0){const p=n.getRenderTarget(),g=new hz(d.height/2);return g.fromEquirectangularTexture(n,c),e.set(c,g),n.setRenderTarget(p),c.addEventListener("dispose",r),t(g.texture,c.mapping)}else return null}}return c}function r(c){const s=c.target;s.removeEventListener("dispose",r);const d=e.get(s);d!==void 0&&(e.delete(s),d.dispose())}function o(){e=new WeakMap}return{get:i,dispose:o}}class _1 extends v0{constructor(e=-1,t=1,i=1,r=-1,o=.1,c=2e3){super(),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=r,this.near=o,this.far=c,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=e.view===null?null:Object.assign({},e.view),this}setViewOffset(e,t,i,r,o,c){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=r,this.view.width=o,this.view.height=c,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,r=(this.top+this.bottom)/2;let o=i-e,c=i+e,s=r+t,d=r-t;if(this.view!==null&&this.view.enabled){const p=(this.right-this.left)/this.view.fullWidth/this.zoom,g=(this.top-this.bottom)/this.view.fullHeight/this.zoom;o+=p*this.view.offsetX,c=o+p*this.view.width,s-=g*this.view.offsetY,d=s-g*this.view.height}this.projectionMatrix.makeOrthographic(o,c,s,d,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,this.view!==null&&(t.object.view=Object.assign({},this.view)),t}}_1.prototype.isOrthographicCamera=!0;class v1 extends ta{constructor(e){super(e),this.type="RawShaderMaterial"}}v1.prototype.isRawShaderMaterial=!0;const Lg=4,Ld=8,tu=Math.pow(2,Ld),fz=[.125,.215,.35,.446,.526,.582],pz=Ld-Lg+1+fz.length,eg=20,Vd={[Bo]:0,[Tp]:1,[OC]:2,[tz]:3,[iz]:4,[nz]:5,[FC]:6},JT=new _1,{_lodPlanes:Rv,_sizeLods:uL,_sigmas:sx}=$Y(),hL=new $i;let QT=null;const Xf=(1+Math.sqrt(5))/2,tg=1/Xf,dL=[new Ge(1,1,1),new Ge(-1,1,1),new Ge(1,1,-1),new Ge(-1,1,-1),new Ge(0,Xf,tg),new Ge(0,Xf,-tg),new Ge(tg,0,Xf),new Ge(-tg,0,Xf),new Ge(Xf,tg,0),new Ge(-Xf,tg,0)];class BY{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._blurMaterial=VY(eg),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,i=.1,r=100){QT=this._renderer.getRenderTarget();const o=this._allocateTargets();return this._sceneToCubeUV(e,i,r,o),t>0&&this._blur(o,0,0,t),this._applyPMREM(o),this._cleanup(o),o}fromEquirectangular(e){return this._fromTexture(e)}fromCubemap(e){return this._fromTexture(e)}compileCubemapShader(){this._cubemapShader===null&&(this._cubemapShader=mL(),this._compileMaterial(this._cubemapShader))}compileEquirectangularShader(){this._equirectShader===null&&(this._equirectShader=pL(),this._compileMaterial(this._equirectShader))}dispose(){this._blurMaterial.dispose(),this._cubemapShader!==null&&this._cubemapShader.dispose(),this._equirectShader!==null&&this._equirectShader.dispose();for(let e=0;e<Rv.length;e++)Rv[e].dispose()}_cleanup(e){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(QT),e.scissorTest=!1,ox(e,0,0,e.width,e.height)}_fromTexture(e){QT=this._renderer.getRenderTarget();const t=this._allocateTargets(e);return this._textureToCubeUV(e,t),this._applyPMREM(t),this._cleanup(t),t}_allocateTargets(e){const t={magFilter:Hs,minFilter:Hs,generateMipmaps:!1,type:$d,format:DH,encoding:NY(e)?e.encoding:OC,depthBuffer:!1},i=fL(t);return i.depthBuffer=!e,this._pingPongRenderTarget=fL(t),i}_compileMaterial(e){const t=new kr(Rv[0],e);this._renderer.compile(t,JT)}_sceneToCubeUV(e,t,i,r){const s=new na(90,1,t,i),d=[1,-1,1,1,1,1],p=[1,1,1,-1,-1,-1],g=this._renderer,_=g.autoClear,x=g.outputEncoding,b=g.toneMapping;g.getClearColor(hL),g.toneMapping=cp,g.outputEncoding=Bo,g.autoClear=!1;const S=new g0({name:"PMREM.Background",side:Gs,depthWrite:!1,depthTest:!1}),P=new kr(new _0,S);let L=!1;const E=e.background;E?E.isColor&&(S.color.copy(E),e.background=null,L=!0):(S.color.copy(hL),L=!0);for(let C=0;C<6;C++){const D=C%3;D==0?(s.up.set(0,d[C],0),s.lookAt(p[C],0,0)):D==1?(s.up.set(0,0,d[C]),s.lookAt(0,p[C],0)):(s.up.set(0,d[C],0),s.lookAt(0,0,p[C])),ox(r,D*tu,C>2?tu:0,tu,tu),g.setRenderTarget(r),L&&g.render(P,s),g.render(e,s)}P.geometry.dispose(),P.material.dispose(),g.toneMapping=b,g.outputEncoding=x,g.autoClear=_,e.background=E}_setEncoding(e,t){this._renderer.capabilities.isWebGL2===!0&&t.format===ca&&t.type===$d&&t.encoding===Tp?e.value=Vd[Bo]:e.value=Vd[t.encoding]}_textureToCubeUV(e,t){const i=this._renderer,r=e.mapping===p0||e.mapping===m0;r?this._cubemapShader==null&&(this._cubemapShader=mL()):this._equirectShader==null&&(this._equirectShader=pL());const o=r?this._cubemapShader:this._equirectShader,c=new kr(Rv[0],o),s=o.uniforms;s.envMap.value=e,r||s.texelSize.value.set(1/e.image.width,1/e.image.height),this._setEncoding(s.inputEncoding,e),this._setEncoding(s.outputEncoding,t.texture),ox(t,0,0,3*tu,2*tu),i.setRenderTarget(t),i.render(c,JT)}_applyPMREM(e){const t=this._renderer,i=t.autoClear;t.autoClear=!1;for(let r=1;r<pz;r++){const o=Math.sqrt(sx[r]*sx[r]-sx[r-1]*sx[r-1]),c=dL[(r-1)%dL.length];this._blur(e,r-1,r,o,c)}t.autoClear=i}_blur(e,t,i,r,o){const c=this._pingPongRenderTarget;this._halfBlur(e,c,t,i,r,"latitudinal",o),this._halfBlur(c,e,i,i,r,"longitudinal",o)}_halfBlur(e,t,i,r,o,c,s){const d=this._renderer,p=this._blurMaterial;c!=="latitudinal"&&c!=="longitudinal"&&console.error("blur direction must be either latitudinal or longitudinal!");const g=3,_=new kr(Rv[r],p),x=p.uniforms,b=uL[i]-1,S=isFinite(o)?Math.PI/(2*b):2*Math.PI/(2*eg-1),P=o/S,L=isFinite(o)?1+Math.floor(g*P):eg;L>eg&&console.warn(`sigmaRadians, ${o}, is too large and will clip, as it requested ${L} samples when the maximum is set to ${eg}`);const E=[];let C=0;for(let j=0;j<eg;++j){const G=j/P,N=Math.exp(-G*G/2);E.push(N),j==0?C+=N:j<L&&(C+=2*N)}for(let j=0;j<E.length;j++)E[j]=E[j]/C;x.envMap.value=e.texture,x.samples.value=L,x.weights.value=E,x.latitudinal.value=c==="latitudinal",s&&(x.poleAxis.value=s),x.dTheta.value=S,x.mipInt.value=Ld-i,this._setEncoding(x.inputEncoding,e.texture),this._setEncoding(x.outputEncoding,e.texture);const D=uL[r],O=3*Math.max(0,tu-2*D),U=(r===0?0:2*tu)+2*D*(r>Ld-Lg?r-Ld+Lg:0);ox(t,O,U,3*D,2*D),d.setRenderTarget(t),d.render(_,JT)}}function NY(n){return n===void 0||n.type!==$d?!1:n.encoding===Bo||n.encoding===Tp||n.encoding===FC}function $Y(){const n=[],e=[],t=[];let i=Ld;for(let r=0;r<pz;r++){const o=Math.pow(2,i);e.push(o);let c=1/o;r>Ld-Lg?c=fz[r-Ld+Lg-1]:r==0&&(c=0),t.push(c);const s=1/(o-1),d=-s/2,p=1+s/2,g=[d,d,p,d,p,p,d,d,p,p,d,p],_=6,x=6,b=3,S=2,P=1,L=new Float32Array(b*x*_),E=new Float32Array(S*x*_),C=new Float32Array(P*x*_);for(let O=0;O<_;O++){const U=O%3*2/3-1,j=O>2?0:-1,G=[U,j,0,U+2/3,j,0,U+2/3,j+1,0,U,j,0,U+2/3,j+1,0,U,j+1,0];L.set(G,b*x*O),E.set(g,S*x*O);const N=[O,O,O,O,O,O];C.set(N,P*x*O)}const D=new jn;D.setAttribute("position",new En(L,b)),D.setAttribute("uv",new En(E,S)),D.setAttribute("faceIndex",new En(C,P)),n.push(D),i>Lg&&i--}return{_lodPlanes:n,_sizeLods:e,_sigmas:t}}function fL(n){const e=new Cc(3*tu,3*tu,n);return e.texture.mapping=h1,e.texture.name="PMREM.cubeUv",e.scissorTest=!0,e}function ox(n,e,t,i,r){n.viewport.set(e,t,i,r),n.scissor.set(e,t,i,r)}function VY(n){const e=new Float32Array(n),t=new Ge(0,1,0);return new v1({name:"SphericalGaussianBlur",defines:{n},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:e},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:t},inputEncoding:{value:Vd[Bo]},outputEncoding:{value:Vd[Bo]}},vertexShader:NC(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			${$C()}

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:Rd,depthTest:!1,depthWrite:!1})}function pL(){const n=new li(1,1);return new v1({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:n},inputEncoding:{value:Vd[Bo]},outputEncoding:{value:Vd[Bo]}},vertexShader:NC(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform vec2 texelSize;

			${$C()}

			#include <common>

			void main() {

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				vec2 f = fract( uv / texelSize - 0.5 );
				uv -= f * texelSize;
				vec3 tl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.x += texelSize.x;
				vec3 tr = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.y += texelSize.y;
				vec3 br = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.x -= texelSize.x;
				vec3 bl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;

				vec3 tm = mix( tl, tr, f.x );
				vec3 bm = mix( bl, br, f.x );
				gl_FragColor.rgb = mix( tm, bm, f.y );

				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:Rd,depthTest:!1,depthWrite:!1})}function mL(){return new v1({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},inputEncoding:{value:Vd[Bo]},outputEncoding:{value:Vd[Bo]}},vertexShader:NC(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			${$C()}

			void main() {

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb = envMapTexelToLinear( textureCube( envMap, vec3( - vOutputDirection.x, vOutputDirection.yz ) ) ).rgb;
				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:Rd,depthTest:!1,depthWrite:!1})}function NC(){return`

		precision mediump float;
		precision mediump int;

		attribute vec3 position;
		attribute vec2 uv;
		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`}function $C(){return`

		uniform int inputEncoding;
		uniform int outputEncoding;

		#include <encodings_pars_fragment>

		vec4 inputTexelToLinear( vec4 value ) {

			if ( inputEncoding == 0 ) {

				return value;

			} else if ( inputEncoding == 1 ) {

				return sRGBToLinear( value );

			} else if ( inputEncoding == 2 ) {

				return RGBEToLinear( value );

			} else if ( inputEncoding == 3 ) {

				return RGBMToLinear( value, 7.0 );

			} else if ( inputEncoding == 4 ) {

				return RGBMToLinear( value, 16.0 );

			} else if ( inputEncoding == 5 ) {

				return RGBDToLinear( value, 256.0 );

			} else {

				return GammaToLinear( value, 2.2 );

			}

		}

		vec4 linearToOutputTexel( vec4 value ) {

			if ( outputEncoding == 0 ) {

				return value;

			} else if ( outputEncoding == 1 ) {

				return LinearTosRGB( value );

			} else if ( outputEncoding == 2 ) {

				return LinearToRGBE( value );

			} else if ( outputEncoding == 3 ) {

				return LinearToRGBM( value, 7.0 );

			} else if ( outputEncoding == 4 ) {

				return LinearToRGBM( value, 16.0 );

			} else if ( outputEncoding == 5 ) {

				return LinearToRGBD( value, 256.0 );

			} else {

				return LinearToGamma( value, 2.2 );

			}

		}

		vec4 envMapTexelToLinear( vec4 color ) {

			return inputTexelToLinear( color );

		}
	`}function UY(n){let e=new WeakMap,t=null;function i(s){if(s&&s.isTexture&&s.isRenderTargetTexture===!1){const d=s.mapping,p=d===a2||d===l2,g=d===p0||d===m0;if(p||g){if(e.has(s))return e.get(s).texture;{const _=s.image;if(p&&_&&_.height>0||g&&_&&r(_)){const x=n.getRenderTarget();t===null&&(t=new BY(n));const b=p?t.fromEquirectangular(s):t.fromCubemap(s);return e.set(s,b),n.setRenderTarget(x),s.addEventListener("dispose",o),b.texture}else return null}}}return s}function r(s){let d=0;const p=6;for(let g=0;g<p;g++)s[g]!==void 0&&d++;return d===p}function o(s){const d=s.target;d.removeEventListener("dispose",o);const p=e.get(d);p!==void 0&&(e.delete(d),p.dispose())}function c(){e=new WeakMap,t!==null&&(t.dispose(),t=null)}return{get:i,dispose:c}}function jY(n){const e={};function t(i){if(e[i]!==void 0)return e[i];let r;switch(i){case"WEBGL_depth_texture":r=n.getExtension("WEBGL_depth_texture")||n.getExtension("MOZ_WEBGL_depth_texture")||n.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=n.getExtension("WEBGL_compressed_texture_s3tc")||n.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=n.getExtension("WEBGL_compressed_texture_pvrtc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:r=n.getExtension(i)}return e[i]=r,r}return{has:function(i){return t(i)!==null},init:function(i){i.isWebGL2?t("EXT_color_buffer_float"):(t("WEBGL_depth_texture"),t("OES_texture_float"),t("OES_texture_half_float"),t("OES_texture_half_float_linear"),t("OES_standard_derivatives"),t("OES_element_index_uint"),t("OES_vertex_array_object"),t("ANGLE_instanced_arrays")),t("OES_texture_float_linear"),t("EXT_color_buffer_half_float")},get:function(i){const r=t(i);return r===null&&console.warn("THREE.WebGLRenderer: "+i+" extension not supported."),r}}}function GY(n,e,t,i){const r={},o=new WeakMap;function c(_){const x=_.target;x.index!==null&&e.remove(x.index);for(const S in x.attributes)e.remove(x.attributes[S]);x.removeEventListener("dispose",c),delete r[x.id];const b=o.get(x);b&&(e.remove(b),o.delete(x)),i.releaseStatesOfGeometry(x),x.isInstancedBufferGeometry===!0&&delete x._maxInstanceCount,t.memory.geometries--}function s(_,x){return r[x.id]===!0||(x.addEventListener("dispose",c),r[x.id]=!0,t.memory.geometries++),x}function d(_){const x=_.attributes;for(const S in x)e.update(x[S],34962);const b=_.morphAttributes;for(const S in b){const P=b[S];for(let L=0,E=P.length;L<E;L++)e.update(P[L],34962)}}function p(_){const x=[],b=_.index,S=_.attributes.position;let P=0;if(b!==null){const C=b.array;P=b.version;for(let D=0,O=C.length;D<O;D+=3){const U=C[D+0],j=C[D+1],G=C[D+2];x.push(U,j,j,G,G,U)}}else{const C=S.array;P=S.version;for(let D=0,O=C.length/3-1;D<O;D+=3){const U=D+0,j=D+1,G=D+2;x.push(U,j,j,G,G,U)}}const L=new(sz(x)>65535?uz:cz)(x,1);L.version=P;const E=o.get(_);E&&e.remove(E),o.set(_,L)}function g(_){const x=o.get(_);if(x){const b=_.index;b!==null&&x.version<b.version&&p(_)}else p(_);return o.get(_)}return{get:s,update:d,getWireframeAttribute:g}}function qY(n,e,t,i){const r=i.isWebGL2;let o;function c(x){o=x}let s,d;function p(x){s=x.type,d=x.bytesPerElement}function g(x,b){n.drawElements(o,b,s,x*d),t.update(b,o,1)}function _(x,b,S){if(S===0)return;let P,L;if(r)P=n,L="drawElementsInstanced";else if(P=e.get("ANGLE_instanced_arrays"),L="drawElementsInstancedANGLE",P===null){console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");return}P[L](o,b,s,x*d,S),t.update(b,o,S)}this.setMode=c,this.setIndex=p,this.render=g,this.renderInstances=_}function WY(n){const e={geometries:0,textures:0},t={frame:0,calls:0,triangles:0,points:0,lines:0};function i(o,c,s){switch(t.calls++,c){case 4:t.triangles+=s*(o/3);break;case 1:t.lines+=s*(o/2);break;case 3:t.lines+=s*(o-1);break;case 2:t.lines+=s*o;break;case 0:t.points+=s*o;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",c);break}}function r(){t.frame++,t.calls=0,t.triangles=0,t.points=0,t.lines=0}return{memory:e,render:t,programs:null,autoReset:!0,reset:r,update:i}}class VC extends Bs{constructor(e=null,t=1,i=1,r=1){super(null),this.image={data:e,width:t,height:i,depth:r},this.magFilter=Hs,this.minFilter=Hs,this.wrapR=nl,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}VC.prototype.isDataTexture2DArray=!0;function HY(n,e){return n[0]-e[0]}function ZY(n,e){return Math.abs(e[1])-Math.abs(n[1])}function gL(n,e){let t=1;const i=e.isInterleavedBufferAttribute?e.data.array:e.array;i instanceof Int8Array?t=127:i instanceof Int16Array?t=32767:i instanceof Int32Array?t=2147483647:console.error("THREE.WebGLMorphtargets: Unsupported morph attribute data type: ",i),n.divideScalar(t)}function XY(n,e,t){const i={},r=new Float32Array(8),o=new WeakMap,c=new Ge,s=[];for(let p=0;p<8;p++)s[p]=[p,0];function d(p,g,_,x){const b=p.morphTargetInfluences;if(e.isWebGL2===!0){const S=g.morphAttributes.position.length;let P=o.get(g);if(P===void 0||P.count!==S){P!==void 0&&P.texture.dispose();const C=g.morphAttributes.normal!==void 0,D=g.morphAttributes.position,O=g.morphAttributes.normal||[],U=g.attributes.position.count,j=C===!0?2:1;let G=U*j,N=1;G>e.maxTextureSize&&(N=Math.ceil(G/e.maxTextureSize),G=e.maxTextureSize);const V=new Float32Array(G*N*4*S),q=new VC(V,G,N,S);q.format=ca,q.type=Td;const z=j*4;for(let Q=0;Q<S;Q++){const X=D[Q],re=O[Q],oe=G*N*4*Q;for(let de=0;de<X.count;de++){c.fromBufferAttribute(X,de),X.normalized===!0&&gL(c,X);const ce=de*z;V[oe+ce+0]=c.x,V[oe+ce+1]=c.y,V[oe+ce+2]=c.z,V[oe+ce+3]=0,C===!0&&(c.fromBufferAttribute(re,de),re.normalized===!0&&gL(c,re),V[oe+ce+4]=c.x,V[oe+ce+5]=c.y,V[oe+ce+6]=c.z,V[oe+ce+7]=0)}}P={count:S,texture:q,size:new li(G,N)},o.set(g,P)}let L=0;for(let C=0;C<b.length;C++)L+=b[C];const E=g.morphTargetsRelative?1:1-L;x.getUniforms().setValue(n,"morphTargetBaseInfluence",E),x.getUniforms().setValue(n,"morphTargetInfluences",b),x.getUniforms().setValue(n,"morphTargetsTexture",P.texture,t),x.getUniforms().setValue(n,"morphTargetsTextureSize",P.size)}else{const S=b===void 0?0:b.length;let P=i[g.id];if(P===void 0||P.length!==S){P=[];for(let O=0;O<S;O++)P[O]=[O,0];i[g.id]=P}for(let O=0;O<S;O++){const U=P[O];U[0]=O,U[1]=b[O]}P.sort(ZY);for(let O=0;O<8;O++)O<S&&P[O][1]?(s[O][0]=P[O][0],s[O][1]=P[O][1]):(s[O][0]=Number.MAX_SAFE_INTEGER,s[O][1]=0);s.sort(HY);const L=g.morphAttributes.position,E=g.morphAttributes.normal;let C=0;for(let O=0;O<8;O++){const U=s[O],j=U[0],G=U[1];j!==Number.MAX_SAFE_INTEGER&&G?(L&&g.getAttribute("morphTarget"+O)!==L[j]&&g.setAttribute("morphTarget"+O,L[j]),E&&g.getAttribute("morphNormal"+O)!==E[j]&&g.setAttribute("morphNormal"+O,E[j]),r[O]=G,C+=G):(L&&g.hasAttribute("morphTarget"+O)===!0&&g.deleteAttribute("morphTarget"+O),E&&g.hasAttribute("morphNormal"+O)===!0&&g.deleteAttribute("morphNormal"+O),r[O]=0)}const D=g.morphTargetsRelative?1:1-C;x.getUniforms().setValue(n,"morphTargetBaseInfluence",D),x.getUniforms().setValue(n,"morphTargetInfluences",r)}}return{update:d}}function YY(n,e,t,i){let r=new WeakMap;function o(d){const p=i.render.frame,g=d.geometry,_=e.get(d,g);return r.get(_)!==p&&(e.update(_),r.set(_,p)),d.isInstancedMesh&&(d.hasEventListener("dispose",s)===!1&&d.addEventListener("dispose",s),t.update(d.instanceMatrix,34962),d.instanceColor!==null&&t.update(d.instanceColor,34962)),_}function c(){r=new WeakMap}function s(d){const p=d.target;p.removeEventListener("dispose",s),t.remove(p.instanceMatrix),p.instanceColor!==null&&t.remove(p.instanceColor)}return{update:o,dispose:c}}class mz extends Bs{constructor(e=null,t=1,i=1,r=1){super(null),this.image={data:e,width:t,height:i,depth:r},this.magFilter=Hs,this.minFilter=Hs,this.wrapR=nl,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}mz.prototype.isDataTexture3D=!0;const gz=new Bs,KY=new VC,JY=new mz,_z=new p1,_L=[],vL=[],yL=new Float32Array(16),bL=new Float32Array(9),xL=new Float32Array(4);function p_(n,e,t){const i=n[0];if(i<=0||i>0)return n;const r=e*t;let o=_L[r];if(o===void 0&&(o=new Float32Array(r),_L[r]=o),e!==0){i.toArray(o,0);for(let c=1,s=0;c!==e;++c)s+=t,n[c].toArray(o,s)}return o}function ua(n,e){if(n.length!==e.length)return!1;for(let t=0,i=n.length;t<i;t++)if(n[t]!==e[t])return!1;return!0}function No(n,e){for(let t=0,i=e.length;t<i;t++)n[t]=e[t]}function vz(n,e){let t=vL[e];t===void 0&&(t=new Int32Array(e),vL[e]=t);for(let i=0;i!==e;++i)t[i]=n.allocateTextureUnit();return t}function QY(n,e){const t=this.cache;t[0]!==e&&(n.uniform1f(this.addr,e),t[0]=e)}function eK(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y)&&(n.uniform2f(this.addr,e.x,e.y),t[0]=e.x,t[1]=e.y);else{if(ua(t,e))return;n.uniform2fv(this.addr,e),No(t,e)}}function tK(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z)&&(n.uniform3f(this.addr,e.x,e.y,e.z),t[0]=e.x,t[1]=e.y,t[2]=e.z);else if(e.r!==void 0)(t[0]!==e.r||t[1]!==e.g||t[2]!==e.b)&&(n.uniform3f(this.addr,e.r,e.g,e.b),t[0]=e.r,t[1]=e.g,t[2]=e.b);else{if(ua(t,e))return;n.uniform3fv(this.addr,e),No(t,e)}}function iK(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z||t[3]!==e.w)&&(n.uniform4f(this.addr,e.x,e.y,e.z,e.w),t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.w);else{if(ua(t,e))return;n.uniform4fv(this.addr,e),No(t,e)}}function nK(n,e){const t=this.cache,i=e.elements;if(i===void 0){if(ua(t,e))return;n.uniformMatrix2fv(this.addr,!1,e),No(t,e)}else{if(ua(t,i))return;xL.set(i),n.uniformMatrix2fv(this.addr,!1,xL),No(t,i)}}function rK(n,e){const t=this.cache,i=e.elements;if(i===void 0){if(ua(t,e))return;n.uniformMatrix3fv(this.addr,!1,e),No(t,e)}else{if(ua(t,i))return;bL.set(i),n.uniformMatrix3fv(this.addr,!1,bL),No(t,i)}}function sK(n,e){const t=this.cache,i=e.elements;if(i===void 0){if(ua(t,e))return;n.uniformMatrix4fv(this.addr,!1,e),No(t,e)}else{if(ua(t,i))return;yL.set(i),n.uniformMatrix4fv(this.addr,!1,yL),No(t,i)}}function oK(n,e){const t=this.cache;t[0]!==e&&(n.uniform1i(this.addr,e),t[0]=e)}function aK(n,e){const t=this.cache;ua(t,e)||(n.uniform2iv(this.addr,e),No(t,e))}function lK(n,e){const t=this.cache;ua(t,e)||(n.uniform3iv(this.addr,e),No(t,e))}function cK(n,e){const t=this.cache;ua(t,e)||(n.uniform4iv(this.addr,e),No(t,e))}function uK(n,e){const t=this.cache;t[0]!==e&&(n.uniform1ui(this.addr,e),t[0]=e)}function hK(n,e){const t=this.cache;ua(t,e)||(n.uniform2uiv(this.addr,e),No(t,e))}function dK(n,e){const t=this.cache;ua(t,e)||(n.uniform3uiv(this.addr,e),No(t,e))}function fK(n,e){const t=this.cache;ua(t,e)||(n.uniform4uiv(this.addr,e),No(t,e))}function pK(n,e,t){const i=this.cache,r=t.allocateTextureUnit();i[0]!==r&&(n.uniform1i(this.addr,r),i[0]=r),t.safeSetTexture2D(e||gz,r)}function mK(n,e,t){const i=this.cache,r=t.allocateTextureUnit();i[0]!==r&&(n.uniform1i(this.addr,r),i[0]=r),t.setTexture3D(e||JY,r)}function gK(n,e,t){const i=this.cache,r=t.allocateTextureUnit();i[0]!==r&&(n.uniform1i(this.addr,r),i[0]=r),t.safeSetTextureCube(e||_z,r)}function _K(n,e,t){const i=this.cache,r=t.allocateTextureUnit();i[0]!==r&&(n.uniform1i(this.addr,r),i[0]=r),t.setTexture2DArray(e||KY,r)}function vK(n){switch(n){case 5126:return QY;case 35664:return eK;case 35665:return tK;case 35666:return iK;case 35674:return nK;case 35675:return rK;case 35676:return sK;case 5124:case 35670:return oK;case 35667:case 35671:return aK;case 35668:case 35672:return lK;case 35669:case 35673:return cK;case 5125:return uK;case 36294:return hK;case 36295:return dK;case 36296:return fK;case 35678:case 36198:case 36298:case 36306:case 35682:return pK;case 35679:case 36299:case 36307:return mK;case 35680:case 36300:case 36308:case 36293:return gK;case 36289:case 36303:case 36311:case 36292:return _K}}function yK(n,e){n.uniform1fv(this.addr,e)}function bK(n,e){const t=p_(e,this.size,2);n.uniform2fv(this.addr,t)}function xK(n,e){const t=p_(e,this.size,3);n.uniform3fv(this.addr,t)}function wK(n,e){const t=p_(e,this.size,4);n.uniform4fv(this.addr,t)}function SK(n,e){const t=p_(e,this.size,4);n.uniformMatrix2fv(this.addr,!1,t)}function TK(n,e){const t=p_(e,this.size,9);n.uniformMatrix3fv(this.addr,!1,t)}function MK(n,e){const t=p_(e,this.size,16);n.uniformMatrix4fv(this.addr,!1,t)}function CK(n,e){n.uniform1iv(this.addr,e)}function EK(n,e){n.uniform2iv(this.addr,e)}function AK(n,e){n.uniform3iv(this.addr,e)}function PK(n,e){n.uniform4iv(this.addr,e)}function IK(n,e){n.uniform1uiv(this.addr,e)}function RK(n,e){n.uniform2uiv(this.addr,e)}function LK(n,e){n.uniform3uiv(this.addr,e)}function kK(n,e){n.uniform4uiv(this.addr,e)}function DK(n,e,t){const i=e.length,r=vz(t,i);n.uniform1iv(this.addr,r);for(let o=0;o!==i;++o)t.safeSetTexture2D(e[o]||gz,r[o])}function FK(n,e,t){const i=e.length,r=vz(t,i);n.uniform1iv(this.addr,r);for(let o=0;o!==i;++o)t.safeSetTextureCube(e[o]||_z,r[o])}function OK(n){switch(n){case 5126:return yK;case 35664:return bK;case 35665:return xK;case 35666:return wK;case 35674:return SK;case 35675:return TK;case 35676:return MK;case 5124:case 35670:return CK;case 35667:case 35671:return EK;case 35668:case 35672:return AK;case 35669:case 35673:return PK;case 5125:return IK;case 36294:return RK;case 36295:return LK;case 36296:return kK;case 35678:case 36198:case 36298:case 36306:case 35682:return DK;case 35680:case 36300:case 36308:case 36293:return FK}}function zK(n,e,t){this.id=n,this.addr=t,this.cache=[],this.setValue=vK(e.type)}function yz(n,e,t){this.id=n,this.addr=t,this.cache=[],this.size=e.size,this.setValue=OK(e.type)}yz.prototype.updateCache=function(n){const e=this.cache;n instanceof Float32Array&&e.length!==n.length&&(this.cache=new Float32Array(n.length)),No(e,n)};function bz(n){this.id=n,this.seq=[],this.map={}}bz.prototype.setValue=function(n,e,t){const i=this.seq;for(let r=0,o=i.length;r!==o;++r){const c=i[r];c.setValue(n,e[c.id],t)}};const eM=/(\w+)(\])?(\[|\.)?/g;function wL(n,e){n.seq.push(e),n.map[e.id]=e}function BK(n,e,t){const i=n.name,r=i.length;for(eM.lastIndex=0;;){const o=eM.exec(i),c=eM.lastIndex;let s=o[1];const d=o[2]==="]",p=o[3];if(d&&(s=s|0),p===void 0||p==="["&&c+2===r){wL(t,p===void 0?new zK(s,n,e):new yz(s,n,e));break}else{let _=t.map[s];_===void 0&&(_=new bz(s),wL(t,_)),t=_}}}function kd(n,e){this.seq=[],this.map={};const t=n.getProgramParameter(e,35718);for(let i=0;i<t;++i){const r=n.getActiveUniform(e,i),o=n.getUniformLocation(e,r.name);BK(r,o,this)}}kd.prototype.setValue=function(n,e,t,i){const r=this.map[e];r!==void 0&&r.setValue(n,t,i)};kd.prototype.setOptional=function(n,e,t){const i=e[t];i!==void 0&&this.setValue(n,t,i)};kd.upload=function(n,e,t,i){for(let r=0,o=e.length;r!==o;++r){const c=e[r],s=t[c.id];s.needsUpdate!==!1&&c.setValue(n,s.value,i)}};kd.seqWithValue=function(n,e){const t=[];for(let i=0,r=n.length;i!==r;++i){const o=n[i];o.id in e&&t.push(o)}return t};function SL(n,e,t){const i=n.createShader(e);return n.shaderSource(i,t),n.compileShader(i),i}let NK=0;function $K(n){const e=n.split(`
`);for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join(`
`)}function xz(n){switch(n){case Bo:return["Linear","( value )"];case Tp:return["sRGB","( value )"];case OC:return["RGBE","( value )"];case tz:return["RGBM","( value, 7.0 )"];case iz:return["RGBM","( value, 16.0 )"];case nz:return["RGBD","( value, 256.0 )"];case FC:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case x9:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",n),["Linear","( value )"]}}function TL(n,e,t){const i=n.getShaderParameter(e,35713),r=n.getShaderInfoLog(e).trim();return i&&r===""?"":t.toUpperCase()+`

`+r+`

`+$K(n.getShaderSource(e))}function Wf(n,e){const t=xz(e);return"vec4 "+n+"( vec4 value ) { return "+t[0]+"ToLinear"+t[1]+"; }"}function VK(n,e){const t=xz(e);return"vec4 "+n+"( vec4 value ) { return LinearTo"+t[0]+t[1]+"; }"}function UK(n,e){let t;switch(e){case yH:t="Linear";break;case bH:t="Reinhard";break;case xH:t="OptimizedCineon";break;case wH:t="ACESFilmic";break;case SH:t="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),t="Linear"}return"vec3 "+n+"( vec3 color ) { return "+t+"ToneMapping( color ); }"}function jK(n){return[n.extensionDerivatives||n.envMapCubeUV||n.bumpMap||n.tangentSpaceNormalMap||n.clearcoatNormalMap||n.flatShading||n.shaderID==="physical"?"#extension GL_OES_standard_derivatives : enable":"",(n.extensionFragDepth||n.logarithmicDepthBuffer)&&n.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",n.extensionDrawBuffers&&n.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(n.extensionShaderTextureLOD||n.envMap||n.transmission)&&n.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Yv).join(`
`)}function GK(n){const e=[];for(const t in n){const i=n[t];i!==!1&&e.push("#define "+t+" "+i)}return e.join(`
`)}function qK(n,e){const t={},i=n.getProgramParameter(e,35721);for(let r=0;r<i;r++){const o=n.getActiveAttrib(e,r),c=o.name;let s=1;o.type===35674&&(s=2),o.type===35675&&(s=3),o.type===35676&&(s=4),t[c]={type:o.type,location:n.getAttribLocation(e,c),locationSize:s}}return t}function Yv(n){return n!==""}function ML(n,e){return n.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function CL(n,e){return n.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const WK=/^[ \t]*#include +<([\w\d./]+)>/gm;function d2(n){return n.replace(WK,HK)}function HK(n,e){const t=Cn[e];if(t===void 0)throw new Error("Can not resolve #include <"+e+">");return d2(t)}const ZK=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,XK=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function EL(n){return n.replace(XK,wz).replace(ZK,YK)}function YK(n,e,t,i){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),wz(n,e,t,i)}function wz(n,e,t,i){let r="";for(let o=parseInt(e);o<parseInt(t);o++)r+=i.replace(/\[\s*i\s*\]/g,"[ "+o+" ]").replace(/UNROLLED_LOOP_INDEX/g,o);return r}function AL(n){let e="precision "+n.precision+` float;
precision `+n.precision+" int;";return n.precision==="highp"?e+=`
#define HIGH_PRECISION`:n.precision==="mediump"?e+=`
#define MEDIUM_PRECISION`:n.precision==="lowp"&&(e+=`
#define LOW_PRECISION`),e}function KK(n){let e="SHADOWMAP_TYPE_BASIC";return n.shadowMapType===XO?e="SHADOWMAP_TYPE_PCF":n.shadowMapType===KW?e="SHADOWMAP_TYPE_PCF_SOFT":n.shadowMapType===Xv&&(e="SHADOWMAP_TYPE_VSM"),e}function JK(n){let e="ENVMAP_TYPE_CUBE";if(n.envMap)switch(n.envMapMode){case p0:case m0:e="ENVMAP_TYPE_CUBE";break;case h1:case kC:e="ENVMAP_TYPE_CUBE_UV";break}return e}function QK(n){let e="ENVMAP_MODE_REFLECTION";if(n.envMap)switch(n.envMapMode){case m0:case kC:e="ENVMAP_MODE_REFRACTION";break}return e}function eJ(n){let e="ENVMAP_BLENDING_NONE";if(n.envMap)switch(n.combine){case u1:e="ENVMAP_BLENDING_MULTIPLY";break;case _H:e="ENVMAP_BLENDING_MIX";break;case vH:e="ENVMAP_BLENDING_ADD";break}return e}function tJ(n,e,t,i){const r=n.getContext(),o=t.defines;let c=t.vertexShader,s=t.fragmentShader;const d=KK(t),p=JK(t),g=QK(t),_=eJ(t),x=n.gammaFactor>0?n.gammaFactor:1,b=t.isWebGL2?"":jK(t),S=GK(o),P=r.createProgram();let L,E,C=t.glslVersion?"#version "+t.glslVersion+`
`:"";t.isRawShaderMaterial?(L=[S].filter(Yv).join(`
`),L.length>0&&(L+=`
`),E=[b,S].filter(Yv).join(`
`),E.length>0&&(E+=`
`)):(L=[AL(t),"#define SHADER_NAME "+t.shaderName,S,t.instancing?"#define USE_INSTANCING":"",t.instancingColor?"#define USE_INSTANCING_COLOR":"",t.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+x,"#define MAX_BONES "+t.maxBones,t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+g:"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMap&&t.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",t.normalMap&&t.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.displacementMap&&t.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",t.specularColorMap?"#define USE_SPECULARCOLORMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.sheenColorMap?"#define USE_SHEENCOLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEENROUGHNESSMAP":"",t.vertexTangents?"#define USE_TANGENT":"",t.vertexColors?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUvs?"#define USE_UV":"",t.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",t.flatShading?"#define FLAT_SHADED":"",t.skinning?"#define USE_SKINNING":"",t.useVertexTexture?"#define BONE_TEXTURE":"",t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals&&t.flatShading===!1?"#define USE_MORPHNORMALS":"",t.morphTargets&&t.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",t.morphTargets&&t.isWebGL2?"#define MORPHTARGETS_COUNT "+t.morphTargetsCount:"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+d:"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","	attribute vec3 morphTarget0;","	attribute vec3 morphTarget1;","	attribute vec3 morphTarget2;","	attribute vec3 morphTarget3;","	#ifdef USE_MORPHNORMALS","		attribute vec3 morphNormal0;","		attribute vec3 morphNormal1;","		attribute vec3 morphNormal2;","		attribute vec3 morphNormal3;","	#else","		attribute vec3 morphTarget4;","		attribute vec3 morphTarget5;","		attribute vec3 morphTarget6;","		attribute vec3 morphTarget7;","	#endif","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
`].filter(Yv).join(`
`),E=[b,AL(t),"#define SHADER_NAME "+t.shaderName,S,"#define GAMMA_FACTOR "+x,t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.matcap?"#define USE_MATCAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+p:"",t.envMap?"#define "+g:"",t.envMap?"#define "+_:"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMap&&t.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",t.normalMap&&t.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",t.clearcoat?"#define USE_CLEARCOAT":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",t.specularColorMap?"#define USE_SPECULARCOLORMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaTest?"#define USE_ALPHATEST":"",t.sheen?"#define USE_SHEEN":"",t.sheenColorMap?"#define USE_SHEENCOLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEENROUGHNESSMAP":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.vertexTangents?"#define USE_TANGENT":"",t.vertexColors||t.instancingColor?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUvs?"#define USE_UV":"",t.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",t.gradientMap?"#define USE_GRADIENTMAP":"",t.flatShading?"#define FLAT_SHADED":"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+d:"",t.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",t.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(t.extensionShaderTextureLOD||t.envMap)&&t.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",t.toneMapping!==cp?"#define TONE_MAPPING":"",t.toneMapping!==cp?Cn.tonemapping_pars_fragment:"",t.toneMapping!==cp?UK("toneMapping",t.toneMapping):"",t.dithering?"#define DITHERING":"",t.format===up?"#define OPAQUE":"",Cn.encodings_pars_fragment,t.map?Wf("mapTexelToLinear",t.mapEncoding):"",t.matcap?Wf("matcapTexelToLinear",t.matcapEncoding):"",t.envMap?Wf("envMapTexelToLinear",t.envMapEncoding):"",t.emissiveMap?Wf("emissiveMapTexelToLinear",t.emissiveMapEncoding):"",t.specularColorMap?Wf("specularColorMapTexelToLinear",t.specularColorMapEncoding):"",t.sheenColorMap?Wf("sheenColorMapTexelToLinear",t.sheenColorMapEncoding):"",t.lightMap?Wf("lightMapTexelToLinear",t.lightMapEncoding):"",VK("linearToOutputTexel",t.outputEncoding),t.depthPacking?"#define DEPTH_PACKING "+t.depthPacking:"",`
`].filter(Yv).join(`
`)),c=d2(c),c=ML(c,t),c=CL(c,t),s=d2(s),s=ML(s,t),s=CL(s,t),c=EL(c),s=EL(s),t.isWebGL2&&t.isRawShaderMaterial!==!0&&(C=`#version 300 es
`,L=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join(`
`)+`
`+L,E=["#define varying in",t.glslVersion===KR?"":"out highp vec4 pc_fragColor;",t.glslVersion===KR?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join(`
`)+`
`+E);const D=C+L+c,O=C+E+s,U=SL(r,35633,D),j=SL(r,35632,O);if(r.attachShader(P,U),r.attachShader(P,j),t.index0AttributeName!==void 0?r.bindAttribLocation(P,0,t.index0AttributeName):t.morphTargets===!0&&r.bindAttribLocation(P,0,"position"),r.linkProgram(P),n.debug.checkShaderErrors){const V=r.getProgramInfoLog(P).trim(),q=r.getShaderInfoLog(U).trim(),z=r.getShaderInfoLog(j).trim();let Q=!0,X=!0;if(r.getProgramParameter(P,35714)===!1){Q=!1;const re=TL(r,U,"vertex"),oe=TL(r,j,"fragment");console.error("THREE.WebGLProgram: Shader Error "+r.getError()+" - VALIDATE_STATUS "+r.getProgramParameter(P,35715)+`

Program Info Log: `+V+`
`+re+`
`+oe)}else V!==""?console.warn("THREE.WebGLProgram: Program Info Log:",V):(q===""||z==="")&&(X=!1);X&&(this.diagnostics={runnable:Q,programLog:V,vertexShader:{log:q,prefix:L},fragmentShader:{log:z,prefix:E}})}r.deleteShader(U),r.deleteShader(j);let G;this.getUniforms=function(){return G===void 0&&(G=new kd(r,P)),G};let N;return this.getAttributes=function(){return N===void 0&&(N=qK(r,P)),N},this.destroy=function(){i.releaseStatesOfProgram(this),r.deleteProgram(P),this.program=void 0},this.name=t.shaderName,this.id=NK++,this.cacheKey=e,this.usedTimes=1,this.program=P,this.vertexShader=U,this.fragmentShader=j,this}function iJ(n,e,t,i,r,o,c){const s=[],d=r.isWebGL2,p=r.logarithmicDepthBuffer,g=r.floatVertexTextures,_=r.maxVertexUniforms,x=r.vertexTextures;let b=r.precision;const S={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},P=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoat","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap",,"roughnessMap","metalnessMap","gradientMap","alphaMap","alphaTest","combine","vertexColors","vertexAlphas","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","morphTargetsCount","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","format","specularIntensityMap","specularColorMap","specularColorMapEncoding","transmission","transmissionMap","thicknessMap","sheen","sheenColorMap","sheenColorMapEncoding","sheenRoughnessMap"];function L(G){const V=G.skeleton.bones;if(g)return 1024;{const z=Math.floor((_-20)/4),Q=Math.min(z,V.length);return Q<V.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+V.length+" bones. This GPU supports "+Q+"."),0):Q}}function E(G){let N;return G&&G.isTexture?N=G.encoding:G&&G.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),N=G.texture.encoding):N=Bo,d&&G&&G.isTexture&&G.format===ca&&G.type===$d&&G.encoding===Tp&&(N=Bo),N}function C(G,N,V,q,z){const Q=q.fog,X=G.isMeshStandardMaterial?q.environment:null,re=(G.isMeshStandardMaterial?t:e).get(G.envMap||X),oe=S[G.type],de=z.isSkinnedMesh?L(z):0;G.precision!==null&&(b=r.getMaxPrecision(G.precision),b!==G.precision&&console.warn("THREE.WebGLProgram.getParameters:",G.precision,"not supported, using",b,"instead."));let ce,Se;if(oe){const Ue=ru[oe];ce=Ue.vertexShader,Se=Ue.fragmentShader}else ce=G.vertexShader,Se=G.fragmentShader;const Pe=n.getRenderTarget(),je=G.alphaTest>0,Fe=G.clearcoat>0;return{isWebGL2:d,shaderID:oe,shaderName:G.type,vertexShader:ce,fragmentShader:Se,defines:G.defines,isRawShaderMaterial:G.isRawShaderMaterial===!0,glslVersion:G.glslVersion,precision:b,instancing:z.isInstancedMesh===!0,instancingColor:z.isInstancedMesh===!0&&z.instanceColor!==null,supportsVertexTextures:x,outputEncoding:Pe!==null?E(Pe.texture):n.outputEncoding,map:!!G.map,mapEncoding:E(G.map),matcap:!!G.matcap,matcapEncoding:E(G.matcap),envMap:!!re,envMapMode:re&&re.mapping,envMapEncoding:E(re),envMapCubeUV:!!re&&(re.mapping===h1||re.mapping===kC),lightMap:!!G.lightMap,lightMapEncoding:E(G.lightMap),aoMap:!!G.aoMap,emissiveMap:!!G.emissiveMap,emissiveMapEncoding:E(G.emissiveMap),bumpMap:!!G.bumpMap,normalMap:!!G.normalMap,objectSpaceNormalMap:G.normalMapType===T9,tangentSpaceNormalMap:G.normalMapType===h_,clearcoat:Fe,clearcoatMap:Fe&&!!G.clearcoatMap,clearcoatRoughnessMap:Fe&&!!G.clearcoatRoughnessMap,clearcoatNormalMap:Fe&&!!G.clearcoatNormalMap,displacementMap:!!G.displacementMap,roughnessMap:!!G.roughnessMap,metalnessMap:!!G.metalnessMap,specularMap:!!G.specularMap,specularIntensityMap:!!G.specularIntensityMap,specularColorMap:!!G.specularColorMap,specularColorMapEncoding:E(G.specularColorMap),alphaMap:!!G.alphaMap,alphaTest:je,gradientMap:!!G.gradientMap,sheen:G.sheen>0,sheenColorMap:!!G.sheenColorMap,sheenColorMapEncoding:E(G.sheenColorMap),sheenRoughnessMap:!!G.sheenRoughnessMap,transmission:G.transmission>0,transmissionMap:!!G.transmissionMap,thicknessMap:!!G.thicknessMap,combine:G.combine,vertexTangents:!!G.normalMap&&!!z.geometry&&!!z.geometry.attributes.tangent,vertexColors:G.vertexColors,vertexAlphas:G.vertexColors===!0&&!!z.geometry&&!!z.geometry.attributes.color&&z.geometry.attributes.color.itemSize===4,vertexUvs:!!G.map||!!G.bumpMap||!!G.normalMap||!!G.specularMap||!!G.alphaMap||!!G.emissiveMap||!!G.roughnessMap||!!G.metalnessMap||!!G.clearcoatMap||!!G.clearcoatRoughnessMap||!!G.clearcoatNormalMap||!!G.displacementMap||!!G.transmissionMap||!!G.thicknessMap||!!G.specularIntensityMap||!!G.specularColorMap||!!G.sheenColorMap||G.sheenRoughnessMap,uvsVertexOnly:!(G.map||G.bumpMap||G.normalMap||G.specularMap||G.alphaMap||G.emissiveMap||G.roughnessMap||G.metalnessMap||G.clearcoatNormalMap||G.transmission>0||G.transmissionMap||G.thicknessMap||G.specularIntensityMap||G.specularColorMap||!!G.sheen>0||G.sheenColorMap||G.sheenRoughnessMap)&&!!G.displacementMap,fog:!!Q,useFog:G.fog,fogExp2:Q&&Q.isFogExp2,flatShading:!!G.flatShading,sizeAttenuation:G.sizeAttenuation,logarithmicDepthBuffer:p,skinning:z.isSkinnedMesh===!0&&de>0,maxBones:de,useVertexTexture:g,morphTargets:!!z.geometry&&!!z.geometry.morphAttributes.position,morphNormals:!!z.geometry&&!!z.geometry.morphAttributes.normal,morphTargetsCount:z.geometry&&z.geometry.morphAttributes.position?z.geometry.morphAttributes.position.length:0,numDirLights:N.directional.length,numPointLights:N.point.length,numSpotLights:N.spot.length,numRectAreaLights:N.rectArea.length,numHemiLights:N.hemi.length,numDirLightShadows:N.directionalShadowMap.length,numPointLightShadows:N.pointShadowMap.length,numSpotLightShadows:N.spotShadowMap.length,numClippingPlanes:c.numPlanes,numClipIntersection:c.numIntersection,format:G.format,dithering:G.dithering,shadowMapEnabled:n.shadowMap.enabled&&V.length>0,shadowMapType:n.shadowMap.type,toneMapping:G.toneMapped?n.toneMapping:cp,physicallyCorrectLights:n.physicallyCorrectLights,premultipliedAlpha:G.premultipliedAlpha,doubleSided:G.side===ea,flipSided:G.side===Gs,depthPacking:G.depthPacking!==void 0?G.depthPacking:!1,index0AttributeName:G.index0AttributeName,extensionDerivatives:G.extensions&&G.extensions.derivatives,extensionFragDepth:G.extensions&&G.extensions.fragDepth,extensionDrawBuffers:G.extensions&&G.extensions.drawBuffers,extensionShaderTextureLOD:G.extensions&&G.extensions.shaderTextureLOD,rendererExtensionFragDepth:d||i.has("EXT_frag_depth"),rendererExtensionDrawBuffers:d||i.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:d||i.has("EXT_shader_texture_lod"),customProgramCacheKey:G.customProgramCacheKey()}}function D(G){const N=[];if(G.shaderID?N.push(G.shaderID):(N.push(JR(G.fragmentShader)),N.push(JR(G.vertexShader))),G.defines!==void 0)for(const V in G.defines)N.push(V),N.push(G.defines[V]);if(G.isRawShaderMaterial===!1){for(let V=0;V<P.length;V++)N.push(G[P[V]]);N.push(n.outputEncoding),N.push(n.gammaFactor)}return N.push(G.customProgramCacheKey),N.join()}function O(G){const N=S[G.type];let V;if(N){const q=ru[N];V=eZ.clone(q.uniforms)}else V=G.uniforms;return V}function U(G,N){let V;for(let q=0,z=s.length;q<z;q++){const Q=s[q];if(Q.cacheKey===N){V=Q,++V.usedTimes;break}}return V===void 0&&(V=new tJ(n,N,G,o),s.push(V)),V}function j(G){if(--G.usedTimes===0){const N=s.indexOf(G);s[N]=s[s.length-1],s.pop(),G.destroy()}}return{getParameters:C,getProgramCacheKey:D,getUniforms:O,acquireProgram:U,releaseProgram:j,programs:s}}function nJ(){let n=new WeakMap;function e(o){let c=n.get(o);return c===void 0&&(c={},n.set(o,c)),c}function t(o){n.delete(o)}function i(o,c,s){n.get(o)[c]=s}function r(){n=new WeakMap}return{get:e,remove:t,update:i,dispose:r}}function rJ(n,e){return n.groupOrder!==e.groupOrder?n.groupOrder-e.groupOrder:n.renderOrder!==e.renderOrder?n.renderOrder-e.renderOrder:n.program!==e.program?n.program.id-e.program.id:n.material.id!==e.material.id?n.material.id-e.material.id:n.z!==e.z?n.z-e.z:n.id-e.id}function PL(n,e){return n.groupOrder!==e.groupOrder?n.groupOrder-e.groupOrder:n.renderOrder!==e.renderOrder?n.renderOrder-e.renderOrder:n.z!==e.z?e.z-n.z:n.id-e.id}function IL(n){const e=[];let t=0;const i=[],r=[],o=[],c={id:-1};function s(){t=0,i.length=0,r.length=0,o.length=0}function d(b,S,P,L,E,C){let D=e[t];const O=n.get(P);return D===void 0?(D={id:b.id,object:b,geometry:S,material:P,program:O.program||c,groupOrder:L,renderOrder:b.renderOrder,z:E,group:C},e[t]=D):(D.id=b.id,D.object=b,D.geometry=S,D.material=P,D.program=O.program||c,D.groupOrder=L,D.renderOrder=b.renderOrder,D.z=E,D.group=C),t++,D}function p(b,S,P,L,E,C){const D=d(b,S,P,L,E,C);P.transmission>0?r.push(D):P.transparent===!0?o.push(D):i.push(D)}function g(b,S,P,L,E,C){const D=d(b,S,P,L,E,C);P.transmission>0?r.unshift(D):P.transparent===!0?o.unshift(D):i.unshift(D)}function _(b,S){i.length>1&&i.sort(b||rJ),r.length>1&&r.sort(S||PL),o.length>1&&o.sort(S||PL)}function x(){for(let b=t,S=e.length;b<S;b++){const P=e[b];if(P.id===null)break;P.id=null,P.object=null,P.geometry=null,P.material=null,P.program=null,P.group=null}}return{opaque:i,transmissive:r,transparent:o,init:s,push:p,unshift:g,finish:x,sort:_}}function sJ(n){let e=new WeakMap;function t(r,o){let c;return e.has(r)===!1?(c=new IL(n),e.set(r,[c])):o>=e.get(r).length?(c=new IL(n),e.get(r).push(c)):c=e.get(r)[o],c}function i(){e=new WeakMap}return{get:t,dispose:i}}function oJ(){const n={};return{get:function(e){if(n[e.id]!==void 0)return n[e.id];let t;switch(e.type){case"DirectionalLight":t={direction:new Ge,color:new $i};break;case"SpotLight":t={position:new Ge,direction:new Ge,color:new $i,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":t={position:new Ge,color:new $i,distance:0,decay:0};break;case"HemisphereLight":t={direction:new Ge,skyColor:new $i,groundColor:new $i};break;case"RectAreaLight":t={color:new $i,position:new Ge,halfWidth:new Ge,halfHeight:new Ge};break}return n[e.id]=t,t}}}function aJ(){const n={};return{get:function(e){if(n[e.id]!==void 0)return n[e.id];let t;switch(e.type){case"DirectionalLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new li};break;case"SpotLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new li};break;case"PointLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new li,shadowCameraNear:1,shadowCameraFar:1e3};break}return n[e.id]=t,t}}}let lJ=0;function cJ(n,e){return(e.castShadow?1:0)-(n.castShadow?1:0)}function uJ(n,e){const t=new oJ,i=aJ(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let g=0;g<9;g++)r.probe.push(new Ge);const o=new Ge,c=new ki,s=new ki;function d(g,_){let x=0,b=0,S=0;for(let V=0;V<9;V++)r.probe[V].set(0,0,0);let P=0,L=0,E=0,C=0,D=0,O=0,U=0,j=0;g.sort(cJ);const G=_!==!0?Math.PI:1;for(let V=0,q=g.length;V<q;V++){const z=g[V],Q=z.color,X=z.intensity,re=z.distance,oe=z.shadow&&z.shadow.map?z.shadow.map.texture:null;if(z.isAmbientLight)x+=Q.r*X*G,b+=Q.g*X*G,S+=Q.b*X*G;else if(z.isLightProbe)for(let de=0;de<9;de++)r.probe[de].addScaledVector(z.sh.coefficients[de],X);else if(z.isDirectionalLight){const de=t.get(z);if(de.color.copy(z.color).multiplyScalar(z.intensity*G),z.castShadow){const ce=z.shadow,Se=i.get(z);Se.shadowBias=ce.bias,Se.shadowNormalBias=ce.normalBias,Se.shadowRadius=ce.radius,Se.shadowMapSize=ce.mapSize,r.directionalShadow[P]=Se,r.directionalShadowMap[P]=oe,r.directionalShadowMatrix[P]=z.shadow.matrix,O++}r.directional[P]=de,P++}else if(z.isSpotLight){const de=t.get(z);if(de.position.setFromMatrixPosition(z.matrixWorld),de.color.copy(Q).multiplyScalar(X*G),de.distance=re,de.coneCos=Math.cos(z.angle),de.penumbraCos=Math.cos(z.angle*(1-z.penumbra)),de.decay=z.decay,z.castShadow){const ce=z.shadow,Se=i.get(z);Se.shadowBias=ce.bias,Se.shadowNormalBias=ce.normalBias,Se.shadowRadius=ce.radius,Se.shadowMapSize=ce.mapSize,r.spotShadow[E]=Se,r.spotShadowMap[E]=oe,r.spotShadowMatrix[E]=z.shadow.matrix,j++}r.spot[E]=de,E++}else if(z.isRectAreaLight){const de=t.get(z);de.color.copy(Q).multiplyScalar(X),de.halfWidth.set(z.width*.5,0,0),de.halfHeight.set(0,z.height*.5,0),r.rectArea[C]=de,C++}else if(z.isPointLight){const de=t.get(z);if(de.color.copy(z.color).multiplyScalar(z.intensity*G),de.distance=z.distance,de.decay=z.decay,z.castShadow){const ce=z.shadow,Se=i.get(z);Se.shadowBias=ce.bias,Se.shadowNormalBias=ce.normalBias,Se.shadowRadius=ce.radius,Se.shadowMapSize=ce.mapSize,Se.shadowCameraNear=ce.camera.near,Se.shadowCameraFar=ce.camera.far,r.pointShadow[L]=Se,r.pointShadowMap[L]=oe,r.pointShadowMatrix[L]=z.shadow.matrix,U++}r.point[L]=de,L++}else if(z.isHemisphereLight){const de=t.get(z);de.skyColor.copy(z.color).multiplyScalar(X*G),de.groundColor.copy(z.groundColor).multiplyScalar(X*G),r.hemi[D]=de,D++}}C>0&&(e.isWebGL2||n.has("OES_texture_float_linear")===!0?(r.rectAreaLTC1=xi.LTC_FLOAT_1,r.rectAreaLTC2=xi.LTC_FLOAT_2):n.has("OES_texture_half_float_linear")===!0?(r.rectAreaLTC1=xi.LTC_HALF_1,r.rectAreaLTC2=xi.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),r.ambient[0]=x,r.ambient[1]=b,r.ambient[2]=S;const N=r.hash;(N.directionalLength!==P||N.pointLength!==L||N.spotLength!==E||N.rectAreaLength!==C||N.hemiLength!==D||N.numDirectionalShadows!==O||N.numPointShadows!==U||N.numSpotShadows!==j)&&(r.directional.length=P,r.spot.length=E,r.rectArea.length=C,r.point.length=L,r.hemi.length=D,r.directionalShadow.length=O,r.directionalShadowMap.length=O,r.pointShadow.length=U,r.pointShadowMap.length=U,r.spotShadow.length=j,r.spotShadowMap.length=j,r.directionalShadowMatrix.length=O,r.pointShadowMatrix.length=U,r.spotShadowMatrix.length=j,N.directionalLength=P,N.pointLength=L,N.spotLength=E,N.rectAreaLength=C,N.hemiLength=D,N.numDirectionalShadows=O,N.numPointShadows=U,N.numSpotShadows=j,r.version=lJ++)}function p(g,_){let x=0,b=0,S=0,P=0,L=0;const E=_.matrixWorldInverse;for(let C=0,D=g.length;C<D;C++){const O=g[C];if(O.isDirectionalLight){const U=r.directional[x];U.direction.setFromMatrixPosition(O.matrixWorld),o.setFromMatrixPosition(O.target.matrixWorld),U.direction.sub(o),U.direction.transformDirection(E),x++}else if(O.isSpotLight){const U=r.spot[S];U.position.setFromMatrixPosition(O.matrixWorld),U.position.applyMatrix4(E),U.direction.setFromMatrixPosition(O.matrixWorld),o.setFromMatrixPosition(O.target.matrixWorld),U.direction.sub(o),U.direction.transformDirection(E),S++}else if(O.isRectAreaLight){const U=r.rectArea[P];U.position.setFromMatrixPosition(O.matrixWorld),U.position.applyMatrix4(E),s.identity(),c.copy(O.matrixWorld),c.premultiply(E),s.extractRotation(c),U.halfWidth.set(O.width*.5,0,0),U.halfHeight.set(0,O.height*.5,0),U.halfWidth.applyMatrix4(s),U.halfHeight.applyMatrix4(s),P++}else if(O.isPointLight){const U=r.point[b];U.position.setFromMatrixPosition(O.matrixWorld),U.position.applyMatrix4(E),b++}else if(O.isHemisphereLight){const U=r.hemi[L];U.direction.setFromMatrixPosition(O.matrixWorld),U.direction.transformDirection(E),U.direction.normalize(),L++}}}return{setup:d,setupView:p,state:r}}function RL(n,e){const t=new uJ(n,e),i=[],r=[];function o(){i.length=0,r.length=0}function c(_){i.push(_)}function s(_){r.push(_)}function d(_){t.setup(i,_)}function p(_){t.setupView(i,_)}return{init:o,state:{lightsArray:i,shadowsArray:r,lights:t},setupLights:d,setupLightsView:p,pushLight:c,pushShadow:s}}function hJ(n,e){let t=new WeakMap;function i(o,c=0){let s;return t.has(o)===!1?(s=new RL(n,e),t.set(o,[s])):c>=t.get(o).length?(s=new RL(n,e),t.get(o).push(s)):s=t.get(o)[c],s}function r(){t=new WeakMap}return{get:i,dispose:r}}class Sz extends Vo{constructor(e){super(),this.type="MeshDepthMaterial",this.depthPacking=w9,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}Sz.prototype.isMeshDepthMaterial=!0;class Tz extends Vo{constructor(e){super(),this.type="MeshDistanceMaterial",this.referencePosition=new Ge,this.nearDistance=1,this.farDistance=1e3,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}Tz.prototype.isMeshDistanceMaterial=!0;const dJ=`void main() {
	gl_Position = vec4( position, 1.0 );
}`,fJ=`uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;
#include <packing>
void main() {
	const float samples = float( VSM_SAMPLES );
	float mean = 0.0;
	float squared_mean = 0.0;
	float uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );
	float uvStart = samples <= 1.0 ? 0.0 : - 1.0;
	for ( float i = 0.0; i < samples; i ++ ) {
		float uvOffset = uvStart + i * uvStride;
		#ifdef HORIZONTAL_PASS
			vec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );
			mean += distribution.x;
			squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;
		#else
			float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );
			mean += depth;
			squared_mean += depth * depth;
		#endif
	}
	mean = mean / samples;
	squared_mean = squared_mean / samples;
	float std_dev = sqrt( squared_mean - mean * mean );
	gl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );
}`;function Mz(n,e,t){let i=new m1;const r=new li,o=new li,c=new Xn,s=new Sz({depthPacking:S9}),d=new Tz,p={},g=t.maxTextureSize,_={0:Gs,1:Hg,2:ea},x=new ta({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new li},radius:{value:4}},vertexShader:dJ,fragmentShader:fJ}),b=x.clone();b.defines.HORIZONTAL_PASS=1;const S=new jn;S.setAttribute("position",new En(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const P=new kr(S,x),L=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=XO,this.render=function(O,U,j){if(L.enabled===!1||L.autoUpdate===!1&&L.needsUpdate===!1||O.length===0)return;const G=n.getRenderTarget(),N=n.getActiveCubeFace(),V=n.getActiveMipmapLevel(),q=n.state;q.setBlending(Rd),q.buffers.color.setClear(1,1,1,1),q.buffers.depth.setTest(!0),q.setScissorTest(!1);for(let z=0,Q=O.length;z<Q;z++){const X=O[z],re=X.shadow;if(re===void 0){console.warn("THREE.WebGLShadowMap:",X,"has no shadow.");continue}if(re.autoUpdate===!1&&re.needsUpdate===!1)continue;r.copy(re.mapSize);const oe=re.getFrameExtents();if(r.multiply(oe),o.copy(re.mapSize),(r.x>g||r.y>g)&&(r.x>g&&(o.x=Math.floor(g/oe.x),r.x=o.x*oe.x,re.mapSize.x=o.x),r.y>g&&(o.y=Math.floor(g/oe.y),r.y=o.y*oe.y,re.mapSize.y=o.y)),re.map===null&&!re.isPointLightShadow&&this.type===Xv){const ce={minFilter:Fo,magFilter:Fo,format:ca};re.map=new Cc(r.x,r.y,ce),re.map.texture.name=X.name+".shadowMap",re.mapPass=new Cc(r.x,r.y,ce),re.camera.updateProjectionMatrix()}if(re.map===null){const ce={minFilter:Hs,magFilter:Hs,format:ca};re.map=new Cc(r.x,r.y,ce),re.map.texture.name=X.name+".shadowMap",re.camera.updateProjectionMatrix()}n.setRenderTarget(re.map),n.clear();const de=re.getViewportCount();for(let ce=0;ce<de;ce++){const Se=re.getViewport(ce);c.set(o.x*Se.x,o.y*Se.y,o.x*Se.z,o.y*Se.w),q.viewport(c),re.updateMatrices(X,ce),i=re.getFrustum(),D(U,j,re.camera,X,this.type)}!re.isPointLightShadow&&this.type===Xv&&E(re,j),re.needsUpdate=!1}L.needsUpdate=!1,n.setRenderTarget(G,N,V)};function E(O,U){const j=e.update(P);x.defines.VSM_SAMPLES!==O.blurSamples&&(x.defines.VSM_SAMPLES=O.blurSamples,b.defines.VSM_SAMPLES=O.blurSamples,x.needsUpdate=!0,b.needsUpdate=!0),x.uniforms.shadow_pass.value=O.map.texture,x.uniforms.resolution.value=O.mapSize,x.uniforms.radius.value=O.radius,n.setRenderTarget(O.mapPass),n.clear(),n.renderBufferDirect(U,null,j,x,P,null),b.uniforms.shadow_pass.value=O.mapPass.texture,b.uniforms.resolution.value=O.mapSize,b.uniforms.radius.value=O.radius,n.setRenderTarget(O.map),n.clear(),n.renderBufferDirect(U,null,j,b,P,null)}function C(O,U,j,G,N,V,q){let z=null;const Q=G.isPointLight===!0?O.customDistanceMaterial:O.customDepthMaterial;if(Q!==void 0?z=Q:z=G.isPointLight===!0?d:s,n.localClippingEnabled&&j.clipShadows===!0&&j.clippingPlanes.length!==0||j.displacementMap&&j.displacementScale!==0||j.alphaMap&&j.alphaTest>0){const X=z.uuid,re=j.uuid;let oe=p[X];oe===void 0&&(oe={},p[X]=oe);let de=oe[re];de===void 0&&(de=z.clone(),oe[re]=de),z=de}return z.visible=j.visible,z.wireframe=j.wireframe,q===Xv?z.side=j.shadowSide!==null?j.shadowSide:j.side:z.side=j.shadowSide!==null?j.shadowSide:_[j.side],z.alphaMap=j.alphaMap,z.alphaTest=j.alphaTest,z.clipShadows=j.clipShadows,z.clippingPlanes=j.clippingPlanes,z.clipIntersection=j.clipIntersection,z.displacementMap=j.displacementMap,z.displacementScale=j.displacementScale,z.displacementBias=j.displacementBias,z.wireframeLinewidth=j.wireframeLinewidth,z.linewidth=j.linewidth,G.isPointLight===!0&&z.isMeshDistanceMaterial===!0&&(z.referencePosition.setFromMatrixPosition(G.matrixWorld),z.nearDistance=N,z.farDistance=V),z}function D(O,U,j,G,N){if(O.visible===!1)return;if(O.layers.test(U.layers)&&(O.isMesh||O.isLine||O.isPoints)&&(O.castShadow||O.receiveShadow&&N===Xv)&&(!O.frustumCulled||i.intersectsObject(O))){O.modelViewMatrix.multiplyMatrices(j.matrixWorldInverse,O.matrixWorld);const z=e.update(O),Q=O.material;if(Array.isArray(Q)){const X=z.groups;for(let re=0,oe=X.length;re<oe;re++){const de=X[re],ce=Q[de.materialIndex];if(ce&&ce.visible){const Se=C(O,z,ce,G,j.near,j.far,N);n.renderBufferDirect(j,null,z,Se,O,de)}}}else if(Q.visible){const X=C(O,z,Q,G,j.near,j.far,N);n.renderBufferDirect(j,null,z,X,O,null)}}const q=O.children;for(let z=0,Q=q.length;z<Q;z++)D(q[z],U,j,G,N)}}function pJ(n,e,t){const i=t.isWebGL2;function r(){let te=!1;const he=new Xn;let pe=null;const Re=new Xn(0,0,0,0);return{setMask:function(Oe){pe!==Oe&&!te&&(n.colorMask(Oe,Oe,Oe,Oe),pe=Oe)},setLocked:function(Oe){te=Oe},setClear:function(Oe,ht,pt,ot,St){St===!0&&(Oe*=ot,ht*=ot,pt*=ot),he.set(Oe,ht,pt,ot),Re.equals(he)===!1&&(n.clearColor(Oe,ht,pt,ot),Re.copy(he))},reset:function(){te=!1,pe=null,Re.set(-1,0,0,0)}}}function o(){let te=!1,he=null,pe=null,Re=null;return{setTest:function(Oe){Oe?ke(2929):et(2929)},setMask:function(Oe){he!==Oe&&!te&&(n.depthMask(Oe),he=Oe)},setFunc:function(Oe){if(pe!==Oe){if(Oe)switch(Oe){case uH:n.depthFunc(512);break;case hH:n.depthFunc(519);break;case dH:n.depthFunc(513);break;case o2:n.depthFunc(515);break;case fH:n.depthFunc(514);break;case pH:n.depthFunc(518);break;case mH:n.depthFunc(516);break;case gH:n.depthFunc(517);break;default:n.depthFunc(515)}else n.depthFunc(515);pe=Oe}},setLocked:function(Oe){te=Oe},setClear:function(Oe){Re!==Oe&&(n.clearDepth(Oe),Re=Oe)},reset:function(){te=!1,he=null,pe=null,Re=null}}}function c(){let te=!1,he=null,pe=null,Re=null,Oe=null,ht=null,pt=null,ot=null,St=null;return{setTest:function(Lt){te||(Lt?ke(2960):et(2960))},setMask:function(Lt){he!==Lt&&!te&&(n.stencilMask(Lt),he=Lt)},setFunc:function(Lt,zt,Jt){(pe!==Lt||Re!==zt||Oe!==Jt)&&(n.stencilFunc(Lt,zt,Jt),pe=Lt,Re=zt,Oe=Jt)},setOp:function(Lt,zt,Jt){(ht!==Lt||pt!==zt||ot!==Jt)&&(n.stencilOp(Lt,zt,Jt),ht=Lt,pt=zt,ot=Jt)},setLocked:function(Lt){te=Lt},setClear:function(Lt){St!==Lt&&(n.clearStencil(Lt),St=Lt)},reset:function(){te=!1,he=null,pe=null,Re=null,Oe=null,ht=null,pt=null,ot=null,St=null}}}const s=new r,d=new o,p=new c;let g={},_=null,x={},b=null,S=!1,P=null,L=null,E=null,C=null,D=null,O=null,U=null,j=!1,G=null,N=null,V=null,q=null,z=null;const Q=n.getParameter(35661);let X=!1,re=0;const oe=n.getParameter(7938);oe.indexOf("WebGL")!==-1?(re=parseFloat(/^WebGL (\d)/.exec(oe)[1]),X=re>=1):oe.indexOf("OpenGL ES")!==-1&&(re=parseFloat(/^OpenGL ES (\d)/.exec(oe)[1]),X=re>=2);let de=null,ce={};const Se=n.getParameter(3088),Pe=n.getParameter(2978),je=new Xn().fromArray(Se),Fe=new Xn().fromArray(Pe);function qe(te,he,pe){const Re=new Uint8Array(4),Oe=n.createTexture();n.bindTexture(te,Oe),n.texParameteri(te,10241,9728),n.texParameteri(te,10240,9728);for(let ht=0;ht<pe;ht++)n.texImage2D(he+ht,0,6408,1,1,0,6408,5121,Re);return Oe}const Ue={};Ue[3553]=qe(3553,3553,1),Ue[34067]=qe(34067,34069,6),s.setClear(0,0,0,1),d.setClear(1),p.setClear(0),ke(2929),d.setFunc(o2),Ve(!1),tt(kR),ke(2884),we(Rd);function ke(te){g[te]!==!0&&(n.enable(te),g[te]=!0)}function et(te){g[te]!==!1&&(n.disable(te),g[te]=!1)}function ye(te){te!==_&&(n.bindFramebuffer(36160,te),_=te)}function Be(te,he){return he===null&&_!==null&&(he=_),x[te]!==he?(n.bindFramebuffer(te,he),x[te]=he,i&&(te===36009&&(x[36160]=he),te===36160&&(x[36009]=he)),!0):!1}function Je(te){return b!==te?(n.useProgram(te),b=te,!0):!1}const ct={[pg]:32774,[QW]:32778,[eH]:32779};if(i)ct[zR]=32775,ct[BR]=32776;else{const te=e.get("EXT_blend_minmax");te!==null&&(ct[zR]=te.MIN_EXT,ct[BR]=te.MAX_EXT)}const yt={[tH]:0,[iH]:1,[nH]:768,[KO]:770,[cH]:776,[aH]:774,[sH]:772,[rH]:769,[JO]:771,[lH]:775,[oH]:773};function we(te,he,pe,Re,Oe,ht,pt,ot){if(te===Rd){S===!0&&(et(3042),S=!1);return}if(S===!1&&(ke(3042),S=!0),te!==JW){if(te!==P||ot!==j){if((L!==pg||D!==pg)&&(n.blendEquation(32774),L=pg,D=pg),ot)switch(te){case py:n.blendFuncSeparate(1,771,1,771);break;case DR:n.blendFunc(1,1);break;case FR:n.blendFuncSeparate(0,0,769,771);break;case OR:n.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",te);break}else switch(te){case py:n.blendFuncSeparate(770,771,1,771);break;case DR:n.blendFunc(770,1);break;case FR:n.blendFunc(0,769);break;case OR:n.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",te);break}E=null,C=null,O=null,U=null,P=te,j=ot}return}Oe=Oe||he,ht=ht||pe,pt=pt||Re,(he!==L||Oe!==D)&&(n.blendEquationSeparate(ct[he],ct[Oe]),L=he,D=Oe),(pe!==E||Re!==C||ht!==O||pt!==U)&&(n.blendFuncSeparate(yt[pe],yt[Re],yt[ht],yt[pt]),E=pe,C=Re,O=ht,U=pt),P=te,j=null}function fe(te,he){te.side===ea?et(2884):ke(2884);let pe=te.side===Gs;he&&(pe=!pe),Ve(pe),te.blending===py&&te.transparent===!1?we(Rd):we(te.blending,te.blendEquation,te.blendSrc,te.blendDst,te.blendEquationAlpha,te.blendSrcAlpha,te.blendDstAlpha,te.premultipliedAlpha),d.setFunc(te.depthFunc),d.setTest(te.depthTest),d.setMask(te.depthWrite),s.setMask(te.colorWrite);const Re=te.stencilWrite;p.setTest(Re),Re&&(p.setMask(te.stencilWriteMask),p.setFunc(te.stencilFunc,te.stencilRef,te.stencilFuncMask),p.setOp(te.stencilFail,te.stencilZFail,te.stencilZPass)),mt(te.polygonOffset,te.polygonOffsetFactor,te.polygonOffsetUnits),te.alphaToCoverage===!0?ke(32926):et(32926)}function Ve(te){G!==te&&(te?n.frontFace(2304):n.frontFace(2305),G=te)}function tt(te){te!==XW?(ke(2884),te!==N&&(te===kR?n.cullFace(1029):te===YW?n.cullFace(1028):n.cullFace(1032))):et(2884),N=te}function Mt(te){te!==V&&(X&&n.lineWidth(te),V=te)}function mt(te,he,pe){te?(ke(32823),(q!==he||z!==pe)&&(n.polygonOffset(he,pe),q=he,z=pe)):et(32823)}function Ce(te){te?ke(3089):et(3089)}function xe(te){te===void 0&&(te=33984+Q-1),de!==te&&(n.activeTexture(te),de=te)}function vt(te,he){de===null&&xe();let pe=ce[de];pe===void 0&&(pe={type:void 0,texture:void 0},ce[de]=pe),(pe.type!==te||pe.texture!==he)&&(n.bindTexture(te,he||Ue[te]),pe.type=te,pe.texture=he)}function be(){const te=ce[de];te!==void 0&&te.type!==void 0&&(n.bindTexture(te.type,null),te.type=void 0,te.texture=void 0)}function ie(){try{n.compressedTexImage2D.apply(n,arguments)}catch(te){console.error("THREE.WebGLState:",te)}}function ae(){try{n.texImage2D.apply(n,arguments)}catch(te){console.error("THREE.WebGLState:",te)}}function De(){try{n.texImage3D.apply(n,arguments)}catch(te){console.error("THREE.WebGLState:",te)}}function Xe(te){je.equals(te)===!1&&(n.scissor(te.x,te.y,te.z,te.w),je.copy(te))}function bt(te){Fe.equals(te)===!1&&(n.viewport(te.x,te.y,te.z,te.w),Fe.copy(te))}function Te(){n.disable(3042),n.disable(2884),n.disable(2929),n.disable(32823),n.disable(3089),n.disable(2960),n.disable(32926),n.blendEquation(32774),n.blendFunc(1,0),n.blendFuncSeparate(1,0,1,0),n.colorMask(!0,!0,!0,!0),n.clearColor(0,0,0,0),n.depthMask(!0),n.depthFunc(513),n.clearDepth(1),n.stencilMask(4294967295),n.stencilFunc(519,0,4294967295),n.stencilOp(7680,7680,7680),n.clearStencil(0),n.cullFace(1029),n.frontFace(2305),n.polygonOffset(0,0),n.activeTexture(33984),n.bindFramebuffer(36160,null),i===!0&&(n.bindFramebuffer(36009,null),n.bindFramebuffer(36008,null)),n.useProgram(null),n.lineWidth(1),n.scissor(0,0,n.canvas.width,n.canvas.height),n.viewport(0,0,n.canvas.width,n.canvas.height),g={},de=null,ce={},_=null,x={},b=null,S=!1,P=null,L=null,E=null,C=null,D=null,O=null,U=null,j=!1,G=null,N=null,V=null,q=null,z=null,je.set(0,0,n.canvas.width,n.canvas.height),Fe.set(0,0,n.canvas.width,n.canvas.height),s.reset(),d.reset(),p.reset()}return{buffers:{color:s,depth:d,stencil:p},enable:ke,disable:et,bindFramebuffer:Be,bindXRFramebuffer:ye,useProgram:Je,setBlending:we,setMaterial:fe,setFlipSided:Ve,setCullFace:tt,setLineWidth:Mt,setPolygonOffset:mt,setScissorTest:Ce,activeTexture:xe,bindTexture:vt,unbindTexture:be,compressedTexImage2D:ie,texImage2D:ae,texImage3D:De,scissor:Xe,viewport:bt,reset:Te}}function mJ(n,e,t,i,r,o,c){const s=r.isWebGL2,d=r.maxTextures,p=r.maxCubemapSize,g=r.maxTextureSize,_=r.maxSamples,x=new WeakMap;let b,S=!1;try{S=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")!==null}catch{}function P(Ce,xe){return S?new OffscreenCanvas(Ce,xe):f1("canvas")}function L(Ce,xe,vt,be){let ie=1;if((Ce.width>be||Ce.height>be)&&(ie=be/Math.max(Ce.width,Ce.height)),ie<1||xe===!0)if(typeof HTMLImageElement<"u"&&Ce instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&Ce instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&Ce instanceof ImageBitmap){const ae=xe?rz:Math.floor,De=ae(ie*Ce.width),Xe=ae(ie*Ce.height);b===void 0&&(b=P(De,Xe));const bt=vt?P(De,Xe):b;return bt.width=De,bt.height=Xe,bt.getContext("2d").drawImage(Ce,0,0,De,Xe),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+Ce.width+"x"+Ce.height+") to ("+De+"x"+Xe+")."),bt}else return"data"in Ce&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+Ce.width+"x"+Ce.height+")."),Ce;return Ce}function E(Ce){return h2(Ce.width)&&h2(Ce.height)}function C(Ce){return s?!1:Ce.wrapS!==nl||Ce.wrapT!==nl||Ce.minFilter!==Hs&&Ce.minFilter!==Fo}function D(Ce,xe){return Ce.generateMipmaps&&xe&&Ce.minFilter!==Hs&&Ce.minFilter!==Fo}function O(Ce,xe,vt,be,ie=1){n.generateMipmap(Ce);const ae=i.get(xe);ae.__maxMipLevel=Math.log2(Math.max(vt,be,ie))}function U(Ce,xe,vt,be){if(s===!1)return xe;if(Ce!==null){if(n[Ce]!==void 0)return n[Ce];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+Ce+"'")}let ie=xe;return xe===6403&&(vt===5126&&(ie=33326),vt===5131&&(ie=33325),vt===5121&&(ie=33321)),xe===6407&&(vt===5126&&(ie=34837),vt===5131&&(ie=34843),vt===5121&&(ie=32849)),xe===6408&&(vt===5126&&(ie=34836),vt===5131&&(ie=34842),vt===5121&&(ie=be===Tp?35907:32856)),(ie===33325||ie===33326||ie===34842||ie===34836)&&e.get("EXT_color_buffer_float"),ie}function j(Ce){return Ce===Hs||Ce===NR||Ce===$R?9728:9729}function G(Ce){const xe=Ce.target;xe.removeEventListener("dispose",G),V(xe),xe.isVideoTexture&&x.delete(xe),c.memory.textures--}function N(Ce){const xe=Ce.target;xe.removeEventListener("dispose",N),q(xe)}function V(Ce){const xe=i.get(Ce);xe.__webglInit!==void 0&&(n.deleteTexture(xe.__webglTexture),i.remove(Ce))}function q(Ce){const xe=Ce.texture,vt=i.get(Ce),be=i.get(xe);if(Ce){if(be.__webglTexture!==void 0&&(n.deleteTexture(be.__webglTexture),c.memory.textures--),Ce.depthTexture&&Ce.depthTexture.dispose(),Ce.isWebGLCubeRenderTarget)for(let ie=0;ie<6;ie++)n.deleteFramebuffer(vt.__webglFramebuffer[ie]),vt.__webglDepthbuffer&&n.deleteRenderbuffer(vt.__webglDepthbuffer[ie]);else n.deleteFramebuffer(vt.__webglFramebuffer),vt.__webglDepthbuffer&&n.deleteRenderbuffer(vt.__webglDepthbuffer),vt.__webglMultisampledFramebuffer&&n.deleteFramebuffer(vt.__webglMultisampledFramebuffer),vt.__webglColorRenderbuffer&&n.deleteRenderbuffer(vt.__webglColorRenderbuffer),vt.__webglDepthRenderbuffer&&n.deleteRenderbuffer(vt.__webglDepthRenderbuffer);if(Ce.isWebGLMultipleRenderTargets)for(let ie=0,ae=xe.length;ie<ae;ie++){const De=i.get(xe[ie]);De.__webglTexture&&(n.deleteTexture(De.__webglTexture),c.memory.textures--),i.remove(xe[ie])}i.remove(xe),i.remove(Ce)}}let z=0;function Q(){z=0}function X(){const Ce=z;return Ce>=d&&console.warn("THREE.WebGLTextures: Trying to use "+Ce+" texture units while this GPU supports only "+d),z+=1,Ce}function re(Ce,xe){const vt=i.get(Ce);if(Ce.isVideoTexture&&fe(Ce),Ce.version>0&&vt.__version!==Ce.version){const be=Ce.image;if(be===void 0)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else if(be.complete===!1)console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete");else{qe(vt,Ce,xe);return}}t.activeTexture(33984+xe),t.bindTexture(3553,vt.__webglTexture)}function oe(Ce,xe){const vt=i.get(Ce);if(Ce.version>0&&vt.__version!==Ce.version){qe(vt,Ce,xe);return}t.activeTexture(33984+xe),t.bindTexture(35866,vt.__webglTexture)}function de(Ce,xe){const vt=i.get(Ce);if(Ce.version>0&&vt.__version!==Ce.version){qe(vt,Ce,xe);return}t.activeTexture(33984+xe),t.bindTexture(32879,vt.__webglTexture)}function ce(Ce,xe){const vt=i.get(Ce);if(Ce.version>0&&vt.__version!==Ce.version){Ue(vt,Ce,xe);return}t.activeTexture(33984+xe),t.bindTexture(34067,vt.__webglTexture)}const Se={[c2]:10497,[nl]:33071,[u2]:33648},Pe={[Hs]:9728,[NR]:9984,[$R]:9986,[Fo]:9729,[TH]:9985,[d1]:9987};function je(Ce,xe,vt){if(vt?(n.texParameteri(Ce,10242,Se[xe.wrapS]),n.texParameteri(Ce,10243,Se[xe.wrapT]),(Ce===32879||Ce===35866)&&n.texParameteri(Ce,32882,Se[xe.wrapR]),n.texParameteri(Ce,10240,Pe[xe.magFilter]),n.texParameteri(Ce,10241,Pe[xe.minFilter])):(n.texParameteri(Ce,10242,33071),n.texParameteri(Ce,10243,33071),(Ce===32879||Ce===35866)&&n.texParameteri(Ce,32882,33071),(xe.wrapS!==nl||xe.wrapT!==nl)&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),n.texParameteri(Ce,10240,j(xe.magFilter)),n.texParameteri(Ce,10241,j(xe.minFilter)),xe.minFilter!==Hs&&xe.minFilter!==Fo&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),e.has("EXT_texture_filter_anisotropic")===!0){const be=e.get("EXT_texture_filter_anisotropic");if(xe.type===Td&&e.has("OES_texture_float_linear")===!1||s===!1&&xe.type===Ig&&e.has("OES_texture_half_float_linear")===!1)return;(xe.anisotropy>1||i.get(xe).__currentAnisotropy)&&(n.texParameterf(Ce,be.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(xe.anisotropy,r.getMaxAnisotropy())),i.get(xe).__currentAnisotropy=xe.anisotropy)}}function Fe(Ce,xe){Ce.__webglInit===void 0&&(Ce.__webglInit=!0,xe.addEventListener("dispose",G),Ce.__webglTexture=n.createTexture(),c.memory.textures++)}function qe(Ce,xe,vt){let be=3553;xe.isDataTexture2DArray&&(be=35866),xe.isDataTexture3D&&(be=32879),Fe(Ce,xe),t.activeTexture(33984+vt),t.bindTexture(be,Ce.__webglTexture),n.pixelStorei(37440,xe.flipY),n.pixelStorei(37441,xe.premultiplyAlpha),n.pixelStorei(3317,xe.unpackAlignment),n.pixelStorei(37443,0);const ie=C(xe)&&E(xe.image)===!1,ae=L(xe.image,ie,!1,g),De=E(ae)||s,Xe=o.convert(xe.format);let bt=o.convert(xe.type),Te=U(xe.internalFormat,Xe,bt,xe.encoding);je(be,xe,De);let te;const he=xe.mipmaps;if(xe.isDepthTexture)Te=6402,s?xe.type===Td?Te=36012:xe.type===Yx?Te=33190:xe.type===my?Te=35056:Te=33189:xe.type===Td&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),xe.format===Rg&&Te===6402&&xe.type!==Mw&&xe.type!==Yx&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),xe.type=Mw,bt=o.convert(xe.type)),xe.format===By&&Te===6402&&(Te=34041,xe.type!==my&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),xe.type=my,bt=o.convert(xe.type))),t.texImage2D(3553,0,Te,ae.width,ae.height,0,Xe,bt,null);else if(xe.isDataTexture)if(he.length>0&&De){for(let pe=0,Re=he.length;pe<Re;pe++)te=he[pe],t.texImage2D(3553,pe,Te,te.width,te.height,0,Xe,bt,te.data);xe.generateMipmaps=!1,Ce.__maxMipLevel=he.length-1}else t.texImage2D(3553,0,Te,ae.width,ae.height,0,Xe,bt,ae.data),Ce.__maxMipLevel=0;else if(xe.isCompressedTexture){for(let pe=0,Re=he.length;pe<Re;pe++)te=he[pe],xe.format!==ca&&xe.format!==up?Xe!==null?t.compressedTexImage2D(3553,pe,Te,te.width,te.height,0,te.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):t.texImage2D(3553,pe,Te,te.width,te.height,0,Xe,bt,te.data);Ce.__maxMipLevel=he.length-1}else if(xe.isDataTexture2DArray)t.texImage3D(35866,0,Te,ae.width,ae.height,ae.depth,0,Xe,bt,ae.data),Ce.__maxMipLevel=0;else if(xe.isDataTexture3D)t.texImage3D(32879,0,Te,ae.width,ae.height,ae.depth,0,Xe,bt,ae.data),Ce.__maxMipLevel=0;else if(he.length>0&&De){for(let pe=0,Re=he.length;pe<Re;pe++)te=he[pe],t.texImage2D(3553,pe,Te,Xe,bt,te);xe.generateMipmaps=!1,Ce.__maxMipLevel=he.length-1}else t.texImage2D(3553,0,Te,Xe,bt,ae),Ce.__maxMipLevel=0;D(xe,De)&&O(be,xe,ae.width,ae.height),Ce.__version=xe.version,xe.onUpdate&&xe.onUpdate(xe)}function Ue(Ce,xe,vt){if(xe.image.length!==6)return;Fe(Ce,xe),t.activeTexture(33984+vt),t.bindTexture(34067,Ce.__webglTexture),n.pixelStorei(37440,xe.flipY),n.pixelStorei(37441,xe.premultiplyAlpha),n.pixelStorei(3317,xe.unpackAlignment),n.pixelStorei(37443,0);const be=xe&&(xe.isCompressedTexture||xe.image[0].isCompressedTexture),ie=xe.image[0]&&xe.image[0].isDataTexture,ae=[];for(let pe=0;pe<6;pe++)!be&&!ie?ae[pe]=L(xe.image[pe],!1,!0,p):ae[pe]=ie?xe.image[pe].image:xe.image[pe];const De=ae[0],Xe=E(De)||s,bt=o.convert(xe.format),Te=o.convert(xe.type),te=U(xe.internalFormat,bt,Te,xe.encoding);je(34067,xe,Xe);let he;if(be){for(let pe=0;pe<6;pe++){he=ae[pe].mipmaps;for(let Re=0;Re<he.length;Re++){const Oe=he[Re];xe.format!==ca&&xe.format!==up?bt!==null?t.compressedTexImage2D(34069+pe,Re,te,Oe.width,Oe.height,0,Oe.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):t.texImage2D(34069+pe,Re,te,Oe.width,Oe.height,0,bt,Te,Oe.data)}}Ce.__maxMipLevel=he.length-1}else{he=xe.mipmaps;for(let pe=0;pe<6;pe++)if(ie){t.texImage2D(34069+pe,0,te,ae[pe].width,ae[pe].height,0,bt,Te,ae[pe].data);for(let Re=0;Re<he.length;Re++){const ht=he[Re].image[pe].image;t.texImage2D(34069+pe,Re+1,te,ht.width,ht.height,0,bt,Te,ht.data)}}else{t.texImage2D(34069+pe,0,te,bt,Te,ae[pe]);for(let Re=0;Re<he.length;Re++){const Oe=he[Re];t.texImage2D(34069+pe,Re+1,te,bt,Te,Oe.image[pe])}}Ce.__maxMipLevel=he.length}D(xe,Xe)&&O(34067,xe,De.width,De.height),Ce.__version=xe.version,xe.onUpdate&&xe.onUpdate(xe)}function ke(Ce,xe,vt,be,ie){const ae=o.convert(vt.format),De=o.convert(vt.type),Xe=U(vt.internalFormat,ae,De,vt.encoding);ie===32879||ie===35866?t.texImage3D(ie,0,Xe,xe.width,xe.height,xe.depth,0,ae,De,null):t.texImage2D(ie,0,Xe,xe.width,xe.height,0,ae,De,null),t.bindFramebuffer(36160,Ce),n.framebufferTexture2D(36160,be,ie,i.get(vt).__webglTexture,0),t.bindFramebuffer(36160,null)}function et(Ce,xe,vt){if(n.bindRenderbuffer(36161,Ce),xe.depthBuffer&&!xe.stencilBuffer){let be=33189;if(vt){const ie=xe.depthTexture;ie&&ie.isDepthTexture&&(ie.type===Td?be=36012:ie.type===Yx&&(be=33190));const ae=we(xe);n.renderbufferStorageMultisample(36161,ae,be,xe.width,xe.height)}else n.renderbufferStorage(36161,be,xe.width,xe.height);n.framebufferRenderbuffer(36160,36096,36161,Ce)}else if(xe.depthBuffer&&xe.stencilBuffer){if(vt){const be=we(xe);n.renderbufferStorageMultisample(36161,be,35056,xe.width,xe.height)}else n.renderbufferStorage(36161,34041,xe.width,xe.height);n.framebufferRenderbuffer(36160,33306,36161,Ce)}else{const be=xe.isWebGLMultipleRenderTargets===!0?xe.texture[0]:xe.texture,ie=o.convert(be.format),ae=o.convert(be.type),De=U(be.internalFormat,ie,ae,be.encoding);if(vt){const Xe=we(xe);n.renderbufferStorageMultisample(36161,Xe,De,xe.width,xe.height)}else n.renderbufferStorage(36161,De,xe.width,xe.height)}n.bindRenderbuffer(36161,null)}function ye(Ce,xe){if(xe&&xe.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(36160,Ce),!(xe.depthTexture&&xe.depthTexture.isDepthTexture))throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");(!i.get(xe.depthTexture).__webglTexture||xe.depthTexture.image.width!==xe.width||xe.depthTexture.image.height!==xe.height)&&(xe.depthTexture.image.width=xe.width,xe.depthTexture.image.height=xe.height,xe.depthTexture.needsUpdate=!0),re(xe.depthTexture,0);const be=i.get(xe.depthTexture).__webglTexture;if(xe.depthTexture.format===Rg)n.framebufferTexture2D(36160,36096,3553,be,0);else if(xe.depthTexture.format===By)n.framebufferTexture2D(36160,33306,3553,be,0);else throw new Error("Unknown depthTexture format")}function Be(Ce){const xe=i.get(Ce),vt=Ce.isWebGLCubeRenderTarget===!0;if(Ce.depthTexture){if(vt)throw new Error("target.depthTexture not supported in Cube render targets");ye(xe.__webglFramebuffer,Ce)}else if(vt){xe.__webglDepthbuffer=[];for(let be=0;be<6;be++)t.bindFramebuffer(36160,xe.__webglFramebuffer[be]),xe.__webglDepthbuffer[be]=n.createRenderbuffer(),et(xe.__webglDepthbuffer[be],Ce,!1)}else t.bindFramebuffer(36160,xe.__webglFramebuffer),xe.__webglDepthbuffer=n.createRenderbuffer(),et(xe.__webglDepthbuffer,Ce,!1);t.bindFramebuffer(36160,null)}function Je(Ce){const xe=Ce.texture,vt=i.get(Ce),be=i.get(xe);Ce.addEventListener("dispose",N),Ce.isWebGLMultipleRenderTargets!==!0&&(be.__webglTexture=n.createTexture(),be.__version=xe.version,c.memory.textures++);const ie=Ce.isWebGLCubeRenderTarget===!0,ae=Ce.isWebGLMultipleRenderTargets===!0,De=Ce.isWebGLMultisampleRenderTarget===!0,Xe=xe.isDataTexture3D||xe.isDataTexture2DArray,bt=E(Ce)||s;if(s&&xe.format===up&&(xe.type===Td||xe.type===Ig)&&(xe.format=ca,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),ie){vt.__webglFramebuffer=[];for(let Te=0;Te<6;Te++)vt.__webglFramebuffer[Te]=n.createFramebuffer()}else if(vt.__webglFramebuffer=n.createFramebuffer(),ae)if(r.drawBuffers){const Te=Ce.texture;for(let te=0,he=Te.length;te<he;te++){const pe=i.get(Te[te]);pe.__webglTexture===void 0&&(pe.__webglTexture=n.createTexture(),c.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");else if(De)if(s){vt.__webglMultisampledFramebuffer=n.createFramebuffer(),vt.__webglColorRenderbuffer=n.createRenderbuffer(),n.bindRenderbuffer(36161,vt.__webglColorRenderbuffer);const Te=o.convert(xe.format),te=o.convert(xe.type),he=U(xe.internalFormat,Te,te,xe.encoding),pe=we(Ce);n.renderbufferStorageMultisample(36161,pe,he,Ce.width,Ce.height),t.bindFramebuffer(36160,vt.__webglMultisampledFramebuffer),n.framebufferRenderbuffer(36160,36064,36161,vt.__webglColorRenderbuffer),n.bindRenderbuffer(36161,null),Ce.depthBuffer&&(vt.__webglDepthRenderbuffer=n.createRenderbuffer(),et(vt.__webglDepthRenderbuffer,Ce,!0)),t.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(ie){t.bindTexture(34067,be.__webglTexture),je(34067,xe,bt);for(let Te=0;Te<6;Te++)ke(vt.__webglFramebuffer[Te],Ce,xe,36064,34069+Te);D(xe,bt)&&O(34067,xe,Ce.width,Ce.height),t.unbindTexture()}else if(ae){const Te=Ce.texture;for(let te=0,he=Te.length;te<he;te++){const pe=Te[te],Re=i.get(pe);t.bindTexture(3553,Re.__webglTexture),je(3553,pe,bt),ke(vt.__webglFramebuffer,Ce,pe,36064+te,3553),D(pe,bt)&&O(3553,pe,Ce.width,Ce.height)}t.unbindTexture()}else{let Te=3553;Xe&&(s?Te=xe.isDataTexture3D?32879:35866:console.warn("THREE.DataTexture3D and THREE.DataTexture2DArray only supported with WebGL2.")),t.bindTexture(Te,be.__webglTexture),je(Te,xe,bt),ke(vt.__webglFramebuffer,Ce,xe,36064,Te),D(xe,bt)&&O(Te,xe,Ce.width,Ce.height,Ce.depth),t.unbindTexture()}Ce.depthBuffer&&Be(Ce)}function ct(Ce){const xe=E(Ce)||s,vt=Ce.isWebGLMultipleRenderTargets===!0?Ce.texture:[Ce.texture];for(let be=0,ie=vt.length;be<ie;be++){const ae=vt[be];if(D(ae,xe)){const De=Ce.isWebGLCubeRenderTarget?34067:3553,Xe=i.get(ae).__webglTexture;t.bindTexture(De,Xe),O(De,ae,Ce.width,Ce.height),t.unbindTexture()}}}function yt(Ce){if(Ce.isWebGLMultisampleRenderTarget)if(s){const xe=Ce.width,vt=Ce.height;let be=16384;Ce.depthBuffer&&(be|=256),Ce.stencilBuffer&&(be|=1024);const ie=i.get(Ce);t.bindFramebuffer(36008,ie.__webglMultisampledFramebuffer),t.bindFramebuffer(36009,ie.__webglFramebuffer),n.blitFramebuffer(0,0,xe,vt,0,0,xe,vt,be,9728),t.bindFramebuffer(36008,null),t.bindFramebuffer(36009,ie.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")}function we(Ce){return s&&Ce.isWebGLMultisampleRenderTarget?Math.min(_,Ce.samples):0}function fe(Ce){const xe=c.render.frame;x.get(Ce)!==xe&&(x.set(Ce,xe),Ce.update())}let Ve=!1,tt=!1;function Mt(Ce,xe){Ce&&Ce.isWebGLRenderTarget&&(Ve===!1&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),Ve=!0),Ce=Ce.texture),re(Ce,xe)}function mt(Ce,xe){Ce&&Ce.isWebGLCubeRenderTarget&&(tt===!1&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),tt=!0),Ce=Ce.texture),ce(Ce,xe)}this.allocateTextureUnit=X,this.resetTextureUnits=Q,this.setTexture2D=re,this.setTexture2DArray=oe,this.setTexture3D=de,this.setTextureCube=ce,this.setupRenderTarget=Je,this.updateRenderTargetMipmap=ct,this.updateMultisampleRenderTarget=yt,this.safeSetTexture2D=Mt,this.safeSetTextureCube=mt}function gJ(n,e,t){const i=t.isWebGL2;function r(o){let c;if(o===$d)return 5121;if(o===AH)return 32819;if(o===PH)return 32820;if(o===IH)return 33635;if(o===MH)return 5120;if(o===CH)return 5122;if(o===Mw)return 5123;if(o===EH)return 5124;if(o===Yx)return 5125;if(o===Td)return 5126;if(o===Ig)return i?5131:(c=e.get("OES_texture_half_float"),c!==null?c.HALF_FLOAT_OES:null);if(o===RH)return 6406;if(o===up)return 6407;if(o===ca)return 6408;if(o===LH)return 6409;if(o===kH)return 6410;if(o===Rg)return 6402;if(o===By)return 34041;if(o===FH)return 6403;if(o===OH)return 36244;if(o===zH)return 33319;if(o===BH)return 33320;if(o===NH)return 36248;if(o===$H)return 36249;if(o===VR||o===UR||o===jR||o===GR)if(c=e.get("WEBGL_compressed_texture_s3tc"),c!==null){if(o===VR)return c.COMPRESSED_RGB_S3TC_DXT1_EXT;if(o===UR)return c.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(o===jR)return c.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(o===GR)return c.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(o===qR||o===WR||o===HR||o===ZR)if(c=e.get("WEBGL_compressed_texture_pvrtc"),c!==null){if(o===qR)return c.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(o===WR)return c.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(o===HR)return c.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(o===ZR)return c.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null;if(o===VH)return c=e.get("WEBGL_compressed_texture_etc1"),c!==null?c.COMPRESSED_RGB_ETC1_WEBGL:null;if((o===XR||o===YR)&&(c=e.get("WEBGL_compressed_texture_etc"),c!==null)){if(o===XR)return c.COMPRESSED_RGB8_ETC2;if(o===YR)return c.COMPRESSED_RGBA8_ETC2_EAC}if(o===UH||o===jH||o===GH||o===qH||o===WH||o===HH||o===ZH||o===XH||o===YH||o===KH||o===JH||o===QH||o===e9||o===t9||o===n9||o===r9||o===s9||o===o9||o===a9||o===l9||o===c9||o===u9||o===h9||o===d9||o===f9||o===p9||o===m9||o===g9)return c=e.get("WEBGL_compressed_texture_astc"),c!==null?o:null;if(o===i9)return c=e.get("EXT_texture_compression_bptc"),c!==null?o:null;if(o===my)return i?34042:(c=e.get("WEBGL_depth_texture"),c!==null?c.UNSIGNED_INT_24_8_WEBGL:null)}return{convert:r}}class Cz extends na{constructor(e=[]){super(),this.cameras=e}}Cz.prototype.isArrayCamera=!0;class Kv extends Ln{constructor(){super(),this.type="Group"}}Kv.prototype.isGroup=!0;const _J={type:"move"};class tM{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new Kv,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new Kv,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Ge,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Ge),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new Kv,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Ge,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Ge),this._grip}dispatchEvent(e){return this._targetRay!==null&&this._targetRay.dispatchEvent(e),this._grip!==null&&this._grip.dispatchEvent(e),this._hand!==null&&this._hand.dispatchEvent(e),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(e,t,i){let r=null,o=null,c=null;const s=this._targetRay,d=this._grip,p=this._hand;if(e&&t.session.visibilityState!=="visible-blurred")if(s!==null&&(r=t.getPose(e.targetRaySpace,i),r!==null&&(s.matrix.fromArray(r.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale),r.linearVelocity?(s.hasLinearVelocity=!0,s.linearVelocity.copy(r.linearVelocity)):s.hasLinearVelocity=!1,r.angularVelocity?(s.hasAngularVelocity=!0,s.angularVelocity.copy(r.angularVelocity)):s.hasAngularVelocity=!1,this.dispatchEvent(_J))),p&&e.hand){c=!0;for(const P of e.hand.values()){const L=t.getJointPose(P,i);if(p.joints[P.jointName]===void 0){const C=new Kv;C.matrixAutoUpdate=!1,C.visible=!1,p.joints[P.jointName]=C,p.add(C)}const E=p.joints[P.jointName];L!==null&&(E.matrix.fromArray(L.transform.matrix),E.matrix.decompose(E.position,E.rotation,E.scale),E.jointRadius=L.radius),E.visible=L!==null}const g=p.joints["index-finger-tip"],_=p.joints["thumb-tip"],x=g.position.distanceTo(_.position),b=.02,S=.005;p.inputState.pinching&&x>b+S?(p.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!p.inputState.pinching&&x<=b-S&&(p.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else d!==null&&e.gripSpace&&(o=t.getPose(e.gripSpace,i),o!==null&&(d.matrix.fromArray(o.transform.matrix),d.matrix.decompose(d.position,d.rotation,d.scale),o.linearVelocity?(d.hasLinearVelocity=!0,d.linearVelocity.copy(o.linearVelocity)):d.hasLinearVelocity=!1,o.angularVelocity?(d.hasAngularVelocity=!0,d.angularVelocity.copy(o.angularVelocity)):d.hasAngularVelocity=!1));return s!==null&&(s.visible=r!==null),d!==null&&(d.visible=o!==null),p!==null&&(p.visible=c!==null),this}}class vJ extends Mp{constructor(e,t){super();const i=this,r=e.state;let o=null,c=1,s=null,d="local-floor",p=null,g=null,_=null,x=null,b=null,S=!1,P=null,L=null,E=null,C=null,D=null,O=null;const U=[],j=new Map,G=new na;G.layers.enable(1),G.viewport=new Xn;const N=new na;N.layers.enable(2),N.viewport=new Xn;const V=[G,N],q=new Cz;q.layers.enable(1),q.layers.enable(2);let z=null,Q=null;this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(Ue){let ke=U[Ue];return ke===void 0&&(ke=new tM,U[Ue]=ke),ke.getTargetRaySpace()},this.getControllerGrip=function(Ue){let ke=U[Ue];return ke===void 0&&(ke=new tM,U[Ue]=ke),ke.getGripSpace()},this.getHand=function(Ue){let ke=U[Ue];return ke===void 0&&(ke=new tM,U[Ue]=ke),ke.getHandSpace()};function X(Ue){const ke=j.get(Ue.inputSource);ke&&ke.dispatchEvent({type:Ue.type,data:Ue.inputSource})}function re(){j.forEach(function(Ue,ke){Ue.disconnect(ke)}),j.clear(),z=null,Q=null,r.bindXRFramebuffer(null),e.setRenderTarget(e.getRenderTarget()),_&&t.deleteFramebuffer(_),P&&t.deleteFramebuffer(P),L&&t.deleteRenderbuffer(L),E&&t.deleteRenderbuffer(E),_=null,P=null,L=null,E=null,b=null,x=null,g=null,o=null,qe.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}this.setFramebufferScaleFactor=function(Ue){c=Ue,i.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(Ue){d=Ue,i.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return s},this.getBaseLayer=function(){return x!==null?x:b},this.getBinding=function(){return g},this.getFrame=function(){return C},this.getSession=function(){return o},this.setSession=async function(Ue){if(o=Ue,o!==null){o.addEventListener("select",X),o.addEventListener("selectstart",X),o.addEventListener("selectend",X),o.addEventListener("squeeze",X),o.addEventListener("squeezestart",X),o.addEventListener("squeezeend",X),o.addEventListener("end",re),o.addEventListener("inputsourceschange",oe);const ke=t.getContextAttributes();if(ke.xrCompatible!==!0&&await t.makeXRCompatible(),o.renderState.layers===void 0){const et={antialias:ke.antialias,alpha:ke.alpha,depth:ke.depth,stencil:ke.stencil,framebufferScaleFactor:c};b=new XRWebGLLayer(o,t,et),o.updateRenderState({baseLayer:b})}else if(t instanceof WebGLRenderingContext){const et={antialias:!0,alpha:ke.alpha,depth:ke.depth,stencil:ke.stencil,framebufferScaleFactor:c};b=new XRWebGLLayer(o,t,et),o.updateRenderState({layers:[b]})}else{S=ke.antialias;let et=null;ke.depth&&(O=256,ke.stencil&&(O|=1024),D=ke.stencil?33306:36096,et=ke.stencil?35056:33190);const ye={colorFormat:ke.alpha?32856:32849,depthFormat:et,scaleFactor:c};g=new XRWebGLBinding(o,t),x=g.createProjectionLayer(ye),_=t.createFramebuffer(),o.updateRenderState({layers:[x]}),S&&(P=t.createFramebuffer(),L=t.createRenderbuffer(),t.bindRenderbuffer(36161,L),t.renderbufferStorageMultisample(36161,4,32856,x.textureWidth,x.textureHeight),r.bindFramebuffer(36160,P),t.framebufferRenderbuffer(36160,36064,36161,L),t.bindRenderbuffer(36161,null),et!==null&&(E=t.createRenderbuffer(),t.bindRenderbuffer(36161,E),t.renderbufferStorageMultisample(36161,4,et,x.textureWidth,x.textureHeight),t.framebufferRenderbuffer(36160,D,36161,E),t.bindRenderbuffer(36161,null)),r.bindFramebuffer(36160,null))}s=await o.requestReferenceSpace(d),qe.setContext(o),qe.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}};function oe(Ue){const ke=o.inputSources;for(let et=0;et<U.length;et++)j.set(ke[et],U[et]);for(let et=0;et<Ue.removed.length;et++){const ye=Ue.removed[et],Be=j.get(ye);Be&&(Be.dispatchEvent({type:"disconnected",data:ye}),j.delete(ye))}for(let et=0;et<Ue.added.length;et++){const ye=Ue.added[et],Be=j.get(ye);Be&&Be.dispatchEvent({type:"connected",data:ye})}}const de=new Ge,ce=new Ge;function Se(Ue,ke,et){de.setFromMatrixPosition(ke.matrixWorld),ce.setFromMatrixPosition(et.matrixWorld);const ye=de.distanceTo(ce),Be=ke.projectionMatrix.elements,Je=et.projectionMatrix.elements,ct=Be[14]/(Be[10]-1),yt=Be[14]/(Be[10]+1),we=(Be[9]+1)/Be[5],fe=(Be[9]-1)/Be[5],Ve=(Be[8]-1)/Be[0],tt=(Je[8]+1)/Je[0],Mt=ct*Ve,mt=ct*tt,Ce=ye/(-Ve+tt),xe=Ce*-Ve;ke.matrixWorld.decompose(Ue.position,Ue.quaternion,Ue.scale),Ue.translateX(xe),Ue.translateZ(Ce),Ue.matrixWorld.compose(Ue.position,Ue.quaternion,Ue.scale),Ue.matrixWorldInverse.copy(Ue.matrixWorld).invert();const vt=ct+Ce,be=yt+Ce,ie=Mt-xe,ae=mt+(ye-xe),De=we*yt/be*vt,Xe=fe*yt/be*vt;Ue.projectionMatrix.makePerspective(ie,ae,De,Xe,vt,be)}function Pe(Ue,ke){ke===null?Ue.matrixWorld.copy(Ue.matrix):Ue.matrixWorld.multiplyMatrices(ke.matrixWorld,Ue.matrix),Ue.matrixWorldInverse.copy(Ue.matrixWorld).invert()}this.updateCamera=function(Ue){if(o===null)return;q.near=N.near=G.near=Ue.near,q.far=N.far=G.far=Ue.far,(z!==q.near||Q!==q.far)&&(o.updateRenderState({depthNear:q.near,depthFar:q.far}),z=q.near,Q=q.far);const ke=Ue.parent,et=q.cameras;Pe(q,ke);for(let Be=0;Be<et.length;Be++)Pe(et[Be],ke);q.matrixWorld.decompose(q.position,q.quaternion,q.scale),Ue.position.copy(q.position),Ue.quaternion.copy(q.quaternion),Ue.scale.copy(q.scale),Ue.matrix.copy(q.matrix),Ue.matrixWorld.copy(q.matrixWorld);const ye=Ue.children;for(let Be=0,Je=ye.length;Be<Je;Be++)ye[Be].updateMatrixWorld(!0);et.length===2?Se(q,G,N):q.projectionMatrix.copy(G.projectionMatrix)},this.getCamera=function(){return q},this.getFoveation=function(){if(x!==null)return x.fixedFoveation;if(b!==null)return b.fixedFoveation},this.setFoveation=function(Ue){x!==null&&(x.fixedFoveation=Ue),b!==null&&b.fixedFoveation!==void 0&&(b.fixedFoveation=Ue)};let je=null;function Fe(Ue,ke){if(p=ke.getViewerPose(s),C=ke,p!==null){const ye=p.views;b!==null&&r.bindXRFramebuffer(b.framebuffer);let Be=!1;ye.length!==q.cameras.length&&(q.cameras.length=0,Be=!0);for(let Je=0;Je<ye.length;Je++){const ct=ye[Je];let yt=null;if(b!==null)yt=b.getViewport(ct);else{const fe=g.getViewSubImage(x,ct);r.bindXRFramebuffer(_),fe.depthStencilTexture!==void 0&&t.framebufferTexture2D(36160,D,3553,fe.depthStencilTexture,0),t.framebufferTexture2D(36160,36064,3553,fe.colorTexture,0),yt=fe.viewport}const we=V[Je];we.matrix.fromArray(ct.transform.matrix),we.projectionMatrix.fromArray(ct.projectionMatrix),we.viewport.set(yt.x,yt.y,yt.width,yt.height),Je===0&&q.matrix.copy(we.matrix),Be===!0&&q.cameras.push(we)}S&&(r.bindXRFramebuffer(P),O!==null&&t.clear(O))}const et=o.inputSources;for(let ye=0;ye<U.length;ye++){const Be=U[ye],Je=et[ye];Be.update(Je,ke,s)}if(je&&je(Ue,ke),S){const ye=x.textureWidth,Be=x.textureHeight;r.bindFramebuffer(36008,P),r.bindFramebuffer(36009,_),t.invalidateFramebuffer(36008,[D]),t.invalidateFramebuffer(36009,[D]),t.blitFramebuffer(0,0,ye,Be,0,0,ye,Be,16384,9728),t.invalidateFramebuffer(36008,[36064]),r.bindFramebuffer(36008,null),r.bindFramebuffer(36009,null),r.bindFramebuffer(36160,P)}C=null}const qe=new dz;qe.setAnimationLoop(Fe),this.setAnimationLoop=function(Ue){je=Ue},this.dispose=function(){}}}function yJ(n){function e(E,C){E.fogColor.value.copy(C.color),C.isFog?(E.fogNear.value=C.near,E.fogFar.value=C.far):C.isFogExp2&&(E.fogDensity.value=C.density)}function t(E,C,D,O,U){C.isMeshBasicMaterial?i(E,C):C.isMeshLambertMaterial?(i(E,C),d(E,C)):C.isMeshToonMaterial?(i(E,C),g(E,C)):C.isMeshPhongMaterial?(i(E,C),p(E,C)):C.isMeshStandardMaterial?(i(E,C),C.isMeshPhysicalMaterial?x(E,C,U):_(E,C)):C.isMeshMatcapMaterial?(i(E,C),b(E,C)):C.isMeshDepthMaterial?(i(E,C),S(E,C)):C.isMeshDistanceMaterial?(i(E,C),P(E,C)):C.isMeshNormalMaterial?(i(E,C),L(E,C)):C.isLineBasicMaterial?(r(E,C),C.isLineDashedMaterial&&o(E,C)):C.isPointsMaterial?c(E,C,D,O):C.isSpriteMaterial?s(E,C):C.isShadowMaterial?(E.color.value.copy(C.color),E.opacity.value=C.opacity):C.isShaderMaterial&&(C.uniformsNeedUpdate=!1)}function i(E,C){E.opacity.value=C.opacity,C.color&&E.diffuse.value.copy(C.color),C.emissive&&E.emissive.value.copy(C.emissive).multiplyScalar(C.emissiveIntensity),C.map&&(E.map.value=C.map),C.alphaMap&&(E.alphaMap.value=C.alphaMap),C.specularMap&&(E.specularMap.value=C.specularMap),C.alphaTest>0&&(E.alphaTest.value=C.alphaTest);const D=n.get(C).envMap;if(D){E.envMap.value=D,E.flipEnvMap.value=D.isCubeTexture&&D.isRenderTargetTexture===!1?-1:1,E.reflectivity.value=C.reflectivity,E.ior.value=C.ior,E.refractionRatio.value=C.refractionRatio;const j=n.get(D).__maxMipLevel;j!==void 0&&(E.maxMipLevel.value=j)}C.lightMap&&(E.lightMap.value=C.lightMap,E.lightMapIntensity.value=C.lightMapIntensity),C.aoMap&&(E.aoMap.value=C.aoMap,E.aoMapIntensity.value=C.aoMapIntensity);let O;C.map?O=C.map:C.specularMap?O=C.specularMap:C.displacementMap?O=C.displacementMap:C.normalMap?O=C.normalMap:C.bumpMap?O=C.bumpMap:C.roughnessMap?O=C.roughnessMap:C.metalnessMap?O=C.metalnessMap:C.alphaMap?O=C.alphaMap:C.emissiveMap?O=C.emissiveMap:C.clearcoatMap?O=C.clearcoatMap:C.clearcoatNormalMap?O=C.clearcoatNormalMap:C.clearcoatRoughnessMap?O=C.clearcoatRoughnessMap:C.specularIntensityMap?O=C.specularIntensityMap:C.specularColorMap?O=C.specularColorMap:C.transmissionMap?O=C.transmissionMap:C.thicknessMap?O=C.thicknessMap:C.sheenColorMap?O=C.sheenColorMap:C.sheenRoughnessMap&&(O=C.sheenRoughnessMap),O!==void 0&&(O.isWebGLRenderTarget&&(O=O.texture),O.matrixAutoUpdate===!0&&O.updateMatrix(),E.uvTransform.value.copy(O.matrix));let U;C.aoMap?U=C.aoMap:C.lightMap&&(U=C.lightMap),U!==void 0&&(U.isWebGLRenderTarget&&(U=U.texture),U.matrixAutoUpdate===!0&&U.updateMatrix(),E.uv2Transform.value.copy(U.matrix))}function r(E,C){E.diffuse.value.copy(C.color),E.opacity.value=C.opacity}function o(E,C){E.dashSize.value=C.dashSize,E.totalSize.value=C.dashSize+C.gapSize,E.scale.value=C.scale}function c(E,C,D,O){E.diffuse.value.copy(C.color),E.opacity.value=C.opacity,E.size.value=C.size*D,E.scale.value=O*.5,C.map&&(E.map.value=C.map),C.alphaMap&&(E.alphaMap.value=C.alphaMap),C.alphaTest>0&&(E.alphaTest.value=C.alphaTest);let U;C.map?U=C.map:C.alphaMap&&(U=C.alphaMap),U!==void 0&&(U.matrixAutoUpdate===!0&&U.updateMatrix(),E.uvTransform.value.copy(U.matrix))}function s(E,C){E.diffuse.value.copy(C.color),E.opacity.value=C.opacity,E.rotation.value=C.rotation,C.map&&(E.map.value=C.map),C.alphaMap&&(E.alphaMap.value=C.alphaMap),C.alphaTest>0&&(E.alphaTest.value=C.alphaTest);let D;C.map?D=C.map:C.alphaMap&&(D=C.alphaMap),D!==void 0&&(D.matrixAutoUpdate===!0&&D.updateMatrix(),E.uvTransform.value.copy(D.matrix))}function d(E,C){C.emissiveMap&&(E.emissiveMap.value=C.emissiveMap)}function p(E,C){E.specular.value.copy(C.specular),E.shininess.value=Math.max(C.shininess,1e-4),C.emissiveMap&&(E.emissiveMap.value=C.emissiveMap),C.bumpMap&&(E.bumpMap.value=C.bumpMap,E.bumpScale.value=C.bumpScale,C.side===Gs&&(E.bumpScale.value*=-1)),C.normalMap&&(E.normalMap.value=C.normalMap,E.normalScale.value.copy(C.normalScale),C.side===Gs&&E.normalScale.value.negate()),C.displacementMap&&(E.displacementMap.value=C.displacementMap,E.displacementScale.value=C.displacementScale,E.displacementBias.value=C.displacementBias)}function g(E,C){C.gradientMap&&(E.gradientMap.value=C.gradientMap),C.emissiveMap&&(E.emissiveMap.value=C.emissiveMap),C.bumpMap&&(E.bumpMap.value=C.bumpMap,E.bumpScale.value=C.bumpScale,C.side===Gs&&(E.bumpScale.value*=-1)),C.normalMap&&(E.normalMap.value=C.normalMap,E.normalScale.value.copy(C.normalScale),C.side===Gs&&E.normalScale.value.negate()),C.displacementMap&&(E.displacementMap.value=C.displacementMap,E.displacementScale.value=C.displacementScale,E.displacementBias.value=C.displacementBias)}function _(E,C){E.roughness.value=C.roughness,E.metalness.value=C.metalness,C.roughnessMap&&(E.roughnessMap.value=C.roughnessMap),C.metalnessMap&&(E.metalnessMap.value=C.metalnessMap),C.emissiveMap&&(E.emissiveMap.value=C.emissiveMap),C.bumpMap&&(E.bumpMap.value=C.bumpMap,E.bumpScale.value=C.bumpScale,C.side===Gs&&(E.bumpScale.value*=-1)),C.normalMap&&(E.normalMap.value=C.normalMap,E.normalScale.value.copy(C.normalScale),C.side===Gs&&E.normalScale.value.negate()),C.displacementMap&&(E.displacementMap.value=C.displacementMap,E.displacementScale.value=C.displacementScale,E.displacementBias.value=C.displacementBias),n.get(C).envMap&&(E.envMapIntensity.value=C.envMapIntensity)}function x(E,C,D){_(E,C),E.ior.value=C.ior,C.sheen>0&&(E.sheenColor.value.copy(C.sheenColor).multiplyScalar(C.sheen),E.sheenRoughness.value=C.sheenRoughness,C.sheenColorMap&&(E.sheenColorMap.value=C.sheenColorMap),C.sheenRoughnessMap&&(E.sheenRoughnessMap.value=C.sheenRoughnessMap)),C.clearcoat>0&&(E.clearcoat.value=C.clearcoat,E.clearcoatRoughness.value=C.clearcoatRoughness,C.clearcoatMap&&(E.clearcoatMap.value=C.clearcoatMap),C.clearcoatRoughnessMap&&(E.clearcoatRoughnessMap.value=C.clearcoatRoughnessMap),C.clearcoatNormalMap&&(E.clearcoatNormalScale.value.copy(C.clearcoatNormalScale),E.clearcoatNormalMap.value=C.clearcoatNormalMap,C.side===Gs&&E.clearcoatNormalScale.value.negate())),C.transmission>0&&(E.transmission.value=C.transmission,E.transmissionSamplerMap.value=D.texture,E.transmissionSamplerSize.value.set(D.width,D.height),C.transmissionMap&&(E.transmissionMap.value=C.transmissionMap),E.thickness.value=C.thickness,C.thicknessMap&&(E.thicknessMap.value=C.thicknessMap),E.attenuationDistance.value=C.attenuationDistance,E.attenuationColor.value.copy(C.attenuationColor)),E.specularIntensity.value=C.specularIntensity,E.specularColor.value.copy(C.specularColor),C.specularIntensityMap&&(E.specularIntensityMap.value=C.specularIntensityMap),C.specularColorMap&&(E.specularColorMap.value=C.specularColorMap)}function b(E,C){C.matcap&&(E.matcap.value=C.matcap),C.bumpMap&&(E.bumpMap.value=C.bumpMap,E.bumpScale.value=C.bumpScale,C.side===Gs&&(E.bumpScale.value*=-1)),C.normalMap&&(E.normalMap.value=C.normalMap,E.normalScale.value.copy(C.normalScale),C.side===Gs&&E.normalScale.value.negate()),C.displacementMap&&(E.displacementMap.value=C.displacementMap,E.displacementScale.value=C.displacementScale,E.displacementBias.value=C.displacementBias)}function S(E,C){C.displacementMap&&(E.displacementMap.value=C.displacementMap,E.displacementScale.value=C.displacementScale,E.displacementBias.value=C.displacementBias)}function P(E,C){C.displacementMap&&(E.displacementMap.value=C.displacementMap,E.displacementScale.value=C.displacementScale,E.displacementBias.value=C.displacementBias),E.referencePosition.value.copy(C.referencePosition),E.nearDistance.value=C.nearDistance,E.farDistance.value=C.farDistance}function L(E,C){C.bumpMap&&(E.bumpMap.value=C.bumpMap,E.bumpScale.value=C.bumpScale,C.side===Gs&&(E.bumpScale.value*=-1)),C.normalMap&&(E.normalMap.value=C.normalMap,E.normalScale.value.copy(C.normalScale),C.side===Gs&&E.normalScale.value.negate()),C.displacementMap&&(E.displacementMap.value=C.displacementMap,E.displacementScale.value=C.displacementScale,E.displacementBias.value=C.displacementBias)}return{refreshFogUniforms:e,refreshMaterialUniforms:t}}function bJ(){const n=f1("canvas");return n.style.display="block",n}function dr(n={}){const e=n.canvas!==void 0?n.canvas:bJ(),t=n.context!==void 0?n.context:null,i=n.alpha!==void 0?n.alpha:!1,r=n.depth!==void 0?n.depth:!0,o=n.stencil!==void 0?n.stencil:!0,c=n.antialias!==void 0?n.antialias:!1,s=n.premultipliedAlpha!==void 0?n.premultipliedAlpha:!0,d=n.preserveDrawingBuffer!==void 0?n.preserveDrawingBuffer:!1,p=n.powerPreference!==void 0?n.powerPreference:"default",g=n.failIfMajorPerformanceCaveat!==void 0?n.failIfMajorPerformanceCaveat:!1;let _=null,x=null;const b=[],S=[];this.domElement=e,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=Bo,this.physicallyCorrectLights=!1,this.toneMapping=cp,this.toneMappingExposure=1;const P=this;let L=!1,E=0,C=0,D=null,O=-1,U=null;const j=new Xn,G=new Xn;let N=null,V=e.width,q=e.height,z=1,Q=null,X=null;const re=new Xn(0,0,V,q),oe=new Xn(0,0,V,q);let de=!1;const ce=[],Se=new m1;let Pe=!1,je=!1,Fe=null;const qe=new ki,Ue=new Ge,ke={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function et(){return D===null?z:1}let ye=t;function Be(Ye,kt){for(let at=0;at<Ye.length;at++){const Ot=Ye[at],Gt=e.getContext(Ot,kt);if(Gt!==null)return Gt}return null}try{const Ye={alpha:i,depth:r,stencil:o,antialias:c,premultipliedAlpha:s,preserveDrawingBuffer:d,powerPreference:p,failIfMajorPerformanceCaveat:g};if(e.addEventListener("webglcontextlost",pt,!1),e.addEventListener("webglcontextrestored",ot,!1),ye===null){const kt=["webgl2","webgl","experimental-webgl"];if(P.isWebGL1Renderer===!0&&kt.shift(),ye=Be(kt,Ye),ye===null)throw Be(kt)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}ye.getShaderPrecisionFormat===void 0&&(ye.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(Ye){throw console.error("THREE.WebGLRenderer: "+Ye.message),Ye}let Je,ct,yt,we,fe,Ve,tt,Mt,mt,Ce,xe,vt,be,ie,ae,De,Xe,bt,Te,te,he,pe,Re;function Oe(){Je=new jY(ye),ct=new FY(ye,Je,n),Je.init(ct),pe=new gJ(ye,Je,ct),yt=new pJ(ye,Je,ct),ce[0]=1029,we=new WY,fe=new nJ,Ve=new mJ(ye,Je,yt,fe,ct,pe,we),tt=new zY(P),Mt=new UY(P),mt=new sZ(ye,ct),Re=new kY(ye,Je,mt,ct),Ce=new GY(ye,mt,we,Re),xe=new YY(ye,Ce,mt,we),Te=new XY(ye,ct,Ve),De=new OY(fe),vt=new iJ(P,tt,Mt,Je,ct,Re,De),be=new yJ(fe),ie=new sJ(fe),ae=new hJ(Je,ct),bt=new LY(P,tt,yt,xe,s),Xe=new Mz(P,xe,ct),te=new DY(ye,Je,we,ct),he=new qY(ye,Je,we,ct),we.programs=vt.programs,P.capabilities=ct,P.extensions=Je,P.properties=fe,P.renderLists=ie,P.shadowMap=Xe,P.state=yt,P.info=we}Oe();const ht=new vJ(P,ye);this.xr=ht,this.getContext=function(){return ye},this.getContextAttributes=function(){return ye.getContextAttributes()},this.forceContextLoss=function(){const Ye=Je.get("WEBGL_lose_context");Ye&&Ye.loseContext()},this.forceContextRestore=function(){const Ye=Je.get("WEBGL_lose_context");Ye&&Ye.restoreContext()},this.getPixelRatio=function(){return z},this.setPixelRatio=function(Ye){Ye!==void 0&&(z=Ye,this.setSize(V,q,!1))},this.getSize=function(Ye){return Ye.set(V,q)},this.setSize=function(Ye,kt,at){if(ht.isPresenting){console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting.");return}V=Ye,q=kt,e.width=Math.floor(Ye*z),e.height=Math.floor(kt*z),at!==!1&&(e.style.width=Ye+"px",e.style.height=kt+"px"),this.setViewport(0,0,Ye,kt)},this.getDrawingBufferSize=function(Ye){return Ye.set(V*z,q*z).floor()},this.setDrawingBufferSize=function(Ye,kt,at){V=Ye,q=kt,z=at,e.width=Math.floor(Ye*at),e.height=Math.floor(kt*at),this.setViewport(0,0,Ye,kt)},this.getCurrentViewport=function(Ye){return Ye.copy(j)},this.getViewport=function(Ye){return Ye.copy(re)},this.setViewport=function(Ye,kt,at,Ot){Ye.isVector4?re.set(Ye.x,Ye.y,Ye.z,Ye.w):re.set(Ye,kt,at,Ot),yt.viewport(j.copy(re).multiplyScalar(z).floor())},this.getScissor=function(Ye){return Ye.copy(oe)},this.setScissor=function(Ye,kt,at,Ot){Ye.isVector4?oe.set(Ye.x,Ye.y,Ye.z,Ye.w):oe.set(Ye,kt,at,Ot),yt.scissor(G.copy(oe).multiplyScalar(z).floor())},this.getScissorTest=function(){return de},this.setScissorTest=function(Ye){yt.setScissorTest(de=Ye)},this.setOpaqueSort=function(Ye){Q=Ye},this.setTransparentSort=function(Ye){X=Ye},this.getClearColor=function(Ye){return Ye.copy(bt.getClearColor())},this.setClearColor=function(){bt.setClearColor.apply(bt,arguments)},this.getClearAlpha=function(){return bt.getClearAlpha()},this.setClearAlpha=function(){bt.setClearAlpha.apply(bt,arguments)},this.clear=function(Ye,kt,at){let Ot=0;(Ye===void 0||Ye)&&(Ot|=16384),(kt===void 0||kt)&&(Ot|=256),(at===void 0||at)&&(Ot|=1024),ye.clear(Ot)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",pt,!1),e.removeEventListener("webglcontextrestored",ot,!1),ie.dispose(),ae.dispose(),fe.dispose(),tt.dispose(),Mt.dispose(),xe.dispose(),Re.dispose(),ht.dispose(),ht.removeEventListener("sessionstart",Fi),ht.removeEventListener("sessionend",un),Fe&&(Fe.dispose(),Fe=null),nn.stop()};function pt(Ye){Ye.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),L=!0}function ot(){console.log("THREE.WebGLRenderer: Context Restored."),L=!1;const Ye=we.autoReset,kt=Xe.enabled,at=Xe.autoUpdate,Ot=Xe.needsUpdate,Gt=Xe.type;Oe(),we.autoReset=Ye,Xe.enabled=kt,Xe.autoUpdate=at,Xe.needsUpdate=Ot,Xe.type=Gt}function St(Ye){const kt=Ye.target;kt.removeEventListener("dispose",St),Lt(kt)}function Lt(Ye){zt(Ye),fe.remove(Ye)}function zt(Ye){const kt=fe.get(Ye).programs;kt!==void 0&&kt.forEach(function(at){vt.releaseProgram(at)})}this.renderBufferDirect=function(Ye,kt,at,Ot,Gt,Gi){kt===null&&(kt=ke);const Ci=Gt.isMesh&&Gt.matrixWorld.determinant()<0,Nt=kn(Ye,kt,at,Ot,Gt);yt.setMaterial(Ot,Ci);let si=at.index;const pi=at.attributes.position;if(si===null){if(pi===void 0||pi.count===0)return}else if(si.count===0)return;let Wi=1;Ot.wireframe===!0&&(si=Ce.getWireframeAttribute(at),Wi=2),Re.setup(Gt,Ot,Nt,at,si);let wt,Ri=te;si!==null&&(wt=mt.get(si),Ri=he,Ri.setIndex(wt));const bi=si!==null?si.count:pi.count,Vi=at.drawRange.start*Wi,Jn=at.drawRange.count*Wi,Xi=Gi!==null?Gi.start*Wi:0,Gn=Gi!==null?Gi.count*Wi:1/0,on=Math.max(Vi,Xi),zr=Math.min(bi,Vi+Jn,Xi+Gn)-1,qn=Math.max(0,zr-on+1);if(qn!==0){if(Gt.isMesh)Ot.wireframe===!0?(yt.setLineWidth(Ot.wireframeLinewidth*et()),Ri.setMode(1)):Ri.setMode(4);else if(Gt.isLine){let an=Ot.linewidth;an===void 0&&(an=1),yt.setLineWidth(an*et()),Gt.isLineSegments?Ri.setMode(1):Gt.isLineLoop?Ri.setMode(2):Ri.setMode(3)}else Gt.isPoints?Ri.setMode(0):Gt.isSprite&&Ri.setMode(4);if(Gt.isInstancedMesh)Ri.renderInstances(on,qn,Gt.count);else if(at.isInstancedBufferGeometry){const an=Math.min(at.instanceCount,at._maxInstanceCount);Ri.renderInstances(on,qn,an)}else Ri.render(on,qn)}},this.compile=function(Ye,kt){x=ae.get(Ye),x.init(),S.push(x),Ye.traverseVisible(function(at){at.isLight&&at.layers.test(kt.layers)&&(x.pushLight(at),at.castShadow&&x.pushShadow(at))}),x.setupLights(P.physicallyCorrectLights),Ye.traverse(function(at){const Ot=at.material;if(Ot)if(Array.isArray(Ot))for(let Gt=0;Gt<Ot.length;Gt++){const Gi=Ot[Gt];zn(Gi,Ye,at)}else zn(Ot,Ye,at)}),S.pop(),x=null};let Jt=null;function gi(Ye){Jt&&Jt(Ye)}function Fi(){nn.stop()}function un(){nn.start()}const nn=new dz;nn.setAnimationLoop(gi),typeof window<"u"&&nn.setContext(window),this.setAnimationLoop=function(Ye){Jt=Ye,ht.setAnimationLoop(Ye),Ye===null?nn.stop():nn.start()},ht.addEventListener("sessionstart",Fi),ht.addEventListener("sessionend",un),this.render=function(Ye,kt){if(kt!==void 0&&kt.isCamera!==!0){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}if(L===!0)return;Ye.autoUpdate===!0&&Ye.updateMatrixWorld(),kt.parent===null&&kt.updateMatrixWorld(),ht.enabled===!0&&ht.isPresenting===!0&&(ht.cameraAutoUpdate===!0&&ht.updateCamera(kt),kt=ht.getCamera()),Ye.isScene===!0&&Ye.onBeforeRender(P,Ye,kt,D),x=ae.get(Ye,S.length),x.init(),S.push(x),qe.multiplyMatrices(kt.projectionMatrix,kt.matrixWorldInverse),Se.setFromProjectionMatrix(qe),je=this.localClippingEnabled,Pe=De.init(this.clippingPlanes,je,kt),_=ie.get(Ye,b.length),_.init(),b.push(_),Tt(Ye,kt,0,P.sortObjects),_.finish(),P.sortObjects===!0&&_.sort(Q,X),Pe===!0&&De.beginShadows();const at=x.state.shadowsArray;if(Xe.render(at,Ye,kt),Pe===!0&&De.endShadows(),this.info.autoReset===!0&&this.info.reset(),bt.render(_,Ye),x.setupLights(P.physicallyCorrectLights),kt.isArrayCamera){const Ot=kt.cameras;for(let Gt=0,Gi=Ot.length;Gt<Gi;Gt++){const Ci=Ot[Gt];hn(_,Ye,Ci,Ci.viewport)}}else hn(_,Ye,kt);D!==null&&(Ve.updateMultisampleRenderTarget(D),Ve.updateRenderTargetMipmap(D)),Ye.isScene===!0&&Ye.onAfterRender(P,Ye,kt),yt.buffers.depth.setTest(!0),yt.buffers.depth.setMask(!0),yt.buffers.color.setMask(!0),yt.setPolygonOffset(!1),Re.resetDefaultState(),O=-1,U=null,S.pop(),S.length>0?x=S[S.length-1]:x=null,b.pop(),b.length>0?_=b[b.length-1]:_=null};function Tt(Ye,kt,at,Ot){if(Ye.visible===!1)return;if(Ye.layers.test(kt.layers)){if(Ye.isGroup)at=Ye.renderOrder;else if(Ye.isLOD)Ye.autoUpdate===!0&&Ye.update(kt);else if(Ye.isLight)x.pushLight(Ye),Ye.castShadow&&x.pushShadow(Ye);else if(Ye.isSprite){if(!Ye.frustumCulled||Se.intersectsSprite(Ye)){Ot&&Ue.setFromMatrixPosition(Ye.matrixWorld).applyMatrix4(qe);const Ci=xe.update(Ye),Nt=Ye.material;Nt.visible&&_.push(Ye,Ci,Nt,at,Ue.z,null)}}else if((Ye.isMesh||Ye.isLine||Ye.isPoints)&&(Ye.isSkinnedMesh&&Ye.skeleton.frame!==we.render.frame&&(Ye.skeleton.update(),Ye.skeleton.frame=we.render.frame),!Ye.frustumCulled||Se.intersectsObject(Ye))){Ot&&Ue.setFromMatrixPosition(Ye.matrixWorld).applyMatrix4(qe);const Ci=xe.update(Ye),Nt=Ye.material;if(Array.isArray(Nt)){const si=Ci.groups;for(let pi=0,Wi=si.length;pi<Wi;pi++){const wt=si[pi],Ri=Nt[wt.materialIndex];Ri&&Ri.visible&&_.push(Ye,Ci,Ri,at,Ue.z,wt)}}else Nt.visible&&_.push(Ye,Ci,Nt,at,Ue.z,null)}}const Gi=Ye.children;for(let Ci=0,Nt=Gi.length;Ci<Nt;Ci++)Tt(Gi[Ci],kt,at,Ot)}function hn(Ye,kt,at,Ot){const Gt=Ye.opaque,Gi=Ye.transmissive,Ci=Ye.transparent;x.setupLightsView(at),Gi.length>0&&fr(Gt,kt,at),Ot&&yt.viewport(j.copy(Ot)),Gt.length>0&&Li(Gt,kt,at),Gi.length>0&&Li(Gi,kt,at),Ci.length>0&&Li(Ci,kt,at)}function fr(Ye,kt,at){if(Fe===null){const Ci=c===!0&&ct.isWebGL2===!0?oz:Cc;Fe=new Ci(1024,1024,{generateMipmaps:!0,type:pe.convert(Ig)!==null?Ig:$d,minFilter:d1,magFilter:Hs,wrapS:nl,wrapT:nl})}const Ot=P.getRenderTarget();P.setRenderTarget(Fe),P.clear();const Gt=P.toneMapping;P.toneMapping=cp,Li(Ye,kt,at),P.toneMapping=Gt,Ve.updateMultisampleRenderTarget(Fe),Ve.updateRenderTargetMipmap(Fe),P.setRenderTarget(Ot)}function Li(Ye,kt,at){const Ot=kt.isScene===!0?kt.overrideMaterial:null;for(let Gt=0,Gi=Ye.length;Gt<Gi;Gt++){const Ci=Ye[Gt],Nt=Ci.object,si=Ci.geometry,pi=Ot===null?Ci.material:Ot,Wi=Ci.group;Nt.layers.test(at.layers)&&gn(Nt,kt,at,si,pi,Wi)}}function gn(Ye,kt,at,Ot,Gt,Gi){Ye.onBeforeRender(P,kt,at,Ot,Gt,Gi),Ye.modelViewMatrix.multiplyMatrices(at.matrixWorldInverse,Ye.matrixWorld),Ye.normalMatrix.getNormalMatrix(Ye.modelViewMatrix),Gt.onBeforeRender(P,kt,at,Ot,Ye,Gi),Gt.transparent===!0&&Gt.side===ea?(Gt.side=Gs,Gt.needsUpdate=!0,P.renderBufferDirect(at,kt,Ot,Gt,Ye,Gi),Gt.side=Hg,Gt.needsUpdate=!0,P.renderBufferDirect(at,kt,Ot,Gt,Ye,Gi),Gt.side=ea):P.renderBufferDirect(at,kt,Ot,Gt,Ye,Gi),Ye.onAfterRender(P,kt,at,Ot,Gt,Gi)}function zn(Ye,kt,at){kt.isScene!==!0&&(kt=ke);const Ot=fe.get(Ye),Gt=x.state.lights,Gi=x.state.shadowsArray,Ci=Gt.state.version,Nt=vt.getParameters(Ye,Gt.state,Gi,kt,at),si=vt.getProgramCacheKey(Nt);let pi=Ot.programs;Ot.environment=Ye.isMeshStandardMaterial?kt.environment:null,Ot.fog=kt.fog,Ot.envMap=(Ye.isMeshStandardMaterial?Mt:tt).get(Ye.envMap||Ot.environment),pi===void 0&&(Ye.addEventListener("dispose",St),pi=new Map,Ot.programs=pi);let Wi=pi.get(si);if(Wi!==void 0){if(Ot.currentProgram===Wi&&Ot.lightsStateVersion===Ci)return wn(Ye,Nt),Wi}else Nt.uniforms=vt.getUniforms(Ye),Ye.onBuild(at,Nt,P),Ye.onBeforeCompile(Nt,P),Wi=vt.acquireProgram(Nt,si),pi.set(si,Wi),Ot.uniforms=Nt.uniforms;const wt=Ot.uniforms;(!Ye.isShaderMaterial&&!Ye.isRawShaderMaterial||Ye.clipping===!0)&&(wt.clippingPlanes=De.uniform),wn(Ye,Nt),Ot.needsLights=Kn(Ye),Ot.lightsStateVersion=Ci,Ot.needsLights&&(wt.ambientLightColor.value=Gt.state.ambient,wt.lightProbe.value=Gt.state.probe,wt.directionalLights.value=Gt.state.directional,wt.directionalLightShadows.value=Gt.state.directionalShadow,wt.spotLights.value=Gt.state.spot,wt.spotLightShadows.value=Gt.state.spotShadow,wt.rectAreaLights.value=Gt.state.rectArea,wt.ltc_1.value=Gt.state.rectAreaLTC1,wt.ltc_2.value=Gt.state.rectAreaLTC2,wt.pointLights.value=Gt.state.point,wt.pointLightShadows.value=Gt.state.pointShadow,wt.hemisphereLights.value=Gt.state.hemi,wt.directionalShadowMap.value=Gt.state.directionalShadowMap,wt.directionalShadowMatrix.value=Gt.state.directionalShadowMatrix,wt.spotShadowMap.value=Gt.state.spotShadowMap,wt.spotShadowMatrix.value=Gt.state.spotShadowMatrix,wt.pointShadowMap.value=Gt.state.pointShadowMap,wt.pointShadowMatrix.value=Gt.state.pointShadowMatrix);const Ri=Wi.getUniforms(),bi=kd.seqWithValue(Ri.seq,wt);return Ot.currentProgram=Wi,Ot.uniformsList=bi,Wi}function wn(Ye,kt){const at=fe.get(Ye);at.outputEncoding=kt.outputEncoding,at.instancing=kt.instancing,at.skinning=kt.skinning,at.morphTargets=kt.morphTargets,at.morphNormals=kt.morphNormals,at.morphTargetsCount=kt.morphTargetsCount,at.numClippingPlanes=kt.numClippingPlanes,at.numIntersection=kt.numClipIntersection,at.vertexAlphas=kt.vertexAlphas,at.vertexTangents=kt.vertexTangents}function kn(Ye,kt,at,Ot,Gt){kt.isScene!==!0&&(kt=ke),Ve.resetTextureUnits();const Gi=kt.fog,Ci=Ot.isMeshStandardMaterial?kt.environment:null,Nt=D===null?P.outputEncoding:D.texture.encoding,si=(Ot.isMeshStandardMaterial?Mt:tt).get(Ot.envMap||Ci),pi=Ot.vertexColors===!0&&!!at.attributes.color&&at.attributes.color.itemSize===4,Wi=!!Ot.normalMap&&!!at.attributes.tangent,wt=!!at.morphAttributes.position,Ri=!!at.morphAttributes.normal,bi=at.morphAttributes.position?at.morphAttributes.position.length:0,Vi=fe.get(Ot),Jn=x.state.lights;if(Pe===!0&&(je===!0||Ye!==U)){const ns=Ye===U&&Ot.id===O;De.setState(Ot,Ye,ns)}let Xi=!1;Ot.version===Vi.__version?(Vi.needsLights&&Vi.lightsStateVersion!==Jn.state.version||Vi.outputEncoding!==Nt||Gt.isInstancedMesh&&Vi.instancing===!1||!Gt.isInstancedMesh&&Vi.instancing===!0||Gt.isSkinnedMesh&&Vi.skinning===!1||!Gt.isSkinnedMesh&&Vi.skinning===!0||Vi.envMap!==si||Ot.fog&&Vi.fog!==Gi||Vi.numClippingPlanes!==void 0&&(Vi.numClippingPlanes!==De.numPlanes||Vi.numIntersection!==De.numIntersection)||Vi.vertexAlphas!==pi||Vi.vertexTangents!==Wi||Vi.morphTargets!==wt||Vi.morphNormals!==Ri||ct.isWebGL2===!0&&Vi.morphTargetsCount!==bi)&&(Xi=!0):(Xi=!0,Vi.__version=Ot.version);let Gn=Vi.currentProgram;Xi===!0&&(Gn=zn(Ot,kt,Gt));let on=!1,zr=!1,qn=!1;const an=Gn.getUniforms(),rn=Vi.uniforms;if(yt.useProgram(Gn.program)&&(on=!0,zr=!0,qn=!0),Ot.id!==O&&(O=Ot.id,zr=!0),on||U!==Ye){if(an.setValue(ye,"projectionMatrix",Ye.projectionMatrix),ct.logarithmicDepthBuffer&&an.setValue(ye,"logDepthBufFC",2/(Math.log(Ye.far+1)/Math.LN2)),U!==Ye&&(U=Ye,zr=!0,qn=!0),Ot.isShaderMaterial||Ot.isMeshPhongMaterial||Ot.isMeshToonMaterial||Ot.isMeshStandardMaterial||Ot.envMap){const ns=an.map.cameraPosition;ns!==void 0&&ns.setValue(ye,Ue.setFromMatrixPosition(Ye.matrixWorld))}(Ot.isMeshPhongMaterial||Ot.isMeshToonMaterial||Ot.isMeshLambertMaterial||Ot.isMeshBasicMaterial||Ot.isMeshStandardMaterial||Ot.isShaderMaterial)&&an.setValue(ye,"isOrthographic",Ye.isOrthographicCamera===!0),(Ot.isMeshPhongMaterial||Ot.isMeshToonMaterial||Ot.isMeshLambertMaterial||Ot.isMeshBasicMaterial||Ot.isMeshStandardMaterial||Ot.isShaderMaterial||Ot.isShadowMaterial||Gt.isSkinnedMesh)&&an.setValue(ye,"viewMatrix",Ye.matrixWorldInverse)}if(Gt.isSkinnedMesh){an.setOptional(ye,Gt,"bindMatrix"),an.setOptional(ye,Gt,"bindMatrixInverse");const ns=Gt.skeleton;ns&&(ct.floatVertexTextures?(ns.boneTexture===null&&ns.computeBoneTexture(),an.setValue(ye,"boneTexture",ns.boneTexture,Ve),an.setValue(ye,"boneTextureSize",ns.boneTextureSize)):an.setOptional(ye,ns,"boneMatrices"))}return at&&(at.morphAttributes.position!==void 0||at.morphAttributes.normal!==void 0)&&Te.update(Gt,at,Ot,Gn),(zr||Vi.receiveShadow!==Gt.receiveShadow)&&(Vi.receiveShadow=Gt.receiveShadow,an.setValue(ye,"receiveShadow",Gt.receiveShadow)),zr&&(an.setValue(ye,"toneMappingExposure",P.toneMappingExposure),Vi.needsLights&&Sn(rn,qn),Gi&&Ot.fog&&be.refreshFogUniforms(rn,Gi),be.refreshMaterialUniforms(rn,Ot,z,q,Fe),kd.upload(ye,Vi.uniformsList,rn,Ve)),Ot.isShaderMaterial&&Ot.uniformsNeedUpdate===!0&&(kd.upload(ye,Vi.uniformsList,rn,Ve),Ot.uniformsNeedUpdate=!1),Ot.isSpriteMaterial&&an.setValue(ye,"center",Gt.center),an.setValue(ye,"modelViewMatrix",Gt.modelViewMatrix),an.setValue(ye,"normalMatrix",Gt.normalMatrix),an.setValue(ye,"modelMatrix",Gt.matrixWorld),Gn}function Sn(Ye,kt){Ye.ambientLightColor.needsUpdate=kt,Ye.lightProbe.needsUpdate=kt,Ye.directionalLights.needsUpdate=kt,Ye.directionalLightShadows.needsUpdate=kt,Ye.pointLights.needsUpdate=kt,Ye.pointLightShadows.needsUpdate=kt,Ye.spotLights.needsUpdate=kt,Ye.spotLightShadows.needsUpdate=kt,Ye.rectAreaLights.needsUpdate=kt,Ye.hemisphereLights.needsUpdate=kt}function Kn(Ye){return Ye.isMeshLambertMaterial||Ye.isMeshToonMaterial||Ye.isMeshPhongMaterial||Ye.isMeshStandardMaterial||Ye.isShadowMaterial||Ye.isShaderMaterial&&Ye.lights===!0}this.getActiveCubeFace=function(){return E},this.getActiveMipmapLevel=function(){return C},this.getRenderTarget=function(){return D},this.setRenderTarget=function(Ye,kt=0,at=0){D=Ye,E=kt,C=at,Ye&&fe.get(Ye).__webglFramebuffer===void 0&&Ve.setupRenderTarget(Ye);let Ot=null,Gt=!1,Gi=!1;if(Ye){const Nt=Ye.texture;(Nt.isDataTexture3D||Nt.isDataTexture2DArray)&&(Gi=!0);const si=fe.get(Ye).__webglFramebuffer;Ye.isWebGLCubeRenderTarget?(Ot=si[kt],Gt=!0):Ye.isWebGLMultisampleRenderTarget?Ot=fe.get(Ye).__webglMultisampledFramebuffer:Ot=si,j.copy(Ye.viewport),G.copy(Ye.scissor),N=Ye.scissorTest}else j.copy(re).multiplyScalar(z).floor(),G.copy(oe).multiplyScalar(z).floor(),N=de;if(yt.bindFramebuffer(36160,Ot)&&ct.drawBuffers){let Nt=!1;if(Ye)if(Ye.isWebGLMultipleRenderTargets){const si=Ye.texture;if(ce.length!==si.length||ce[0]!==36064){for(let pi=0,Wi=si.length;pi<Wi;pi++)ce[pi]=36064+pi;ce.length=si.length,Nt=!0}}else(ce.length!==1||ce[0]!==36064)&&(ce[0]=36064,ce.length=1,Nt=!0);else(ce.length!==1||ce[0]!==1029)&&(ce[0]=1029,ce.length=1,Nt=!0);Nt&&(ct.isWebGL2?ye.drawBuffers(ce):Je.get("WEBGL_draw_buffers").drawBuffersWEBGL(ce))}if(yt.viewport(j),yt.scissor(G),yt.setScissorTest(N),Gt){const Nt=fe.get(Ye.texture);ye.framebufferTexture2D(36160,36064,34069+kt,Nt.__webglTexture,at)}else if(Gi){const Nt=fe.get(Ye.texture),si=kt||0;ye.framebufferTextureLayer(36160,36064,Nt.__webglTexture,at||0,si)}O=-1},this.readRenderTargetPixels=function(Ye,kt,at,Ot,Gt,Gi,Ci){if(!(Ye&&Ye.isWebGLRenderTarget)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");return}let Nt=fe.get(Ye).__webglFramebuffer;if(Ye.isWebGLCubeRenderTarget&&Ci!==void 0&&(Nt=Nt[Ci]),Nt){yt.bindFramebuffer(36160,Nt);try{const si=Ye.texture,pi=si.format,Wi=si.type;if(pi!==ca&&pe.convert(pi)!==ye.getParameter(35739)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");return}const wt=Wi===Ig&&(Je.has("EXT_color_buffer_half_float")||ct.isWebGL2&&Je.has("EXT_color_buffer_float"));if(Wi!==$d&&pe.convert(Wi)!==ye.getParameter(35738)&&!(Wi===Td&&(ct.isWebGL2||Je.has("OES_texture_float")||Je.has("WEBGL_color_buffer_float")))&&!wt){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");return}ye.checkFramebufferStatus(36160)===36053?kt>=0&&kt<=Ye.width-Ot&&at>=0&&at<=Ye.height-Gt&&ye.readPixels(kt,at,Ot,Gt,pe.convert(pi),pe.convert(Wi),Gi):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{const si=D!==null?fe.get(D).__webglFramebuffer:null;yt.bindFramebuffer(36160,si)}}},this.copyFramebufferToTexture=function(Ye,kt,at=0){const Ot=Math.pow(2,-at),Gt=Math.floor(kt.image.width*Ot),Gi=Math.floor(kt.image.height*Ot);let Ci=pe.convert(kt.format);ct.isWebGL2&&(Ci===6407&&(Ci=32849),Ci===6408&&(Ci=32856)),Ve.setTexture2D(kt,0),ye.copyTexImage2D(3553,at,Ci,Ye.x,Ye.y,Gt,Gi,0),yt.unbindTexture()},this.copyTextureToTexture=function(Ye,kt,at,Ot=0){const Gt=kt.image.width,Gi=kt.image.height,Ci=pe.convert(at.format),Nt=pe.convert(at.type);Ve.setTexture2D(at,0),ye.pixelStorei(37440,at.flipY),ye.pixelStorei(37441,at.premultiplyAlpha),ye.pixelStorei(3317,at.unpackAlignment),kt.isDataTexture?ye.texSubImage2D(3553,Ot,Ye.x,Ye.y,Gt,Gi,Ci,Nt,kt.image.data):kt.isCompressedTexture?ye.compressedTexSubImage2D(3553,Ot,Ye.x,Ye.y,kt.mipmaps[0].width,kt.mipmaps[0].height,Ci,kt.mipmaps[0].data):ye.texSubImage2D(3553,Ot,Ye.x,Ye.y,Ci,Nt,kt.image),Ot===0&&at.generateMipmaps&&ye.generateMipmap(3553),yt.unbindTexture()},this.copyTextureToTexture3D=function(Ye,kt,at,Ot,Gt=0){if(P.isWebGL1Renderer){console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");return}const Gi=Ye.max.x-Ye.min.x+1,Ci=Ye.max.y-Ye.min.y+1,Nt=Ye.max.z-Ye.min.z+1,si=pe.convert(Ot.format),pi=pe.convert(Ot.type);let Wi;if(Ot.isDataTexture3D)Ve.setTexture3D(Ot,0),Wi=32879;else if(Ot.isDataTexture2DArray)Ve.setTexture2DArray(Ot,0),Wi=35866;else{console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");return}ye.pixelStorei(37440,Ot.flipY),ye.pixelStorei(37441,Ot.premultiplyAlpha),ye.pixelStorei(3317,Ot.unpackAlignment);const wt=ye.getParameter(3314),Ri=ye.getParameter(32878),bi=ye.getParameter(3316),Vi=ye.getParameter(3315),Jn=ye.getParameter(32877),Xi=at.isCompressedTexture?at.mipmaps[0]:at.image;ye.pixelStorei(3314,Xi.width),ye.pixelStorei(32878,Xi.height),ye.pixelStorei(3316,Ye.min.x),ye.pixelStorei(3315,Ye.min.y),ye.pixelStorei(32877,Ye.min.z),at.isDataTexture||at.isDataTexture3D?ye.texSubImage3D(Wi,Gt,kt.x,kt.y,kt.z,Gi,Ci,Nt,si,pi,Xi.data):at.isCompressedTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),ye.compressedTexSubImage3D(Wi,Gt,kt.x,kt.y,kt.z,Gi,Ci,Nt,si,Xi.data)):ye.texSubImage3D(Wi,Gt,kt.x,kt.y,kt.z,Gi,Ci,Nt,si,pi,Xi),ye.pixelStorei(3314,wt),ye.pixelStorei(32878,Ri),ye.pixelStorei(3316,bi),ye.pixelStorei(3315,Vi),ye.pixelStorei(32877,Jn),Gt===0&&Ot.generateMipmaps&&ye.generateMipmap(Wi),yt.unbindTexture()},this.initTexture=function(Ye){Ve.setTexture2D(Ye,0),yt.unbindTexture()},this.resetState=function(){E=0,C=0,D=null,yt.reset(),Re.reset()},typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}dr.prototype.isWebGLRenderer=!0;class xJ extends dr{}xJ.prototype.isWebGL1Renderer=!0;class yh extends Ln{constructor(){super(),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),e.background!==null&&(this.background=e.background.clone()),e.environment!==null&&(this.environment=e.environment.clone()),e.fog!==null&&(this.fog=e.fog.clone()),e.overrideMaterial!==null&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return this.fog!==null&&(t.object.fog=this.fog.toJSON()),t}}yh.prototype.isScene=!0;class y0{constructor(e,t){this.array=e,this.stride=t,this.count=e!==void 0?e.length/t:0,this.usage=Ny,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=Mc()}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,i){e*=this.stride,i*=t.stride;for(let r=0,o=this.stride;r<o;r++)this.array[e+r]=t.array[i+r];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){e.arrayBuffers===void 0&&(e.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=Mc()),e.arrayBuffers[this.array.buffer._uuid]===void 0&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(t,this.stride);return i.setUsage(this.usage),i}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return e.arrayBuffers===void 0&&(e.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=Mc()),e.arrayBuffers[this.array.buffer._uuid]===void 0&&(e.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}y0.prototype.isInterleavedBuffer=!0;const ys=new Ge;class Vy{constructor(e,t,i,r=!1){this.name="",this.data=e,this.itemSize=t,this.offset=i,this.normalized=r===!0}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,i=this.data.count;t<i;t++)ys.x=this.getX(t),ys.y=this.getY(t),ys.z=this.getZ(t),ys.applyMatrix4(e),this.setXYZ(t,ys.x,ys.y,ys.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)ys.x=this.getX(t),ys.y=this.getY(t),ys.z=this.getZ(t),ys.applyNormalMatrix(e),this.setXYZ(t,ys.x,ys.y,ys.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)ys.x=this.getX(t),ys.y=this.getY(t),ys.z=this.getZ(t),ys.transformDirection(e),this.setXYZ(t,ys.x,ys.y,ys.z);return this}setX(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){return this.data.array[e*this.data.stride+this.offset]}getY(e){return this.data.array[e*this.data.stride+this.offset+1]}getZ(e){return this.data.array[e*this.data.stride+this.offset+2]}getW(e){return this.data.array[e*this.data.stride+this.offset+3]}setXY(e,t,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this}setXYZ(e,t,i,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=r,this}setXYZW(e,t,i,r,o){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=r,this.data.array[e+3]=o,this}clone(e){if(e===void 0){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let i=0;i<this.count;i++){const r=i*this.data.stride+this.offset;for(let o=0;o<this.itemSize;o++)t.push(this.data.array[r+o])}return new En(new this.array.constructor(t),this.itemSize,this.normalized)}else return e.interleavedBuffers===void 0&&(e.interleavedBuffers={}),e.interleavedBuffers[this.data.uuid]===void 0&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new Vy(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(e===void 0){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let i=0;i<this.count;i++){const r=i*this.data.stride+this.offset;for(let o=0;o<this.itemSize;o++)t.push(this.data.array[r+o])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}else return e.interleavedBuffers===void 0&&(e.interleavedBuffers={}),e.interleavedBuffers[this.data.uuid]===void 0&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}Vy.prototype.isInterleavedBufferAttribute=!0;class UC extends Vo{constructor(e){super(),this.type="SpriteMaterial",this.color=new $i(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this}}UC.prototype.isSpriteMaterial=!0;let ig;const Lv=new Ge,ng=new Ge,rg=new Ge,sg=new li,kv=new li,Ez=new ki,ax=new Ge,Dv=new Ge,lx=new Ge,LL=new li,iM=new li,kL=new li;class Az extends Ln{constructor(e){if(super(),this.type="Sprite",ig===void 0){ig=new jn;const t=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),i=new y0(t,5);ig.setIndex([0,1,2,0,2,3]),ig.setAttribute("position",new Vy(i,3,0,!1)),ig.setAttribute("uv",new Vy(i,2,3,!1))}this.geometry=ig,this.material=e!==void 0?e:new UC,this.center=new li(.5,.5)}raycast(e,t){e.camera===null&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),ng.setFromMatrixScale(this.matrixWorld),Ez.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),rg.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&this.material.sizeAttenuation===!1&&ng.multiplyScalar(-rg.z);const i=this.material.rotation;let r,o;i!==0&&(o=Math.cos(i),r=Math.sin(i));const c=this.center;cx(ax.set(-.5,-.5,0),rg,c,ng,r,o),cx(Dv.set(.5,-.5,0),rg,c,ng,r,o),cx(lx.set(.5,.5,0),rg,c,ng,r,o),LL.set(0,0),iM.set(1,0),kL.set(1,1);let s=e.ray.intersectTriangle(ax,Dv,lx,!1,Lv);if(s===null&&(cx(Dv.set(-.5,.5,0),rg,c,ng,r,o),iM.set(0,1),s=e.ray.intersectTriangle(ax,lx,Dv,!1,Lv),s===null))return;const d=e.ray.origin.distanceTo(Lv);d<e.near||d>e.far||t.push({distance:d,point:Lv.clone(),uv:Zs.getUV(Lv,ax,Dv,lx,LL,iM,kL,new li),face:null,object:this})}copy(e){return super.copy(e),e.center!==void 0&&this.center.copy(e.center),this.material=e.material,this}}Az.prototype.isSprite=!0;function cx(n,e,t,i,r,o){sg.subVectors(n,t).addScalar(.5).multiply(i),r!==void 0?(kv.x=o*sg.x-r*sg.y,kv.y=r*sg.x+o*sg.y):kv.copy(sg),n.copy(e),n.x+=kv.x,n.y+=kv.y,n.applyMatrix4(Ez)}const DL=new Ge,FL=new Xn,OL=new Xn,wJ=new Ge,zL=new ki;class Pz extends kr{constructor(e,t){super(e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new ki,this.bindMatrixInverse=new ki}copy(e){return super.copy(e),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,this}bind(e,t){this.skeleton=e,t===void 0&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new Xn,t=this.geometry.attributes.skinWeight;for(let i=0,r=t.count;i<r;i++){e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.w=t.getW(i);const o=1/e.manhattanLength();o!==1/0?e.multiplyScalar(o):e.set(1,0,0,0),t.setXYZW(i,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode==="attached"?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode==="detached"?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}boneTransform(e,t){const i=this.skeleton,r=this.geometry;FL.fromBufferAttribute(r.attributes.skinIndex,e),OL.fromBufferAttribute(r.attributes.skinWeight,e),DL.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let o=0;o<4;o++){const c=OL.getComponent(o);if(c!==0){const s=FL.getComponent(o);zL.multiplyMatrices(i.bones[s].matrixWorld,i.boneInverses[s]),t.addScaledVector(wJ.copy(DL).applyMatrix4(zL),c)}}return t.applyMatrix4(this.bindMatrixInverse)}}Pz.prototype.isSkinnedMesh=!0;class SJ extends Ln{constructor(){super(),this.type="Bone"}}SJ.prototype.isBone=!0;class TJ extends Bs{constructor(e=null,t=1,i=1,r,o,c,s,d,p=Hs,g=Hs,_,x){super(null,c,s,d,p,g,r,o,_,x),this.image={data:e,width:t,height:i},this.magFilter=p,this.minFilter=g,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}TJ.prototype.isDataTexture=!0;class f2 extends En{constructor(e,t,i,r=1){typeof i=="number"&&(r=i,i=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),super(e,t,i),this.meshPerAttribute=r}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}f2.prototype.isInstancedBufferAttribute=!0;const BL=new ki,NL=new ki,ux=[],Fv=new kr;class MJ extends kr{constructor(e,t,i){super(e,t),this.instanceMatrix=new f2(new Float32Array(i*16),16),this.instanceColor=null,this.count=i,this.frustumCulled=!1}copy(e){return super.copy(e),this.instanceMatrix.copy(e.instanceMatrix),e.instanceColor!==null&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,this}getColorAt(e,t){t.fromArray(this.instanceColor.array,e*3)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,e*16)}raycast(e,t){const i=this.matrixWorld,r=this.count;if(Fv.geometry=this.geometry,Fv.material=this.material,Fv.material!==void 0)for(let o=0;o<r;o++){this.getMatrixAt(o,BL),NL.multiplyMatrices(i,BL),Fv.matrixWorld=NL,Fv.raycast(e,ux);for(let c=0,s=ux.length;c<s;c++){const d=ux[c];d.instanceId=o,d.object=this,t.push(d)}ux.length=0}}setColorAt(e,t){this.instanceColor===null&&(this.instanceColor=new f2(new Float32Array(this.instanceMatrix.count*3),3)),t.toArray(this.instanceColor.array,e*3)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,e*16)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}MJ.prototype.isInstancedMesh=!0;class Ih extends Vo{constructor(e){super(),this.type="LineBasicMaterial",this.color=new $i(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this}}Ih.prototype.isLineBasicMaterial=!0;const $L=new Ge,VL=new Ge,UL=new ki,nM=new Cp,hx=new f_;class Ap extends Ln{constructor(e=new jn,t=new Ih){super(),this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),this.material=e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(e.isBufferGeometry)if(e.index===null){const t=e.attributes.position,i=[0];for(let r=1,o=t.count;r<o;r++)$L.fromBufferAttribute(t,r-1),VL.fromBufferAttribute(t,r),i[r]=i[r-1],i[r]+=$L.distanceTo(VL);e.setAttribute("lineDistance",new ws(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else e.isGeometry&&console.error("THREE.Line.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}raycast(e,t){const i=this.geometry,r=this.matrixWorld,o=e.params.Line.threshold,c=i.drawRange;if(i.boundingSphere===null&&i.computeBoundingSphere(),hx.copy(i.boundingSphere),hx.applyMatrix4(r),hx.radius+=o,e.ray.intersectsSphere(hx)===!1)return;UL.copy(r).invert(),nM.copy(e.ray).applyMatrix4(UL);const s=o/((this.scale.x+this.scale.y+this.scale.z)/3),d=s*s,p=new Ge,g=new Ge,_=new Ge,x=new Ge,b=this.isLineSegments?2:1;if(i.isBufferGeometry){const S=i.index,L=i.attributes.position;if(S!==null){const E=Math.max(0,c.start),C=Math.min(S.count,c.start+c.count);for(let D=E,O=C-1;D<O;D+=b){const U=S.getX(D),j=S.getX(D+1);if(p.fromBufferAttribute(L,U),g.fromBufferAttribute(L,j),nM.distanceSqToSegment(p,g,x,_)>d)continue;x.applyMatrix4(this.matrixWorld);const N=e.ray.origin.distanceTo(x);N<e.near||N>e.far||t.push({distance:N,point:_.clone().applyMatrix4(this.matrixWorld),index:D,face:null,faceIndex:null,object:this})}}else{const E=Math.max(0,c.start),C=Math.min(L.count,c.start+c.count);for(let D=E,O=C-1;D<O;D+=b){if(p.fromBufferAttribute(L,D),g.fromBufferAttribute(L,D+1),nM.distanceSqToSegment(p,g,x,_)>d)continue;x.applyMatrix4(this.matrixWorld);const j=e.ray.origin.distanceTo(x);j<e.near||j>e.far||t.push({distance:j,point:_.clone().applyMatrix4(this.matrixWorld),index:D,face:null,faceIndex:null,object:this})}}}else i.isGeometry&&console.error("THREE.Line.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const r=t[i[0]];if(r!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let o=0,c=r.length;o<c;o++){const s=r[o].name||String(o);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=o}}}}else{const t=e.morphTargets;t!==void 0&&t.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}Ap.prototype.isLine=!0;const jL=new Ge,GL=new Ge;class y1 extends Ap{constructor(e,t){super(e,t),this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(e.isBufferGeometry)if(e.index===null){const t=e.attributes.position,i=[];for(let r=0,o=t.count;r<o;r+=2)jL.fromBufferAttribute(t,r),GL.fromBufferAttribute(t,r+1),i[r]=r===0?0:i[r-1],i[r+1]=i[r]+jL.distanceTo(GL);e.setAttribute("lineDistance",new ws(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else e.isGeometry&&console.error("THREE.LineSegments.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}}y1.prototype.isLineSegments=!0;class CJ extends Ap{constructor(e,t){super(e,t),this.type="LineLoop"}}CJ.prototype.isLineLoop=!0;class Iz extends Vo{constructor(e){super(),this.type="PointsMaterial",this.color=new $i(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this}}Iz.prototype.isPointsMaterial=!0;const qL=new ki,p2=new Cp,dx=new f_,fx=new Ge;class Rz extends Ln{constructor(e=new jn,t=new Iz){super(),this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),this.material=e.material,this.geometry=e.geometry,this}raycast(e,t){const i=this.geometry,r=this.matrixWorld,o=e.params.Points.threshold,c=i.drawRange;if(i.boundingSphere===null&&i.computeBoundingSphere(),dx.copy(i.boundingSphere),dx.applyMatrix4(r),dx.radius+=o,e.ray.intersectsSphere(dx)===!1)return;qL.copy(r).invert(),p2.copy(e.ray).applyMatrix4(qL);const s=o/((this.scale.x+this.scale.y+this.scale.z)/3),d=s*s;if(i.isBufferGeometry){const p=i.index,_=i.attributes.position;if(p!==null){const x=Math.max(0,c.start),b=Math.min(p.count,c.start+c.count);for(let S=x,P=b;S<P;S++){const L=p.getX(S);fx.fromBufferAttribute(_,L),WL(fx,L,d,r,e,t,this)}}else{const x=Math.max(0,c.start),b=Math.min(_.count,c.start+c.count);for(let S=x,P=b;S<P;S++)fx.fromBufferAttribute(_,S),WL(fx,S,d,r,e,t,this)}}else console.error("THREE.Points.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const r=t[i[0]];if(r!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let o=0,c=r.length;o<c;o++){const s=r[o].name||String(o);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=o}}}}else{const t=e.morphTargets;t!==void 0&&t.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}Rz.prototype.isPoints=!0;function WL(n,e,t,i,r,o,c){const s=p2.distanceSqToPoint(n);if(s<t){const d=new Ge;p2.closestPointToPoint(n,d),d.applyMatrix4(i);const p=r.ray.origin.distanceTo(d);if(p<r.near||p>r.far)return;o.push({distance:p,distanceToRay:Math.sqrt(s),point:d,index:e,face:null,object:c})}}class EJ extends Bs{constructor(e,t,i,r,o,c,s,d,p){super(e,t,i,r,o,c,s,d,p),this.format=s!==void 0?s:up,this.minFilter=c!==void 0?c:Fo,this.magFilter=o!==void 0?o:Fo,this.generateMipmaps=!1;const g=this;function _(){g.needsUpdate=!0,e.requestVideoFrameCallback(_)}"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback(_)}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;"requestVideoFrameCallback"in e===!1&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}EJ.prototype.isVideoTexture=!0;class AJ extends Bs{constructor(e,t,i,r,o,c,s,d,p,g,_,x){super(null,c,s,d,p,g,r,o,_,x),this.image={width:t,height:i},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}AJ.prototype.isCompressedTexture=!0;class PJ extends Bs{constructor(e,t,i,r,o,c,s,d,p){super(e,t,i,r,o,c,s,d,p),this.needsUpdate=!0}}PJ.prototype.isCanvasTexture=!0;class IJ extends Bs{constructor(e,t,i,r,o,c,s,d,p,g){if(g=g!==void 0?g:Rg,g!==Rg&&g!==By)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");i===void 0&&g===Rg&&(i=Mw),i===void 0&&g===By&&(i=my),super(null,r,o,c,s,d,g,i,p),this.image={width:e,height:t},this.magFilter=s!==void 0?s:Hs,this.minFilter=d!==void 0?d:Hs,this.flipY=!1,this.generateMipmaps=!1}}IJ.prototype.isDepthTexture=!0;class Gl{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(e,t){const i=this.getUtoTmapping(e);return this.getPoint(i,t)}getPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return t}getSpacedPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let i,r=this.getPoint(0),o=0;t.push(0);for(let c=1;c<=e;c++)i=this.getPoint(c/e),o+=i.distanceTo(r),t.push(o),r=i;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t){const i=this.getLengths();let r=0;const o=i.length;let c;t?c=t:c=e*i[o-1];let s=0,d=o-1,p;for(;s<=d;)if(r=Math.floor(s+(d-s)/2),p=i[r]-c,p<0)s=r+1;else if(p>0)d=r-1;else{d=r;break}if(r=d,i[r]===c)return r/(o-1);const g=i[r],x=i[r+1]-g,b=(c-g)/x;return(r+b)/(o-1)}getTangent(e,t){let r=e-1e-4,o=e+1e-4;r<0&&(r=0),o>1&&(o=1);const c=this.getPoint(r),s=this.getPoint(o),d=t||(c.isVector2?new li:new Ge);return d.copy(s).sub(c).normalize(),d}getTangentAt(e,t){const i=this.getUtoTmapping(e);return this.getTangent(i,t)}computeFrenetFrames(e,t){const i=new Ge,r=[],o=[],c=[],s=new Ge,d=new ki;for(let b=0;b<=e;b++){const S=b/e;r[b]=this.getTangentAt(S,new Ge)}o[0]=new Ge,c[0]=new Ge;let p=Number.MAX_VALUE;const g=Math.abs(r[0].x),_=Math.abs(r[0].y),x=Math.abs(r[0].z);g<=p&&(p=g,i.set(1,0,0)),_<=p&&(p=_,i.set(0,1,0)),x<=p&&i.set(0,0,1),s.crossVectors(r[0],i).normalize(),o[0].crossVectors(r[0],s),c[0].crossVectors(r[0],o[0]);for(let b=1;b<=e;b++){if(o[b]=o[b-1].clone(),c[b]=c[b-1].clone(),s.crossVectors(r[b-1],r[b]),s.length()>Number.EPSILON){s.normalize();const S=Math.acos(ya(r[b-1].dot(r[b]),-1,1));o[b].applyMatrix4(d.makeRotationAxis(s,S))}c[b].crossVectors(r[b],o[b])}if(t===!0){let b=Math.acos(ya(o[0].dot(o[e]),-1,1));b/=e,r[0].dot(s.crossVectors(o[0],o[e]))>0&&(b=-b);for(let S=1;S<=e;S++)o[S].applyMatrix4(d.makeRotationAxis(r[S],b*S)),c[S].crossVectors(r[S],o[S])}return{tangents:r,normals:o,binormals:c}}clone(){return new this.constructor().copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class b1 extends Gl{constructor(e=0,t=0,i=1,r=1,o=0,c=Math.PI*2,s=!1,d=0){super(),this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=r,this.aStartAngle=o,this.aEndAngle=c,this.aClockwise=s,this.aRotation=d}getPoint(e,t){const i=t||new li,r=Math.PI*2;let o=this.aEndAngle-this.aStartAngle;const c=Math.abs(o)<Number.EPSILON;for(;o<0;)o+=r;for(;o>r;)o-=r;o<Number.EPSILON&&(c?o=0:o=r),this.aClockwise===!0&&!c&&(o===r?o=-r:o=o-r);const s=this.aStartAngle+e*o;let d=this.aX+this.xRadius*Math.cos(s),p=this.aY+this.yRadius*Math.sin(s);if(this.aRotation!==0){const g=Math.cos(this.aRotation),_=Math.sin(this.aRotation),x=d-this.aX,b=p-this.aY;d=x*g-b*_+this.aX,p=x*_+b*g+this.aY}return i.set(d,p)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}b1.prototype.isEllipseCurve=!0;class Lz extends b1{constructor(e,t,i,r,o,c){super(e,t,i,i,r,o,c),this.type="ArcCurve"}}Lz.prototype.isArcCurve=!0;function jC(){let n=0,e=0,t=0,i=0;function r(o,c,s,d){n=o,e=s,t=-3*o+3*c-2*s-d,i=2*o-2*c+s+d}return{initCatmullRom:function(o,c,s,d,p){r(c,s,p*(s-o),p*(d-c))},initNonuniformCatmullRom:function(o,c,s,d,p,g,_){let x=(c-o)/p-(s-o)/(p+g)+(s-c)/g,b=(s-c)/g-(d-c)/(g+_)+(d-s)/_;x*=g,b*=g,r(c,s,x,b)},calc:function(o){const c=o*o,s=c*o;return n+e*o+t*c+i*s}}}const px=new Ge,rM=new jC,sM=new jC,oM=new jC;class vy extends Gl{constructor(e=[],t=!1,i="centripetal",r=.5){super(),this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=i,this.tension=r}getPoint(e,t=new Ge){const i=t,r=this.points,o=r.length,c=(o-(this.closed?0:1))*e;let s=Math.floor(c),d=c-s;this.closed?s+=s>0?0:(Math.floor(Math.abs(s)/o)+1)*o:d===0&&s===o-1&&(s=o-2,d=1);let p,g;this.closed||s>0?p=r[(s-1)%o]:(px.subVectors(r[0],r[1]).add(r[0]),p=px);const _=r[s%o],x=r[(s+1)%o];if(this.closed||s+2<o?g=r[(s+2)%o]:(px.subVectors(r[o-1],r[o-2]).add(r[o-1]),g=px),this.curveType==="centripetal"||this.curveType==="chordal"){const b=this.curveType==="chordal"?.5:.25;let S=Math.pow(p.distanceToSquared(_),b),P=Math.pow(_.distanceToSquared(x),b),L=Math.pow(x.distanceToSquared(g),b);P<1e-4&&(P=1),S<1e-4&&(S=P),L<1e-4&&(L=P),rM.initNonuniformCatmullRom(p.x,_.x,x.x,g.x,S,P,L),sM.initNonuniformCatmullRom(p.y,_.y,x.y,g.y,S,P,L),oM.initNonuniformCatmullRom(p.z,_.z,x.z,g.z,S,P,L)}else this.curveType==="catmullrom"&&(rM.initCatmullRom(p.x,_.x,x.x,g.x,this.tension),sM.initCatmullRom(p.y,_.y,x.y,g.y,this.tension),oM.initCatmullRom(p.z,_.z,x.z,g.z,this.tension));return i.set(rM.calc(d),sM.calc(d),oM.calc(d)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const r=e.points[t];this.points.push(r.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const r=this.points[t];e.points.push(r.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const r=e.points[t];this.points.push(new Ge().fromArray(r))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}vy.prototype.isCatmullRomCurve3=!0;function HL(n,e,t,i,r){const o=(i-e)*.5,c=(r-t)*.5,s=n*n,d=n*s;return(2*t-2*i+o+c)*d+(-3*t+3*i-2*o-c)*s+o*n+t}function RJ(n,e){const t=1-n;return t*t*e}function LJ(n,e){return 2*(1-n)*n*e}function kJ(n,e){return n*n*e}function yy(n,e,t,i){return RJ(n,e)+LJ(n,t)+kJ(n,i)}function DJ(n,e){const t=1-n;return t*t*t*e}function FJ(n,e){const t=1-n;return 3*t*t*n*e}function OJ(n,e){return 3*(1-n)*n*n*e}function zJ(n,e){return n*n*n*e}function by(n,e,t,i,r){return DJ(n,e)+FJ(n,t)+OJ(n,i)+zJ(n,r)}class GC extends Gl{constructor(e=new li,t=new li,i=new li,r=new li){super(),this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=i,this.v3=r}getPoint(e,t=new li){const i=t,r=this.v0,o=this.v1,c=this.v2,s=this.v3;return i.set(by(e,r.x,o.x,c.x,s.x),by(e,r.y,o.y,c.y,s.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}GC.prototype.isCubicBezierCurve=!0;class kz extends Gl{constructor(e=new Ge,t=new Ge,i=new Ge,r=new Ge){super(),this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=i,this.v3=r}getPoint(e,t=new Ge){const i=t,r=this.v0,o=this.v1,c=this.v2,s=this.v3;return i.set(by(e,r.x,o.x,c.x,s.x),by(e,r.y,o.y,c.y,s.y),by(e,r.z,o.z,c.z,s.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}kz.prototype.isCubicBezierCurve3=!0;class x1 extends Gl{constructor(e=new li,t=new li){super(),this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new li){const i=t;return e===1?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t){const i=t||new li;return i.copy(this.v2).sub(this.v1).normalize(),i}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}x1.prototype.isLineCurve=!0;class BJ extends Gl{constructor(e=new Ge,t=new Ge){super(),this.type="LineCurve3",this.isLineCurve3=!0,this.v1=e,this.v2=t}getPoint(e,t=new Ge){const i=t;return e===1?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class qC extends Gl{constructor(e=new li,t=new li,i=new li){super(),this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new li){const i=t,r=this.v0,o=this.v1,c=this.v2;return i.set(yy(e,r.x,o.x,c.x),yy(e,r.y,o.y,c.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}qC.prototype.isQuadraticBezierCurve=!0;class Dz extends Gl{constructor(e=new Ge,t=new Ge,i=new Ge){super(),this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new Ge){const i=t,r=this.v0,o=this.v1,c=this.v2;return i.set(yy(e,r.x,o.x,c.x),yy(e,r.y,o.y,c.y),yy(e,r.z,o.z,c.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}Dz.prototype.isQuadraticBezierCurve3=!0;class WC extends Gl{constructor(e=[]){super(),this.type="SplineCurve",this.points=e}getPoint(e,t=new li){const i=t,r=this.points,o=(r.length-1)*e,c=Math.floor(o),s=o-c,d=r[c===0?c:c-1],p=r[c],g=r[c>r.length-2?r.length-1:c+1],_=r[c>r.length-3?r.length-1:c+2];return i.set(HL(s,d.x,p.x,g.x,_.x),HL(s,d.y,p.y,g.y,_.y)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const r=e.points[t];this.points.push(r.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const r=this.points[t];e.points.push(r.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const r=e.points[t];this.points.push(new li().fromArray(r))}return this}}WC.prototype.isSplineCurve=!0;var Fz=Object.freeze({__proto__:null,ArcCurve:Lz,CatmullRomCurve3:vy,CubicBezierCurve:GC,CubicBezierCurve3:kz,EllipseCurve:b1,LineCurve:x1,LineCurve3:BJ,QuadraticBezierCurve:qC,QuadraticBezierCurve3:Dz,SplineCurve:WC});class NJ extends Gl{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new x1(t,e))}getPoint(e,t){const i=e*this.getLength(),r=this.getCurveLengths();let o=0;for(;o<r.length;){if(r[o]>=i){const c=r[o]-i,s=this.curves[o],d=s.getLength(),p=d===0?0:1-c/d;return s.getPointAt(p,t)}o++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let i=0,r=this.curves.length;i<r;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let i;for(let r=0,o=this.curves;r<o.length;r++){const c=o[r],s=c&&c.isEllipseCurve?e*2:c&&(c.isLineCurve||c.isLineCurve3)?1:c&&c.isSplineCurve?e*c.points.length:e,d=c.getPoints(s);for(let p=0;p<d.length;p++){const g=d[p];i&&i.equals(g)||(t.push(g),i=g)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const r=e.curves[t];this.curves.push(r.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,i=this.curves.length;t<i;t++){const r=this.curves[t];e.curves.push(r.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const r=e.curves[t];this.curves.push(new Fz[r.type]().fromJSON(r))}return this}}class m2 extends NJ{constructor(e){super(),this.type="Path",this.currentPoint=new li,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const i=new x1(this.currentPoint.clone(),new li(e,t));return this.curves.push(i),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,i,r){const o=new qC(this.currentPoint.clone(),new li(e,t),new li(i,r));return this.curves.push(o),this.currentPoint.set(i,r),this}bezierCurveTo(e,t,i,r,o,c){const s=new GC(this.currentPoint.clone(),new li(e,t),new li(i,r),new li(o,c));return this.curves.push(s),this.currentPoint.set(o,c),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),i=new WC(t);return this.curves.push(i),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,i,r,o,c){const s=this.currentPoint.x,d=this.currentPoint.y;return this.absarc(e+s,t+d,i,r,o,c),this}absarc(e,t,i,r,o,c){return this.absellipse(e,t,i,i,r,o,c),this}ellipse(e,t,i,r,o,c,s,d){const p=this.currentPoint.x,g=this.currentPoint.y;return this.absellipse(e+p,t+g,i,r,o,c,s,d),this}absellipse(e,t,i,r,o,c,s,d){const p=new b1(e,t,i,r,o,c,s,d);if(this.curves.length>0){const _=p.getPoint(0);_.equals(this.currentPoint)||this.lineTo(_.x,_.y)}this.curves.push(p);const g=p.getPoint(1);return this.currentPoint.copy(g),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class b0 extends m2{constructor(e){super(e),this.uuid=Mc(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let i=0,r=this.holes.length;i<r;i++)t[i]=this.holes[i].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){const r=e.holes[t];this.holes.push(r.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,i=this.holes.length;t<i;t++){const r=this.holes[t];e.holes.push(r.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){const r=e.holes[t];this.holes.push(new m2().fromJSON(r))}return this}}const $J={triangulate:function(n,e,t=2){const i=e&&e.length,r=i?e[0]*t:n.length;let o=Oz(n,0,r,t,!0);const c=[];if(!o||o.next===o.prev)return c;let s,d,p,g,_,x,b;if(i&&(o=qJ(n,e,o,t)),n.length>80*t){s=p=n[0],d=g=n[1];for(let S=t;S<r;S+=t)_=n[S],x=n[S+1],_<s&&(s=_),x<d&&(d=x),_>p&&(p=_),x>g&&(g=x);b=Math.max(p-s,g-d),b=b!==0?1/b:0}return Uy(o,c,t,s,d,b),c}};function Oz(n,e,t,i,r){let o,c;if(r===iQ(n,e,t,i)>0)for(o=e;o<t;o+=i)c=ZL(o,n[o],n[o+1],c);else for(o=t-i;o>=e;o-=i)c=ZL(o,n[o],n[o+1],c);return c&&w1(c,c.next)&&(Gy(c),c=c.next),c}function Ud(n,e){if(!n)return n;e||(e=n);let t=n,i;do if(i=!1,!t.steiner&&(w1(t,t.next)||cs(t.prev,t,t.next)===0)){if(Gy(t),t=e=t.prev,t===t.next)break;i=!0}else t=t.next;while(i||t!==e);return e}function Uy(n,e,t,i,r,o,c){if(!n)return;!c&&o&&YJ(n,i,r,o);let s=n,d,p;for(;n.prev!==n.next;){if(d=n.prev,p=n.next,o?UJ(n,i,r,o):VJ(n)){e.push(d.i/t),e.push(n.i/t),e.push(p.i/t),Gy(n),n=p.next,s=p.next;continue}if(n=p,n===s){c?c===1?(n=jJ(Ud(n),e,t),Uy(n,e,t,i,r,o,2)):c===2&&GJ(n,e,t,i,r,o):Uy(Ud(n),e,t,i,r,o,1);break}}}function VJ(n){const e=n.prev,t=n,i=n.next;if(cs(e,t,i)>=0)return!1;let r=n.next.next;for(;r!==n.prev;){if(bg(e.x,e.y,t.x,t.y,i.x,i.y,r.x,r.y)&&cs(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function UJ(n,e,t,i){const r=n.prev,o=n,c=n.next;if(cs(r,o,c)>=0)return!1;const s=r.x<o.x?r.x<c.x?r.x:c.x:o.x<c.x?o.x:c.x,d=r.y<o.y?r.y<c.y?r.y:c.y:o.y<c.y?o.y:c.y,p=r.x>o.x?r.x>c.x?r.x:c.x:o.x>c.x?o.x:c.x,g=r.y>o.y?r.y>c.y?r.y:c.y:o.y>c.y?o.y:c.y,_=g2(s,d,e,t,i),x=g2(p,g,e,t,i);let b=n.prevZ,S=n.nextZ;for(;b&&b.z>=_&&S&&S.z<=x;){if(b!==n.prev&&b!==n.next&&bg(r.x,r.y,o.x,o.y,c.x,c.y,b.x,b.y)&&cs(b.prev,b,b.next)>=0||(b=b.prevZ,S!==n.prev&&S!==n.next&&bg(r.x,r.y,o.x,o.y,c.x,c.y,S.x,S.y)&&cs(S.prev,S,S.next)>=0))return!1;S=S.nextZ}for(;b&&b.z>=_;){if(b!==n.prev&&b!==n.next&&bg(r.x,r.y,o.x,o.y,c.x,c.y,b.x,b.y)&&cs(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;S&&S.z<=x;){if(S!==n.prev&&S!==n.next&&bg(r.x,r.y,o.x,o.y,c.x,c.y,S.x,S.y)&&cs(S.prev,S,S.next)>=0)return!1;S=S.nextZ}return!0}function jJ(n,e,t){let i=n;do{const r=i.prev,o=i.next.next;!w1(r,o)&&zz(r,i,i.next,o)&&jy(r,o)&&jy(o,r)&&(e.push(r.i/t),e.push(i.i/t),e.push(o.i/t),Gy(i),Gy(i.next),i=n=o),i=i.next}while(i!==n);return Ud(i)}function GJ(n,e,t,i,r,o){let c=n;do{let s=c.next.next;for(;s!==c.prev;){if(c.i!==s.i&&QJ(c,s)){let d=Bz(c,s);c=Ud(c,c.next),d=Ud(d,d.next),Uy(c,e,t,i,r,o),Uy(d,e,t,i,r,o);return}s=s.next}c=c.next}while(c!==n)}function qJ(n,e,t,i){const r=[];let o,c,s,d,p;for(o=0,c=e.length;o<c;o++)s=e[o]*i,d=o<c-1?e[o+1]*i:n.length,p=Oz(n,s,d,i,!1),p===p.next&&(p.steiner=!0),r.push(JJ(p));for(r.sort(WJ),o=0;o<r.length;o++)HJ(r[o],t),t=Ud(t,t.next);return t}function WJ(n,e){return n.x-e.x}function HJ(n,e){if(e=ZJ(n,e),e){const t=Bz(e,n);Ud(e,e.next),Ud(t,t.next)}}function ZJ(n,e){let t=e;const i=n.x,r=n.y;let o=-1/0,c;do{if(r<=t.y&&r>=t.next.y&&t.next.y!==t.y){const x=t.x+(r-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(x<=i&&x>o){if(o=x,x===i){if(r===t.y)return t;if(r===t.next.y)return t.next}c=t.x<t.next.x?t:t.next}}t=t.next}while(t!==e);if(!c)return null;if(i===o)return c;const s=c,d=c.x,p=c.y;let g=1/0,_;t=c;do i>=t.x&&t.x>=d&&i!==t.x&&bg(r<p?i:o,r,d,p,r<p?o:i,r,t.x,t.y)&&(_=Math.abs(r-t.y)/(i-t.x),jy(t,n)&&(_<g||_===g&&(t.x>c.x||t.x===c.x&&XJ(c,t)))&&(c=t,g=_)),t=t.next;while(t!==s);return c}function XJ(n,e){return cs(n.prev,n,e.prev)<0&&cs(e.next,n,n.next)<0}function YJ(n,e,t,i){let r=n;do r.z===null&&(r.z=g2(r.x,r.y,e,t,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next;while(r!==n);r.prevZ.nextZ=null,r.prevZ=null,KJ(r)}function KJ(n){let e,t,i,r,o,c,s,d,p=1;do{for(t=n,n=null,o=null,c=0;t;){for(c++,i=t,s=0,e=0;e<p&&(s++,i=i.nextZ,!!i);e++);for(d=p;s>0||d>0&&i;)s!==0&&(d===0||!i||t.z<=i.z)?(r=t,t=t.nextZ,s--):(r=i,i=i.nextZ,d--),o?o.nextZ=r:n=r,r.prevZ=o,o=r;t=i}o.nextZ=null,p*=2}while(c>1);return n}function g2(n,e,t,i,r){return n=32767*(n-t)*r,e=32767*(e-i)*r,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n|e<<1}function JJ(n){let e=n,t=n;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==n);return t}function bg(n,e,t,i,r,o,c,s){return(r-c)*(e-s)-(n-c)*(o-s)>=0&&(n-c)*(i-s)-(t-c)*(e-s)>=0&&(t-c)*(o-s)-(r-c)*(i-s)>=0}function QJ(n,e){return n.next.i!==e.i&&n.prev.i!==e.i&&!eQ(n,e)&&(jy(n,e)&&jy(e,n)&&tQ(n,e)&&(cs(n.prev,n,e.prev)||cs(n,e.prev,e))||w1(n,e)&&cs(n.prev,n,n.next)>0&&cs(e.prev,e,e.next)>0)}function cs(n,e,t){return(e.y-n.y)*(t.x-e.x)-(e.x-n.x)*(t.y-e.y)}function w1(n,e){return n.x===e.x&&n.y===e.y}function zz(n,e,t,i){const r=gx(cs(n,e,t)),o=gx(cs(n,e,i)),c=gx(cs(t,i,n)),s=gx(cs(t,i,e));return!!(r!==o&&c!==s||r===0&&mx(n,t,e)||o===0&&mx(n,i,e)||c===0&&mx(t,n,i)||s===0&&mx(t,e,i))}function mx(n,e,t){return e.x<=Math.max(n.x,t.x)&&e.x>=Math.min(n.x,t.x)&&e.y<=Math.max(n.y,t.y)&&e.y>=Math.min(n.y,t.y)}function gx(n){return n>0?1:n<0?-1:0}function eQ(n,e){let t=n;do{if(t.i!==n.i&&t.next.i!==n.i&&t.i!==e.i&&t.next.i!==e.i&&zz(t,t.next,n,e))return!0;t=t.next}while(t!==n);return!1}function jy(n,e){return cs(n.prev,n,n.next)<0?cs(n,e,n.next)>=0&&cs(n,n.prev,e)>=0:cs(n,e,n.prev)<0||cs(n,n.next,e)<0}function tQ(n,e){let t=n,i=!1;const r=(n.x+e.x)/2,o=(n.y+e.y)/2;do t.y>o!=t.next.y>o&&t.next.y!==t.y&&r<(t.next.x-t.x)*(o-t.y)/(t.next.y-t.y)+t.x&&(i=!i),t=t.next;while(t!==n);return i}function Bz(n,e){const t=new _2(n.i,n.x,n.y),i=new _2(e.i,e.x,e.y),r=n.next,o=e.prev;return n.next=e,e.prev=n,t.next=r,r.prev=t,i.next=t,t.prev=i,o.next=i,i.prev=o,i}function ZL(n,e,t,i){const r=new _2(n,e,t);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Gy(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function _2(n,e,t){this.i=n,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function iQ(n,e,t,i){let r=0;for(let o=e,c=t-i;o<t;o+=i)r+=(n[c]-n[o])*(n[o+1]+n[c+1]),c=o;return r}class Dd{static area(e){const t=e.length;let i=0;for(let r=t-1,o=0;o<t;r=o++)i+=e[r].x*e[o].y-e[o].x*e[r].y;return i*.5}static isClockWise(e){return Dd.area(e)<0}static triangulateShape(e,t){const i=[],r=[],o=[];XL(e),YL(i,e);let c=e.length;t.forEach(XL);for(let d=0;d<t.length;d++)r.push(c),c+=t[d].length,YL(i,t[d]);const s=$J.triangulate(i,r);for(let d=0;d<s.length;d+=3)o.push(s.slice(d,d+3));return o}}function XL(n){const e=n.length;e>2&&n[e-1].equals(n[0])&&n.pop()}function YL(n,e){for(let t=0;t<e.length;t++)n.push(e[t].x),n.push(e[t].y)}class m_ extends jn{constructor(e=new b0([new li(.5,.5),new li(-.5,.5),new li(-.5,-.5),new li(.5,-.5)]),t={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const i=this,r=[],o=[];for(let s=0,d=e.length;s<d;s++){const p=e[s];c(p)}this.setAttribute("position",new ws(r,3)),this.setAttribute("uv",new ws(o,2)),this.computeVertexNormals();function c(s){const d=[],p=t.curveSegments!==void 0?t.curveSegments:12,g=t.steps!==void 0?t.steps:1;let _=t.depth!==void 0?t.depth:1,x=t.bevelEnabled!==void 0?t.bevelEnabled:!0,b=t.bevelThickness!==void 0?t.bevelThickness:.2,S=t.bevelSize!==void 0?t.bevelSize:b-.1,P=t.bevelOffset!==void 0?t.bevelOffset:0,L=t.bevelSegments!==void 0?t.bevelSegments:3;const E=t.extrudePath,C=t.UVGenerator!==void 0?t.UVGenerator:nQ;t.amount!==void 0&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),_=t.amount);let D,O=!1,U,j,G,N;E&&(D=E.getSpacedPoints(g),O=!0,x=!1,U=E.computeFrenetFrames(g,!1),j=new Ge,G=new Ge,N=new Ge),x||(L=0,b=0,S=0,P=0);const V=s.extractPoints(p);let q=V.shape;const z=V.holes;if(!Dd.isClockWise(q)){q=q.reverse();for(let fe=0,Ve=z.length;fe<Ve;fe++){const tt=z[fe];Dd.isClockWise(tt)&&(z[fe]=tt.reverse())}}const X=Dd.triangulateShape(q,z),re=q;for(let fe=0,Ve=z.length;fe<Ve;fe++){const tt=z[fe];q=q.concat(tt)}function oe(fe,Ve,tt){return Ve||console.error("THREE.ExtrudeGeometry: vec does not exist"),Ve.clone().multiplyScalar(tt).add(fe)}const de=q.length,ce=X.length;function Se(fe,Ve,tt){let Mt,mt,Ce;const xe=fe.x-Ve.x,vt=fe.y-Ve.y,be=tt.x-fe.x,ie=tt.y-fe.y,ae=xe*xe+vt*vt,De=xe*ie-vt*be;if(Math.abs(De)>Number.EPSILON){const Xe=Math.sqrt(ae),bt=Math.sqrt(be*be+ie*ie),Te=Ve.x-vt/Xe,te=Ve.y+xe/Xe,he=tt.x-ie/bt,pe=tt.y+be/bt,Re=((he-Te)*ie-(pe-te)*be)/(xe*ie-vt*be);Mt=Te+xe*Re-fe.x,mt=te+vt*Re-fe.y;const Oe=Mt*Mt+mt*mt;if(Oe<=2)return new li(Mt,mt);Ce=Math.sqrt(Oe/2)}else{let Xe=!1;xe>Number.EPSILON?be>Number.EPSILON&&(Xe=!0):xe<-Number.EPSILON?be<-Number.EPSILON&&(Xe=!0):Math.sign(vt)===Math.sign(ie)&&(Xe=!0),Xe?(Mt=-vt,mt=xe,Ce=Math.sqrt(ae)):(Mt=xe,mt=vt,Ce=Math.sqrt(ae/2))}return new li(Mt/Ce,mt/Ce)}const Pe=[];for(let fe=0,Ve=re.length,tt=Ve-1,Mt=fe+1;fe<Ve;fe++,tt++,Mt++)tt===Ve&&(tt=0),Mt===Ve&&(Mt=0),Pe[fe]=Se(re[fe],re[tt],re[Mt]);const je=[];let Fe,qe=Pe.concat();for(let fe=0,Ve=z.length;fe<Ve;fe++){const tt=z[fe];Fe=[];for(let Mt=0,mt=tt.length,Ce=mt-1,xe=Mt+1;Mt<mt;Mt++,Ce++,xe++)Ce===mt&&(Ce=0),xe===mt&&(xe=0),Fe[Mt]=Se(tt[Mt],tt[Ce],tt[xe]);je.push(Fe),qe=qe.concat(Fe)}for(let fe=0;fe<L;fe++){const Ve=fe/L,tt=b*Math.cos(Ve*Math.PI/2),Mt=S*Math.sin(Ve*Math.PI/2)+P;for(let mt=0,Ce=re.length;mt<Ce;mt++){const xe=oe(re[mt],Pe[mt],Mt);Be(xe.x,xe.y,-tt)}for(let mt=0,Ce=z.length;mt<Ce;mt++){const xe=z[mt];Fe=je[mt];for(let vt=0,be=xe.length;vt<be;vt++){const ie=oe(xe[vt],Fe[vt],Mt);Be(ie.x,ie.y,-tt)}}}const Ue=S+P;for(let fe=0;fe<de;fe++){const Ve=x?oe(q[fe],qe[fe],Ue):q[fe];O?(G.copy(U.normals[0]).multiplyScalar(Ve.x),j.copy(U.binormals[0]).multiplyScalar(Ve.y),N.copy(D[0]).add(G).add(j),Be(N.x,N.y,N.z)):Be(Ve.x,Ve.y,0)}for(let fe=1;fe<=g;fe++)for(let Ve=0;Ve<de;Ve++){const tt=x?oe(q[Ve],qe[Ve],Ue):q[Ve];O?(G.copy(U.normals[fe]).multiplyScalar(tt.x),j.copy(U.binormals[fe]).multiplyScalar(tt.y),N.copy(D[fe]).add(G).add(j),Be(N.x,N.y,N.z)):Be(tt.x,tt.y,_/g*fe)}for(let fe=L-1;fe>=0;fe--){const Ve=fe/L,tt=b*Math.cos(Ve*Math.PI/2),Mt=S*Math.sin(Ve*Math.PI/2)+P;for(let mt=0,Ce=re.length;mt<Ce;mt++){const xe=oe(re[mt],Pe[mt],Mt);Be(xe.x,xe.y,_+tt)}for(let mt=0,Ce=z.length;mt<Ce;mt++){const xe=z[mt];Fe=je[mt];for(let vt=0,be=xe.length;vt<be;vt++){const ie=oe(xe[vt],Fe[vt],Mt);O?Be(ie.x,ie.y+D[g-1].y,D[g-1].x+tt):Be(ie.x,ie.y,_+tt)}}}ke(),et();function ke(){const fe=r.length/3;if(x){let Ve=0,tt=de*Ve;for(let Mt=0;Mt<ce;Mt++){const mt=X[Mt];Je(mt[2]+tt,mt[1]+tt,mt[0]+tt)}Ve=g+L*2,tt=de*Ve;for(let Mt=0;Mt<ce;Mt++){const mt=X[Mt];Je(mt[0]+tt,mt[1]+tt,mt[2]+tt)}}else{for(let Ve=0;Ve<ce;Ve++){const tt=X[Ve];Je(tt[2],tt[1],tt[0])}for(let Ve=0;Ve<ce;Ve++){const tt=X[Ve];Je(tt[0]+de*g,tt[1]+de*g,tt[2]+de*g)}}i.addGroup(fe,r.length/3-fe,0)}function et(){const fe=r.length/3;let Ve=0;ye(re,Ve),Ve+=re.length;for(let tt=0,Mt=z.length;tt<Mt;tt++){const mt=z[tt];ye(mt,Ve),Ve+=mt.length}i.addGroup(fe,r.length/3-fe,1)}function ye(fe,Ve){let tt=fe.length;for(;--tt>=0;){const Mt=tt;let mt=tt-1;mt<0&&(mt=fe.length-1);for(let Ce=0,xe=g+L*2;Ce<xe;Ce++){const vt=de*Ce,be=de*(Ce+1),ie=Ve+Mt+vt,ae=Ve+mt+vt,De=Ve+mt+be,Xe=Ve+Mt+be;ct(ie,ae,De,Xe)}}}function Be(fe,Ve,tt){d.push(fe),d.push(Ve),d.push(tt)}function Je(fe,Ve,tt){yt(fe),yt(Ve),yt(tt);const Mt=r.length/3,mt=C.generateTopUV(i,r,Mt-3,Mt-2,Mt-1);we(mt[0]),we(mt[1]),we(mt[2])}function ct(fe,Ve,tt,Mt){yt(fe),yt(Ve),yt(Mt),yt(Ve),yt(tt),yt(Mt);const mt=r.length/3,Ce=C.generateSideWallUV(i,r,mt-6,mt-3,mt-2,mt-1);we(Ce[0]),we(Ce[1]),we(Ce[3]),we(Ce[1]),we(Ce[2]),we(Ce[3])}function yt(fe){r.push(d[fe*3+0]),r.push(d[fe*3+1]),r.push(d[fe*3+2])}function we(fe){o.push(fe.x),o.push(fe.y)}}}toJSON(){const e=super.toJSON(),t=this.parameters.shapes,i=this.parameters.options;return rQ(t,i,e)}static fromJSON(e,t){const i=[];for(let o=0,c=e.shapes.length;o<c;o++){const s=t[e.shapes[o]];i.push(s)}const r=e.options.extrudePath;return r!==void 0&&(e.options.extrudePath=new Fz[r.type]().fromJSON(r)),new m_(i,e.options)}}const nQ={generateTopUV:function(n,e,t,i,r){const o=e[t*3],c=e[t*3+1],s=e[i*3],d=e[i*3+1],p=e[r*3],g=e[r*3+1];return[new li(o,c),new li(s,d),new li(p,g)]},generateSideWallUV:function(n,e,t,i,r,o){const c=e[t*3],s=e[t*3+1],d=e[t*3+2],p=e[i*3],g=e[i*3+1],_=e[i*3+2],x=e[r*3],b=e[r*3+1],S=e[r*3+2],P=e[o*3],L=e[o*3+1],E=e[o*3+2];return Math.abs(s-g)<Math.abs(c-p)?[new li(c,1-d),new li(p,1-_),new li(x,1-S),new li(P,1-E)]:[new li(s,1-d),new li(g,1-_),new li(b,1-S),new li(L,1-E)]}};function rQ(n,e,t){if(t.shapes=[],Array.isArray(n))for(let i=0,r=n.length;i<r;i++){const o=n[i];t.shapes.push(o.uuid)}else t.shapes.push(n.uuid);return e.extrudePath!==void 0&&(t.options.extrudePath=e.extrudePath.toJSON()),t}class HC extends jn{constructor(e=new b0([new li(0,.5),new li(-.5,-.5),new li(.5,-.5)]),t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const i=[],r=[],o=[],c=[];let s=0,d=0;if(Array.isArray(e)===!1)p(e);else for(let g=0;g<e.length;g++)p(e[g]),this.addGroup(s,d,g),s+=d,d=0;this.setIndex(i),this.setAttribute("position",new ws(r,3)),this.setAttribute("normal",new ws(o,3)),this.setAttribute("uv",new ws(c,2));function p(g){const _=r.length/3,x=g.extractPoints(t);let b=x.shape;const S=x.holes;Dd.isClockWise(b)===!1&&(b=b.reverse());for(let L=0,E=S.length;L<E;L++){const C=S[L];Dd.isClockWise(C)===!0&&(S[L]=C.reverse())}const P=Dd.triangulateShape(b,S);for(let L=0,E=S.length;L<E;L++){const C=S[L];b=b.concat(C)}for(let L=0,E=b.length;L<E;L++){const C=b[L];r.push(C.x,C.y,0),o.push(0,0,1),c.push(C.x,C.y)}for(let L=0,E=P.length;L<E;L++){const C=P[L],D=C[0]+_,O=C[1]+_,U=C[2]+_;i.push(D,O,U),d+=3}}}toJSON(){const e=super.toJSON(),t=this.parameters.shapes;return sQ(t,e)}static fromJSON(e,t){const i=[];for(let r=0,o=e.shapes.length;r<o;r++){const c=t[e.shapes[r]];i.push(c)}return new HC(i,e.curveSegments)}}function sQ(n,e){if(e.shapes=[],Array.isArray(n))for(let t=0,i=n.length;t<i;t++){const r=n[t];e.shapes.push(r.uuid)}else e.shapes.push(n.uuid);return e}class ZC extends jn{constructor(e=1,t=32,i=16,r=0,o=Math.PI*2,c=0,s=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:r,phiLength:o,thetaStart:c,thetaLength:s},t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));const d=Math.min(c+s,Math.PI);let p=0;const g=[],_=new Ge,x=new Ge,b=[],S=[],P=[],L=[];for(let E=0;E<=i;E++){const C=[],D=E/i;let O=0;E==0&&c==0?O=.5/t:E==i&&d==Math.PI&&(O=-.5/t);for(let U=0;U<=t;U++){const j=U/t;_.x=-e*Math.cos(r+j*o)*Math.sin(c+D*s),_.y=e*Math.cos(c+D*s),_.z=e*Math.sin(r+j*o)*Math.sin(c+D*s),S.push(_.x,_.y,_.z),x.copy(_).normalize(),P.push(x.x,x.y,x.z),L.push(j+O,1-D),C.push(p++)}g.push(C)}for(let E=0;E<i;E++)for(let C=0;C<t;C++){const D=g[E][C+1],O=g[E][C],U=g[E+1][C],j=g[E+1][C+1];(E!==0||c>0)&&b.push(D,O,j),(E!==i-1||d<Math.PI)&&b.push(O,U,j)}this.setIndex(b),this.setAttribute("position",new ws(S,3)),this.setAttribute("normal",new ws(P,3)),this.setAttribute("uv",new ws(L,2))}static fromJSON(e){return new ZC(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class oQ extends Vo{constructor(e){super(),this.type="ShadowMaterial",this.color=new $i(0),this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this}}oQ.prototype.isShadowMaterial=!0;class Nz extends Vo{constructor(e){super(),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new $i(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $i(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=h_,this.normalScale=new li(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}Nz.prototype.isMeshStandardMaterial=!0;class aQ extends Nz{constructor(e){super(),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new li(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return ya(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(t){this.ior=(1+.4*t)/(1-.4*t)}}),this.sheenColor=new $i(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=.01,this.thicknessMap=null,this.attenuationDistance=0,this.attenuationColor=new $i(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new $i(1,1,1),this.specularColorMap=null,this._sheen=0,this._clearcoat=0,this._transmission=0,this.setValues(e)}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.ior=e.ior,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}aQ.prototype.isMeshPhysicalMaterial=!0;class lQ extends Vo{constructor(e){super(),this.type="MeshPhongMaterial",this.color=new $i(16777215),this.specular=new $i(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $i(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=h_,this.normalScale=new li(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=u1,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}lQ.prototype.isMeshPhongMaterial=!0;class cQ extends Vo{constructor(e){super(),this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new $i(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $i(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=h_,this.normalScale=new li(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this}}cQ.prototype.isMeshToonMaterial=!0;class uQ extends Vo{constructor(e){super(),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=h_,this.normalScale=new li(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}uQ.prototype.isMeshNormalMaterial=!0;class hQ extends Vo{constructor(e){super(),this.type="MeshLambertMaterial",this.color=new $i(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $i(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=u1,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this}}hQ.prototype.isMeshLambertMaterial=!0;class dQ extends Vo{constructor(e){super(),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new $i(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=h_,this.normalScale=new li(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this}}dQ.prototype.isMeshMatcapMaterial=!0;class fQ extends Ih{constructor(e){super(),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}fQ.prototype.isLineDashedMaterial=!0;const ts={arraySlice:function(n,e,t){return ts.isTypedArray(n)?new n.constructor(n.subarray(e,t!==void 0?t:n.length)):n.slice(e,t)},convertArray:function(n,e,t){return!n||!t&&n.constructor===e?n:typeof e.BYTES_PER_ELEMENT=="number"?new e(n):Array.prototype.slice.call(n)},isTypedArray:function(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)},getKeyframeOrder:function(n){function e(r,o){return n[r]-n[o]}const t=n.length,i=new Array(t);for(let r=0;r!==t;++r)i[r]=r;return i.sort(e),i},sortedArray:function(n,e,t){const i=n.length,r=new n.constructor(i);for(let o=0,c=0;c!==i;++o){const s=t[o]*e;for(let d=0;d!==e;++d)r[c++]=n[s+d]}return r},flattenJSON:function(n,e,t,i){let r=1,o=n[0];for(;o!==void 0&&o[i]===void 0;)o=n[r++];if(o===void 0)return;let c=o[i];if(c!==void 0)if(Array.isArray(c))do c=o[i],c!==void 0&&(e.push(o.time),t.push.apply(t,c)),o=n[r++];while(o!==void 0);else if(c.toArray!==void 0)do c=o[i],c!==void 0&&(e.push(o.time),c.toArray(t,t.length)),o=n[r++];while(o!==void 0);else do c=o[i],c!==void 0&&(e.push(o.time),t.push(c)),o=n[r++];while(o!==void 0)},subclip:function(n,e,t,i,r=30){const o=n.clone();o.name=e;const c=[];for(let d=0;d<o.tracks.length;++d){const p=o.tracks[d],g=p.getValueSize(),_=[],x=[];for(let b=0;b<p.times.length;++b){const S=p.times[b]*r;if(!(S<t||S>=i)){_.push(p.times[b]);for(let P=0;P<g;++P)x.push(p.values[b*g+P])}}_.length!==0&&(p.times=ts.convertArray(_,p.times.constructor),p.values=ts.convertArray(x,p.values.constructor),c.push(p))}o.tracks=c;let s=1/0;for(let d=0;d<o.tracks.length;++d)s>o.tracks[d].times[0]&&(s=o.tracks[d].times[0]);for(let d=0;d<o.tracks.length;++d)o.tracks[d].shift(-1*s);return o.resetDuration(),o},makeClipAdditive:function(n,e=0,t=n,i=30){i<=0&&(i=30);const r=t.tracks.length,o=e/i;for(let c=0;c<r;++c){const s=t.tracks[c],d=s.ValueTypeName;if(d==="bool"||d==="string")continue;const p=n.tracks.find(function(E){return E.name===s.name&&E.ValueTypeName===d});if(p===void 0)continue;let g=0;const _=s.getValueSize();s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(g=_/3);let x=0;const b=p.getValueSize();p.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(x=b/3);const S=s.times.length-1;let P;if(o<=s.times[0]){const E=g,C=_-g;P=ts.arraySlice(s.values,E,C)}else if(o>=s.times[S]){const E=S*_+g,C=E+_-g;P=ts.arraySlice(s.values,E,C)}else{const E=s.createInterpolant(),C=g,D=_-g;E.evaluate(o),P=ts.arraySlice(E.resultBuffer,C,D)}d==="quaternion"&&new yo().fromArray(P).normalize().conjugate().toArray(P);const L=p.times.length;for(let E=0;E<L;++E){const C=E*b+x;if(d==="quaternion")yo.multiplyQuaternionsFlat(p.values,C,P,0,p.values,C);else{const D=b-x*2;for(let O=0;O<D;++O)p.values[C+O]-=P[O]}}}return n.blendMode=ez,n}};class jd{constructor(e,t,i,r){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=r!==void 0?r:new t.constructor(i),this.sampleValues=t,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let i=this._cachedIndex,r=t[i],o=t[i-1];e:{t:{let c;i:{n:if(!(e<r)){for(let s=i+2;;){if(r===void 0){if(e<o)break n;return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,e,o)}if(i===s)break;if(o=r,r=t[++i],e<r)break t}c=t.length;break i}if(!(e>=o)){const s=t[1];e<s&&(i=2,o=s);for(let d=i-2;;){if(o===void 0)return this._cachedIndex=0,this.beforeStart_(0,e,r);if(i===d)break;if(r=o,o=t[--i-1],e>=o)break t}c=i,i=0;break i}break e}for(;i<c;){const s=i+c>>>1;e<t[s]?c=s:i=s+1}if(r=t[i],o=t[i-1],o===void 0)return this._cachedIndex=0,this.beforeStart_(0,e,r);if(r===void 0)return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,o,e)}this._cachedIndex=i,this.intervalChanged_(i,o,r)}return this.interpolate_(i,o,e,r)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,r=this.valueSize,o=e*r;for(let c=0;c!==r;++c)t[c]=i[o+c];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}jd.prototype.beforeStart_=jd.prototype.copySampleValue_;jd.prototype.afterEnd_=jd.prototype.copySampleValue_;class pQ extends jd{constructor(e,t,i,r){super(e,t,i,r),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:vg,endingEnd:vg}}intervalChanged_(e,t,i){const r=this.parameterPositions;let o=e-2,c=e+1,s=r[o],d=r[c];if(s===void 0)switch(this.getSettings_().endingStart){case yg:o=e,s=2*t-i;break;case Aw:o=r.length-2,s=t+r[o]-r[o+1];break;default:o=e,s=i}if(d===void 0)switch(this.getSettings_().endingEnd){case yg:c=e,d=2*i-t;break;case Aw:c=1,d=i+r[1]-r[0];break;default:c=e-1,d=t}const p=(i-t)*.5,g=this.valueSize;this._weightPrev=p/(t-s),this._weightNext=p/(d-i),this._offsetPrev=o*g,this._offsetNext=c*g}interpolate_(e,t,i,r){const o=this.resultBuffer,c=this.sampleValues,s=this.valueSize,d=e*s,p=d-s,g=this._offsetPrev,_=this._offsetNext,x=this._weightPrev,b=this._weightNext,S=(i-t)/(r-t),P=S*S,L=P*S,E=-x*L+2*x*P-x*S,C=(1+x)*L+(-1.5-2*x)*P+(-.5+x)*S+1,D=(-1-b)*L+(1.5+b)*P+.5*S,O=b*L-b*P;for(let U=0;U!==s;++U)o[U]=E*c[g+U]+C*c[p+U]+D*c[d+U]+O*c[_+U];return o}}class $z extends jd{constructor(e,t,i,r){super(e,t,i,r)}interpolate_(e,t,i,r){const o=this.resultBuffer,c=this.sampleValues,s=this.valueSize,d=e*s,p=d-s,g=(i-t)/(r-t),_=1-g;for(let x=0;x!==s;++x)o[x]=c[p+x]*_+c[d+x]*g;return o}}class mQ extends jd{constructor(e,t,i,r){super(e,t,i,r)}interpolate_(e){return this.copySampleValue_(e-1)}}class Su{constructor(e,t,i,r){if(e===void 0)throw new Error("THREE.KeyframeTrack: track name is undefined");if(t===void 0||t.length===0)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=ts.convertArray(t,this.TimeBufferType),this.values=ts.convertArray(i,this.ValueBufferType),this.setInterpolation(r||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let i;if(t.toJSON!==this.toJSON)i=t.toJSON(e);else{i={name:e.name,times:ts.convertArray(e.times,Array),values:ts.convertArray(e.values,Array)};const r=e.getInterpolation();r!==e.DefaultInterpolation&&(i.interpolation=r)}return i.type=e.ValueTypeName,i}InterpolantFactoryMethodDiscrete(e){return new mQ(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new $z(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new pQ(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case Cw:t=this.InterpolantFactoryMethodDiscrete;break;case Ew:t=this.InterpolantFactoryMethodLinear;break;case ET:t=this.InterpolantFactoryMethodSmooth;break}if(t===void 0){const i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(this.createInterpolant===void 0)if(e!==this.DefaultInterpolation)this.setInterpolation(this.DefaultInterpolation);else throw new Error(i);return console.warn("THREE.KeyframeTrack:",i),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return Cw;case this.InterpolantFactoryMethodLinear:return Ew;case this.InterpolantFactoryMethodSmooth:return ET}}getValueSize(){return this.values.length/this.times.length}shift(e){if(e!==0){const t=this.times;for(let i=0,r=t.length;i!==r;++i)t[i]+=e}return this}scale(e){if(e!==1){const t=this.times;for(let i=0,r=t.length;i!==r;++i)t[i]*=e}return this}trim(e,t){const i=this.times,r=i.length;let o=0,c=r-1;for(;o!==r&&i[o]<e;)++o;for(;c!==-1&&i[c]>t;)--c;if(++c,o!==0||c!==r){o>=c&&(c=Math.max(c,1),o=c-1);const s=this.getValueSize();this.times=ts.arraySlice(i,o,c),this.values=ts.arraySlice(this.values,o*s,c*s)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!==0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const i=this.times,r=this.values,o=i.length;o===0&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let c=null;for(let s=0;s!==o;s++){const d=i[s];if(typeof d=="number"&&isNaN(d)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,s,d),e=!1;break}if(c!==null&&c>d){console.error("THREE.KeyframeTrack: Out of order keys.",this,s,d,c),e=!1;break}c=d}if(r!==void 0&&ts.isTypedArray(r))for(let s=0,d=r.length;s!==d;++s){const p=r[s];if(isNaN(p)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,s,p),e=!1;break}}return e}optimize(){const e=ts.arraySlice(this.times),t=ts.arraySlice(this.values),i=this.getValueSize(),r=this.getInterpolation()===ET,o=e.length-1;let c=1;for(let s=1;s<o;++s){let d=!1;const p=e[s],g=e[s+1];if(p!==g&&(s!==1||p!==e[0]))if(r)d=!0;else{const _=s*i,x=_-i,b=_+i;for(let S=0;S!==i;++S){const P=t[_+S];if(P!==t[x+S]||P!==t[b+S]){d=!0;break}}}if(d){if(s!==c){e[c]=e[s];const _=s*i,x=c*i;for(let b=0;b!==i;++b)t[x+b]=t[_+b]}++c}}if(o>0){e[c]=e[o];for(let s=o*i,d=c*i,p=0;p!==i;++p)t[d+p]=t[s+p];++c}return c!==e.length?(this.times=ts.arraySlice(e,0,c),this.values=ts.arraySlice(t,0,c*i)):(this.times=e,this.values=t),this}clone(){const e=ts.arraySlice(this.times,0),t=ts.arraySlice(this.values,0),i=this.constructor,r=new i(this.name,e,t);return r.createInterpolant=this.createInterpolant,r}}Su.prototype.TimeBufferType=Float32Array;Su.prototype.ValueBufferType=Float32Array;Su.prototype.DefaultInterpolation=Ew;class g_ extends Su{}g_.prototype.ValueTypeName="bool";g_.prototype.ValueBufferType=Array;g_.prototype.DefaultInterpolation=Cw;g_.prototype.InterpolantFactoryMethodLinear=void 0;g_.prototype.InterpolantFactoryMethodSmooth=void 0;class Vz extends Su{}Vz.prototype.ValueTypeName="color";class Iw extends Su{}Iw.prototype.ValueTypeName="number";class gQ extends jd{constructor(e,t,i,r){super(e,t,i,r)}interpolate_(e,t,i,r){const o=this.resultBuffer,c=this.sampleValues,s=this.valueSize,d=(i-t)/(r-t);let p=e*s;for(let g=p+s;p!==g;p+=4)yo.slerpFlat(o,0,c,p-s,c,p,d);return o}}class x0 extends Su{InterpolantFactoryMethodLinear(e){return new gQ(this.times,this.values,this.getValueSize(),e)}}x0.prototype.ValueTypeName="quaternion";x0.prototype.DefaultInterpolation=Ew;x0.prototype.InterpolantFactoryMethodSmooth=void 0;class __ extends Su{}__.prototype.ValueTypeName="string";__.prototype.ValueBufferType=Array;__.prototype.DefaultInterpolation=Cw;__.prototype.InterpolantFactoryMethodLinear=void 0;__.prototype.InterpolantFactoryMethodSmooth=void 0;class Rw extends Su{}Rw.prototype.ValueTypeName="vector";class KL{constructor(e,t=-1,i,r=DC){this.name=e,this.tracks=i,this.duration=t,this.blendMode=r,this.uuid=Mc(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],i=e.tracks,r=1/(e.fps||1);for(let c=0,s=i.length;c!==s;++c)t.push(vQ(i[c]).scale(r));const o=new this(e.name,e.duration,t,e.blendMode);return o.uuid=e.uuid,o}static toJSON(e){const t=[],i=e.tracks,r={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let o=0,c=i.length;o!==c;++o)t.push(Su.toJSON(i[o]));return r}static CreateFromMorphTargetSequence(e,t,i,r){const o=t.length,c=[];for(let s=0;s<o;s++){let d=[],p=[];d.push((s+o-1)%o,s,(s+1)%o),p.push(0,1,0);const g=ts.getKeyframeOrder(d);d=ts.sortedArray(d,1,g),p=ts.sortedArray(p,1,g),!r&&d[0]===0&&(d.push(o),p.push(p[0])),c.push(new Iw(".morphTargetInfluences["+t[s].name+"]",d,p).scale(1/i))}return new this(e,-1,c)}static findByName(e,t){let i=e;if(!Array.isArray(e)){const r=e;i=r.geometry&&r.geometry.animations||r.animations}for(let r=0;r<i.length;r++)if(i[r].name===t)return i[r];return null}static CreateClipsFromMorphTargetSequences(e,t,i){const r={},o=/^([\w-]*?)([\d]+)$/;for(let s=0,d=e.length;s<d;s++){const p=e[s],g=p.name.match(o);if(g&&g.length>1){const _=g[1];let x=r[_];x||(r[_]=x=[]),x.push(p)}}const c=[];for(const s in r)c.push(this.CreateFromMorphTargetSequence(s,r[s],t,i));return c}static parseAnimation(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const i=function(_,x,b,S,P){if(b.length!==0){const L=[],E=[];ts.flattenJSON(b,L,E,S),L.length!==0&&P.push(new _(x,L,E))}},r=[],o=e.name||"default",c=e.fps||30,s=e.blendMode;let d=e.length||-1;const p=e.hierarchy||[];for(let _=0;_<p.length;_++){const x=p[_].keys;if(!(!x||x.length===0))if(x[0].morphTargets){const b={};let S;for(S=0;S<x.length;S++)if(x[S].morphTargets)for(let P=0;P<x[S].morphTargets.length;P++)b[x[S].morphTargets[P]]=-1;for(const P in b){const L=[],E=[];for(let C=0;C!==x[S].morphTargets.length;++C){const D=x[S];L.push(D.time),E.push(D.morphTarget===P?1:0)}r.push(new Iw(".morphTargetInfluence["+P+"]",L,E))}d=b.length*c}else{const b=".bones["+t[_].name+"]";i(Rw,b+".position",x,"pos",r),i(x0,b+".quaternion",x,"rot",r),i(Rw,b+".scale",x,"scl",r)}}return r.length===0?null:new this(o,d,r,s)}resetDuration(){const e=this.tracks;let t=0;for(let i=0,r=e.length;i!==r;++i){const o=this.tracks[i];t=Math.max(t,o.times[o.times.length-1])}return this.duration=t,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function _Q(n){switch(n.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Iw;case"vector":case"vector2":case"vector3":case"vector4":return Rw;case"color":return Vz;case"quaternion":return x0;case"bool":case"boolean":return g_;case"string":return __}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+n)}function vQ(n){if(n.type===void 0)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const e=_Q(n.type);if(n.times===void 0){const t=[],i=[];ts.flattenJSON(n.keys,t,i,"value"),n.times=t,n.values=i}return e.parse!==void 0?e.parse(n):new e(n.name,n.times,n.values,n.interpolation)}const Yg={enabled:!1,files:{},add:function(n,e){this.enabled!==!1&&(this.files[n]=e)},get:function(n){if(this.enabled!==!1)return this.files[n]},remove:function(n){delete this.files[n]},clear:function(){this.files={}}};class yQ{constructor(e,t,i){const r=this;let o=!1,c=0,s=0,d;const p=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(g){s++,o===!1&&r.onStart!==void 0&&r.onStart(g,c,s),o=!0},this.itemEnd=function(g){c++,r.onProgress!==void 0&&r.onProgress(g,c,s),c===s&&(o=!1,r.onLoad!==void 0&&r.onLoad())},this.itemError=function(g){r.onError!==void 0&&r.onError(g)},this.resolveURL=function(g){return d?d(g):g},this.setURLModifier=function(g){return d=g,this},this.addHandler=function(g,_){return p.push(g,_),this},this.removeHandler=function(g){const _=p.indexOf(g);return _!==-1&&p.splice(_,2),this},this.getHandler=function(g){for(let _=0,x=p.length;_<x;_+=2){const b=p[_],S=p[_+1];if(b.global&&(b.lastIndex=0),b.test(g))return S}return null}}}const bQ=new yQ;class Qd{constructor(e){this.manager=e!==void 0?e:bQ,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise(function(r,o){i.load(e,r,t,o)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}const ah={};class xQ extends Qd{constructor(e){super(e)}load(e,t,i,r){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const o=Yg.get(e);if(o!==void 0)return this.manager.itemStart(e),setTimeout(()=>{t&&t(o),this.manager.itemEnd(e)},0),o;if(ah[e]!==void 0){ah[e].push({onLoad:t,onProgress:i,onError:r});return}ah[e]=[],ah[e].push({onLoad:t,onProgress:i,onError:r});const c=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"});fetch(c).then(s=>{if(s.status===200||s.status===0){s.status===0&&console.warn("THREE.FileLoader: HTTP Status 0 received.");const d=ah[e],p=s.body.getReader(),g=s.headers.get("Content-Length"),_=g?parseInt(g):0,x=_!==0;let b=0;return new ReadableStream({start(S){P();function P(){p.read().then(({done:L,value:E})=>{if(L)S.close();else{b+=E.byteLength;const C=new ProgressEvent("progress",{lengthComputable:x,loaded:b,total:_});for(let D=0,O=d.length;D<O;D++){const U=d[D];U.onProgress&&U.onProgress(C)}S.enqueue(E),P()}})}}})}else throw Error(`fetch for "${s.url}" responded with ${s.status}: ${s.statusText}`)}).then(s=>{const d=new Response(s);switch(this.responseType){case"arraybuffer":return d.arrayBuffer();case"blob":return d.blob();case"document":return d.text().then(p=>new DOMParser().parseFromString(p,this.mimeType));case"json":return d.json();default:return d.text()}}).then(s=>{Yg.add(e,s);const d=ah[e];delete ah[e];for(let p=0,g=d.length;p<g;p++){const _=d[p];_.onLoad&&_.onLoad(s)}this.manager.itemEnd(e)}).catch(s=>{const d=ah[e];delete ah[e];for(let p=0,g=d.length;p<g;p++){const _=d[p];_.onError&&_.onError(s)}this.manager.itemError(e),this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class Uz extends Qd{constructor(e){super(e)}load(e,t,i,r){this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const o=this,c=Yg.get(e);if(c!==void 0)return o.manager.itemStart(e),setTimeout(function(){t&&t(c),o.manager.itemEnd(e)},0),c;const s=f1("img");function d(){g(),Yg.add(e,this),t&&t(this),o.manager.itemEnd(e)}function p(_){g(),r&&r(_),o.manager.itemError(e),o.manager.itemEnd(e)}function g(){s.removeEventListener("load",d,!1),s.removeEventListener("error",p,!1)}return s.addEventListener("load",d,!1),s.addEventListener("error",p,!1),e.substr(0,5)!=="data:"&&this.crossOrigin!==void 0&&(s.crossOrigin=this.crossOrigin),o.manager.itemStart(e),s.src=e,s}}class wQ extends Qd{constructor(e){super(e)}load(e,t,i,r){const o=new p1,c=new Uz(this.manager);c.setCrossOrigin(this.crossOrigin),c.setPath(this.path);let s=0;function d(p){c.load(e[p],function(g){o.images[p]=g,s++,s===6&&(o.needsUpdate=!0,t&&t(o))},void 0,r)}for(let p=0;p<e.length;++p)d(p);return o}}class SQ extends Qd{constructor(e){super(e)}load(e,t,i,r){const o=new Bs,c=new Uz(this.manager);return c.setCrossOrigin(this.crossOrigin),c.setPath(this.path),c.load(e,function(s){o.image=s,o.needsUpdate=!0,t!==void 0&&t(o)},i,r),o}}class yu extends Ln{constructor(e,t=1){super(),this.type="Light",this.color=new $i(e),this.intensity=t}dispose(){}copy(e){return super.copy(e),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,this.groundColor!==void 0&&(t.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(t.object.distance=this.distance),this.angle!==void 0&&(t.object.angle=this.angle),this.decay!==void 0&&(t.object.decay=this.decay),this.penumbra!==void 0&&(t.object.penumbra=this.penumbra),this.shadow!==void 0&&(t.object.shadow=this.shadow.toJSON()),t}}yu.prototype.isLight=!0;class TQ extends yu{constructor(e,t,i){super(e,i),this.type="HemisphereLight",this.position.copy(Ln.DefaultUp),this.updateMatrix(),this.groundColor=new $i(t)}copy(e){return yu.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}TQ.prototype.isHemisphereLight=!0;const JL=new ki,QL=new Ge,e3=new Ge;class XC{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new li(512,512),this.map=null,this.mapPass=null,this.matrix=new ki,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new m1,this._frameExtents=new li(1,1),this._viewportCount=1,this._viewports=[new Xn(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,i=this.matrix;QL.setFromMatrixPosition(e.matrixWorld),t.position.copy(QL),e3.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(e3),t.updateMatrixWorld(),JL.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(JL),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(t.projectionMatrix),i.multiply(t.matrixWorldInverse)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){const e={};return this.bias!==0&&(e.bias=this.bias),this.normalBias!==0&&(e.normalBias=this.normalBias),this.radius!==1&&(e.radius=this.radius),(this.mapSize.x!==512||this.mapSize.y!==512)&&(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class jz extends XC{constructor(){super(new na(50,1,.5,500)),this.focus=1}updateMatrices(e){const t=this.camera,i=$y*2*e.angle*this.focus,r=this.mapSize.width/this.mapSize.height,o=e.distance||t.far;(i!==t.fov||r!==t.aspect||o!==t.far)&&(t.fov=i,t.aspect=r,t.far=o,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}jz.prototype.isSpotLightShadow=!0;class MQ extends yu{constructor(e,t,i=0,r=Math.PI/3,o=0,c=1){super(e,t),this.type="SpotLight",this.position.copy(Ln.DefaultUp),this.updateMatrix(),this.target=new Ln,this.distance=i,this.angle=r,this.penumbra=o,this.decay=c,this.shadow=new jz}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}MQ.prototype.isSpotLight=!0;const t3=new ki,Ov=new Ge,aM=new Ge;class Gz extends XC{constructor(){super(new na(90,1,.5,500)),this._frameExtents=new li(4,2),this._viewportCount=6,this._viewports=[new Xn(2,1,1,1),new Xn(0,1,1,1),new Xn(3,1,1,1),new Xn(1,1,1,1),new Xn(3,0,1,1),new Xn(1,0,1,1)],this._cubeDirections=[new Ge(1,0,0),new Ge(-1,0,0),new Ge(0,0,1),new Ge(0,0,-1),new Ge(0,1,0),new Ge(0,-1,0)],this._cubeUps=[new Ge(0,1,0),new Ge(0,1,0),new Ge(0,1,0),new Ge(0,1,0),new Ge(0,0,1),new Ge(0,0,-1)]}updateMatrices(e,t=0){const i=this.camera,r=this.matrix,o=e.distance||i.far;o!==i.far&&(i.far=o,i.updateProjectionMatrix()),Ov.setFromMatrixPosition(e.matrixWorld),i.position.copy(Ov),aM.copy(i.position),aM.add(this._cubeDirections[t]),i.up.copy(this._cubeUps[t]),i.lookAt(aM),i.updateMatrixWorld(),r.makeTranslation(-Ov.x,-Ov.y,-Ov.z),t3.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(t3)}}Gz.prototype.isPointLightShadow=!0;class CQ extends yu{constructor(e,t,i=0,r=1){super(e,t),this.type="PointLight",this.distance=i,this.decay=r,this.shadow=new Gz}get power(){return this.intensity*4*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}CQ.prototype.isPointLight=!0;class qz extends XC{constructor(){super(new _1(-5,5,5,-5,.5,500))}}qz.prototype.isDirectionalLightShadow=!0;class EQ extends yu{constructor(e,t){super(e,t),this.type="DirectionalLight",this.position.copy(Ln.DefaultUp),this.updateMatrix(),this.target=new Ln,this.shadow=new qz}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}EQ.prototype.isDirectionalLight=!0;class AQ extends yu{constructor(e,t){super(e,t),this.type="AmbientLight"}}AQ.prototype.isAmbientLight=!0;class PQ extends yu{constructor(e,t,i=10,r=10){super(e,t),this.type="RectAreaLight",this.width=i,this.height=r}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}PQ.prototype.isRectAreaLight=!0;class Wz{constructor(){this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new Ge)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){const i=e.x,r=e.y,o=e.z,c=this.coefficients;return t.copy(c[0]).multiplyScalar(.282095),t.addScaledVector(c[1],.488603*r),t.addScaledVector(c[2],.488603*o),t.addScaledVector(c[3],.488603*i),t.addScaledVector(c[4],1.092548*(i*r)),t.addScaledVector(c[5],1.092548*(r*o)),t.addScaledVector(c[6],.315392*(3*o*o-1)),t.addScaledVector(c[7],1.092548*(i*o)),t.addScaledVector(c[8],.546274*(i*i-r*r)),t}getIrradianceAt(e,t){const i=e.x,r=e.y,o=e.z,c=this.coefficients;return t.copy(c[0]).multiplyScalar(.886227),t.addScaledVector(c[1],2*.511664*r),t.addScaledVector(c[2],2*.511664*o),t.addScaledVector(c[3],2*.511664*i),t.addScaledVector(c[4],2*.429043*i*r),t.addScaledVector(c[5],2*.429043*r*o),t.addScaledVector(c[6],.743125*o*o-.247708),t.addScaledVector(c[7],2*.429043*i*o),t.addScaledVector(c[8],.429043*(i*i-r*r)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let i=0;i<9;i++)this.coefficients[i].addScaledVector(e.coefficients[i],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let i=0;i<9;i++)this.coefficients[i].lerp(e.coefficients[i],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return new this.constructor().copy(this)}fromArray(e,t=0){const i=this.coefficients;for(let r=0;r<9;r++)i[r].fromArray(e,t+r*3);return this}toArray(e=[],t=0){const i=this.coefficients;for(let r=0;r<9;r++)i[r].toArray(e,t+r*3);return e}static getBasisAt(e,t){const i=e.x,r=e.y,o=e.z;t[0]=.282095,t[1]=.488603*r,t[2]=.488603*o,t[3]=.488603*i,t[4]=1.092548*i*r,t[5]=1.092548*r*o,t[6]=.315392*(3*o*o-1),t[7]=1.092548*i*o,t[8]=.546274*(i*i-r*r)}}Wz.prototype.isSphericalHarmonics3=!0;class YC extends yu{constructor(e=new Wz,t=1){super(void 0,t),this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){const t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}}YC.prototype.isLightProbe=!0;class IQ{static decodeText(e){if(typeof TextDecoder<"u")return new TextDecoder().decode(e);let t="";for(let i=0,r=e.length;i<r;i++)t+=String.fromCharCode(e[i]);try{return decodeURIComponent(escape(t))}catch{return t}}static extractUrlBase(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substr(0,t+1)}static resolveURL(e,t){return typeof e!="string"||e===""?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}}class RQ extends jn{constructor(){super(),this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(e){return super.copy(e),this.instanceCount=e.instanceCount,this}clone(){return new this.constructor().copy(this)}toJSON(){const e=super.toJSON(this);return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}RQ.prototype.isInstancedBufferGeometry=!0;class LQ extends Qd{constructor(e){super(e),typeof createImageBitmap>"u"&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),typeof fetch>"u"&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,t,i,r){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const o=this,c=Yg.get(e);if(c!==void 0)return o.manager.itemStart(e),setTimeout(function(){t&&t(c),o.manager.itemEnd(e)},0),c;const s={};s.credentials=this.crossOrigin==="anonymous"?"same-origin":"include",s.headers=this.requestHeader,fetch(e,s).then(function(d){return d.blob()}).then(function(d){return createImageBitmap(d,Object.assign(o.options,{colorSpaceConversion:"none"}))}).then(function(d){Yg.add(e,d),t&&t(d),o.manager.itemEnd(e)}).catch(function(d){r&&r(d),o.manager.itemError(e),o.manager.itemEnd(e)}),o.manager.itemStart(e)}}LQ.prototype.isImageBitmapLoader=!0;let _x;const kQ={getContext:function(){return _x===void 0&&(_x=new(window.AudioContext||window.webkitAudioContext)),_x},setContext:function(n){_x=n}};class DQ extends Qd{constructor(e){super(e)}load(e,t,i,r){const o=this,c=new xQ(this.manager);c.setResponseType("arraybuffer"),c.setPath(this.path),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials),c.load(e,function(s){try{const d=s.slice(0);kQ.getContext().decodeAudioData(d,function(g){t(g)})}catch(d){r?r(d):console.error(d),o.manager.itemError(e)}},i,r)}}class FQ extends YC{constructor(e,t,i=1){super(void 0,i);const r=new $i().set(e),o=new $i().set(t),c=new Ge(r.r,r.g,r.b),s=new Ge(o.r,o.g,o.b),d=Math.sqrt(Math.PI),p=d*Math.sqrt(.75);this.sh.coefficients[0].copy(c).add(s).multiplyScalar(d),this.sh.coefficients[1].copy(c).sub(s).multiplyScalar(p)}}FQ.prototype.isHemisphereLightProbe=!0;class OQ extends YC{constructor(e,t=1){super(void 0,t);const i=new $i().set(e);this.sh.coefficients[0].set(i.r,i.g,i.b).multiplyScalar(2*Math.sqrt(Math.PI))}}OQ.prototype.isAmbientLightProbe=!0;class zQ{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=i3(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=i3();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}function i3(){return(typeof performance>"u"?Date:performance).now()}class BQ extends Ln{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(this.isPlaying===!0){console.warn("THREE.Audio: Audio is already playing.");return}if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}this._startedAt=this.context.currentTime+e;const t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.onended=this.onEnded.bind(this),t.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=t,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.isPlaying===!0&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,this.loop===!0&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this}stop(){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this._progress=0,this.source.stop(),this.source.onended=null,this.isPlaying=!1,this}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}getFilters(){return this.filters}setFilters(e){return e||(e=[]),this._connected===!0?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){if(this.detune=e,this.source.detune!==void 0)return this.isPlaying===!0&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.playbackRate=e,this.isPlaying===!0&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return this.hasPlaybackControl===!1?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(e){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.loop=e,this.isPlaying===!0&&(this.source.loop=this.loop),this}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}}class NQ{constructor(e,t,i){this.binding=e,this.valueSize=i;let r,o,c;switch(t){case"quaternion":r=this._slerp,o=this._slerpAdditive,c=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(i*6),this._workIndex=5;break;case"string":case"bool":r=this._select,o=this._select,c=this._setAdditiveIdentityOther,this.buffer=new Array(i*5);break;default:r=this._lerp,o=this._lerpAdditive,c=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(i*5)}this._mixBufferRegion=r,this._mixBufferRegionAdditive=o,this._setIdentity=c,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,t){const i=this.buffer,r=this.valueSize,o=e*r+r;let c=this.cumulativeWeight;if(c===0){for(let s=0;s!==r;++s)i[o+s]=i[s];c=t}else{c+=t;const s=t/c;this._mixBufferRegion(i,o,0,s,r)}this.cumulativeWeight=c}accumulateAdditive(e){const t=this.buffer,i=this.valueSize,r=i*this._addIndex;this.cumulativeWeightAdditive===0&&this._setIdentity(),this._mixBufferRegionAdditive(t,r,0,e,i),this.cumulativeWeightAdditive+=e}apply(e){const t=this.valueSize,i=this.buffer,r=e*t+t,o=this.cumulativeWeight,c=this.cumulativeWeightAdditive,s=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,o<1){const d=t*this._origIndex;this._mixBufferRegion(i,r,d,1-o,t)}c>0&&this._mixBufferRegionAdditive(i,r,this._addIndex*t,1,t);for(let d=t,p=t+t;d!==p;++d)if(i[d]!==i[d+t]){s.setValue(i,r);break}}saveOriginalState(){const e=this.binding,t=this.buffer,i=this.valueSize,r=i*this._origIndex;e.getValue(t,r);for(let o=i,c=r;o!==c;++o)t[o]=t[r+o%i];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const e=this.valueSize*3;this.binding.setValue(this.buffer,e)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,t=e+this.valueSize;for(let i=e;i<t;i++)this.buffer[i]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,t=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[t+i]=this.buffer[e+i]}_select(e,t,i,r,o){if(r>=.5)for(let c=0;c!==o;++c)e[t+c]=e[i+c]}_slerp(e,t,i,r){yo.slerpFlat(e,t,e,t,e,i,r)}_slerpAdditive(e,t,i,r,o){const c=this._workIndex*o;yo.multiplyQuaternionsFlat(e,c,e,t,e,i),yo.slerpFlat(e,t,e,t,e,c,r)}_lerp(e,t,i,r,o){const c=1-r;for(let s=0;s!==o;++s){const d=t+s;e[d]=e[d]*c+e[i+s]*r}}_lerpAdditive(e,t,i,r,o){for(let c=0;c!==o;++c){const s=t+c;e[s]=e[s]+e[i+c]*r}}}const KC="\\[\\]\\.:\\/",$Q=new RegExp("["+KC+"]","g"),JC="[^"+KC+"]",VQ="[^"+KC.replace("\\.","")+"]",UQ=/((?:WC+[\/:])*)/.source.replace("WC",JC),jQ=/(WCOD+)?/.source.replace("WCOD",VQ),GQ=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",JC),qQ=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",JC),WQ=new RegExp("^"+UQ+jQ+GQ+qQ+"$"),HQ=["material","materials","bones"];class ZQ{constructor(e,t,i){const r=i||cr.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,r)}getValue(e,t){this.bind();const i=this._targetGroup.nCachedObjects_,r=this._bindings[i];r!==void 0&&r.getValue(e,t)}setValue(e,t){const i=this._bindings;for(let r=this._targetGroup.nCachedObjects_,o=i.length;r!==o;++r)i[r].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}}class cr{constructor(e,t,i){this.path=t,this.parsedPath=i||cr.parseTrackName(t),this.node=cr.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,i){return e&&e.isAnimationObjectGroup?new cr.Composite(e,t,i):new cr(e,t,i)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace($Q,"")}static parseTrackName(e){const t=WQ.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},r=i.nodeName&&i.nodeName.lastIndexOf(".");if(r!==void 0&&r!==-1){const o=i.nodeName.substring(r+1);HQ.indexOf(o)!==-1&&(i.nodeName=i.nodeName.substring(0,r),i.objectName=o)}if(i.propertyName===null||i.propertyName.length===0)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}static findNode(e,t){if(!t||t===""||t==="."||t===-1||t===e.name||t===e.uuid)return e;if(e.skeleton){const i=e.skeleton.getBoneByName(t);if(i!==void 0)return i}if(e.children){const i=function(o){for(let c=0;c<o.length;c++){const s=o[c];if(s.name===t||s.uuid===t)return s;const d=i(s.children);if(d)return d}return null},r=i(e.children);if(r)return r}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const i=this.resolvedProperty;for(let r=0,o=i.length;r!==o;++r)e[t++]=i[r]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const i=this.resolvedProperty;for(let r=0,o=i.length;r!==o;++r)i[r]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const i=this.resolvedProperty;for(let r=0,o=i.length;r!==o;++r)i[r]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const i=this.resolvedProperty;for(let r=0,o=i.length;r!==o;++r)i[r]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,i=t.objectName,r=t.propertyName;let o=t.propertyIndex;if(e||(e=cr.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e){console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.");return}if(i){let p=t.objectIndex;switch(i){case"materials":if(!e.material){console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);return}if(!e.material.materials){console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);return}e=e.material.materials;break;case"bones":if(!e.skeleton){console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);return}e=e.skeleton.bones;for(let g=0;g<e.length;g++)if(e[g].name===p){p=g;break}break;default:if(e[i]===void 0){console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);return}e=e[i]}if(p!==void 0){if(e[p]===void 0){console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);return}e=e[p]}}const c=e[r];if(c===void 0){const p=t.nodeName;console.error("THREE.PropertyBinding: Trying to update property for track: "+p+"."+r+" but it wasn't found.",e);return}let s=this.Versioning.None;this.targetObject=e,e.needsUpdate!==void 0?s=this.Versioning.NeedsUpdate:e.matrixWorldNeedsUpdate!==void 0&&(s=this.Versioning.MatrixWorldNeedsUpdate);let d=this.BindingType.Direct;if(o!==void 0){if(r==="morphTargetInfluences"){if(!e.geometry){console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);return}if(e.geometry.isBufferGeometry){if(!e.geometry.morphAttributes){console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);return}e.morphTargetDictionary[o]!==void 0&&(o=e.morphTargetDictionary[o])}else{console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences on THREE.Geometry. Use THREE.BufferGeometry instead.",this);return}}d=this.BindingType.ArrayElement,this.resolvedProperty=c,this.propertyIndex=o}else c.fromArray!==void 0&&c.toArray!==void 0?(d=this.BindingType.HasFromToArray,this.resolvedProperty=c):Array.isArray(c)?(d=this.BindingType.EntireArray,this.resolvedProperty=c):this.propertyName=r;this.getValue=this.GetterByBindingType[d],this.setValue=this.SetterByBindingTypeAndVersioning[d][s]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}cr.Composite=ZQ;cr.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3};cr.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2};cr.prototype.GetterByBindingType=[cr.prototype._getValue_direct,cr.prototype._getValue_array,cr.prototype._getValue_arrayElement,cr.prototype._getValue_toArray];cr.prototype.SetterByBindingTypeAndVersioning=[[cr.prototype._setValue_direct,cr.prototype._setValue_direct_setNeedsUpdate,cr.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[cr.prototype._setValue_array,cr.prototype._setValue_array_setNeedsUpdate,cr.prototype._setValue_array_setMatrixWorldNeedsUpdate],[cr.prototype._setValue_arrayElement,cr.prototype._setValue_arrayElement_setNeedsUpdate,cr.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[cr.prototype._setValue_fromArray,cr.prototype._setValue_fromArray_setNeedsUpdate,cr.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class XQ{constructor(e,t,i=null,r=t.blendMode){this._mixer=e,this._clip=t,this._localRoot=i,this.blendMode=r;const o=t.tracks,c=o.length,s=new Array(c),d={endingStart:vg,endingEnd:vg};for(let p=0;p!==c;++p){const g=o[p].createInterpolant(null);s[p]=g,g.settings=d}this._interpolantSettings=d,this._interpolants=s,this._propertyBindings=new Array(c),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=v9,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&this.timeScale!==0&&this._startTime===null&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,t){return this.loop=e,this.repetitions=t,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,t,i){if(e.fadeOut(t),this.fadeIn(t),i){const r=this._clip.duration,o=e._clip.duration,c=o/r,s=r/o;e.warp(1,c,t),this.warp(s,1,t)}return this}crossFadeTo(e,t,i){return e.crossFadeFrom(this,t,i)}stopFading(){const e=this._weightInterpolant;return e!==null&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,t,i){const r=this._mixer,o=r.time,c=this.timeScale;let s=this._timeScaleInterpolant;s===null&&(s=r._lendControlInterpolant(),this._timeScaleInterpolant=s);const d=s.parameterPositions,p=s.sampleValues;return d[0]=o,d[1]=o+i,p[0]=e/c,p[1]=t/c,this}stopWarping(){const e=this._timeScaleInterpolant;return e!==null&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,t,i,r){if(!this.enabled){this._updateWeight(e);return}const o=this._startTime;if(o!==null){const d=(e-o)*i;if(d<0||i===0)return;this._startTime=null,t=i*d}t*=this._updateTimeScale(e);const c=this._updateTime(t),s=this._updateWeight(e);if(s>0){const d=this._interpolants,p=this._propertyBindings;switch(this.blendMode){case ez:for(let g=0,_=d.length;g!==_;++g)d[g].evaluate(c),p[g].accumulateAdditive(s);break;case DC:default:for(let g=0,_=d.length;g!==_;++g)d[g].evaluate(c),p[g].accumulate(r,s)}}}_updateWeight(e){let t=0;if(this.enabled){t=this.weight;const i=this._weightInterpolant;if(i!==null){const r=i.evaluate(e)[0];t*=r,e>i.parameterPositions[1]&&(this.stopFading(),r===0&&(this.enabled=!1))}}return this._effectiveWeight=t,t}_updateTimeScale(e){let t=0;if(!this.paused){t=this.timeScale;const i=this._timeScaleInterpolant;if(i!==null){const r=i.evaluate(e)[0];t*=r,e>i.parameterPositions[1]&&(this.stopWarping(),t===0?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t}_updateTime(e){const t=this._clip.duration,i=this.loop;let r=this.time+e,o=this._loopCount;const c=i===y9;if(e===0)return o===-1?r:c&&(o&1)===1?t-r:r;if(i===_9){o===-1&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(r>=t)r=t;else if(r<0)r=0;else{this.time=r;break e}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=r,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(o===-1&&(e>=0?(o=0,this._setEndings(!0,this.repetitions===0,c)):this._setEndings(this.repetitions===0,!0,c)),r>=t||r<0){const s=Math.floor(r/t);r-=t*s,o+=Math.abs(s);const d=this.repetitions-o;if(d<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,r=e>0?t:0,this.time=r,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(d===1){const p=e<0;this._setEndings(p,!p,c)}else this._setEndings(!1,!1,c);this._loopCount=o,this.time=r,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:s})}}else this.time=r;if(c&&(o&1)===1)return t-r}return r}_setEndings(e,t,i){const r=this._interpolantSettings;i?(r.endingStart=yg,r.endingEnd=yg):(e?r.endingStart=this.zeroSlopeAtStart?yg:vg:r.endingStart=Aw,t?r.endingEnd=this.zeroSlopeAtEnd?yg:vg:r.endingEnd=Aw)}_scheduleFading(e,t,i){const r=this._mixer,o=r.time;let c=this._weightInterpolant;c===null&&(c=r._lendControlInterpolant(),this._weightInterpolant=c);const s=c.parameterPositions,d=c.sampleValues;return s[0]=o,d[0]=t,s[1]=o+e,d[1]=i,this}}class YQ extends Mp{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,t){const i=e._localRoot||this._root,r=e._clip.tracks,o=r.length,c=e._propertyBindings,s=e._interpolants,d=i.uuid,p=this._bindingsByRootAndName;let g=p[d];g===void 0&&(g={},p[d]=g);for(let _=0;_!==o;++_){const x=r[_],b=x.name;let S=g[b];if(S!==void 0)c[_]=S;else{if(S=c[_],S!==void 0){S._cacheIndex===null&&(++S.referenceCount,this._addInactiveBinding(S,d,b));continue}const P=t&&t._propertyBindings[_].binding.parsedPath;S=new NQ(cr.create(i,b,P),x.ValueTypeName,x.getValueSize()),++S.referenceCount,this._addInactiveBinding(S,d,b),c[_]=S}s[_].resultBuffer=S.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(e._cacheIndex===null){const i=(e._localRoot||this._root).uuid,r=e._clip.uuid,o=this._actionsByClip[r];this._bindAction(e,o&&o.knownActions[0]),this._addInactiveAction(e,r,i)}const t=e._propertyBindings;for(let i=0,r=t.length;i!==r;++i){const o=t[i];o.useCount++===0&&(this._lendBinding(o),o.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const t=e._propertyBindings;for(let i=0,r=t.length;i!==r;++i){const o=t[i];--o.useCount===0&&(o.restoreOriginalState(),this._takeBackBinding(o))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const t=e._cacheIndex;return t!==null&&t<this._nActiveActions}_addInactiveAction(e,t,i){const r=this._actions,o=this._actionsByClip;let c=o[t];if(c===void 0)c={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,o[t]=c;else{const s=c.knownActions;e._byClipCacheIndex=s.length,s.push(e)}e._cacheIndex=r.length,r.push(e),c.actionByRoot[i]=e}_removeInactiveAction(e){const t=this._actions,i=t[t.length-1],r=e._cacheIndex;i._cacheIndex=r,t[r]=i,t.pop(),e._cacheIndex=null;const o=e._clip.uuid,c=this._actionsByClip,s=c[o],d=s.knownActions,p=d[d.length-1],g=e._byClipCacheIndex;p._byClipCacheIndex=g,d[g]=p,d.pop(),e._byClipCacheIndex=null;const _=s.actionByRoot,x=(e._localRoot||this._root).uuid;delete _[x],d.length===0&&delete c[o],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const t=e._propertyBindings;for(let i=0,r=t.length;i!==r;++i){const o=t[i];--o.referenceCount===0&&this._removeInactiveBinding(o)}}_lendAction(e){const t=this._actions,i=e._cacheIndex,r=this._nActiveActions++,o=t[r];e._cacheIndex=r,t[r]=e,o._cacheIndex=i,t[i]=o}_takeBackAction(e){const t=this._actions,i=e._cacheIndex,r=--this._nActiveActions,o=t[r];e._cacheIndex=r,t[r]=e,o._cacheIndex=i,t[i]=o}_addInactiveBinding(e,t,i){const r=this._bindingsByRootAndName,o=this._bindings;let c=r[t];c===void 0&&(c={},r[t]=c),c[i]=e,e._cacheIndex=o.length,o.push(e)}_removeInactiveBinding(e){const t=this._bindings,i=e.binding,r=i.rootNode.uuid,o=i.path,c=this._bindingsByRootAndName,s=c[r],d=t[t.length-1],p=e._cacheIndex;d._cacheIndex=p,t[p]=d,t.pop(),delete s[o],Object.keys(s).length===0&&delete c[r]}_lendBinding(e){const t=this._bindings,i=e._cacheIndex,r=this._nActiveBindings++,o=t[r];e._cacheIndex=r,t[r]=e,o._cacheIndex=i,t[i]=o}_takeBackBinding(e){const t=this._bindings,i=e._cacheIndex,r=--this._nActiveBindings,o=t[r];e._cacheIndex=r,t[r]=e,o._cacheIndex=i,t[i]=o}_lendControlInterpolant(){const e=this._controlInterpolants,t=this._nActiveControlInterpolants++;let i=e[t];return i===void 0&&(i=new $z(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),i.__cacheIndex=t,e[t]=i),i}_takeBackControlInterpolant(e){const t=this._controlInterpolants,i=e.__cacheIndex,r=--this._nActiveControlInterpolants,o=t[r];e.__cacheIndex=r,t[r]=e,o.__cacheIndex=i,t[i]=o}clipAction(e,t,i){const r=t||this._root,o=r.uuid;let c=typeof e=="string"?KL.findByName(r,e):e;const s=c!==null?c.uuid:e,d=this._actionsByClip[s];let p=null;if(i===void 0&&(c!==null?i=c.blendMode:i=DC),d!==void 0){const _=d.actionByRoot[o];if(_!==void 0&&_.blendMode===i)return _;p=d.knownActions[0],c===null&&(c=p._clip)}if(c===null)return null;const g=new XQ(this,c,t,i);return this._bindAction(g,p),this._addInactiveAction(g,s,o),g}existingAction(e,t){const i=t||this._root,r=i.uuid,o=typeof e=="string"?KL.findByName(i,e):e,c=o?o.uuid:e,s=this._actionsByClip[c];return s!==void 0&&s.actionByRoot[r]||null}stopAllAction(){const e=this._actions,t=this._nActiveActions;for(let i=t-1;i>=0;--i)e[i].stop();return this}update(e){e*=this.timeScale;const t=this._actions,i=this._nActiveActions,r=this.time+=e,o=Math.sign(e),c=this._accuIndex^=1;for(let p=0;p!==i;++p)t[p]._update(r,e,o,c);const s=this._bindings,d=this._nActiveBindings;for(let p=0;p!==d;++p)s[p].apply(c);return this}setTime(e){this.time=0;for(let t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const t=this._actions,i=e.uuid,r=this._actionsByClip,o=r[i];if(o!==void 0){const c=o.knownActions;for(let s=0,d=c.length;s!==d;++s){const p=c[s];this._deactivateAction(p);const g=p._cacheIndex,_=t[t.length-1];p._cacheIndex=null,p._byClipCacheIndex=null,_._cacheIndex=g,t[g]=_,t.pop(),this._removeInactiveBindingsForAction(p)}delete r[i]}}uncacheRoot(e){const t=e.uuid,i=this._actionsByClip;for(const c in i){const s=i[c].actionByRoot,d=s[t];d!==void 0&&(this._deactivateAction(d),this._removeInactiveAction(d))}const r=this._bindingsByRootAndName,o=r[t];if(o!==void 0)for(const c in o){const s=o[c];s.restoreOriginalState(),this._removeInactiveBinding(s)}}uncacheAction(e,t){const i=this.existingAction(e,t);i!==null&&(this._deactivateAction(i),this._removeInactiveAction(i))}}YQ.prototype._controlInterpolantsResultBuffer=new Float32Array(1);class KQ extends y0{constructor(e,t,i=1){super(e,t),this.meshPerAttribute=i}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){const t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}KQ.prototype.isInstancedInterleavedBuffer=!0;class Lw{constructor(e,t,i=0,r=1/0){this.ray=new Cp(e,t),this.near=i,this.far=r,this.camera=null,this.layers=new az,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}intersectObject(e,t=!0,i=[]){return v2(e,this,i,t),i.sort(n3),i}intersectObjects(e,t=!0,i=[]){for(let r=0,o=e.length;r<o;r++)v2(e[r],this,i,t);return i.sort(n3),i}}function n3(n,e){return n.distance-e.distance}function v2(n,e,t,i){if(n.layers.test(e.layers)&&n.raycast(e,t),i===!0){const r=n.children;for(let o=0,c=r.length;o<c;o++)v2(r[o],e,t,!0)}}const vd=new Ge,vx=new ki,lM=new ki;class JQ extends y1{constructor(e){const t=Hz(e),i=new jn,r=[],o=[],c=new $i(0,0,1),s=new $i(0,1,0);for(let p=0;p<t.length;p++){const g=t[p];g.parent&&g.parent.isBone&&(r.push(0,0,0),r.push(0,0,0),o.push(c.r,c.g,c.b),o.push(s.r,s.g,s.b))}i.setAttribute("position",new ws(r,3)),i.setAttribute("color",new ws(o,3));const d=new Ih({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0});super(i,d),this.type="SkeletonHelper",this.isSkeletonHelper=!0,this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){const t=this.bones,i=this.geometry,r=i.getAttribute("position");lM.copy(this.root.matrixWorld).invert();for(let o=0,c=0;o<t.length;o++){const s=t[o];s.parent&&s.parent.isBone&&(vx.multiplyMatrices(lM,s.matrixWorld),vd.setFromMatrixPosition(vx),r.setXYZ(c,vd.x,vd.y,vd.z),vx.multiplyMatrices(lM,s.parent.matrixWorld),vd.setFromMatrixPosition(vx),r.setXYZ(c+1,vd.x,vd.y,vd.z),c+=2)}i.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(e)}}function Hz(n){const e=[];n&&n.isBone&&e.push(n);for(let t=0;t<n.children.length;t++)e.push.apply(e,Hz(n.children[t]));return e}class QQ extends y1{constructor(e=10,t=10,i=4473924,r=8947848){i=new $i(i),r=new $i(r);const o=t/2,c=e/t,s=e/2,d=[],p=[];for(let x=0,b=0,S=-s;x<=t;x++,S+=c){d.push(-s,0,S,s,0,S),d.push(S,0,-s,S,0,s);const P=x===o?i:r;P.toArray(p,b),b+=3,P.toArray(p,b),b+=3,P.toArray(p,b),b+=3,P.toArray(p,b),b+=3}const g=new jn;g.setAttribute("position",new ws(d,3)),g.setAttribute("color",new ws(p,3));const _=new Ih({vertexColors:!0,toneMapped:!1});super(g,_),this.type="GridHelper"}}const eee=new Float32Array(1);new Int32Array(eee.buffer);Gl.create=function(n,e){return console.log("THREE.Curve.create() has been deprecated"),n.prototype=Object.create(Gl.prototype),n.prototype.constructor=n,n.prototype.getPoint=e,n};m2.prototype.fromPoints=function(n){return console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(n)};QQ.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")};JQ.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")};Qd.prototype.extractUrlBase=function(n){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),IQ.extractUrlBase(n)};Qd.Handlers={add:function(){console.error("THREE.Loader: Handlers.add() has been removed. Use LoadingManager.addHandler() instead.")},get:function(){console.error("THREE.Loader: Handlers.get() has been removed. Use LoadingManager.getHandler() instead.")}};dl.prototype.center=function(n){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(n)};dl.prototype.empty=function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()};dl.prototype.isIntersectionBox=function(n){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(n)};dl.prototype.isIntersectionSphere=function(n){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(n)};dl.prototype.size=function(n){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(n)};f_.prototype.empty=function(){return console.warn("THREE.Sphere: .empty() has been renamed to .isEmpty()."),this.isEmpty()};m1.prototype.setFromMatrix=function(n){return console.warn("THREE.Frustum: .setFromMatrix() has been renamed to .setFromProjectionMatrix()."),this.setFromProjectionMatrix(n)};vo.prototype.flattenToArrayOffset=function(n,e){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(n,e)};vo.prototype.multiplyVector3=function(n){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),n.applyMatrix3(this)};vo.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")};vo.prototype.applyToBufferAttribute=function(n){return console.warn("THREE.Matrix3: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix3( matrix ) instead."),n.applyMatrix3(this)};vo.prototype.applyToVector3Array=function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")};vo.prototype.getInverse=function(n){return console.warn("THREE.Matrix3: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(n).invert()};ki.prototype.extractPosition=function(n){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(n)};ki.prototype.flattenToArrayOffset=function(n,e){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(n,e)};ki.prototype.getPosition=function(){return console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),new Ge().setFromMatrixColumn(this,3)};ki.prototype.setRotationFromQuaternion=function(n){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(n)};ki.prototype.multiplyToArray=function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")};ki.prototype.multiplyVector3=function(n){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),n.applyMatrix4(this)};ki.prototype.multiplyVector4=function(n){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),n.applyMatrix4(this)};ki.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")};ki.prototype.rotateAxis=function(n){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),n.transformDirection(this)};ki.prototype.crossVector=function(n){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),n.applyMatrix4(this)};ki.prototype.translate=function(){console.error("THREE.Matrix4: .translate() has been removed.")};ki.prototype.rotateX=function(){console.error("THREE.Matrix4: .rotateX() has been removed.")};ki.prototype.rotateY=function(){console.error("THREE.Matrix4: .rotateY() has been removed.")};ki.prototype.rotateZ=function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")};ki.prototype.rotateByAxis=function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")};ki.prototype.applyToBufferAttribute=function(n){return console.warn("THREE.Matrix4: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix4( matrix ) instead."),n.applyMatrix4(this)};ki.prototype.applyToVector3Array=function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")};ki.prototype.makeFrustum=function(n,e,t,i,r,o){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(n,e,i,t,r,o)};ki.prototype.getInverse=function(n){return console.warn("THREE.Matrix4: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(n).invert()};dh.prototype.isIntersectionLine=function(n){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(n)};yo.prototype.multiplyVector3=function(n){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),n.applyQuaternion(this)};yo.prototype.inverse=function(){return console.warn("THREE.Quaternion: .inverse() has been renamed to invert()."),this.invert()};Cp.prototype.isIntersectionBox=function(n){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(n)};Cp.prototype.isIntersectionPlane=function(n){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(n)};Cp.prototype.isIntersectionSphere=function(n){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(n)};Zs.prototype.area=function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()};Zs.prototype.barycoordFromPoint=function(n,e){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(n,e)};Zs.prototype.midpoint=function(n){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(n)};Zs.prototypenormal=function(n){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(n)};Zs.prototype.plane=function(n){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(n)};Zs.barycoordFromPoint=function(n,e,t,i,r){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),Zs.getBarycoord(n,e,t,i,r)};Zs.normal=function(n,e,t,i){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),Zs.getNormal(n,e,t,i)};b0.prototype.extractAllPoints=function(n){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(n)};b0.prototype.extrude=function(n){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new m_(this,n)};b0.prototype.makeGeometry=function(n){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new HC(this,n)};li.prototype.fromAttribute=function(n,e,t){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(n,e,t)};li.prototype.distanceToManhattan=function(n){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(n)};li.prototype.lengthManhattan=function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()};Ge.prototype.setEulerFromRotationMatrix=function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")};Ge.prototype.setEulerFromQuaternion=function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")};Ge.prototype.getPositionFromMatrix=function(n){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(n)};Ge.prototype.getScaleFromMatrix=function(n){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(n)};Ge.prototype.getColumnFromMatrix=function(n,e){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,n)};Ge.prototype.applyProjection=function(n){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(n)};Ge.prototype.fromAttribute=function(n,e,t){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(n,e,t)};Ge.prototype.distanceToManhattan=function(n){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(n)};Ge.prototype.lengthManhattan=function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()};Xn.prototype.fromAttribute=function(n,e,t){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(n,e,t)};Xn.prototype.lengthManhattan=function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()};Ln.prototype.getChildByName=function(n){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(n)};Ln.prototype.renderDepth=function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")};Ln.prototype.translate=function(n,e){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(e,n)};Ln.prototype.getWorldRotation=function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")};Ln.prototype.applyMatrix=function(n){return console.warn("THREE.Object3D: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(n)};Object.defineProperties(Ln.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(n){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=n}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}});kr.prototype.setDrawMode=function(){console.error("THREE.Mesh: .setDrawMode() has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")};Object.defineProperties(kr.prototype,{drawMode:{get:function(){return console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode."),b9},set:function(){console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}});Pz.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")};na.prototype.setLens=function(n,e){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),e!==void 0&&(this.filmGauge=e),this.setFocalLength(n)};Object.defineProperties(yu.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(n){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=n}},shadowCameraLeft:{set:function(n){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=n}},shadowCameraRight:{set:function(n){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=n}},shadowCameraTop:{set:function(n){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=n}},shadowCameraBottom:{set:function(n){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=n}},shadowCameraNear:{set:function(n){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=n}},shadowCameraFar:{set:function(n){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=n}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(n){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=n}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(n){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=n}},shadowMapHeight:{set:function(n){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=n}}});Object.defineProperties(En.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},dynamic:{get:function(){return console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.usage===Pw},set:function(){console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.setUsage(Pw)}}});En.prototype.setDynamic=function(n){return console.warn("THREE.BufferAttribute: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(n===!0?Pw:Ny),this};En.prototype.copyIndicesArray=function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")},En.prototype.setArray=function(){console.error("THREE.BufferAttribute: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")};jn.prototype.addIndex=function(n){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(n)};jn.prototype.addAttribute=function(n,e){return console.warn("THREE.BufferGeometry: .addAttribute() has been renamed to .setAttribute()."),!(e&&e.isBufferAttribute)&&!(e&&e.isInterleavedBufferAttribute)?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.setAttribute(n,new En(arguments[1],arguments[2]))):n==="index"?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(e),this):this.setAttribute(n,e)};jn.prototype.addDrawCall=function(n,e,t){t!==void 0&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(n,e)};jn.prototype.clearDrawCalls=function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()};jn.prototype.computeOffsets=function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")};jn.prototype.removeAttribute=function(n){return console.warn("THREE.BufferGeometry: .removeAttribute() has been renamed to .deleteAttribute()."),this.deleteAttribute(n)};jn.prototype.applyMatrix=function(n){return console.warn("THREE.BufferGeometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(n)};Object.defineProperties(jn.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}});y0.prototype.setDynamic=function(n){return console.warn("THREE.InterleavedBuffer: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(n===!0?Pw:Ny),this};y0.prototype.setArray=function(){console.error("THREE.InterleavedBuffer: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")};m_.prototype.getArrays=function(){console.error("THREE.ExtrudeGeometry: .getArrays() has been removed.")};m_.prototype.addShapeList=function(){console.error("THREE.ExtrudeGeometry: .addShapeList() has been removed.")};m_.prototype.addShape=function(){console.error("THREE.ExtrudeGeometry: .addShape() has been removed.")};yh.prototype.dispose=function(){console.error("THREE.Scene: .dispose() has been removed.")};Object.defineProperties(Vo.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new $i}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(n){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=n===YO}},stencilMask:{get:function(){return console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask},set:function(n){console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask=n}},vertexTangents:{get:function(){console.warn("THREE."+this.type+": .vertexTangents has been removed.")},set:function(){console.warn("THREE."+this.type+": .vertexTangents has been removed.")}}});Object.defineProperties(ta.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(n){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=n}}});dr.prototype.clearTarget=function(n,e,t,i){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(n),this.clear(e,t,i)};dr.prototype.animate=function(n){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(n)};dr.prototype.getCurrentRenderTarget=function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()};dr.prototype.getMaxAnisotropy=function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()};dr.prototype.getPrecision=function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision};dr.prototype.resetGLState=function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()};dr.prototype.supportsFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")};dr.prototype.supportsHalfFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")};dr.prototype.supportsStandardDerivatives=function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")};dr.prototype.supportsCompressedTextureS3TC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")};dr.prototype.supportsCompressedTexturePVRTC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")};dr.prototype.supportsBlendMinMax=function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")};dr.prototype.supportsVertexTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures};dr.prototype.supportsInstancedArrays=function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")};dr.prototype.enableScissorTest=function(n){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(n)};dr.prototype.initMaterial=function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")};dr.prototype.addPrePlugin=function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")};dr.prototype.addPostPlugin=function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")};dr.prototype.updateShadowMap=function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")};dr.prototype.setFaceCulling=function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")};dr.prototype.allocTextureUnit=function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")};dr.prototype.setTexture=function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")};dr.prototype.setTexture2D=function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")};dr.prototype.setTextureCube=function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")};dr.prototype.getActiveMipMapLevel=function(){return console.warn("THREE.WebGLRenderer: .getActiveMipMapLevel() is now .getActiveMipmapLevel()."),this.getActiveMipmapLevel()};Object.defineProperties(dr.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(n){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=n}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(n){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=n}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}},context:{get:function(){return console.warn("THREE.WebGLRenderer: .context has been removed. Use .getContext() instead."),this.getContext()}},vr:{get:function(){return console.warn("THREE.WebGLRenderer: .vr has been renamed to .xr"),this.xr}},gammaInput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead."),!1},set:function(){console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),!1},set:function(n){console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),this.outputEncoding=n===!0?Tp:Bo}},toneMappingWhitePoint:{get:function(){return console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed."),1},set:function(){console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed.")}}});Object.defineProperties(Mz.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}});Object.defineProperties(Cc.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(n){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=n}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(n){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=n}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(n){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=n}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(n){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=n}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(n){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=n}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(n){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=n}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(n){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=n}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(n){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=n}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(n){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=n}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(n){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=n}}});BQ.prototype.load=function(n){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");const e=this;return new DQ().load(n,function(i){e.setBuffer(i)}),this};BC.prototype.updateCubeMap=function(n,e){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(n,e)};BC.prototype.clear=function(n,e,t,i){return console.warn("THREE.CubeCamera: .clear() is now .renderTarget.clear()."),this.renderTarget.clear(n,e,t,i)};d_.crossOrigin=void 0;d_.loadTexture=function(n,e,t,i){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");const r=new SQ;r.setCrossOrigin(this.crossOrigin);const o=r.load(n,t,void 0,i);return e&&(o.mapping=e),o};d_.loadTextureCube=function(n,e,t,i){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");const r=new wQ;r.setCrossOrigin(this.crossOrigin);const o=r.load(n,t,void 0,i);return e&&(o.mapping=e),o};d_.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")};d_.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")};typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:ZO}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=ZO);const Kg=Math.PI/180,r3=180/Math.PI,Zz=6378137,Xz=635675231424518e-8;function ra(n,e,t,i,r,o){const c=QC(n,e,t);return tee(c[0],c[1],c[2],i,r,o)}function vp(n,e,t,i,r,o){const c=iee(n,e,t,i,r,o);return nee(c[0],c[1],c[2])}function tee(n,e,t,i,r,o){const c=QC(i,r,o),s=[n-c[0],e-c[1],t-c[2]];i=i*Kg,r=r*Kg;const d=Math.cos(i),p=Math.sin(i),g=Math.cos(r),_=Math.sin(r),x=-p*s[0]+d*s[1],b=-_*d*s[0]-_*p*s[1]+g*s[2],S=g*d*s[0]+g*p*s[1]+_*s[2];return[x,b,S]}function iee(n,e,t,i,r,o){const c=QC(i,r,o);i=i*Kg,r=r*Kg;const s=Math.cos(i),d=Math.sin(i),p=Math.cos(r),g=Math.sin(r),_=-d*n-g*s*e+p*s*t+c[0],x=s*n-g*d*e+p*d*t+c[1],b=p*e+g*t+c[2];return[_,x,b]}function QC(n,e,t){const i=Zz,r=Xz;n=n*Kg,e=e*Kg;const o=Math.cos(n),c=Math.sin(n),s=Math.cos(e),d=Math.sin(e),p=i*i,g=r*r,_=1/Math.sqrt(p*s*s+g*d*d),x=(p*_+t)*s,b=x*o,S=x*c,P=(g*_+t)*d;return[b,S,P]}function nee(n,e,t){const i=Zz,r=Xz,o=i*i,c=r*r,s=o-c,d=Math.sqrt(s/o),p=Math.sqrt(s/c),g=Math.sqrt(n*n+e*e),_=Math.atan2(t*i,g*r),x=Math.sin(_),b=Math.cos(_),S=Math.atan2(e,n),P=Math.atan2(t+p*p*r*x*x*x,g-d*d*i*b*b*b),L=Math.sin(P),E=Math.cos(P),C=i/Math.sqrt(1-d*d*L*L),D=g/E-C;return[S*r3,P*r3,D]}class eE{boundingBoxCorners(e,t){const i=vp(-t,-t,0,e.lng,e.lat,0),r=vp(t,t,0,e.lng,e.lat,0);return[{lat:i[1],lng:i[0]},{lat:r[1],lng:r[0]}]}rotationFromCompass(e,t){let i=0,r=0,o=0;switch(t){case 1:i=Math.PI/2;break;case 3:i=-Math.PI/2,o=Math.PI;break;case 6:r=-Math.PI/2,o=-Math.PI/2;break;case 8:r=Math.PI/2,o=Math.PI/2;break}const c=new ki().makeRotationZ(o),s=new Ep(i,r,e*Math.PI/180,"XYZ"),d=new ki().makeRotationFromEuler(s),p=new Xn().setAxisAngleFromRotationMatrix(d.multiply(c));return p.multiplyScalar(p.w).toArray().slice(0,3)}}class yx{constructor(e){if(!e)throw new Error(`Incorrect core image data ${e}`);this._cache=null,this._core=e,this._spatial=null}get assetsCached(){return this._core!=null&&this._spatial!=null&&this._cache!=null&&this._cache.image!=null&&this._cache.mesh!=null}get cameraParameters(){return this._spatial.camera_parameters}get cameraType(){return this._spatial.camera_type}get capturedAt(){return this._spatial.captured_at}get clusterId(){return this._spatial.cluster?this._spatial.cluster.id:null}get clusterUrl(){return this._spatial.cluster?this._spatial.cluster.url:null}get compassAngle(){return this._spatial.computed_compass_angle!=null?this._spatial.computed_compass_angle:this._spatial.compass_angle}get complete(){return this._spatial!=null}get computedAltitude(){return this._spatial.computed_altitude}get computedCompassAngle(){return this._spatial.computed_compass_angle}get computedLngLat(){return this._core.computed_geometry}get creatorId(){return this._spatial.creator.id}get creatorUsername(){return this._spatial.creator.username}get exifOrientation(){return this._spatial.exif_orientation}get height(){return this._spatial.height}get image(){return this._cache.image}get image$(){return this._cache.image$}get id(){return this._core.id}get lngLat(){return this._core.computed_geometry!=null?this._core.computed_geometry:this._core.geometry}get merged(){return this._spatial!=null&&this._spatial.merge_id!=null}get mergeId(){return this._spatial.merge_id}get mesh(){return this._cache.mesh}get originalAltitude(){return this._spatial.altitude}get originalCompassAngle(){return this._spatial.compass_angle}get originalLngLat(){return this._core.geometry}get ownerId(){return this._spatial.owner?this._spatial.owner.id:null}get private(){return this._spatial.private}get qualityScore(){return this._spatial.quality_score}get rotation(){return this._spatial.computed_rotation}get scale(){return this._spatial.atomic_scale}get sequenceId(){return this._core.sequence?this._core.sequence.id:null}get sequenceEdges(){return this._cache.sequenceEdges}get sequenceEdges$(){return this._cache.sequenceEdges$}get spatialEdges(){return this._cache.spatialEdges}get spatialEdges$(){return this._cache.spatialEdges$}get width(){return this._spatial.width}cacheAssets$(){return this._cache.cacheAssets$(this._spatial,this.merged).pipe(st(()=>this))}cacheImage$(){return this._cache.cacheImage$(this._spatial).pipe(st(()=>this))}cacheSequenceEdges(e){this._cache.cacheSequenceEdges(e)}cacheSpatialEdges(e){this._cache.cacheSpatialEdges(e)}dispose(){this._cache!=null&&(this._cache.dispose(),this._cache=null),this._core=null,this._spatial=null}initializeCache(e){if(this._cache!=null)throw new Error(`Image cache already initialized (${this.id}).`);this._cache=e}makeComplete(e){if(e==null)throw new Error("Fill can not be null.");this._spatial=e}resetSequenceEdges(){this._cache.resetSequenceEdges()}resetSpatialEdges(){this._cache.resetSpatialEdges()}uncache(){this._cache!=null&&(this._cache.dispose(),this._cache=null)}}class ree{constructor(e){this._disposed=!1,this._provider=e,this._image=null,this._mesh=null,this._sequenceEdges={cached:!1,edges:[]},this._spatialEdges={cached:!1,edges:[]},this._imageChanged$=new ri,this._image$=this._imageChanged$.pipe(An(null),Ii(1),_i()),this._iamgeSubscription=this._image$.subscribe(),this._sequenceEdgesChanged$=new ri,this._sequenceEdges$=this._sequenceEdgesChanged$.pipe(An(this._sequenceEdges),Ii(1),_i()),this._sequenceEdgesSubscription=this._sequenceEdges$.subscribe(()=>{}),this._spatialEdgesChanged$=new ri,this._spatialEdges$=this._spatialEdgesChanged$.pipe(An(this._spatialEdges),Ii(1),_i()),this._spatialEdgesSubscription=this._spatialEdges$.subscribe(()=>{}),this._cachingAssets$=null}get image(){return this._image}get image$(){return this._image$}get mesh(){return this._mesh}get sequenceEdges(){return this._sequenceEdges}get sequenceEdges$(){return this._sequenceEdges$}get spatialEdges(){return this._spatialEdges}get spatialEdges$(){return this._spatialEdges$}cacheAssets$(e,t){return this._cachingAssets$!=null?this._cachingAssets$:(this._cachingAssets$=Si(this._cacheImage$(e),this._cacheMesh$(e,t)).pipe(st(([i,r])=>(this._image=i,this._mesh=r,this)),va(()=>{this._cachingAssets$=null}),Ii(1),_i()),this._cachingAssets$.pipe(wi(i=>!!i._image)).subscribe(()=>{this._imageChanged$.next(this._image)},()=>{}),this._cachingAssets$)}cacheImage$(e){if(this._image!=null)return Pi(this);const t=this._cacheImage$(e).pipe(wi(i=>!!i),Dr(i=>{this._disposeImage(),this._image=i}),st(()=>this),Ii(1),_i());return t.subscribe(()=>{this._imageChanged$.next(this._image)},()=>{}),t}cacheSequenceEdges(e){this._sequenceEdges={cached:!0,edges:e},this._sequenceEdgesChanged$.next(this._sequenceEdges)}cacheSpatialEdges(e){this._spatialEdges={cached:!0,edges:e},this._spatialEdgesChanged$.next(this._spatialEdges)}dispose(){this._iamgeSubscription.unsubscribe(),this._sequenceEdgesSubscription.unsubscribe(),this._spatialEdgesSubscription.unsubscribe(),this._disposeImage(),this._mesh=null,this._sequenceEdges={cached:!1,edges:[]},this._spatialEdges={cached:!1,edges:[]},this._imageChanged$.next(null),this._sequenceEdgesChanged$.next(this._sequenceEdges),this._spatialEdgesChanged$.next(this._spatialEdges),this._disposed=!0,this._imageAborter!=null&&(this._imageAborter(),this._imageAborter=null),this._meshAborter!=null&&(this._meshAborter(),this._meshAborter=null)}resetSequenceEdges(){this._sequenceEdges={cached:!1,edges:[]},this._sequenceEdgesChanged$.next(this._sequenceEdges)}resetSpatialEdges(){this._spatialEdges={cached:!1,edges:[]},this._spatialEdgesChanged$.next(this._spatialEdges)}_cacheImage$(e){return _r.create(t=>{const i=new Promise((o,c)=>{this._imageAborter=c}),r=e.thumb.url;if(!r){const o=e.thumb.id,c=`Incorrect thumb URL for ${e.id} (${o}, ${r})`;t.error(new Error(c));return}this._provider.getImageBuffer(r,i).then(o=>{this._imageAborter=null;const c=new Image;c.crossOrigin="Anonymous",c.onload=()=>{if(this._disposed){window.URL.revokeObjectURL(c.src);const d=`Image load was aborted (${r})`;t.error(new Error(d));return}t.next(c),t.complete()},c.onerror=()=>{this._imageAborter=null,t.error(new Error(`Failed to load image (${r})`))};const s=new Blob([o]);c.src=window.URL.createObjectURL(s)},o=>{this._imageAborter=null,t.error(o)})})}_cacheMesh$(e,t){return _r.create(i=>{if(!t){i.next(this._createEmptyMesh()),i.complete();return}const r=e.mesh.url;if(!r){const c=e.mesh.id,s=`Incorrect mesh URL for ${e.id} (${c}, ${r})`;console.warn(s),i.next(this._createEmptyMesh()),i.complete();return}const o=new Promise((c,s)=>{this._meshAborter=s});this._provider.getMesh(r,o).then(c=>{this._meshAborter=null,!this._disposed&&(i.next(c),i.complete())},c=>{this._meshAborter=null,console.error(c),i.next(this._createEmptyMesh()),i.complete()})})}_createEmptyMesh(){return{faces:[],vertices:[]}}_disposeImage(){this._image!=null&&window.URL.revokeObjectURL(this._image.src),this._image=null}}class see{constructor(e){this._id=e.id,this._imageIds=e.image_ids}get id(){return this._id}get imageIds(){return this._imageIds}dispose(){this._id=null,this._imageIds=null}findNext(e){let t=this._imageIds.indexOf(e);return t+1>=this._imageIds.length||t===-1?null:this._imageIds[t+1]}findPrev(e){let t=this._imageIds.indexOf(e);return t===0||t===-1?null:this._imageIds[t-1]}}class oee{constructor(){this.sphericalPreferredDistance=2,this.sphericalMotion=2,this.sphericalSequencePenalty=1,this.sphericalMergeCCPenalty=4,this.stepPreferredDistance=4,this.stepMotion=3,this.stepRotation=4,this.stepSequencePenalty=2,this.stepMergeCCPenalty=6,this.similarDistance=2,this.similarRotation=3,this.turnDistance=4,this.turnMotion=2,this.turnSequencePenalty=1,this.turnMergeCCPenalty=4}}var Vt;(function(n){n[n.Next=0]="Next",n[n.Prev=1]="Prev",n[n.StepLeft=2]="StepLeft",n[n.StepRight=3]="StepRight",n[n.StepForward=4]="StepForward",n[n.StepBackward=5]="StepBackward",n[n.TurnLeft=6]="TurnLeft",n[n.TurnRight=7]="TurnRight",n[n.TurnU=8]="TurnU",n[n.Spherical=9]="Spherical",n[n.Similar=10]="Similar"})(Vt||(Vt={}));class aee{constructor(){this.steps={},this.turns={},this.spherical={},this.steps[Vt.StepForward]={direction:Vt.StepForward,motionChange:0,useFallback:!0},this.steps[Vt.StepBackward]={direction:Vt.StepBackward,motionChange:Math.PI,useFallback:!0},this.steps[Vt.StepLeft]={direction:Vt.StepLeft,motionChange:Math.PI/2,useFallback:!1},this.steps[Vt.StepRight]={direction:Vt.StepRight,motionChange:-Math.PI/2,useFallback:!1},this.turns[Vt.TurnLeft]={direction:Vt.TurnLeft,directionChange:Math.PI/2,motionChange:Math.PI/4},this.turns[Vt.TurnRight]={direction:Vt.TurnRight,directionChange:-Math.PI/2,motionChange:-Math.PI/4},this.turns[Vt.TurnU]={direction:Vt.TurnU,directionChange:Math.PI,motionChange:null},this.spherical[Vt.StepForward]={direction:Vt.StepForward,directionChange:0,next:Vt.StepLeft,prev:Vt.StepRight},this.spherical[Vt.StepBackward]={direction:Vt.StepBackward,directionChange:Math.PI,next:Vt.StepRight,prev:Vt.StepLeft},this.spherical[Vt.StepLeft]={direction:Vt.StepLeft,directionChange:Math.PI/2,next:Vt.StepBackward,prev:Vt.StepForward},this.spherical[Vt.StepRight]={direction:Vt.StepRight,directionChange:-Math.PI/2,next:Vt.StepForward,prev:Vt.StepBackward}}}class lee{constructor(){this.sphericalMinDistance=.1,this.sphericalMaxDistance=20,this.sphericalPreferredDistance=5,this.sphericalMaxItems=4,this.sphericalMaxStepTurnChange=Math.PI/8,this.rotationMaxDistance=this.turnMaxRigDistance,this.rotationMaxDirectionChange=Math.PI/6,this.rotationMaxVerticalDirectionChange=Math.PI/8,this.similarMaxDirectionChange=Math.PI/8,this.similarMaxDistance=12,this.similarMinTimeDifference=12*3600*1e3,this.stepMaxDistance=20,this.stepMaxDirectionChange=Math.PI/6,this.stepMaxDrift=Math.PI/6,this.stepPreferredDistance=4,this.turnMaxDistance=15,this.turnMaxDirectionChange=2*Math.PI/9,this.turnMaxRigDistance=.65,this.turnMinRigDirectionChange=Math.PI/6}get maxDistance(){return Math.max(this.sphericalMaxDistance,this.similarMaxDistance,this.stepMaxDistance,this.turnMaxDistance)}}class ur extends Error{constructor(e){super(e),Object.setPrototypeOf(this,ur.prototype),this.name="MapillaryError"}}class _a extends ur{constructor(e){super(e??"The argument is not valid."),Object.setPrototypeOf(this,_a.prototype),this.name="ArgumentMapillaryError"}}class xo{constructor(){this._epsilon=1e-9}azimuthalToBearing(e){return-e+Math.PI/2}degToRad(e){return Math.PI*e/180}radToDeg(e){return 180*e/Math.PI}rotationMatrix(e){let t=new Ge(e[0],e[1],e[2]),i=t.length();return i>0&&t.normalize(),new ki().makeRotationAxis(t,i)}rotate(e,t){let i=new Ge(e[0],e[1],e[2]),r=this.rotationMatrix(t);return i.applyMatrix4(r),i}opticalCenter(e,t){let i=[-e[0],-e[1],-e[2]],r=[-t[0],-t[1],-t[2]];return this.rotate(r,i)}viewingDirection(e){let t=[-e[0],-e[1],-e[2]];return this.rotate([0,0,1],t)}wrap(e,t,i){if(i<t)throw new Error("Invalid arguments: max must be larger than min.");let r=i-t;for(;e>i||e<t;)e>i?e=e-r:e<t&&(e=e+r);return e}wrapAngle(e){return this.wrap(e,-Math.PI,Math.PI)}clamp(e,t,i){return e<t?t:e>i?i:e}angleBetweenVector2(e,t,i,r){let o=Math.atan2(r,i)-Math.atan2(t,e);return this.wrapAngle(o)}angleDifference(e,t){let i=t-e;return this.wrapAngle(i)}relativeRotationAngle(e,t){let i=this.rotationMatrix([-e[0],-e[1],-e[2]]),r=this.rotationMatrix(t),c=i.multiply(r).elements,s=c[0]+c[5]+c[10];return Math.acos(Math.max(Math.min((s-1)/2,1),-1))}angleToPlane(e,t){let i=new Ge().fromArray(e),r=i.length();if(r<this._epsilon)return 0;let o=i.dot(new Ge().fromArray(t));return Math.asin(o/r)}azimuthal(e,t){const i=new Ge().fromArray(e),r=new Ge().fromArray(t),o=i.clone().dot(r),c=i.clone().sub(r.clone().multiplyScalar(o));return Math.atan2(c.y,c.x)}distanceFromLngLat(e,t,i,r){let o=6371e3,c=this.degToRad(r-t),s=this.degToRad(i-e),d=Math.sin(c/2)*Math.sin(c/2)+Math.cos(this.degToRad(t))*Math.cos(this.degToRad(r))*Math.sin(s/2)*Math.sin(s/2);return 2*o*Math.atan2(Math.sqrt(d),Math.sqrt(1-d))}}const cee=new xo;function Di(n){return n==="spherical"}function kw(n){return n==="fisheye"}function Dw(n,e,t){const i=ra(n.lng,n.lat,n.alt,t.lng,t.lat,t.alt),r=cee.rotate(i,e);return[-r.x,-r.y,-r.z]}function tE(n,e,t,i,r){const o=[];for(let d=0;d<e.length;++d){const p=e[d],g=t[d];for(let _=0;_<=i;++_)o.push([p[0]+g[0]*_/i,p[1]+g[1]*_/i])}const c=new v0;return c.up.copy(n.upVector()),c.position.copy(new Ge().fromArray(n.unprojectSfM([0,0],0))),c.lookAt(new Ge().fromArray(n.unprojectSfM([0,0],10))),c.updateMatrix(),c.updateMatrixWorld(!0),o.map(d=>{const p=n.unprojectBasic(d,1e4),g=r.worldToCamera(p,c);return[Math.abs(g[0]/g[2]),Math.abs(g[1]/g[2])]})}class uee{constructor(e,t,i){this._spatial=new xo,this._settings=e??new lee,this._directions=t??new aee,this._coefficients=i??new oee}getPotentialEdges(e,t,i){if(!e.complete)throw new _a("Image has to be full.");if(!e.merged)return[];let r=this._spatial.viewingDirection(e.rotation),o=this._spatial.angleToPlane(r.toArray(),[0,0,1]),c=[];for(let s of t){if(!s.merged||s.id===e.id)continue;let d=ra(s.lngLat.lng,s.lngLat.lat,s.computedAltitude,e.lngLat.lng,e.lngLat.lat,e.computedAltitude),p=new Ge(d[0],d[1],d[2]),g=p.length();if(g>this._settings.maxDistance&&i.indexOf(s.id)<0)continue;let _=this._spatial.angleBetweenVector2(r.x,r.y,p.x,p.y),x=this._spatial.angleToPlane(p.toArray(),[0,0,1]),b=this._spatial.viewingDirection(s.rotation),S=this._spatial.angleBetweenVector2(r.x,r.y,b.x,b.y),L=this._spatial.angleToPlane(b.toArray(),[0,0,1])-o,E=this._spatial.relativeRotationAngle(e.rotation,s.rotation),C=this._spatial.angleBetweenVector2(1,0,p.x,p.y),D=s.sequenceId!=null&&e.sequenceId!=null&&s.sequenceId===e.sequenceId,O=s.mergeId===e.mergeId,U=s.creatorId===e.creatorId,j={capturedAt:s.capturedAt,directionChange:S,distance:g,spherical:Di(s.cameraType),id:s.id,motionChange:_,rotation:E,sameMergeCC:O,sameSequence:D,sameUser:U,sequenceId:s.sequenceId,verticalDirectionChange:L,verticalMotion:x,worldMotionAzimuth:C};c.push(j)}return c}computeSequenceEdges(e,t){if(!e.complete)throw new _a("Image has to be full.");if(e.sequenceId!==t.id)throw new _a("Image and sequence does not correspond.");let i=[],r=t.findNext(e.id);r!=null&&i.push({data:{direction:Vt.Next,worldMotionAzimuth:Number.NaN},source:e.id,target:r});let o=t.findPrev(e.id);return o!=null&&i.push({data:{direction:Vt.Prev,worldMotionAzimuth:Number.NaN},source:e.id,target:o}),i}computeSimilarEdges(e,t){if(!e.complete)throw new _a("Image has to be full.");let i=Di(e.cameraType),r={};for(let s of t)if(s.sequenceId!=null&&!s.sameSequence){if(i){if(!s.spherical)continue}else if(!s.spherical&&Math.abs(s.directionChange)>this._settings.similarMaxDirectionChange)continue;s.distance>this._settings.similarMaxDistance||s.sameUser&&Math.abs(s.capturedAt-e.capturedAt)<this._settings.similarMinTimeDifference||(r[s.sequenceId]==null&&(r[s.sequenceId]=[]),r[s.sequenceId].push(s))}let o=[],c=Di(e.cameraType)?s=>s.distance:s=>this._coefficients.similarDistance*s.distance+this._coefficients.similarRotation*s.rotation;for(let s in r){if(!r.hasOwnProperty(s))continue;let d=Number.MAX_VALUE,p=null;for(let g of r[s]){let _=c(g);_<d&&(d=_,p=g)}p!=null&&o.push(p)}return o.map(s=>({data:{direction:Vt.Similar,worldMotionAzimuth:s.worldMotionAzimuth},source:e.id,target:s.id}))}computeStepEdges(e,t,i,r){if(!e.complete)throw new _a("Image has to be full.");let o=[];if(Di(e.cameraType))return o;for(let c in this._directions.steps){if(!this._directions.steps.hasOwnProperty(c))continue;let s=this._directions.steps[c],d=Number.MAX_VALUE,p=null,g=null;for(let _ of t){if(_.spherical||Math.abs(_.directionChange)>this._settings.stepMaxDirectionChange)continue;let x=this._spatial.angleDifference(s.motionChange,_.motionChange),b=this._spatial.angleDifference(_.directionChange,x),S=Math.max(Math.abs(x),Math.abs(b));if(Math.abs(S)>this._settings.stepMaxDrift)continue;let P=_.id;if(s.useFallback&&(P===i||P===r)&&(g=_),_.distance>this._settings.stepMaxDistance)continue;x=Math.sqrt(x*x+_.verticalMotion*_.verticalMotion);let L=this._coefficients.stepPreferredDistance*Math.abs(_.distance-this._settings.stepPreferredDistance)/this._settings.stepMaxDistance+this._coefficients.stepMotion*x/this._settings.stepMaxDrift+this._coefficients.stepRotation*_.rotation/this._settings.stepMaxDirectionChange+this._coefficients.stepSequencePenalty*(_.sameSequence?0:1)+this._coefficients.stepMergeCCPenalty*(_.sameMergeCC?0:1);L<d&&(d=L,p=_)}p=p??g,p!=null&&o.push({data:{direction:s.direction,worldMotionAzimuth:p.worldMotionAzimuth},source:e.id,target:p.id})}return o}computeTurnEdges(e,t){if(!e.complete)throw new _a("Image has to be full.");let i=[];if(Di(e.cameraType))return i;for(let r in this._directions.turns){if(!this._directions.turns.hasOwnProperty(r))continue;let o=this._directions.turns[r],c=Number.MAX_VALUE,s=null;for(let d of t){if(d.spherical||d.distance>this._settings.turnMaxDistance)continue;let p=o.direction!==Vt.TurnU&&d.distance<this._settings.turnMaxRigDistance&&Math.abs(d.directionChange)>this._settings.turnMinRigDirectionChange,g=this._spatial.angleDifference(o.directionChange,d.directionChange),_;if(p&&d.directionChange*o.directionChange>0&&Math.abs(d.directionChange)<Math.abs(o.directionChange))_=-Math.PI/2+Math.abs(d.directionChange);else{if(Math.abs(g)>this._settings.turnMaxDirectionChange)continue;let x=o.motionChange?this._spatial.angleDifference(o.motionChange,d.motionChange):0;x=Math.sqrt(x*x+d.verticalMotion*d.verticalMotion),_=this._coefficients.turnDistance*d.distance/this._settings.turnMaxDistance+this._coefficients.turnMotion*x/Math.PI+this._coefficients.turnSequencePenalty*(d.sameSequence?0:1)+this._coefficients.turnMergeCCPenalty*(d.sameMergeCC?0:1)}_<c&&(c=_,s=d)}s!=null&&i.push({data:{direction:o.direction,worldMotionAzimuth:s.worldMotionAzimuth},source:e.id,target:s.id})}return i}computePerspectiveToSphericalEdges(e,t){if(!e.complete)throw new _a("Image has to be full.");if(Di(e.cameraType))return[];let i=Number.MAX_VALUE,r=null;for(let o of t){if(!o.spherical)continue;let c=this._coefficients.sphericalPreferredDistance*Math.abs(o.distance-this._settings.sphericalPreferredDistance)/this._settings.sphericalMaxDistance+this._coefficients.sphericalMotion*Math.abs(o.motionChange)/Math.PI+this._coefficients.sphericalMergeCCPenalty*(o.sameMergeCC?0:1);c<i&&(i=c,r=o)}return r==null?[]:[{data:{direction:Vt.Spherical,worldMotionAzimuth:r.worldMotionAzimuth},source:e.id,target:r.id}]}computeSphericalEdges(e,t){if(!e.complete)throw new _a("Image has to be full.");if(!Di(e.cameraType))return[];let i=[],r=[],o=[];for(let g of t)if(!(g.distance>this._settings.sphericalMaxDistance))if(g.spherical){if(g.distance<this._settings.sphericalMinDistance)continue;r.push(g)}else for(let _ in this._directions.spherical){if(!this._directions.spherical.hasOwnProperty(_))continue;let x=this._directions.spherical[_],b=this._spatial.angleDifference(g.directionChange,g.motionChange),S=this._spatial.angleDifference(x.directionChange,b);if(!(Math.abs(S)>this._settings.sphericalMaxStepTurnChange)){o.push([x.direction,g]);break}}let c=Math.PI/this._settings.sphericalMaxItems,s=[],d=[];for(let g=0;g<this._settings.sphericalMaxItems;g++){let _=g/this._settings.sphericalMaxItems*2*Math.PI,x=Number.MAX_VALUE,b=null;for(let S of r){let P=this._spatial.angleDifference(_,S.motionChange);if(Math.abs(P)>c)continue;let L=Number.MAX_VALUE;for(let C of s){let D=Math.abs(this._spatial.angleDifference(C,S.motionChange));D<L&&(L=D)}if(L<=c)continue;let E=this._coefficients.sphericalPreferredDistance*Math.abs(S.distance-this._settings.sphericalPreferredDistance)/this._settings.sphericalMaxDistance+this._coefficients.sphericalMotion*Math.abs(P)/c+this._coefficients.sphericalSequencePenalty*(S.sameSequence?0:1)+this._coefficients.sphericalMergeCCPenalty*(S.sameMergeCC?0:1);E<x&&(x=E,b=S)}b!=null?(s.push(b.motionChange),i.push({data:{direction:Vt.Spherical,worldMotionAzimuth:b.worldMotionAzimuth},source:e.id,target:b.id})):d.push(_)}let p={};p[Vt.Spherical]=s,p[Vt.StepForward]=[],p[Vt.StepLeft]=[],p[Vt.StepBackward]=[],p[Vt.StepRight]=[];for(let g of d){let _=[];for(let x in this._directions.spherical){if(!this._directions.spherical.hasOwnProperty(x))continue;let b=this._directions.spherical[x],S=p[Vt.Spherical].concat(p[b.direction]).concat(p[b.prev]).concat(p[b.next]),P=Number.MAX_VALUE,L=null;for(let E of o){if(E[0]!==b.direction)continue;let C=this._spatial.angleDifference(g,E[1].motionChange);if(Math.abs(C)>c)continue;let D=Number.MAX_VALUE;for(let U of S){let j=Math.abs(this._spatial.angleDifference(U,E[1].motionChange));j<D&&(D=j)}if(D<=c)continue;let O=this._coefficients.sphericalPreferredDistance*Math.abs(E[1].distance-this._settings.sphericalPreferredDistance)/this._settings.sphericalMaxDistance+this._coefficients.sphericalMotion*Math.abs(C)/c+this._coefficients.sphericalMergeCCPenalty*(E[1].sameMergeCC?0:1);O<P&&(P=O,L=E)}L!=null&&(_.push(L),i.push({data:{direction:L[0],worldMotionAzimuth:L[1].worldMotionAzimuth},source:e.id,target:L[1].id}))}for(let x of _)p[x[0]].push(x[1].motionChange)}return i}}class lr extends ur{constructor(e){super(e),Object.setPrototypeOf(this,lr.prototype),this.name="GraphMapillaryError"}}class qy{constructor(e,t,i,r,o,c){this._api=e,this._cachedNodes={},this._cachedNodeTiles={},this._cachedSequenceNodes={},this._cachedSpatialEdges={},this._cachedTiles={},this._cachingFill$={},this._cachingFull$={},this._cachingSequenceNodes$={},this._cachingSequences$={},this._cachingSpatialArea$={},this._cachingTiles$={},this._changed$=new ri,this._filterCreator=o??new ZW,this._filter=this._filterCreator.createFilter(void 0),this._filterSubject$=new ri,this._filter$=jl(Pi(this._filter),this._filterSubject$).pipe(Ii(1),_i()),this._filterSubscription=this._filter$.subscribe(()=>{}),this._defaultAlt=2,this._edgeCalculator=r??new uee,this._graphCalculator=i??new eE,this._configuration=c??{maxSequences:50,maxUnusedImages:100,maxUnusedPreStoredImages:30,maxUnusedTiles:20},this._nodes={},this._nodeIndex=t??new qy._spatialIndex(16),this._nodeIndexTiles={},this._nodeToTile={},this._preStored={},this._requiredNodeTiles={},this._requiredSpatialArea={},this._sequences={},this._tileThreshold=20}static register(e){qy._spatialIndex=e}get api(){return this._api}get changed$(){return this._changed$}get filter$(){return this._filter$}cacheBoundingBox$(e,t){const i=this._api.data.geometry.bboxToCellIds(e,t).filter(r=>!(r in this._cachedTiles)).map(r=>r in this._cachingTiles$?this._cachingTiles$[r]:this._cacheTile$(r));return i.length===0&&i.push(Pi(this)),Fr(i).pipe(lp(),Wg(),Hi(()=>{const r=this._nodeIndex.search({maxX:t.lng,maxY:t.lat,minX:e.lng,minY:e.lat}).map(_=>_.node),o=[],c=[];for(const _ of r)_.complete?o.push(_):c.push(_.id);const s=[],d=200;for(;c.length>0;)s.push(c.splice(0,d));const p=Pi(o),g=s.map(_=>this._api.getSpatialImages$(_).pipe(st(x=>{const b=[];for(const S of x){if(!this.hasNode(S.node_id))continue;const L=this.getNode(S.node_id);L.complete||this._makeFull(L,S.node),b.push(L)}return b})));return mn(p,Fr(g).pipe(lp()))}),LR((r,o)=>r.concat(o)))}cacheCell$(e){return(e in this._cachedTiles?Pi(this):e in this._cachingTiles$?this._cachingTiles$[e]:this._cacheTile$(e)).pipe(Hi(()=>{const i=this._cachedTiles[e];i.accessed=new Date().getTime();const r=i.nodes,o=[],c=[];for(const _ of r)_.complete?o.push(_):c.push(_.id);const s=[],d=200;for(;c.length>0;)s.push(c.splice(0,d));const p=Pi(o),g=s.map(_=>this._api.getSpatialImages$(_).pipe(st(x=>{const b=[];for(const S of x){if(!S.node){console.warn(`Image is empty (${S.node})`);continue}const P=S.node_id;if(!this.hasNode(P))continue;const L=this.getNode(P);L.complete||this._makeFull(L,S.node),b.push(L)}return b})));return mn(p,Fr(g).pipe(lp()))}),LR((i,r)=>i.concat(r)))}cacheFill$(e){if(e in this._cachingFull$)throw new lr(`Cannot fill node while caching full (${e}).`);if(!this.hasNode(e))throw new lr(`Cannot fill node that does not exist in graph (${e}).`);if(e in this._cachingFill$)return this._cachingFill$[e];const t=this.getNode(e);if(t.complete)throw new lr(`Cannot fill node that is already full (${e}).`);return this._cachingFill$[e]=this._api.getSpatialImages$([e]).pipe(Dr(i=>{for(const r of i)r.node||console.warn(`Image is empty ${r.node_id}`),t.complete||this._makeFull(t,r.node),delete this._cachingFill$[r.node_id]}),st(()=>this),va(()=>{e in this._cachingFill$&&delete this._cachingFill$[e],this._changed$.next(this)}),Qa(),_i()),this._cachingFill$[e]}cacheFull$(e){if(e in this._cachingFull$)return this._cachingFull$[e];if(this.hasNode(e))throw new lr(`Cannot cache full node that already exist in graph (${e}).`);return this._cachingFull$[e]=this._api.getImages$([e]).pipe(Dr(t=>{for(const i of t){if(!i.node)throw new lr(`Image does not exist (${e}, ${i.node}).`);const r=i.node_id;if(this.hasNode(r)){const o=this.getNode(e);o.complete||this._makeFull(o,i.node)}else{if(i.node.sequence.id==null)throw new lr(`Image has no sequence key (${e}).`);const o=new yx(i.node);this._makeFull(o,i.node);const c=this._api.data.geometry.lngLatToCellId(o.originalLngLat);this._preStore(c,o),this._setNode(o),delete this._cachingFull$[r]}}}),st(()=>this),va(()=>{e in this._cachingFull$&&delete this._cachingFull$[e],this._changed$.next(this)}),Qa(),_i()),this._cachingFull$[e]}cacheNodeSequence$(e){if(!this.hasNode(e))throw new lr(`Cannot cache sequence edges of node that does not exist in graph (${e}).`);let t=this.getNode(e);if(t.sequenceId in this._sequences)throw new lr(`Sequence already cached (${e}), (${t.sequenceId}).`);return this._cacheSequence$(t.sequenceId)}cacheSequence$(e){if(e in this._sequences)throw new lr(`Sequence already cached (${e})`);return this._cacheSequence$(e)}cacheSequenceEdges(e){let t=this.getNode(e);if(!(t.sequenceId in this._sequences))throw new lr(`Sequence is not cached (${e}), (${t.sequenceId})`);let i=this._sequences[t.sequenceId].sequence,r=this._edgeCalculator.computeSequenceEdges(t,i);t.cacheSequenceEdges(r)}cacheSequenceNodes$(e,t){if(!this.hasSequence(e))throw new lr(`Cannot cache sequence nodes of sequence that does not exist in graph (${e}).`);if(this.hasSequenceNodes(e))throw new lr(`Sequence nodes already cached (${e}).`);const i=this.getSequence(e);if(i.id in this._cachingSequenceNodes$)return this._cachingSequenceNodes$[i.id];const r=[],o=i.imageIds.slice(),c=50;if(t&&o.length>c){const g=o.indexOf(t),_=Math.max(0,Math.min(g-c/2,o.length-c));r.push(o.splice(_,c))}const s=200;for(;o.length>0;)r.push(o.splice(0,s));let d=r.length;const p=Fr(r).pipe(Hi(g=>this._api.getImages$(g).pipe(Dr(_=>{for(const x of _){if(!x.node){console.warn(`Image empty (${x.node_id})`);continue}const b=x.node_id;if(this.hasNode(b)){const S=this.getNode(b);S.complete||this._makeFull(S,x.node)}else{x.node.sequence.id==null&&console.warn(`Sequence missing, discarding node (${x.node_id})`);const S=new yx(x.node);this._makeFull(S,x.node);const P=this._api.data.geometry.lngLatToCellId(S.originalLngLat);this._preStore(P,S),this._setNode(S)}}d--}),st(()=>this)),6),Wg(),va(()=>{delete this._cachingSequenceNodes$[i.id],d===0&&(this._cachedSequenceNodes[i.id]=!0)}),Qa(),_i());return this._cachingSequenceNodes$[i.id]=p,p}cacheSpatialArea$(e){if(!this.hasNode(e))throw new lr(`Cannot cache spatial area of node that does not exist in graph (${e}).`);if(e in this._cachedSpatialEdges)throw new lr(`Image already spatially cached (${e}).`);if(!(e in this._requiredSpatialArea))throw new lr(`Spatial area not determined (${e}).`);let t=this._requiredSpatialArea[e];if(Object.keys(t.cacheNodes).length===0)throw new lr(`Spatial nodes already cached (${e}).`);if(e in this._cachingSpatialArea$)return this._cachingSpatialArea$[e];let i=[];for(;t.cacheKeys.length>0;)i.push(t.cacheKeys.splice(0,200));let r=i.length,o=[];for(let c of i){let s=this._api.getSpatialImages$(c).pipe(Dr(d=>{for(const p of d){if(!p.node){console.warn(`Image is empty (${p.node_id})`);continue}const g=p.node_id,_=t.cacheNodes[g];if(_.complete){delete t.cacheNodes[g];continue}this._makeFull(_,p.node),delete t.cacheNodes[g]}--r===0&&delete this._cachingSpatialArea$[e]}),st(()=>this),Un(d=>{for(let p of c)p in t.all&&delete t.all[p],p in t.cacheNodes&&delete t.cacheNodes[p];throw--r===0&&delete this._cachingSpatialArea$[e],d}),va(()=>{Object.keys(t.cacheNodes).length===0&&this._changed$.next(this)}),Qa(),_i());o.push(s)}return this._cachingSpatialArea$[e]=o,o}cacheSpatialEdges(e){if(e in this._cachedSpatialEdges)throw new lr(`Spatial edges already cached (${e}).`);let t=this.getNode(e),i=this._sequences[t.sequenceId].sequence,r=[],o=i.findPrev(t.id);o!=null&&r.push(o);let c=i.findNext(t.id);c!=null&&r.push(c);let s=this._requiredSpatialArea[e].all,d=[],p=this._filter;for(let x in s){if(!s.hasOwnProperty(x))continue;let b=s[x];p(b)&&d.push(b)}let g=this._edgeCalculator.getPotentialEdges(t,d,r),_=this._edgeCalculator.computeStepEdges(t,g,o,c);_=_.concat(this._edgeCalculator.computeTurnEdges(t,g)),_=_.concat(this._edgeCalculator.computeSphericalEdges(t,g)),_=_.concat(this._edgeCalculator.computePerspectiveToSphericalEdges(t,g)),_=_.concat(this._edgeCalculator.computeSimilarEdges(t,g)),t.cacheSpatialEdges(_),this._cachedSpatialEdges[e]=t,delete this._requiredSpatialArea[e],delete this._cachedNodeTiles[e]}cacheTiles$(e){if(e in this._cachedNodeTiles)throw new lr(`Tiles already cached (${e}).`);if(e in this._cachedSpatialEdges)throw new lr(`Spatial edges already cached so tiles considered cached (${e}).`);if(!(e in this._requiredNodeTiles))throw new lr(`Tiles have not been determined (${e}).`);let t=this._requiredNodeTiles[e];if(t.cache.length===0&&t.caching.length===0)throw new lr(`Tiles already cached (${e}).`);if(!this.hasNode(e))throw new lr(`Cannot cache tiles of node that does not exist in graph (${e}).`);let i=t.cache.slice();t.caching=this._requiredNodeTiles[e].caching.concat(i),t.cache=[];let r=[];for(let o of t.caching){const c=o in this._cachingTiles$?this._cachingTiles$[o]:this._cacheTile$(o);r.push(c.pipe(Dr(s=>{let d=t.caching.indexOf(o);d>-1&&t.caching.splice(d,1),t.caching.length===0&&t.cache.length===0&&(delete this._requiredNodeTiles[e],this._cachedNodeTiles[e]=!0)}),Un(s=>{let d=t.caching.indexOf(o);throw d>-1&&t.caching.splice(d,1),t.caching.length===0&&t.cache.length===0&&(delete this._requiredNodeTiles[e],this._cachedNodeTiles[e]=!0),s}),va(()=>{this._changed$.next(this)}),Qa(),_i()))}return r}initializeCache(e){if(e in this._cachedNodes)throw new lr(`Image already in cache (${e}).`);const t=this.getNode(e),i=this._api.data;t.initializeCache(new ree(i));const r=new Date().getTime();this._cachedNodes[e]={accessed:r,node:t},this._updateCachedTileAccess(e,r)}isCachingFill(e){return e in this._cachingFill$}isCachingFull(e){return e in this._cachingFull$}isCachingNodeSequence(e){return this.getNode(e).sequenceId in this._cachingSequences$}isCachingSequence(e){return e in this._cachingSequences$}isCachingSequenceNodes(e){return e in this._cachingSequenceNodes$}isCachingTiles(e){return e in this._requiredNodeTiles&&this._requiredNodeTiles[e].cache.length===0&&this._requiredNodeTiles[e].caching.length>0}hasInitializedCache(e){return e in this._cachedNodes}hasNode(e){let t=new Date().getTime();return this._updateCachedNodeAccess(e,t),this._updateCachedTileAccess(e,t),e in this._nodes}hasNodeSequence(e){let i=this.getNode(e).sequenceId,r=i in this._sequences;return r&&(this._sequences[i].accessed=new Date().getTime()),r}hasSequence(e){let t=e in this._sequences;return t&&(this._sequences[e].accessed=new Date().getTime()),t}hasSequenceNodes(e){return e in this._cachedSequenceNodes}hasSpatialArea(e){if(!this.hasNode(e))throw new lr(`Spatial area nodes cannot be determined if node not in graph (${e}).`);if(e in this._cachedSpatialEdges)return!0;if(e in this._requiredSpatialArea)return Object.keys(this._requiredSpatialArea[e].cacheNodes).length===0;let t=this.getNode(e),i=this._graphCalculator.boundingBoxCorners(t.lngLat,this._tileThreshold),r=this._nodeIndex.search({maxX:i[1].lng,maxY:i[1].lat,minX:i[0].lng,minY:i[0].lat}),o={all:{},cacheKeys:[],cacheNodes:{}};for(let c of r)o.all[c.node.id]=c.node,c.node.complete||(o.cacheKeys.push(c.node.id),o.cacheNodes[c.node.id]=c.node);return this._requiredSpatialArea[e]=o,o.cacheKeys.length===0}hasTiles(e){if(e in this._cachedNodeTiles||e in this._cachedSpatialEdges)return!0;if(!this.hasNode(e))throw new lr(`Image does not exist in graph (${e}).`);let t={cache:[],caching:[]};if(e in this._requiredNodeTiles)t=this._requiredNodeTiles[e];else{const i=this.getNode(e),[r,o]=this._graphCalculator.boundingBoxCorners(i.lngLat,this._tileThreshold);t.cache=this._api.data.geometry.bboxToCellIds(r,o).filter(c=>!(c in this._cachedTiles)),t.cache.length>0&&(this._requiredNodeTiles[e]=t)}return t.cache.length===0&&t.caching.length===0}getNode(e){let t=new Date().getTime();return this._updateCachedNodeAccess(e,t),this._updateCachedTileAccess(e,t),this._nodes[e]}getSequence(e){let t=this._sequences[e];return t.accessed=new Date().getTime(),t.sequence}resetSpatialEdges(){let e=Object.keys(this._cachedSpatialEdges);for(let t of e)this._cachedSpatialEdges[t].resetSpatialEdges(),delete this._cachedSpatialEdges[t]}reset(e){const t=[];for(const i of e){if(!this.hasNode(i))throw new Error(`Image does not exist ${i}`);const r=this.getNode(i);r.resetSequenceEdges(),r.resetSpatialEdges(),t.push(r)}for(let i of Object.keys(this._cachedNodes))e.indexOf(i)===-1&&(this._cachedNodes[i].node.dispose(),delete this._cachedNodes[i]);this._cachedNodeTiles={},this._cachedSpatialEdges={},this._cachedTiles={},this._cachingFill$={},this._cachingFull$={},this._cachingSequences$={},this._cachingSpatialArea$={},this._cachingTiles$={},this._nodes={},this._nodeToTile={},this._preStored={};for(const i of t){this._nodes[i.id]=i;const r=this._api.data.geometry.lngLatToCellId(i.originalLngLat);this._preStore(r,i)}this._requiredNodeTiles={},this._requiredSpatialArea={},this._sequences={},this._nodeIndexTiles={},this._nodeIndex.clear()}setFilter(e){this._filter=this._filterCreator.createFilter(e),this._filterSubject$.next(this._filter)}uncache(e,t,i){const r={};this._addNewKeys(r,this._cachingFull$),this._addNewKeys(r,this._cachingFill$),this._addNewKeys(r,this._cachingSpatialArea$),this._addNewKeys(r,this._requiredNodeTiles),this._addNewKeys(r,this._requiredSpatialArea);for(const C of e)C in r||(r[C]=!0);const o=this._tileThreshold,c=this._graphCalculator,s=this._api.data.geometry,d=new Set(t);for(let C in r){if(!r.hasOwnProperty(C))continue;const D=this._nodes[C],[O,U]=c.boundingBoxCorners(D.lngLat,o),j=s.bboxToCellIds(O,U);for(const G of j)d.has(G)||d.add(G)}const p=[];for(let C in this._cachedTiles)!this._cachedTiles.hasOwnProperty(C)||d.has(C)||p.push([C,this._cachedTiles[C]]);const g=p.sort((C,D)=>D[1].accessed-C[1].accessed).slice(this._configuration.maxUnusedTiles).map(C=>C[0]);for(let C of g)this._uncacheTile(C,i);const _=[],x=[];for(let C in this._preStored){if(!this._preStored.hasOwnProperty(C)||C in this._cachingTiles$)continue;const D=this._preStored[C];for(let O in D)!D.hasOwnProperty(O)||O in r||D[O].sequenceId!==i&&(O in this._cachedNodes?_.push([this._cachedNodes[O],C]):x.push([O,C]))}const b=_.sort(([C],[D])=>D.accessed-C.accessed).slice(this._configuration.maxUnusedPreStoredImages).map(([C,D])=>[C.node.id,D]);this._uncachePreStored(x),this._uncachePreStored(b);const S=[];for(let C in this._cachedNodes)!this._cachedNodes.hasOwnProperty(C)||C in r||S.push(this._cachedNodes[C]);const P=S.sort((C,D)=>D.accessed-C.accessed).slice(this._configuration.maxUnusedImages);for(const C of P){C.node.uncache();const D=C.node.id;delete this._cachedNodes[D],D in this._cachedNodeTiles&&delete this._cachedNodeTiles[D],D in this._cachedSpatialEdges&&delete this._cachedSpatialEdges[D]}const L=[];for(let C in this._sequences)!this._sequences.hasOwnProperty(C)||C in this._cachingSequences$||C===i||L.push(this._sequences[C]);const E=L.sort((C,D)=>D.accessed-C.accessed).slice(this._configuration.maxSequences);for(const C of E){const D=C.sequence.id;delete this._sequences[D],D in this._cachedSequenceNodes&&delete this._cachedSequenceNodes[D],C.sequence.dispose()}}updateCells$(e){const t=this._cachedTiles,i=this._cachingTiles$;return Fr(e).pipe(Hi(r=>r in t?this._updateCell$(r):r in i?i[r].pipe(Un(()=>Pi(this)),Hi(()=>this._updateCell$(r))):Ni()))}unsubscribe(){this._filterSubscription.unsubscribe()}_addNewKeys(e,t){for(let i in t)!t.hasOwnProperty(i)||!this.hasNode(i)||i in e||(e[i]=!0)}_cacheSequence$(e){return e in this._cachingSequences$?this._cachingSequences$[e]:(this._cachingSequences$[e]=this._api.getSequence$(e).pipe(Dr(t=>{t?(t.id in this._sequences||(this._sequences[t.id]={accessed:new Date().getTime(),sequence:new see(t)}),delete this._cachingSequences$[e]):console.warn(`Sequence does not exist (${e})`)}),st(()=>this),va(()=>{e in this._cachingSequences$&&delete this._cachingSequences$[e],this._changed$.next(this)}),Qa(),_i()),this._cachingSequences$[e])}_cacheTile$(e){return this._cachingTiles$[e]=this._api.getCoreImages$(e).pipe(Dr(t=>{if(e in this._cachedTiles)return;const i=t.images;this._nodeIndexTiles[e]=[],this._cachedTiles[e]={accessed:new Date().getTime(),nodes:[]};const r=this._cachedTiles[e].nodes,o=this._removeFromPreStore(e);for(const c of i){if(!c)break;if(c.sequence.id==null){console.warn(`Sequence missing, discarding node (${c.id})`);continue}if(o!=null&&c.id in o){const p=o[c.id];delete o[c.id],r.push(p);const g={lat:p.lngLat.lat,lng:p.lngLat.lng,node:p};this._nodeIndex.insert(g),this._nodeIndexTiles[e].push(g),this._nodeToTile[p.id]=e;continue}const s=new yx(c);r.push(s);const d={lat:s.lngLat.lat,lng:s.lngLat.lng,node:s};this._nodeIndex.insert(d),this._nodeIndexTiles[e].push(d),this._nodeToTile[s.id]=e,this._setNode(s)}delete this._cachingTiles$[e]}),st(()=>this),Un(t=>{throw delete this._cachingTiles$[e],t}),Qa(),_i()),this._cachingTiles$[e]}_makeFull(e,t){t.computed_altitude==null&&(t.computed_altitude=this._defaultAlt),t.computed_rotation==null&&(t.computed_rotation=this._graphCalculator.rotationFromCompass(t.compass_angle,t.exif_orientation)),e.makeComplete(t)}_preStore(e,t){e in this._preStored||(this._preStored[e]={}),this._preStored[e][t.id]=t}_removeFromPreStore(e){let t=null;return e in this._preStored&&(t=this._preStored[e],delete this._preStored[e]),t}_setNode(e){let t=e.id;if(this.hasNode(t))throw new lr(`Image already exist (${t}).`);this._nodes[t]=e}_uncacheTile(e,t){for(let i of this._cachedTiles[e].nodes){let r=i.id;delete this._nodeToTile[r],r in this._cachedNodes&&delete this._cachedNodes[r],r in this._cachedNodeTiles&&delete this._cachedNodeTiles[r],r in this._cachedSpatialEdges&&delete this._cachedSpatialEdges[r],i.sequenceId===t?(this._preStore(e,i),i.uncache()):(delete this._nodes[r],i.sequenceId in this._cachedSequenceNodes&&delete this._cachedSequenceNodes[i.sequenceId],i.dispose())}for(let i of this._nodeIndexTiles[e])this._nodeIndex.remove(i);delete this._nodeIndexTiles[e],delete this._cachedTiles[e]}_uncachePreStored(e){let t={};for(let[i,r]of e){i in this._nodes&&delete this._nodes[i],i in this._cachedNodes&&delete this._cachedNodes[i];let o=this._preStored[r][i];o.sequenceId in this._cachedSequenceNodes&&delete this._cachedSequenceNodes[o.sequenceId],delete this._preStored[r][i],o.dispose(),t[r]=!0}for(let i in t)t.hasOwnProperty(i)&&Object.keys(this._preStored[i]).length===0&&delete this._preStored[i]}_updateCachedTileAccess(e,t){e in this._nodeToTile&&(this._cachedTiles[this._nodeToTile[e]].accessed=t)}_updateCachedNodeAccess(e,t){e in this._cachedNodes&&(this._cachedNodes[e].accessed=t)}_updateCell$(e){return this._api.getCoreImages$(e).pipe(Hi(t=>{if(!(e in this._cachedTiles))return Ni();const i=this._nodeIndex,r=this._nodeIndexTiles[e],o=this._nodeToTile,c=this._cachedTiles[e];c.accessed=new Date().getTime();const s=c.nodes,d=t.images;for(const p of d){if(p==null)break;if(this.hasNode(p.id))continue;if(p.sequence.id==null){console.warn(`Sequence missing, discarding node (${p.id})`);continue}const g=new yx(p);s.push(g);const _={lat:g.lngLat.lat,lng:g.lngLat.lng,node:g};i.insert(_),r.push(_),o[g.id]=e,this._setNode(g)}return Pi(e)}),Un(t=>(console.error(t),Ni())))}}class Wy{constructor(){this._hash={},this._index=new Wy._spatialIndex(16),this._indexChanged$=new ri,this._updated$=new ri}static register(e){Wy._spatialIndex=e}get changed$(){return this._indexChanged$}get updated$(){return this._updated$}add(e){const t=[],i=this._hash,r=this._index;for(const o of e){const c=o.id;c in i&&(r.remove(i[c]),t.push(o));const s={lat:o.lngLat.lat,lng:o.lngLat.lng,marker:o};i[c]=s,r.insert(s)}t.length>0&&this._updated$.next(t),e.length>t.length&&this._indexChanged$.next(this)}has(e){return e in this._hash}get(e){return this.has(e)?this._hash[e].marker:void 0}getAll(){return this._index.all().map(e=>e.marker)}remove(e){const t=this._hash,i=this._index;let r=!1;for(const o of e){if(!(o in t))continue;const c=t[o];i.remove(c),delete t[o],r=!0}r&&this._indexChanged$.next(this)}removeAll(){this._hash={},this._index.clear(),this._indexChanged$.next(this)}search([e,t]){return this._index.search({maxX:t.lng,maxY:t.lat,minX:e.lng,minY:e.lat}).map(i=>i.marker)}update(e){const t=this._hash,i=this._index,r=e.id;if(!(r in t))return;i.remove(t[r]);const o={lat:e.lngLat.lat,lng:e.lngLat.lng,marker:e};t[r]=o,i.insert(o)}}function hee(n,e,t,i,r){Yz(n,e,t||0,i||n.length-1,r||dee)}function Yz(n,e,t,i,r){for(;i>t;){if(i-t>600){var o=i-t+1,c=e-t+1,s=Math.log(o),d=.5*Math.exp(2*s/3),p=.5*Math.sqrt(s*d*(o-d)/o)*(c-o/2<0?-1:1),g=Math.max(t,Math.floor(e-c*d/o+p)),_=Math.min(i,Math.floor(e+(o-c)*d/o+p));Yz(n,e,g,_,r)}var x=n[e],b=t,S=i;for(zv(n,t,e),r(n[i],x)>0&&zv(n,t,i);b<S;){for(zv(n,b,S),b++,S--;r(n[b],x)<0;)b++;for(;r(n[S],x)>0;)S--}r(n[t],x)===0?zv(n,t,S):(S++,zv(n,S,i)),S<=e&&(t=S+1),e<=S&&(i=S-1)}}function zv(n,e,t){var i=n[e];n[e]=n[t],n[t]=i}function dee(n,e){return n<e?-1:n>e?1:0}class fee{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const i=[];if(!xx(e,t))return i;const r=this.toBBox,o=[];for(;t;){for(let c=0;c<t.children.length;c++){const s=t.children[c],d=t.leaf?r(s):s;xx(e,d)&&(t.leaf?i.push(s):uM(e,d)?this._all(s,i):o.push(s))}t=o.pop()}return i}collides(e){let t=this.data;if(!xx(e,t))return!1;const i=[];for(;t;){for(let r=0;r<t.children.length;r++){const o=t.children[r],c=t.leaf?this.toBBox(o):o;if(xx(e,c)){if(t.leaf||uM(e,c))return!0;i.push(o)}}t=i.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let i=0;i<e.length;i++)this.insert(e[i]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const i=this.data;this.data=t,t=i}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=mg([]),this}remove(e,t){if(!e)return this;let i=this.data;const r=this.toBBox(e),o=[],c=[];let s,d,p;for(;i||o.length;){if(i||(i=o.pop(),d=o[o.length-1],s=c.pop(),p=!0),i.leaf){const g=pee(e,i.children,t);if(g!==-1)return i.children.splice(g,1),o.push(i),this._condense(o),this}!p&&!i.leaf&&uM(i,r)?(o.push(i),c.push(s),s=0,d=i,i=i.children[0]):d?(s++,i=d.children[s],p=!1):i=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const i=[];for(;e;)e.leaf?t.push(...e.children):i.push(...e.children),e=i.pop();return t}_build(e,t,i,r){const o=i-t+1;let c=this._maxEntries,s;if(o<=c)return s=mg(e.slice(t,i+1)),og(s,this.toBBox),s;r||(r=Math.ceil(Math.log(o)/Math.log(c)),c=Math.ceil(o/Math.pow(c,r-1))),s=mg([]),s.leaf=!1,s.height=r;const d=Math.ceil(o/c),p=d*Math.ceil(Math.sqrt(c));s3(e,t,i,p,this.compareMinX);for(let g=t;g<=i;g+=p){const _=Math.min(g+p-1,i);s3(e,g,_,d,this.compareMinY);for(let x=g;x<=_;x+=d){const b=Math.min(x+d-1,_);s.children.push(this._build(e,x,b,r-1))}}return og(s,this.toBBox),s}_chooseSubtree(e,t,i,r){for(;r.push(t),!(t.leaf||r.length-1===i);){let o=1/0,c=1/0,s;for(let d=0;d<t.children.length;d++){const p=t.children[d],g=cM(p),_=_ee(e,p)-g;_<c?(c=_,o=g<o?g:o,s=p):_===c&&g<o&&(o=g,s=p)}t=s||t.children[0]}return t}_insert(e,t,i){const r=i?e:this.toBBox(e),o=[],c=this._chooseSubtree(r,this.data,t,o);for(c.children.push(e),Qv(c,r);t>=0&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(r,o,t)}_split(e,t){const i=e[t],r=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,r);const c=this._chooseSplitIndex(i,o,r),s=mg(i.children.splice(c,i.children.length-c));s.height=i.height,s.leaf=i.leaf,og(i,this.toBBox),og(s,this.toBBox),t?e[t-1].children.push(s):this._splitRoot(i,s)}_splitRoot(e,t){this.data=mg([e,t]),this.data.height=e.height+1,this.data.leaf=!1,og(this.data,this.toBBox)}_chooseSplitIndex(e,t,i){let r,o=1/0,c=1/0;for(let s=t;s<=i-t;s++){const d=Jv(e,0,s,this.toBBox),p=Jv(e,s,i,this.toBBox),g=vee(d,p),_=cM(d)+cM(p);g<o?(o=g,r=s,c=_<c?_:c):g===o&&_<c&&(c=_,r=s)}return r||i-t}_chooseSplitAxis(e,t,i){const r=e.leaf?this.compareMinX:mee,o=e.leaf?this.compareMinY:gee,c=this._allDistMargin(e,t,i,r),s=this._allDistMargin(e,t,i,o);c<s&&e.children.sort(r)}_allDistMargin(e,t,i,r){e.children.sort(r);const o=this.toBBox,c=Jv(e,0,t,o),s=Jv(e,i-t,i,o);let d=bx(c)+bx(s);for(let p=t;p<i-t;p++){const g=e.children[p];Qv(c,e.leaf?o(g):g),d+=bx(c)}for(let p=i-t-1;p>=t;p--){const g=e.children[p];Qv(s,e.leaf?o(g):g),d+=bx(s)}return d}_adjustParentBBoxes(e,t,i){for(let r=i;r>=0;r--)Qv(t[r],e)}_condense(e){for(let t=e.length-1,i;t>=0;t--)e[t].children.length===0?t>0?(i=e[t-1].children,i.splice(i.indexOf(e[t]),1)):this.clear():og(e[t],this.toBBox)}}function pee(n,e,t){if(!t)return e.indexOf(n);for(let i=0;i<e.length;i++)if(t(n,e[i]))return i;return-1}function og(n,e){Jv(n,0,n.children.length,e,n)}function Jv(n,e,t,i,r){r||(r=mg(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let o=e;o<t;o++){const c=n.children[o];Qv(r,n.leaf?i(c):c)}return r}function Qv(n,e){return n.minX=Math.min(n.minX,e.minX),n.minY=Math.min(n.minY,e.minY),n.maxX=Math.max(n.maxX,e.maxX),n.maxY=Math.max(n.maxY,e.maxY),n}function mee(n,e){return n.minX-e.minX}function gee(n,e){return n.minY-e.minY}function cM(n){return(n.maxX-n.minX)*(n.maxY-n.minY)}function bx(n){return n.maxX-n.minX+(n.maxY-n.minY)}function _ee(n,e){return(Math.max(e.maxX,n.maxX)-Math.min(e.minX,n.minX))*(Math.max(e.maxY,n.maxY)-Math.min(e.minY,n.minY))}function vee(n,e){const t=Math.max(n.minX,e.minX),i=Math.max(n.minY,e.minY),r=Math.min(n.maxX,e.maxX),o=Math.min(n.maxY,e.maxY);return Math.max(0,r-t)*Math.max(0,o-i)}function uM(n,e){return n.minX<=e.minX&&n.minY<=e.minY&&e.maxX<=n.maxX&&e.maxY<=n.maxY}function xx(n,e){return e.minX<=n.maxX&&e.minY<=n.maxY&&e.maxX>=n.minX&&e.maxY>=n.minY}function mg(n){return{children:n,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function s3(n,e,t,i,r){const o=[e,t];for(;o.length;){if(t=o.pop(),e=o.pop(),t-e<=i)continue;const c=e+Math.ceil((t-e)/i/2)*i;hee(n,c,e,t,r),o.push(e,c,c,t)}}class Kz extends fee{compareMinX(e,t){return e.lng-t.lng}compareMinY(e,t){return e.lat-t.lat}toBBox(e){return{minX:e.lng,minY:e.lat,maxX:e.lng,maxY:e.lat}}}class Cr{constructor(e,t){this._components={};for(const i in Cr.registeredComponents){if(!Cr.registeredComponents.hasOwnProperty(i))continue;const r=Cr.registeredComponents[i];this._components[i]={active:!1,component:new r(i,e,t)}}this._coverComponent=new Cr.registeredCoverComponent("cover",e,t),this._coverComponent.activate(),this._coverActivated=!0}static register(e){Cr.registeredComponents[e.componentName]===void 0&&(Cr.registeredComponents[e.componentName]=e)}static registerCover(e){Cr.registeredCoverComponent=e}get coverActivated(){return this._coverActivated}activateCover(){if(!this._coverActivated){this._coverActivated=!0;for(const e in this._components){if(!this._components.hasOwnProperty(e))continue;const t=this._components[e];t.active&&t.component.deactivate()}}}deactivateCover(){if(this._coverActivated){this._coverActivated=!1;for(const e in this._components){if(!this._components.hasOwnProperty(e))continue;const t=this._components[e];t.active&&t.component.activate()}}}activate(e){this._checkName(e),this._components[e].active=!0,this._coverActivated||this.get(e).activate()}configure(e,t){this._checkName(e),this.get(e).configure(t)}deactivate(e){this._checkName(e),this._components[e].active=!1,this._coverActivated||this.get(e).deactivate()}get(e){return this._components[e].component}getCover(){return this._coverComponent}remove(){this._coverComponent.deactivate();for(const e in this._components)this._components.hasOwnProperty(e)&&this._components[e].component.deactivate()}_checkName(e){if(!(e in this._components))throw new _a(`Component does not exist: ${e}`)}}Cr.registeredComponents={};var Hy=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function yee(n){if(n.__esModule)return n;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach(function(t){var i=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:function(){return n[t]}})}),e}function bee(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var xee=Array.isArray,wee=Object.prototype.toString,iE=xee||See;function See(n){return wee.call(n)==="[object Array]"}var w0="2",Tee=w0;Wl.NONE=0;Wl.VTEXT=1;Wl.VNODE=2;Wl.WIDGET=3;Wl.PROPS=4;Wl.ORDER=5;Wl.INSERT=6;Wl.REMOVE=7;Wl.THUNK=8;var Jz=Wl;function Wl(n,e,t){this.type=Number(n),this.vNode=e,this.patch=t}Wl.prototype.version=Tee;Wl.prototype.type="VirtualPatch";var Mee=w0,S0=Cee;function Cee(n){return n&&n.type==="VirtualNode"&&n.version===Mee}var Eee=w0,S1=Aee;function Aee(n){return n&&n.type==="VirtualText"&&n.version===Eee}var Pp=Pee;function Pee(n){return n&&n.type==="Widget"}var T1=Iee;function Iee(n){return n&&n.type==="Thunk"}var Ree=S0,Lee=S1,kee=Pp,o3=T1,Qz=Dee;function Dee(n,e){var t=n,i=e;return o3(e)&&(i=a3(e,n)),o3(n)&&(t=a3(n,null)),{a:t,b:i}}function a3(n,e){var t=n.vnode;if(t||(t=n.vnode=n.render(e)),!(Ree(t)||Lee(t)||kee(t)))throw new Error("thunk did not return a valid node");return t}var eB=function(e){return typeof e=="object"&&e!==null},M1=Fee;function Fee(n){return n&&(typeof n.hook=="function"&&!n.hasOwnProperty("hook")||typeof n.unhook=="function"&&!n.hasOwnProperty("unhook"))}var l3=eB,Oee=M1,zee=tB;function tB(n,e){var t;for(var i in n){i in e||(t=t||{},t[i]=void 0);var r=n[i],o=e[i];if(r!==o)if(l3(r)&&l3(o))if(c3(o)!==c3(r))t=t||{},t[i]=o;else if(Oee(o))t=t||{},t[i]=o;else{var c=tB(r,o);c&&(t=t||{},t[i]=c)}else t=t||{},t[i]=o}for(var s in e)s in n||(t=t||{},t[s]=e[s]);return t}function c3(n){if(Object.getPrototypeOf)return Object.getPrototypeOf(n);if(n.__proto__)return n.__proto__;if(n.constructor)return n.constructor.prototype}var Bee=iE,es=Jz,yp=S0,u3=S1,Kx=Pp,Fw=T1,Nee=Qz,$ee=zee,Vee=iB;function iB(n,e){var t={a:n};return nB(n,e,t,0),t}function nB(n,e,t,i){if(n!==e){var r=t[i],o=!1;if(Fw(n)||Fw(e))nE(n,e,t,i);else if(e==null)Kx(n)||(h3(n,t,i),r=t[i]),r=bc(r,new es(es.REMOVE,n,e));else if(yp(e))if(yp(n))if(n.tagName===e.tagName&&n.namespace===e.namespace&&n.key===e.key){var c=$ee(n.properties,e.properties);c&&(r=bc(r,new es(es.PROPS,n,c))),r=Uee(n,e,t,r,i)}else r=bc(r,new es(es.VNODE,n,e)),o=!0;else r=bc(r,new es(es.VNODE,n,e)),o=!0;else u3(e)?u3(n)?n.text!==e.text&&(r=bc(r,new es(es.VTEXT,n,e))):(r=bc(r,new es(es.VTEXT,n,e)),o=!0):Kx(e)&&(Kx(n)||(o=!0),r=bc(r,new es(es.WIDGET,n,e)));r&&(t[i]=r),o&&h3(n,t,i)}}function Uee(n,e,t,i,r){for(var o=n.children,c=qee(o,e.children),s=c.children,d=o.length,p=s.length,g=d>p?d:p,_=0;_<g;_++){var x=o[_],b=s[_];r+=1,x?nB(x,b,t,r):b&&(i=bc(i,new es(es.INSERT,null,b))),yp(x)&&x.count&&(r+=x.count)}return c.moves&&(i=bc(i,new es(es.ORDER,n,c.moves))),i}function h3(n,e,t){sB(n,e,t),rB(n,e,t)}function rB(n,e,t){if(Kx(n))typeof n.destroy=="function"&&(e[t]=bc(e[t],new es(es.REMOVE,n,null)));else if(yp(n)&&(n.hasWidgets||n.hasThunks))for(var i=n.children,r=i.length,o=0;o<r;o++){var c=i[o];t+=1,rB(c,e,t),yp(c)&&c.count&&(t+=c.count)}else Fw(n)&&nE(n,null,e,t)}function nE(n,e,t,i){var r=Nee(n,e),o=iB(r.a,r.b);jee(o)&&(t[i]=new es(es.THUNK,null,o))}function jee(n){for(var e in n)if(e!=="a")return!0;return!1}function sB(n,e,t){if(yp(n)){if(n.hooks&&(e[t]=bc(e[t],new es(es.PROPS,n,Gee(n.hooks)))),n.descendantHooks||n.hasThunks)for(var i=n.children,r=i.length,o=0;o<r;o++){var c=i[o];t+=1,sB(c,e,t),yp(c)&&c.count&&(t+=c.count)}}else Fw(n)&&nE(n,null,e,t)}function Gee(n){var e={};for(var t in n)e[t]=void 0;return e}function qee(n,e){var t=d3(e),i=t.keys,r=t.free;if(r.length===e.length)return{children:e,moves:null};var o=d3(n),c=o.keys,s=o.free;if(s.length===n.length)return{children:e,moves:null};for(var d=[],p=0,g=r.length,_=0,x=0;x<n.length;x++){var b=n[x],S;b.key?i.hasOwnProperty(b.key)?(S=i[b.key],d.push(e[S])):(S=x-_++,d.push(null)):p<g?(S=r[p++],d.push(e[S])):(S=x-_++,d.push(null))}for(var P=p>=r.length?e.length:r[p],L=0;L<e.length;L++){var E=e[L];E.key?c.hasOwnProperty(E.key)||d.push(E):L>=P&&d.push(E)}for(var C=d.slice(),D=0,O=[],U=[],j,G=0;G<e.length;){var N=e[G];for(j=C[D];j===null&&C.length;)O.push(wx(C,D,null)),j=C[D];!j||j.key!==N.key?N.key?(j&&j.key?i[j.key]!==G+1?(O.push(wx(C,D,j.key)),j=C[D],!j||j.key!==N.key?U.push({key:N.key,to:G}):D++):U.push({key:N.key,to:G}):U.push({key:N.key,to:G}),G++):j&&j.key&&O.push(wx(C,D,j.key)):(D++,G++)}for(;D<C.length;)j=C[D],O.push(wx(C,D,j&&j.key));return O.length===_&&!U.length?{children:d,moves:null}:{children:d,moves:{removes:O,inserts:U}}}function wx(n,e,t){return n.splice(e,1),{from:e,key:t}}function d3(n){for(var e={},t=[],i=n.length,r=0;r<i;r++){var o=n[r];o.key?e[o.key]=r:t.push(r)}return{keys:e,free:t}}function bc(n,e){return n?(Bee(n)?n.push(e):n=[n,e],n):e}var Wee=Vee,Hee=Wee,f3=Array.prototype.slice,oB=Zee;function Zee(n,e){for(("length"in n)||(n=[n]),n=f3.call(n);n.length;){var t=n.shift(),i=e(t);if(i)return i;t.childNodes&&t.childNodes.length&&(n=f3.call(t.childNodes).concat(n))}}var Xee=Jg;function Jg(n,e){if(!(this instanceof Jg))return new Jg(n,e);this.data=n,this.nodeValue=n,this.length=n.length,this.ownerDocument=e||null}Jg.prototype.nodeType=8;Jg.prototype.nodeName="#comment";Jg.prototype.toString=function(){return"[object Comment]"};var Yee=Gd;function Gd(n,e){if(!(this instanceof Gd))return new Gd(n);this.data=n||"",this.length=this.data.length,this.ownerDocument=e||null}Gd.prototype.type="DOMTextNode";Gd.prototype.nodeType=3;Gd.prototype.nodeName="#text";Gd.prototype.toString=function(){return this.data};Gd.prototype.replaceData=function(e,t,i){var r=this.data,o=r.substring(0,e),c=r.substring(e+t,r.length);this.data=o+i+c,this.length=this.data.length};var aB=Kee;function Kee(n){var e=this,t=n.type;n.target||(n.target=e),e.listeners||(e.listeners={});var i=e.listeners[t];if(i)return i.forEach(function(r){n.currentTarget=e,typeof r=="function"?r(n):r.handleEvent(n)});e.parentNode&&e.parentNode.dispatchEvent(n)}var lB=Jee;function Jee(n,e){var t=this;t.listeners||(t.listeners={}),t.listeners[n]||(t.listeners[n]=[]),t.listeners[n].indexOf(e)===-1&&t.listeners[n].push(e)}var cB=Qee;function Qee(n,e){var t=this;if(t.listeners&&t.listeners[n]){var i=t.listeners[n],r=i.indexOf(e);r!==-1&&i.splice(r,1)}}var ete=uB,tte=["area","base","br","col","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"];function uB(n){switch(n.nodeType){case 3:return rE(n.data);case 8:return"<!--"+n.data+"-->";default:return ite(n)}}function ite(n){var e=[],t=n.tagName;return n.namespaceURI==="http://www.w3.org/1999/xhtml"&&(t=t.toLowerCase()),e.push("<"+t+ote(n)+ste(n)),tte.indexOf(t)>-1?e.push(" />"):(e.push(">"),n.childNodes.length?e.push.apply(e,n.childNodes.map(uB)):n.textContent||n.innerText?e.push(rE(n.textContent||n.innerText)):n.innerHTML&&e.push(n.innerHTML),e.push("</"+t+">")),e.join("")}function nte(n,e){var t=typeof n[e];return e==="style"&&Object.keys(n.style).length>0?!0:n.hasOwnProperty(e)&&(t==="string"||t==="boolean"||t==="number")&&e!=="nodeName"&&e!=="className"&&e!=="tagName"&&e!=="textContent"&&e!=="innerText"&&e!=="namespaceURI"&&e!=="innerHTML"}function rte(n){if(typeof n=="string")return n;var e="";return Object.keys(n).forEach(function(t){var i=n[t];t=t.replace(/[A-Z]/g,function(r){return"-"+r.toLowerCase()}),e+=t+":"+i+";"}),e}function ste(n){var e=n.dataset,t=[];for(var i in e)t.push({name:"data-"+i,value:e[i]});return t.length?hB(t):""}function hB(n){var e=[];return n.forEach(function(t){var i=t.name,r=t.value;i==="style"&&(r=rte(r)),e.push(i+'="'+ate(r)+'"')}),e.length?" "+e.join(" "):""}function ote(n){var e=[];for(var t in n)nte(n,t)&&e.push({name:t,value:n[t]});for(var i in n._attributes)for(var r in n._attributes[i]){var o=n._attributes[i][r],c=(o.prefix?o.prefix+":":"")+r;e.push({name:c,value:o.value})}return n.className&&e.push({name:"class",value:n.className}),e.length?hB(e):""}function rE(n){var e="";return typeof n=="string"?e=n:n&&(e=n.toString()),e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function ate(n){return rE(n).replace(/"/g,"&quot;")}var sE=oB,lte=aB,cte=lB,ute=cB,hte=ete,p3="http://www.w3.org/1999/xhtml",dB=Gr;function Gr(n,e,t){if(!(this instanceof Gr))return new Gr(n);var i=t===void 0?p3:t||null;this.tagName=i===p3?String(n).toUpperCase():n,this.nodeName=this.tagName,this.className="",this.dataset={},this.childNodes=[],this.parentNode=null,this.style={},this.ownerDocument=e||null,this.namespaceURI=i,this._attributes={},this.tagName==="INPUT"&&(this.type="text")}Gr.prototype.type="DOMElement";Gr.prototype.nodeType=1;Gr.prototype.appendChild=function(e){return e.parentNode&&e.parentNode.removeChild(e),this.childNodes.push(e),e.parentNode=this,e};Gr.prototype.replaceChild=function(e,t){e.parentNode&&e.parentNode.removeChild(e);var i=this.childNodes.indexOf(t);return t.parentNode=null,this.childNodes[i]=e,e.parentNode=this,t};Gr.prototype.removeChild=function(e){var t=this.childNodes.indexOf(e);return this.childNodes.splice(t,1),e.parentNode=null,e};Gr.prototype.insertBefore=function(e,t){e.parentNode&&e.parentNode.removeChild(e);var i=t==null?-1:this.childNodes.indexOf(t);return i>-1?this.childNodes.splice(i,0,e):this.childNodes.push(e),e.parentNode=this,e};Gr.prototype.setAttributeNS=function(e,t,i){var r=null,o=t,c=t.indexOf(":");if(c>-1&&(r=t.substr(0,c),o=t.substr(c+1)),this.tagName==="INPUT"&&t==="type")this.type=i;else{var s=this._attributes[e]||(this._attributes[e]={});s[o]={value:i,prefix:r}}};Gr.prototype.getAttributeNS=function(e,t){var i=this._attributes[e],r=i&&i[t]&&i[t].value;return this.tagName==="INPUT"&&t==="type"?this.type:typeof r!="string"?null:r};Gr.prototype.removeAttributeNS=function(e,t){var i=this._attributes[e];i&&delete i[t]};Gr.prototype.hasAttributeNS=function(e,t){var i=this._attributes[e];return!!i&&t in i};Gr.prototype.setAttribute=function(e,t){return this.setAttributeNS(null,e,t)};Gr.prototype.getAttribute=function(e){return this.getAttributeNS(null,e)};Gr.prototype.removeAttribute=function(e){return this.removeAttributeNS(null,e)};Gr.prototype.hasAttribute=function(e){return this.hasAttributeNS(null,e)};Gr.prototype.removeEventListener=ute;Gr.prototype.addEventListener=cte;Gr.prototype.dispatchEvent=lte;Gr.prototype.focus=function(){};Gr.prototype.toString=function(){return hte(this)};Gr.prototype.getElementsByClassName=function(e){var t=e.split(" "),i=[];return sE(this,function(r){if(r.nodeType===1){var o=r.className||"",c=o.split(" ");t.every(function(s){return c.indexOf(s)!==-1})&&i.push(r)}}),i};Gr.prototype.getElementsByTagName=function(e){e=e.toLowerCase();var t=[];return sE(this.childNodes,function(i){i.nodeType===1&&(e==="*"||i.tagName.toLowerCase()===e)&&t.push(i)}),t};Gr.prototype.contains=function(e){return sE(this,function(t){return e===t})||!1};var oE=dB,dte=bu;function bu(n){if(!(this instanceof bu))return new bu;this.childNodes=[],this.parentNode=null,this.ownerDocument=n||null}bu.prototype.type="DocumentFragment";bu.prototype.nodeType=11;bu.prototype.nodeName="#document-fragment";bu.prototype.appendChild=oE.prototype.appendChild;bu.prototype.replaceChild=oE.prototype.replaceChild;bu.prototype.removeChild=oE.prototype.removeChild;bu.prototype.toString=function(){return this.childNodes.map(function(e){return String(e)}).join("")};var fte=aE;function aE(n){}aE.prototype.initEvent=function(e,t,i){this.type=e,this.bubbles=t,this.cancelable=i};aE.prototype.preventDefault=function(){};var pte=oB,mte=Xee,gte=Yee,T0=dB,_te=dte,vte=fte,yte=aB,bte=lB,xte=cB,wte=Ow;function Ow(){if(!(this instanceof Ow))return new Ow;this.head=this.createElement("head"),this.body=this.createElement("body"),this.documentElement=this.createElement("html"),this.documentElement.appendChild(this.head),this.documentElement.appendChild(this.body),this.childNodes=[this.documentElement],this.nodeType=9}var fl=Ow.prototype;fl.createTextNode=function(e){return new gte(e,this)};fl.createElementNS=function(e,t){var i=e===null?null:String(e);return new T0(t,this,i)};fl.createElement=function(e){return new T0(e,this)};fl.createDocumentFragment=function(){return new _te(this)};fl.createEvent=function(e){return new vte};fl.createComment=function(e){return new mte(e,this)};fl.getElementById=function(e){e=String(e);var t=pte(this.childNodes,function(i){if(String(i.id)===e)return i});return t||null};fl.getElementsByClassName=T0.prototype.getElementsByClassName;fl.getElementsByTagName=T0.prototype.getElementsByTagName;fl.contains=T0.prototype.contains;fl.removeEventListener=xte;fl.addEventListener=bte;fl.dispatchEvent=yte;var Ste=wte,Tte=new Ste,m3=typeof Hy<"u"?Hy:typeof window<"u"?window:{},Mte=Tte,ey;typeof document<"u"?ey=document:(ey=m3["__GLOBAL_DOCUMENT_CACHE@4"],ey||(ey=m3["__GLOBAL_DOCUMENT_CACHE@4"]=Mte));var fB=ey,y2=eB,pB=M1,mB=Cte;function Cte(n,e,t){for(var i in e){var r=e[i];r===void 0?g3(n,i,r,t):pB(r)?(g3(n,i,r,t),r.hook&&r.hook(n,i,t?t[i]:void 0)):y2(r)?Ete(n,e,t,i,r):n[i]=r}}function g3(n,e,t,i){if(i){var r=i[e];if(pB(r))r.unhook&&r.unhook(n,e,t);else if(e==="attributes")for(var o in r)n.removeAttribute(o);else if(e==="style")for(var c in r)n.style[c]="";else typeof r=="string"?n[e]="":n[e]=null}}function Ete(n,e,t,i,r){var o=t?t[i]:void 0;if(i==="attributes"){for(var c in r){var s=r[c];s===void 0?n.removeAttribute(c):n.setAttribute(c,s)}return}if(o&&y2(o)&&_3(o)!==_3(r)){n[i]=r;return}y2(n[i])||(n[i]={});var d=i==="style"?"":void 0;for(var p in r){var g=r[p];n[i][p]=g===void 0?d:g}}function _3(n){if(Object.getPrototypeOf)return Object.getPrototypeOf(n);if(n.__proto__)return n.__proto__;if(n.constructor)return n.constructor.prototype}var v3=fB,Ate=mB,Pte=S0,Ite=S1,Rte=Pp,Lte=Qz,gB=_B;function _B(n,e){var t=e&&e.document||v3,i=e?e.warn:null;if(n=Lte(n).a,Rte(n))return n.init();if(Ite(n))return t.createTextNode(n.text);if(!Pte(n))return i&&i("Item is not a valid virtual dom node",n),null;var r=n.namespace===null?t.createElement(n.tagName):t.createElementNS(n.namespace,n.tagName),o=n.properties;Ate(r,o);for(var c=n.children,s=0;s<c.length;s++){var d=_B(c[s],e);d&&r.appendChild(d)}return r}var kte={},Dte=Fte;function Fte(n,e,t,i){return!t||t.length===0?{}:(t.sort(Ote),vB(n,e,t,i,0))}function vB(n,e,t,i,r){if(i=i||{},n){y3(t,r,r)&&(i[r]=n);var o=e.children;if(o)for(var c=n.childNodes,s=0;s<e.children.length;s++){r+=1;var d=o[s]||kte,p=r+(d.count||0);y3(t,r,p)&&vB(c[s],d,t,i,r),r=p}}return i}function y3(n,e,t){if(n.length===0)return!1;for(var i=0,r=n.length-1,o,c;i<=r;){if(o=(r+i)/2>>0,c=n[o],i===r)return c>=e&&c<=t;if(c<e)i=o+1;else if(c>t)r=o-1;else return!0}return!1}function Ote(n,e){return n>e?1:-1}var b3=Pp,zte=Bte;function Bte(n,e){return b3(n)&&b3(e)?"name"in n&&"name"in e?n.id===e.id:n.init===e.init:!1}var Nte=mB,$te=Pp,yd=Jz,Vte=zte,Ute=jte;function jte(n,e,t){var i=n.type,r=n.vNode,o=n.patch;switch(i){case yd.REMOVE:return Gte(e,r);case yd.INSERT:return qte(e,o,t);case yd.VTEXT:return Wte(e,r,o,t);case yd.WIDGET:return Hte(e,r,o,t);case yd.VNODE:return Zte(e,r,o,t);case yd.ORDER:return Xte(e,o),e;case yd.PROPS:return Nte(e,o,r.properties),e;case yd.THUNK:return Yte(e,t.patch(e,o,t));default:return e}}function Gte(n,e){var t=n.parentNode;return t&&t.removeChild(n),yB(n,e),null}function qte(n,e,t){var i=t.render(e,t);return n&&n.appendChild(i),n}function Wte(n,e,t,i){var r;if(n.nodeType===3)n.replaceData(0,n.length,t.text),r=n;else{var o=n.parentNode;r=i.render(t,i),o&&r!==n&&o.replaceChild(r,n)}return r}function Hte(n,e,t,i){var r=Vte(e,t),o;r?o=t.update(e,n)||n:o=i.render(t,i);var c=n.parentNode;return c&&o!==n&&c.replaceChild(o,n),r||yB(n,e),o}function Zte(n,e,t,i){var r=n.parentNode,o=i.render(t,i);return r&&o!==n&&r.replaceChild(o,n),o}function yB(n,e){typeof e.destroy=="function"&&$te(e)&&e.destroy(n)}function Xte(n,e){for(var t=n.childNodes,i={},r,o,c,s=0;s<e.removes.length;s++)o=e.removes[s],r=t[o.from],o.key&&(i[o.key]=r),n.removeChild(r);for(var d=t.length,p=0;p<e.inserts.length;p++)c=e.inserts[p],r=i[c.key],n.insertBefore(r,c.to>=d++?null:t[c.to])}function Yte(n,e){return n&&e&&n!==e&&n.parentNode&&n.parentNode.replaceChild(e,n),e}var Kte=fB,Jte=iE,Qte=gB,eie=Dte,x3=Ute,tie=bB;function bB(n,e,t){return t=t||{},t.patch=t.patch&&t.patch!==bB?t.patch:iie,t.render=t.render||Qte,t.patch(n,e,t)}function iie(n,e,t){var i=rie(e);if(i.length===0)return n;var r=eie(n,e.a,i),o=n.ownerDocument;!t.document&&o!==Kte&&(t.document=o);for(var c=0;c<i.length;c++){var s=i[c];n=nie(n,r[s],e[s],t)}return n}function nie(n,e,t,i){if(!e)return n;var r;if(Jte(t))for(var o=0;o<t.length;o++)r=x3(t[o],e,i),e===n&&(n=r);else r=x3(t,e,i),e===n&&(n=r);return n}function rie(n){var e=[];for(var t in n)t!=="a"&&e.push(Number(t));return e}var sie=tie,oie=sie,aie=w0,lie=S0,cie=Pp,uie=T1,hie=M1,xB=lE,die={},fie=[];function lE(n,e,t,i,r){this.tagName=n,this.properties=e||die,this.children=t||fie,this.key=i!=null?String(i):void 0,this.namespace=typeof r=="string"?r:null;var o=t&&t.length||0,c=0,s=!1,d=!1,p=!1,g;for(var _ in e)if(e.hasOwnProperty(_)){var x=e[_];hie(x)&&x.unhook&&(g||(g={}),g[_]=x)}for(var b=0;b<o;b++){var S=t[b];lie(S)?(c+=S.count||0,!s&&S.hasWidgets&&(s=!0),!d&&S.hasThunks&&(d=!0),!p&&(S.hooks||S.descendantHooks)&&(p=!0)):!s&&cie(S)?typeof S.destroy=="function"&&(s=!0):!d&&uie(S)&&(d=!0)}this.count=o+c,this.hasWidgets=s,this.hasThunks=d,this.hooks=g,this.descendantHooks=p}lE.prototype.version=aie;lE.prototype.type="VirtualNode";var pie=w0,wB=cE;function cE(n){this.text=String(n)}cE.prototype.version=pie;cE.prototype.type="VirtualText";var mie=(function(e){var t=String.prototype.split,i=/()??/.exec("")[1]===e,r;return r=function(o,_,s){if(Object.prototype.toString.call(_)!=="[object RegExp]")return t.call(o,_,s);var d=[],p=(_.ignoreCase?"i":"")+(_.multiline?"m":"")+(_.extended?"x":"")+(_.sticky?"y":""),g=0,_=new RegExp(_.source,p+"g"),x,b,S,P;for(o+="",i||(x=new RegExp("^"+_.source+"$(?!\\s)",p)),s=s===e?-1>>>0:s>>>0;(b=_.exec(o))&&(S=b.index+b[0].length,!(S>g&&(d.push(o.slice(g,b.index)),!i&&b.length>1&&b[0].replace(x,function(){for(var L=1;L<arguments.length-2;L++)arguments[L]===e&&(b[L]=e)}),b.length>1&&b.index<o.length&&Array.prototype.push.apply(d,b.slice(1)),P=b[0].length,g=S,d.length>=s)));)_.lastIndex===b.index&&_.lastIndex++;return g===o.length?(P||!_.test(""))&&d.push(""):d.push(o.slice(g)),d.length>s?d.slice(0,s):d},r})(),gie=mie,_ie=/([\.#]?[a-zA-Z0-9\u007F-\uFFFF_:-]+)/,vie=/^\.|#/,yie=bie;function bie(n,e){if(!n)return"DIV";var t=!e.hasOwnProperty("id"),i=gie(n,_ie),r=null;vie.test(i[1])&&(r="DIV");var o,c,s,d;for(d=0;d<i.length;d++)c=i[d],c&&(s=c.charAt(0),r?s==="."?(o=o||[],o.push(c.substring(1,c.length))):s==="#"&&t&&(e.id=c.substring(1,c.length)):r=c);return o&&(e.className&&o.push(e.className),e.className=o.join(" ")),e.namespace?r:r.toUpperCase()}var xie=zw;function zw(n){if(!(this instanceof zw))return new zw(n);this.value=n}zw.prototype.hook=function(n,e){n[e]!==this.value&&(n[e]=this.value)};var hM=typeof window<"u"?window:typeof Hy<"u"?Hy:{},wie=Sie;function Sie(n,e){return n in hM?hM[n]:(hM[n]=e,e)}var w3=wie,Tie=Mie;function Mie(n,e,t){var i="__INDIVIDUAL_ONE_VERSION_"+n,r=i+"_ENFORCE_SINGLETON",o=w3(r,e);if(o!==e)throw new Error("Can only have one copy of "+n+`.
You already have version `+o+` installed.
This means you cannot install version `+e);return w3(i,t)}var Cie=Tie,SB="7";Cie("ev-store",SB);var S3="__EV_STORE_KEY@"+SB,Eie=Aie;function Aie(n){var e=n[S3];return e||(e=n[S3]={}),e}var TB=Eie,Pie=Zy;function Zy(n){if(!(this instanceof Zy))return new Zy(n);this.value=n}Zy.prototype.hook=function(n,e){var t=TB(n),i=e.substr(3);t[i]=this.value};Zy.prototype.unhook=function(n,e){var t=TB(n),i=e.substr(3);t[i]=void 0};var MB=iE,Iie=xB,T3=wB,Rie=S0,Lie=S1,kie=Pp,CB=M1,Die=T1,Fie=yie,Oie=xie,zie=Pie,Bie=Nie;function Nie(n,e,t){var i=[],r,o,c,s;return!t&&Vie(e)&&(t=e,o={}),o=o||e||{},r=Fie(n,o),o.hasOwnProperty("key")&&(c=o.key,o.key=void 0),o.hasOwnProperty("namespace")&&(s=o.namespace,o.namespace=void 0),r==="INPUT"&&!s&&o.hasOwnProperty("value")&&o.value!==void 0&&!CB(o.value)&&(o.value=Oie(o.value)),$ie(o),t!=null&&EB(t,i,r,o),new Iie(r,o,i,c,s)}function EB(n,e,t,i){if(typeof n=="string")e.push(new T3(n));else if(typeof n=="number")e.push(new T3(String(n)));else if(AB(n))e.push(n);else if(MB(n))for(var r=0;r<n.length;r++)EB(n[r],e,t,i);else{if(n==null)return;throw Uie({foreignObject:n,parentVnode:{tagName:t,properties:i}})}}function $ie(n){for(var e in n)if(n.hasOwnProperty(e)){var t=n[e];if(CB(t))continue;e.substr(0,3)==="ev-"&&(n[e]=zie(t))}}function AB(n){return Rie(n)||Lie(n)||kie(n)||Die(n)}function Vie(n){return typeof n=="string"||MB(n)||AB(n)}function Uie(n){var e=new Error;return e.type="virtual-hyperscript.unexpected.virtual-element",e.message=`Unexpected virtual child passed to h().
Expected a VNode / Vthunk / VWidget / string but:
got:
`+M3(n.foreignObject)+`.
The parent vnode is:
`+M3(n.parentVnode),e.foreignObject=n.foreignObject,e.parentVnode=n.parentVnode,e}function M3(n){try{return JSON.stringify(n,null,"    ")}catch{return String(n)}}var jie=Bie,Gie=jie,qie=gB,Wie=qie,Hie=Hee,Zie=oie,Xie=Gie,Yie=Wie,Kie=xB,Jie=wB,qt={diff:Hie,patch:Zie,h:Xie,create:Yie,VNode:Kie,VText:Jie};class C1{constructor(){this._events={}}fire(e,t){if(this._listens(e))for(const i of this._events[e])i(t)}off(e,t){if(!e){this._events={};return}if(this._listens(e)){const i=this._events[e].indexOf(t);i>=0&&this._events[e].splice(i,1),this._events[e].length||delete this._events[e]}}on(e,t){this._events[e]=this._events[e]||[],this._events[e].push(t)}_listens(e){return e in this._events}}class wo{constructor(){this._subscriptions=[]}push(e){this._subscriptions.push(e)}unsubscribe(){for(const e of this._subscriptions)e.unsubscribe();this._subscriptions=[]}}class So extends C1{constructor(e,t,i){super(),this._activated$=new Ph(!1),this._configurationSubject$=new ri,this._activated=!1,this._container=t,this._name=e,this._navigator=i,this._subscriptions=new wo,this._configuration$=this._configurationSubject$.pipe(An(this.defaultConfiguration),Vr((r,o)=>{for(let c in o)o.hasOwnProperty(c)&&(r[c]=o[c]);return r}),Ii(1),_i()),this._configuration$.subscribe(()=>{})}get activated(){return this._activated}get activated$(){return this._activated$}get defaultConfiguration(){return this._getDefaultConfiguration()}get configuration$(){return this._configuration$}get name(){return this._name}activate(e){this._activated||(e!==void 0&&this._configurationSubject$.next(e),this._activated=!0,this._activate(),this._activated$.next(!0))}configure(e){this._configurationSubject$.next(e)}deactivate(){this._activated&&(this._activated=!1,this._deactivate(),this._container.domRenderer.clear(this._name),this._container.glRenderer.clear(this._name),this._activated$.next(!1))}fire(e,t){super.fire(e,t)}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}resize(){}}var ia;(function(n){n[n.Hidden=0]="Hidden",n[n.Loading=1]="Loading",n[n.Visible=2]="Visible"})(ia||(ia={}));class PB extends So{constructor(e,t,i){super(e,t,i)}_activate(){const e=this.configuration$.pipe(wi(i=>!!i.id),ai(i=>!i.src),ei(i=>this._getImageSrc$(i.id).pipe(Un(r=>(console.error(r),Ni())))),Ii(1),_i()),t=this._subscriptions;t.push(e.pipe(st(i=>({src:i}))).subscribe(i=>{this._configurationSubject$.next(i)})),t.push(Si(this.configuration$,e).pipe(ai(([i,r])=>!!i.src&&i.src!==r),wi()).subscribe(([,i])=>{window.URL.revokeObjectURL(i)})),t.push(this._configuration$.pipe(yi(void 0,i=>i.state),ei(i=>Si(Pi(i.state),this._navigator.stateService.currentImage$)),ei(([i,r])=>{const o=Si(Pi(r.id),r.image$.pipe(ai(c=>!!c),st(c=>c.src)));return i===ia.Visible?o.pipe(wi()):o}),yi(([i,r],[o,c])=>i===o&&r===c),st(([i,r])=>({id:i,src:r}))).subscribe(this._configurationSubject$)),t.push(Si(this._configuration$,this._container.configurationService.exploreUrl$,this._container.renderService.size$).pipe(st(([i,r,o])=>{if(!i.src)return{name:this._name,vNode:qt.h("div",[])};const c=o.width<=640||o.height<=480?".mapillary-cover-compact":"";if(i.state===ia.Hidden){const d=qt.h("div.mapillary-cover-container.mapillary-cover-done"+c,[this._getCoverBackgroundVNode(i)]);return{name:this._name,vNode:d}}const s=qt.h("div.mapillary-cover-container"+c,[this._getCoverButtonVNode(i,r)]);return{name:this._name,vNode:s}})).subscribe(this._container.domRenderer.render$))}_deactivate(){this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{state:ia.Visible}}_getCoverButtonVNode(e,t){const i=e.state===ia.Loading?"div.mapillary-cover.mapillary-cover-loading":"div.mapillary-cover",r=qt.h("div.mapillary-cover-button",[qt.h("div.mapillary-cover-button-icon",[])]),o=qt.h("a.mapillary-cover-logo",{href:t,target:"_blank"},[]),c=qt.h("div.mapillary-cover-indicator",{onclick:()=>{this.configure({state:ia.Loading})}},[]);return qt.h(i,[this._getCoverBackgroundVNode(e),c,r,o])}_getCoverBackgroundVNode(e){const t={style:{backgroundImage:`url(${e.src})`}},i=[];return e.state===ia.Loading&&i.push(qt.h("div.mapillary-cover-spinner",{},[])),qt.h("div.mapillary-cover-background",t,i)}_getImageSrc$(e){return _r.create(t=>{this._navigator.api.getImages$([e]).subscribe(i=>{for(const r of i){const o=typeof e=="number"?e.toString():e;if(r.node_id===o){this._navigator.api.data.getImageBuffer(r.node.thumb.url).then(c=>{const s=new Image;s.crossOrigin="Anonymous",s.onload=()=>{t.next(s.src),t.complete()},s.onerror=()=>{t.error(new Error(`Failed to load cover image (${e})`))};const d=new Blob([c]);s.src=window.URL.createObjectURL(d)},c=>{t.error(c)});return}}t.error(new ur(`Non existent cover key: ${e}`))},i=>{t.error(i)})})}}PB.componentName="cover";class IB extends So{_activate(){this._subscriptions.push(Si(this._container.configurationService.exploreUrl$,this._navigator.stateService.currentImage$,this._container.renderService.size$).pipe(st(([e,t,i])=>{const r=this._makeAttribution(t.creatorUsername,e,t.id,t.capturedAt,i.width);return{name:this._name,vNode:r}})).subscribe(this._container.domRenderer.render$))}_deactivate(){this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{}}makeImageUrl(e,t){return`${e}/app/?pKey=${t}&focus=photo`}_makeAttribution(e,t,i,r,o){const c=o<=640,s=this._makeDate(r,c),d=this._makeBy(e,t,i,c),p=c?".mapillary-attribution-compact":"";return qt.h("div.mapillary-attribution-container"+p,{},[...d,s])}_makeBy(e,t,i,r){const o=qt.h("div.mapillary-attribution-logo",[]);return e?this._makeCreatorBy(o,e,t,i,r):this._makeGeneralBy(o,t,i,r)}_makeCreatorBy(e,t,i,r,o){const c=qt.h("a.mapillary-attribution-icon-container",{href:i,rel:"noreferrer",target:"_blank"},[e]),s=o?`${t}`:`image by ${t}`,d=qt.h("div.mapillary-attribution-username",{textContent:s},[]),p=qt.h("a.mapillary-attribution-image-container",{href:this.makeImageUrl(i,r),rel:"noreferrer",target:"_blank"},[d]);return[c,p]}_makeGeneralBy(e,t,i,r){const o=qt.h("div.mapillary-attribution-username",{textContent:"images by"},[]),c=qt.h("div.mapillary-attribution-icon-container",{},[e]),s=qt.h("div.mapillary-attribution-username",{textContent:"contributors"},[]),d=[c,s];return r||d.unshift(o),[qt.h("a.mapillary-attribution-image-container",{href:this.makeImageUrl(t,i),rel:"noreferrer",target:"_blank"},d)]}_makeDate(e,t){const i=new Date(e).toDateString().split(" "),r=(i.length>3?t?[i[3]]:[i[1],i[2]+",",i[3]]:i).join(" ");return qt.h("div.mapillary-attribution-date",{textContent:r},[])}}IB.componentName="attribution";class $o{constructor(){this._unprojectDepth=200}basicToCanvas(e,t,i,r,o){const c=r.unprojectBasic([e,t],this._unprojectDepth);return this.projectToCanvas(c,i,o)}basicToCanvasSafe(e,t,i,r,o){const c=this.basicToViewportSafe(e,t,r,o);return c===null?null:this.viewportToCanvas(c[0],c[1],i)}basicToViewport(e,t,i,r){const o=i.unprojectBasic([e,t],this._unprojectDepth);return this.projectToViewport(o,r)}basicToViewportSafe(e,t,i,r){const o=i.unprojectBasic([e,t],this._unprojectDepth);return this.worldToCamera(o,r)[2]>0?null:this.projectToViewport(o,r)}cameraToViewport(e,t){const i=new Ge().fromArray(e).applyMatrix4(t.projectionMatrix);return[i.x,i.y]}canvasPosition(e,t){const i=t.getBoundingClientRect(),r=e.clientX-i.left-t.clientLeft,o=e.clientY-i.top-t.clientTop;return[r,o]}canvasToBasic(e,t,i,r,o){const c=this.unprojectFromCanvas(e,t,i,o).toArray();return r.projectBasic(c)}canvasToViewport(e,t,i){const[r,o]=this.containerToCanvas(i),c=2*e/r-1,s=1-2*t/o;return[c,s]}containerToCanvas(e){return[e.offsetWidth,e.offsetHeight]}getBasicDistances(e,t){const i=this.viewportToBasic(-1,1,e,t),r=this.viewportToBasic(1,1,e,t),o=this.viewportToBasic(1,-1,e,t),c=this.viewportToBasic(-1,-1,e,t);let s=0,d=0,p=0,g=0;return i[1]<0&&r[1]<0&&(s=i[1]>r[1]?-i[1]:-r[1]),r[0]>1&&o[0]>1&&(d=r[0]<o[0]?r[0]-1:o[0]-1),o[1]>1&&c[1]>1&&(p=o[1]<c[1]?o[1]-1:c[1]-1),c[0]<0&&i[0]<0&&(g=c[0]>i[0]?-c[0]:-i[0]),[s,d,p,g]}getPixelDistances(e,t,i){const r=this.viewportToBasic(-1,1,t,i),o=this.viewportToBasic(1,1,t,i),c=this.viewportToBasic(1,-1,t,i),s=this.viewportToBasic(-1,-1,t,i);let d=0,p=0,g=0,_=0;const[x,b]=this.containerToCanvas(e);if(r[1]<0&&o[1]<0){const S=r[1]>o[1]?r[0]:o[0],P=this.basicToCanvas(S,0,e,t,i);d=P[1]>0?P[1]:0}if(o[0]>1&&c[0]>1){const S=o[0]<c[0]?o[1]:c[1],P=this.basicToCanvas(1,S,e,t,i);p=P[0]<x?x-P[0]:0}if(c[1]>1&&s[1]>1){const S=c[1]<s[1]?c[0]:s[0],P=this.basicToCanvas(S,1,e,t,i);g=P[1]<b?b-P[1]:0}if(s[0]<0&&r[0]<0){const S=s[0]>r[0]?s[1]:r[1],P=this.basicToCanvas(0,S,e,t,i);_=P[0]>0?P[0]:0}return[d,p,g,_]}insideElement(e,t){const i=t.getBoundingClientRect(),r=i.left+t.clientLeft,o=r+t.clientWidth,c=i.top+t.clientTop,s=c+t.clientHeight;return e.clientX>r&&e.clientX<o&&e.clientY>c&&e.clientY<s}projectToCanvas(e,t,i){const r=this.projectToViewport(e,i);return this.viewportToCanvas(r[0],r[1],t)}projectToCanvasSafe(e,t,i){if(this.worldToCamera(e,i)[2]>0)return null;const o=this.projectToViewport(e,i);return this.viewportToCanvas(o[0],o[1],t)}projectToViewport(e,t){const i=new Ge(e[0],e[1],e[2]).project(t);return[i.x,i.y]}unprojectFromCanvas(e,t,i,r){const o=this.canvasToViewport(e,t,i);return this.unprojectFromViewport(o[0],o[1],r)}unprojectFromViewport(e,t,i){return new Ge(e,t,1).unproject(i)}viewportToBasic(e,t,i,r){const o=new Ge(e,t,1).unproject(r).toArray();return i.projectBasic(o)}viewportToCanvas(e,t,i){const[r,o]=this.containerToCanvas(i),c=r*(e+1)/2,s=-o*(t-1)/2;return[c,s]}worldToCamera(e,t){return new Ge(e[0],e[1],e[2]).applyMatrix4(t.matrixWorldInverse).toArray()}}var Fd;(function(n){n[n.Automatic=0]="Automatic",n[n.Large=1]="Large",n[n.Small=2]="Small"})(Fd||(Fd={}));class RB extends So{constructor(e,t,i){super(e,t,i),this._spatial=new xo,this._viewportCoords=new $o,this._svgNamespace="http://www.w3.org/2000/svg",this._distinctThreshold=Math.PI/360,this._animationSpeed=.075}_activate(){const e=this._subscriptions,t=this._container.renderService.renderCamera$.pipe(st(d=>{let p=this._spatial.degToRad(d.perspective.fov),g=d.perspective.aspect===Number.POSITIVE_INFINITY?Math.PI:Math.atan(d.perspective.aspect*Math.tan(.5*p))*2;return[this._spatial.azimuthalToBearing(d.rotation.phi),g]}),yi((d,p)=>Math.abs(p[0]-d[0])<this._distinctThreshold&&Math.abs(p[1]-d[1])<this._distinctThreshold)),i=Si(this._navigator.stateService.currentState$.pipe(yi(void 0,d=>d.state.currentImage.id)),this._navigator.panService.panImages$).pipe(st(([d,p])=>{const g=d.state.currentImage,_=d.state.currentTransform;if(Di(g.cameraType))return[Math.PI,Math.PI];const x=this._computeProjectedPoints(_),b=this._spatial.degToRad(this._computeHorizontalFov(x));let S=b/2,P=b/2;for(const[L,,E]of p){const C=this._spatial.wrap(L.compassAngle-g.compassAngle,-180,180);C<0?S=this._spatial.degToRad(Math.abs(C))+E/2:P=this._spatial.degToRad(Math.abs(C))+E/2}return[S,P]}),yi(([d,p],[g,_])=>Math.abs(g-d)<this._distinctThreshold&&Math.abs(_-p)<this._distinctThreshold)),r=Si(this._navigator.stateService.currentState$.pipe(yi(void 0,d=>d.state.currentImage.id)),this._container.renderService.bearing$).pipe(st(([d,p])=>this._spatial.degToRad(d.state.currentImage.compassAngle-p))),o=new ri,c=o.pipe(Vr((d,p)=>p(d),{alpha:0,curr:[0,0,0],prev:[0,0,0]}),st(d=>{const p=Zg.smootherstep(d.alpha,0,1),g=d.curr,_=d.prev;return[this._interpolate(_[0],g[0],p),this._interpolate(_[1],g[1],p)]}));e.push(i.pipe(st(d=>p=>{const g=Zg.smootherstep(p.alpha,0,1),_=p.curr,x=p.prev,b=[this._interpolate(x[0],_[0],g),this._interpolate(x[1],_[1],g)];return{alpha:0,curr:d.slice(),prev:b}})).subscribe(o)),e.push(i.pipe(ei(()=>this._container.renderService.renderCameraFrame$.pipe(Ks(1),Vr(d=>d+this._animationSpeed,0),HO(d=>d<=1+this._animationSpeed),st(d=>Math.min(d,1)))),st(d=>p=>({alpha:d,curr:p.curr.slice(),prev:p.prev.slice()}))).subscribe(o));const s=Si(r,c).pipe(st(([d,p])=>[d,p[0],p[1]]));e.push(Si(t,s,this._configuration$,this._container.renderService.size$).pipe(st(([[d,p],[g,_,x],b,S])=>{const P=this._createBackground(d),L=this._createFovIndicator(_,x,g),E=this._createNorth(d),C=this._createCircleSectorCompass(this._createCircleSector(Math.max(Math.PI/20,p),"#FFF")),D=b.size===Fd.Small||b.size===Fd.Automatic&&S.width<640?".mapillary-bearing-compact":"";return{name:this._name,vNode:qt.h("div.mapillary-bearing-indicator-container"+D,{oncontextmenu:O=>{O.preventDefault()}},[P,L,E,C])}})).subscribe(this._container.domRenderer.render$))}_deactivate(){this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{size:Fd.Automatic}}_createFovIndicator(e,t,i){const r=this._createFovArc(e,t),o=qt.h("g",{attributes:{transform:"translate(18,18)"},namespace:this._svgNamespace},[r]);return qt.h("svg",{attributes:{viewBox:"0 0 36 36"},namespace:this._svgNamespace,style:{height:"36px",left:"2px",position:"absolute",top:"2px",transform:`rotateZ(${this._spatial.radToDeg(i)}deg)`,width:"36px"}},[o])}_createFovArc(e,t){const o=e+t;if(o>2*Math.PI-Math.PI/90)return qt.h("circle",{attributes:{cx:"0",cy:"0","fill-opacity":"0",r:`${16.75}`,stroke:"#FFF","stroke-width":`${2.5}`},namespace:this._svgNamespace},[]);let c=-Math.PI/2-e,s=c+o,d=16.75*Math.cos(c),p=16.75*Math.sin(c),g=16.75*Math.cos(s),_=16.75*Math.sin(s),x=o>=Math.PI?1:0,b=`M ${d} ${p} A ${16.75} ${16.75} 0 ${x} 1 ${g} ${_}`;return qt.h("path",{attributes:{d:b,"fill-opacity":"0",stroke:"#FFF","stroke-width":`${2.5}`},namespace:this._svgNamespace},[])}_createCircleSectorCompass(e){let t=qt.h("g",{attributes:{transform:"translate(1,1)"},namespace:this._svgNamespace},[e]);return qt.h("svg",{attributes:{viewBox:"0 0 2 2"},namespace:this._svgNamespace,style:{height:"26px",left:"7px",position:"absolute",top:"7px",width:"26px"}},[t])}_createCircleSector(e,t){if(e>2*Math.PI-Math.PI/90)return qt.h("circle",{attributes:{cx:"0",cy:"0",fill:t,r:"1"},namespace:this._svgNamespace},[]);let i=-Math.PI/2-e/2,r=i+e,o=Math.cos(i),c=Math.sin(i),s=Math.cos(r),d=Math.sin(r),p=e>=Math.PI?1:0,g=`M 0 0 ${o} ${c} A 1 1 0 ${p} 1 ${s} ${d}`;return qt.h("path",{attributes:{d:g,fill:t},namespace:this._svgNamespace},[])}_createNorth(e){const t=qt.h("div.mapillary-bearing-north",[]);return qt.h("div.mapillary-bearing-north-container",{style:{transform:`rotateZ(${this._spatial.radToDeg(-e)}deg)`}},[t])}_createBackground(e){return qt.h("div.mapillary-bearing-indicator-background",{style:{transform:`rotateZ(${this._spatial.radToDeg(-e)}deg)`}},[qt.h("div.mapillary-bearing-indicator-background-circle",[]),qt.h("div.mapillary-bearing-indicator-background-arrow-container",[qt.h("div.mapillary-bearing-indicator-background-arrow",[])])])}_computeProjectedPoints(e){return tE(e,[[1,0]],[[0,.5]],12,this._viewportCoords)}_computeHorizontalFov(e){const t=e.map(r=>this._coordToFov(r[0]));return Math.min(...t)}_coordToFov(e){return this._spatial.radToDeg(2*Math.atan(e))}_interpolate(e,t,i){return(1-i)*e+i*t}}RB.componentName="bearing";class LB extends So{constructor(e,t,i){super(e,t,i)}_activate(){const e=this._subscriptions;e.push(Si(this._navigator.stateService.currentImage$.pipe(ei(t=>t.sequenceEdges$),ai(t=>t.cached)),this._configuration$).pipe(ei(t=>{let i=t[0],r=t[1],o=Math.max(0,Math.min(4,r.depth.sequence)),c=this._cache$(i.edges,Vt.Next,o),s=this._cache$(i.edges,Vt.Prev,o);return mn(c,s).pipe(Un(d=>(console.error("Failed to cache sequence edges.",d),Ni())))})).subscribe(()=>{})),e.push(Si(this._navigator.stateService.currentImage$.pipe(ei(t=>Si(Pi(t),t.spatialEdges$.pipe(ai(i=>i.cached))))),this._configuration$).pipe(ei(([[t,i],r])=>{let o=i.edges,c=r.depth,s=Math.max(0,Math.min(2,c.spherical)),d=Di(t.cameraType)?0:Math.max(0,Math.min(3,c.step)),p=Di(t.cameraType)?0:Math.max(0,Math.min(1,c.turn)),g=this._cache$(o,Vt.Spherical,s),_=this._cache$(o,Vt.StepForward,d),x=this._cache$(o,Vt.StepBackward,d),b=this._cache$(o,Vt.StepLeft,d),S=this._cache$(o,Vt.StepRight,d),P=this._cache$(o,Vt.TurnLeft,p),L=this._cache$(o,Vt.TurnRight,p),E=this._cache$(o,Vt.TurnU,p);return mn(_,x,b,S,g,P,L,E).pipe(Un(C=>(console.error("Failed to cache spatial edges.",C),Ni())))})).subscribe(()=>{}))}_deactivate(){this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{depth:{spherical:1,sequence:2,step:1,turn:0}}}_cache$(e,t,i){return Oy(Pi(e),Pi(i)).pipe(qO(r=>{let o=r[0],c=r[1],s=[];if(c>0)for(let d of o)d.data.direction===t&&s.push(Oy(this._navigator.graphService.cacheImage$(d.target).pipe(Hi(p=>this._imageToEdges$(p,t))),Pi(c-1)));return Fr(s).pipe(lp())}),Ks(1))}_imageToEdges$(e,t){return([Vt.Next,Vt.Prev].indexOf(t)>-1?e.sequenceEdges$:e.spatialEdges$).pipe(wi(i=>i.cached),st(i=>i.edges))}}LB.componentName="cache";class Ul extends ur{constructor(e){super(e??"The request was cancelled."),Object.setPrototypeOf(this,Ul.prototype),this.name="CancelMapillaryError"}}class Qie{constructor(e,t){this._spatial=new xo,this._minThresholdWidth=320,this._maxThresholdWidth=1480,this._minThresholdHeight=240,this._maxThresholdHeight=820,this._configure(e),this._resize(t),this._reset()}get minWidth(){return this._minWidth}get maxWidth(){return this._maxWidth}get containerWidth(){return this._containerWidth}get containerWidthCss(){return this._containerWidthCss}get containerMarginCss(){return this._containerMarginCss}get containerLeftCss(){return this._containerLeftCss}get containerHeight(){return this._containerHeight}get containerHeightCss(){return this._containerHeightCss}get containerBottomCss(){return this._containerBottomCss}get stepCircleSize(){return this._stepCircleSize}get stepCircleSizeCss(){return this._stepCircleSizeCss}get stepCircleMarginCss(){return this._stepCircleMarginCss}get turnCircleSize(){return this._turnCircleSize}get turnCircleSizeCss(){return this._turnCircleSizeCss}get outerRadius(){return this._outerRadius}get innerRadius(){return this._innerRadius}get shadowOffset(){return this._shadowOffset}configure(e){this._configure(e),this._reset()}resize(e){this._resize(e),this._reset()}angleToCoordinates(e){return[Math.cos(e),Math.sin(e)]}relativeAngleToCoordiantes(e,t){let i=this._spatial.wrapAngle(e-t);return this.angleToCoordinates(i)}_configure(e){this._minWidth=e.minWidth,this._maxWidth=this._getMaxWidth(e.minWidth,e.maxWidth)}_resize(e){this._elementWidth=e.width,this._elementHeight=e.height}_reset(){this._containerWidth=this._getContainerWidth(this._elementWidth,this._elementHeight),this._containerHeight=this._getContainerHeight(this.containerWidth),this._stepCircleSize=this._getStepCircleDiameter(this._containerHeight),this._turnCircleSize=this._getTurnCircleDiameter(this.containerHeight),this._outerRadius=this._getOuterRadius(this._containerHeight),this._innerRadius=this._getInnerRadius(this._containerHeight),this._shadowOffset=3,this._containerWidthCss=this._numberToCssPixels(this._containerWidth),this._containerMarginCss=this._numberToCssPixels(-.5*this._containerWidth),this._containerLeftCss=this._numberToCssPixels(Math.floor(.5*this._elementWidth)),this._containerHeightCss=this._numberToCssPixels(this._containerHeight),this._containerBottomCss=this._numberToCssPixels(Math.floor(-.08*this._containerHeight)),this._stepCircleSizeCss=this._numberToCssPixels(this._stepCircleSize),this._stepCircleMarginCss=this._numberToCssPixels(-.5*this._stepCircleSize),this._turnCircleSizeCss=this._numberToCssPixels(this._turnCircleSize)}_getContainerWidth(e,t){let i=(e-this._minThresholdWidth)/(this._maxThresholdWidth-this._minThresholdWidth),r=(t-this._minThresholdHeight)/(this._maxThresholdHeight-this._minThresholdHeight),o=Math.max(0,Math.min(1,Math.min(i,r)));return o=.04*Math.round(25*o),this._minWidth+o*(this._maxWidth-this._minWidth)}_getContainerHeight(e){return .77*e}_getStepCircleDiameter(e){return .34*e}_getTurnCircleDiameter(e){return .3*e}_getOuterRadius(e){return .31*e}_getInnerRadius(e){return .125*e}_numberToCssPixels(e){return e+"px"}_getMaxWidth(e,t){return e>t?e:t}}class ene{constructor(e,t){this._isEdge=!1,this._spatial=new xo,this._calculator=new Qie(e,t),this._image=null,this._rotation={phi:0,theta:0},this._epsilon=.5*Math.PI/180,this._highlightKey=null,this._distinguishSequence=!1,this._needsRender=!1,this._stepEdges=[],this._turnEdges=[],this._sphericalEdges=[],this._sequenceEdgeKeys=[],this._stepDirections=[Vt.StepForward,Vt.StepBackward,Vt.StepLeft,Vt.StepRight],this._turnDirections=[Vt.TurnLeft,Vt.TurnRight,Vt.TurnU],this._turnNames={},this._turnNames[Vt.TurnLeft]="mapillary-direction-turn-left",this._turnNames[Vt.TurnRight]="mapillary-direction-turn-right",this._turnNames[Vt.TurnU]="mapillary-direction-turn-around";let i=!!document.documentMode;this._isEdge=!i&&!!window.StyleMedia}get needsRender(){return this._needsRender}render(e){this._needsRender=!1;let t=this._rotation,i=[],r=[];return Di(this._image.cameraType)?i=i.concat(this._createSphericalArrows(e,t)):(i=i.concat(this._createPerspectiveToSphericalArrows(e,t)),i=i.concat(this._createStepArrows(e,t)),r=r.concat(this._createTurnArrows(e))),this._getContainer(i,r,t)}setEdges(e,t){this._setEdges(e,t),this._setNeedsRender()}setImage(e){this._image=e,this._clearEdges(),this._setNeedsRender()}setRenderCamera(e){let t=e.rotation;Math.abs(t.phi-this._rotation.phi)<this._epsilon||(this._rotation=t,this._setNeedsRender())}setConfiguration(e){let t=!1;(this._highlightKey!==e.highlightId||this._distinguishSequence!==e.distinguishSequence)&&(this._highlightKey=e.highlightId,this._distinguishSequence=e.distinguishSequence,t=!0),(this._calculator.minWidth!==e.minWidth||this._calculator.maxWidth!==e.maxWidth)&&(this._calculator.configure(e),t=!0),t&&this._setNeedsRender()}resize(e){this._calculator.resize(e),this._setNeedsRender()}_setNeedsRender(){this._image!=null&&(this._needsRender=!0)}_clearEdges(){this._stepEdges=[],this._turnEdges=[],this._sphericalEdges=[],this._sequenceEdgeKeys=[]}_setEdges(e,t){this._stepEdges=[],this._turnEdges=[],this._sphericalEdges=[],this._sequenceEdgeKeys=[];for(let i of e.edges){let r=i.data.direction;if(this._stepDirections.indexOf(r)>-1){this._stepEdges.push(i);continue}if(this._turnDirections.indexOf(r)>-1){this._turnEdges.push(i);continue}i.data.direction===Vt.Spherical&&this._sphericalEdges.push(i)}if(this._distinguishSequence&&t!=null){let i=this._sphericalEdges.concat(this._stepEdges).concat(this._turnEdges);for(let r of i){let o=r.target;for(let c of t.imageIds)if(c===o){this._sequenceEdgeKeys.push(o);break}}}}_createSphericalArrows(e,t){let i=[];for(let r of this._sphericalEdges)i.push(this._createVNodeByKey(e,r.target,r.data.worldMotionAzimuth,t,this._calculator.outerRadius,"mapillary-direction-arrow-spherical"));for(let r of this._stepEdges)i.push(this._createSphericalToPerspectiveArrow(e,r.target,r.data.worldMotionAzimuth,t,r.data.direction));return i}_createSphericalToPerspectiveArrow(e,t,i,r,o){let c=Math.PI/8,s=r.phi;switch(o){case Vt.StepBackward:s=r.phi-Math.PI;break;case Vt.StepLeft:s=r.phi+Math.PI/2;break;case Vt.StepRight:s=r.phi-Math.PI/2;break}return Math.abs(this._spatial.wrapAngle(i-s))<c?this._createVNodeByKey(e,t,i,r,this._calculator.outerRadius,"mapillary-direction-arrow-step"):this._createVNodeInactive(t,i,r)}_createPerspectiveToSphericalArrows(e,t){let i=[];for(let r of this._sphericalEdges)i.push(this._createVNodeByKey(e,r.target,r.data.worldMotionAzimuth,t,this._calculator.innerRadius,"mapillary-direction-arrow-spherical",!0));return i}_createStepArrows(e,t){let i=[];for(let r of this._stepEdges)i.push(this._createVNodeByDirection(e,r.target,r.data.worldMotionAzimuth,t,r.data.direction));return i}_createTurnArrows(e){let t=[];for(let i of this._turnEdges){let r=i.data.direction,o=this._turnNames[r];t.push(this._createVNodeByTurn(e,i.target,o,r))}return t}_createVNodeByKey(e,t,i,r,o,c,s){let d=p=>{e.moveTo$(t).subscribe(void 0,g=>{g instanceof Ul||console.error(g)})};return this._createVNode(t,i,r,o,c,"mapillary-direction-circle",d,s)}_createVNodeByDirection(e,t,i,r,o){let c=s=>{e.moveDir$(o).subscribe(void 0,d=>{d instanceof Ul||console.error(d)})};return this._createVNode(t,i,r,this._calculator.outerRadius,"mapillary-direction-arrow-step","mapillary-direction-circle",c)}_createVNodeByTurn(e,t,i,r){let o=g=>{e.moveDir$(r).subscribe(void 0,_=>{_ instanceof Ul||console.error(_)})},c={height:this._calculator.turnCircleSizeCss,transform:"rotate(0)",width:this._calculator.turnCircleSizeCss};switch(r){case Vt.TurnLeft:c.left="5px",c.top="5px";break;case Vt.TurnRight:c.right="5px",c.top="5px";break;case Vt.TurnU:c.left="5px",c.bottom="5px";break}let s={attributes:{"data-id":t},onclick:o,style:c},d="mapillary-direction-turn-circle";this._sequenceEdgeKeys.indexOf(t)>-1&&(d+="-sequence"),this._highlightKey===t&&(d+="-highlight");let p=qt.h(`div.${i}`,{},[]);return qt.h("div."+d,s,[p])}_createVNodeInactive(e,t,i){return this._createVNode(e,t,i,this._calculator.outerRadius,"mapillary-direction-arrow-inactive","mapillary-direction-circle-inactive")}_createVNode(e,t,i,r,o,c,s,d){let p=this._calculator.angleToCoordinates(t-i.phi),g=Math.round(-r*p[1]+.5*this._calculator.containerWidth),_=Math.round(-r*p[0]+.5*this._calculator.containerHeight),x=this._calculator.relativeAngleToCoordiantes(t,i.phi),b=this._calculator.shadowOffset,S=-b*x[1],P=b*x[0],L=`drop-shadow(${S}px ${P}px 1px rgba(0,0,0,0.8))`,E={style:{"-webkit-filter":L,filter:L}},C=qt.h("div."+o,E,[]),D=-this._spatial.radToDeg(t-i.phi),O=d?`translate(${g}px, ${_}px) rotate(${D}deg) translateZ(-0.01px)`:`translate(${g}px, ${_}px) rotate(${D}deg)`,U={attributes:{"data-id":e},onclick:s,style:{height:this._calculator.stepCircleSizeCss,marginLeft:this._calculator.stepCircleMarginCss,marginTop:this._calculator.stepCircleMarginCss,transform:O,width:this._calculator.stepCircleSizeCss}};return this._sequenceEdgeKeys.indexOf(e)>-1&&(c+="-sequence"),this._highlightKey===e&&(c+="-highlight"),qt.h("div."+c,U,[C])}_getContainer(e,t,i){let r=this._isEdge?"rotateX(60deg)":`perspective(${this._calculator.containerWidthCss}) rotateX(60deg)`,o={oncontextmenu:c=>{c.preventDefault()},style:{bottom:this._calculator.containerBottomCss,height:this._calculator.containerHeightCss,left:this._calculator.containerLeftCss,marginLeft:this._calculator.containerMarginCss,transform:r,width:this._calculator.containerWidthCss}};return qt.h("div.mapillary-direction-perspective",o,t.concat(e))}}class kB extends So{constructor(e,t,i,r){super(e,t,i),this._renderer=r||new ene(this.defaultConfiguration,{height:t.container.offsetHeight,width:t.container.offsetWidth}),this._hoveredIdSubject$=new ri,this._hoveredId$=this._hoveredIdSubject$.pipe(pn())}fire(e,t){super.fire(e,t)}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}_activate(){const e=this._subscriptions;e.push(this._configuration$.subscribe(t=>{this._renderer.setConfiguration(t)})),e.push(this._container.renderService.size$.subscribe(t=>{this._renderer.resize(t)})),e.push(this._navigator.stateService.currentImage$.pipe(Dr(t=>{this._container.domRenderer.render$.next({name:this._name,vNode:qt.h("div",{},[])}),this._renderer.setImage(t)}),Ui(this._configuration$),ei(([t,i])=>Si(t.spatialEdges$,i.distinguishSequence?this._navigator.graphService.cacheSequence$(t.sequenceId).pipe(Un(r=>(console.error(`Failed to cache sequence (${t.sequenceId})`,r),Pi(null)))):Pi(null)))).subscribe(([t,i])=>{this._renderer.setEdges(t,i)})),e.push(this._container.renderService.renderCameraFrame$.pipe(Dr(t=>{this._renderer.setRenderCamera(t)}),st(()=>this._renderer),ai(t=>t.needsRender),st(t=>({name:this._name,vNode:t.render(this._navigator)}))).subscribe(this._container.domRenderer.render$)),e.push(Si(this._container.domRenderer.element$,this._container.renderService.renderCamera$,this._container.mouseService.mouseMove$.pipe(An(null)),this._container.mouseService.mouseUp$.pipe(An(null))).pipe(st(([t])=>{let i=t.getElementsByClassName("mapillary-direction-perspective");for(let r=0;r<i.length;r++){let o=i.item(r).querySelector(":hover");if(o!=null&&o.hasAttribute("data-id"))return o.getAttribute("data-id")}return null}),yi()).subscribe(this._hoveredIdSubject$)),e.push(this._hoveredId$.subscribe(t=>{const i="hover",r={id:t,target:this,type:i};this.fire(i,r)}))}_deactivate(){this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{distinguishSequence:!1,maxWidth:460,minWidth:260}}}kB.componentName="direction";const tne=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif

#define tau 6.28318530718

uniform sampler2D projectorTex;
uniform float opacity;

varying vec4 vRstq;

void main()
{
    vec3 b = normalize(vRstq.xyz);
    float lat = -asin(b.y);
    float lng = atan(b.x, b.z);
    float x = lng / tau + 0.5;
    float y = lat / tau * 2.0 + 0.5;
    vec4 baseColor = texture2D(projectorTex, vec2(x, y));
    baseColor.a = opacity;
    gl_FragColor = baseColor;
}
`,ine=`
#ifdef GL_ES
precision highp float;
#endif

uniform mat4 projectorMat;

varying vec4 vRstq;

void main()
{
    vRstq = projectorMat * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,nne=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif

#define tau 6.28318530718

uniform sampler2D projectorTex;
uniform float curtain;
uniform float opacity;

varying vec4 vRstq;

void main()
{
    vec3 b = normalize(vRstq.xyz);
    float lat = -asin(b.y);
    float lng = atan(b.x, b.z);
    float x = lng / tau + 0.5;
    float y = lat / tau * 2.0 + 0.5;

    bool inverted = curtain < 0.5;

    float curtainMin = inverted ? curtain + 0.5 : curtain - 0.5;
    float curtainMax = curtain;

    bool insideCurtain = inverted ?
        x > curtainMin || x < curtainMax :
        x > curtainMin && x < curtainMax;

    vec4 baseColor;
    if (insideCurtain) {
        baseColor = texture2D(projectorTex, vec2(x, y));
        baseColor.a = opacity;
    } else {
        baseColor = vec4(0.0, 0.0, 0.0, 0.0);
    }

    gl_FragColor = baseColor;
}
`,rne=`
#ifdef GL_ES
precision highp float;
#endif

uniform mat4 projectorMat;

varying vec4 vRstq;

void main()
{
    vRstq = projectorMat * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,sne=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif

uniform sampler2D projectorTex;
uniform float opacity;
uniform float focal;
uniform float k1;
uniform float k2;
uniform float scale_x;
uniform float scale_y;
uniform float radial_peak;

varying vec4 vRstq;

void main()
{
    float x = vRstq.x;
    float y = vRstq.y;
    float z = vRstq.z;

    float r = sqrt(x * x + y * y);
    float theta = atan(r, z);

    if (radial_peak > 0. && theta > radial_peak) {
        theta = radial_peak;
    }

    float theta2 = theta * theta;
    float theta_d = theta * (1.0 + theta2 * (k1 + theta2 * k2));
    float s = focal * theta_d / r;

    float u = scale_x * s * x + 0.5;
    float v = -scale_y * s * y + 0.5;

    vec4 baseColor;
    if (u >= 0. && u <= 1. && v >= 0. && v <= 1.) {
        baseColor = texture2D(projectorTex, vec2(u, v));
        baseColor.a = opacity;
    } else {
        baseColor = vec4(0.0, 0.0, 0.0, 0.0);
    }

    gl_FragColor = baseColor;
}
`,one=`
#ifdef GL_ES
precision highp float;
#endif

uniform mat4 projectorMat;

varying vec4 vRstq;

void main()
{
    vRstq = projectorMat * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,ane=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif

uniform sampler2D projectorTex;
uniform float opacity;
uniform float focal;
uniform float k1;
uniform float k2;
uniform float scale_x;
uniform float scale_y;
uniform float radial_peak;
uniform float curtain;

varying vec4 vRstq;

void main()
{
    float x = vRstq.x;
    float y = vRstq.y;
    float z = vRstq.z;

    float r2 = sqrt(x * x + y * y);
    float theta = atan(r2, z);

    if (radial_peak > 0. && theta > radial_peak) {
        theta = radial_peak;
    }

    float theta2 = theta * theta;
    float theta_d = theta * (1.0 + theta2 * (k1 + theta2 * k2));
    float s = focal * theta_d / r2;

    float u = scale_x * s * x + 0.5;
    float v = -scale_y * s * y + 0.5;

    vec4 baseColor;
    if ((u < curtain || curtain >= 1.0) && u >= 0. && u <= 1. && v >= 0. && v <= 1.) {
        baseColor = texture2D(projectorTex, vec2(u, v));
        baseColor.a = opacity;
    } else {
        baseColor = vec4(0.0, 0.0, 0.0, 0.0);
    }

    gl_FragColor = baseColor;
}
`,lne=`
#ifdef GL_ES
precision highp float;
#endif

uniform mat4 projectorMat;

varying vec4 vRstq;

void main()
{
    vRstq = projectorMat * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,cne=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif

uniform sampler2D projectorTex;
uniform float opacity;
uniform float focal;
uniform float k1;
uniform float k2;
uniform float scale_x;
uniform float scale_y;
uniform float radial_peak;

varying vec4 vRstq;

void main()
{
    float x = vRstq.x / vRstq.z;
    float y = vRstq.y / vRstq.z;
    float r2 = x * x + y * y;

    if (radial_peak > 0. && r2 > radial_peak * sqrt(r2)) {
        r2 = radial_peak * radial_peak;
    }

    float d = 1.0 + k1 * r2 + k2 * r2 * r2;
    float u = scale_x * focal * d * x + 0.5;
    float v = - scale_y * focal * d * y + 0.5;

    vec4 baseColor;
    if (u >= 0. && u <= 1. && v >= 0. && v <= 1.) {
        baseColor = texture2D(projectorTex, vec2(u, v));
        baseColor.a = opacity;
    } else {
        baseColor = vec4(0.0, 0.0, 0.0, 0.0);
    }

    gl_FragColor = baseColor;
}
`,une=`
#ifdef GL_ES
precision highp float;
#endif

uniform mat4 projectorMat;

varying vec4 vRstq;

void main()
{
    vRstq = projectorMat * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,hne=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif

uniform sampler2D projectorTex;
uniform float opacity;
uniform float focal;
uniform float k1;
uniform float k2;
uniform float scale_x;
uniform float scale_y;
uniform float radial_peak;
uniform float curtain;

varying vec4 vRstq;

void main()
{
    float x = vRstq.x / vRstq.z;
    float y = vRstq.y / vRstq.z;
    float r2 = x * x + y * y;

    if (radial_peak > 0. && r2 > radial_peak * sqrt(r2)) {
        r2 = radial_peak * radial_peak;
    }

    float d = 1.0 + k1 * r2 + k2 * r2 * r2;
    float u = scale_x * focal * d * x + 0.5;
    float v = - scale_y * focal * d * y + 0.5;

    vec4 baseColor;
    if ((u < curtain || curtain >= 1.0) && u >= 0. && u <= 1. && v >= 0. && v <= 1.) {
        baseColor = texture2D(projectorTex, vec2(u, v));
        baseColor.a = opacity;
    } else {
        baseColor = vec4(0.0, 0.0, 0.0, 0.0);
    }

    gl_FragColor = baseColor;
}
`,dne=`
#ifdef GL_ES
precision highp float;
#endif

uniform mat4 projectorMat;

varying vec4 vRstq;

void main()
{
    vRstq = projectorMat * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,fne=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif

uniform sampler2D projectorTex;
uniform float opacity;

varying vec4 vRstq;

void main()
{
    float u = vRstq.x / vRstq.w;
    float v = vRstq.y / vRstq.w;

    vec4 baseColor;
    if (u >= 0. && u <= 1. && v >= 0. && v <= 1.) {
        baseColor = texture2D(projectorTex, vec2(u, v));
        baseColor.a = opacity;
    } else {
        baseColor = vec4(0.0, 0.0, 0.0, 0.0);
    }

    gl_FragColor = baseColor;
}
`,pne=`
#ifdef GL_ES
precision highp float;
#endif

uniform mat4 projectorMat;

varying vec4 vRstq;

void main()
{
    vRstq = projectorMat * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,mne=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif

uniform sampler2D projectorTex;
uniform float opacity;
uniform float curtain;

varying vec4 vRstq;

void main()
{
    float u = vRstq.x / vRstq.w;
    float v = vRstq.y / vRstq.w;

    vec4 baseColor;
    if ((u < curtain || curtain >= 1.0) && u >= 0. && u <= 1. && v >= 0. && v <= 1.) {
        baseColor = texture2D(projectorTex, vec2(u, v));
        baseColor.a = opacity;
    } else {
        baseColor = vec4(0.0, 0.0, 0.0, 0.0);
    }

    gl_FragColor = baseColor;
}
`,gne=`
#ifdef GL_ES
precision highp float;
#endif

uniform mat4 projectorMat;

varying vec4 vRstq;

void main()
{
    vRstq = projectorMat * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`;class Jr{}Jr.fisheye={fragment:sne,vertex:one};Jr.fisheyeCurtain={fragment:ane,vertex:lne};Jr.perspective={fragment:cne,vertex:une};Jr.perspectiveCurtain={fragment:hne,vertex:dne};Jr.perspectiveDistorted={fragment:fne,vertex:pne};Jr.perspectiveDistortedCurtain={fragment:mne,vertex:gne};Jr.spherical={fragment:tne,vertex:ine};Jr.sphericalCurtain={fragment:nne,vertex:rne};class DB{constructor(e,t){this._imagePlaneDepth=e??200,this._imageSphereRadius=t??200}createMesh(e,t){return Di(t.cameraType)?this._createImageSphere(e,t):kw(t.cameraType)?this._createImagePlaneFisheye(e,t):this._createImagePlane(e,t)}createFlatMesh(e,t,i,r,o,c){let s=this._createTexture(e.image),d=this._createDistortedPlaneMaterialParameters(t,s),p=new ta(d),g=this._getFlatImagePlaneGeoFromBasic(t,i,r,o,c);return new kr(g,p)}createCurtainMesh(e,t){return Di(t.cameraType)?this._createSphereCurtainMesh(e,t):kw(t.cameraType)?this._createCurtainMeshFisheye(e,t):this._createCurtainMesh(e,t)}createDistortedCurtainMesh(e,t){return this._createDistortedCurtainMesh(e,t)}_createCurtainMesh(e,t){let i=this._createTexture(e.image),r=this._createCurtainPlaneMaterialParameters(t,i),o=new ta(r),c=this._useMesh(t,e)?this._getImagePlaneGeo(t,e):this._getRegularFlatImagePlaneGeo(t);return new kr(c,o)}_createCurtainMeshFisheye(e,t){let i=this._createTexture(e.image),r=this._createCurtainPlaneMaterialParametersFisheye(t,i),o=new ta(r),c=this._useMesh(t,e)?this._getImagePlaneGeoFisheye(t,e):this._getRegularFlatImagePlaneGeo(t);return new kr(c,o)}_createDistortedCurtainMesh(e,t){let i=this._createTexture(e.image),r=this._createDistortedCurtainPlaneMaterialParameters(t,i),o=new ta(r),c=this._getRegularFlatImagePlaneGeo(t);return new kr(c,o)}_createSphereCurtainMesh(e,t){let i=this._createTexture(e.image),r=this._createCurtainSphereMaterialParameters(t,i),o=new ta(r);return this._useMesh(t,e)?new kr(this._getImageSphereGeo(t,e),o):new kr(this._getFlatImageSphereGeo(t),o)}_createImageSphere(e,t){let i=this._createTexture(e.image),r=this._createSphereMaterialParameters(t,i),o=new ta(r);return this._useMesh(t,e)?new kr(this._getImageSphereGeo(t,e),o):new kr(this._getFlatImageSphereGeo(t),o)}_createImagePlane(e,t){let i=this._createTexture(e.image),r=this._createPlaneMaterialParameters(t,i),o=new ta(r),c=this._useMesh(t,e)?this._getImagePlaneGeo(t,e):this._getRegularFlatImagePlaneGeo(t);return new kr(c,o)}_createImagePlaneFisheye(e,t){let i=this._createTexture(e.image),r=this._createPlaneMaterialParametersFisheye(t,i),o=new ta(r),c=this._useMesh(t,e)?this._getImagePlaneGeoFisheye(t,e):this._getRegularFlatImagePlaneGeoFisheye(t);return new kr(c,o)}_createSphereMaterialParameters(e,t){return{depthWrite:!1,fragmentShader:Jr.spherical.fragment,side:ea,transparent:!0,uniforms:{opacity:{value:1},projectorMat:{value:e.rt},projectorTex:{value:t}},vertexShader:Jr.spherical.vertex}}_createCurtainSphereMaterialParameters(e,t){return{depthWrite:!1,fragmentShader:Jr.sphericalCurtain.fragment,side:ea,transparent:!0,uniforms:{curtain:{value:1},opacity:{value:1},projectorMat:{value:e.rt},projectorTex:{value:t}},vertexShader:Jr.sphericalCurtain.vertex}}_createPlaneMaterialParameters(e,t){return{depthWrite:!1,fragmentShader:Jr.perspective.fragment,side:ea,transparent:!0,uniforms:{focal:{value:e.focal},k1:{value:e.ck1},k2:{value:e.ck2},opacity:{value:1},projectorMat:{value:e.basicRt},projectorTex:{value:t},radial_peak:{value:e.radialPeak?e.radialPeak:0},scale_x:{value:Math.max(e.basicHeight,e.basicWidth)/e.basicWidth},scale_y:{value:Math.max(e.basicWidth,e.basicHeight)/e.basicHeight}},vertexShader:Jr.perspective.vertex}}_createPlaneMaterialParametersFisheye(e,t){return{depthWrite:!1,fragmentShader:Jr.fisheye.fragment,side:ea,transparent:!0,uniforms:{focal:{value:e.focal},k1:{value:e.ck1},k2:{value:e.ck2},opacity:{value:1},projectorMat:{value:e.basicRt},projectorTex:{value:t},radial_peak:{value:e.radialPeak?e.radialPeak:0},scale_x:{value:Math.max(e.basicHeight,e.basicWidth)/e.basicWidth},scale_y:{value:Math.max(e.basicWidth,e.basicHeight)/e.basicHeight}},vertexShader:Jr.fisheye.vertex}}_createCurtainPlaneMaterialParametersFisheye(e,t){return{depthWrite:!1,fragmentShader:Jr.fisheyeCurtain.fragment,side:ea,transparent:!0,uniforms:{curtain:{value:1},focal:{value:e.focal},k1:{value:e.ck1},k2:{value:e.ck2},opacity:{value:1},projectorMat:{value:e.basicRt},projectorTex:{value:t},radial_peak:{value:e.radialPeak?e.radialPeak:0},scale_x:{value:Math.max(e.basicHeight,e.basicWidth)/e.basicWidth},scale_y:{value:Math.max(e.basicWidth,e.basicHeight)/e.basicHeight}},vertexShader:Jr.fisheyeCurtain.vertex}}_createCurtainPlaneMaterialParameters(e,t){return{depthWrite:!1,fragmentShader:Jr.perspectiveCurtain.fragment,side:ea,transparent:!0,uniforms:{curtain:{value:1},focal:{value:e.focal},k1:{value:e.ck1},k2:{value:e.ck2},opacity:{value:1},projectorMat:{value:e.basicRt},projectorTex:{value:t},radial_peak:{value:e.radialPeak?e.radialPeak:0},scale_x:{value:Math.max(e.basicHeight,e.basicWidth)/e.basicWidth},scale_y:{value:Math.max(e.basicWidth,e.basicHeight)/e.basicHeight}},vertexShader:Jr.perspectiveCurtain.vertex}}_createDistortedCurtainPlaneMaterialParameters(e,t){return{depthWrite:!1,fragmentShader:Jr.perspectiveDistortedCurtain.fragment,side:ea,transparent:!0,uniforms:{curtain:{value:1},opacity:{value:1},projectorMat:{value:e.projectorMatrix()},projectorTex:{value:t}},vertexShader:Jr.perspectiveDistortedCurtain.vertex}}_createDistortedPlaneMaterialParameters(e,t){return{depthWrite:!1,fragmentShader:Jr.perspectiveDistorted.fragment,side:ea,transparent:!0,uniforms:{opacity:{value:1},projectorMat:{value:e.projectorMatrix()},projectorTex:{value:t}},vertexShader:Jr.perspectiveDistorted.vertex}}_createTexture(e){let t=new Bs(e);return t.minFilter=Fo,t.needsUpdate=!0,t}_useMesh(e,t){return t.mesh.vertices.length&&e.hasValidScale}_getImageSphereGeo(e,t){const i=e.srtInverse;let r=5*e.scale,o=this._imageSphereRadius*e.scale,c=t.mesh.vertices,s=c.length/3,d=new Float32Array(c.length);for(let x=0;x<s;++x){let b=3*x,S=c[b+0],P=c[b+1],L=c[b+2],E=Math.sqrt(S*S+P*P+L*L),D=Math.max(r,Math.min(E,o))/E,O=new Ge(S*D,P*D,L*D);O.applyMatrix4(i),d[b+0]=O.x,d[b+1]=O.y,d[b+2]=O.z}let p=t.mesh.faces,g=new Uint16Array(p.length);for(let x=0;x<p.length;++x)g[x]=p[x];let _=new jn;return _.setAttribute("position",new En(d,3)),_.setIndex(new En(g,1)),_}_getImagePlaneGeo(e,t){const r=e.srtInverse;let o=5*e.scale,c=this._imagePlaneDepth*e.scale,s=t.mesh.vertices,d=s.length/3,p=new Float32Array(s.length);for(let b=0;b<d;++b){let S=3*b,P=s[S+0],L=s[S+1],E=s[S+2];b<4&&(P*=3,L*=3);let C=Math.max(o,Math.min(E,c)),D=C/E,O=new Ge(P*D,L*D,C);O.applyMatrix4(r),p[S+0]=O.x,p[S+1]=O.y,p[S+2]=O.z}let g=t.mesh.faces,_=new Uint16Array(g.length);for(let b=0;b<g.length;++b)_[b]=g[b];let x=new jn;return x.setAttribute("position",new En(p,3)),x.setIndex(new En(_,1)),x}_getImagePlaneGeoFisheye(e,t){const i=e.srtInverse;let r=5*e.scale,o=this._imagePlaneDepth*e.scale,c=t.mesh.vertices,s=c.length/3,d=new Float32Array(c.length);for(let x=0;x<s;++x){let b=3*x,S=c[b+0],P=c[b+1],L=c[b+2],E=Math.sqrt(S*S+P*P+L*L),D=Math.max(r,Math.min(E,o))/E,O=new Ge(S*D,P*D,L*D);O.applyMatrix4(i),d[b+0]=O.x,d[b+1]=O.y,d[b+2]=O.z}let p=t.mesh.faces,g=new Uint16Array(p.length);for(let x=0;x<p.length;++x)g[x]=p[x];let _=new jn;return _.setAttribute("position",new En(d,3)),_.setIndex(new En(g,1)),_}_getFlatImageSphereGeo(e){const t=new ZC(this._imageSphereRadius,20,40),i=e.rt.clone().invert();return t.applyMatrix4(i),t}_getRegularFlatImagePlaneGeo(e){let t=e.width,i=e.height,r=Math.max(t,i),o=t/2/r,c=i/2/r;return this._getFlatImagePlaneGeo(e,o,c)}_getFlatImagePlaneGeo(e,t,i){let r=[];return r.push(e.unprojectSfM([-t,-i],this._imagePlaneDepth)),r.push(e.unprojectSfM([t,-i],this._imagePlaneDepth)),r.push(e.unprojectSfM([t,i],this._imagePlaneDepth)),r.push(e.unprojectSfM([-t,i],this._imagePlaneDepth)),this._createFlatGeometry(r)}_getRegularFlatImagePlaneGeoFisheye(e){let t=e.width,i=e.height,r=Math.max(t,i),o=t/2/r,c=i/2/r;return this._getFlatImagePlaneGeoFisheye(e,o,c)}_getFlatImagePlaneGeoFisheye(e,t,i){let r=[];return r.push(e.unprojectSfM([-t,-i],this._imagePlaneDepth)),r.push(e.unprojectSfM([t,-i],this._imagePlaneDepth)),r.push(e.unprojectSfM([t,i],this._imagePlaneDepth)),r.push(e.unprojectSfM([-t,i],this._imagePlaneDepth)),this._createFlatGeometry(r)}_getFlatImagePlaneGeoFromBasic(e,t,i,r,o){let c=[];return c.push(e.unprojectBasic([t,r],this._imagePlaneDepth)),c.push(e.unprojectBasic([i,r],this._imagePlaneDepth)),c.push(e.unprojectBasic([i,o],this._imagePlaneDepth)),c.push(e.unprojectBasic([t,o],this._imagePlaneDepth)),this._createFlatGeometry(c)}_createFlatGeometry(e){let t=new Float32Array(12);for(let o=0;o<e.length;o++){let c=3*o;t[c+0]=e[o][0],t[c+1]=e[o][1],t[c+2]=e[o][2]}let i=new Uint16Array(6);i[0]=0,i[1]=1,i[2]=3,i[3]=1,i[4]=2,i[5]=3;let r=new jn;return r.setAttribute("position",new En(t,3)),r.setIndex(new En(i,1)),r}}class FB{constructor(){this._planes={},this._planesOld={},this._planesPeriphery={},this._scene=new yh,this._sceneOld=new yh,this._scenePeriphery=new yh}get planes(){return this._planes}get planesOld(){return this._planesOld}get planesPeriphery(){return this._planesPeriphery}get scene(){return this._scene}get sceneOld(){return this._sceneOld}get scenePeriphery(){return this._scenePeriphery}updateImagePlanes(e){this._dispose(this._planesOld,this.sceneOld);for(const t in this._planes){if(!this._planes.hasOwnProperty(t))continue;const i=this._planes[t];this._scene.remove(i),this._sceneOld.add(i)}for(const t in e)e.hasOwnProperty(t)&&this._scene.add(e[t]);this._planesOld=this._planes,this._planes=e}addImagePlanes(e){for(const t in e){if(!e.hasOwnProperty(t))continue;const i=e[t];this._scene.add(i),this._planes[t]=i}}addImagePlanesOld(e){for(const t in e){if(!e.hasOwnProperty(t))continue;const i=e[t];this._sceneOld.add(i),this._planesOld[t]=i}}setImagePlanes(e){this._clear(),this.addImagePlanes(e)}addPeripheryPlanes(e){for(const t in e){if(!e.hasOwnProperty(t))continue;const i=e[t];this._scenePeriphery.add(i),this._planesPeriphery[t]=i}}setPeripheryPlanes(e){this._clearPeriphery(),this.addPeripheryPlanes(e)}setImagePlanesOld(e){this._clearOld(),this.addImagePlanesOld(e)}clear(){this._clear(),this._clearOld()}_clear(){this._dispose(this._planes,this._scene),this._planes={}}_clearOld(){this._dispose(this._planesOld,this._sceneOld),this._planesOld={}}_clearPeriphery(){this._dispose(this._planesPeriphery,this._scenePeriphery),this._planesPeriphery={}}_dispose(e,t){for(const i in e){if(!e.hasOwnProperty(i))continue;const r=e[i];t.remove(r),r.geometry.dispose(),r.material.dispose();let o=r.material.uniforms.projectorTex.value;o?.dispose()}}}class _ne{constructor(){this._factory=new DB,this._scene=new FB,this._alpha=0,this._alphaOld=0,this._fadeOutSpeed=.05,this._currentKey=null,this._previousKey=null,this._providerDisposers={},this._frameId=0,this._needsRender=!1}get frameId(){return this._frameId}get needsRender(){return this._needsRender}indicateNeedsRender(){this._needsRender=!0}addPeripheryPlane(e,t){const i=this._factory.createMesh(e,t),r={};r[e.id]=i,this._scene.addPeripheryPlanes(r),this._needsRender=!0}clearPeripheryPlanes(){this._scene.setPeripheryPlanes({}),this._needsRender=!0}updateFrame(e){this._updateFrameId(e.id),this._needsRender=this._updateAlpha(e.state.alpha)||this._needsRender,this._needsRender=this._updateAlphaOld(e.state.alpha)||this._needsRender,this._needsRender=this._updateImagePlanes(e.state)||this._needsRender}setTextureProvider(e,t){if(e!==this._currentKey)return;let i=t.textureCreated$.subscribe(c=>{this._updateTexture(c)}),r=t.textureUpdated$.subscribe(c=>{this._needsRender=!0}),o=()=>{i.unsubscribe(),r.unsubscribe(),t.dispose()};if(e in this._providerDisposers){let c=this._providerDisposers[e];c(),delete this._providerDisposers[e]}this._providerDisposers[e]=o}updateTextureImage(e,t){this._needsRender=!0;const i=this._extend({},this._scene.planes,this._scene.planesOld,this._scene.planesPeriphery);for(const r in i){if(!i.hasOwnProperty(r)||r!==t.id)continue;let s=i[r].material.uniforms.projectorTex.value;s.image=e,s.needsUpdate=!0}}render(e,t){const i=this._scene.planes,r=this._scene.planesOld,o=this._scene.planesPeriphery,c=Object.keys(r).length?1:this._alpha,s=Object.keys(r).length?1:Math.floor(this._alpha);for(const d in i){if(!i.hasOwnProperty(d))continue;const p=i[d];p.material.uniforms.opacity.value=c}for(const d in r){if(!r.hasOwnProperty(d))continue;const p=r[d];p.material.uniforms.opacity.value=this._alphaOld}for(const d in o){if(!o.hasOwnProperty(d))continue;const p=o[d];p.material.uniforms.opacity.value=s}t.render(this._scene.scenePeriphery,e),t.render(this._scene.scene,e),t.render(this._scene.sceneOld,e);for(const d in i){if(!i.hasOwnProperty(d))continue;const p=i[d];p.material.uniforms.opacity.value=this._alpha}t.render(this._scene.scene,e)}clearNeedsRender(){this._needsRender=!1}dispose(){this._scene.clear()}_updateFrameId(e){this._frameId=e}_updateAlpha(e){return e===this._alpha?!1:(this._alpha=e,!0)}_updateAlphaOld(e){return e<1||this._alphaOld===0?!1:(this._alphaOld=Math.max(0,this._alphaOld-this._fadeOutSpeed),!0)}_updateImagePlanes(e){if(e.currentImage==null||e.currentImage.id===this._currentKey)return!1;let t=e.previousImage!=null?e.previousImage.id:null,i=e.currentImage.id;if(this._previousKey!==t&&this._previousKey!==i&&this._previousKey in this._providerDisposers){let c=this._providerDisposers[this._previousKey];c(),delete this._providerDisposers[this._previousKey]}if(t!=null){if(t!==this._currentKey&&t!==this._previousKey){let c=this._factory.createMesh(e.previousImage,e.previousTransform);const s={};s[t]=c,this._scene.updateImagePlanes(s)}this._previousKey=t}this._currentKey=i;let r=this._factory.createMesh(e.currentImage,e.currentTransform);const o={};return o[i]=r,this._scene.updateImagePlanes(o),this._alphaOld=1,!0}_updateTexture(e){this._needsRender=!0;const t=this._scene.planes;for(const i in t){if(!t.hasOwnProperty(i))continue;let o=t[i].material,c=o.uniforms.projectorTex.value;o.uniforms.projectorTex.value=null,c.dispose(),o.uniforms.projectorTex.value=e}}_extend(e,...t){for(const i of t)for(const r in i)i.hasOwnProperty(r)&&(e[r]=i[r]);return e}}var Rh;(function(n){n[n.Background=0]="Background",n[n.Opaque=1]="Opaque"})(Rh||(Rh={}));class OB{constructor(e){this._api=e,this._urls$=new Map}getImage$(e){let t;const i=new Promise((r,o)=>{t=o});return[_r.create(r=>{this._api.data.getImageBuffer(e,i).then(o=>{t=null;const c=new Image;c.crossOrigin="Anonymous",c.onload=()=>{window.URL.revokeObjectURL(c.src),r.next(c),r.complete()},c.onerror=()=>{t=null,window.URL.revokeObjectURL(c.src),r.error(new Error("Failed to load image tile"))};const s=new Blob([o]);c.src=window.URL.createObjectURL(s)},o=>{t=null,r.error(o)})}),()=>{t&&t()}]}getURLs$(e,t){const i=this._inventId(e,t);if(this._urls$.has(i))return this._urls$.get(i);const r={imageId:e,z:t},o=this._api.getImageTiles$(r).pipe(st(c=>c.node),va(()=>{this._urls$.delete(i)}),Qa(),_i());return this._urls$.set(i,o),o}_inventId(e,t){return`${e}-${t}`}}class b2{constructor(){this._tiles=new Map,this._urlLevels=new Set,this._urls=new Map}add(e,t){if(this._tiles.has(e))throw new Error(`Image tile already stored (${e})`);this._tiles.set(e,t)}addURLs(e,t){const i=this._urls;for(const r of t){const o=this.inventId(r);if(this._urls.has(o))throw new Error(`URL already stored (${o})`);i.set(o,r.url)}this._urlLevels.add(e)}dispose(){this._tiles.forEach(e=>window.URL.revokeObjectURL(e.src)),this._tiles.clear(),this._urls.clear(),this._urlLevels.clear()}get(e){return this._tiles.get(e)}getURL(e){return this._urls.get(e)}has(e){return this._tiles.has(e)}hasURL(e){return this._urls.has(e)}hasURLLevel(e){return this._urlLevels.has(e)}inventId(e){return`${e.z}-${e.x}-${e.y}`}}class zB{constructor(){this._viewportCoords=new $o}computeRegionOfInterest(e,t,i){const r=this._viewportBoundaryPoints(4),o=this._viewportPointsBoundingBox(r,e,i);this._clipBoundingBox(o);const c=2/t.width,s=2/t.height,d=[[-.5*c,.5*s],[.5*c,.5*s],[.5*c,-.5*s],[-.5*c,-.5*s]],p=this._viewportPointsBoundingBox(d,e,i),g=p.minX<p.maxX;return{bbox:o,pixelHeight:p.maxY-p.minY,pixelWidth:p.maxX-p.minX+(g?0:1)}}_viewportBoundaryPoints(e){const t=[],i=[[-1,1],[1,1],[1,-1],[-1,-1]],r=[[2,0],[0,-2],[-2,0],[0,2]];for(let o=0;o<4;++o){const c=i[o],s=r[o];for(let d=0;d<e;++d)t.push([c[0]+s[0]*d/e,c[1]+s[1]*d/e])}return t}_viewportPointsBoundingBox(e,t,i){const r=e.map(o=>this._viewportCoords.viewportToBasic(o[0],o[1],i,t.perspective));return Di(i.cameraType)?this._boundingBoxSpherical(r):this._boundingBox(r)}_boundingBox(e){const t={maxX:Number.NEGATIVE_INFINITY,maxY:Number.NEGATIVE_INFINITY,minX:Number.POSITIVE_INFINITY,minY:Number.POSITIVE_INFINITY};for(let i=0;i<e.length;++i)t.minX=Math.min(t.minX,e[i][0]),t.maxX=Math.max(t.maxX,e[i][0]),t.minY=Math.min(t.minY,e[i][1]),t.maxY=Math.max(t.maxY,e[i][1]);return t}_boundingBoxSpherical(e){const t=[],i=[];for(let o=0;o<e.length;++o)t.push(e[o][0]),i.push(e[o][1]);t.sort((o,c)=>this._sign(o-c)),i.sort((o,c)=>this._sign(o-c));const r=this._intervalSpherical(t);return{maxX:r[1],maxY:i[i.length-1],minX:r[0],minY:i[0]}}_intervalSpherical(e){let t=0,i=-1;for(let o=0;o<e.length-1;++o){const c=e[o+1]-e[o];c>t&&(t=c,i=o)}return e[0]+1-e[e.length-1]>t?[e[0],e[e.length-1]]:[e[i+1],e[i]]}_clipBoundingBox(e){e.minX=Math.max(0,Math.min(1,e.minX)),e.maxX=Math.max(0,Math.min(1,e.maxX)),e.minY=Math.max(0,Math.min(1,e.minY)),e.maxY=Math.max(0,Math.min(1,e.maxY))}_sign(e){return e>0?1:e<0?-1:0}}const vne=11,BB=1024;function C3(n,e,t){return Math.max(e,Math.min(t,n))}function NB(n){return BB/uE(n)}function uE(n){return Math.pow(2,n.z-n.max)}function yne(n){const e=Math.max(n.w,n.h);return Math.log(e)/Math.log(2)}function $B(n){return Math.ceil(yne(n))}function bne(n,e,t){return Math.max(e,Math.min(t,$B(n)))}function E3(n,e,t){const i=NB(t),r=e.w,o=e.h,c=Math.ceil(r/i)-1,s=Math.ceil(o/i)-1,d=C3(Math.floor(r*n[0]/i),0,c),p=C3(Math.floor(o*n[1]/i),0,s);return{x:d,y:p}}function dM(n,e,t){const r=1/uE(t)*BB,o=r*n.x,c=r*n.y,s=Math.min(r,e.w-o);return{h:Math.min(r,e.h-c),x:o,y:c,w:s}}function A3(n,e,t){return t*n<=e&&e<t*(n+1)}function xne(n,e){if(n.z===e.z)return n.x===e.x&&n.y===e.y;const t=n.z<e.z?n:e,i=n.z<e.z?e:n,r=1/uE({max:i.z,z:t.z}),o=A3(t.x,i.x,r),c=A3(t.y,i.y,r);return o&&c}function wne(n,e,t,i){const r=[];if(n.x>e.x){const c=NB(i),s=Math.ceil(t.w/c)-1;for(let d=n.x;d<=s;d++)r.push(d);for(let d=0;d<=e.x;d++)r.push(d)}else for(let c=n.x;c<=e.x;c++)r.push(c);const o=[];for(const c of r)for(let s=n.y;s<=e.y;s++)o.push({x:c,y:s});return o}function P3(n){return n.w>0&&n.h>0}class x2{constructor(e,t,i,r,o,c,s){const d={h:i,w:t};P3(d)||console.warn(`Original image size (${t}, ${i}) is invalid (${e}). Tiles will not be loaded.`),this._imageId=e,this._size=d,this._level={max:$B(this._size),z:-1},this._holder=new wo,this._updated$=new ri,this._createdSubject$=new ri,this._created$=this._createdSubject$.pipe(Ii(1),_i()),this._holder.push(this._created$.subscribe(()=>{})),this._hasSubject$=new ri,this._has$=this._hasSubject$.pipe(An(!1),Ii(1),_i()),this._holder.push(this._has$.subscribe(()=>{})),this._renderedLevel=new Set,this._rendered=new Map,this._subscriptions=new Map,this._urlSubscriptions=new Map,this._loader=o,this._store=c,this._background=r,this._renderer=s,this._aborts=[],this._render=null,this._disposed=!1}get disposed(){return this._disposed}get hasTexture$(){return this._has$}get id(){return this._imageId}get textureUpdated$(){return this._updated$}get textureCreated$(){return this._created$}abort(){this._subscriptions.forEach(e=>e.unsubscribe()),this._subscriptions.clear();for(const e of this._aborts)e();this._aborts=[]}dispose(){if(this._disposed){console.warn(`Texture already disposed (${this._imageId})`);return}this._urlSubscriptions.forEach(e=>e.unsubscribe()),this._urlSubscriptions.clear(),this.abort(),this._render!=null&&(this._render.target.dispose(),this._render.target=null,this._render.camera=null,this._render=null),this._store.dispose(),this._holder.unsubscribe(),this._renderedLevel.clear(),this._background=null,this._renderer=null,this._disposed=!0}setRegionOfInterest(e){if(!P3(this._size))return;const t=1/e.pixelWidth,i=1/e.pixelHeight,r=bne({h:i,w:t},vne,this._level.max);r!==this._level.z&&(this.abort(),this._level.z=r,this._renderedLevel.clear(),this._rendered.forEach((d,p)=>{d.z===r&&this._renderedLevel.add(p)})),this._render==null&&this._initRender();const o=E3([e.bbox.minX,e.bbox.minY],this._size,this._level),c=E3([e.bbox.maxX,e.bbox.maxY],this._size,this._level),s=wne(o,c,this._size,this._level);this._fetchTiles(r,s)}_fetchTile(e){const t=this._loader.getImage$(e.url),i=t[0],r=t[1];this._aborts.push(r);const o=this._store.inventId(e),c=i.subscribe(s=>{const d=dM(e,this._size,this._level);this._renderToTarget(d,s),this._subscriptions.delete(o),this._removeFromArray(r,this._aborts),this._markRendered(e),this._store.add(o,s),this._updated$.next(!0)},s=>{this._subscriptions.delete(o),this._removeFromArray(r,this._aborts),console.error(s)});c.closed||this._subscriptions.set(o,c)}_fetchTiles(e,t){const r=(this._store.hasURLLevel(e)?Pi(void 0):this._loader.getURLs$(this._imageId,e).pipe(Dr(o=>{this._store.hasURLLevel(e)||this._store.addURLs(e,o)}))).subscribe(()=>{if(e===this._level.z){for(const o of t){const c={x:o.x,y:o.y,z:e,url:null},s=this._store.inventId(c);if(!(this._renderedLevel.has(s)||this._subscriptions.has(s))){if(this._store.has(s)){const d=dM(o,this._size,this._level);this._renderToTarget(d,this._store.get(s)),this._markRendered(c),this._updated$.next(!0);continue}c.url=this._store.getURL(s),this._fetchTile(c)}}this._urlSubscriptions.delete(e)}},o=>{this._urlSubscriptions.delete(e),console.error(o)});r.closed||this._urlSubscriptions.set(e,r)}_initRender(){const e=this._size.w/2,t=this._size.h/2,i=-1,r=1,o=new _1(-e,e,t,-t,i,r);o.position.z=1;const c=this._renderer.getContext(),s=c.getParameter(c.MAX_TEXTURE_SIZE),d=Math.max(this._size.w,this._size.h),p=s>d?1:s/d,g=Math.floor(p*this._size.w),_=Math.floor(p*this._size.h),x=new Cc(g,_,{depthBuffer:!1,format:up,magFilter:Fo,minFilter:Fo,stencilBuffer:!1});this._render={camera:o,target:x};const b=dM({x:0,y:0},this._size,{max:this._level.max,z:0});this._renderToTarget(b,this._background),this._createdSubject$.next(x.texture),this._hasSubject$.next(!0)}_markRendered(e){const t=Array.from(this._rendered.entries()).filter(([r,o])=>o.z!==e.z);for(const[r,o]of t)xne(e,o)&&this._rendered.delete(r);const i=this._store.inventId(e);this._rendered.set(i,e),this._renderedLevel.add(i)}_removeFromArray(e,t){const i=t.indexOf(e);i!==-1&&t.splice(i,1)}_renderToTarget(e,t){const i=new Bs(t);i.minFilter=Fo,i.needsUpdate=!0;const r=new g1(e.w,e.h),o=new g0({map:i,side:Hg}),c=new kr(r,o);c.position.x=-this._size.w/2+e.x+e.w/2,c.position.y=this._size.h/2-e.y-e.h/2;const s=new yh;s.add(c);const d=this._renderer.getRenderTarget();this._renderer.resetState(),this._renderer.setRenderTarget(this._render.target),this._renderer.render(s,this._render.camera),this._renderer.setRenderTarget(d),s.remove(c),r.dispose(),o.dispose(),i.dispose()}}var Bi;(function(n){n[n.Custom=0]="Custom",n[n.Earth=1]="Earth",n[n.Traversing=2]="Traversing",n[n.Waiting=3]="Waiting",n[n.WaitingInteractively=4]="WaitingInteractively"})(Bi||(Bi={}));class VB extends So{constructor(e,t,i){super(e,t,i),this._imageTileLoader=new OB(i.api),this._roiCalculator=new zB,this._rendererOperation$=new ri,this._rendererCreator$=new ri,this._rendererDisposer$=new ri,this._renderer$=this._rendererOperation$.pipe(Vr((r,o)=>o(r),null),ai(r=>r!=null),yi(void 0,r=>r.frameId)),this._rendererCreator$.pipe(st(()=>r=>{if(r!=null)throw new Error("Multiple image plane states can not be created at the same time");return new _ne})).subscribe(this._rendererOperation$),this._rendererDisposer$.pipe(st(()=>r=>(r.dispose(),null))).subscribe(this._rendererOperation$)}_activate(){const e=this._subscriptions;e.push(this._renderer$.pipe(st(d=>{const p={name:this._name,renderer:{frameId:d.frameId,needsRender:d.needsRender,render:d.render.bind(d),pass:Rh.Background}};return d.clearNeedsRender(),p})).subscribe(this._container.glRenderer.render$)),this._rendererCreator$.next(null),e.push(this._navigator.stateService.currentState$.pipe(st(d=>p=>(p.updateFrame(d),p))).subscribe(this._rendererOperation$));const t=this._container.configurationService.imageTiling$.pipe(ei(d=>d?this._navigator.stateService.currentState$:new ri),yi(void 0,d=>d.state.currentImage.id),Ui(this._container.glRenderer.webGLRenderer$),st(([d,p])=>{const g=d.state,_=g.currentImage,x=g.currentTransform;return new x2(_.id,x.basicWidth,x.basicHeight,_.image,this._imageTileLoader,new b2,p)}),Ii(1),_i());e.push(t.subscribe(()=>{})),e.push(t.pipe(st(d=>p=>(p.setTextureProvider(d.id,d),p))).subscribe(this._rendererOperation$)),e.push(t.pipe(rl()).subscribe(d=>{d[0].abort()}));const i=this._container.configurationService.imageTiling$.pipe(ei(d=>d?Si(this._navigator.stateService.state$,this._navigator.stateService.inTranslation$):new ri),ei(([d,p])=>(d===Bi.Traversing||d===Bi.Waiting||d===Bi.WaitingInteractively)&&!p?this._container.renderService.renderCameraFrame$:Ni()),st(d=>({camera:d,height:d.size.height.valueOf(),lookat:d.camera.lookat.clone(),width:d.size.width.valueOf(),zoom:d.zoom.valueOf()})),rl(),st(([d,p])=>{const g=d.width===p.width&&d.height===p.height&&d.zoom===p.zoom&&d.lookat.equals(p.lookat);return{camera:p.camera,stalled:g}}),yi((d,p)=>d.stalled===p.stalled),ai(d=>d.stalled),Ui(this._container.renderService.size$,this._navigator.stateService.currentTransform$));e.push(t.pipe(ei(d=>i.pipe(st(([p,g,_])=>{const x=p.camera,b=new $o().viewportToBasic(0,0,_,x.perspective);if(!(b[0]<0||b[1]<0||b[0]>1||b[1]>1))return[this._roiCalculator.computeRegionOfInterest(x,g,_),d]}),ai(p=>!!p))),ai(d=>!d[1].disposed)).subscribe(([d,p])=>{p.setRegionOfInterest(d)}));const r=t.pipe(ei(d=>d.hasTexture$),An(!1),Ii(1),_i());e.push(r.subscribe(()=>{})),e.push(this._navigator.panService.panImages$.pipe(ai(d=>d.length===0),st(()=>d=>(d.clearPeripheryPlanes(),d))).subscribe(this._rendererOperation$));const o=this._navigator.panService.panImages$.pipe(ei(d=>Fr(d).pipe(Hi(([p,g])=>Si(this._navigator.graphService.cacheImage$(p.id).pipe(Un(_=>(console.error(`Failed to cache periphery image (${p.id})`,_),Ni()))),Pi(g))))),pn());e.push(o.pipe(st(([d,p])=>g=>(g.addPeripheryPlane(d,p),g))).subscribe(this._rendererOperation$)),e.push(o.pipe(Hi(([d])=>d.cacheImage$().pipe(Un(()=>Ni()))),st(d=>p=>(p.updateTextureImage(d.image,d),p))).subscribe(this._rendererOperation$));const c=this._navigator.stateService.currentState$.pipe(st(d=>d.state.alpha<1),yi()),s=Si(this._container.mouseService.active$,this._container.touchService.active$,this._navigator.stateService.inMotion$,c).pipe(st(([d,p,g,_])=>!(d||p||g||_)),ai(d=>d));e.push(this._navigator.stateService.state$.pipe(ei(d=>d===Bi.Traversing?this._navigator.panService.panImages$:Ni()),ei(d=>s.pipe(Ui(this._container.renderService.renderCamera$,this._navigator.stateService.currentImage$,this._navigator.stateService.currentTransform$),Hi(([,p,g,_])=>Pi([p,g,_,d])))),ei(([d,p,g,_])=>{const x=d.camera.lookat.clone().sub(d.camera.position),P=[new xo().viewingDirection(p.rotation).angleTo(x),void 0],L=new $o().viewportToBasic(0,0,g,d.perspective);L[0]>=0&&L[0]<=1&&L[1]>=0&&L[1]<=1&&(P[0]=Number.NEGATIVE_INFINITY);for(const[E]of _){const D=new xo().viewingDirection(E.rotation).angleTo(x);D<P[0]&&(P[0]=D,P[1]=E.id)}return P[1]?this._navigator.moveTo$(P[1]).pipe(Un(()=>Ni())):Ni()})).subscribe())}_deactivate(){this._rendererDisposer$.next(null),this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{}}}VB.componentName="image";class Tu{constructor(e,t,i){this._component=e,this._container=t,this._navigator=i,this._enabled=!1}get isEnabled(){return this._enabled}enable(){this._enabled||!this._component.activated||(this._enable(),this._enabled=!0,this._component.configure(this._getConfiguration(!0)))}disable(){this._enabled&&(this._disable(),this._enabled=!1,this._component.activated&&this._component.configure(this._getConfiguration(!1)))}}class Sne extends Tu{_enable(){const e=this._navigator.stateService.currentImage$.pipe(ei(t=>t.sequenceEdges$));this._keyDownSubscription=this._container.keyboardService.keyDown$.pipe(Ui(e)).subscribe(([t,i])=>{let r=null;switch(t.keyCode){case 38:r=Vt.Next;break;case 40:r=Vt.Prev;break;default:return}if(t.preventDefault(),!(!t.altKey||t.shiftKey||!i.cached)){for(const o of i.edges)if(o.data.direction===r){this._navigator.moveTo$(o.target).subscribe(void 0,c=>{c instanceof Ul||console.error(c)});return}}})}_disable(){this._keyDownSubscription.unsubscribe()}_getConfiguration(e){return{keySequenceNavigation:e}}}class Tne extends Tu{constructor(e,t,i,r){super(e,t,i),this._spatial=r}_enable(){const e=this._navigator.stateService.currentImage$.pipe(ei(t=>t.spatialEdges$));this._keyDownSubscription=this._container.keyboardService.keyDown$.pipe(Ui(e,this._navigator.stateService.currentState$)).subscribe(([t,i,r])=>{let o=Di(r.state.currentImage.cameraType),c=null;switch(t.keyCode){case 37:c=t.shiftKey&&!o?Vt.TurnLeft:Vt.StepLeft;break;case 38:c=t.shiftKey&&!o?Vt.Spherical:Vt.StepForward;break;case 39:c=t.shiftKey&&!o?Vt.TurnRight:Vt.StepRight;break;case 40:c=t.shiftKey&&!o?Vt.TurnU:Vt.StepBackward;break;default:return}if(t.preventDefault(),!(t.altKey||!i.cached||t.shiftKey&&o))if(!o)this._moveDir(c,i);else{const s={};s[Vt.StepBackward]=Math.PI,s[Vt.StepForward]=0,s[Vt.StepLeft]=Math.PI/2,s[Vt.StepRight]=-Math.PI/2;const d=this._rotationFromCamera(r.state.camera).phi,p=this._spatial.wrapAngle(d+s[c]),g=Math.PI/4,_=i.edges.filter(S=>S.data.direction===Vt.Spherical||S.data.direction===c);let x=Number.MAX_VALUE,b=null;for(const S of _){const P=Math.abs(this._spatial.wrapAngle(S.data.worldMotionAzimuth-p));P<Math.min(x,g)&&(x=P,b=S.target)}if(b==null)return;this._moveTo(b)}})}_disable(){this._keyDownSubscription.unsubscribe()}_getConfiguration(e){return{keySpatialNavigation:e}}_moveDir(e,t){for(const i of t.edges)if(i.data.direction===e){this._moveTo(i.target);return}}_moveTo(e){this._navigator.moveTo$(e).subscribe(void 0,t=>{t instanceof Ul||console.error(t)})}_rotationFromCamera(e){let t=e.lookat.clone().sub(e.position),i=t.clone().dot(e.up),r=t.clone().sub(e.up.clone().multiplyScalar(i)),o=Math.atan2(r.y,r.x),c=Math.PI/2-this._spatial.angleToPlane(t.toArray(),[0,0,1]);return{phi:o,theta:c}}}class Mne extends Tu{constructor(e,t,i,r){super(e,t,i),this._viewportCoords=r}_enable(){this._keyDownSubscription=this._container.keyboardService.keyDown$.pipe(Ui(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$)).subscribe(([e,t,i])=>{if(e.altKey||e.ctrlKey||e.metaKey)return;let r=0;switch(e.key){case"+":r=1;break;case"-":r=-1;break;default:return}e.preventDefault();const o=this._viewportCoords.unprojectFromViewport(0,0,t.perspective),c=i.projectBasic(o.toArray());this._navigator.stateService.zoomIn(r,c)})}_disable(){this._keyDownSubscription.unsubscribe()}_getConfiguration(e){return{keyZoom:e}}}class Cne extends Tu{_enable(){this._keyDownSubscription=this._container.keyboardService.keyDown$.pipe(Ui(this._navigator.playService.playing$,this._navigator.playService.direction$,this._navigator.playService.speed$,this._navigator.stateService.currentImage$.pipe(ei(e=>e.sequenceEdges$)),this._navigator.stateService.state$.pipe(st(e=>e===Bi.Earth),yi()))).subscribe(([e,t,i,r,o,c])=>{if(!(e.altKey||e.ctrlKey||e.metaKey)){switch(e.key){case"D":if(!e.shiftKey)return;const s=t?null:i===Vt.Next?Vt.Prev:i===Vt.Prev?Vt.Next:null;s!=null&&this._navigator.playService.setDirection(s);break;case" ":if(e.shiftKey)return;if(!c)if(t)this._navigator.playService.stop();else for(let d of o.edges)d.data.direction===i&&this._navigator.playService.play();break;case"<":this._navigator.playService.setSpeed(r-.05);break;case">":this._navigator.playService.setSpeed(r+.05);break;default:return}e.preventDefault()}})}_disable(){this._keyDownSubscription.unsubscribe()}_getConfiguration(e){return{keyPlay:e}}}class UB extends So{constructor(e,t,i){super(e,t,i),this._keyPlayHandler=new Cne(this,t,i),this._keySequenceNavigationHandler=new Sne(this,t,i),this._keySpatialNavigationHandler=new Tne(this,t,i,new xo),this._keyZoomHandler=new Mne(this,t,i,new $o)}get keyPlay(){return this._keyPlayHandler}get keySequenceNavigation(){return this._keySequenceNavigationHandler}get keySpatialNavigation(){return this._keySpatialNavigationHandler}get keyZoom(){return this._keyZoomHandler}_activate(){this._subscriptions.push(this._configuration$.subscribe(e=>{e.keyPlay?this._keyPlayHandler.enable():this._keyPlayHandler.disable(),e.keySequenceNavigation?this._keySequenceNavigationHandler.enable():this._keySequenceNavigationHandler.disable(),e.keySpatialNavigation?this._keySpatialNavigationHandler.enable():this._keySpatialNavigationHandler.disable(),e.keyZoom?this._keyZoomHandler.enable():this._keyZoomHandler.disable()}))}_deactivate(){this._subscriptions.unsubscribe(),this._keyPlayHandler.disable(),this._keySequenceNavigationHandler.disable(),this._keySpatialNavigationHandler.disable(),this._keyZoomHandler.disable()}_getDefaultConfiguration(){return{keyPlay:!0,keySequenceNavigation:!0,keySpatialNavigation:!0,keyZoom:!0}}}UB.componentName="keyboard";class Ene{constructor(e,t){this._needsRender=!1,this._interactiveObjects=[],this._markers={},this._objectMarkers={},this._raycaster=t||new Lw,this._scene=e||new yh}get markers(){return this._markers}get needsRender(){return this._needsRender}add(e,t){e.id in this._markers&&this._dispose(e.id),e.createGeometry(t),this._scene.add(e.geometry),this._markers[e.id]=e;for(let i of e.getInteractiveObjects())this._interactiveObjects.push(i),this._objectMarkers[i.uuid]=e.id;this._needsRender=!0}clear(){for(const e in this._markers)this._markers.hasOwnProperty&&this._dispose(e);this._needsRender=!0}get(e){return this._markers[e]}getAll(){return Object.keys(this._markers).map(e=>this._markers[e])}has(e){return e in this._markers}intersectObjects([e,t],i){this._raycaster.setFromCamera(new li(e,t),i);const r=this._raycaster.intersectObjects(this._interactiveObjects);for(const o of r)if(o.object.uuid in this._objectMarkers)return this._objectMarkers[o.object.uuid];return null}lerpAltitude(e,t,i){e in this._markers&&(this._markers[e].lerpAltitude(t,i),this._needsRender=!0)}remove(e){e in this._markers&&(this._dispose(e),this._needsRender=!0)}render(e,t){t.render(this._scene,e),this._needsRender=!1}update(e,t,i){if(!(e in this._markers))return;this._markers[e].updatePosition(t,i),this._needsRender=!0}_dispose(e){const t=this._markers[e];this._scene.remove(t.geometry);for(let i of t.getInteractiveObjects()){const r=this._interactiveObjects.indexOf(i);r!==-1?this._interactiveObjects.splice(r,1):console.warn(`Object does not exist (${i.id}) for ${e}`),delete this._objectMarkers[i.uuid]}t.disposeGeometry(),delete this._markers[e]}}class jB extends So{constructor(e,t,i){super(e,t,i),this._graphCalculator=new eE,this._markerScene=new Ene,this._markerSet=new Wy,this._viewportCoords=new $o,this._relativeGroundAltitude=-2}add(e){this._markerSet.add(e)}fire(e,t){super.fire(e,t)}get(e){return this._markerSet.get(e)}getAll(){return this._markerSet.getAll()}getMarkerIdAt(e){return new Promise((t,i)=>{this._container.renderService.renderCamera$.pipe(wi(),st(r=>{const o=this._viewportCoords.canvasToViewport(e[0],e[1],this._container.container);return this._markerScene.intersectObjects(o,r.perspective)})).subscribe(r=>{t(r)},r=>{i(r)})})}has(e){return this._markerSet.has(e)}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}remove(e){this._markerSet.remove(e)}removeAll(){this._markerSet.removeAll()}_activate(){const e=this._navigator.stateService.currentState$.pipe(st(S=>S.state.camera.position.z+this._relativeGroundAltitude),yi((S,P)=>Math.abs(S-P)<.01),Ii(1),_i()),t=Si(e,this._navigator.stateService.reference$).pipe(wi(),st(()=>{}),Ii(1),_i()),i=this._configuration$.pipe(st(S=>({visibleBBoxSize:Math.max(1,Math.min(200,S.visibleBBoxSize))}))),r=this._navigator.stateService.currentImage$.pipe(st(S=>S.lngLat),Ii(1),_i()),o=Si(i,r).pipe(st(([S,P])=>this._graphCalculator.boundingBoxCorners(P,S.visibleBBoxSize/2)),Ii(1),_i()),c=Si(jl(Pi(this._markerSet),this._markerSet.changed$),o).pipe(st(([S,P])=>S.search(P))),s=this._subscriptions;s.push(t.pipe(ei(()=>c.pipe(Ui(this._navigator.stateService.reference$,e)))).subscribe(([S,P,L])=>{const E=this._markerScene,C=E.markers,D=Object.assign({},C);for(const O of S)if(O.id in C)delete D[O.id];else{const U=ra(O.lngLat.lng,O.lngLat.lat,P.alt+L,P.lng,P.lat,P.alt);E.add(O,U)}for(const O in D)D.hasOwnProperty(O)&&E.remove(O)})),s.push(t.pipe(ei(()=>this._markerSet.updated$.pipe(Ui(o,this._navigator.stateService.reference$,e)))).subscribe(([S,[P,L],E,C])=>{const D=this._markerScene;for(const O of S){const U=D.has(O.id),j=O.lngLat.lat>P.lat&&O.lngLat.lat<L.lat&&O.lngLat.lng>P.lng&&O.lngLat.lng<L.lng;if(j){const G=ra(O.lngLat.lng,O.lngLat.lat,E.alt+C,E.lng,E.lat,E.alt);D.add(O,G)}else!j&&U&&D.remove(O.id)}})),s.push(this._navigator.stateService.reference$.pipe(Ks(1),Ui(e)).subscribe(([S,P])=>{const L=this._markerScene;for(const E of L.getAll()){const C=ra(E.lngLat.lng,E.lngLat.lat,S.alt+P,S.lng,S.lat,S.alt);L.update(E.id,C)}})),s.push(e.pipe(Ks(1),Ui(this._navigator.stateService.reference$,r)).subscribe(([S,P,L])=>{const E=this._markerScene,C=ra(L.lng,L.lat,P.alt+S,P.lng,P.lat,P.alt);for(const D of E.getAll()){const O=ra(D.lngLat.lng,D.lngLat.lat,P.alt+S,P.lng,P.lat,P.alt),U=O[0]-C[0],j=O[1]-C[1],G=Math.sqrt(U*U+j*j);G>50||E.lerpAltitude(D.id,S,Math.min(1,Math.max(0,1.2-1.2*G/50)))}})),s.push(this._navigator.stateService.currentState$.pipe(st(S=>{const P=this._markerScene;return{name:this._name,renderer:{frameId:S.id,needsRender:P.needsRender,render:P.render.bind(P),pass:Rh.Opaque}}})).subscribe(this._container.glRenderer.render$));const d=Si(this._container.renderService.renderCamera$,this._container.mouseService.mouseMove$).pipe(st(([S,P])=>{const L=this._container.container,[E,C]=this._viewportCoords.canvasPosition(P,L),D=this._viewportCoords.canvasToViewport(E,C,L);return this._markerScene.intersectObjects(D,S.perspective)}),Ii(1),_i()),p=this._container.mouseService.filtered$(this._name,this._container.mouseService.mouseDragStart$).pipe(st(()=>!0)),g=this._container.mouseService.filtered$(this._name,this._container.mouseService.mouseDragEnd$).pipe(st(()=>!1)),_=mn(p,g).pipe(An(!1));s.push(mn(p.pipe(Ui(d)),Si(g,Pi(null))).pipe(An([!1,null]),rl()).subscribe(([S,P])=>{const L=P[0],E=L?"markerdragstart":"markerdragend",C=L?P[1]:S[1],O={marker:this._markerScene.get(C),target:this,type:E};this.fire(E,O)}));const x=mn(this._container.mouseService.mouseDown$.pipe(st(()=>!0)),this._container.mouseService.documentMouseUp$.pipe(st(()=>!1))).pipe(An(!1));s.push(Si(this._container.mouseService.active$,d.pipe(yi()),x,_).pipe(st(([S,P,L,E])=>!S&&P!=null&&L||E),yi()).subscribe(S=>{S?(this._container.mouseService.claimMouse(this._name,1),this._container.mouseService.claimWheel(this._name,1)):(this._container.mouseService.unclaimMouse(this._name),this._container.mouseService.unclaimWheel(this._name))}));const b=this._container.mouseService.filtered$(this._name,this._container.mouseService.mouseDragStart$).pipe(Ui(d,this._container.renderService.renderCamera$),st(([S,P,L])=>{const E=this._markerScene.get(P),C=this._container.container,[D,O]=this._viewportCoords.projectToCanvas(E.geometry.position.toArray(),C,L.perspective),[U,j]=this._viewportCoords.canvasPosition(S,C),G=[U-D,j-O];return[E,G,L]}),Ii(1),_i());s.push(this._container.mouseService.filtered$(this._name,this._container.mouseService.mouseDrag$).pipe(Ui(b,this._navigator.stateService.reference$,i)).subscribe(([S,[P,L,E],C,D])=>{if(!this._markerScene.has(P.id))return;const O=this._container.container,[U,j]=this._viewportCoords.canvasPosition(S,O),G=U-L[0],N=j-L[1],[V,q]=this._viewportCoords.canvasToViewport(G,N,O),z=new Ge(V,q,1).unproject(E.perspective).sub(E.perspective.position).normalize(),Q=Math.min(this._relativeGroundAltitude/z.z,D.visibleBBoxSize/2-.1);if(Q<0)return;const X=z.clone().multiplyScalar(Q).add(E.perspective.position);X.z=E.perspective.position.z+this._relativeGroundAltitude;const[re,oe]=vp(X.x,X.y,X.z,C.lng,C.lat,C.alt);this._markerScene.update(P.id,X.toArray(),{lat:oe,lng:re}),this._markerSet.update(P);const de="markerposition",ce={marker:P,target:this,type:de};this.fire(de,ce)}))}_deactivate(){this._subscriptions.unsubscribe(),this._markerScene.clear()}_getDefaultConfiguration(){return{visibleBBoxSize:100}}}jB.componentName="marker";function Ane(n){return n>0?1:n<0?-1:0}function Sx(n,e){return n.x<=Math.max(e.p1.x,e.p2.x)&&n.x>=Math.min(e.p1.x,e.p2.x)&&n.y>=Math.max(e.p1.y,e.p2.y)&&n.y>=Math.min(e.p1.y,e.p2.y)}function GB(n,e){const t=n.p2.x-n.p1.x,i=n.p2.y-n.p1.y,r=e.p2.x-e.p1.x,o=e.p2.y-e.p1.y,c=t*o-i*r,s=t*t+i*i,d=r*r+o*o;return c*c<1e-10*s*d}function Tx(n,e,t){const i=(e.y-n.y)*(t.x-e.x)-(t.y-e.y)*(e.x-n.x);return Ane(i)}function Pne(n,e){if(GB(n,e))return!1;const t=Tx(n.p1,n.p2,e.p1),i=Tx(n.p1,n.p2,e.p2),r=Tx(e.p1,e.p2,n.p1),o=Tx(e.p1,e.p2,n.p2);return!!(t!==i&&r!==o||t===0&&Sx(e.p1,n)||i===0&&Sx(e.p2,n)||r===0&&Sx(n.p1,e)||o===0&&Sx(n.p2,e))}function Ine(n,e){if(GB(n,e))return;const t=n.p1.x,i=n.p2.x,r=n.p1.y,o=n.p2.y,c=e.p1.x,s=e.p2.x,d=e.p1.y,p=e.p2.y,g=(t-i)*(d-p)-(r-o)*(c-s),_=(t*o-r*i)*(c-s)-(t-i)*(c*p-d*s),x=(t*o-r*i)*(d-p)-(r-o)*(c*p-d*s);return{x:_/g,y:x/g}}function Rne(n){let e=[],t=[[0,0],[1,0],[1,1],[0,1]],i=[[1,0],[0,1],[-1,0],[0,-1]];for(let r=0;r<4;++r){let o=t[r],c=i[r];for(let s=0;s<n;++s)e.push([o[0]+c[0]*s/n,o[1]+c[1]*s/n])}return e}function fM(n,e){return n>=-1&&n<=1&&e>=-1&&e<=1}function Mx(n,e){return n>=0&&n<=1&&e>=0&&e<=1}function Bw(n,e,t){const r=Rne(100).map(D=>t.basicToViewportSafe(D[0],D[1],n,e)),o=[],c=[{x:-1,y:1},{x:1,y:1},{x:1,y:-1},{x:-1,y:-1}],s=[!1,!1,!1,!1];for(let D=0;D<r.length;D++){const O=r[D],U=r[(D+1)%r.length];if(O===null)continue;if(U===null){fM(O[0],O[1])&&o.push(O);continue}const[j,G]=O,[N,V]=U;if(fM(j,G))if(fM(N,V))o.push(O);else for(let q=0;q<4;q++){const z={p1:{x:j,y:G},p2:{x:N,y:V}},Q={p1:c[q],p2:c[(q+1)%4]};if(Pne(z,Q)){const re=Ine(z,Q);o.push(O,[re.x,re.y]),s[q]=!0}}}const[d,p]=t.viewportToBasic(-1,1,n,e),[g,_]=t.viewportToBasic(1,1,n,e),[x,b]=t.viewportToBasic(1,-1,n,e),[S,P]=t.viewportToBasic(-1,-1,n,e);Mx(d,p)&&(s[3]=s[0]=!0),Mx(g,_)&&(s[0]=s[1]=!0),Mx(x,b)&&(s[1]=s[2]=!0),Mx(S,P)&&(s[2]=s[3]=!0);const L=[-1,-1,1,1];for(let D of o){const O=D[0],U=D[1];O>L[1]&&(L[1]=O),O<L[3]&&(L[3]=O),U>L[0]&&(L[0]=U),U<L[2]&&(L[2]=U)}const E=[1,1,-1,-1],C=[];for(let D=0;D<4;D++){if(s[D]){C.push(0);continue}C.push(Math.abs(E[D]-L[D]))}return C}class Lne extends Tu{constructor(e,t,i,r,o){super(e,t,i),this._spatial=o,this._viewportCoords=r}_enable(){const e=this._navigator.stateService.currentState$.pipe(st(t=>t.state.alpha<1),yi());this._bounceSubscription=Si(e,this._navigator.stateService.inTranslation$,this._container.mouseService.active$,this._container.touchService.active$).pipe(st(t=>t[0]||t[1]||t[2]||t[3]),yi(),ei(t=>t?Ni():Si(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$.pipe(wi()))),Ui(this._navigator.panService.panImages$)).subscribe(([[t,i],r])=>{if(!i.hasValidScale&&t.camera.focal<.1||t.perspective.aspect===0||t.perspective.aspect===Number.POSITIVE_INFINITY)return;const o=Bw(i,t.perspective,this._viewportCoords),c=this._viewportCoords.viewportToBasic(0,0,i,t.perspective);(c[0]<0||c[0]>1)&&r.length>0&&(o[0]=o[2]=0);for(const[,L]of r){const E=Bw(L,t.perspective,this._viewportCoords);for(let C=1;C<o.length;C+=2)E[C]<o[C]&&(o[C]=E[C])}if(Math.max(...o)<.01)return;const s=o[1]-o[3],d=o[0]-o[2],p=this._viewportCoords.unprojectFromViewport(0,0,t.perspective).sub(t.perspective.position),g=this._viewportCoords.unprojectFromViewport(s,0,t.perspective).sub(t.perspective.position),_=this._viewportCoords.unprojectFromViewport(0,d,t.perspective).sub(t.perspective.position);let x=(s>0?1:-1)*g.angleTo(p),b=(d>0?1:-1)*_.angleTo(p);const S=Math.PI/60,P=.1;x=this._spatial.clamp(P*x,-S,S),b=this._spatial.clamp(P*b,-S,S),this._navigator.stateService.rotateUnbounded({phi:x,theta:b})})}_disable(){this._bounceSubscription.unsubscribe()}_getConfiguration(){return{}}}class Jx{static filteredPairwiseMouseDrag$(e,t){return this._filteredPairwiseMouseDrag$(e,t,t.mouseDragStart$,t.mouseDrag$,t.mouseDragEnd$)}static filteredPairwiseMouseRightDrag$(e,t){return this._filteredPairwiseMouseDrag$(e,t,t.mouseRightDragStart$,t.mouseRightDrag$,t.mouseRightDragEnd$)}static _filteredPairwiseMouseDrag$(e,t,i,r,o){return t.filtered$(e,i).pipe(ei(c=>{const s=jl(Pi(c),t.filtered$(e,r)),d=t.filtered$(e,o).pipe(st(()=>null));return mn(s,d).pipe(HO(p=>!!p),An(null))}),rl(),ai(c=>c[0]!=null&&c[1]!=null))}}class kne extends Tu{constructor(e,t,i,r,o){super(e,t,i),this._spatial=o,this._viewportCoords=r}_enable(){let e=this._container.mouseService.filtered$(this._component.name,this._container.mouseService.mouseDragStart$).pipe(st(()=>!0),pn()),t=this._container.mouseService.filtered$(this._component.name,this._container.mouseService.mouseDragEnd$).pipe(st(()=>!1),pn());this._activeMouseSubscription=mn(e,t).subscribe(this._container.mouseService.activate$);const i=mn(e,t).pipe(ei(s=>s?this._container.mouseService.documentMouseMove$:Ni()));this._preventDefaultSubscription=mn(i,this._container.touchService.touchMove$).subscribe(s=>{s.preventDefault()});let r=this._container.touchService.singleTouchDragStart$.pipe(st(()=>!0)),o=this._container.touchService.singleTouchDragEnd$.pipe(st(()=>!1));this._activeTouchSubscription=mn(r,o).subscribe(this._container.touchService.activate$);const c=this._navigator.stateService.currentState$.pipe(st(s=>Di(s.state.currentImage.cameraType)||s.state.imagesAhead<1),yi(),ei(s=>{if(!s)return Ni();const d=Jx.filteredPairwiseMouseDrag$(this._component.name,this._container.mouseService),p=mn(this._container.touchService.singleTouchDragStart$,this._container.touchService.singleTouchDrag$,this._container.touchService.singleTouchDragEnd$.pipe(st(()=>null))).pipe(st(g=>g!=null&&g.touches.length>0?g.touches[0]:null),rl(),ai(g=>g[0]!=null&&g[1]!=null));return mn(d,p)}),Ui(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$,this._navigator.panService.panImages$),st(([s,d,p,g])=>{let _=s[0],x=s[1],b=x.clientX-_.clientX,S=x.clientY-_.clientY,P=this._container.container,[L,E]=this._viewportCoords.canvasPosition(x,P),C=this._viewportCoords.unprojectFromCanvas(L,E,P,d.perspective).sub(d.perspective.position),D=this._viewportCoords.unprojectFromCanvas(L-b,E,P,d.perspective).sub(d.perspective.position),O=this._viewportCoords.unprojectFromCanvas(L,E-S,P,d.perspective).sub(d.perspective.position),U=(b>0?1:-1)*D.angleTo(C),j=(S>0?-1:1)*O.angleTo(C);const G=Bw(p,d.perspective,this._viewportCoords);for(const[,N]of g){const V=Bw(N,d.perspective,this._viewportCoords);for(let q=0;q<G.length;q++)V[q]<G[q]&&(G[q]=V[q])}return G[0]>0&&j<0&&(j/=Math.max(1,200*G[0])),G[2]>0&&j>0&&(j/=Math.max(1,200*G[2])),G[1]>0&&U<0&&(U/=Math.max(1,200*G[1])),G[3]>0&&U>0&&(U/=Math.max(1,200*G[3])),{phi:U,theta:j}}),pn());this._rotateWithoutInertiaSubscription=c.subscribe(s=>{this._navigator.stateService.rotateWithoutInertia(s)}),this._rotateSubscription=c.pipe(Vr((s,d)=>(this._drainBuffer(s),s.push([Date.now(),d]),s),[]),HW(mn(this._container.mouseService.filtered$(this._component.name,this._container.mouseService.mouseDragEnd$),this._container.touchService.singleTouchDragEnd$)),st(s=>{const d=this._drainBuffer(s.slice()),p={phi:0,theta:0};for(const x of d)p.phi+=x[1].phi,p.theta+=x[1].theta;const g=d.length;g>0&&(p.phi/=g,p.theta/=g);const _=Math.PI/18;return p.phi=this._spatial.clamp(p.phi,-_,_),p.theta=this._spatial.clamp(p.theta,-_,_),p})).subscribe(s=>{this._navigator.stateService.rotate(s)})}_disable(){this._activeMouseSubscription.unsubscribe(),this._activeTouchSubscription.unsubscribe(),this._preventDefaultSubscription.unsubscribe(),this._rotateSubscription.unsubscribe(),this._rotateWithoutInertiaSubscription.unsubscribe(),this._activeMouseSubscription=null,this._activeTouchSubscription=null,this._preventDefaultSubscription=null,this._rotateSubscription=null}_getConfiguration(e){return{dragPan:e}}_drainBuffer(e){const i=Date.now();for(;e.length>0&&i-e[0][0]>50;)e.shift();return e}}class Dne extends Tu{constructor(e,t,i,r,o){super(e,t,i),this._spatial=o,this._viewportCoords=r,this._subscriptions=new wo}_enable(){const e=this._navigator.stateService.state$.pipe(st(i=>i===Bi.Earth),Ii(1),_i()),t=this._subscriptions;t.push(e.pipe(ei(i=>i?this._container.mouseService.mouseWheel$:Ni())).subscribe(i=>{i.preventDefault()})),t.push(e.pipe(ei(i=>i?Jx.filteredPairwiseMouseDrag$(this._component.name,this._container.mouseService).pipe(ai(([r,o])=>!(r.ctrlKey&&o.ctrlKey))):Ni()),Ui(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$),st(([[i,r],o,c])=>{const s=[0,0,1],d=[0,0,-2],p=this._planeIntersection(r,s,d,o.perspective,this._container.container),g=this._planeIntersection(i,s,d,o.perspective,this._container.container);return!p||!g?null:new Ge().subVectors(p,g).multiplyScalar(-1).toArray()}),ai(i=>!!i)).subscribe(i=>{this._navigator.stateService.truck(i)})),t.push(e.pipe(ei(i=>i?Jx.filteredPairwiseMouseDrag$(this._component.name,this._container.mouseService).pipe(ai(([r,o])=>r.ctrlKey&&o.ctrlKey)):Ni()),st(([i,r])=>this._mousePairToRotation(i,r))).subscribe(i=>{this._navigator.stateService.orbit(i)})),t.push(e.pipe(ei(i=>i?Jx.filteredPairwiseMouseRightDrag$(this._component.name,this._container.mouseService).pipe(ai(([r,o])=>!r.ctrlKey&&!o.ctrlKey)):Ni()),st(([i,r])=>this._mousePairToRotation(i,r))).subscribe(i=>{this._navigator.stateService.orbit(i)})),t.push(e.pipe(ei(i=>i?this._container.mouseService.filteredWheel$(this._component.name,this._container.mouseService.mouseWheel$):Ni()),st(i=>{let r=i.deltaY;i.deltaMode===1?r=40*r:i.deltaMode===2&&(r=800*r);const o=this._viewportCoords.containerToCanvas(this._container.container);return-r/o[1]})).subscribe(i=>{this._navigator.stateService.dolly(i)}))}_disable(){this._subscriptions.unsubscribe()}_getConfiguration(){return{}}_eventToViewport(e,t){const i=this._viewportCoords.canvasPosition(e,t);return this._viewportCoords.canvasToViewport(i[0],i[1],t)}_mousePairToRotation(e,t){const[i,r]=this._eventToViewport(t,this._container.container),[o,c]=this._eventToViewport(e,this._container.container),s=(o-i)*Math.PI,d=(r-c)*Math.PI/2;return{phi:s,theta:d}}_planeIntersection(e,t,i,r,o){const[c,s]=this._viewportCoords.canvasPosition(e,o),d=this._viewportCoords.unprojectFromCanvas(c,s,o,r).sub(r.position).normalize();if(Math.abs(this._spatial.angleToPlane(d.toArray(),t))<Math.PI/90)return null;const p=r.position.clone(),g=new Ge().fromArray(t),_=new Ge().fromArray(i),x=new Ge().subVectors(_,p).dot(g)/d.clone().dot(g),b=new Ge().addVectors(p,d.multiplyScalar(x));return this._viewportCoords.worldToCamera(b.toArray(),r)[2]>0?null:b}}class Fne extends Tu{constructor(e,t,i,r){super(e,t,i),this._viewportCoords=r}_enable(){this._container.mouseService.claimWheel(this._component.name,0),this._preventDefaultSubscription=this._container.mouseService.mouseWheel$.subscribe(e=>{e.preventDefault()}),this._zoomSubscription=this._container.mouseService.filteredWheel$(this._component.name,this._container.mouseService.mouseWheel$).pipe(Ui(this._navigator.stateService.currentState$,(e,t)=>[e,t]),ai(e=>{let t=e[1].state;return Di(t.currentImage.cameraType)||t.imagesAhead<1}),st(e=>e[0]),Ui(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$,(e,t,i)=>[e,t,i])).subscribe(e=>{let t=e[0],i=e[1],r=e[2],o=this._container.container,[c,s]=this._viewportCoords.canvasPosition(t,o),d=this._viewportCoords.unprojectFromCanvas(c,s,o,i.perspective),p=r.projectBasic(d.toArray()),g=t.deltaY;t.deltaMode===1?g=40*g:t.deltaMode===2&&(g=800*g);const _=this._viewportCoords.containerToCanvas(o);let x=-3*g/_[1];this._navigator.stateService.zoomIn(x,p)})}_disable(){this._container.mouseService.unclaimWheel(this._component.name),this._preventDefaultSubscription.unsubscribe(),this._zoomSubscription.unsubscribe(),this._preventDefaultSubscription=null,this._zoomSubscription=null}_getConfiguration(e){return{scrollZoom:e}}}class One extends Tu{constructor(e,t,i,r){super(e,t,i),this._viewportCoords=r}_enable(){this._preventDefaultSubscription=this._container.touchService.pinch$.subscribe(i=>{i.originalEvent.preventDefault()});let e=this._container.touchService.pinchStart$.pipe(st(i=>!0)),t=this._container.touchService.pinchEnd$.pipe(st(i=>!1));this._activeSubscription=mn(e,t).subscribe(this._container.touchService.activate$),this._zoomSubscription=this._container.touchService.pinch$.pipe(Ui(this._navigator.stateService.currentState$),ai(i=>{let r=i[1].state;return Di(r.currentImage.cameraType)||r.imagesAhead<1}),st(i=>i[0]),Ui(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$)).subscribe(([i,r,o])=>{let c=this._container.container,[s,d]=this._viewportCoords.canvasPosition(i,c),p=this._viewportCoords.unprojectFromCanvas(s,d,c,r.perspective),g=o.projectBasic(p.toArray());const[_,x]=this._viewportCoords.containerToCanvas(c);let b=3*i.distanceChange/Math.min(_,x);this._navigator.stateService.zoomIn(b,g)})}_disable(){this._activeSubscription.unsubscribe(),this._preventDefaultSubscription.unsubscribe(),this._zoomSubscription.unsubscribe(),this._preventDefaultSubscription=null,this._zoomSubscription=null}_getConfiguration(e){return{touchZoom:e}}}class qB extends So{constructor(e,t,i){super(e,t,i);const r=new xo,o=new $o;this._bounceHandler=new Lne(this,t,i,o,r),this._dragPanHandler=new kne(this,t,i,o,r),this._earthControlHandler=new Dne(this,t,i,o,r),this._scrollZoomHandler=new Fne(this,t,i,o),this._touchZoomHandler=new One(this,t,i,o)}get dragPan(){return this._dragPanHandler}get earthControl(){return this._earthControlHandler}get scrollZoom(){return this._scrollZoomHandler}get touchZoom(){return this._touchZoomHandler}_activate(){this._bounceHandler.enable(),this._subscriptions.push(this._configuration$.subscribe(e=>{e.dragPan?this._dragPanHandler.enable():this._dragPanHandler.disable(),e.earthControl?this._earthControlHandler.enable():this._earthControlHandler.disable(),e.scrollZoom?this._scrollZoomHandler.enable():this._scrollZoomHandler.disable(),e.touchZoom?this._touchZoomHandler.enable():this._touchZoomHandler.disable()})),this._container.mouseService.claimMouse(this._name,0)}_deactivate(){this._container.mouseService.unclaimMouse(this._name),this._subscriptions.unsubscribe(),this._bounceHandler.disable(),this._dragPanHandler.disable(),this._earthControlHandler.disable(),this._scrollZoomHandler.disable(),this._touchZoomHandler.disable()}_getDefaultConfiguration(){return{dragPan:!0,earthControl:!0,scrollZoom:!0,touchZoom:!0}}}qB.componentName="pointer";class hE{constructor(e){this._document=e||document}get document(){return this._document}createElement(e,t,i){const r=this._document.createElement(e);return t&&(r.className=t),i&&i.appendChild(r),r}}class WB extends So{constructor(e,t,i,r){super(e,t,i),this._dom=r||new hE,this._popups=[],this._added$=new ri,this._popups$=new ri}add(e){for(const t of e)this._popups.indexOf(t)===-1&&(this._popups.push(t),this._activated&&t.setParentContainer(this._popupContainer));this._added$.next(e),this._popups$.next(this._popups)}getAll(){return this._popups.slice()}remove(e){for(const t of e)this._remove(t);this._popups$.next(this._popups)}removeAll(){for(const e of this._popups.slice())this._remove(e);this._popups$.next(this._popups)}_activate(){this._popupContainer=this._dom.createElement("div","mapillary-popup-container",this._container.container);for(const i of this._popups)i.setParentContainer(this._popupContainer);const e=this._subscriptions;e.push(Si(this._container.renderService.renderCamera$,this._container.renderService.size$,this._navigator.stateService.currentTransform$).subscribe(([i,r,o])=>{for(const c of this._popups)c.update(i,r,o)}));const t=this._popups$.pipe(An(this._popups),ei(i=>Fr(i).pipe(Hi(r=>r.changed$))),st(i=>[i]));e.push(mn(this._added$,t).pipe(Ui(this._container.renderService.renderCamera$,this._container.renderService.size$,this._navigator.stateService.currentTransform$)).subscribe(([i,r,o,c])=>{for(const s of i)s.update(r,o,c)}))}_deactivate(){this._subscriptions.unsubscribe();for(const e of this._popups)e.remove();this._container.container.removeChild(this._popupContainer),delete this._popupContainer}_getDefaultConfiguration(){return{}}_remove(e){const t=this._popups.indexOf(e);if(t===-1)return;const i=this._popups.splice(t,1)[0];this._activated&&i.remove()}}WB.componentName="popup";var oa;(function(n){n[n.Sequence=0]="Sequence",n[n.Spatial=1]="Spatial"})(oa||(oa={}));var po;(function(n){n[n.Default=0]="Default",n[n.Playback=1]="Playback",n[n.Timeline=2]="Timeline"})(po||(po={}));class zne{constructor(e){this._container=e,this._minThresholdWidth=320,this._maxThresholdWidth=1480,this._minThresholdHeight=240,this._maxThresholdHeight=820,this._stepperDefaultWidth=108,this._controlsDefaultWidth=88,this._defaultHeight=30,this._expandControls=!1,this._mode=po.Default,this._speed=.5,this._changingSpeed=!1,this._index=null,this._changingPosition=!1,this._mouseEnterDirection$=new ri,this._mouseLeaveDirection$=new ri,this._notifyChanged$=new ri,this._notifyChangingPositionChanged$=new ri,this._notifySpeedChanged$=new ri,this._notifyIndexChanged$=new ri}get changed$(){return this._notifyChanged$}get changingPositionChanged$(){return this._notifyChangingPositionChanged$}get speed$(){return this._notifySpeedChanged$}get index$(){return this._notifyIndexChanged$}get mouseEnterDirection$(){return this._mouseEnterDirection$}get mouseLeaveDirection$(){return this._mouseLeaveDirection$}activate(){this._changingSubscription||(this._changingSubscription=mn(this._container.mouseService.documentMouseUp$,this._container.touchService.touchEnd$.pipe(ai(e=>e.touches.length===0))).subscribe(()=>{this._changingSpeed&&(this._changingSpeed=!1),this._changingPosition&&this._setChangingPosition(!1)}))}deactivate(){this._changingSubscription&&(this._changingSpeed=!1,this._changingPosition=!1,this._expandControls=!1,this._mode=po.Default,this._changingSubscription.unsubscribe(),this._changingSubscription=null)}render(e,t,i,r,o,c,s,d,p){if(t.visible===!1)return qt.h("div.mapillary-sequence-container",{},[]);const g=this._createStepper(e,t,s,i,d,p),_=this._createSequenceControls(i),x=this._createPlaybackControls(i,r,d,t),b=this._createTimelineControls(i,o,c);return qt.h("div.mapillary-sequence-container",[g,_,x,b])}getContainerWidth(e,t){let i=t.minWidth,r=t.maxWidth;r<i&&(r=i);let o=(e.width-this._minThresholdWidth)/(this._maxThresholdWidth-this._minThresholdWidth),c=(e.height-this._minThresholdHeight)/(this._maxThresholdHeight-this._minThresholdHeight),s=Math.max(0,Math.min(1,Math.min(o,c)));return i+s*(r-i)}_createPositionInput(e,t){this._index=e;const i=b=>{this._index=Number(b.target.value),this._notifyIndexChanged$.next(this._index)},r=this._container.domContainer.getBoundingClientRect(),o=Math.max(276,Math.min(410,5+.8*r.width))-65,c=b=>{b.stopPropagation(),this._setChangingPosition(!0)},s=b=>{this._changingPosition===!0&&b.stopPropagation()},p={max:t??1,min:0,onchange:i,oninput:i,onkeydown:b=>{(b.key==="ArrowDown"||b.key==="ArrowLeft"||b.key==="ArrowRight"||b.key==="ArrowUp")&&b.preventDefault()},onpointerdown:c,onpointermove:s,ontouchmove:s,ontouchstart:c,style:{width:`${o}px`},type:"range",value:e??0},g=e==null||t==null||t<=1;g&&(p.disabled="true");const _=qt.h("input.mapillary-sequence-position",p,[]),x=g?".mapillary-sequence-position-container-inactive":".mapillary-sequence-position-container";return qt.h("div"+x,[_])}_createSpeedInput(e){this._speed=e;const t=p=>{this._speed=Number(p.target.value)/1e3,this._notifySpeedChanged$.next(this._speed)},i=this._container.domContainer.getBoundingClientRect(),r=Math.max(276,Math.min(410,5+.8*i.width))-160,o=p=>{this._changingSpeed=!0,p.stopPropagation()},c=p=>{this._changingSpeed===!0&&p.stopPropagation()},s=p=>{(p.key==="ArrowDown"||p.key==="ArrowLeft"||p.key==="ArrowRight"||p.key==="ArrowUp")&&p.preventDefault()},d=qt.h("input.mapillary-sequence-speed",{max:1e3,min:0,onchange:t,oninput:t,onkeydown:s,onpointerdown:o,onpointermove:c,ontouchmove:c,ontouchstart:o,style:{width:`${r}px`},type:"range",value:1e3*e},[]);return qt.h("div.mapillary-sequence-speed-container",[d])}_createPlaybackControls(e,t,i,r){if(this._mode!==po.Playback)return qt.h("div.mapillary-sequence-playback",[]);const o=qt.h("div.mapillary-sequence-switch-icon.mapillary-sequence-icon-visible",[]),c=r.direction===Vt.Next?Vt.Prev:Vt.Next,s=r.playing,d={onclick:()=>{s||i.configure({direction:c})}},p=r.playing?".mapillary-sequence-switch-button-inactive":".mapillary-sequence-switch-button",g=qt.h("div"+p,d,[o]),_=qt.h("div.mapillary-sequence-slow-icon.mapillary-sequence-icon-visible",[]),x=qt.h("div.mapillary-sequence-slow-container",[_]),b=qt.h("div.mapillary-sequence-fast-icon.mapillary-sequence-icon-visible",[]),S=qt.h("div.mapillary-sequence-fast-container",[b]),P=qt.h("div.mapillary-sequence-close-icon.mapillary-sequence-icon-visible",[]),L={onclick:()=>{this._mode=po.Default,this._notifyChanged$.next(this)}},E=qt.h("div.mapillary-sequence-close-button",L,[P]),C=this._createSpeedInput(t),D=[g,x,C,S,E],U={style:{top:`${Math.round(e/this._stepperDefaultWidth*this._defaultHeight+10)}px`}};return qt.h("div.mapillary-sequence-playback",U,D)}_createPlayingButton(e,t,i,r,o){let c=r.direction===Vt.Next&&e!=null||r.direction===Vt.Prev&&t!=null;c=c&&i;let d={onclick:r.playing?()=>{o.stop()}:c?()=>{o.play()}:null},p={};r.direction===Vt.Prev&&(p.style={transform:"rotate(180deg) translate(50%, 50%)"});let g=qt.h("div.mapillary-sequence-icon",p,[]),_=r.playing?"mapillary-sequence-stop":c?"mapillary-sequence-play":"mapillary-sequence-play-inactive";return qt.h("div."+_,d,[g])}_createSequenceControls(e){const t=Math.round(8/this._stepperDefaultWidth*e),i={onclick:()=>{this._expandControls=!this._expandControls,this._mode=po.Default,this._notifyChanged$.next(this)},style:{"border-bottom-right-radius":`${t}px`,"border-top-right-radius":`${t}px`}},r=qt.h("div.mapillary-sequence-expander-bar",[]),o=qt.h("div.mapillary-sequence-expander-button",i,[r]),c=this._mode===po.Playback?".mapillary-sequence-fast-icon-gray.mapillary-sequence-icon-visible":".mapillary-sequence-fast-icon",s=qt.h("div"+c,[]),d={onclick:()=>{this._mode=this._mode===po.Playback?po.Default:po.Playback,this._notifyChanged$.next(this)}},p=qt.h("div.mapillary-sequence-playback-button",d,[s]),g=this._mode===po.Timeline?".mapillary-sequence-timeline-icon-gray.mapillary-sequence-icon-visible":".mapillary-sequence-timeline-icon",_=qt.h("div"+g,[]),x={onclick:()=>{this._mode=this._mode===po.Timeline?po.Default:po.Timeline,this._notifyChanged$.next(this)}},b=qt.h("div.mapillary-sequence-timeline-button",x,[_]),S={style:{height:this._defaultHeight/this._stepperDefaultWidth*e+"px",transform:`translate(${e/2+2}px, 0)`,width:this._controlsDefaultWidth/this._stepperDefaultWidth*e+"px"}},P=".mapillary-sequence-controls"+(this._expandControls?".mapillary-sequence-controls-expanded":"");return qt.h("div"+P,S,[p,b,o])}_createSequenceArrows(e,t,i,r,o){let c={onclick:e!=null?()=>{o.moveDir$(Vt.Next).subscribe(void 0,b=>{b instanceof Ul||console.error(b)})}:null,onpointerenter:()=>{this._mouseEnterDirection$.next(Vt.Next)},onpointerleave:()=>{this._mouseLeaveDirection$.next(Vt.Next)}};const s=Math.round(8/this._stepperDefaultWidth*i);let d={onclick:t!=null?()=>{o.moveDir$(Vt.Prev).subscribe(void 0,b=>{b instanceof Ul||console.error(b)})}:null,onpointerenter:()=>{this._mouseEnterDirection$.next(Vt.Prev)},onpointerleave:()=>{this._mouseLeaveDirection$.next(Vt.Prev)},style:{"border-bottom-left-radius":`${s}px`,"border-top-left-radius":`${s}px`}},p=this._getStepClassName(Vt.Next,e,r.highlightId),g=this._getStepClassName(Vt.Prev,t,r.highlightId),_=qt.h("div.mapillary-sequence-icon",[]),x=qt.h("div.mapillary-sequence-icon",[]);return[qt.h("div."+g,d,[x]),qt.h("div."+p,c,[_])]}_createStepper(e,t,i,r,o,c){let s=null,d=null;for(let x of e.edges)x.data.direction===Vt.Next&&(s=x.target),x.data.direction===Vt.Prev&&(d=x.target);const p=this._createPlayingButton(s,d,i,t,o),g=this._createSequenceArrows(s,d,r,t,c);g.splice(1,0,p);const _={oncontextmenu:x=>{x.preventDefault()},style:{height:this._defaultHeight/this._stepperDefaultWidth*r+"px",width:r+"px"}};return qt.h("div.mapillary-sequence-stepper",_,g)}_createTimelineControls(e,t,i){if(this._mode!==po.Timeline)return qt.h("div.mapillary-sequence-timeline",[]);const r=this._createPositionInput(t,i),o=qt.h("div.mapillary-sequence-close-icon.mapillary-sequence-icon-visible",[]),c={onclick:()=>{this._mode=po.Default,this._notifyChanged$.next(this)}},s=qt.h("div.mapillary-sequence-close-button",c,[o]),p={style:{top:`${Math.round(e/this._stepperDefaultWidth*this._defaultHeight+10)}px`}};return qt.h("div.mapillary-sequence-timeline",p,[r,s])}_getStepClassName(e,t,i){let r=e===Vt.Next?"mapillary-sequence-step-next":"mapillary-sequence-step-prev";return t==null?r+="-inactive":i===t&&(r+="-highlight"),r}_setChangingPosition(e){this._changingPosition=e,this._notifyChangingPositionChanged$.next(e)}}class HB extends So{constructor(e,t,i,r,o){super(e,t,i),this._sequenceDOMRenderer=r||new zne(t),this._scheduler=o,this._containerWidth$=new ri,this._hoveredIdSubject$=new ri,this._hoveredId$=this._hoveredIdSubject$.pipe(pn()),this._navigator.playService.playing$.pipe(Ks(1),Ui(this._configuration$)).subscribe(([c,s])=>{const d="playing",p={playing:c,target:this,type:d};this.fire(d,p),c!==s.playing&&(c?this.play():this.stop())}),this._navigator.playService.direction$.pipe(Ks(1),Ui(this._configuration$)).subscribe(([c,s])=>{c!==s.direction&&this.configure({direction:c})})}fire(e,t){super.fire(e,t)}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}play(){this.configure({playing:!0})}stop(){this.configure({playing:!1})}_activate(){this._sequenceDOMRenderer.activate();const e=this._navigator.stateService.currentImage$.pipe(ei(s=>s.sequenceEdges$),Ii(1),_i()),t=this._navigator.stateService.currentImage$.pipe(yi(void 0,s=>s.sequenceId),ei(s=>jl(Pi(null),this._navigator.graphService.cacheSequence$(s.sequenceId).pipe(r2(3),Un(d=>(console.error("Failed to cache sequence",d),Pi(null)))))),An(null),Ii(1),_i()),i=this._subscriptions;i.push(t.subscribe());const r=this._sequenceDOMRenderer.index$.pipe(Ui(t),st(([s,d])=>d!=null?d.imageIds[s]:null),ai(s=>!!s),yi(),Qa(),_i());i.push(mn(r.pipe(zy(100,this._scheduler)),r.pipe($O(400,this._scheduler))).pipe(yi(),ei(s=>this._navigator.moveTo$(s).pipe(Un(()=>Ni())))).subscribe()),i.push(this._sequenceDOMRenderer.changingPositionChanged$.pipe(ai(s=>s)).subscribe(()=>{this._navigator.graphService.setGraphMode(oa.Sequence)})),i.push(this._sequenceDOMRenderer.changingPositionChanged$.pipe(ai(s=>!s)).subscribe(()=>{this._navigator.graphService.setGraphMode(oa.Spatial)})),this._navigator.graphService.graphMode$.pipe(ei(s=>s===oa.Spatial?this._navigator.stateService.currentImage$.pipe(Vl(2)):Ni()),ai(s=>!s.spatialEdges.cached),ei(s=>this._navigator.graphService.cacheImage$(s.id).pipe(Un(()=>Ni())))).subscribe(),i.push(this._sequenceDOMRenderer.changingPositionChanged$.pipe(ai(s=>s)).subscribe(()=>{this._navigator.playService.stop()})),i.push(Si(this._navigator.graphService.graphMode$,this._sequenceDOMRenderer.changingPositionChanged$.pipe(An(!1),yi())).pipe(Ui(this._navigator.stateService.currentImage$),ei(([[s,d],p])=>d&&s===oa.Sequence?this._navigator.graphService.cacheSequenceImages$(p.sequenceId,p.id).pipe(r2(3),Un(g=>(console.error("Failed to cache sequence images.",g),Ni()))):Ni())).subscribe());const o=t.pipe(ei(s=>{if(!s)return Pi({index:null,max:null});let d=!0;return this._sequenceDOMRenderer.changingPositionChanged$.pipe(An(!1),yi(),ei(p=>{const g=!p&&d?0:1;return d=!1,p?r:this._navigator.stateService.currentImage$.pipe(st(_=>_.id),yi(),Ks(g))}),st(p=>{const g=s.imageIds.indexOf(p);return g===-1?{index:null,max:null}:{index:g,max:s.imageIds.length-1}}))})),c=this._navigator.stateService.state$.pipe(st(s=>s===Bi.Earth),yi());i.push(Si(e,this._configuration$,this._containerWidth$,this._sequenceDOMRenderer.changed$.pipe(An(this._sequenceDOMRenderer)),this._navigator.playService.speed$,o,c).pipe(st(([s,d,p,,g,_,x])=>{const b=this._sequenceDOMRenderer.render(s,d,p,g,_.index,_.max,!x,this,this._navigator);return{name:this._name,vNode:b}})).subscribe(this._container.domRenderer.render$)),i.push(this._sequenceDOMRenderer.speed$.subscribe(s=>{this._navigator.playService.setSpeed(s)})),i.push(this._configuration$.pipe(st(s=>s.direction),yi()).subscribe(s=>{this._navigator.playService.setDirection(s)})),i.push(Si(this._container.renderService.size$,this._configuration$.pipe(yi((s,d)=>s[0]===d[0]&&s[1]===d[1],s=>[s.minWidth,s.maxWidth]))).pipe(st(([s,d])=>this._sequenceDOMRenderer.getContainerWidth(s,d))).subscribe(this._containerWidth$)),i.push(this._configuration$.pipe(st(s=>s.playing),yi()).subscribe(s=>{s?this._navigator.playService.play():this._navigator.playService.stop()})),i.push(this._sequenceDOMRenderer.mouseEnterDirection$.pipe(ei(s=>{const d=e.pipe(st(p=>{for(let g of p.edges)if(g.data.direction===s)return g.target;return null}),Cd(this._sequenceDOMRenderer.mouseLeaveDirection$));return jl(d,Pi(null))}),yi()).subscribe(this._hoveredIdSubject$)),i.push(this._hoveredId$.subscribe(s=>{const d="hover",p={id:s,target:this,type:d};this.fire(d,p)}))}_deactivate(){this._subscriptions.unsubscribe(),this._sequenceDOMRenderer.deactivate()}_getDefaultConfiguration(){return{direction:Vt.Next,maxWidth:108,minWidth:70,playing:!1,visible:!0}}}HB.componentName="sequence";var Ol;(function(n){n[n.Motion=0]="Motion",n[n.Stationary=1]="Stationary"})(Ol||(Ol={}));const Bne=1e-8;class kg{constructor(e,t,i,r,o,c,s,d,p,g){this._orientation=this._getValue(e,1);let _=s!=null?s.width:4,x=s!=null?s.height:3,b=this._orientation<5;this._width=this._getValue(t,b?_:x),this._height=this._getValue(i,b?x:_),this._basicAspect=b?this._width/this._height:this._height/this._width,this._basicWidth=b?t:i,this._basicHeight=b?i:t;const S=this._getCameraParameters(p,g),P=S[0],L=S[1],E=S[2];this._focal=this._getValue(P,1),this._scale=this._getValue(r,0),this._worldToCamera=this.createWorldToCamera(o,c),this._worldToCameraInverse=new ki().copy(this._worldToCamera).invert(),this._scaledWorldToCamera=this._createScaledWorldToCamera(this._worldToCamera,this._scale),this._scaledWorldToCameraInverse=new ki().copy(this._scaledWorldToCamera).invert(),this._basicWorldToCamera=this._createBasicWorldToCamera(this._worldToCamera,e),this._textureScale=d||[1,1],this._ck1=L||0,this._ck2=E||0,this._cameraType=g||"perspective",this._radialPeak=this._getRadialPeak(this._ck1,this._ck2)}get ck1(){return this._ck1}get ck2(){return this._ck2}get cameraType(){return this._cameraType}get basicAspect(){return this._basicAspect}get basicHeight(){return this._basicHeight}get basicRt(){return this._basicWorldToCamera}get basicWidth(){return this._basicWidth}get focal(){return this._focal}get height(){return this._height}get orientation(){return this._orientation}get rt(){return this._worldToCamera}get srt(){return this._scaledWorldToCamera}get srtInverse(){return this._scaledWorldToCameraInverse}get scale(){return this._scale}get hasValidScale(){return this._scale>.01&&this._scale<50}get radialPeak(){return this._radialPeak}get width(){return this._width}upVector(){let e=this._worldToCamera.elements;switch(this._orientation){case 1:return new Ge(-e[1],-e[5],-e[9]);case 3:return new Ge(e[1],e[5],e[9]);case 6:return new Ge(-e[0],-e[4],-e[8]);case 8:return new Ge(e[0],e[4],e[8]);default:return new Ge(-e[1],-e[5],-e[9])}}projectorMatrix(){let e=this._normalizedToTextureMatrix(),t=this._focal,i=new ki().set(t,0,0,0,0,t,0,0,0,0,0,0,0,0,1,0);return e.multiply(i),e.multiply(this._worldToCamera),e}projectBasic(e){let t=this.projectSfM(e);return this._sfmToBasic(t)}unprojectBasic(e,t,i){let r=this._basicToSfm(e);return this.unprojectSfM(r,t,i)}projectSfM(e){let t=new Xn(e[0],e[1],e[2],1);return t.applyMatrix4(this._worldToCamera),this._bearingToSfm([t.x,t.y,t.z])}unprojectSfM(e,t,i){const r=this._sfmToBearing(e),c=(i&&!Di(this._cameraType)?new Xn(t*r[0]/r[2],t*r[1]/r[2],t,1):new Xn(t*r[0],t*r[1],t*r[2],1)).applyMatrix4(this._worldToCameraInverse);return[c.x/c.w,c.y/c.w,c.z/c.w]}_sfmToBearing(e){if(Di(this._cameraType)){let t=e[0]*2*Math.PI,i=-e[1]*2*Math.PI,r=Math.cos(i)*Math.sin(t),o=-Math.sin(i),c=Math.cos(i)*Math.cos(t);return[r,o,c]}else if(kw(this._cameraType)){let[t,i]=[e[0]/this._focal,e[1]/this._focal];const r=Math.sqrt(t*t+i*i);let o=this._distortionFromDistortedRadius(r,this._ck1,this._ck2,this._radialPeak),c=r/o,s=Math.cos(c),d=Math.sin(c);const p=r>Bne?1/r:1;let g=d*t*p,_=d*i*p;return[g,_,s]}else{let[t,i]=[e[0]/this._focal,e[1]/this._focal];const r=Math.sqrt(t*t+i*i);let o=this._distortionFromDistortedRadius(r,this._ck1,this._ck2,this._radialPeak);const c=t/o,s=i/o;let d=new Ge(c,s,1);return d.normalize(),[d.x,d.y,d.z]}}_distortionFromDistortedRadius(e,t,i,r){let o=1;for(let c=0;c<10;c++){let s=e/o;s>r&&(s=r),o=1+t*Math.pow(s,2)+i*Math.pow(s,4)}return o}_bearingToSfm(e){if(Di(this._cameraType)){let t=e[0],i=e[1],r=e[2],o=Math.atan2(t,r),c=Math.atan2(-i,Math.sqrt(t*t+r*r));return[o/(2*Math.PI),-c/(2*Math.PI)]}else if(kw(this._cameraType))if(e[2]>0){const[t,i,r]=e,o=Math.sqrt(t*t+i*i);let c=Math.atan2(o,r);c>this._radialPeak&&(c=this._radialPeak);const s=1+Math.pow(c,2)*(this._ck1+Math.pow(c,2)*this._ck2),d=this._focal*s*c/o;return[d*t,d*i]}else return[e[0]<0?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,e[1]<0?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY];else if(e[2]>0){let[t,i]=[e[0]/e[2],e[1]/e[2]],r=t*t+i*i;const o=Math.pow(this._radialPeak,2);r>o&&(r=o);const c=1+this._ck1*r+this._ck2*Math.pow(r,2);return[this._focal*c*t,this._focal*c*i]}else return[e[0]<0?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,e[1]<0?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY]}_basicToSfm(e){let t,i;switch(this._orientation){case 1:t=e[0],i=e[1];break;case 3:t=1-e[0],i=1-e[1];break;case 6:t=e[1],i=1-e[0];break;case 8:t=1-e[1],i=e[0];break;default:t=e[0],i=e[1];break}let r=this._width,o=this._height,c=Math.max(r,o),s=t*r/c-r/c/2,d=i*o/c-o/c/2;return[s,d]}_sfmToBasic(e){let t=this._width,i=this._height,r=Math.max(t,i),o=(e[0]+t/r/2)/t*r,c=(e[1]+i/r/2)/i*r,s,d;switch(this._orientation){case 1:s=o,d=c;break;case 3:s=1-o,d=1-c;break;case 6:s=1-c,d=o;break;case 8:s=c,d=1-o;break;default:s=o,d=c;break}return[s,d]}_getValue(e,t){return e!=null&&e>0?e:t}_getCameraParameters(e,t){if(Di(t))return[];if(!e||e.length===0)return[1,0,0];const i=3-e.length;return i<=0?e:e.concat(new Array(i).fill(0))}createWorldToCamera(e,t){const i=new Ge(e[0],e[1],e[2]),r=i.length();r>0&&i.normalize();const o=new ki;return o.makeRotationAxis(i,r),o.setPosition(new Ge(t[0],t[1],t[2])),o}_createScaledWorldToCamera(e,t){const i=e.clone(),r=i.elements;return r[12]=t*r[12],r[13]=t*r[13],r[14]=t*r[14],i.scale(new Ge(t,t,t)),i}_createBasicWorldToCamera(e,t){const i=new Ge(0,0,1);let r=0;switch(t){case 3:r=Math.PI;break;case 6:r=Math.PI/2;break;case 8:r=3*Math.PI/2;break}return new ki().makeRotationAxis(i,r).multiply(e)}_getRadialPeak(e,t){const i=5*t,r=3*e,c=Math.pow(r,2)-4*i*1;if(c<0)return;const s=(-r-Math.sqrt(c))/2/i,d=(-r+Math.sqrt(c))/2/i,p=Math.min(s,d),g=Math.max(s,d);return p>0?Math.sqrt(p):g>0?Math.sqrt(g):void 0}_normalizedToTextureMatrix(){const e=Math.max(this._width,this._height),t=this._orientation<5?this._textureScale[0]:this._textureScale[1],i=this._orientation<5?this._textureScale[1]:this._textureScale[0],r=e/this._width*t,o=e/this._height*i;switch(this._orientation){case 1:return new ki().set(r,0,0,.5,0,-o,0,.5,0,0,1,0,0,0,0,1);case 3:return new ki().set(-r,0,0,.5,0,o,0,.5,0,0,1,0,0,0,0,1);case 6:return new ki().set(0,-o,0,.5,-r,0,0,.5,0,0,1,0,0,0,0,1);case 8:return new ki().set(0,o,0,.5,r,0,0,.5,0,0,1,0,0,0,0,1);default:return new ki().set(r,0,0,.5,0,-o,0,.5,0,0,1,0,0,0,0,1)}}}class Nne{constructor(){this._factory=new DB,this._scene=new FB,this._spatial=new xo,this._currentKey=null,this._previousKey=null,this._disabled=!1,this._curtain=1,this._frameId=0,this._needsRender=!1,this._mode=null,this._currentProviderDisposers={},this._previousProviderDisposers={}}get disabled(){return this._disabled}get frameId(){return this._frameId}get needsRender(){return this._needsRender}setTextureProvider(e,t){this._setTextureProvider(e,this._currentKey,t,this._currentProviderDisposers,this._updateTexture.bind(this))}setTextureProviderPrev(e,t){this._setTextureProvider(e,this._previousKey,t,this._previousProviderDisposers,this._updateTexturePrev.bind(this))}update(e,t){this._updateFrameId(e.id),this._updateImagePlanes(e.state,t)}updateCurtain(e){this._curtain!==e&&(this._curtain=e,this._updateCurtain(),this._needsRender=!0)}updateTexture(e,t){const i=t.id===this._currentKey?this._scene.planes:t.id===this._previousKey?this._scene.planesOld:{};if(Object.keys(i).length!==0){this._needsRender=!0;for(const r in i){if(!i.hasOwnProperty(r))continue;let s=i[r].material.uniforms.projectorTex.value;s.image=e,s.needsUpdate=!0}}}updateTextureImage(e,t){if(this._currentKey!==t.id)return;this._needsRender=!0;const i=this._scene.planes;for(const r in i){if(!i.hasOwnProperty(r))continue;let s=i[r].material.uniforms.projectorTex.value;s.image=e,s.needsUpdate=!0}}render(e,t){this.disabled||t.render(this._scene.sceneOld,e),t.render(this._scene.scene,e),this._needsRender=!1}dispose(){this._scene.clear();for(const e in this._currentProviderDisposers)this._currentProviderDisposers.hasOwnProperty(e)&&this._currentProviderDisposers[e]();for(const e in this._previousProviderDisposers)this._previousProviderDisposers.hasOwnProperty(e)&&this._previousProviderDisposers[e]();this._currentProviderDisposers={},this._previousProviderDisposers={}}_getBasicCorners(e,t){let i,r;return e>t?(i=.5,r=.5*e/t):(i=.5*t/e,r=.5),[[.5-i,.5-r],[.5+i,.5+r]]}_setDisabled(e){this._disabled=e.currentImage==null||e.previousImage==null||Di(e.currentImage.cameraType)&&!Di(e.previousImage.cameraType)}_setTextureProvider(e,t,i,r,o){if(e!==t)return;let c=i.textureCreated$.subscribe(o),s=i.textureUpdated$.subscribe(p=>{this._needsRender=!0}),d=()=>{c.unsubscribe(),s.unsubscribe(),i.dispose()};if(e in r){let p=r[e];p(),delete r[e]}r[e]=d}_updateCurtain(){const e=this._scene.planes;for(const t in e){if(!e.hasOwnProperty(t))continue;let r=e[t].material;r.uniforms.curtain&&(r.uniforms.curtain.value=this._curtain)}}_updateFrameId(e){this._frameId=e}_updateImagePlanes(e,t){const i=e.currentImage!=null&&this._currentKey!==e.currentImage.id,r=e.previousImage!=null&&this._previousKey!==e.previousImage.id,o=this._mode!==t;if(!(i||r||o))return;this._setDisabled(e),this._needsRender=!0,this._mode=t;const c=e.motionless||t===Ol.Stationary||Di(e.currentImage.cameraType);if((this.disabled||r)&&this._previousKey in this._previousProviderDisposers&&(this._previousProviderDisposers[this._previousKey](),delete this._previousProviderDisposers[this._previousKey]),this.disabled)this._scene.setImagePlanesOld({});else if(r||o){const s=e.previousImage;this._previousKey=s.id;const d=e.currentTransform.rt.elements;let p=[d[12],d[13],d[14]];const g=e.currentTransform.basicAspect,_=e.previousTransform.basicAspect,x=g>_?[1,_/g]:[g/_,1];let b=e.currentImage.rotation,S=e.currentImage.width,P=e.currentImage.height;Di(s.cameraType)&&(b=e.previousImage.rotation,p=this._spatial.rotate(this._spatial.opticalCenter(e.currentImage.rotation,p).toArray(),b).multiplyScalar(-1).toArray(),S=e.previousImage.width,P=e.previousImage.height);const L=new kg(e.currentImage.exifOrientation,S,P,e.currentImage.scale,b,p,s.image,x,e.currentImage.cameraParameters,e.currentImage.cameraType);let E;if(Di(s.cameraType))E=this._factory.createMesh(s,c||Di(e.currentImage.cameraType)?L:e.previousTransform);else if(c){const[[D,O],[U,j]]=this._getBasicCorners(g,_);E=this._factory.createFlatMesh(e.previousImage,L,D,U,O,j)}else E=this._factory.createMesh(e.previousImage,e.previousTransform);const C={};C[s.id]=E,this._scene.setImagePlanesOld(C)}if(i||o){this._currentKey in this._currentProviderDisposers&&(this._currentProviderDisposers[this._currentKey](),delete this._currentProviderDisposers[this._currentKey]),this._currentKey=e.currentImage.id;const s={};Di(e.currentImage.cameraType)?s[e.currentImage.id]=this._factory.createCurtainMesh(e.currentImage,e.currentTransform):c?s[e.currentImage.id]=this._factory.createDistortedCurtainMesh(e.currentImage,e.currentTransform):s[e.currentImage.id]=this._factory.createCurtainMesh(e.currentImage,e.currentTransform),this._scene.setImagePlanes(s),this._updateCurtain()}}_updateTexture(e){this._needsRender=!0;const t=this._scene.planes;for(const i in t){if(!t.hasOwnProperty(i))continue;let o=t[i].material,c=o.uniforms.projectorTex.value;o.uniforms.projectorTex.value=null,c.dispose(),o.uniforms.projectorTex.value=e}}_updateTexturePrev(e){this._needsRender=!0;const t=this._scene.planesOld;for(const i in t){if(!t.hasOwnProperty(i))continue;let o=t[i].material,c=o.uniforms.projectorTex.value;o.uniforms.projectorTex.value=null,c.dispose(),o.uniforms.projectorTex.value=e}}}class $ne{constructor(e){this._container=e,this._interacting=!1,this._notifyModeChanged$=new ri,this._notifyPositionChanged$=new ri,this._stopInteractionSubscription=null}get mode$(){return this._notifyModeChanged$}get position$(){return this._notifyPositionChanged$}activate(){this._stopInteractionSubscription||(this._stopInteractionSubscription=mn(this._container.mouseService.documentMouseUp$,this._container.touchService.touchEnd$.pipe(ai(e=>e.touches.length===0))).subscribe(e=>{this._interacting&&(this._interacting=!1)}))}deactivate(){this._stopInteractionSubscription&&(this._interacting=!1,this._stopInteractionSubscription.unsubscribe(),this._stopInteractionSubscription=null)}render(e,t,i,r,o){const c=[];if(o){c.push(qt.h("div.mapillary-slider-border",[]));const p=!(i||r);p&&(c.push(this._createModeButton(t)),c.push(this._createModeButton2d(t))),c.push(this._createPositionInput(e,p))}const s=this._container.domContainer.getBoundingClientRect(),d=Math.max(215,Math.min(400,s.width-100));return qt.h("div.mapillary-slider-container",{style:{width:`${d}px`}},c)}_createModeButton(e){const t={onclick:()=>{e!==Ol.Motion&&this._notifyModeChanged$.next(Ol.Motion)}},i=e===Ol.Stationary?"mapillary-slider-mode-button-inactive":"mapillary-slider-mode-button";return qt.h("div."+i,t,[qt.h("div.mapillary-slider-mode-icon",[])])}_createModeButton2d(e){const t={onclick:()=>{e!==Ol.Stationary&&this._notifyModeChanged$.next(Ol.Stationary)}},i=e===Ol.Motion?"mapillary-slider-mode-button-2d-inactive":"mapillary-slider-mode-button-2d";return qt.h("div."+i,t,[qt.h("div.mapillary-slider-mode-icon-2d",[])])}_createPositionInput(e,t){const i=g=>{this._notifyPositionChanged$.next(Number(g.target.value)/1e3)},r=g=>{this._interacting=!0,g.stopPropagation()},o=g=>{this._interacting&&g.stopPropagation()},c=g=>{(g.key==="ArrowDown"||g.key==="ArrowLeft"||g.key==="ArrowRight"||g.key==="ArrowUp")&&g.preventDefault()},s=this._container.domContainer.getBoundingClientRect(),d=Math.max(215,Math.min(400,s.width-105))-84+(t?0:52),p=qt.h("input.mapillary-slider-position",{max:1e3,min:0,onchange:i,oninput:i,onkeydown:c,onpointerdown:r,onpointermove:o,ontouchmove:o,ontouchstart:r,style:{width:`${d}px`},type:"range",value:1e3*e},[]);return qt.h("div.mapillary-slider-position-container",[p])}}class ZB extends So{constructor(e,t,i,r){super(e,t,i),this._viewportCoords=r||new $o,this._domRenderer=new $ne(t),this._imageTileLoader=new OB(i.api),this._roiCalculator=new zB,this._spatial=new xo,this._glRendererOperation$=new ri,this._glRendererCreator$=new ri,this._glRendererDisposer$=new ri,this._glRenderer$=this._glRendererOperation$.pipe(Vr((o,c)=>c(o),null),ai(o=>o!=null),yi(void 0,o=>o.frameId)),this._glRendererCreator$.pipe(st(()=>o=>{if(o!=null)throw new Error("Multiple slider states can not be created at the same time");return new Nne})).subscribe(this._glRendererOperation$),this._glRendererDisposer$.pipe(st(()=>o=>(o.dispose(),null))).subscribe(this._glRendererOperation$)}_activate(){const e=this._subscriptions;e.push(this._domRenderer.mode$.subscribe(b=>{this.configure({mode:b})})),e.push(this._glRenderer$.pipe(st(b=>({name:this._name,renderer:{frameId:b.frameId,needsRender:b.needsRender,render:b.render.bind(b),pass:Rh.Background}}))).subscribe(this._container.glRenderer.render$));const t=jl(this.configuration$.pipe(st(b=>b.initialPosition!=null?b.initialPosition:1),wi()),this._domRenderer.position$),i=this.configuration$.pipe(st(b=>b.mode),yi()),r=this._navigator.stateService.currentState$.pipe(st(b=>b.state.motionless),yi()),o=this._navigator.stateService.currentState$.pipe(st(b=>Di(b.state.currentImage.cameraType)),yi()),c=Si(this._configuration$.pipe(st(b=>b.sliderVisible)),this._navigator.stateService.currentState$.pipe(st(b=>!(b.state.currentImage==null||b.state.previousImage==null||Di(b.state.currentImage.cameraType)&&!Di(b.state.previousImage.cameraType))),yi())).pipe(st(([b,S])=>b&&S),yi());this._waitSubscription=Si(i,r,o,c).pipe(Ui(this._navigator.stateService.state$)).subscribe(([[b,S,P,L],E])=>{const C=L&&(S||b===Ol.Stationary||P);C&&E!==Bi.WaitingInteractively?this._navigator.stateService.waitInteractively():!C&&E!==Bi.Waiting&&this._navigator.stateService.wait()}),e.push(Si(t,i,r,o,c).subscribe(([b,S,P,L])=>{P||S===Ol.Stationary||L?this._navigator.stateService.moveTo(1):this._navigator.stateService.moveTo(b)})),e.push(Si(t,i,r,o,c,this._container.renderService.size$).pipe(st(([b,S,P,L,E])=>({name:this._name,vNode:this._domRenderer.render(b,S,P,L,E)}))).subscribe(this._container.domRenderer.render$)),this._glRendererCreator$.next(null),e.push(Si(t,o,c,this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$).pipe(st(([b,S,P,L,E])=>{if(!S)return P?b:1;const C=this._viewportCoords.viewportToBasic(-1.15,0,E,L.perspective),D=this._viewportCoords.viewportToBasic(1.15,0,E,L.perspective),O=D[0]<C[0]?D[0]+1:D[0],U=C[0]+b*(O-C[0]);return U>1?U-1:U}),st(b=>S=>(S.updateCurtain(b),S))).subscribe(this._glRendererOperation$)),e.push(Si(this._navigator.stateService.currentState$,i).pipe(st(([b,S])=>P=>(P.update(b,S),P))).subscribe(this._glRendererOperation$)),e.push(this._configuration$.pipe(ai(b=>b.ids!=null),ei(b=>Oy(Oy(this._catchCacheImage$(b.ids.background),this._catchCacheImage$(b.ids.foreground)).pipe(st(S=>({background:S[0],foreground:S[1]}))),this._navigator.stateService.currentState$.pipe(wi())).pipe(st(S=>({images:S[0],state:S[1].state}))))).subscribe(b=>{if(!(b.state.currentImage!=null&&b.state.previousImage!=null&&b.state.currentImage.id===b.images.foreground.id&&b.state.previousImage.id===b.images.background.id)){if(b.state.currentImage.id===b.images.background.id){this._navigator.stateService.setImages([b.images.foreground]);return}if(b.state.currentImage.id===b.images.foreground.id&&b.state.trajectory.length===1){this._navigator.stateService.prependImages([b.images.background]);return}this._navigator.stateService.setImages([b.images.background]),this._navigator.stateService.setImages([b.images.foreground])}},b=>{console.error(b)}));const s=this._container.configurationService.imageTiling$.pipe(ei(b=>b?this._navigator.stateService.currentState$:new ri),yi(void 0,b=>b.state.currentImage.id),Ui(this._container.glRenderer.webGLRenderer$,this._container.renderService.size$),st(([b,S,P])=>{const L=b.state;Math.max(P.width,P.height);const E=L.currentImage,C=L.currentTransform;return new x2(E.id,C.basicWidth,C.basicHeight,E.image,this._imageTileLoader,new b2,S)}),Ii(1),_i());e.push(s.subscribe(()=>{})),e.push(s.pipe(st(b=>S=>(S.setTextureProvider(b.id,b),S))).subscribe(this._glRendererOperation$)),e.push(s.pipe(rl()).subscribe(b=>{b[0].abort()}));const d=this._container.configurationService.imageTiling$.pipe(ei(b=>b?Si(this._container.renderService.renderCameraFrame$,this._container.renderService.size$.pipe(zy(250))):new ri),st(([b,S])=>[b.camera.position.clone(),b.camera.lookat.clone(),b.zoom.valueOf(),S.height.valueOf(),S.width.valueOf()]),rl(),s2(b=>b[1][2]-b[0][2]<0||b[1][2]===0),st(b=>{let S=b[0][0].equals(b[1][0]),P=b[0][1].equals(b[1][1]),L=b[0][2]===b[1][2],E=b[0][3]===b[1][3],C=b[0][4]===b[1][4];return S&&P&&L&&E&&C}),yi(),ai(b=>b),ei(()=>this._container.renderService.renderCameraFrame$.pipe(wi())),Ui(this._container.renderService.size$,this._navigator.stateService.currentTransform$));e.push(s.pipe(ei(b=>d.pipe(st(([S,P,L])=>[this._roiCalculator.computeRegionOfInterest(S,P,L),b]))),ai(b=>!b[1].disposed)).subscribe(b=>{let S=b[0];b[1].setRegionOfInterest(S)}));const p=s.pipe(ei(b=>b.hasTexture$),An(!1),Ii(1),_i());e.push(p.subscribe(()=>{}));const g=this._container.configurationService.imageTiling$.pipe(ei(b=>b?this._navigator.stateService.currentState$:new ri),ai(b=>!!b.state.previousImage),yi(void 0,b=>b.state.previousImage.id),Ui(this._container.glRenderer.webGLRenderer$,this._container.renderService.size$),st(([b,S,P])=>{const L=b.state,E=L.previousImage,C=L.previousTransform;return new x2(E.id,C.basicWidth,C.basicHeight,E.image,this._imageTileLoader,new b2,S)}),Ii(1),_i());e.push(g.subscribe(()=>{})),e.push(g.pipe(st(b=>S=>(S.setTextureProviderPrev(b.id,b),S))).subscribe(this._glRendererOperation$)),e.push(g.pipe(rl()).subscribe(b=>{b[0].abort()}));const _=this._container.configurationService.imageTiling$.pipe(ei(b=>b?Si(this._container.renderService.renderCameraFrame$,this._container.renderService.size$.pipe(zy(250))):new ri),st(([b,S])=>[b.camera.position.clone(),b.camera.lookat.clone(),b.zoom.valueOf(),S.height.valueOf(),S.width.valueOf()]),rl(),s2(b=>b[1][2]-b[0][2]<0||b[1][2]===0),st(b=>{let S=b[0][0].equals(b[1][0]),P=b[0][1].equals(b[1][1]),L=b[0][2]===b[1][2],E=b[0][3]===b[1][3],C=b[0][4]===b[1][4];return S&&P&&L&&E&&C}),yi(),ai(b=>b),ei(()=>this._container.renderService.renderCameraFrame$.pipe(wi())),Ui(this._container.renderService.size$,this._navigator.stateService.currentTransform$));e.push(g.pipe(ei(b=>_.pipe(st(([S,P,L])=>[this._roiCalculator.computeRegionOfInterest(S,P,L),b]))),ai(b=>!b[1].disposed),Ui(this._navigator.stateService.currentState$)).subscribe(([[b,S],P])=>{let L=null;if(Di(P.state.previousImage.cameraType))if(Di(P.state.currentImage.cameraType)){const E=this._spatial.viewingDirection(P.state.currentImage.rotation),C=this._spatial.viewingDirection(P.state.previousImage.rotation),O=this._spatial.angleBetweenVector2(E.x,E.y,C.x,C.y)/(2*Math.PI);L={bbox:{maxX:this._spatial.wrap(b.bbox.maxX+O,0,1),maxY:b.bbox.maxY,minX:this._spatial.wrap(b.bbox.minX+O,0,1),minY:b.bbox.minY},pixelHeight:b.pixelHeight,pixelWidth:b.pixelWidth}}else{const E=this._spatial.viewingDirection(P.state.currentImage.rotation),C=this._spatial.viewingDirection(P.state.previousImage.rotation),O=this._spatial.angleBetweenVector2(E.x,E.y,C.x,C.y)/(2*Math.PI),U=this._spatial.angleToPlane(E.toArray(),[0,0,1]),G=(this._spatial.angleToPlane(C.toArray(),[0,0,1])-U)/(2*Math.PI),N=P.state.currentTransform,V=Math.max(N.basicWidth,N.basicHeight),q=V>0?2*Math.atan(.5*N.basicWidth/(V*N.focal)):Math.PI/3,z=V>0?2*Math.atan(.5*N.basicHeight/(V*N.focal)):Math.PI/3,Q=q/(2*Math.PI),X=z/Math.PI,re=(b.bbox.maxX-b.bbox.minX)*Q,oe=(b.bbox.maxY-b.bbox.minY)*X,de=b.pixelWidth*Q,ce=b.pixelHeight*X,Se=(b.bbox.minX+b.bbox.maxX)/2-.5,Pe=(b.bbox.minY+b.bbox.maxY)/2-.5,je=.5+O+Q*Se-re/2,Fe=.5+O+Q*Se+re/2,qe=.5+G+X*Pe-oe/2,Ue=.5+G+X*Pe+oe/2;L={bbox:{maxX:this._spatial.wrap(Fe,0,1),maxY:Ue,minX:this._spatial.wrap(je,0,1),minY:qe},pixelHeight:ce,pixelWidth:de}}else{const E=P.state.currentTransform.basicAspect,C=P.state.previousTransform.basicAspect,[[D,O],[U,j]]=this._getBasicCorners(E,C),G=U-D,N=j-O,V=b.pixelWidth/G,q=b.pixelHeight/N,z=(G-1)/(2*G)+b.bbox.minX/G,Q=(G-1)/(2*G)+b.bbox.maxX/G,X=(N-1)/(2*N)+b.bbox.minY/N,re=(N-1)/(2*N)+b.bbox.maxY/N,oe={maxX:Q,maxY:re,minX:z,minY:X};this._clipBoundingBox(oe),L={bbox:oe,pixelHeight:q,pixelWidth:V}}S.setRegionOfInterest(L)}));const x=g.pipe(ei(b=>b.hasTexture$),An(!1),Ii(1),_i());e.push(x.subscribe(()=>{}))}_deactivate(){this._waitSubscription.unsubscribe(),this._navigator.stateService.state$.pipe(wi()).subscribe(e=>{e!==Bi.Traversing&&this._navigator.stateService.traverse()}),this._glRendererDisposer$.next(null),this._domRenderer.deactivate(),this._subscriptions.unsubscribe(),this.configure({ids:null})}_getDefaultConfiguration(){return{initialPosition:1,mode:Ol.Motion,sliderVisible:!0}}_catchCacheImage$(e){return this._navigator.graphService.cacheImage$(e).pipe(Un(t=>(console.error(`Failed to cache slider image (${e})`,t),Ni())))}_getBasicCorners(e,t){let i,r;return e>t?(i=.5,r=.5*e/t):(i=.5*t/e,r=.5),[[.5-i,.5-r],[.5+i,.5+r]]}_clipBoundingBox(e){e.minX=Math.max(0,Math.min(1,e.minX)),e.maxX=Math.max(0,Math.min(1,e.maxX)),e.minY=Math.max(0,Math.min(1,e.minY)),e.maxY=Math.max(0,Math.min(1,e.maxY))}}ZB.componentName="slider";class M0{constructor(e,t){this._subscriptions=new wo,this._graphService=e,this._stateService=t;const i=this._subscriptions;this._directionSubject$=new ri,this._direction$=this._directionSubject$.pipe(An(Vt.Next),Ii(1),_i()),i.push(this._direction$.subscribe()),this._playing=!1,this._playingSubject$=new ri,this._playing$=this._playingSubject$.pipe(An(this._playing),Ii(1),_i()),i.push(this._playing$.subscribe()),this._speed=.5,this._speedSubject$=new ri,this._speed$=this._speedSubject$.pipe(An(this._speed),Ii(1),_i()),i.push(this._speed$.subscribe()),this._imagesAhead=this._mapImagesAhead(this._mapSpeed(this._speed)),this._bridging$=null}get playing(){return this._playing}get direction$(){return this._direction$}get playing$(){return this._playing$}get speed$(){return this._speed$}play(){if(this._playing)return;this._stateService.cutImages();const e=this._setSpeed(this._speed);this._stateService.setSpeed(e),this._graphModeSubscription=this._speed$.pipe(st(i=>i>M0.sequenceSpeed?oa.Sequence:oa.Spatial),yi()).subscribe(i=>{this._graphService.setGraphMode(i)}),this._cacheSubscription=Si(this._stateService.currentImage$.pipe(st(i=>[i.sequenceId,i.id]),yi(void 0,([i])=>i)),this._graphService.graphMode$,this._direction$).pipe(ei(([[i,r],o,c])=>{if(c!==Vt.Next&&c!==Vt.Prev)return Pi([void 0,c]);const s=(o===oa.Sequence?this._graphService.cacheSequenceImages$(i,r):this._graphService.cacheSequence$(i)).pipe(r2(3),Un(d=>(console.error(d),Pi(void 0))));return Si(s,Pi(c))}),ei(([i,r])=>{if(i===void 0)return Ni();const o=i.imageIds.slice();return r===Vt.Prev&&o.reverse(),this._stateService.currentState$.pipe(st(c=>[c.state.trajectory[c.state.trajectory.length-1].id,c.state.imagesAhead]),Vr(([c,s],[d,p])=>{c===void 0&&(c=d);const g=o.length-1;if(p>=this._imagesAhead||o[g]===c)return[c,[]];const _=o.indexOf(d),x=o.indexOf(c)+1,b=Math.min(g,_+this._imagesAhead-p)+1;return b<=x?[c,[]]:[o[b-1],o.slice(x,b)]},[void 0,[]]),Hi(([c,s])=>Fr(s)))}),Hi(i=>this._graphService.cacheImage$(i).pipe(Un(()=>Ni())),6)).subscribe(),this._playingSubscription=this._stateService.currentState$.pipe(ai(i=>i.state.imagesAhead<this._imagesAhead),yi(void 0,i=>i.state.lastImage.id),st(i=>{const r=i.state.lastImage,o=i.state.trajectory;let c;for(let s=o.length-2;s>=0;s--){const d=o[s];if(d.sequenceId!==r.sequenceId)break;if(d.capturedAt!==r.capturedAt){c=d.capturedAt<r.capturedAt;break}}return[i.state.lastImage,c]}),Ui(this._direction$),ei(([[i,r],o])=>Oy(([Vt.Next,Vt.Prev].indexOf(o)>-1?i.sequenceEdges$:i.spatialEdges$).pipe(wi(c=>c.cached),i2(15e3)),Pi(o)).pipe(st(([c,s])=>{for(let d of c.edges)if(d.data.direction===s)return d.target;return null}),ei(c=>c!=null?this._graphService.cacheImage$(c):Ni())))).subscribe(i=>{this._stateService.appendImagess([i])},i=>{console.error(i),this.stop()}),this._clearSubscription=this._stateService.currentImage$.pipe(Tw(1,10)).subscribe(i=>{this._stateService.clearPriorImages()}),this._setPlaying(!0);const t=this._stateService.currentState$.pipe(st(i=>i.state),yi(([i,r],[o,c])=>i===o&&r===c,i=>[i.currentImage.id,i.lastImage.id]),ai(i=>i.currentImage.id===i.lastImage.id&&i.currentIndex===i.trajectory.length-1),st(i=>i.currentImage));this._stopSubscription=Si(t,this._direction$).pipe(ei(([i,r])=>{const o=([Vt.Next,Vt.Prev].indexOf(r)>-1?i.sequenceEdges$:i.spatialEdges$).pipe(wi(c=>c.cached),i2(15e3),Un(c=>(console.error(c),Pi({cached:!1,edges:[]}))));return Si(Pi(r),o).pipe(st(([c,s])=>{for(const d of s.edges)if(d.data.direction===c)return!0;return!1}))}),Hi(i=>i||!this._bridging$?Pi(i):this._bridging$.pipe(st(r=>r!=null),Un(r=>(console.error(r),Pi(!1))))),wi(i=>!i)).subscribe(void 0,void 0,()=>{this.stop()}),this._stopSubscription.closed&&(this._stopSubscription=null),this._earthSubscription=this._stateService.state$.pipe(st(i=>i===Bi.Earth),yi(),wi(i=>i)).subscribe(void 0,void 0,()=>{this.stop()}),this._earthSubscription.closed&&(this._earthSubscription=null)}dispose(){this.stop(),this._subscriptions.unsubscribe()}setDirection(e){this._directionSubject$.next(e)}setSpeed(e){if(e=Math.max(0,Math.min(1,e)),e===this._speed)return;const t=this._setSpeed(e);this._playing&&this._stateService.setSpeed(t),this._speedSubject$.next(this._speed)}stop(){this._playing&&(this._stopSubscription&&(this._stopSubscription.closed||this._stopSubscription.unsubscribe(),this._stopSubscription=null),this._earthSubscription&&(this._earthSubscription.closed||this._earthSubscription.unsubscribe(),this._earthSubscription=null),this._graphModeSubscription.unsubscribe(),this._graphModeSubscription=null,this._cacheSubscription.unsubscribe(),this._cacheSubscription=null,this._playingSubscription.unsubscribe(),this._playingSubscription=null,this._clearSubscription.unsubscribe(),this._clearSubscription=null,this._stateService.setSpeed(1),this._stateService.cutImages(),this._graphService.setGraphMode(oa.Spatial),this._setPlaying(!1))}_mapSpeed(e){const t=2*e-1;return Math.pow(10,t)-.2*t}_mapImagesAhead(e){return Math.round(Math.max(10,Math.min(50,8+6*e)))}_setPlaying(e){this._playing=e,this._playingSubject$.next(e)}_setSpeed(e){this._speed=e;const t=this._mapSpeed(this._speed);return this._imagesAhead=this._mapImagesAhead(t),t}}M0.sequenceSpeed=.54;var Bl;(function(n){n[n.Hidden=0]="Hidden",n[n.Homogeneous=1]="Homogeneous",n[n.Cluster=2]="Cluster",n[n.ConnectedComponent=3]="ConnectedComponent",n[n.Sequence=4]="Sequence"})(Bl||(Bl={}));var Xy;(function(n){n[n.Hidden=0]="Hidden",n[n.Altitude=1]="Altitude",n[n.Flat=2]="Flat"})(Xy||(Xy={}));class Vne extends Rz{constructor(e){super(),this._originalSize=e.originalSize;const{cluster:t,color:i,scale:r,translation:o}=e;this._makeAttributes(t),this.material.size=r*this._originalSize,this.setColor(i),this.matrixAutoUpdate=!1,this.position.fromArray(o),this.updateMatrix(),this.updateMatrixWorld(!1)}dispose(){this.geometry.dispose(),this.material.dispose()}setColor(e){this.material.vertexColors=e==null,this.material.color=new $i(e),this.material.needsUpdate=!0}resize(e){this.material.size=e*this._originalSize,this.material.needsUpdate=!0}_makeAttributes(e){const t=[],i=[],r=e.points;for(const c in r){if(!r.hasOwnProperty(c))continue;const s=r[c];t.push(...s.coordinates);const d=s.color;i.push(d[0]),i.push(d[1]),i.push(d[2])}const o=this.geometry;o.setAttribute("position",new En(new Float32Array(t),3)),o.setAttribute("color",new En(new Float32Array(i),3))}}class Une extends Ap{constructor(e){super(),this._makeAttributes(e),this.matrixAutoUpdate=!1,this.updateMatrix(),this.updateMatrixWorld(!1)}dispose(){this.geometry.dispose(),this.material.dispose()}_makeAttributes(e){const t=e.slice();t.push(e[0]);let i=0;const r=new Float32Array(3*(e.length+1));for(const o of t)r[i++]=o[0],r[i++]=o[1],r[i++]=o[2];this.geometry.setAttribute("position",new En(r,3))}}const jne=14,Gne=6;function I3(n,e){return n===e}function qne(n){return Math.pow(2,n)}function Wne(n){const t=qne(n)/2;return{min:[-t,-t,-t],max:[t,t,t]}}class dE{constructor(e,t,i,r){this.level=e,this.leafLevel=t,this.boundingBox=i,this.parent=r,this.children=[],this.items=[],r&&r.children.push(this)}get isEmpty(){return!(this.children.length||this.items.length)}add(e){const t=this;if(!t.boundingBox.containsPoint(e.position))throw new Error("Item not contained in node");if(I3(t.level,t.leafLevel))return t.items.push(e),this;for(const i of t.children)if(i.boundingBox.containsPoint(e.position))return i.add(e);for(const i of t._generateBoundingBoxes())if(i.containsPoint(e.position))return new dE(t.level-1,t.leafLevel,i,t).add(e);throw new Error("Item not contained in children")}intersect(e,t,i){if(e.intersectBox(this.boundingBox,t)){if(I3(this.level,this.leafLevel)){i.push(this);return}for(const r of this.children)r.intersect(e,t,i)}}remove(e){const t=this.items.indexOf(e);if(t<0)throw new Error(`Item does not exist ${e.uuid}`);this.items.splice(t,1)}traverse(){const e=this;if(!e.isEmpty)return;const t=e.parent;if(!t)return;const i=t.children.indexOf(e);if(i<0)throw new Error("Corrupt octree");t.children.splice(i,1),this.parent=null,t.traverse()}_generateBoundingBoxes(){const e=this,t=e.boundingBox.min,r=(e.boundingBox.max.x-t.x)/2,o=[[t.x,t.y+r,t.z+r],[t.x+r,t.y+r,t.z+r],[t.x,t.y,t.z+r],[t.x+r,t.y,t.z+r],[t.x,t.y+r,t.z],[t.x+r,t.y+r,t.z],[t.x,t.y,t.z],[t.x+r,t.y,t.z]],c=[];for(const[s,d,p]of o)c.push(new dl(new Ge(s,d,p),new Ge(s+r,d+r,p+r)));return c}}class Hne{constructor(e,t){if(this.rootLevel=e,this.leafLevel=t,t>e)throw new Error;this._index=new Map,this._root=this._makeRoot()}get root(){return this._root}add(e){if(!this.root.boundingBox.containsPoint(e.position)){console.warn(`Object outside bounding box ${e.uuid}`);return}const t=this._root.add(e);this._index.set(e.uuid,t)}has(e){return this._index.has(e.uuid)}intersect(e){const t=[],i=new Ge;return this._root.intersect(e,i,t),t.map(r=>r.items).reduce((r,o)=>(r.push(...o),r),[])}reset(){this._root=this._makeRoot(),this._index.clear()}remove(e){if(!this.has(e))throw new Error(`Frame does not exist ${e.uuid}`);const t=this._index.get(e.uuid);t.remove(e),t.traverse(),this._index.delete(e.uuid)}_makeRoot(){const e=this.rootLevel,t=Wne(e),i=new dl(new Ge().fromArray(t.min),new Ge().fromArray(t.max));return new dE(e,this.leafLevel,i)}}class Zne{constructor(e,t){this._objects=[],this._objectImageMap=new Map,this._octree=e??new Hne(jne,Gne),this._raycaster=t??new Lw,this._interactiveLayer=1,this._raycaster=t||new Lw(void 0,void 0,1,1e4),this._lineThreshold=.2,this._largeLineThreshold=.4,this._raycaster.params.Line.threshold=this._lineThreshold,this._raycaster.layers.set(this._interactiveLayer)}get interactiveLayer(){return this._interactiveLayer}get octree(){return this._octree}get raycaster(){return this._raycaster}add(e,t){const i=e.uuid;this._objectImageMap.set(i,t),this._objects.push(e),this._octree.add(e)}intersectObjects(e,t){this._raycaster.setFromCamera(new li().fromArray(e),t);const i=this._octree.intersect(this.raycaster.ray),r=this._raycaster.intersectObjects(i),o=this._objectImageMap;for(const c of r){const s=c.object.uuid;if(o.has(s))return o.get(s)}return null}remove(e){const t=this._objects,i=t.indexOf(e);if(i!==-1){const r=t.splice(i,1);for(const o of r)this._objectImageMap.delete(o.uuid);this._octree.remove(e)}else console.warn("Object does not exist")}resetIntersectionThreshold(e){this._raycaster.params.Line.threshold=e?this._largeLineThreshold:this._lineThreshold}}class Xne extends Ap{constructor(e){super(e.geometry,e.material);const t=e.mode,i=e.originalOrigin,o=e.transform.unprojectBasic([0,0],0);this._relativeAltitude=i[2]-o[2],this._makeAttributes(o,i,t),this.matrixAutoUpdate=!1,this.position.fromArray(o),this.updateMatrix(),this.updateMatrixWorld(!1)}dispose(){this.geometry.dispose(),this.material.dispose()}setMode(e){const t=this.geometry.attributes.position,i=t.array;i[5]=this._modeToAltitude(e),t.needsUpdate=!0,this.geometry.computeBoundingSphere()}_makeAttributes(e,t,i){const r=new Float32Array(6);r[0]=0,r[1]=0,r[2]=0,r[3]=t[0]-e[0],r[4]=t[1]-e[1],r[5]=this._modeToAltitude(i);const o=new En(r,3);this.geometry.setAttribute("position",o),o.needsUpdate=!0,this.geometry.computeBoundingSphere()}_modeToAltitude(e){return e===Xy.Altitude?this._relativeAltitude:0}}class XB extends y1{constructor(e){super(e.geometry,e.material);const t=e.color,i=e.size,r=e.scale,o=e.transform,c=o.unprojectBasic([0,0],0),s=this._makePositions(i,o,c);this._makeAttributes(s,t),this.geometry.computeBoundingSphere(),this.geometry.computeBoundingBox(),this.matrixAutoUpdate=!1,this.position.fromArray(c),this.scale.set(r,r,r),this.updateMatrix(),this.updateMatrixWorld(!1)}dispose(){this.geometry.dispose(),this.material.dispose()}setColor(e){return this._updateColorAttribute(e),this}resize(e){return this.scale.set(e,e,e),this.updateMatrix(),this.updateMatrixWorld(!1),this}_makeAttributes(e,t){const i=this.geometry,r=new En(new Float32Array(e),3);i.setAttribute("position",r),r.needsUpdate=!0;const o=new En(new Float32Array(e.length),3);i.setAttribute("color",o),this._updateColorAttribute(t)}_updateColorAttribute(e){const[t,i,r]=new $i(e).toArray(),o=this.geometry.attributes.color,c=o.array,s=c.length;let d=0;for(let p=0;p<s;p++)c[d++]=t,c[d++]=i,c[d++]=r;o.needsUpdate=!0}}class Yne extends XB{_makePositions(e,t,i){const o=[];o.push(...this._makeAxis(e,t,i)),o.push(...this._makeLat(.5,10,e,t,i));for(const c of[0,.25,.5,.75])o.push(...this._makeLng(c,10,e,t,i));return o}_makeAxis(e,t,i){const r=t.unprojectBasic([.5,1],.8*e),o=t.unprojectBasic([.5,0],1.2*e);return[r[0]-i[0],r[1]-i[1],r[2]-i[2],o[0]-i[0],o[1]-i[1],o[2]-i[2]]}_makeLat(e,t,i,r,o){const c=.8*i,[s,d,p]=o,g=[],_=r.unprojectBasic([0,e],c);_[0]-=s,_[1]-=d,_[2]-=p,g.push(..._);for(let x=1;x<=t;x++){const b=r.unprojectBasic([x/t,e],c);b[0]-=s,b[1]-=d,b[2]-=p,g.push(...b,...b)}return g.push(..._),g}_makeLng(e,t,i,r,o){const c=.8*i,[s,d,p]=o,g=[],_=r.unprojectBasic([e,0],c);_[0]-=s,_[1]-=d,_[2]-=p,g.push(..._);for(let x=0;x<=t;x++){const b=r.unprojectBasic([e,x/t],c);b[0]-=s,b[1]-=d,b[2]-=p,g.push(...b,...b)}return g.push(..._),g}}class Kne extends XB{_makePositions(e,t,i){const o=[];return o.push(...this._makeDiags(e,t,i)),o.push(...this._makeFrame(e,8,t,i)),o}_makeDiags(e,t,i){const[r,o,c]=i,s=[0,0,0],d=[];for(const p of[[0,0],[1,0],[1,1],[0,1]]){const g=t.unprojectBasic(p,e);g[0]-=r,g[1]-=o,g[2]-=c,d.push(...s,...g)}return d}_makeFrame(e,t,i,r){const o=[];o.push(...this._subsample([0,1],[0,0],t)),o.push(...this._subsample([0,0],[1,0],t)),o.push(...this._subsample([1,0],[1,1],t));const[c,s,d]=r,p=[];for(const g of o){const _=i.unprojectBasic(g,e);_[0]-=c,_[1]-=s,_[2]-=d,p.push(..._)}return p}_interpolate(e,t,i){return e+i*(t-e)}_subsample(e,t,i){if(i<1)return[e,t];const r=[];r.push(e);for(let o=0;o<=i;o++){const c=[];for(let s=0;s<3;s++)c.push(this._interpolate(e[s],t[s],o/(i+1)));r.push(c),r.push(c)}return r.push(t),r}}function Nw(n,e,t){const[i,r,o]=e,[c,s,d]=vp(i,r,o,t.lng,t.lat,t.alt);return ra(c,s,d,n.lng,n.lat,n.alt)}class Jne{constructor(e,t,i){this.id=e,this._scene=t,this._intersection=i,this.cameras=new Ln,this.keys=[],this._positionLines={},this._positions=new Ln,this._cameraFrames={},this._clusters=new Map,this._connectedComponents=new Map,this._sequences=new Map,this._props={},this.clusterVisibles={},this._frameMaterial=new Ih({fog:!1,vertexColors:!0}),this._positionMaterial=new Ih({fog:!1,color:16711680}),this._scene.add(this.cameras,this._positions)}addImage(e){const t=e.image,i=t.id;if(this.hasImage(i))throw new Error(`Image exists ${i}`);const r=e.idMap.ccId;this._connectedComponents.has(r)||this._connectedComponents.set(r,[]);const o=e.idMap.clusterId;this._clusters.has(o)||this._clusters.set(o,[]);const c=e.idMap.sequenceId;this._sequences.has(c)||this._sequences.set(c,[]),this._props[i]={image:t,ids:{ccId:r,clusterId:o,sequenceId:c}},this.keys.push(i)}applyCameraColor(e,t){this._cameraFrames[e].setColor(t)}applyCameraSize(e){for(const t of this.cameras.children)t.resize(e)}applyFilter(e){var t;const i=this.clusterVisibles;for(const s in i)i.hasOwnProperty(s)&&(i[s]=!1);const r=this._cameraFrames,o=this._positionLines,c=this._intersection.interactiveLayer;for(const s of Object.values(this._props)){const d=s.image,p=e(d),g=d.id;o[g].visible=p;const _=r[g];this._setCameraVisibility(_,p,c),i[t=s.ids.clusterId]||(i[t]=p)}}applyPositionMode(e){this._positions.visible=e!==Xy.Hidden;for(const t of this._positions.children)t.setMode(e)}dispose(){this._disposeCameras(),this._disposePositions(),this._scene=null,this._intersection=null}getCamerasByMode(e){if(e===Bl.Cluster)return this._clusters;if(e===Bl.ConnectedComponent)return this._connectedComponents;if(e===Bl.Sequence)return this._sequences;const t=Bl,i=t[t.Homogeneous],r=new Map;return r.set(i,this.cameras.children),r}getColorId(e,t){const i=this._props[e],r=Bl;switch(t){case r.Cluster:return i.ids.clusterId;case r.ConnectedComponent:return i.ids.ccId;case r.Sequence:return i.ids.sequenceId;default:return r[r.Homogeneous]}}hasImage(e){return this.keys.indexOf(e)!==-1}resetReference(e,t){const i=this._cameraFrames;for(const o in i){if(!i.hasOwnProperty(o))continue;const c=i[o];c.position.fromArray(Nw(e,c.position.toArray(),t))}const r=this._positionLines;for(const o in r){if(!r.hasOwnProperty(o))continue;const c=r[o];c.position.fromArray(Nw(e,c.position.toArray(),t))}}visualize(e){var t,i;const r=e.id,o=e.visible,c=e.transform,s={color:e.color,material:this._frameMaterial,scale:e.scale,size:e.maxSize,transform:c},d=Di(c.cameraType)?new Yne(s):new Kne(s),p=this._intersection.interactiveLayer;this._setCameraVisibility(d,o,p),this.cameras.add(d),this._cameraFrames[r]=d,this._intersection.add(d,r);const _=this._props[r].ids;(t=this.clusterVisibles)[i=_.clusterId]||(t[i]=o),this._connectedComponents.get(_.ccId).push(d),this._clusters.get(_.clusterId).push(d),this._sequences.get(_.sequenceId).push(d);const x={material:this._positionMaterial,mode:e.positionMode,originalOrigin:e.originalPosition,transform:c},b=new Xne(x);b.visible=o,this._positions.add(b),this._positionLines[r]=b}_disposeCameras(){const e=this._intersection,t=this.cameras;for(const i of t.children.slice())i.dispose(),e.remove(i),t.remove(i);this._scene.remove(this.cameras)}_disposePositions(){const e=this._positions;for(const t of e.children.slice())t.dispose(),e.remove(t);this._scene.remove(this._positions)}_setCameraVisibility(e,t,i){e.visible=t,t?e.layers.enable(i):e.layers.disable(i)}}class Qne{constructor(){this._colors=new Map;const e=Bl;this._colors.set(e[e.Homogeneous],"#FFFFFF")}getColor(e){const t=this._colors;return t.has(e)||t.set(e,this._randomColor()),t.get(e)}_randomColor(){return`hsl(${Math.floor(360*Math.random())}, 100%, 50%)`}}function w2(n){return n!==Bl.Hidden}function ere(n){return n===Bi.Custom||n===Bi.Earth}var ou;(function(n){n[n.Hidden=0]="Hidden",n[n.Original=1]="Original",n[n.Cluster=2]="Cluster"})(ou||(ou={}));const tre="NO_CLUSTER_ID",ire="NO_MERGE_ID",nre="NO_SEQUENCE_ID";class rre{constructor(e,t){this._rayNearScale=1.1,this._originalPointSize=2,this._originalCameraSize=2,this._imageCellMap=new Map,this._scene=t||new yh,this._scene.autoUpdate=!1,this._intersection=new Zne,this._assets=new Qne,this._needsRender=!1,this._images={},this._cells={},this._cellClusters={},this._clusters={},this._cameraVisualizationMode=e.cameraVisualizationMode?e.cameraVisualizationMode:Bl.Homogeneous,this._cameraSize=e.cameraSize,this._pointSize=e.pointSize,this._pointVisualizationMode=e.pointVisualizationMode?e.pointVisualizationMode:ou.Original,this._positionMode=e.originalPositionMode,this._cellsVisible=e.cellsVisible,this._hoveredId=null,this._selectedId=null,this._colors={hover:"#FF0000",select:"#FF8000"},this._filter=()=>!0}get needsRender(){return this._needsRender}get intersection(){return this._intersection}addCluster(e,t,i){if(this.hasCluster(e.id,i))return;const r=e.id;if(!(r in this._clusters)){this._clusters[r]={points:new Ln,cellIds:[]};const o=this._getClusterVisible(r),c=this._clusters[r],s=this._pointVisualizationMode===ou.Cluster?this._assets.getColor(r):null,d=new Vne({cluster:e,color:s,originalSize:this._originalPointSize,scale:this._pointSize,translation:t});c.points.visible=o,c.points.add(d),this._scene.add(c.points)}this._clusters[r].cellIds.indexOf(i)===-1&&this._clusters[r].cellIds.push(i),i in this._cellClusters||(this._cellClusters[i]={keys:[]}),this._cellClusters[i].keys.indexOf(r)===-1&&this._cellClusters[i].keys.push(r),this._needsRender=!0}addImage(e,t,i,r){var o,c,s;const d=e.id,p={clusterId:(o=e.clusterId)!==null&&o!==void 0?o:tre,sequenceId:(c=e.sequenceId)!==null&&c!==void 0?c:nre,ccId:(s=e.mergeId)!==null&&s!==void 0?s:ire};if(!(r in this._images)){const S=new Jne(r,this._scene,this._intersection);S.cameras.visible=w2(this._cameraVisualizationMode),S.applyPositionMode(this._positionMode),this._images[r]=S}const g=this._images[r];if(g.hasImage(d))return;g.addImage({idMap:p,image:e});const _=g.getColorId(d,this._cameraVisualizationMode),x=this._assets.getColor(_),b=this._filter(e);if(g.visualize({id:d,color:x,positionMode:this._positionMode,scale:this._cameraSize,transform:t,visible:b,maxSize:this._originalCameraSize,originalPosition:i}),this._imageCellMap.set(d,r),d===this._selectedId&&this._highlight(d,this._colors.select,this._cameraVisualizationMode),p.clusterId in this._clusters){const S=this._getClusterVisible(p.clusterId);this._clusters[p.clusterId].points.visible=S}this._needsRender=!0}addCell(e,t){if(this.hasCell(t))return;const i=new Une(e);this._cells[t]=new Ln,this._cells[t].visible=this._cellsVisible,this._cells[t].add(i),this._scene.add(this._cells[t]),this._needsRender=!0}deactivate(){this._filter=()=>!0,this._selectedId=null,this._hoveredId=null,this.uncache()}hasCluster(e,t){return e in this._clusters&&this._clusters[e].cellIds.indexOf(t)!==-1}hasCell(e){return e in this._cells}hasImage(e,t){return t in this._images&&this._images[t].hasImage(e)}render(e,t){t.render(this._scene,e),this._needsRender=!1}resetReference(e,t){const i=this._clusters;for(const c in i){if(!i.hasOwnProperty(c))continue;const s=i[c];s.points.position.fromArray(Nw(e,s.points.position.toArray(),t))}const r=this._cells;for(const c in r){if(!r.hasOwnProperty(c))continue;const s=r[c];s.position.fromArray(Nw(e,s.position.toArray(),t))}const o=this._images;for(const c in o){if(!o.hasOwnProperty(c))continue;o[c].resetReference(e,t)}}setCameraSize(e){if(Math.abs(e-this._cameraSize)<.001)return;const t=this._images;for(const i of Object.keys(t))t[i].applyCameraSize(e);this._intersection.raycaster.near=this._getNear(e),this._cameraSize=e,this._needsRender=!0}setFilter(e){this._filter=e;const t={};for(const r of Object.values(this._images)){r.applyFilter(e);const o=r.clusterVisibles;for(const c in o)o.hasOwnProperty(c)&&(c in t||(t[c]=!1),t[c]||(t[c]=o[c]))}const i=this._pointVisualizationMode!==ou.Hidden;for(const r in t){if(!t.hasOwnProperty(r))continue;t[r]&&(t[r]=i);const o=t[r];r in this._clusters&&(this._clusters[r].points.visible=o)}this._needsRender=!0}setHoveredImage(e){if(e!=null&&!this._imageCellMap.has(e))throw new ur(`Image does not exist: ${e}`);this._hoveredId!==e&&(this._needsRender=!0,this._hoveredId!=null&&(this._hoveredId===this._selectedId?this._highlight(this._hoveredId,this._colors.select,this._cameraVisualizationMode):this._resetCameraColor(this._hoveredId)),this._highlight(e,this._colors.hover,this._cameraVisualizationMode),this._hoveredId=e)}setNavigationState(e){this._intersection.resetIntersectionThreshold(e)}setPointSize(e){if(Math.abs(e-this._pointSize)<.001)return;const t=this._clusters;for(const i in t)if(t.hasOwnProperty(i))for(const r of t[i].points.children)r.resize(e);this._pointSize=e,this._needsRender=!0}setPointVisualizationMode(e){if(e!==this._pointVisualizationMode){this._pointVisualizationMode=e;for(const t in this._clusters){if(!this._clusters.hasOwnProperty(t))continue;const i=this._clusters[t];i.points.visible=this._getClusterVisible(t);for(const r of i.points.children){const o=e===ou.Cluster?this._assets.getColor(t):null;r.setColor(o)}}this._needsRender=!0}}setPositionMode(e){if(e!==this._positionMode){for(const t of Object.values(this._images))t.applyPositionMode(e);this._positionMode=e,this._needsRender=!0}}setSelectedImage(e){this._selectedId!==e&&(this._needsRender=!0,this._selectedId!=null&&this._resetCameraColor(this._selectedId),this._highlight(e,this._colors.select,this._cameraVisualizationMode),this._selectedId=e)}setCellVisibility(e){if(e!==this._cellsVisible){for(const t in this._cells)this._cells.hasOwnProperty(t)&&(this._cells[t].visible=e);this._cellsVisible=e,this._needsRender=!0}}setCameraVisualizationMode(e){if(e===this._cameraVisualizationMode)return;const t=w2(e),i=this._assets;for(const r of Object.values(this._images))r.cameras.visible=t,r.getCamerasByMode(e).forEach((c,s)=>{const d=i.getColor(s);for(const p of c)p.setColor(d)});this._highlight(this._hoveredId,this._colors.hover,e),this._highlight(this._selectedId,this._colors.select,e),this._cameraVisualizationMode=e,this._needsRender=!0}uncache(e){for(const t of Object.keys(this._cellClusters))e&&e.indexOf(t)!==-1||this._disposeReconstruction(t);for(const t of Object.keys(this._images)){if(e&&e.indexOf(t)!==-1)continue;const i=this._imageCellMap,r=this._images[t].keys;for(const o of r)i.delete(o);this._images[t].dispose(),delete this._images[t]}for(const t of Object.keys(this._cells))e&&e.indexOf(t)!==-1||this._disposeCell(t);this._needsRender=!0}_getClusterVisible(e){if(this._pointVisualizationMode===ou.Hidden)return!1;let t=!1;for(const i of Object.values(this._images)){const r=i.clusterVisibles;e in r&&(t||(t=r[e]))}return t}_disposePoints(e){for(const t of this._cellClusters[e].keys){if(!(t in this._clusters))continue;const i=this._clusters[t].cellIds.indexOf(e);if(i!==-1&&(this._clusters[t].cellIds.splice(i,1),!(this._clusters[t].cellIds.length>0))){for(const r of this._clusters[t].points.children.slice())r.dispose();this._scene.remove(this._clusters[t].points),delete this._clusters[t]}}}_disposeReconstruction(e){this._disposePoints(e),delete this._cellClusters[e]}_disposeCell(e){const t=this._cells[e];for(const i of t.children.slice())i.dispose(),t.remove(i);this._scene.remove(t),delete this._cells[e]}_getNear(e){const t=this._rayNearScale*this._originalCameraSize*e;return Math.max(1,t)}_resetCameraColor(e){const t=this._imageCellMap;if(e==null||!t.has(e))return;const i=t.get(e),r=this._images[i],o=r.getColorId(e,this._cameraVisualizationMode),c=this._assets.getColor(o);r.applyCameraColor(e,c)}_highlight(e,t,i){const r=this._imageCellMap;if(e==null||!r.has(e))return;const o=r.get(e);t=i===Bl.Homogeneous?t:"#FFFFFF",this._images[o].applyCameraColor(e,t)}}class sre{constructor(e,t){this._graphService=e,this._data=t,this._cells={},this._cacheRequests={},this._clusters={},this._clusterCells={},this._cellClusters={},this._cachingCells$={},this._cachingClusters$={}}cacheClusters$(e){if(!this.hasCell(e))throw new Error("Cannot cache reconstructions of a non-existing cell.");if(this.hasClusters(e))throw new Error("Cannot cache reconstructions that already exists.");if(this.isCachingClusters(e))return this._cachingClusters$[e];const t=this.getCell(e).filter(c=>!!c.clusterId&&!!c.clusterUrl).map(c=>({key:c.clusterId,url:c.clusterUrl})),i=Array.from(new Map(t.map(c=>[c.key,c])).values());this._cellClusters[e]=i,this._cacheRequests[e]=[];let r;const o=new Promise((c,s)=>{r=s});return this._cacheRequests[e].push(r),this._cachingClusters$[e]=this._cacheClusters$(i,e,o).pipe(va(()=>{e in this._cachingClusters$&&delete this._cachingClusters$[e],e in this._cacheRequests&&delete this._cacheRequests[e]}),Qa(),_i()),this._cachingClusters$[e]}cacheCell$(e){if(this.hasCell(e))throw new Error("Cannot cache cell that already exists.");return this.isCachingCell(e)?this._cachingCells$[e]:(this._cachingCells$[e]=this._graphService.cacheCell$(e).pipe(Un(t=>(console.error(t),Ni())),ai(()=>!(e in this._cells)),Dr(t=>{this._cells[e]=[],this._cells[e].push(...t),delete this._cachingCells$[e]}),va(()=>{e in this._cachingCells$&&delete this._cachingCells$[e]}),Qa(),_i()),this._cachingCells$[e])}isCachingClusters(e){return e in this._cachingClusters$}isCachingCell(e){return e in this._cachingCells$}hasClusters(e){if(e in this._cachingClusters$||!(e in this._cellClusters))return!1;for(const t of this._cellClusters[e])if(!(t.key in this._clusters))return!1;return!0}hasCell(e){return!(e in this._cachingCells$)&&e in this._cells}getClusters(e){return e in this._cellClusters?this._cellClusters[e].map(t=>this._clusters[t.key]).filter(t=>!!t):[]}getCell(e){return e in this._cells?this._cells[e]:[]}uncache(e){for(let t of Object.keys(this._cacheRequests))if(!(e&&e.indexOf(t)!==-1)){for(const i of this._cacheRequests[t])i();delete this._cacheRequests[t]}for(let t of Object.keys(this._cellClusters))if(!(e&&e.indexOf(t)!==-1)){for(const i of this._cellClusters[t]){if(!(i.key in this._clusterCells))continue;const r=this._clusterCells[i.key].indexOf(t);r!==-1&&(this._clusterCells[i.key].splice(r,1),!(this._clusterCells[i.key].length>0)&&(delete this._clusterCells[i.key],delete this._clusters[i.key]))}delete this._cellClusters[t]}for(let t of Object.keys(this._cells))e&&e.indexOf(t)!==-1||delete this._cells[t]}updateCell$(e){if(!this.hasCell(e))throw new Error("Cannot update cell that does not exists.");return this._graphService.cacheCell$(e).pipe(Un(t=>(console.error(t),Ni())),ai(()=>e in this._cells),Dr(t=>{this._cells[e]=[],this._cells[e].push(...t)}),Qa(),_i())}updateClusters$(e){if(!this.hasCell(e))throw new Error("Cannot update reconstructions of a non-existing cell.");if(!this.hasClusters(e))throw new Error("Cannot update reconstructions for cell that is not cached.");const t=this.getCell(e).filter(r=>!!r.clusterId&&!!r.clusterUrl).map(r=>({key:r.clusterId,url:r.clusterUrl})),i=Array.from(new Map(t.map(r=>[r.key,r])).values()).filter(r=>!(r.key in this._clusters));return this._cellClusters[e].push(...i),this._cacheClusters$(i,e,null)}_cacheClusters$(e,t,i){return Fr(e).pipe(Hi(r=>this._hasCluster(r.key)?Pi(this._getCluster(r.key)):this._getCluster$(r.url,r.key,i).pipe(Un(o=>(o instanceof Ul||console.error(o),Ni()))),6),ai(()=>t in this._cellClusters),Dr(r=>{this._hasCluster(r.id)||(this._clusters[r.id]=r),r.id in this._clusterCells||(this._clusterCells[r.id]=[]),this._clusterCells[r.id].indexOf(t)===-1&&this._clusterCells[r.id].push(t)}))}_getCluster(e){return this._clusters[e]}_getCluster$(e,t,i){return _r.create(r=>{this._data.getCluster(e,i).then(o=>{o.id=t,r.next(o),r.complete()},o=>{r.error(o)})})}_hasCluster(e){return e in this._clusters}}function S2(n,e,t){const i=new Set;return i.add(n),YB(i,[n],0,e,t),Array.from(i)}function YB(n,e,t,i,r){if(t>=i)return;const o=[];for(const s of e){const d=r.getAdjacent(s);o.push(...d)}const c=[];for(const s of o)n.has(s)||(n.add(s),c.push(s));YB(n,c,t+1,i,r)}class KB extends So{constructor(e,t,i){super(e,t,i),this._cache=new sre(i.graphService,i.api.data),this._scene=new rre(this._getDefaultConfiguration()),this._viewportCoords=new $o,this._spatial=new xo}getFrameIdAt(e){return new Promise((t,i)=>{this._container.renderService.renderCamera$.pipe(wi(),st(r=>{const o=this._viewportCoords.canvasToViewport(e[0],e[1],this._container.container);return this._scene.intersection.intersectObjects(o,r.perspective)})).subscribe(r=>{t(r)},r=>{i(r)})})}_activate(){this._navigator.cacheService.configure({cellDepth:3});const e=this._subscriptions;e.push(this._navigator.stateService.reference$.pipe(rl()).subscribe(([x,b])=>{this._scene.resetReference(b,x)})),e.push(this._navigator.graphService.filter$.subscribe(x=>{this._scene.setFilter(x)}));const t=this._container.renderService.bearing$.pipe(st(x=>6*Math.floor(x/6)),yi(),Ii(1),_i()),i=this._navigator.stateService.currentImage$.pipe(st(x=>this._navigator.api.data.geometry.lngLatToCellId(x.originalLngLat)),yi(),Ii(1),_i()),r=this._configuration$.pipe(st(x=>this._spatial.clamp(x.cellGridDepth,1,3)),yi(),Ii(1),_i()),o=Si(this._navigator.playService.playing$,this._navigator.playService.speed$).pipe(st(([x,b])=>x&&b>M0.sequenceSpeed),yi(),Ii(1),_i()),c=this._navigator.stateService.state$.pipe(st(x=>ere(x)),yi(),Ii(1),_i());e.push(c.subscribe(x=>{this._scene.setNavigationState(x)}));const s=Si(c,o,t,r,this._navigator.stateService.currentImage$).pipe(yi(([x,b,S,P,L],[E,C,D,O,U])=>{if(x!==E)return!1;const j=L.id===U.id&&b===C&&P===O;return x?j:j&&S===D}),MT(([x,b,S,P,L])=>{if(x){const C=this._navigator.api.data.geometry,D=C.lngLatToCellId(L.originalLngLat),O=b?[D]:S2(D,P,C);return Pi(O)}const E=b?30:90;return Pi(this._cellsInFov(L,S,E))}),ei(x=>Fr(x).pipe(Hi(b=>(this._cache.hasCell(b)?Pi(this._cache.getCell(b)):this._cache.cacheCell$(b)).pipe(st(P=>({id:b,images:P}))),6))));e.push(s.pipe(Ui(this._navigator.stateService.reference$)).subscribe(([x,b])=>{this._scene.hasCell(x.id)||this._scene.addCell(this._cellToTopocentric(x.id,b),x.id)})),e.push(s.pipe(Ui(this._navigator.stateService.reference$)).subscribe(([x,b])=>{this._addSceneImages(x,b)})),e.push(s.pipe(MT(x=>{const b=x.id;let S;return this._cache.hasClusters(b)?S=Fr(this._cache.getClusters(b)):this._cache.isCachingClusters(b)?S=this._cache.cacheClusters$(b).pipe(Wg(null,{}),ei(()=>Fr(this._cache.getClusters(b)))):this._cache.hasCell(b)?S=this._cache.cacheClusters$(b):S=Ni(),Si(Pi(b),S)}),Ui(this._navigator.stateService.reference$)).subscribe(([[x,b],S])=>{this._scene.hasCluster(b.id,x)||this._scene.addCluster(b,this._computeTranslation(b,S),x)})),e.push(this._configuration$.pipe(st(x=>{var b;x.cameraSize=this._spatial.clamp(x.cameraSize,.01,1),x.pointSize=this._spatial.clamp(x.pointSize,.01,1);const S=x.pointsVisible?(b=x.pointVisualizationMode)!==null&&b!==void 0?b:ou.Original:ou.Hidden;return{cameraSize:x.cameraSize,cameraVisualizationMode:x.cameraVisualizationMode,cellsVisible:x.cellsVisible,originalPositionMode:x.originalPositionMode,pointSize:x.pointSize,pointVisualizationMode:S}}),yi((x,b)=>x.cameraSize===b.cameraSize&&x.cameraVisualizationMode===b.cameraVisualizationMode&&x.cellsVisible===b.cellsVisible&&x.originalPositionMode===b.originalPositionMode&&x.pointSize===b.pointSize&&x.pointVisualizationMode===b.pointVisualizationMode)).subscribe(x=>{this._scene.setCameraSize(x.cameraSize);const b=x.cameraVisualizationMode;this._scene.setCameraVisualizationMode(b),this._scene.setCellVisibility(x.cellsVisible),this._scene.setPointSize(x.pointSize);const S=x.pointVisualizationMode;this._scene.setPointVisualizationMode(S);const P=x.originalPositionMode;this._scene.setPositionMode(P)})),e.push(Si(i,r).subscribe(([x,b])=>{const S=S2(x,b,this._navigator.api.data.geometry);this._scene.uncache(S),this._cache.uncache(S)})),e.push(this._navigator.playService.playing$.pipe(ei(x=>x?Ni():this._container.mouseService.dblClick$),Ui(this._container.renderService.renderCamera$),ei(([x,b])=>{const S=this._container.container,[P,L]=this._viewportCoords.canvasPosition(x,S),E=this._viewportCoords.canvasToViewport(P,L,S),C=this._scene.intersection.intersectObjects(E,b.perspective);return C?this._navigator.moveTo$(C).pipe(Un(()=>Ni())):Ni()})).subscribe());const d=Si(this._configuration$,this._navigator.stateService.state$).pipe(st(([x,b])=>(x.cameraSize=this._spatial.clamp(x.cameraSize,.01,1),{size:x.cameraSize,visible:w2(x.cameraVisualizationMode),state:b})),yi((x,b)=>x.size===b.size&&x.visible===b.visible&&x.state===b.state)),p=this._container.mouseService.mouseMove$.pipe(Ii(1),_i());e.push(p.subscribe());const g=mn(this._container.mouseService.mouseEnter$,this._container.mouseService.mouseLeave$,this._container.mouseService.windowBlur$);e.push(Si(this._navigator.playService.playing$,g,c,this._navigator.graphService.filter$).pipe(ei(([x,b])=>!x&&b.type==="pointerenter"?Si(jl(p.pipe(Vl(1)),this._container.mouseService.mouseMove$),this._container.renderService.renderCamera$,d):Si(Pi(b),Pi(null),Pi(null)))).subscribe(([x,b])=>{if(x.type!=="pointermove"){this._scene.setHoveredImage(null);return}const S=this._container.container,[P,L]=this._viewportCoords.canvasPosition(x,S),E=this._viewportCoords.canvasToViewport(P,L,S),C=this._scene.intersection.intersectObjects(E,b.perspective);this._scene.setHoveredImage(C)})),e.push(this._navigator.stateService.currentId$.subscribe(x=>{this._scene.setSelectedImage(x)})),e.push(this._navigator.stateService.currentState$.pipe(st(x=>{const b=this._scene;return{name:this._name,renderer:{frameId:x.id,needsRender:b.needsRender,render:b.render.bind(b),pass:Rh.Opaque}}})).subscribe(this._container.glRenderer.render$));const _=this._navigator.graphService.dataAdded$.pipe(ai(x=>this._cache.hasCell(x)),Hi(x=>this._cache.updateCell$(x).pipe(st(b=>({id:x,images:b})),Ui(this._navigator.stateService.reference$))),Qa(),_i());e.push(_.subscribe(([x,b])=>{this._addSceneImages(x,b)})),e.push(_.pipe(MT(([x])=>{const b=x.id,S=this._cache;let P;return S.hasClusters(b)?P=S.updateClusters$(b):S.isCachingClusters(b)?P=this._cache.cacheClusters$(b).pipe(Wg(null,{}),ei(()=>Fr(S.updateClusters$(b)))):P=Ni(),Si(Pi(b),P)}),Ui(this._navigator.stateService.reference$)).subscribe(([[x,b],S])=>{this._scene.hasCluster(b.id,x)||this._scene.addCluster(b,this._computeTranslation(b,S),x)}))}_deactivate(){this._subscriptions.unsubscribe(),this._cache.uncache(),this._scene.deactivate(),this._navigator.cacheService.configure()}_getDefaultConfiguration(){return{cameraSize:.1,cameraVisualizationMode:Bl.Homogeneous,cellGridDepth:1,originalPositionMode:Xy.Hidden,pointSize:.1,pointsVisible:!0,pointVisualizationMode:ou.Original,cellsVisible:!1}}_addSceneImages(e,t){const i=e.id,r=e.images;for(const o of r)this._scene.hasImage(o.id,i)||this._scene.addImage(o,this._createTransform(o,t),this._computeOriginalPosition(o,t),i)}_cellsInFov(e,t,i){const r=this._spatial,o=this._navigator.api.data.geometry,c=o.lngLatToCellId(e.originalLngLat),s=[c],d=i/2,p=o.getAdjacent(c);for(const g of p){const _=o.getVertices(g);for(const x of _){const[b,S]=ra(x.lng,x.lat,0,e.lngLat.lng,e.lngLat.lat,0),P=Math.atan2(S,b),L=r.radToDeg(r.azimuthalToBearing(P));Math.abs(L-t)<d&&s.push(g)}}return s}_computeOriginalPosition(e,t){return ra(e.originalLngLat.lng,e.originalLngLat.lat,e.originalAltitude!=null?e.originalAltitude:e.computedAltitude,t.lng,t.lat,t.alt)}_cellToTopocentric(e,t){return this._navigator.api.data.geometry.getVertices(e).map(r=>ra(r.lng,r.lat,-2,t.lng,t.lat,t.alt))}_computeTranslation(e,t){return ra(e.reference.lng,e.reference.lat,e.reference.alt,t.lng,t.lat,t.alt)}_createTransform(e,t){const i=Dw({alt:e.computedAltitude,lat:e.lngLat.lat,lng:e.lngLat.lng},e.rotation,t);return new kg(e.exifOrientation,e.width,e.height,e.scale,e.rotation,i,void 0,void 0,e.cameraParameters,e.cameraType)}}KB.componentName="spatial";class fE{constructor(){this._notifyChanged$=new ri}get changed$(){return this._notifyChanged$}}class Os extends ur{constructor(e){super(e??"The provided geometry value is incorrect"),Object.setPrototypeOf(this,Os.prototype),this.name="GeometryTagError"}}class ore extends fE{constructor(e){if(super(),e.length<2)throw new Os("A points geometry must have two or more positions.");this._points=[];for(const i of e){if(i[0]<0||i[0]>1||i[1]<0||i[1]>1)throw new Os("Basic coordinates of points must be on the interval [0, 1].");this._points.push(i.slice())}}get points(){return this._points}addPoint2d(e){const t=[Math.max(0,Math.min(1,e[0])),Math.max(0,Math.min(1,e[1]))];this._points.push(t),this._notifyChanged$.next(this)}getPoint2d(e){return this._points[e].slice()}removePoint2d(e){if(e<0||e>=this._points.length||this._points.length<3)throw new Os("Index for removed point must be valid.");this._points.splice(e,1),this._notifyChanged$.next(this)}setVertex2d(e,t,i){this.setPoint2d(e,t,i)}setPoint2d(e,t,i){const r=[Math.max(0,Math.min(1,t[0])),Math.max(0,Math.min(1,t[1]))];this._points[e]=r,this._notifyChanged$.next(this)}getPoints3d(e){return this._getPoints3d(this._points,e)}getPoint3d(e,t){return t.unprojectBasic(this._points[e],200)}getPoints2d(){return this._points.slice()}getCentroid2d(e){if(!e)throw new Os("Get centroid must be called with a transform for points geometries.");const[t,i,r,o]=this.getRect2d(e),c=t<r?(t+r)/2:(t+r+1)/2%1,s=(i+o)/2;return[c,s]}getCentroid3d(e){let t=this.getCentroid2d();return e.unprojectBasic(t,200)}getRect2d(e){let t=1,i=0,r=1,o=0;const c=this._points;for(const s of c)s[0]<t&&(t=s[0]),s[0]>i&&(i=s[0]),s[1]<r&&(r=s[1]),s[1]>o&&(o=s[1]);if(Di(e.cameraType)){const s=[];for(let g=0;g<c.length;g++)s[g]=g;s.sort((g,_)=>c[g][0]<c[_][0]?-1:c[g][0]>c[_][0]?1:g<_?-1:1);let d=c[s[0]][0]+1-c[s[s.length-1]][0],p=0;for(let g=0;g<s.length-1;g++){const _=s[g],x=s[g+1],b=c[x][0]-c[_][0];b>d&&(d=b,p=g+1)}p>0&&(t=c[s[p]][0],i=c[s[p-1]][0])}return[t,r,i,o]}setCentroid2d(e,t){throw new Error("Not implemented")}_getPoints3d(e,t){return e.map(i=>t.unprojectBasic(i,200))}}class JB{constructor(e,t,i){this._geometry=e,this._transform=t,this._viewportCoords=i||new $o,this._aborted$=new ri,this._created$=new ri,this._glObjectsChanged$=new ri,this._geometryChangedSubscription=this._geometry.changed$.subscribe(()=>{this._onGeometryChanged(),this._glObjectsChanged$.next(this)})}get geometry(){return this._geometry}get glObjects(){return this._glObjects}get aborted$(){return this._aborted$}get created$(){return this._created$}get glObjectsChanged$(){return this._glObjectsChanged$}get geometryChanged$(){return this._geometry.changed$.pipe(st(()=>this))}dispose(){this._geometryChangedSubscription.unsubscribe()}_canvasToTransform(e){const t=Math.round(e[0]),i=Math.round(e[1]);return`translate(-50%,-50%) translate(${t}px,${i}px)`}_colorToBackground(e){return"#"+("000000"+e.toString(16)).substr(-6)}_createOutine(e,t){const i=this._getLinePositions(e),r=new jn;r.setAttribute("position",new En(i,3));const o=new Ih({color:t,linewidth:1});return new Ap(r,o)}_disposeLine(e){e!=null&&(e.geometry.dispose(),e.material.dispose())}_getLinePositions(e){const t=e.length,i=new Float32Array(t*3);for(let r=0;r<t;++r){const o=3*r,c=e[r];i[o]=c[0],i[o+1]=c[1],i[o+2]=c[2]}return i}}var pE={exports:{}};pE.exports=E1;pE.exports.default=E1;function E1(n,e,t){t=t||2;var i=e&&e.length,r=i?e[0]*t:n.length,o=QB(n,0,r,t,!0),c=[];if(!o||o.next===o.prev)return c;var s,d,p,g,_,x,b;if(i&&(o=hre(n,e,o,t)),n.length>80*t){s=p=n[0],d=g=n[1];for(var S=t;S<r;S+=t)_=n[S],x=n[S+1],_<s&&(s=_),x<d&&(d=x),_>p&&(p=_),x>g&&(g=x);b=Math.max(p-s,g-d),b=b!==0?1/b:0}return Yy(o,c,t,s,d,b),c}function QB(n,e,t,i,r){var o,c;if(r===C2(n,e,t,i)>0)for(o=e;o<t;o+=i)c=R3(o,n[o],n[o+1],c);else for(o=t-i;o>=e;o-=i)c=R3(o,n[o],n[o+1],c);return c&&A1(c,c.next)&&(Jy(c),c=c.next),c}function qd(n,e){if(!n)return n;e||(e=n);var t=n,i;do if(i=!1,!t.steiner&&(A1(t,t.next)||us(t.prev,t,t.next)===0)){if(Jy(t),t=e=t.prev,t===t.next)break;i=!0}else t=t.next;while(i||t!==e);return e}function Yy(n,e,t,i,r,o,c){if(n){!c&&o&&gre(n,i,r,o);for(var s=n,d,p;n.prev!==n.next;){if(d=n.prev,p=n.next,o?lre(n,i,r,o):are(n)){e.push(d.i/t),e.push(n.i/t),e.push(p.i/t),Jy(n),n=p.next,s=p.next;continue}if(n=p,n===s){c?c===1?(n=cre(qd(n),e,t),Yy(n,e,t,i,r,o,2)):c===2&&ure(n,e,t,i,r,o):Yy(qd(n),e,t,i,r,o,1);break}}}}function are(n){var e=n.prev,t=n,i=n.next;if(us(e,t,i)>=0)return!1;for(var r=n.next.next;r!==n.prev;){if(xg(e.x,e.y,t.x,t.y,i.x,i.y,r.x,r.y)&&us(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function lre(n,e,t,i){var r=n.prev,o=n,c=n.next;if(us(r,o,c)>=0)return!1;for(var s=r.x<o.x?r.x<c.x?r.x:c.x:o.x<c.x?o.x:c.x,d=r.y<o.y?r.y<c.y?r.y:c.y:o.y<c.y?o.y:c.y,p=r.x>o.x?r.x>c.x?r.x:c.x:o.x>c.x?o.x:c.x,g=r.y>o.y?r.y>c.y?r.y:c.y:o.y>c.y?o.y:c.y,_=T2(s,d,e,t,i),x=T2(p,g,e,t,i),b=n.prevZ,S=n.nextZ;b&&b.z>=_&&S&&S.z<=x;){if(b!==n.prev&&b!==n.next&&xg(r.x,r.y,o.x,o.y,c.x,c.y,b.x,b.y)&&us(b.prev,b,b.next)>=0||(b=b.prevZ,S!==n.prev&&S!==n.next&&xg(r.x,r.y,o.x,o.y,c.x,c.y,S.x,S.y)&&us(S.prev,S,S.next)>=0))return!1;S=S.nextZ}for(;b&&b.z>=_;){if(b!==n.prev&&b!==n.next&&xg(r.x,r.y,o.x,o.y,c.x,c.y,b.x,b.y)&&us(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;S&&S.z<=x;){if(S!==n.prev&&S!==n.next&&xg(r.x,r.y,o.x,o.y,c.x,c.y,S.x,S.y)&&us(S.prev,S,S.next)>=0)return!1;S=S.nextZ}return!0}function cre(n,e,t){var i=n;do{var r=i.prev,o=i.next.next;!A1(r,o)&&eN(r,i,i.next,o)&&Ky(r,o)&&Ky(o,r)&&(e.push(r.i/t),e.push(i.i/t),e.push(o.i/t),Jy(i),Jy(i.next),i=n=o),i=i.next}while(i!==n);return qd(i)}function ure(n,e,t,i,r,o){var c=n;do{for(var s=c.next.next;s!==c.prev;){if(c.i!==s.i&&yre(c,s)){var d=tN(c,s);c=qd(c,c.next),d=qd(d,d.next),Yy(c,e,t,i,r,o),Yy(d,e,t,i,r,o);return}s=s.next}c=c.next}while(c!==n)}function hre(n,e,t,i){var r=[],o,c,s,d,p;for(o=0,c=e.length;o<c;o++)s=e[o]*i,d=o<c-1?e[o+1]*i:n.length,p=QB(n,s,d,i,!1),p===p.next&&(p.steiner=!0),r.push(vre(p));for(r.sort(dre),o=0;o<r.length;o++)t=fre(r[o],t),t=qd(t,t.next);return t}function dre(n,e){return n.x-e.x}function fre(n,e){var t=pre(n,e);if(!t)return e;var i=tN(t,n),r=qd(t,t.next);return qd(i,i.next),e===t?r:e}function pre(n,e){var t=e,i=n.x,r=n.y,o=-1/0,c;do{if(r<=t.y&&r>=t.next.y&&t.next.y!==t.y){var s=t.x+(r-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(s<=i&&s>o){if(o=s,s===i){if(r===t.y)return t;if(r===t.next.y)return t.next}c=t.x<t.next.x?t:t.next}}t=t.next}while(t!==e);if(!c)return null;if(i===o)return c;var d=c,p=c.x,g=c.y,_=1/0,x;t=c;do i>=t.x&&t.x>=p&&i!==t.x&&xg(r<g?i:o,r,p,g,r<g?o:i,r,t.x,t.y)&&(x=Math.abs(r-t.y)/(i-t.x),Ky(t,n)&&(x<_||x===_&&(t.x>c.x||t.x===c.x&&mre(c,t)))&&(c=t,_=x)),t=t.next;while(t!==d);return c}function mre(n,e){return us(n.prev,n,e.prev)<0&&us(e.next,n,n.next)<0}function gre(n,e,t,i){var r=n;do r.z===null&&(r.z=T2(r.x,r.y,e,t,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next;while(r!==n);r.prevZ.nextZ=null,r.prevZ=null,_re(r)}function _re(n){var e,t,i,r,o,c,s,d,p=1;do{for(t=n,n=null,o=null,c=0;t;){for(c++,i=t,s=0,e=0;e<p&&(s++,i=i.nextZ,!!i);e++);for(d=p;s>0||d>0&&i;)s!==0&&(d===0||!i||t.z<=i.z)?(r=t,t=t.nextZ,s--):(r=i,i=i.nextZ,d--),o?o.nextZ=r:n=r,r.prevZ=o,o=r;t=i}o.nextZ=null,p*=2}while(c>1);return n}function T2(n,e,t,i,r){return n=32767*(n-t)*r,e=32767*(e-i)*r,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n|e<<1}function vre(n){var e=n,t=n;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==n);return t}function xg(n,e,t,i,r,o,c,s){return(r-c)*(e-s)-(n-c)*(o-s)>=0&&(n-c)*(i-s)-(t-c)*(e-s)>=0&&(t-c)*(o-s)-(r-c)*(i-s)>=0}function yre(n,e){return n.next.i!==e.i&&n.prev.i!==e.i&&!bre(n,e)&&(Ky(n,e)&&Ky(e,n)&&xre(n,e)&&(us(n.prev,n,e.prev)||us(n,e.prev,e))||A1(n,e)&&us(n.prev,n,n.next)>0&&us(e.prev,e,e.next)>0)}function us(n,e,t){return(e.y-n.y)*(t.x-e.x)-(e.x-n.x)*(t.y-e.y)}function A1(n,e){return n.x===e.x&&n.y===e.y}function eN(n,e,t,i){var r=Ex(us(n,e,t)),o=Ex(us(n,e,i)),c=Ex(us(t,i,n)),s=Ex(us(t,i,e));return!!(r!==o&&c!==s||r===0&&Cx(n,t,e)||o===0&&Cx(n,i,e)||c===0&&Cx(t,n,i)||s===0&&Cx(t,e,i))}function Cx(n,e,t){return e.x<=Math.max(n.x,t.x)&&e.x>=Math.min(n.x,t.x)&&e.y<=Math.max(n.y,t.y)&&e.y>=Math.min(n.y,t.y)}function Ex(n){return n>0?1:n<0?-1:0}function bre(n,e){var t=n;do{if(t.i!==n.i&&t.next.i!==n.i&&t.i!==e.i&&t.next.i!==e.i&&eN(t,t.next,n,e))return!0;t=t.next}while(t!==n);return!1}function Ky(n,e){return us(n.prev,n,n.next)<0?us(n,e,n.next)>=0&&us(n,n.prev,e)>=0:us(n,e,n.prev)<0||us(n,n.next,e)<0}function xre(n,e){var t=n,i=!1,r=(n.x+e.x)/2,o=(n.y+e.y)/2;do t.y>o!=t.next.y>o&&t.next.y!==t.y&&r<(t.next.x-t.x)*(o-t.y)/(t.next.y-t.y)+t.x&&(i=!i),t=t.next;while(t!==n);return i}function tN(n,e){var t=new M2(n.i,n.x,n.y),i=new M2(e.i,e.x,e.y),r=n.next,o=e.prev;return n.next=e,e.prev=n,t.next=r,r.prev=t,i.next=t,t.prev=i,o.next=i,i.prev=o,i}function R3(n,e,t,i){var r=new M2(n,e,t);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Jy(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function M2(n,e,t){this.i=n,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}E1.deviation=function(n,e,t,i){var r=e&&e.length,o=r?e[0]*t:n.length,c=Math.abs(C2(n,0,o,t));if(r)for(var s=0,d=e.length;s<d;s++){var p=e[s]*t,g=s<d-1?e[s+1]*t:n.length;c-=Math.abs(C2(n,p,g,t))}var _=0;for(s=0;s<i.length;s+=3){var x=i[s]*t,b=i[s+1]*t,S=i[s+2]*t;_+=Math.abs((n[x]-n[S])*(n[b+1]-n[x+1])-(n[x]-n[b])*(n[S+1]-n[x+1]))}return c===0&&_===0?0:Math.abs((_-c)/c)};function C2(n,e,t,i){for(var r=0,o=e,c=t-i;o<t;o+=i)r+=(n[c]-n[o])*(n[o+1]+n[c+1]),c=o;return r}E1.flatten=function(n){for(var e=n[0][0].length,t={vertices:[],holes:[],dimensions:e},i=0,r=0;r<n.length;r++){for(var o=0;o<n[r].length;o++)for(var c=0;c<e;c++)t.vertices.push(n[r][o][c]);r>0&&(i+=n[r-1].length,t.holes.push(i))}return t};var L3=pE.exports,mE={exports:{}};class wre{constructor(e=[],t=Sre){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let i=(this.length>>1)-1;i>=0;i--)this._down(i)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],t=this.data.pop();return this.length--,this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:i}=this,r=t[e];for(;e>0;){const o=e-1>>1,c=t[o];if(i(r,c)>=0)break;t[e]=c,e=o}t[e]=r}_down(e){const{data:t,compare:i}=this,r=this.length>>1,o=t[e];for(;e<r;){let c=(e<<1)+1,s=t[c];const d=c+1;if(d<this.length&&i(t[d],s)<0&&(c=d,s=t[d]),i(s,o)>=0)break;t[e]=s,e=c}t[e]=o}}function Sre(n,e){return n<e?-1:n>e?1:0}var Tre=Object.freeze({__proto__:null,default:wre}),Mre=yee(Tre),Qx=Mre;Qx.default&&(Qx=Qx.default);mE.exports=iN;mE.exports.default=iN;function iN(n,e,t){e=e||1;for(var i,r,o,c,s=0;s<n[0].length;s++){var d=n[0][s];(!s||d[0]<i)&&(i=d[0]),(!s||d[1]<r)&&(r=d[1]),(!s||d[0]>o)&&(o=d[0]),(!s||d[1]>c)&&(c=d[1])}var p=o-i,g=c-r,_=Math.min(p,g),x=_/2;if(_===0){var b=[i,r];return b.distance=0,b}for(var S=new Qx(void 0,Cre),P=i;P<o;P+=_)for(var L=r;L<c;L+=_)S.push(new Sd(P+x,L+x,x,n));var E=Are(n),C=new Sd(i+p/2,r+g/2,0,n);C.d>E.d&&(E=C);for(var D=S.length;S.length;){var O=S.pop();O.d>E.d&&(E=O,t&&console.log("found best %d after %d probes",Math.round(1e4*O.d)/1e4,D)),!(O.max-E.d<=e)&&(x=O.h/2,S.push(new Sd(O.x-x,O.y-x,x,n)),S.push(new Sd(O.x+x,O.y-x,x,n)),S.push(new Sd(O.x-x,O.y+x,x,n)),S.push(new Sd(O.x+x,O.y+x,x,n)),D+=4)}t&&(console.log("num probes: "+D),console.log("best distance: "+E.d));var U=[E.x,E.y];return U.distance=E.d,U}function Cre(n,e){return e.max-n.max}function Sd(n,e,t,i){this.x=n,this.y=e,this.h=t,this.d=Ere(n,e,i),this.max=this.d+this.h*Math.SQRT2}function Ere(n,e,t){for(var i=!1,r=1/0,o=0;o<t.length;o++)for(var c=t[o],s=0,d=c.length,p=d-1;s<d;p=s++){var g=c[s],_=c[p];g[1]>e!=_[1]>e&&n<(_[0]-g[0])*(e-g[1])/(_[1]-g[1])+g[0]&&(i=!i),r=Math.min(r,Pre(n,e,g,_))}return r===0?0:(i?1:-1)*Math.sqrt(r)}function Are(n){for(var e=0,t=0,i=0,r=n[0],o=0,c=r.length,s=c-1;o<c;s=o++){var d=r[o],p=r[s],g=d[0]*p[1]-p[0]*d[1];t+=(d[0]+p[0])*g,i+=(d[1]+p[1])*g,e+=g*3}return e===0?new Sd(r[0][0],r[0][1],0,n):new Sd(t/e,i/e,0,n)}function Pre(n,e,t,i){var r=t[0],o=t[1],c=i[0]-r,s=i[1]-o;if(c!==0||s!==0){var d=((n-r)*c+(e-o)*s)/(c*c+s*s);d>1?(r=i[0],o=i[1]):d>0&&(r+=c*d,o+=s*d)}return c=n-r,s=e-o,c*c+s*s}var Ire=mE.exports;function Rre(n,e){return n>e?1:n<e?-1:0}class gE{constructor(e=Rre,t=!1){this._compare=e,this._root=null,this._size=0,this._noDuplicates=!!t}rotateLeft(e){var t=e.right;t&&(e.right=t.left,t.left&&(t.left.parent=e),t.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.left=e),e.parent=t}rotateRight(e){var t=e.left;t&&(e.left=t.right,t.right&&(t.right.parent=e),t.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.right=e),e.parent=t}_splay(e){for(;e.parent;){var t=e.parent;t.parent?t.left===e&&t.parent.left===t?(this.rotateRight(t.parent),this.rotateRight(t)):t.right===e&&t.parent.right===t?(this.rotateLeft(t.parent),this.rotateLeft(t)):t.left===e&&t.parent.right===t?(this.rotateRight(t),this.rotateLeft(t)):(this.rotateLeft(t),this.rotateRight(t)):t.left===e?this.rotateRight(t):this.rotateLeft(t)}}splay(e){for(var t,i,r,o,c;e.parent;)t=e.parent,i=t.parent,i&&i.parent?(r=i.parent,r.left===i?r.left=e:r.right=e,e.parent=r):(e.parent=null,this._root=e),o=e.left,c=e.right,e===t.left?(i&&(i.left===t?(t.right?(i.left=t.right,i.left.parent=i):i.left=null,t.right=i,i.parent=t):(o?(i.right=o,o.parent=i):i.right=null,e.left=i,i.parent=e)),c?(t.left=c,c.parent=t):t.left=null,e.right=t,t.parent=e):(i&&(i.right===t?(t.left?(i.right=t.left,i.right.parent=i):i.right=null,t.left=i,i.parent=t):(c?(i.left=c,c.parent=i):i.left=null,e.right=i,i.parent=e)),o?(t.right=o,o.parent=t):t.right=null,e.left=t,t.parent=e)}replace(e,t){e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.parent=e.parent)}minNode(e=this._root){if(e)for(;e.left;)e=e.left;return e}maxNode(e=this._root){if(e)for(;e.right;)e=e.right;return e}insert(e,t){var i=this._root,r=null,o=this._compare,c;if(this._noDuplicates)for(;i;){if(r=i,c=o(i.key,e),c===0)return;o(i.key,e)<0?i=i.right:i=i.left}else for(;i;)r=i,o(i.key,e)<0?i=i.right:i=i.left;return i={key:e,data:t,left:null,right:null,parent:r},r?o(r.key,i.key)<0?r.right=i:r.left=i:this._root=i,this.splay(i),this._size++,i}find(e){for(var t=this._root,i=this._compare;t;){var r=i(t.key,e);if(r<0)t=t.right;else if(r>0)t=t.left;else return t}return null}contains(e){for(var t=this._root,i=this._compare;t;){var r=i(e,t.key);if(r===0)return!0;r<0?t=t.left:t=t.right}return!1}remove(e){var t=this.find(e);if(!t)return!1;if(this.splay(t),!t.left)this.replace(t,t.right);else if(!t.right)this.replace(t,t.left);else{var i=this.minNode(t.right);i.parent!==t&&(this.replace(i,i.right),i.right=t.right,i.right.parent=i),this.replace(t,i),i.left=t.left,i.left.parent=i}return this._size--,!0}removeNode(e){if(!e)return!1;if(this.splay(e),!e.left)this.replace(e,e.right);else if(!e.right)this.replace(e,e.left);else{var t=this.minNode(e.right);t.parent!==e&&(this.replace(t,t.right),t.right=e.right,t.right.parent=t),this.replace(e,t),t.left=e.left,t.left.parent=t}return this._size--,!0}erase(e){var t=this.find(e);if(t){this.splay(t);var i=t.left,r=t.right,o=null;i&&(i.parent=null,o=this.maxNode(i),this.splay(o),this._root=o),r&&(i?o.right=r:this._root=r,r.parent=o),this._size--}}pop(){var e=this._root,t=null;if(e){for(;e.left;)e=e.left;t={key:e.key,data:e.data},this.remove(e.key)}return t}next(e){var t=e;if(t)if(t.right)for(t=t.right;t&&t.left;)t=t.left;else for(t=e.parent;t&&t.right===e;)e=t,t=t.parent;return t}prev(e){var t=e;if(t)if(t.left)for(t=t.left;t&&t.right;)t=t.right;else for(t=e.parent;t&&t.left===e;)e=t,t=t.parent;return t}forEach(e){for(var t=this._root,i=[],r=!1,o=0;!r;)t?(i.push(t),t=t.left):i.length>0?(t=i.pop(),e(t,o++),t=t.right):r=!0;return this}range(e,t,i,r){const o=[],c=this._compare;let s=this._root,d;for(;o.length!==0||s;)if(s)o.push(s),s=s.left;else{if(s=o.pop(),d=c(s.key,t),d>0)break;if(c(s.key,e)>=0&&i.call(r,s))return this;s=s.right}return this}keys(){for(var e=this._root,t=[],i=[],r=!1;!r;)e?(t.push(e),e=e.left):t.length>0?(e=t.pop(),i.push(e.key),e=e.right):r=!0;return i}values(){for(var e=this._root,t=[],i=[],r=!1;!r;)e?(t.push(e),e=e.left):t.length>0?(e=t.pop(),i.push(e.data),e=e.right):r=!0;return i}at(e){for(var t=this._root,i=[],r=!1,o=0;!r;)if(t)i.push(t),t=t.left;else if(i.length>0){if(t=i.pop(),o===e)return t;o++,t=t.right}else r=!0;return null}load(e=[],t=[],i=!1){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const r=e.length;return i&&A2(e,t,0,r-1,this._compare),this._root=E2(null,e,t,0,r),this._size=r,this}min(){var e=this.minNode(this._root);return e?e.key:null}max(){var e=this.maxNode(this._root);return e?e.key:null}isEmpty(){return this._root===null}get size(){return this._size}static createTree(e,t,i,r,o){return new gE(i,o).load(e,t,r)}}function E2(n,e,t,i,r){const o=r-i;if(o>0){const c=i+Math.floor(o/2),s=e[c],d=t[c],p={key:s,data:d,parent:n};return p.left=E2(p,e,t,i,c),p.right=E2(p,e,t,c+1,r),p}return null}function A2(n,e,t,i,r){if(t>=i)return;const o=n[t+i>>1];let c=t-1,s=i+1;for(;;){do c++;while(r(n[c],o)<0);do s--;while(r(n[s],o)>0);if(c>=s)break;let d=n[c];n[c]=n[s],n[s]=d,d=e[c],e[c]=e[s],e[s]=d}A2(n,e,t,s,r),A2(n,e,s+1,i,r)}const nN=0,rN=1,sN=2,oN=3,$w=0,P2=1,Vw=2,aN=3;function Bv(n,e,t){e===null?(n.inOut=!1,n.otherInOut=!0):(n.isSubject===e.isSubject?(n.inOut=!e.inOut,n.otherInOut=e.otherInOut):(n.inOut=!e.otherInOut,n.otherInOut=e.isVertical()?!e.inOut:e.inOut),e&&(n.prevInResult=!k3(e,t)||e.isVertical()?e.prevInResult:e)),k3(n,t)?n.resultTransition=Lre(n,t):n.resultTransition=0}function k3(n,e){switch(n.type){case nN:switch(e){case $w:return!n.otherInOut;case P2:return n.otherInOut;case Vw:return n.isSubject&&n.otherInOut||!n.isSubject&&!n.otherInOut;case aN:return!0}break;case sN:return e===$w||e===P2;case oN:return e===Vw;case rN:return!1}return!1}function Lre(n,e){let t=!n.inOut,i=!n.otherInOut,r;switch(e){case $w:r=t&&i;break;case P2:r=t||i;break;case aN:r=t^i;break;case Vw:n.isSubject?r=t&&!i:r=i&&!t;break}return r?1:-1}class Qg{constructor(e,t,i,r,o){this.left=t,this.point=e,this.otherEvent=i,this.isSubject=r,this.type=o||nN,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0}isBelow(e){const t=this.point,i=this.otherEvent.point;return this.left?(t[0]-e[0])*(i[1]-e[1])-(i[0]-e[0])*(t[1]-e[1])>0:(i[0]-e[0])*(t[1]-e[1])-(t[0]-e[0])*(i[1]-e[1])>0}isAbove(e){return!this.isBelow(e)}isVertical(){return this.point[0]===this.otherEvent.point[0]}get inResult(){return this.resultTransition!==0}clone(){const e=new Qg(this.point,this.left,this.otherEvent,this.isSubject,this.type);return e.contourId=this.contourId,e.resultTransition=this.resultTransition,e.prevInResult=this.prevInResult,e.isExteriorRing=this.isExteriorRing,e.inOut=this.inOut,e.otherInOut=this.otherInOut,e}}function iu(n,e){return n[0]===e[0]?n[1]===e[1]:!1}const bh=11102230246251565e-32,Po=134217729,kre=(3+8*bh)*bh;function pM(n,e,t,i,r){let o,c,s,d,p=e[0],g=i[0],_=0,x=0;g>p==g>-p?(o=p,p=e[++_]):(o=g,g=i[++x]);let b=0;if(_<n&&x<t)for(g>p==g>-p?(c=p+o,s=o-(c-p),p=e[++_]):(c=g+o,s=o-(c-g),g=i[++x]),o=c,s!==0&&(r[b++]=s);_<n&&x<t;)g>p==g>-p?(c=o+p,d=c-o,s=o-(c-d)+(p-d),p=e[++_]):(c=o+g,d=c-o,s=o-(c-d)+(g-d),g=i[++x]),o=c,s!==0&&(r[b++]=s);for(;_<n;)c=o+p,d=c-o,s=o-(c-d)+(p-d),p=e[++_],o=c,s!==0&&(r[b++]=s);for(;x<t;)c=o+g,d=c-o,s=o-(c-d)+(g-d),g=i[++x],o=c,s!==0&&(r[b++]=s);return(o!==0||b===0)&&(r[b++]=o),b}function Dre(n,e){let t=e[0];for(let i=1;i<n;i++)t+=e[i];return t}function C0(n){return new Float64Array(n)}const Fre=(3+16*bh)*bh,Ore=(2+12*bh)*bh,zre=(9+64*bh)*bh*bh,ag=C0(4),D3=C0(8),F3=C0(12),O3=C0(16),Jo=C0(4);function Bre(n,e,t,i,r,o,c){let s,d,p,g,_,x,b,S,P,L,E,C,D,O,U,j,G,N;const V=n-r,q=t-r,z=e-o,Q=i-o;O=V*Q,x=Po*V,b=x-(x-V),S=V-b,x=Po*Q,P=x-(x-Q),L=Q-P,U=S*L-(O-b*P-S*P-b*L),j=z*q,x=Po*z,b=x-(x-z),S=z-b,x=Po*q,P=x-(x-q),L=q-P,G=S*L-(j-b*P-S*P-b*L),E=U-G,_=U-E,ag[0]=U-(E+_)+(_-G),C=O+E,_=C-O,D=O-(C-_)+(E-_),E=D-j,_=D-E,ag[1]=D-(E+_)+(_-j),N=C+E,_=N-C,ag[2]=C-(N-_)+(E-_),ag[3]=N;let X=Dre(4,ag),re=Ore*c;if(X>=re||-X>=re||(_=n-V,s=n-(V+_)+(_-r),_=t-q,p=t-(q+_)+(_-r),_=e-z,d=e-(z+_)+(_-o),_=i-Q,g=i-(Q+_)+(_-o),s===0&&d===0&&p===0&&g===0)||(re=zre*c+kre*Math.abs(X),X+=V*g+Q*s-(z*p+q*d),X>=re||-X>=re))return X;O=s*Q,x=Po*s,b=x-(x-s),S=s-b,x=Po*Q,P=x-(x-Q),L=Q-P,U=S*L-(O-b*P-S*P-b*L),j=d*q,x=Po*d,b=x-(x-d),S=d-b,x=Po*q,P=x-(x-q),L=q-P,G=S*L-(j-b*P-S*P-b*L),E=U-G,_=U-E,Jo[0]=U-(E+_)+(_-G),C=O+E,_=C-O,D=O-(C-_)+(E-_),E=D-j,_=D-E,Jo[1]=D-(E+_)+(_-j),N=C+E,_=N-C,Jo[2]=C-(N-_)+(E-_),Jo[3]=N;const oe=pM(4,ag,4,Jo,D3);O=V*g,x=Po*V,b=x-(x-V),S=V-b,x=Po*g,P=x-(x-g),L=g-P,U=S*L-(O-b*P-S*P-b*L),j=z*p,x=Po*z,b=x-(x-z),S=z-b,x=Po*p,P=x-(x-p),L=p-P,G=S*L-(j-b*P-S*P-b*L),E=U-G,_=U-E,Jo[0]=U-(E+_)+(_-G),C=O+E,_=C-O,D=O-(C-_)+(E-_),E=D-j,_=D-E,Jo[1]=D-(E+_)+(_-j),N=C+E,_=N-C,Jo[2]=C-(N-_)+(E-_),Jo[3]=N;const de=pM(oe,D3,4,Jo,F3);O=s*g,x=Po*s,b=x-(x-s),S=s-b,x=Po*g,P=x-(x-g),L=g-P,U=S*L-(O-b*P-S*P-b*L),j=d*p,x=Po*d,b=x-(x-d),S=d-b,x=Po*p,P=x-(x-p),L=p-P,G=S*L-(j-b*P-S*P-b*L),E=U-G,_=U-E,Jo[0]=U-(E+_)+(_-G),C=O+E,_=C-O,D=O-(C-_)+(E-_),E=D-j,_=D-E,Jo[1]=D-(E+_)+(_-j),N=C+E,_=N-C,Jo[2]=C-(N-_)+(E-_),Jo[3]=N;const ce=pM(de,F3,4,Jo,O3);return O3[ce-1]}function Nre(n,e,t,i,r,o){const c=(e-o)*(t-r),s=(n-r)*(i-o),d=c-s;if(c===0||s===0||c>0!=s>0)return d;const p=Math.abs(c+s);return Math.abs(d)>=Fre*p?d:-Bre(n,e,t,i,r,o,p)}function I2(n,e,t){const i=Nre(n[0],n[1],e[0],e[1],t[0],t[1]);return i>0?-1:i<0?1:0}function Wd(n,e){const t=n.point,i=e.point;return t[0]>i[0]?1:t[0]<i[0]?-1:t[1]!==i[1]?t[1]>i[1]?1:-1:$re(n,e,t)}function $re(n,e,t,i){return n.left!==e.left?n.left?1:-1:I2(t,n.otherEvent.point,e.otherEvent.point)!==0?n.isBelow(e.otherEvent.point)?-1:1:!n.isSubject&&e.isSubject?1:-1}function bd(n,e,t){const i=new Qg(e,!1,n,n.isSubject),r=new Qg(e,!0,n.otherEvent,n.isSubject);return iu(n.point,n.otherEvent.point)&&console.warn("what is that, a collapsed segment?",n),i.contourId=r.contourId=n.contourId,Wd(r,n.otherEvent)>0&&(n.otherEvent.left=!0,r.left=!1),n.otherEvent.otherEvent=r,n.otherEvent=i,t.push(r),t.push(i),t}function Ax(n,e){return n[0]*e[1]-n[1]*e[0]}function mM(n,e){return n[0]*e[0]+n[1]*e[1]}function Vre(n,e,t,i,r){const o=[e[0]-n[0],e[1]-n[1]],c=[i[0]-t[0],i[1]-t[1]];function s(L,E,C){return[L[0]+E*C[0],L[1]+E*C[1]]}const d=[t[0]-n[0],t[1]-n[1]];let p=Ax(o,c),g=p*p;const _=mM(o,o);if(g>0){const L=Ax(d,c)/p;if(L<0||L>1)return null;const E=Ax(d,o)/p;return E<0||E>1?null:L===0||L===1?[s(n,L,o)]:E===0||E===1?[s(t,E,c)]:[s(n,L,o)]}if(p=Ax(d,o),g=p*p,g>0)return null;const x=mM(o,d)/_,b=x+mM(o,c)/_,S=Math.min(x,b),P=Math.max(x,b);return S<=1&&P>=0?S===1?[s(n,S>0?S:0,o)]:P===0?[s(n,P<1?P:1,o)]:[s(n,S>0?S:0,o),s(n,P<1?P:1,o)]:null}function gM(n,e,t){const i=Vre(n.point,n.otherEvent.point,e.point,e.otherEvent.point),r=i?i.length:0;if(r===0||r===1&&(iu(n.point,e.point)||iu(n.otherEvent.point,e.otherEvent.point))||r===2&&n.isSubject===e.isSubject)return 0;if(r===1)return!iu(n.point,i[0])&&!iu(n.otherEvent.point,i[0])&&bd(n,i[0],t),!iu(e.point,i[0])&&!iu(e.otherEvent.point,i[0])&&bd(e,i[0],t),1;const o=[];let c=!1,s=!1;return iu(n.point,e.point)?c=!0:Wd(n,e)===1?o.push(e,n):o.push(n,e),iu(n.otherEvent.point,e.otherEvent.point)?s=!0:Wd(n.otherEvent,e.otherEvent)===1?o.push(e.otherEvent,n.otherEvent):o.push(n.otherEvent,e.otherEvent),c&&s||c?(e.type=rN,n.type=e.inOut===n.inOut?sN:oN,c&&!s&&bd(o[1].otherEvent,o[0].point,t),2):s?(bd(o[0],o[1].point,t),3):o[0]!==o[3].otherEvent?(bd(o[0],o[1].point,t),bd(o[1],o[2].point,t),3):(bd(o[0],o[1].point,t),bd(o[3].otherEvent,o[2].point,t),3)}function Ure(n,e){if(n===e)return 0;if(I2(n.point,n.otherEvent.point,e.point)!==0||I2(n.point,n.otherEvent.point,e.otherEvent.point)!==0)return iu(n.point,e.point)?n.isBelow(e.otherEvent.point)?-1:1:n.point[0]===e.point[0]?n.point[1]<e.point[1]?-1:1:Wd(n,e)===1?e.isAbove(n.point)?-1:1:n.isBelow(e.point)?-1:1;if(n.isSubject===e.isSubject){let t=n.point,i=e.point;if(t[0]===i[0]&&t[1]===i[1])return t=n.otherEvent.point,i=e.otherEvent.point,t[0]===i[0]&&t[1]===i[1]?0:n.contourId>e.contourId?1:-1}else return n.isSubject?-1:1;return Wd(n,e)===1?1:-1}function jre(n,e,t,i,r,o){const c=new gE(Ure),s=[],d=Math.min(i[2],r[2]);let p,g,_;for(;n.length!==0;){let x=n.pop();if(s.push(x),x.point[0]>d||o===Vw)break;if(x.left){g=p=c.insert(x),_=c.minNode(),p!==_?p=c.prev(p):p=null,g=c.next(g);const b=p?p.key:null;let S;if(Bv(x,b,o),g&&gM(x,g.key,n)===2&&(Bv(x,b,o),Bv(x,g.key,o)),p&&gM(p.key,x,n)===2){let P=p;P!==_?P=c.prev(P):P=null,S=P?P.key:null,Bv(b,S,o),Bv(x,b,o)}}else x=x.otherEvent,g=p=c.find(x),p&&g&&(p!==_?p=c.prev(p):p=null,g=c.next(g),c.remove(x),g&&p&&gM(p.key,g.key,n))}return s}class Gre{constructor(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null}isExterior(){return this.holeOf==null}}function qre(n){let e,t,i,r;const o=[];for(t=0,i=n.length;t<i;t++)e=n[t],(e.left&&e.inResult||!e.left&&e.otherEvent.inResult)&&o.push(e);let c=!1;for(;!c;)for(c=!0,t=0,i=o.length;t<i;t++)t+1<i&&Wd(o[t],o[t+1])===1&&(r=o[t],o[t]=o[t+1],o[t+1]=r,c=!1);for(t=0,i=o.length;t<i;t++)e=o[t],e.otherPos=t;for(t=0,i=o.length;t<i;t++)e=o[t],e.left||(r=e.otherPos,e.otherPos=e.otherEvent.otherPos,e.otherEvent.otherPos=r);return o}function Wre(n,e,t,i){let r=n+1,o=e[n].point,c;const s=e.length;for(r<s&&(c=e[r].point);r<s&&c[0]===o[0]&&c[1]===o[1];){if(t[r])r++;else return r;c=e[r].point}for(r=n-1;t[r]&&r>i;)r--;return r}function Hre(n,e,t){const i=new Gre;if(n.prevInResult!=null){const r=n.prevInResult,o=r.outputContourId;if(r.resultTransition>0){const s=e[o];if(s.holeOf!=null){const d=s.holeOf;e[d].holeIds.push(t),i.holeOf=d,i.depth=e[o].depth}else e[o].holeIds.push(t),i.holeOf=o,i.depth=e[o].depth+1}else i.holeOf=null,i.depth=e[o].depth}else i.holeOf=null,i.depth=0;return i}function Zre(n){let e,t;const i=qre(n),r={},o=[];for(e=0,t=i.length;e<t;e++){if(r[e])continue;const c=o.length,s=Hre(i[e],o,c),d=x=>{r[x]=!0,i[x].outputContourId=c};let p=e,g=e;const _=i[e].point;for(s.points.push(_);d(p),p=i[p].otherPos,d(p),s.points.push(i[p].point),p=Wre(p,i,r,g),p!=g;);o.push(s)}return o}var _E={exports:{}};_E.exports=Qy;_E.exports.default=Qy;function Qy(n,e){if(!(this instanceof Qy))return new Qy(n,e);if(this.data=n||[],this.length=this.data.length,this.compare=e||Xre,this.length>0)for(var t=(this.length>>1)-1;t>=0;t--)this._down(t)}function Xre(n,e){return n<e?-1:n>e?1:0}Qy.prototype={push:function(n){this.data.push(n),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var n=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),n}},peek:function(){return this.data[0]},_up:function(n){for(var e=this.data,t=this.compare,i=e[n];n>0;){var r=n-1>>1,o=e[r];if(t(i,o)>=0)break;e[n]=o,n=r}e[n]=i},_down:function(n){for(var e=this.data,t=this.compare,i=this.length>>1,r=e[n];n<i;){var o=(n<<1)+1,c=o+1,s=e[o];if(c<this.length&&t(e[c],s)<0&&(o=c,s=e[c]),t(s,r)>=0)break;e[n]=s,n=o}e[n]=r}};var Yre=_E.exports;const z3=Math.max,B3=Math.min;let Px=0;function N3(n,e,t,i,r,o){let c,s,d,p,g,_;for(c=0,s=n.length-1;c<s;c++){if(d=n[c],p=n[c+1],g=new Qg(d,!1,void 0,e),_=new Qg(p,!1,g,e),g.otherEvent=_,d[0]===p[0]&&d[1]===p[1])continue;g.contourId=_.contourId=t,o||(g.isExteriorRing=!1,_.isExteriorRing=!1),Wd(g,_)>0?_.left=!0:g.left=!0;const x=d[0],b=d[1];r[0]=B3(r[0],x),r[1]=B3(r[1],b),r[2]=z3(r[2],x),r[3]=z3(r[3],b),i.push(g),i.push(_)}}function Kre(n,e,t,i,r){const o=new Yre(null,Wd);let c,s,d,p,g,_;for(d=0,p=n.length;d<p;d++)for(c=n[d],g=0,_=c.length;g<_;g++)s=g===0,s&&Px++,N3(c[g],!0,Px,o,t,s);for(d=0,p=e.length;d<p;d++)for(c=e[d],g=0,_=c.length;g<_;g++)s=g===0,s&&Px++,N3(c[g],!1,Px,o,i,s);return o}const Uw=[];function Jre(n,e,t){let i=null;return n.length*e.length===0&&(i=Uw),i}function Qre(n,e,t,i,r){let o=null;return(t[0]>i[2]||i[0]>t[2]||t[1]>i[3]||i[1]>t[3])&&(o=Uw),o}function ese(n,e,t){typeof n[0][0][0]=="number"&&(n=[n]),typeof e[0][0][0]=="number"&&(e=[e]);let i=Jre(n,e);if(i)return i===Uw?null:i;const r=[1/0,1/0,-1/0,-1/0],o=[1/0,1/0,-1/0,-1/0],c=Kre(n,e,r,o);if(i=Qre(n,e,r,o),i)return i===Uw?null:i;const s=jre(c,n,e,r,o,t),d=Zre(s),p=[];for(let g=0;g<d.length;g++){let _=d[g];if(_.isExterior()){let x=[_.points];for(let b=0;b<_.holeIds.length;b++){let S=_.holeIds[b];x.push(d[S].points)}p.push(x)}}return p}function tse(n,e){return ese(n,e,$w)}class lN extends fE{constructor(){super(),this._subsampleThreshold=.005}_getPoleOfInaccessibility2d(e){return Ire([e],.03)}_project(e,t){const i=this._createCamera(t.upVector().toArray(),t.unprojectSfM([0,0],0),t.unprojectSfM([0,0],10));return this._deunproject(e,t,i)}_subsample(e,t=this._subsampleThreshold){const i=[],r=e.length;for(let o=0;o<r;o++){const c=e[o],s=e[(o+1)%r];i.push(c);const d=Math.sqrt(Math.pow(s[0]-c[0],2)+Math.pow(s[1]-c[1],2)),p=Math.floor(d/t),g=1/(p+1);for(let _=1;_<=p;_++){const x=_*g,b=[(1-x)*c[0]+x*s[0],(1-x)*c[1]+x*s[1]];i.push(b)}}return i}_triangulate(e,t,i,r){let o=[e.slice(0,-1)];for(let g of i??[])o.push(g.slice(0,-1));let c=t.slice(0,-1);for(let g of r??[])c=c.concat(g.slice(0,-1));let s=L3.flatten(o),d=L3(s.vertices,s.holes,s.dimensions),p=[];for(let g=0;g<d.length;++g){let _=c[d[g]];p.push(_[0]),p.push(_[1]),p.push(_[2])}return p}_triangulateSpherical(e,t,i){const r=[];for(let d=0;d<3;d++)for(let p=0;p<3;p++){const g=d===0?-1e-9:1e-9,_=p===0?-1e-9:1e-9,x=d/3+g,b=p/3+_,S=(d+1)/3+1e-9,P=(p+1)/3+1e-9,L=[[x,b],[x,P],[S,P],[S,b],[x,b]],E=[(2*d+1)/6,(2*p+1)/6];r.push(...this._triangulateSubarea(e,t,L,E,i))}return r}_unproject(e,t,i=200){return e.map(r=>t.unprojectBasic(r,i))}_createCamera(e,t,i){const r=new v0;return r.up.copy(new Ge().fromArray(e)),r.position.copy(new Ge().fromArray(t)),r.lookAt(new Ge().fromArray(i)),r.updateMatrix(),r.updateMatrixWorld(!0),r}_deunproject(e,t,i){return e.map(r=>{const o=t.unprojectBasic(r,1e4),c=new Ge(o[0],o[1],o[2]).applyMatrix4(i.matrixWorldInverse);return[c.x/c.z,c.y/c.z]})}_triangulateSubarea(e,t,i,r,o){const c=tse([e,...t],[i]);if(!c)return[];const s=[],d=this._subsampleThreshold,p=this._createCamera(o.upVector().toArray(),o.unprojectSfM([0,0],0),o.unprojectBasic(r,10));for(const g of c){const _=this._subsample(g[0],d),x=this._deunproject(_,o,p),b=this._unproject(_,o),S=[],P=[];for(let L=1;L<g.length;L++){let E=this._subsample(g[L],d);const C=this._deunproject(E,o,p),D=this._unproject(E,o);S.push(C),P.push(D)}s.push(...this._triangulate(x,b,S,P))}return s}}class ba extends lN{constructor(e){if(super(),e.length!==4)throw new Os("Rectangle needs to have four values.");if(e[1]>e[3])throw new Os("Basic Y coordinates values can not be inverted.");for(let t of e)if(t<0||t>1)throw new Os("Basic coordinates must be on the interval [0, 1].");this._anchorIndex=void 0,this._rect=e.slice(0,4),this._inverted=this._rect[0]>this._rect[2]}get anchorIndex(){return this._anchorIndex}get inverted(){return this._inverted}get rect(){return this._rect}initializeAnchorIndexing(e){if(this._anchorIndex!==void 0)throw new Os("Anchor indexing is already initialized.");if(e<0||e>3)throw new Os(`Invalid anchor index: ${e}.`);this._anchorIndex=e===void 0?0:e}terminateAnchorIndexing(){this._anchorIndex=void 0}setOppositeVertex2d(e,t){if(this._anchorIndex===void 0)throw new Os("Anchor indexing needs to be initialized.");const i=[Math.max(0,Math.min(1,e[0])),Math.max(0,Math.min(1,e[1]))],r=this._rect.slice(),o=this._anchorIndex===0?[r[0],r[3]]:this._anchorIndex===1?[r[0],r[1]]:this._anchorIndex===2?[r[2],r[1]]:[r[2],r[3]];if(Di(t.cameraType)){const c=this._anchorIndex<2?i[0]-r[2]:i[0]-r[0];!this._inverted&&this._anchorIndex<2&&i[0]<.25&&r[2]>.75&&c<-.5?(this._inverted=!0,this._anchorIndex=o[1]>i[1]?0:1):!this._inverted&&this._anchorIndex>=2&&i[0]<.25&&r[2]>.75&&c<-.5?(this._inverted=!0,this._anchorIndex=o[1]>i[1]?0:1):this._inverted&&this._anchorIndex>=2&&i[0]<.25&&r[0]>.75&&c<-.5?(this._inverted=!1,o[0]>i[0]?this._anchorIndex=o[1]>i[1]?3:2:this._anchorIndex=o[1]>i[1]?0:1):!this._inverted&&this._anchorIndex>=2&&i[0]>.75&&r[0]<.25&&c>.5?(this._inverted=!0,this._anchorIndex=o[1]>i[1]?3:2):!this._inverted&&this._anchorIndex<2&&i[0]>.75&&r[0]<.25&&c>.5?(this._inverted=!0,this._anchorIndex=o[1]>i[1]?3:2):this._inverted&&this._anchorIndex<2&&i[0]>.75&&r[2]<.25&&c>.5?(this._inverted=!1,o[0]>i[0]?this._anchorIndex=o[1]>i[1]?3:2:this._anchorIndex=o[1]>i[1]?0:1):this._inverted&&this._anchorIndex<2&&i[0]>r[0]?(this._inverted=!1,this._anchorIndex=o[1]>i[1]?0:1):this._inverted&&this._anchorIndex>=2&&i[0]<r[2]?(this._inverted=!1,this._anchorIndex=o[1]>i[1]?3:2):this._inverted?this._anchorIndex<2?this._anchorIndex=o[1]>i[1]?0:1:this._anchorIndex=o[1]>i[1]?3:2:o[0]<=i[0]&&o[1]>i[1]?this._anchorIndex=0:o[0]<=i[0]&&o[1]<=i[1]?this._anchorIndex=1:o[0]>i[0]&&o[1]<=i[1]?this._anchorIndex=2:this._anchorIndex=3;const s=[];this._anchorIndex===0?(s[0]=o[0],s[1]=i[1],s[2]=i[0],s[3]=o[1]):this._anchorIndex===1?(s[0]=o[0],s[1]=o[1],s[2]=i[0],s[3]=i[1]):this._anchorIndex===2?(s[0]=i[0],s[1]=o[1],s[2]=o[0],s[3]=i[1]):(s[0]=i[0],s[1]=i[1],s[2]=o[0],s[3]=o[1]),(!this._inverted&&s[0]>s[2]||this._inverted&&s[0]<s[2])&&(s[0]=r[0],s[2]=r[2]),s[1]>s[3]&&(s[1]=r[1],s[3]=r[3]),this._rect[0]=s[0],this._rect[1]=s[1],this._rect[2]=s[2],this._rect[3]=s[3]}else{o[0]<=i[0]&&o[1]>i[1]?this._anchorIndex=0:o[0]<=i[0]&&o[1]<=i[1]?this._anchorIndex=1:o[0]>i[0]&&o[1]<=i[1]?this._anchorIndex=2:this._anchorIndex=3;const c=[];this._anchorIndex===0?(c[0]=o[0],c[1]=i[1],c[2]=i[0],c[3]=o[1]):this._anchorIndex===1?(c[0]=o[0],c[1]=o[1],c[2]=i[0],c[3]=i[1]):this._anchorIndex===2?(c[0]=i[0],c[1]=o[1],c[2]=o[0],c[3]=i[1]):(c[0]=i[0],c[1]=i[1],c[2]=o[0],c[3]=o[1]),c[0]>c[2]&&(c[0]=r[0],c[2]=r[2]),c[1]>c[3]&&(c[1]=r[1],c[3]=r[3]),this._rect[0]=c[0],this._rect[1]=c[1],this._rect[2]=c[2],this._rect[3]=c[3]}this._notifyChanged$.next(this)}setVertex2d(e,t,i){let r=this._rect.slice(),o=[Math.max(0,Math.min(1,t[0])),Math.max(0,Math.min(1,t[1]))],c=[];if(e===0?(c[0]=o[0],c[1]=r[1],c[2]=r[2],c[3]=o[1]):e===1?(c[0]=o[0],c[1]=o[1],c[2]=r[2],c[3]=r[3]):e===2?(c[0]=r[0],c[1]=o[1],c[2]=o[0],c[3]=r[3]):e===3&&(c[0]=r[0],c[1]=r[1],c[2]=o[0],c[3]=o[1]),Di(i.cameraType)){let s=e<2&&o[0]>.75&&r[0]<.25||e>=2&&this._inverted&&o[0]>.75&&r[2]<.25,d=e<2&&this._inverted&&o[0]<.25&&r[0]>.75||e>=2&&o[0]<.25&&r[2]>.75;s||d?this._inverted=!this._inverted:(c[0]-r[0]<-.25&&(c[0]=r[0]),c[2]-r[2]>.25&&(c[2]=r[2])),(!this._inverted&&c[0]>c[2]||this._inverted&&c[0]<c[2])&&(c[0]=r[0],c[2]=r[2])}else c[0]>c[2]&&(c[0]=r[0],c[2]=r[2]);c[1]>c[3]&&(c[1]=r[1],c[3]=r[3]),this._rect[0]=c[0],this._rect[1]=c[1],this._rect[2]=c[2],this._rect[3]=c[3],this._notifyChanged$.next(this)}setCentroid2d(e,t){let i=this._rect.slice(),r=i[0],o=this._inverted?i[2]+1:i[2],c=i[1],s=i[3],d=r+(o-r)/2,p=c+(s-c)/2,g=0;if(Di(t.cameraType))g=this._inverted?e[0]+1-d:e[0]-d;else{let S=-r,P=1-o;g=Math.max(S,Math.min(P,e[0]-d))}let _=-c,x=1-s,b=Math.max(_,Math.min(x,e[1]-p));this._rect[0]=i[0]+g,this._rect[1]=i[1]+b,this._rect[2]=i[2]+g,this._rect[3]=i[3]+b,this._rect[0]<0?(this._rect[0]+=1,this._inverted=!this._inverted):this._rect[0]>1&&(this._rect[0]-=1,this._inverted=!this._inverted),this._rect[2]<0?(this._rect[2]+=1,this._inverted=!this._inverted):this._rect[2]>1&&(this._rect[2]-=1,this._inverted=!this._inverted),this._notifyChanged$.next(this)}getPoints3d(e){return this._getPoints2d().map(t=>e.unprojectBasic(t,200))}getVertex2d(e){return this._rectToVertices2d(this._rect)[e]}getNonAdjustedVertex2d(e){return this._rectToNonAdjustedVertices2d(this._rect)[e]}getVertex3d(e,t){return t.unprojectBasic(this._rectToVertices2d(this._rect)[e],200)}getVertices2d(){return this._rectToVertices2d(this._rect)}getVertices3d(e){return this._rectToVertices2d(this._rect).map(t=>e.unprojectBasic(t,200))}getCentroid2d(){const e=this._rect,t=e[0],i=this._inverted?e[2]+1:e[2],r=e[1],o=e[3],c=(t+i)/2,s=(r+o)/2;return[c,s]}getCentroid3d(e){const t=this.getCentroid2d();return e.unprojectBasic(t,200)}getPoleOfInaccessibility2d(){return this._getPoleOfInaccessibility2d(this._rectToVertices2d(this._rect))}getPoleOfInaccessibility3d(e){let t=this._getPoleOfInaccessibility2d(this._rectToVertices2d(this._rect));return e.unprojectBasic(t,200)}getTriangles3d(e){return Di(e.cameraType)?[]:this._triangulate(this._project(this._getPoints2d(),e),this.getPoints3d(e))}validate(e){let t=this._rect;return!(!this._inverted&&e[0]<t[0]||e[0]-t[2]>.25||e[1]<t[1])}_getPoints2d(){let e=this._rectToVertices2d(this._rect),t=e.length-1,i=10,r=[];for(let o=0;o<t;++o){let c=e[o][0],s=e[o][1],d=e[o+1][0],p=e[o+1][1],g=(d-c)/(i-1),_=(p-s)/(i-1);for(let x=0;x<i;++x){let b=[c+x*g,s+x*_];r.push(b)}}return r}_rectToVertices2d(e){return[[e[0],e[3]],[e[0],e[1]],[this._inverted?e[2]+1:e[2],e[1]],[this._inverted?e[2]+1:e[2],e[3]],[e[0],e[3]]]}_rectToNonAdjustedVertices2d(e){return[[e[0],e[3]],[e[0],e[1]],[e[2],e[1]],[e[2],e[3]],[e[0],e[3]]]}}class ise extends JB{constructor(e,t,i,r){super(e,i,r),this._options={color:t.color==null?16777215:t.color,indicateCompleter:t.indicateCompleter==null?!0:t.indicateCompleter},this._rectGeometry=new ba(this._geometry.getRect2d(i)),this._createGlObjects()}create(){this._geometry.points.length<3||(this._geometry.removePoint2d(this._geometry.points.length-1),this._created$.next(this))}dispose(){super.dispose(),this._disposeObjects()}getDOMObjects(e,t){const i={offsetHeight:t.height,offsetWidth:t.width},r=[],o=this._geometry.getPoints2d(),c=o.length;for(let s=0;s<c-1;s++){const d=s,[p,g]=o[s],_=this._viewportCoords.basicToCanvasSafe(p,g,i,this._transform,e);if(!_)continue;const x=C=>{C.stopPropagation(),this._aborted$.next(this)},b=C=>{C.stopPropagation(),this._geometry.removePoint2d(d)},S=this._canvasToTransform(_),P={onclick:s===0&&c<3?x:b,style:{transform:S}};r.push(qt.h("div.mapillary-tag-interactor",P,[]));const E={style:{background:this._colorToBackground(this._options.color),transform:S}};r.push(qt.h("div.mapillary-tag-vertex",E,[]))}if(c>2&&this._options.indicateCompleter===!0){const[s,d]=this._geometry.getCentroid2d(this._transform),p=this._viewportCoords.basicToCanvasSafe(s,d,i,this._transform,e);if(p){const g=P=>{P.stopPropagation(),this._geometry.removePoint2d(this._geometry.points.length-1),this._created$.next(this)},_=this._canvasToTransform(p),x={onclick:g,style:{transform:_}};r.push(qt.h("div.mapillary-tag-completer.mapillary-tag-larger",x,[]));const b={style:{background:this._colorToBackground(this._options.color),transform:_}};r.push(qt.h("div.mapillary-tag-vertex.mapillary-tag-larger",b,[]));const S={style:{transform:_}};r.push(qt.h("div.mapillary-tag-dot",S,[]))}}return r}_onGeometryChanged(){this._disposeObjects(),this._rectGeometry=new ba(this._geometry.getRect2d(this._transform)),this._createGlObjects()}_createGlObjects(){this._glObjects=[];const e=this._rectGeometry.getPoints3d(this._transform);this._outline=this._createOutine(e,this._options.color),this._glObjects.push(this._outline)}_disposeObjects(){this._disposeLine(this._outline),this._outline=null,this._glObjects=null}}class xh extends lN{constructor(e,t){super();let i=e.length;if(i<3)throw new Os("A polygon must have three or more positions.");if(e[0][0]!==e[i-1][0]||e[0][1]!==e[i-1][1])throw new Os("First and last positions must be equivalent.");this._polygon=[];for(let r of e){if(r[0]<0||r[0]>1||r[1]<0||r[1]>1)throw new Os("Basic coordinates of polygon must be on the interval [0, 1].");this._polygon.push(r.slice())}if(this._holes=[],t!=null)for(let r=0;r<t.length;r++){let o=t[r],c=o.length;if(c<3)throw new Os("A polygon hole must have three or more positions.");if(o[0][0]!==o[c-1][0]||o[0][1]!==o[c-1][1])throw new Os("First and last positions of hole must be equivalent.");this._holes.push([]);for(let s of o){if(s[0]<0||s[0]>1||s[1]<0||s[1]>1)throw new Os("Basic coordinates of hole must be on the interval [0, 1].");this._holes[r].push(s.slice())}}}get polygon(){return this._polygon}get holes(){return this._holes}addVertex2d(e){let t=[Math.max(0,Math.min(1,e[0])),Math.max(0,Math.min(1,e[1]))];this._polygon.splice(this._polygon.length-1,0,t),this._notifyChanged$.next(this)}getVertex2d(e){return this._polygon[e].slice()}removeVertex2d(e){if(e<0||e>=this._polygon.length||this._polygon.length<4)throw new Os("Index for removed vertex must be valid.");if(e>0&&e<this._polygon.length-1)this._polygon.splice(e,1);else{this._polygon.splice(0,1),this._polygon.pop();let t=this._polygon[0].slice();this._polygon.push(t)}this._notifyChanged$.next(this)}setVertex2d(e,t,i){let r=[Math.max(0,Math.min(1,t[0])),Math.max(0,Math.min(1,t[1]))];e===0||e===this._polygon.length-1?(this._polygon[0]=r.slice(),this._polygon[this._polygon.length-1]=r.slice()):this._polygon[e]=r.slice(),this._notifyChanged$.next(this)}setCentroid2d(e,t){let i=this._polygon.map(L=>L[0]),r=this._polygon.map(L=>L[1]),o=Math.min.apply(Math,i),c=Math.max.apply(Math,i),s=Math.min.apply(Math,r),d=Math.max.apply(Math,r),p=this.getCentroid2d(),g=-o,_=1-c,x=-s,b=1-d,S=Math.max(g,Math.min(_,e[0]-p[0])),P=Math.max(x,Math.min(b,e[1]-p[1]));for(let L of this._polygon)L[0]+=S,L[1]+=P;this._notifyChanged$.next(this)}getPoints3d(e){return this._getPoints3d(this._subsample(this._polygon),e)}getVertex3d(e,t){return t.unprojectBasic(this._polygon[e],200)}getVertices2d(){return this._polygon.slice()}getVertices3d(e){return this._getPoints3d(this._polygon,e)}getHolePoints3d(e){return this._holes.map(t=>this._getPoints3d(this._subsample(t),e))}getHoleVertices3d(e){return this._holes.map(t=>this._getPoints3d(t,e))}getCentroid2d(){let e=this._polygon,t=0,i=0,r=0;for(let o=0;o<e.length-1;o++){let c=e[o][0],s=e[o][1],d=e[o+1][0],p=e[o+1][1],g=c*p-d*s;t+=g,i+=(c+d)*g,r+=(s+p)*g}return t/=2,i/=6*t,r/=6*t,[i,r]}getCentroid3d(e){let t=this.getCentroid2d();return e.unprojectBasic(t,200)}get3dDomainTriangles3d(e){return this._triangulate(this._project(this._polygon,e),this.getVertices3d(e),this._holes.map(t=>this._project(t,e)),this.getHoleVertices3d(e))}getTriangles3d(e){if(Di(e.cameraType))return this._triangulateSpherical(this._polygon.slice(),this.holes.slice(),e);const t=this._project(this._subsample(this._polygon),e),i=this.getPoints3d(e),r=this._holes.map(c=>this._project(this._subsample(c),e)),o=this.getHolePoints3d(e);return this._triangulate(t,i,r,o)}getPoleOfInaccessibility2d(){return this._getPoleOfInaccessibility2d(this._polygon.slice())}getPoleOfInaccessibility3d(e){let t=this._getPoleOfInaccessibility2d(this._polygon.slice());return e.unprojectBasic(t,200)}_getPoints3d(e,t){return e.map(i=>t.unprojectBasic(i,200))}}class $3 extends JB{constructor(e,t,i,r){super(e,i,r),this._options={color:t.color==null?16777215:t.color},this._createGlObjects()}create(){if(this._geometry instanceof ba)this._created$.next(this);else if(this._geometry instanceof xh){const e=this._geometry;e.removeVertex2d(e.polygon.length-2),this._created$.next(this)}}dispose(){super.dispose(),this._disposeLine(this._outline),this._disposeObjects()}getDOMObjects(e,t){const i=[],r={offsetHeight:t.height,offsetWidth:t.width},o=c=>{c.stopPropagation(),this._aborted$.next(this)};if(this._geometry instanceof ba){const c=this._geometry.anchorIndex,s=c===void 0?1:c,[d,p]=this._geometry.getVertex2d(s),g=this._viewportCoords.basicToCanvasSafe(d,p,r,this._transform,e);if(g!=null){const _=this._colorToBackground(this._options.color),x=this._canvasToTransform(g),b={style:{background:_,transform:x}},S={onclick:o,style:{transform:x}};i.push(qt.h("div.mapillary-tag-interactor",S,[])),i.push(qt.h("div.mapillary-tag-vertex",b,[]))}}else if(this._geometry instanceof xh){const c=this._geometry,[s,d]=c.getVertex2d(0),p=this._viewportCoords.basicToCanvasSafe(s,d,r,this._transform,e);if(p!=null){const _=c.polygon.length>4?P=>{P.stopPropagation(),c.removeVertex2d(c.polygon.length-2),this._created$.next(this)}:o,x=this._canvasToTransform(p),b={onclick:_,style:{transform:x}},S=c.polygon.length>4?"mapillary-tag-completer":"mapillary-tag-interactor";i.push(qt.h("div."+S,b,[]))}if(c.polygon.length>3){const[_,x]=c.getVertex2d(c.polygon.length-3),b=this._viewportCoords.basicToCanvasSafe(_,x,r,this._transform,e);if(b!=null){const S=E=>{E.stopPropagation(),c.removeVertex2d(c.polygon.length-3)},P=this._canvasToTransform(b),L={onclick:S,style:{transform:P}};i.push(qt.h("div.mapillary-tag-interactor",L,[]))}}const g=c.polygon.slice();g.splice(-2,2);for(const _ of g){const x=this._viewportCoords.basicToCanvasSafe(_[0],_[1],r,this._transform,e);if(x!=null){const b=this._colorToBackground(this._options.color),S=this._canvasToTransform(x),P={style:{background:b,transform:S}};i.push(qt.h("div.mapillary-tag-vertex",P,[]))}}}return i}addPoint(e){if(this._geometry instanceof ba){if(!this._geometry.validate(e))return;this._created$.next(this)}else this._geometry instanceof xh&&this._geometry.addVertex2d(e)}_onGeometryChanged(){this._disposeLine(this._outline),this._disposeObjects(),this._createGlObjects()}_disposeObjects(){this._outline=null,this._glObjects=[]}_createGlObjects(){const e=this._geometry instanceof ba?this._geometry.getPoints3d(this._transform):this._geometry.getVertices3d(this._transform);this._outline=this._createOutine(e,this._options.color),this._glObjects=[this._outline]}}class nse{constructor(e,t){this._component=e,this._navigator=t,this._tagOperation$=new ri,this._createPoints$=new ri,this._createPolygon$=new ri,this._createRect$=new ri,this._delete$=new ri,this._tag$=this._tagOperation$.pipe(Vr((i,r)=>r(i),null),pn()),this._replayedTag$=this._tag$.pipe(Ii(1),_i()),this._replayedTag$.subscribe(),this._createPoints$.pipe(Ui(this._component.configuration$,this._navigator.stateService.currentTransform$),st(([i,r,o])=>()=>{const c=new ore([[i[0],i[1]],[i[0],i[1]]]);return new ise(c,{color:r.createColor,indicateCompleter:r.indicatePointsCompleter},o)})).subscribe(this._tagOperation$),this._createRect$.pipe(Ui(this._component.configuration$,this._navigator.stateService.currentTransform$),st(([i,r,o])=>()=>{const c=new ba([i[0],i[1],i[0],i[1]]);return new $3(c,{color:r.createColor},o)})).subscribe(this._tagOperation$),this._createPolygon$.pipe(Ui(this._component.configuration$,this._navigator.stateService.currentTransform$),st(([i,r,o])=>()=>{const c=new xh([[i[0],i[1]],[i[0],i[1]],[i[0],i[1]]]);return new $3(c,{color:r.createColor},o)})).subscribe(this._tagOperation$),this._delete$.pipe(st(()=>()=>null)).subscribe(this._tagOperation$)}get createRect$(){return this._createRect$}get createPolygon$(){return this._createPolygon$}get createPoints$(){return this._createPoints$}get delete$(){return this._delete$}get tag$(){return this._tag$}get replayedTag$(){return this._replayedTag$}}class rse{render(e,t,i,r,o){let c=[];for(const s of e)c=c.concat(s.getDOMObjects(i,r,o));return t!=null&&(c=c.concat(t.getDOMObjects(r,o))),qt.h("div.mapillary-tag-container",{},c)}clear(){return qt.h("div",{},[])}}class sse{constructor(e,t){this._createTag=null,this._needsRender=!1,this._raycaster=t||new Lw,this._scene=e||new yh,this._objectTags={},this._retrievableObjects=[],this._tags={}}get needsRender(){return this._needsRender}add(e){for(let t of e)t.tag.id in this._tags&&this._remove(t.tag.id),this._add(t);this._needsRender=!0}addCreateTag(e){for(const t of e.glObjects)this._scene.add(t);this._createTag={tag:e,objects:e.glObjects},this._needsRender=!0}clear(){for(const e of Object.keys(this._tags))this._remove(e);this._needsRender=!1}get(e){return this.has(e)?this._tags[e].tag:void 0}has(e){return e in this._tags}hasCreateTag(){return this._createTag!=null}intersectObjects([e,t],i){this._raycaster.setFromCamera(new li(e,t),i);const r=this._raycaster.intersectObjects(this._retrievableObjects),o=[];for(const c of r)c.object.uuid in this._objectTags&&o.push(this._objectTags[c.object.uuid]);return o}remove(e){for(const t of e)this._remove(t);this._needsRender=!0}removeAll(){for(const e of Object.keys(this._tags))this._remove(e);this._needsRender=!0}removeCreateTag(){if(this._createTag!=null){for(const e of this._createTag.objects)this._scene.remove(e);this._createTag.tag.dispose(),this._createTag=null,this._needsRender=!0}}render(e,t){t.render(this._scene,e),this._needsRender=!1}update(){this._needsRender=!0}updateCreateTagObjects(e){if(this._createTag.tag!==e)throw new Error("Create tags do not have the same reference.");for(let t of this._createTag.objects)this._scene.remove(t);for(const t of e.glObjects)this._scene.add(t);this._createTag.objects=e.glObjects,this._needsRender=!0}updateObjects(e){const t=e.tag.id;if(this._tags[t].tag!==e)throw new Error("Tags do not have the same reference.");const i=this._tags[t];this._removeObjects(i),delete this._tags[t],this._add(e),this._needsRender=!0}_add(e){const t=e.tag.id,i={tag:e,objects:[],retrievableObjects:[]};this._tags[t]=i;for(const r of e.getGLObjects())i.objects.push(r),this._scene.add(r);for(const r of e.getRetrievableObjects())i.retrievableObjects.push(r),this._retrievableObjects.push(r),this._objectTags[r.uuid]=e.tag.id}_remove(e){const t=this._tags[e];this._removeObjects(t),t.tag.dispose(),delete this._tags[e]}_removeObjects(e){for(const t of e.objects)this._scene.remove(t);for(const t of e.retrievableObjects){const i=this._retrievableObjects.indexOf(t);i!==-1&&this._retrievableObjects.splice(i,1)}}}var wg;(function(n){n[n.Default=0]="Default",n[n.CreatePoint=1]="CreatePoint",n[n.CreatePoints=2]="CreatePoints",n[n.CreatePolygon=3]="CreatePolygon",n[n.CreateRect=4]="CreateRect",n[n.CreateRectDrag=5]="CreateRectDrag"})(wg||(wg={}));var sl;(function(n){n[n.None=0]="None",n[n.Centroid=1]="Centroid",n[n.Vertex=2]="Vertex"})(sl||(sl={}));class cN{constructor(e,t,i){this._tag=e,this._transform=t,this._viewportCoords=i||new $o,this._glObjectsChanged$=new ri,this._interact$=new ri}get glObjectsChanged$(){return this._glObjectsChanged$}get interact$(){return this._interact$}get tag(){return this._tag}}class uN extends cN{constructor(e,t){super(e,t),this._geometryChangedSubscription=this._tag.geometry.changed$.subscribe(()=>{this._onGeometryChanged()}),this._changedSubscription=this._tag.changed$.subscribe(()=>{this._onTagChanged()&&this._glObjectsChanged$.next(this)})}dispose(){this._changedSubscription.unsubscribe(),this._geometryChangedSubscription.unsubscribe()}_colorToCss(e){return"#"+("000000"+e.toString(16)).substr(-6)}_createFill(){let e=this._getTriangles(),t=new Float32Array(e),i=new jn;i.setAttribute("position",new En(t,3)),i.computeBoundingSphere();let r=new g0({side:ea,transparent:!0});return this._updateFillMaterial(r),new kr(i,r)}_createLine(e){let t=this._getLinePositions(e),i=new jn;i.setAttribute("position",new En(t,3)),i.computeBoundingSphere();let r=new Ih;this._updateLineBasicMaterial(r);const o=new Ap(i,r);return o.renderOrder=1,o}_createOutline(){return this._createLine(this._getPoints3d())}_disposeFill(){this._fill!=null&&(this._fill.geometry.dispose(),this._fill.material.dispose(),this._fill=null)}_disposeOutline(){this._outline!=null&&(this._outline.geometry.dispose(),this._outline.material.dispose(),this._outline=null)}_getLinePositions(e){let t=e.length,i=new Float32Array(t*3);for(let r=0;r<t;++r){let o=3*r,c=e[r];i[o+0]=c[0],i[o+1]=c[1],i[o+2]=c[2]}return i}_interact(e,t,i){return r=>{let o=r.offsetX-r.target.offsetWidth/2,c=r.offsetY-r.target.offsetHeight/2;this._interact$.next({cursor:t,offsetX:o,offsetY:c,operation:e,tag:this._tag,vertexIndex:i})}}_updateFillGeometry(){let e=this._getTriangles(),t=new Float32Array(e),i=this._fill.geometry,r=i.getAttribute("position");r.array.length===t.length?(r.set(t),r.needsUpdate=!0):(i.deleteAttribute("position"),i.setAttribute("position",new En(t,3))),i.computeBoundingSphere()}_updateLine(e,t){let i=this._getLinePositions(t),r=e.geometry,o=r.getAttribute("position");o.set(i),o.needsUpdate=!0,r.computeBoundingSphere()}_updateOulineGeometry(){this._updateLine(this._outline,this._getPoints3d())}}class ose extends uN{constructor(e,t){super(e,t),this._rectGeometry=new ba(this._tag.geometry.getRect2d(t)),this._fill=Di(t.cameraType)?null:this._createFill(),this._outline=this._tag.lineWidth>=1?this._createOutline():null}dispose(){super.dispose(),this._disposeFill(),this._disposeOutline()}getDOMObjects(e,t,i){const r=[],o={offsetHeight:i.height,offsetWidth:i.width};if(!this._tag.editable)return r;const c=this._colorToCss(this._tag.lineColor),s=this._tag.geometry.getPoints2d();for(let d=0;d<s.length;d++){const[p,g]=s[d],_=this._viewportCoords.basicToCanvasSafe(p,g,o,this._transform,t);if(_==null)continue;const x="crosshair",b=this._interact(sl.Vertex,x,d),S=Math.round(_[0]),P=Math.round(_[1]),L=`translate(-50%, -50%) translate(${S}px,${P}px)`,E={onpointerdown:b,style:{background:c,transform:L,cursor:x}};if(r.push(qt.h("div.mapillary-tag-resizer",E,[])),!this._tag.indicateVertices)continue;const C={style:{background:c,transform:L}};r.push(qt.h("div.mapillary-tag-vertex",C,[]))}return r}getGLObjects(){const e=[];return this._fill!=null&&e.push(this._fill),this._outline!=null&&e.push(this._outline),e}getRetrievableObjects(){return this._fill!=null?[this._fill]:[]}_onGeometryChanged(){this._rectGeometry=new ba(this._tag.geometry.getRect2d(this._transform)),this._fill!=null&&this._updateFillGeometry(),this._outline!=null&&this._updateOulineGeometry()}_onTagChanged(){let e=!1;return this._fill!=null&&this._updateFillMaterial(this._fill.material),this._outline==null?this._tag.lineWidth>=1&&(this._outline=this._createOutline(),e=!0):this._updateOutlineMaterial(),e}_getPoints3d(){return this._rectGeometry.getPoints3d(this._transform)}_getTriangles(){return this._rectGeometry.getTriangles3d(this._transform)}_updateFillMaterial(e){e.color=new $i(this._tag.fillColor),e.opacity=this._tag.fillOpacity,e.needsUpdate=!0}_updateLineBasicMaterial(e){e.color=new $i(this._tag.lineColor),e.linewidth=Math.max(this._tag.lineWidth,1),e.visible=this._tag.lineWidth>=1&&this._tag.lineOpacity>0,e.opacity=this._tag.lineOpacity,e.transparent=this._tag.lineOpacity<1,e.needsUpdate=!0}_updateOutlineMaterial(){let e=this._outline.material;this._updateLineBasicMaterial(e)}}class vE extends C1{constructor(e,t){super(),this._id=e,this._geometry=t,this._notifyChanged$=new ri,this._notifyChanged$.subscribe(i=>{const o={target:this,type:"tag"};this.fire("tag",o)}),this._geometry.changed$.subscribe(i=>{const r="geometry",o={target:this,type:r};this.fire(r,o)})}get id(){return this._id}get geometry(){return this._geometry}get changed$(){return this._notifyChanged$}get geometryChanged$(){return this._geometry.changed$.pipe(st(()=>this),pn())}fire(e,t){super.fire(e,t)}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}}class V3 extends vE{constructor(e,t,i){super(e,t),i=i||{},this._editable=i.editable==null?!1:i.editable,this._fillColor=i.fillColor==null?16777215:i.fillColor,this._fillOpacity=i.fillOpacity==null?0:i.fillOpacity,this._indicateVertices=i.indicateVertices==null?!0:i.indicateVertices,this._lineColor=i.lineColor==null?16777215:i.lineColor,this._lineOpacity=i.lineOpacity==null?1:i.lineOpacity,this._lineWidth=i.lineWidth==null?1:i.lineWidth}get editable(){return this._editable}set editable(e){this._editable=e,this._notifyChanged$.next(this)}get fillColor(){return this._fillColor}set fillColor(e){this._fillColor=e,this._notifyChanged$.next(this)}get fillOpacity(){return this._fillOpacity}set fillOpacity(e){this._fillOpacity=e,this._notifyChanged$.next(this)}get geometry(){return this._geometry}get indicateVertices(){return this._indicateVertices}set indicateVertices(e){this._indicateVertices=e,this._notifyChanged$.next(this)}get lineColor(){return this._lineColor}set lineColor(e){this._lineColor=e,this._notifyChanged$.next(this)}get lineOpacity(){return this._lineOpacity}set lineOpacity(e){this._lineOpacity=e,this._notifyChanged$.next(this)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._notifyChanged$.next(this)}setOptions(e){this._editable=e.editable==null?this._editable:e.editable,this._indicateVertices=e.indicateVertices==null?this._indicateVertices:e.indicateVertices,this._lineColor=e.lineColor==null?this._lineColor:e.lineColor,this._lineWidth=e.lineWidth==null?this._lineWidth:e.lineWidth,this._fillColor=e.fillColor==null?this._fillColor:e.fillColor,this._fillOpacity=e.fillOpacity==null?this._fillOpacity:e.fillOpacity,this._notifyChanged$.next(this)}}var e_;(function(n){n[n.TwoDimensional=0]="TwoDimensional",n[n.ThreeDimensional=1]="ThreeDimensional"})(e_||(e_={}));class ase extends uN{constructor(e,t){super(e,t),this._fill=Di(t.cameraType)?e.domain===e_.TwoDimensional&&e.geometry instanceof xh?this._createFill():null:this._createFill(),this._holes=this._tag.lineWidth>=1?this._createHoles():[],this._outline=this._tag.lineWidth>=1?this._createOutline():null}dispose(){super.dispose(),this._disposeFill(),this._disposeHoles(),this._disposeOutline()}getDOMObjects(e,t,i){const r=[],o=this._tag.geometry instanceof ba,c=!Di(this._transform.cameraType),s={offsetHeight:i.height,offsetWidth:i.width};if(this._tag.icon!=null&&(o||c)){const[g,_]=this._tag.geometry instanceof ba?this._tag.geometry.getVertex2d(this._tag.iconIndex):this._tag.geometry.getPoleOfInaccessibility2d(),x=this._viewportCoords.basicToCanvasSafe(g,_,s,this._transform,t);if(x!=null){const b=()=>{this._interact$.next({offsetX:0,offsetY:0,operation:sl.None,tag:this._tag})};if(e.loaded){const S=e.getDOMSprite(this._tag.icon,this._tag.iconFloat),P=Math.round(x[0]),L=Math.round(x[1]),E=`translate(${P}px,${L}px)`,D={onclick:O=>{O.stopPropagation(),this._tag.click$.next(this._tag)},onpointerdown:b,style:{transform:E}};r.push(qt.h("div.mapillary-tag-symbol",D,[S]))}}}else if(this._tag.text!=null&&(o||c)){const[g,_]=this._tag.geometry instanceof ba?this._tag.geometry.getVertex2d(3):this._tag.geometry.getPoleOfInaccessibility2d(),x=this._viewportCoords.basicToCanvasSafe(g,_,s,this._transform,t);if(x!=null){const b=Math.round(x[0]),S=Math.round(x[1]),P=this._tag.geometry instanceof ba?`translate(${b}px,${S}px)`:`translate(-50%, -50%) translate(${b}px,${S}px)`,E={onpointerdown:()=>{this._interact$.next({offsetX:0,offsetY:0,operation:sl.None,tag:this._tag})},style:{color:this._colorToCss(this._tag.textColor),transform:P},textContent:this._tag.text};r.push(qt.h("span.mapillary-tag-symbol",E,[]))}}if(!this._tag.editable)return r;const d=this._colorToCss(this._tag.lineColor);if(this._tag.geometry instanceof ba){const[g,_]=this._tag.geometry.getCentroid2d(),x=this._viewportCoords.basicToCanvasSafe(g,_,s,this._transform,t);if(x!=null){const b=this._interact(sl.Centroid,"move"),S=Math.round(x[0]),P=Math.round(x[1]),L=`translate(-50%, -50%) translate(${S}px,${P}px)`,E={onpointerdown:b,style:{background:d,transform:L}};r.push(qt.h("div.mapillary-tag-mover",E,[]))}}const p=this._tag.geometry.getVertices2d();for(let g=0;g<p.length-1;g++){if(o&&(this._tag.icon!=null&&g===this._tag.iconIndex||this._tag.icon==null&&this._tag.text!=null&&g===3))continue;const[_,x]=p[g],b=this._viewportCoords.basicToCanvasSafe(_,x,s,this._transform,t);if(b==null)continue;const S=o?g%2===0?"nesw-resize":"nwse-resize":"crosshair",P=this._interact(sl.Vertex,S,g),L=Math.round(b[0]),E=Math.round(b[1]),C=`translate(-50%, -50%) translate(${L}px,${E}px)`,D={onpointerdown:P,style:{background:d,transform:C,cursor:S}};if(r.push(qt.h("div.mapillary-tag-resizer",D,[])),!this._tag.indicateVertices)continue;const O={style:{background:d,transform:C}};r.push(qt.h("div.mapillary-tag-vertex",O,[]))}return r}getGLObjects(){const e=[];this._fill!=null&&e.push(this._fill);for(const t of this._holes)e.push(t);return this._outline!=null&&e.push(this._outline),e}getRetrievableObjects(){return this._fill!=null?[this._fill]:[]}_onGeometryChanged(){this._fill!=null&&this._updateFillGeometry(),this._holes.length>0&&this._updateHoleGeometries(),this._outline!=null&&this._updateOulineGeometry()}_onTagChanged(){let e=!1;return this._fill!=null&&this._updateFillMaterial(this._fill.material),this._outline==null?this._tag.lineWidth>=1&&(this._holes=this._createHoles(),this._outline=this._createOutline(),e=!0):(this._updateHoleMaterials(),this._updateOutlineMaterial()),e}_getPoints3d(){return this._in3dDomain()?this._tag.geometry.getVertices3d(this._transform):this._tag.geometry.getPoints3d(this._transform)}_getTriangles(){return this._in3dDomain()?this._tag.geometry.get3dDomainTriangles3d(this._transform):this._tag.geometry.getTriangles3d(this._transform)}_updateFillMaterial(e){e.color=new $i(this._tag.fillColor),e.opacity=this._tag.fillOpacity,e.needsUpdate=!0}_updateLineBasicMaterial(e){e.color=new $i(this._tag.lineColor),e.linewidth=Math.max(this._tag.lineWidth,1),e.visible=this._tag.lineWidth>=1&&this._tag.lineOpacity>0,e.opacity=this._tag.lineOpacity,e.transparent=this._tag.lineOpacity<1,e.needsUpdate=!0}_createHoles(){let e=[];if(this._tag.geometry instanceof xh){let t=this._getHoles3d();for(let i of t){let r=this._createLine(i);e.push(r)}}return e}_disposeHoles(){for(let e of this._holes)e.geometry.dispose(),e.material.dispose();this._holes=[]}_getHoles3d(){const e=this._tag.geometry;return this._in3dDomain()?e.getHoleVertices3d(this._transform):e.getHolePoints3d(this._transform)}_in3dDomain(){return this._tag.geometry instanceof xh&&this._tag.domain===e_.ThreeDimensional}_updateHoleGeometries(){let e=this._getHoles3d();if(e.length!==this._holes.length)throw new Error("Changing the number of holes is not supported.");for(let t=0;t<this._holes.length;t++){let i=e[t],r=this._holes[t];this._updateLine(r,i)}}_updateHoleMaterials(){for(const e of this._holes)this._updateLineBasicMaterial(e.material)}_updateOutlineMaterial(){this._updateLineBasicMaterial(this._outline.material)}}var as;(function(n){n[n.Bottom=0]="Bottom",n[n.BottomLeft=1]="BottomLeft",n[n.BottomRight=2]="BottomRight",n[n.Center=3]="Center",n[n.Left=4]="Left",n[n.Right=5]="Right",n[n.Top=6]="Top",n[n.TopLeft=7]="TopLeft",n[n.TopRight=8]="TopRight"})(as||(as={}));class U3 extends vE{constructor(e,t,i){super(e,t),i=i||{};const r=i.domain!=null&&t instanceof xh?i.domain:e_.TwoDimensional,o=this._twoDimensionalPolygon(r,t);this._domain=r,this._editable=i.editable==null||o?!1:i.editable,this._fillColor=i.fillColor==null?16777215:i.fillColor,this._fillOpacity=i.fillOpacity==null?0:i.fillOpacity,this._icon=i.icon===void 0?null:i.icon,this._iconFloat=i.iconFloat==null?as.Center:i.iconFloat,this._iconIndex=i.iconIndex==null?3:i.iconIndex,this._indicateVertices=i.indicateVertices==null?!0:i.indicateVertices,this._lineColor=i.lineColor==null?16777215:i.lineColor,this._lineOpacity=i.lineOpacity==null?1:i.lineOpacity,this._lineWidth=i.lineWidth==null?1:i.lineWidth,this._text=i.text===void 0?null:i.text,this._textColor=i.textColor==null?16777215:i.textColor,this._click$=new ri,this._click$.subscribe(()=>{const c="click",s={target:this,type:c};this.fire(c,s)})}get click$(){return this._click$}get domain(){return this._domain}get editable(){return this._editable}set editable(e){this._twoDimensionalPolygon(this._domain,this._geometry)||(this._editable=e,this._notifyChanged$.next(this))}get fillColor(){return this._fillColor}set fillColor(e){this._fillColor=e,this._notifyChanged$.next(this)}get fillOpacity(){return this._fillOpacity}set fillOpacity(e){this._fillOpacity=e,this._notifyChanged$.next(this)}get geometry(){return this._geometry}get icon(){return this._icon}set icon(e){this._icon=e,this._notifyChanged$.next(this)}get iconFloat(){return this._iconFloat}set iconFloat(e){this._iconFloat=e,this._notifyChanged$.next(this)}get iconIndex(){return this._iconIndex}set iconIndex(e){this._iconIndex=e,this._notifyChanged$.next(this)}get indicateVertices(){return this._indicateVertices}set indicateVertices(e){this._indicateVertices=e,this._notifyChanged$.next(this)}get lineColor(){return this._lineColor}set lineColor(e){this._lineColor=e,this._notifyChanged$.next(this)}get lineOpacity(){return this._lineOpacity}set lineOpacity(e){this._lineOpacity=e,this._notifyChanged$.next(this)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._notifyChanged$.next(this)}get text(){return this._text}set text(e){this._text=e,this._notifyChanged$.next(this)}get textColor(){return this._textColor}set textColor(e){this._textColor=e,this._notifyChanged$.next(this)}fire(e,t){super.fire(e,t)}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}setOptions(e){const t=this._twoDimensionalPolygon(this._domain,this._geometry);this._editable=t||e.editable==null?this._editable:e.editable,this._icon=e.icon===void 0?this._icon:e.icon,this._iconFloat=e.iconFloat==null?this._iconFloat:e.iconFloat,this._iconIndex=e.iconIndex==null?this._iconIndex:e.iconIndex,this._indicateVertices=e.indicateVertices==null?this._indicateVertices:e.indicateVertices,this._lineColor=e.lineColor==null?this._lineColor:e.lineColor,this._lineWidth=e.lineWidth==null?this._lineWidth:e.lineWidth,this._fillColor=e.fillColor==null?this._fillColor:e.fillColor,this._fillOpacity=e.fillOpacity==null?this._fillOpacity:e.fillOpacity,this._text=e.text===void 0?this._text:e.text,this._textColor=e.textColor==null?this._textColor:e.textColor,this._notifyChanged$.next(this)}_twoDimensionalPolygon(e,t){return e!==e_.ThreeDimensional&&t instanceof xh}}class lse extends cN{dispose(){}getDOMObjects(e,t,i){const r=this._tag,o={offsetHeight:i.height,offsetWidth:i.width},c=[],[s,d]=r.geometry.getCentroid2d(),p=this._viewportCoords.basicToCanvasSafe(s,d,o,this._transform,t);if(p!=null){const g=E=>{this._interact$.next({offsetX:0,offsetY:0,operation:sl.None,tag:r})},_=Math.round(p[0]),x=Math.round(p[1]);if(r.icon!=null){if(e.loaded){const E=e.getDOMSprite(r.icon,as.Bottom),C=`translate(${_}px,${x+8}px)`,D={onpointerdown:g,style:{pointerEvents:"all",transform:C}};c.push(qt.h("div",D,[E]))}}else if(r.text!=null){const E=`translate(-50%,0%) translate(${_}px,${x+8}px)`,C={onpointerdown:g,style:{color:this._colorToCss(r.textColor),transform:E},textContent:r.text};c.push(qt.h("span.mapillary-tag-symbol",C,[]))}const b=this._interact(sl.Centroid,r,"move"),S=this._colorToCss(r.color),P=`translate(-50%,-50%) translate(${_}px,${x}px)`;if(r.editable){let E={onpointerdown:b,style:{background:S,transform:P}};c.push(qt.h("div.mapillary-tag-spot-interactor",E,[]))}const L={style:{background:S,transform:P}};c.push(qt.h("div.mapillary-tag-vertex",L,[]))}return c}getGLObjects(){return[]}getRetrievableObjects(){return[]}_colorToCss(e){return"#"+("000000"+e.toString(16)).substr(-6)}_interact(e,t,i,r){return o=>{const c=o.offsetX-o.target.offsetWidth/2,s=o.offsetY-o.target.offsetHeight/2;this._interact$.next({cursor:i,offsetX:c,offsetY:s,operation:e,tag:t,vertexIndex:r})}}}class j3 extends vE{constructor(e,t,i){super(e,t),i=i||{},this._color=i.color==null?16777215:i.color,this._editable=i.editable==null?!1:i.editable,this._icon=i.icon===void 0?null:i.icon,this._text=i.text===void 0?null:i.text,this._textColor=i.textColor==null?16777215:i.textColor}get color(){return this._color}set color(e){this._color=e,this._notifyChanged$.next(this)}get editable(){return this._editable}set editable(e){this._editable=e,this._notifyChanged$.next(this)}get icon(){return this._icon}set icon(e){this._icon=e,this._notifyChanged$.next(this)}get text(){return this._text}set text(e){this._text=e,this._notifyChanged$.next(this)}get textColor(){return this._textColor}set textColor(e){this._textColor=e,this._notifyChanged$.next(this)}setOptions(e){this._color=e.color==null?this._color:e.color,this._editable=e.editable==null?this._editable:e.editable,this._icon=e.icon===void 0?this._icon:e.icon,this._text=e.text===void 0?this._text:e.text,this._textColor=e.textColor==null?this._textColor:e.textColor,this._notifyChanged$.next(this)}}class cse{constructor(){this._active=!1,this._hash={},this._hashDeactivated={},this._notifyChanged$=new ri}get active(){return this._active}get changed$(){return this._notifyChanged$}activate(e){if(!this._active){for(const t in this._hashDeactivated){if(!this._hashDeactivated.hasOwnProperty(t))continue;const i=this._hashDeactivated[t];this._add(i,e)}this._hashDeactivated={},this._active=!0,this._notifyChanged$.next(this)}}deactivate(){if(this._active){for(const e in this._hash)this._hash.hasOwnProperty(e)&&(this._hashDeactivated[e]=this._hash[e].tag);this._hash={},this._active=!1}}add(e,t){this._assertActivationState(!0);for(const i of e)this._add(i,t);this._notifyChanged$.next(this)}addDeactivated(e){this._assertActivationState(!1);for(const t of e){if(!(t instanceof U3||t instanceof j3||t instanceof V3))throw new Error("Tag type not supported");this._hashDeactivated[t.id]=t}}get(e){return this.has(e)?this._hash[e]:void 0}getAll(){const e=this._hash;return Object.keys(e).map(t=>e[t])}getAllDeactivated(){const e=this._hashDeactivated;return Object.keys(e).map(t=>e[t])}getDeactivated(e){return this.hasDeactivated(e)?this._hashDeactivated[e]:void 0}has(e){return e in this._hash}hasDeactivated(e){return e in this._hashDeactivated}remove(e){this._assertActivationState(!0);const t=this._hash;for(const i of e)i in t&&delete t[i];this._notifyChanged$.next(this)}removeAll(){this._assertActivationState(!0),this._hash={},this._notifyChanged$.next(this)}removeAllDeactivated(){this._assertActivationState(!1),this._hashDeactivated={}}removeDeactivated(e){this._assertActivationState(!1);const t=this._hashDeactivated;for(const i of e)i in t&&delete t[i]}_add(e,t){if(e instanceof U3)this._hash[e.id]=new ase(e,t);else if(e instanceof j3)this._hash[e.id]=new lse(e,t);else if(e instanceof V3)this._hash[e.id]=new ose(e,t);else throw new Error("Tag type not supported")}_assertActivationState(e){if(e!==this._active)throw new Error("Tag set not in correct state for operation.")}}class use extends fE{constructor(e){super();let t=e[0],i=e[1];if(t<0||t>1||i<0||i>1)throw new Os("Basic coordinates must be on the interval [0, 1].");this._point=e.slice()}get point(){return this._point}getCentroid2d(){return this._point.slice()}getCentroid3d(e){return e.unprojectBasic(this._point,200)}setCentroid2d(e,t){let i=[Math.max(0,Math.min(1,e[0])),Math.max(0,Math.min(1,e[1]))];this._point[0]=i[0],this._point[1]=i[1],this._notifyChanged$.next(this)}}class hN extends Tu{constructor(e,t,i,r){super(e,t,i),this._name=`${this._component.name}-${this._getNameExtension()}`,this._viewportCoords=r}_getConfiguration(e){return{}}_mouseEventToBasic(e,t,i,r,o,c){o=o??0,c=c??0;const[s,d]=this._viewportCoords.canvasPosition(e,t);return this._viewportCoords.canvasToBasic(s-o,d-c,t,r,i.perspective)}}class yE extends hN{constructor(e,t,i,r,o){super(e,t,i,r),this._tagCreator=o,this._geometryCreated$=new ri}get geometryCreated$(){return this._geometryCreated$}_enable(){this._enableCreate(),this._container.container.classList.add("component-tag-create")}_disable(){this._container.container.classList.remove("component-tag-create"),this._disableCreate()}_validateBasic(e){const t=e[0],i=e[1];return 0<=t&&t<=1&&0<=i&&i<=1}_mouseEventToBasic$(e){return e.pipe(Ui(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$),st(([t,i,r])=>this._mouseEventToBasic(t,this._container.container,i,r)))}}class hse extends yE{_enableCreate(){this._container.mouseService.deferPixels(this._name,4),this._geometryCreatedSubscription=this._mouseEventToBasic$(this._container.mouseService.proximateClick$).pipe(ai(this._validateBasic),st(e=>new use(e))).subscribe(this._geometryCreated$)}_disableCreate(){this._container.mouseService.undeferPixels(this._name),this._geometryCreatedSubscription.unsubscribe()}_getNameExtension(){return"create-point"}}class bE extends yE{_enableCreate(){this._container.mouseService.deferPixels(this._name,4);const e=this._navigator.stateService.currentTransform$.pipe(st(()=>{}),Ii(1),_i());this._deleteSubscription=e.pipe(Ks(1)).subscribe(this._tagCreator.delete$);const t=this._mouseEventToBasic$(this._container.mouseService.proximateClick$).pipe(pn());this._createSubscription=e.pipe(ei(()=>t.pipe(ai(this._validateBasic),Vl(1)))).subscribe(this._create$),this._setVertexSubscription=this._tagCreator.tag$.pipe(ei(i=>i?Si(Pi(i),mn(this._container.mouseService.mouseMove$,this._container.mouseService.domMouseMove$),this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$):Ni())).subscribe(([i,r,o,c])=>{const s=this._mouseEventToBasic(r,this._container.container,o,c);this._setVertex2d(i,s,c)}),this._addPointSubscription=this._tagCreator.tag$.pipe(ei(i=>i?Si(Pi(i),t):Ni())).subscribe(([i,r])=>{this._addPoint(i,r)}),this._geometryCreateSubscription=this._tagCreator.tag$.pipe(ei(i=>i?i.created$.pipe(st(r=>r.geometry)):Ni())).subscribe(this._geometryCreated$)}_disableCreate(){this._container.mouseService.undeferPixels(this._name),this._tagCreator.delete$.next(null),this._addPointSubscription.unsubscribe(),this._createSubscription.unsubscribe(),this._deleteSubscription.unsubscribe(),this._geometryCreateSubscription.unsubscribe(),this._setVertexSubscription.unsubscribe()}}class dse extends bE{get _create$(){return this._tagCreator.createPoints$}_addPoint(e,t){e.geometry.addPoint2d(t)}_getNameExtension(){return"create-points"}_setVertex2d(e,t,i){e.geometry.setPoint2d(e.geometry.points.length-1,t,i)}}class fse extends bE{get _create$(){return this._tagCreator.createPolygon$}_addPoint(e,t){e.addPoint(t)}_getNameExtension(){return"create-polygon"}_setVertex2d(e,t,i){e.geometry.setVertex2d(e.geometry.polygon.length-2,t,i)}}class pse extends bE{get _create$(){return this._tagCreator.createRect$}_addPoint(e,t){const i=e.geometry;i.validate(t)||(t=i.getNonAdjustedVertex2d(3)),e.addPoint(t)}_enable(){super._enable(),this._initializeAnchorIndexingSubscription=this._tagCreator.tag$.pipe(ai(e=>!!e)).subscribe(e=>{e.geometry.initializeAnchorIndexing()})}_disable(){super._disable(),this._initializeAnchorIndexingSubscription.unsubscribe()}_getNameExtension(){return"create-rect"}_setVertex2d(e,t,i){e.geometry.setOppositeVertex2d(t,i)}}class mse extends yE{_enableCreate(){this._container.mouseService.claimMouse(this._name,2),this._deleteSubscription=this._navigator.stateService.currentTransform$.pipe(st(i=>null),Ks(1)).subscribe(this._tagCreator.delete$),this._createSubscription=this._mouseEventToBasic$(this._container.mouseService.filtered$(this._name,this._container.mouseService.mouseDragStart$)).pipe(ai(this._validateBasic)).subscribe(this._tagCreator.createRect$),this._initializeAnchorIndexingSubscription=this._tagCreator.tag$.pipe(ai(i=>!!i)).subscribe(i=>{i.geometry.initializeAnchorIndexing()});const e=Si(mn(this._container.mouseService.filtered$(this._name,this._container.mouseService.mouseMove$),this._container.mouseService.filtered$(this._name,this._container.mouseService.domMouseMove$)),this._container.renderService.renderCamera$).pipe(Ui(this._navigator.stateService.currentTransform$),st(([[i,r],o])=>this._mouseEventToBasic(i,this._container.container,r,o)));this._setVertexSubscription=this._tagCreator.tag$.pipe(ei(i=>i?Si(Pi(i),e,this._navigator.stateService.currentTransform$):Ni())).subscribe(([i,r,o])=>{i.geometry.setOppositeVertex2d(r,o)});const t=this._container.mouseService.mouseDragEnd$.pipe(Ui(this._mouseEventToBasic$(this._container.mouseService.filtered$(this._name,this._container.mouseService.mouseDrag$)).pipe(ai(this._validateBasic)),(i,r)=>r),pn());this._addPointSubscription=this._tagCreator.tag$.pipe(ei(i=>i?Si(Pi(i),t):Ni())).subscribe(([i,r])=>{const o=i.geometry;o.validate(r)||(r=o.getNonAdjustedVertex2d(3)),i.addPoint(r)}),this._geometryCreatedSubscription=this._tagCreator.tag$.pipe(ei(i=>i?i.created$.pipe(st(r=>r.geometry)):Ni())).subscribe(this._geometryCreated$)}_disableCreate(){this._container.mouseService.unclaimMouse(this._name),this._tagCreator.delete$.next(null),this._addPointSubscription.unsubscribe(),this._createSubscription.unsubscribe(),this._deleteSubscription.unsubscribe(),this._geometryCreatedSubscription.unsubscribe(),this._initializeAnchorIndexingSubscription.unsubscribe(),this._setVertexSubscription.unsubscribe()}_getNameExtension(){return"create-rect-drag"}}class gse extends hN{constructor(e,t,i,r,o){super(e,t,i,r),this._tagSet=o}_enable(){const e=this._tagSet.changed$.pipe(st(t=>t.getAll()),ei(t=>Fr(t).pipe(Hi(i=>i.interact$))),ei(t=>jl(Pi(t),this._container.mouseService.documentMouseUp$.pipe(st(()=>({offsetX:0,offsetY:0,operation:sl.None,tag:null})),wi()))),pn());mn(this._container.mouseService.mouseMove$,this._container.mouseService.domMouseMove$).pipe(pn()),this._claimMouseSubscription=e.pipe(ei(t=>t.tag?this._container.mouseService.domMouseDragStart$:Ni())).subscribe(()=>{this._container.mouseService.claimMouse(this._name,3)}),this._cursorSubscription=e.pipe(st(t=>t.cursor),yi()).subscribe(t=>{const i=["crosshair","move","nesw-resize","nwse-resize"];for(const r of i)this._container.container.classList.remove(`component-tag-edit-${r}`);t&&this._container.container.classList.add(`component-tag-edit-${t}`)}),this._unclaimMouseSubscription=this._container.mouseService.filtered$(this._name,this._container.mouseService.domMouseDragEnd$).subscribe(t=>{this._container.mouseService.unclaimMouse(this._name)}),this._preventDefaultSubscription=e.pipe(ei(t=>t.tag?this._container.mouseService.documentMouseMove$:Ni())).subscribe(t=>{t.preventDefault()}),this._updateGeometrySubscription=e.pipe(ei(t=>{if(t.operation===sl.None||!t.tag)return Ni();const i=this._container.mouseService.filtered$(this._name,this._container.mouseService.domMouseDrag$).pipe(ai(r=>this._viewportCoords.insideElement(r,this._container.container)));return Si(i,this._container.renderService.renderCamera$).pipe(Ui(Pi(t),this._navigator.stateService.currentTransform$,([r,o],c,s)=>[r,o,c,s]))})).subscribe(([t,i,r,o])=>{const c=this._mouseEventToBasic(t,this._container.container,i,o,r.offsetX,r.offsetY),s=r.tag.geometry;r.operation===sl.Centroid?s.setCentroid2d(c,o):r.operation===sl.Vertex&&s.setVertex2d(r.vertexIndex,c,o)})}_disable(){this._claimMouseSubscription.unsubscribe(),this._cursorSubscription.unsubscribe(),this._preventDefaultSubscription.unsubscribe(),this._unclaimMouseSubscription.unsubscribe(),this._updateGeometrySubscription.unsubscribe()}_getNameExtension(){return"edit-vertex"}}class dN extends So{constructor(e,t,i){super(e,t,i),this._tagDomRenderer=new rse,this._tagScene=new sse,this._tagSet=new cse,this._tagCreator=new nse(this,i),this._viewportCoords=new $o,this._createHandlers={CreatePoint:new hse(this,t,i,this._viewportCoords,this._tagCreator),CreatePoints:new dse(this,t,i,this._viewportCoords,this._tagCreator),CreatePolygon:new fse(this,t,i,this._viewportCoords,this._tagCreator),CreateRect:new pse(this,t,i,this._viewportCoords,this._tagCreator),CreateRectDrag:new mse(this,t,i,this._viewportCoords,this._tagCreator),Default:void 0},this._editVertexHandler=new gse(this,t,i,this._viewportCoords,this._tagSet),this._renderTags$=this._tagSet.changed$.pipe(st(r=>{const o=r.getAll();return o.sort((c,s)=>{const d=c.tag.id,p=s.tag.id;return d<p?-1:d>p?1:0}),o}),pn()),this._tagChanged$=this._renderTags$.pipe(ei(r=>Fr(r).pipe(Hi(o=>mn(o.tag.changed$,o.tag.geometryChanged$)))),pn()),this._renderTagGLChanged$=this._renderTags$.pipe(ei(r=>Fr(r).pipe(Hi(o=>o.glObjectsChanged$))),pn()),this._createGeometryChanged$=this._tagCreator.tag$.pipe(ei(r=>r!=null?r.geometryChanged$:Ni()),pn()),this._createGLObjectsChanged$=this._tagCreator.tag$.pipe(ei(r=>r!=null?r.glObjectsChanged$:Ni()),pn()),this._creatingConfiguration$=this._configuration$.pipe(yi((r,o)=>r.mode===o.mode,r=>({createColor:r.createColor,mode:r.mode})),Ii(1),_i()),this._creatingConfiguration$.subscribe(r=>{const o="tagmode",c={mode:r.mode,target:this,type:o};this.fire(o,c)})}add(e){this._activated?this._navigator.stateService.currentTransform$.pipe(wi()).subscribe(t=>{this._tagSet.add(e,t);const i=e.map(r=>this._tagSet.get(r.id));this._tagScene.add(i)}):this._tagSet.addDeactivated(e)}calculateRect(e){return new Promise((t,i)=>{this._navigator.stateService.currentTransform$.pipe(wi(),st(r=>e.getRect2d(r))).subscribe(r=>{t(r)},r=>{i(r)})})}create(){this._tagCreator.replayedTag$.pipe(wi(),ai(e=>!!e)).subscribe(e=>{e.create()})}changeMode(e){this.configure({mode:e})}fire(e,t){super.fire(e,t)}get(e){if(this._activated){const t=this._tagSet.get(e);return t!==void 0?t.tag:void 0}else return this._tagSet.getDeactivated(e)}getAll(){return this.activated?this._tagSet.getAll().map(e=>e.tag):this._tagSet.getAllDeactivated()}getTagIdsAt(e){return new Promise((t,i)=>{this._container.renderService.renderCamera$.pipe(wi(),st(r=>{const o=this._viewportCoords.canvasToViewport(e[0],e[1],this._container.container);return this._tagScene.intersectObjects(o,r.perspective)})).subscribe(r=>{t(r)},r=>{i(r)})})}has(e){return this._activated?this._tagSet.has(e):this._tagSet.hasDeactivated(e)}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}remove(e){this._activated?(this._tagSet.remove(e),this._tagScene.remove(e)):this._tagSet.removeDeactivated(e)}removeAll(){this._activated?(this._tagSet.removeAll(),this._tagScene.removeAll()):this._tagSet.removeAllDeactivated()}_activate(){this._editVertexHandler.enable();const e=Fr(Object.keys(this._createHandlers)).pipe(st(i=>this._createHandlers[i]),ai(i=>!!i),Hi(i=>i.geometryCreated$),pn()),t=this._subscriptions;t.push(e.subscribe(i=>{const r="geometrycreate",o={geometry:i,target:this,type:r};this.fire(r,o)})),t.push(this._tagCreator.tag$.pipe(s2(i=>i==null),yi()).subscribe(i=>{const r=i!=null?"tagcreatestart":"tagcreateend",o={target:this,type:r};this.fire(r,o)})),t.push(e.subscribe(()=>{this.changeMode(wg.Default)})),t.push(this._creatingConfiguration$.subscribe(i=>{this._disableCreateHandlers();const r=wg[i.mode],o=this._createHandlers[r];o&&o.enable()})),t.push(this._renderTags$.subscribe(()=>{const i="tags",r={target:this,type:i};this.fire(i,r)})),t.push(this._tagCreator.tag$.pipe(ei(i=>i!=null?i.aborted$.pipe(st(()=>null)):Ni())).subscribe(()=>{this.changeMode(wg.Default)})),t.push(this._tagCreator.tag$.subscribe(i=>{this._tagScene.hasCreateTag()&&this._tagScene.removeCreateTag(),i!=null&&this._tagScene.addCreateTag(i)})),t.push(this._createGLObjectsChanged$.subscribe(i=>{this._tagScene.updateCreateTagObjects(i)})),t.push(this._renderTagGLChanged$.subscribe(i=>{this._tagScene.updateObjects(i)})),t.push(this._tagChanged$.subscribe(()=>{this._tagScene.update()})),t.push(Si(this._renderTags$.pipe(An([]),Dr(()=>{this._container.domRenderer.render$.next({name:this._name,vNode:this._tagDomRenderer.clear()})})),this._container.renderService.renderCamera$,this._container.spriteService.spriteAtlas$,this._container.renderService.size$,this._tagChanged$.pipe(An(null)),mn(this._tagCreator.tag$,this._createGeometryChanged$).pipe(An(null))).pipe(st(([i,r,o,c,,s])=>({name:this._name,vNode:this._tagDomRenderer.render(i,s,o,r.perspective,c)}))).subscribe(this._container.domRenderer.render$)),t.push(this._navigator.stateService.currentState$.pipe(st(i=>{const r=this._tagScene;return{name:this._name,renderer:{frameId:i.id,needsRender:r.needsRender,render:r.render.bind(r),pass:Rh.Opaque}}})).subscribe(this._container.glRenderer.render$)),this._navigator.stateService.currentTransform$.pipe(wi()).subscribe(i=>{this._tagSet.activate(i),this._tagScene.add(this._tagSet.getAll())})}_deactivate(){this._editVertexHandler.disable(),this._disableCreateHandlers(),this._tagScene.clear(),this._tagSet.deactivate(),this._tagCreator.delete$.next(null),this._subscriptions.unsubscribe(),this._container.container.classList.remove("component-tag-create")}_getDefaultConfiguration(){return{createColor:16777215,indicatePointsCompleter:!0,mode:wg.Default}}_disableCreateHandlers(){const e=this._createHandlers;for(const t in e){if(!e.hasOwnProperty(t))continue;const i=e[t];i&&i.disable()}}}dN.componentName="tag";class fN extends So{constructor(e,t,i){super(e,t,i),this._viewportCoords=new $o,this._zoomDelta$=new ri}_activate(){const e=this._subscriptions;e.push(Si(this._navigator.stateService.currentState$,this._navigator.stateService.state$,this._configuration$,this._container.renderService.size$).pipe(st(([t,i,r,o])=>{const c=t.state.zoom,s=qt.h("div.mapillary-zoom-in-icon",[]),d=c>=3||i===Bi.Waiting?qt.h("div.mapillary-zoom-in-button-inactive",[s]):qt.h("div.mapillary-zoom-in-button",{onclick:()=>{this._zoomDelta$.next(1)}},[s]),p=qt.h("div.mapillary-zoom-out-icon",[]),g=c<=0||i===Bi.Waiting?qt.h("div.mapillary-zoom-out-button-inactive",[p]):qt.h("div.mapillary-zoom-out-button",{onclick:()=>{this._zoomDelta$.next(-1)}},[p]),_=r.size===Fd.Small||r.size===Fd.Automatic&&o.width<640?".mapillary-zoom-compact":"";return{name:this._name,vNode:qt.h("div.mapillary-zoom-container"+_,{oncontextmenu:x=>{x.preventDefault()}},[d,g])}})).subscribe(this._container.domRenderer.render$)),e.push(this._zoomDelta$.pipe(Ui(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$)).subscribe(([t,i,r])=>{const o=this._viewportCoords.unprojectFromViewport(0,0,i.perspective),c=r.projectBasic(o.toArray());this._navigator.stateService.zoomIn(t,c)}))}_deactivate(){this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{size:Fd.Automatic}}}fN.componentName="zoom";class pN extends So{constructor(e,t,i,r){super(e,t,i),this._canvasId=`${t.id}-${this._name}`,this._dom=r||new hE}_activate(){const e=this._container.domRenderer.element$.pipe(st(()=>this._dom.document.getElementById(this._canvasId)),ai(t=>!!t),st(t=>{const i=t.parentElement,r=i.offsetWidth,o=i.offsetHeight;return[t,{height:o,width:r}]}),yi((t,i)=>t.height===i.height&&t.width===i.width,([,t])=>t));this._subscriptions.push(Si(e,this._navigator.stateService.currentImage$).subscribe(([[t,i],r])=>{t.width=i.width,t.height=i.height,t.getContext("2d").drawImage(r.image,0,0,i.width,i.height)})),this._container.domRenderer.renderAdaptive$.next({name:this._name,vNode:qt.h(`canvas#${this._canvasId}`,[])})}_deactivate(){this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{}}}pN.componentName="imagefallback";class mN extends So{constructor(e,t,i){super(e,t,i),this._seqNames={},this._seqNames[Vt[Vt.Prev]]="-prev",this._seqNames[Vt[Vt.Next]]="-next",this._spaTopNames={},this._spaTopNames[Vt[Vt.TurnLeft]]="-turn-left",this._spaTopNames[Vt[Vt.StepLeft]]="-left",this._spaTopNames[Vt[Vt.StepForward]]="-forward",this._spaTopNames[Vt[Vt.StepRight]]="-right",this._spaTopNames[Vt[Vt.TurnRight]]="-turn-right",this._spaBottomNames={},this._spaBottomNames[Vt[Vt.TurnU]]="-turn-around",this._spaBottomNames[Vt[Vt.StepBackward]]="-backward"}_activate(){this._subscriptions.push(Si(this._navigator.stateService.currentImage$,this._configuration$).pipe(ei(([e,t])=>{const i=t.sequence?e.sequenceEdges$.pipe(st(o=>o.edges.map(c=>c.data.direction))):Pi([]),r=!Di(e.cameraType)&&t.spatial?e.spatialEdges$.pipe(st(o=>o.edges.map(c=>c.data.direction))):Pi([]);return Si(i,r).pipe(st(([o,c])=>o.concat(c)))}),st(e=>{const t=this._createArrowRow(this._seqNames,e),i=this._createArrowRow(this._spaTopNames,e),r=this._createArrowRow(this._spaBottomNames,e),o=qt.h("div.mapillary-navigation-sequence",t),c=qt.h("div.NavigationSpatialTop",i),s=qt.h("div.mapillary-navigation-spatial-bottom",r),d=qt.h("div.mapillary-navigation-spatial",[c,s]);return{name:this._name,vNode:qt.h("div.NavigationContainer",[o,d])}})).subscribe(this._container.domRenderer.render$))}_deactivate(){this._subscriptions.unsubscribe()}_getDefaultConfiguration(){return{sequence:!0,spatial:!0}}_createArrowRow(e,t){const i=[];for(const r in e){if(!e.hasOwnProperty(r))continue;const o=Vt[r];t.indexOf(o)!==-1?i.push(this._createVNode(o,e[r],"visible")):i.push(this._createVNode(o,e[r],"hidden"))}return i}_createVNode(e,t,i){return qt.h(`span.mapillary-navigation-button.mapillary-navigation${t}`,{onclick:()=>{this._navigator.moveDir$(e).subscribe(void 0,r=>{r instanceof Ul||console.error(r)})},style:{visibility:i}},[])}}mN.componentName="navigationfallback";function v_(n){let e=n.length;for(;--e>=0;)n[e]=0}const _se=3,vse=258,gN=29,yse=256,bse=yse+1+gN,_N=30,xse=512,wse=new Array((bse+2)*2);v_(wse);const Sse=new Array(_N*2);v_(Sse);const Tse=new Array(xse);v_(Tse);const Mse=new Array(vse-_se+1);v_(Mse);const Cse=new Array(gN);v_(Cse);const Ese=new Array(_N);v_(Ese);const Ase=(n,e,t,i)=>{let r=n&65535|0,o=n>>>16&65535|0,c=0;for(;t!==0;){c=t>2e3?2e3:t,t-=c;do r=r+e[i++]|0,o=o+r|0;while(--c);r%=65521,o%=65521}return r|o<<16|0};var R2=Ase;const Pse=()=>{let n,e=[];for(var t=0;t<256;t++){n=t;for(var i=0;i<8;i++)n=n&1?3988292384^n>>>1:n>>>1;e[t]=n}return e},Ise=new Uint32Array(Pse()),Rse=(n,e,t,i)=>{const r=Ise,o=i+t;n^=-1;for(let c=i;c<o;c++)n=n>>>8^r[(n^e[c])&255];return n^-1};var eu=Rse,L2={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},vN={Z_NO_FLUSH:0,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFLATED:8};const Lse=(n,e)=>Object.prototype.hasOwnProperty.call(n,e);var kse=function(n){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const t=e.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const i in t)Lse(t,i)&&(n[i]=t[i])}}return n},Dse=n=>{let e=0;for(let i=0,r=n.length;i<r;i++)e+=n[i].length;const t=new Uint8Array(e);for(let i=0,r=0,o=n.length;i<o;i++){let c=n[i];t.set(c,r),r+=c.length}return t},yN={assign:kse,flattenChunks:Dse};let bN=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{bN=!1}const e0=new Uint8Array(256);for(let n=0;n<256;n++)e0[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;e0[254]=e0[254]=1;var Fse=n=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(n);let e,t,i,r,o,c=n.length,s=0;for(r=0;r<c;r++)t=n.charCodeAt(r),(t&64512)===55296&&r+1<c&&(i=n.charCodeAt(r+1),(i&64512)===56320&&(t=65536+(t-55296<<10)+(i-56320),r++)),s+=t<128?1:t<2048?2:t<65536?3:4;for(e=new Uint8Array(s),o=0,r=0;o<s;r++)t=n.charCodeAt(r),(t&64512)===55296&&r+1<c&&(i=n.charCodeAt(r+1),(i&64512)===56320&&(t=65536+(t-55296<<10)+(i-56320),r++)),t<128?e[o++]=t:t<2048?(e[o++]=192|t>>>6,e[o++]=128|t&63):t<65536?(e[o++]=224|t>>>12,e[o++]=128|t>>>6&63,e[o++]=128|t&63):(e[o++]=240|t>>>18,e[o++]=128|t>>>12&63,e[o++]=128|t>>>6&63,e[o++]=128|t&63);return e};const Ose=(n,e)=>{if(e<65534&&n.subarray&&bN)return String.fromCharCode.apply(null,n.length===e?n:n.subarray(0,e));let t="";for(let i=0;i<e;i++)t+=String.fromCharCode(n[i]);return t};var zse=(n,e)=>{const t=e||n.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(n.subarray(0,e));let i,r;const o=new Array(t*2);for(r=0,i=0;i<t;){let c=n[i++];if(c<128){o[r++]=c;continue}let s=e0[c];if(s>4){o[r++]=65533,i+=s-1;continue}for(c&=s===2?31:s===3?15:7;s>1&&i<t;)c=c<<6|n[i++]&63,s--;if(s>1){o[r++]=65533;continue}c<65536?o[r++]=c:(c-=65536,o[r++]=55296|c>>10&1023,o[r++]=56320|c&1023)}return Ose(o,r)},Bse=(n,e)=>{e=e||n.length,e>n.length&&(e=n.length);let t=e-1;for(;t>=0&&(n[t]&192)===128;)t--;return t<0||t===0?e:t+e0[n[t]]>e?t:e},k2={string2buf:Fse,buf2string:zse,utf8border:Bse};function Nse(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var $se=Nse;const Ix=30,Vse=12;var Use=function(e,t){let i,r,o,c,s,d,p,g,_,x,b,S,P,L,E,C,D,O,U,j,G,N,V,q;const z=e.state;i=e.next_in,V=e.input,r=i+(e.avail_in-5),o=e.next_out,q=e.output,c=o-(t-e.avail_out),s=o+(e.avail_out-257),d=z.dmax,p=z.wsize,g=z.whave,_=z.wnext,x=z.window,b=z.hold,S=z.bits,P=z.lencode,L=z.distcode,E=(1<<z.lenbits)-1,C=(1<<z.distbits)-1;e:do{S<15&&(b+=V[i++]<<S,S+=8,b+=V[i++]<<S,S+=8),D=P[b&E];t:for(;;){if(O=D>>>24,b>>>=O,S-=O,O=D>>>16&255,O===0)q[o++]=D&65535;else if(O&16){U=D&65535,O&=15,O&&(S<O&&(b+=V[i++]<<S,S+=8),U+=b&(1<<O)-1,b>>>=O,S-=O),S<15&&(b+=V[i++]<<S,S+=8,b+=V[i++]<<S,S+=8),D=L[b&C];i:for(;;){if(O=D>>>24,b>>>=O,S-=O,O=D>>>16&255,O&16){if(j=D&65535,O&=15,S<O&&(b+=V[i++]<<S,S+=8,S<O&&(b+=V[i++]<<S,S+=8)),j+=b&(1<<O)-1,j>d){e.msg="invalid distance too far back",z.mode=Ix;break e}if(b>>>=O,S-=O,O=o-c,j>O){if(O=j-O,O>g&&z.sane){e.msg="invalid distance too far back",z.mode=Ix;break e}if(G=0,N=x,_===0){if(G+=p-O,O<U){U-=O;do q[o++]=x[G++];while(--O);G=o-j,N=q}}else if(_<O){if(G+=p+_-O,O-=_,O<U){U-=O;do q[o++]=x[G++];while(--O);if(G=0,_<U){O=_,U-=O;do q[o++]=x[G++];while(--O);G=o-j,N=q}}}else if(G+=_-O,O<U){U-=O;do q[o++]=x[G++];while(--O);G=o-j,N=q}for(;U>2;)q[o++]=N[G++],q[o++]=N[G++],q[o++]=N[G++],U-=3;U&&(q[o++]=N[G++],U>1&&(q[o++]=N[G++]))}else{G=o-j;do q[o++]=q[G++],q[o++]=q[G++],q[o++]=q[G++],U-=3;while(U>2);U&&(q[o++]=q[G++],U>1&&(q[o++]=q[G++]))}}else if((O&64)===0){D=L[(D&65535)+(b&(1<<O)-1)];continue i}else{e.msg="invalid distance code",z.mode=Ix;break e}break}}else if((O&64)===0){D=P[(D&65535)+(b&(1<<O)-1)];continue t}else if(O&32){z.mode=Vse;break e}else{e.msg="invalid literal/length code",z.mode=Ix;break e}break}}while(i<r&&o<s);U=S>>3,i-=U,S-=U<<3,b&=(1<<S)-1,e.next_in=i,e.next_out=o,e.avail_in=i<r?5+(r-i):5-(i-r),e.avail_out=o<s?257+(s-o):257-(o-s),z.hold=b,z.bits=S};const lg=15,G3=852,q3=592,W3=0,_M=1,H3=2,jse=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Gse=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),qse=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Wse=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),Hse=(n,e,t,i,r,o,c,s)=>{const d=s.bits;let p=0,g=0,_=0,x=0,b=0,S=0,P=0,L=0,E=0,C=0,D,O,U,j,G,N=null,V=0,q;const z=new Uint16Array(lg+1),Q=new Uint16Array(lg+1);let X=null,re=0,oe,de,ce;for(p=0;p<=lg;p++)z[p]=0;for(g=0;g<i;g++)z[e[t+g]]++;for(b=d,x=lg;x>=1&&z[x]===0;x--);if(b>x&&(b=x),x===0)return r[o++]=1<<24|64<<16|0,r[o++]=1<<24|64<<16|0,s.bits=1,0;for(_=1;_<x&&z[_]===0;_++);for(b<_&&(b=_),L=1,p=1;p<=lg;p++)if(L<<=1,L-=z[p],L<0)return-1;if(L>0&&(n===W3||x!==1))return-1;for(Q[1]=0,p=1;p<lg;p++)Q[p+1]=Q[p]+z[p];for(g=0;g<i;g++)e[t+g]!==0&&(c[Q[e[t+g]]++]=g);if(n===W3?(N=X=c,q=19):n===_M?(N=jse,V-=257,X=Gse,re-=257,q=256):(N=qse,X=Wse,q=-1),C=0,g=0,p=_,G=o,S=b,P=0,U=-1,E=1<<b,j=E-1,n===_M&&E>G3||n===H3&&E>q3)return 1;for(;;){oe=p-P,c[g]<q?(de=0,ce=c[g]):c[g]>q?(de=X[re+c[g]],ce=N[V+c[g]]):(de=96,ce=0),D=1<<p-P,O=1<<S,_=O;do O-=D,r[G+(C>>P)+O]=oe<<24|de<<16|ce|0;while(O!==0);for(D=1<<p-1;C&D;)D>>=1;if(D!==0?(C&=D-1,C+=D):C=0,g++,--z[p]===0){if(p===x)break;p=e[t+c[g]]}if(p>b&&(C&j)!==U){for(P===0&&(P=b),G+=_,S=p-P,L=1<<S;S+P<x&&(L-=z[S+P],!(L<=0));)S++,L<<=1;if(E+=1<<S,n===_M&&E>G3||n===H3&&E>q3)return 1;U=C&j,r[U]=b<<24|S<<16|G-o|0}}return C!==0&&(r[G+C]=p-P<<24|64<<16|0),s.bits=b,0};var xy=Hse;const Zse=0,xN=1,wN=2,{Z_FINISH:Z3,Z_BLOCK:Xse,Z_TREES:Rx,Z_OK:bp,Z_STREAM_END:Yse,Z_NEED_DICT:Kse,Z_STREAM_ERROR:ql,Z_DATA_ERROR:SN,Z_MEM_ERROR:TN,Z_BUF_ERROR:Jse,Z_DEFLATED:X3}=vN,MN=1,Y3=2,K3=3,J3=4,Q3=5,ek=6,tk=7,ik=8,nk=9,rk=10,jw=11,lh=12,vM=13,sk=14,yM=15,ok=16,ak=17,lk=18,ck=19,Lx=20,kx=21,uk=22,hk=23,dk=24,fk=25,pk=26,bM=27,mk=28,gk=29,Kr=30,CN=31,Qse=32,eoe=852,toe=592,ioe=15,noe=ioe,_k=n=>(n>>>24&255)+(n>>>8&65280)+((n&65280)<<8)+((n&255)<<24);function roe(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const EN=n=>{if(!n||!n.state)return ql;const e=n.state;return n.total_in=n.total_out=e.total=0,n.msg="",e.wrap&&(n.adler=e.wrap&1),e.mode=MN,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(eoe),e.distcode=e.distdyn=new Int32Array(toe),e.sane=1,e.back=-1,bp},AN=n=>{if(!n||!n.state)return ql;const e=n.state;return e.wsize=0,e.whave=0,e.wnext=0,EN(n)},PN=(n,e)=>{let t;if(!n||!n.state)return ql;const i=n.state;return e<0?(t=0,e=-e):(t=(e>>4)+1,e<48&&(e&=15)),e&&(e<8||e>15)?ql:(i.window!==null&&i.wbits!==e&&(i.window=null),i.wrap=t,i.wbits=e,AN(n))},IN=(n,e)=>{if(!n)return ql;const t=new roe;n.state=t,t.window=null;const i=PN(n,e);return i!==bp&&(n.state=null),i},soe=n=>IN(n,noe);let vk=!0,xM,wM;const ooe=n=>{if(vk){xM=new Int32Array(512),wM=new Int32Array(32);let e=0;for(;e<144;)n.lens[e++]=8;for(;e<256;)n.lens[e++]=9;for(;e<280;)n.lens[e++]=7;for(;e<288;)n.lens[e++]=8;for(xy(xN,n.lens,0,288,xM,0,n.work,{bits:9}),e=0;e<32;)n.lens[e++]=5;xy(wN,n.lens,0,32,wM,0,n.work,{bits:5}),vk=!1}n.lencode=xM,n.lenbits=9,n.distcode=wM,n.distbits=5},RN=(n,e,t,i)=>{let r;const o=n.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(e.subarray(t-o.wsize,t),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(e.subarray(t-i,t-i+r),o.wnext),i-=r,i?(o.window.set(e.subarray(t-i,t),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0},aoe=(n,e)=>{let t,i,r,o,c,s,d,p,g,_,x,b,S,P,L=0,E,C,D,O,U,j,G,N;const V=new Uint8Array(4);let q,z;const Q=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!n||!n.state||!n.output||!n.input&&n.avail_in!==0)return ql;t=n.state,t.mode===lh&&(t.mode=vM),c=n.next_out,r=n.output,d=n.avail_out,o=n.next_in,i=n.input,s=n.avail_in,p=t.hold,g=t.bits,_=s,x=d,N=bp;e:for(;;)switch(t.mode){case MN:if(t.wrap===0){t.mode=vM;break}for(;g<16;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if(t.wrap&2&&p===35615){t.check=0,V[0]=p&255,V[1]=p>>>8&255,t.check=eu(t.check,V,2,0),p=0,g=0,t.mode=Y3;break}if(t.flags=0,t.head&&(t.head.done=!1),!(t.wrap&1)||(((p&255)<<8)+(p>>8))%31){n.msg="incorrect header check",t.mode=Kr;break}if((p&15)!==X3){n.msg="unknown compression method",t.mode=Kr;break}if(p>>>=4,g-=4,G=(p&15)+8,t.wbits===0)t.wbits=G;else if(G>t.wbits){n.msg="invalid window size",t.mode=Kr;break}t.dmax=1<<t.wbits,n.adler=t.check=1,t.mode=p&512?rk:lh,p=0,g=0;break;case Y3:for(;g<16;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if(t.flags=p,(t.flags&255)!==X3){n.msg="unknown compression method",t.mode=Kr;break}if(t.flags&57344){n.msg="unknown header flags set",t.mode=Kr;break}t.head&&(t.head.text=p>>8&1),t.flags&512&&(V[0]=p&255,V[1]=p>>>8&255,t.check=eu(t.check,V,2,0)),p=0,g=0,t.mode=K3;case K3:for(;g<32;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}t.head&&(t.head.time=p),t.flags&512&&(V[0]=p&255,V[1]=p>>>8&255,V[2]=p>>>16&255,V[3]=p>>>24&255,t.check=eu(t.check,V,4,0)),p=0,g=0,t.mode=J3;case J3:for(;g<16;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}t.head&&(t.head.xflags=p&255,t.head.os=p>>8),t.flags&512&&(V[0]=p&255,V[1]=p>>>8&255,t.check=eu(t.check,V,2,0)),p=0,g=0,t.mode=Q3;case Q3:if(t.flags&1024){for(;g<16;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}t.length=p,t.head&&(t.head.extra_len=p),t.flags&512&&(V[0]=p&255,V[1]=p>>>8&255,t.check=eu(t.check,V,2,0)),p=0,g=0}else t.head&&(t.head.extra=null);t.mode=ek;case ek:if(t.flags&1024&&(b=t.length,b>s&&(b=s),b&&(t.head&&(G=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(i.subarray(o,o+b),G)),t.flags&512&&(t.check=eu(t.check,i,b,o)),s-=b,o+=b,t.length-=b),t.length))break e;t.length=0,t.mode=tk;case tk:if(t.flags&2048){if(s===0)break e;b=0;do G=i[o+b++],t.head&&G&&t.length<65536&&(t.head.name+=String.fromCharCode(G));while(G&&b<s);if(t.flags&512&&(t.check=eu(t.check,i,b,o)),s-=b,o+=b,G)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=ik;case ik:if(t.flags&4096){if(s===0)break e;b=0;do G=i[o+b++],t.head&&G&&t.length<65536&&(t.head.comment+=String.fromCharCode(G));while(G&&b<s);if(t.flags&512&&(t.check=eu(t.check,i,b,o)),s-=b,o+=b,G)break e}else t.head&&(t.head.comment=null);t.mode=nk;case nk:if(t.flags&512){for(;g<16;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if(p!==(t.check&65535)){n.msg="header crc mismatch",t.mode=Kr;break}p=0,g=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),n.adler=t.check=0,t.mode=lh;break;case rk:for(;g<32;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}n.adler=t.check=_k(p),p=0,g=0,t.mode=jw;case jw:if(t.havedict===0)return n.next_out=c,n.avail_out=d,n.next_in=o,n.avail_in=s,t.hold=p,t.bits=g,Kse;n.adler=t.check=1,t.mode=lh;case lh:if(e===Xse||e===Rx)break e;case vM:if(t.last){p>>>=g&7,g-=g&7,t.mode=bM;break}for(;g<3;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}switch(t.last=p&1,p>>>=1,g-=1,p&3){case 0:t.mode=sk;break;case 1:if(ooe(t),t.mode=Lx,e===Rx){p>>>=2,g-=2;break e}break;case 2:t.mode=ak;break;case 3:n.msg="invalid block type",t.mode=Kr}p>>>=2,g-=2;break;case sk:for(p>>>=g&7,g-=g&7;g<32;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if((p&65535)!==(p>>>16^65535)){n.msg="invalid stored block lengths",t.mode=Kr;break}if(t.length=p&65535,p=0,g=0,t.mode=yM,e===Rx)break e;case yM:t.mode=ok;case ok:if(b=t.length,b){if(b>s&&(b=s),b>d&&(b=d),b===0)break e;r.set(i.subarray(o,o+b),c),s-=b,o+=b,d-=b,c+=b,t.length-=b;break}t.mode=lh;break;case ak:for(;g<14;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if(t.nlen=(p&31)+257,p>>>=5,g-=5,t.ndist=(p&31)+1,p>>>=5,g-=5,t.ncode=(p&15)+4,p>>>=4,g-=4,t.nlen>286||t.ndist>30){n.msg="too many length or distance symbols",t.mode=Kr;break}t.have=0,t.mode=lk;case lk:for(;t.have<t.ncode;){for(;g<3;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}t.lens[Q[t.have++]]=p&7,p>>>=3,g-=3}for(;t.have<19;)t.lens[Q[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,q={bits:t.lenbits},N=xy(Zse,t.lens,0,19,t.lencode,0,t.work,q),t.lenbits=q.bits,N){n.msg="invalid code lengths set",t.mode=Kr;break}t.have=0,t.mode=ck;case ck:for(;t.have<t.nlen+t.ndist;){for(;L=t.lencode[p&(1<<t.lenbits)-1],E=L>>>24,C=L>>>16&255,D=L&65535,!(E<=g);){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if(D<16)p>>>=E,g-=E,t.lens[t.have++]=D;else{if(D===16){for(z=E+2;g<z;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if(p>>>=E,g-=E,t.have===0){n.msg="invalid bit length repeat",t.mode=Kr;break}G=t.lens[t.have-1],b=3+(p&3),p>>>=2,g-=2}else if(D===17){for(z=E+3;g<z;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}p>>>=E,g-=E,G=0,b=3+(p&7),p>>>=3,g-=3}else{for(z=E+7;g<z;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}p>>>=E,g-=E,G=0,b=11+(p&127),p>>>=7,g-=7}if(t.have+b>t.nlen+t.ndist){n.msg="invalid bit length repeat",t.mode=Kr;break}for(;b--;)t.lens[t.have++]=G}}if(t.mode===Kr)break;if(t.lens[256]===0){n.msg="invalid code -- missing end-of-block",t.mode=Kr;break}if(t.lenbits=9,q={bits:t.lenbits},N=xy(xN,t.lens,0,t.nlen,t.lencode,0,t.work,q),t.lenbits=q.bits,N){n.msg="invalid literal/lengths set",t.mode=Kr;break}if(t.distbits=6,t.distcode=t.distdyn,q={bits:t.distbits},N=xy(wN,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,q),t.distbits=q.bits,N){n.msg="invalid distances set",t.mode=Kr;break}if(t.mode=Lx,e===Rx)break e;case Lx:t.mode=kx;case kx:if(s>=6&&d>=258){n.next_out=c,n.avail_out=d,n.next_in=o,n.avail_in=s,t.hold=p,t.bits=g,Use(n,x),c=n.next_out,r=n.output,d=n.avail_out,o=n.next_in,i=n.input,s=n.avail_in,p=t.hold,g=t.bits,t.mode===lh&&(t.back=-1);break}for(t.back=0;L=t.lencode[p&(1<<t.lenbits)-1],E=L>>>24,C=L>>>16&255,D=L&65535,!(E<=g);){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if(C&&(C&240)===0){for(O=E,U=C,j=D;L=t.lencode[j+((p&(1<<O+U)-1)>>O)],E=L>>>24,C=L>>>16&255,D=L&65535,!(O+E<=g);){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}p>>>=O,g-=O,t.back+=O}if(p>>>=E,g-=E,t.back+=E,t.length=D,C===0){t.mode=pk;break}if(C&32){t.back=-1,t.mode=lh;break}if(C&64){n.msg="invalid literal/length code",t.mode=Kr;break}t.extra=C&15,t.mode=uk;case uk:if(t.extra){for(z=t.extra;g<z;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}t.length+=p&(1<<t.extra)-1,p>>>=t.extra,g-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=hk;case hk:for(;L=t.distcode[p&(1<<t.distbits)-1],E=L>>>24,C=L>>>16&255,D=L&65535,!(E<=g);){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if((C&240)===0){for(O=E,U=C,j=D;L=t.distcode[j+((p&(1<<O+U)-1)>>O)],E=L>>>24,C=L>>>16&255,D=L&65535,!(O+E<=g);){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}p>>>=O,g-=O,t.back+=O}if(p>>>=E,g-=E,t.back+=E,C&64){n.msg="invalid distance code",t.mode=Kr;break}t.offset=D,t.extra=C&15,t.mode=dk;case dk:if(t.extra){for(z=t.extra;g<z;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}t.offset+=p&(1<<t.extra)-1,p>>>=t.extra,g-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){n.msg="invalid distance too far back",t.mode=Kr;break}t.mode=fk;case fk:if(d===0)break e;if(b=x-d,t.offset>b){if(b=t.offset-b,b>t.whave&&t.sane){n.msg="invalid distance too far back",t.mode=Kr;break}b>t.wnext?(b-=t.wnext,S=t.wsize-b):S=t.wnext-b,b>t.length&&(b=t.length),P=t.window}else P=r,S=c-t.offset,b=t.length;b>d&&(b=d),d-=b,t.length-=b;do r[c++]=P[S++];while(--b);t.length===0&&(t.mode=kx);break;case pk:if(d===0)break e;r[c++]=t.length,d--,t.mode=kx;break;case bM:if(t.wrap){for(;g<32;){if(s===0)break e;s--,p|=i[o++]<<g,g+=8}if(x-=d,n.total_out+=x,t.total+=x,x&&(n.adler=t.check=t.flags?eu(t.check,r,x,c-x):R2(t.check,r,x,c-x)),x=d,(t.flags?p:_k(p))!==t.check){n.msg="incorrect data check",t.mode=Kr;break}p=0,g=0}t.mode=mk;case mk:if(t.wrap&&t.flags){for(;g<32;){if(s===0)break e;s--,p+=i[o++]<<g,g+=8}if(p!==(t.total&4294967295)){n.msg="incorrect length check",t.mode=Kr;break}p=0,g=0}t.mode=gk;case gk:N=Yse;break e;case Kr:N=SN;break e;case CN:return TN;case Qse:default:return ql}return n.next_out=c,n.avail_out=d,n.next_in=o,n.avail_in=s,t.hold=p,t.bits=g,(t.wsize||x!==n.avail_out&&t.mode<Kr&&(t.mode<bM||e!==Z3))&&RN(n,n.output,n.next_out,x-n.avail_out),_-=n.avail_in,x-=n.avail_out,n.total_in+=_,n.total_out+=x,t.total+=x,t.wrap&&x&&(n.adler=t.check=t.flags?eu(t.check,r,x,n.next_out-x):R2(t.check,r,x,n.next_out-x)),n.data_type=t.bits+(t.last?64:0)+(t.mode===lh?128:0)+(t.mode===Lx||t.mode===yM?256:0),(_===0&&x===0||e===Z3)&&N===bp&&(N=Jse),N},loe=n=>{if(!n||!n.state)return ql;let e=n.state;return e.window&&(e.window=null),n.state=null,bp},coe=(n,e)=>{if(!n||!n.state)return ql;const t=n.state;return(t.wrap&2)===0?ql:(t.head=e,e.done=!1,bp)},uoe=(n,e)=>{const t=e.length;let i,r,o;return!n||!n.state||(i=n.state,i.wrap!==0&&i.mode!==jw)?ql:i.mode===jw&&(r=1,r=R2(r,e,t,0),r!==i.check)?SN:(o=RN(n,e,t,t),o?(i.mode=CN,TN):(i.havedict=1,bp))};var hoe=AN,doe=PN,foe=EN,poe=soe,moe=IN,goe=aoe,_oe=loe,voe=coe,yoe=uoe,boe="pako inflate (from Nodeca project)",fh={inflateReset:hoe,inflateReset2:doe,inflateResetKeep:foe,inflateInit:poe,inflateInit2:moe,inflate:goe,inflateEnd:_oe,inflateGetHeader:voe,inflateSetDictionary:yoe,inflateInfo:boe};function xoe(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var woe=xoe;const LN=Object.prototype.toString,{Z_NO_FLUSH:Soe,Z_FINISH:Toe,Z_OK:t0,Z_STREAM_END:SM,Z_NEED_DICT:TM,Z_STREAM_ERROR:Moe,Z_DATA_ERROR:yk,Z_MEM_ERROR:Coe}=vN;function P1(n){this.options=yN.assign({chunkSize:1024*64,windowBits:15,to:""},n||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),e.windowBits>=0&&e.windowBits<16&&!(n&&n.windowBits)&&(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(e.windowBits&15)===0&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new $se,this.strm.avail_out=0;let t=fh.inflateInit2(this.strm,e.windowBits);if(t!==t0)throw new Error(L2[t]);if(this.header=new woe,fh.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=k2.string2buf(e.dictionary):LN.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(t=fh.inflateSetDictionary(this.strm,e.dictionary),t!==t0)))throw new Error(L2[t])}P1.prototype.push=function(n,e){const t=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let o,c,s;if(this.ended)return!1;for(e===~~e?c=e:c=e===!0?Toe:Soe,LN.call(n)==="[object ArrayBuffer]"?t.input=new Uint8Array(n):t.input=n,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(i),t.next_out=0,t.avail_out=i),o=fh.inflate(t,c),o===TM&&r&&(o=fh.inflateSetDictionary(t,r),o===t0?o=fh.inflate(t,c):o===yk&&(o=TM));t.avail_in>0&&o===SM&&t.state.wrap>0&&n[t.next_in]!==0;)fh.inflateReset(t),o=fh.inflate(t,c);switch(o){case Moe:case yk:case TM:case Coe:return this.onEnd(o),this.ended=!0,!1}if(s=t.avail_out,t.next_out&&(t.avail_out===0||o===SM))if(this.options.to==="string"){let d=k2.utf8border(t.output,t.next_out),p=t.next_out-d,g=k2.buf2string(t.output,d);t.next_out=p,t.avail_out=i-p,p&&t.output.set(t.output.subarray(d,d+p),0),this.onData(g)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(o===t0&&s===0)){if(o===SM)return o=fh.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(t.avail_in===0)break}}return!0};P1.prototype.onData=function(n){this.chunks.push(n)};P1.prototype.onEnd=function(n){n===t0&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=yN.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};function Eoe(n,e){const t=new P1(e);if(t.push(n),t.err)throw t.msg||L2[t.err];return t.result}var Aoe=Eoe,Poe={inflate:Aoe};const{inflate:Ioe}=Poe;var Roe=Ioe,xE={};xE.read=function(n,e,t,i,r){var o,c,s=r*8-i-1,d=(1<<s)-1,p=d>>1,g=-7,_=t?r-1:0,x=t?-1:1,b=n[e+_];for(_+=x,o=b&(1<<-g)-1,b>>=-g,g+=s;g>0;o=o*256+n[e+_],_+=x,g-=8);for(c=o&(1<<-g)-1,o>>=-g,g+=i;g>0;c=c*256+n[e+_],_+=x,g-=8);if(o===0)o=1-p;else{if(o===d)return c?NaN:(b?-1:1)*(1/0);c=c+Math.pow(2,i),o=o-p}return(b?-1:1)*c*Math.pow(2,o-i)};xE.write=function(n,e,t,i,r,o){var c,s,d,p=o*8-r-1,g=(1<<p)-1,_=g>>1,x=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,b=i?0:o-1,S=i?1:-1,P=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,c=g):(c=Math.floor(Math.log(e)/Math.LN2),e*(d=Math.pow(2,-c))<1&&(c--,d*=2),c+_>=1?e+=x/d:e+=x*Math.pow(2,1-_),e*d>=2&&(c++,d/=2),c+_>=g?(s=0,c=g):c+_>=1?(s=(e*d-1)*Math.pow(2,r),c=c+_):(s=e*Math.pow(2,_-1)*Math.pow(2,r),c=0));r>=8;n[t+b]=s&255,b+=S,s/=256,r-=8);for(c=c<<r|s,p+=r;p>0;n[t+b]=c&255,b+=S,c/=256,p-=8);n[t+b-S]|=P*128};var Loe=Hn,Dx=xE;function Hn(n){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(n)?n:new Uint8Array(n||0),this.pos=0,this.type=0,this.length=this.buf.length}Hn.Varint=0;Hn.Fixed64=1;Hn.Bytes=2;Hn.Fixed32=5;var D2=65536*65536,bk=1/D2,koe=12,kN=typeof TextDecoder>"u"?null:new TextDecoder("utf8");Hn.prototype={destroy:function(){this.buf=null},readFields:function(n,e,t){for(t=t||this.length;this.pos<t;){var i=this.readVarint(),r=i>>3,o=this.pos;this.type=i&7,n(r,e,this),this.pos===o&&this.skip(i)}return e},readMessage:function(n,e){return this.readFields(n,e,this.readVarint()+this.pos)},readFixed32:function(){var n=Fx(this.buf,this.pos);return this.pos+=4,n},readSFixed32:function(){var n=wk(this.buf,this.pos);return this.pos+=4,n},readFixed64:function(){var n=Fx(this.buf,this.pos)+Fx(this.buf,this.pos+4)*D2;return this.pos+=8,n},readSFixed64:function(){var n=Fx(this.buf,this.pos)+wk(this.buf,this.pos+4)*D2;return this.pos+=8,n},readFloat:function(){var n=Dx.read(this.buf,this.pos,!0,23,4);return this.pos+=4,n},readDouble:function(){var n=Dx.read(this.buf,this.pos,!0,52,8);return this.pos+=8,n},readVarint:function(n){var e=this.buf,t,i;return i=e[this.pos++],t=i&127,i<128||(i=e[this.pos++],t|=(i&127)<<7,i<128)||(i=e[this.pos++],t|=(i&127)<<14,i<128)||(i=e[this.pos++],t|=(i&127)<<21,i<128)?t:(i=e[this.pos],t|=(i&15)<<28,Doe(t,n,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var n=this.readVarint();return n%2===1?(n+1)/-2:n/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var n=this.readVarint()+this.pos,e=this.pos;return this.pos=n,n-e>=koe&&kN?Zoe(this.buf,e,n):Hoe(this.buf,e,n)},readBytes:function(){var n=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,n);return this.pos=n,e},readPackedVarint:function(n,e){if(this.type!==Hn.Bytes)return n.push(this.readVarint(e));var t=ch(this);for(n=n||[];this.pos<t;)n.push(this.readVarint(e));return n},readPackedSVarint:function(n){if(this.type!==Hn.Bytes)return n.push(this.readSVarint());var e=ch(this);for(n=n||[];this.pos<e;)n.push(this.readSVarint());return n},readPackedBoolean:function(n){if(this.type!==Hn.Bytes)return n.push(this.readBoolean());var e=ch(this);for(n=n||[];this.pos<e;)n.push(this.readBoolean());return n},readPackedFloat:function(n){if(this.type!==Hn.Bytes)return n.push(this.readFloat());var e=ch(this);for(n=n||[];this.pos<e;)n.push(this.readFloat());return n},readPackedDouble:function(n){if(this.type!==Hn.Bytes)return n.push(this.readDouble());var e=ch(this);for(n=n||[];this.pos<e;)n.push(this.readDouble());return n},readPackedFixed32:function(n){if(this.type!==Hn.Bytes)return n.push(this.readFixed32());var e=ch(this);for(n=n||[];this.pos<e;)n.push(this.readFixed32());return n},readPackedSFixed32:function(n){if(this.type!==Hn.Bytes)return n.push(this.readSFixed32());var e=ch(this);for(n=n||[];this.pos<e;)n.push(this.readSFixed32());return n},readPackedFixed64:function(n){if(this.type!==Hn.Bytes)return n.push(this.readFixed64());var e=ch(this);for(n=n||[];this.pos<e;)n.push(this.readFixed64());return n},readPackedSFixed64:function(n){if(this.type!==Hn.Bytes)return n.push(this.readSFixed64());var e=ch(this);for(n=n||[];this.pos<e;)n.push(this.readSFixed64());return n},skip:function(n){var e=n&7;if(e===Hn.Varint)for(;this.buf[this.pos++]>127;);else if(e===Hn.Bytes)this.pos=this.readVarint()+this.pos;else if(e===Hn.Fixed32)this.pos+=4;else if(e===Hn.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+e)},writeTag:function(n,e){this.writeVarint(n<<3|e)},realloc:function(n){for(var e=this.length||16;e<this.pos+n;)e*=2;if(e!==this.length){var t=new Uint8Array(e);t.set(this.buf),this.buf=t,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(n){this.realloc(4),ug(this.buf,n,this.pos),this.pos+=4},writeSFixed32:function(n){this.realloc(4),ug(this.buf,n,this.pos),this.pos+=4},writeFixed64:function(n){this.realloc(8),ug(this.buf,n&-1,this.pos),ug(this.buf,Math.floor(n*bk),this.pos+4),this.pos+=8},writeSFixed64:function(n){this.realloc(8),ug(this.buf,n&-1,this.pos),ug(this.buf,Math.floor(n*bk),this.pos+4),this.pos+=8},writeVarint:function(n){if(n=+n||0,n>268435455||n<0){Foe(n,this);return}this.realloc(4),this.buf[this.pos++]=n&127|(n>127?128:0),!(n<=127)&&(this.buf[this.pos++]=(n>>>=7)&127|(n>127?128:0),!(n<=127)&&(this.buf[this.pos++]=(n>>>=7)&127|(n>127?128:0),!(n<=127)&&(this.buf[this.pos++]=n>>>7&127)))},writeSVarint:function(n){this.writeVarint(n<0?-n*2-1:n*2)},writeBoolean:function(n){this.writeVarint(!!n)},writeString:function(n){n=String(n),this.realloc(n.length*4),this.pos++;var e=this.pos;this.pos=Xoe(this.buf,n,this.pos);var t=this.pos-e;t>=128&&xk(e,t,this),this.pos=e-1,this.writeVarint(t),this.pos+=t},writeFloat:function(n){this.realloc(4),Dx.write(this.buf,n,this.pos,!0,23,4),this.pos+=4},writeDouble:function(n){this.realloc(8),Dx.write(this.buf,n,this.pos,!0,52,8),this.pos+=8},writeBytes:function(n){var e=n.length;this.writeVarint(e),this.realloc(e);for(var t=0;t<e;t++)this.buf[this.pos++]=n[t]},writeRawMessage:function(n,e){this.pos++;var t=this.pos;n(e,this);var i=this.pos-t;i>=128&&xk(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i},writeMessage:function(n,e,t){this.writeTag(n,Hn.Bytes),this.writeRawMessage(e,t)},writePackedVarint:function(n,e){e.length&&this.writeMessage(n,Boe,e)},writePackedSVarint:function(n,e){e.length&&this.writeMessage(n,Noe,e)},writePackedBoolean:function(n,e){e.length&&this.writeMessage(n,Uoe,e)},writePackedFloat:function(n,e){e.length&&this.writeMessage(n,$oe,e)},writePackedDouble:function(n,e){e.length&&this.writeMessage(n,Voe,e)},writePackedFixed32:function(n,e){e.length&&this.writeMessage(n,joe,e)},writePackedSFixed32:function(n,e){e.length&&this.writeMessage(n,Goe,e)},writePackedFixed64:function(n,e){e.length&&this.writeMessage(n,qoe,e)},writePackedSFixed64:function(n,e){e.length&&this.writeMessage(n,Woe,e)},writeBytesField:function(n,e){this.writeTag(n,Hn.Bytes),this.writeBytes(e)},writeFixed32Field:function(n,e){this.writeTag(n,Hn.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(n,e){this.writeTag(n,Hn.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(n,e){this.writeTag(n,Hn.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(n,e){this.writeTag(n,Hn.Fixed64),this.writeSFixed64(e)},writeVarintField:function(n,e){this.writeTag(n,Hn.Varint),this.writeVarint(e)},writeSVarintField:function(n,e){this.writeTag(n,Hn.Varint),this.writeSVarint(e)},writeStringField:function(n,e){this.writeTag(n,Hn.Bytes),this.writeString(e)},writeFloatField:function(n,e){this.writeTag(n,Hn.Fixed32),this.writeFloat(e)},writeDoubleField:function(n,e){this.writeTag(n,Hn.Fixed64),this.writeDouble(e)},writeBooleanField:function(n,e){this.writeVarintField(n,!!e)}};function Doe(n,e,t){var i=t.buf,r,o;if(o=i[t.pos++],r=(o&112)>>4,o<128||(o=i[t.pos++],r|=(o&127)<<3,o<128)||(o=i[t.pos++],r|=(o&127)<<10,o<128)||(o=i[t.pos++],r|=(o&127)<<17,o<128)||(o=i[t.pos++],r|=(o&127)<<24,o<128)||(o=i[t.pos++],r|=(o&1)<<31,o<128))return cg(n,r,e);throw new Error("Expected varint not more than 10 bytes")}function ch(n){return n.type===Hn.Bytes?n.readVarint()+n.pos:n.pos+1}function cg(n,e,t){return t?e*4294967296+(n>>>0):(e>>>0)*4294967296+(n>>>0)}function Foe(n,e){var t,i;if(n>=0?(t=n%4294967296|0,i=n/4294967296|0):(t=~(-n%4294967296),i=~(-n/4294967296),t^4294967295?t=t+1|0:(t=0,i=i+1|0)),n>=18446744073709552e3||n<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),Ooe(t,i,e),zoe(i,e)}function Ooe(n,e,t){t.buf[t.pos++]=n&127|128,n>>>=7,t.buf[t.pos++]=n&127|128,n>>>=7,t.buf[t.pos++]=n&127|128,n>>>=7,t.buf[t.pos++]=n&127|128,n>>>=7,t.buf[t.pos]=n&127}function zoe(n,e){var t=(n&7)<<4;e.buf[e.pos++]|=t|((n>>>=3)?128:0),n&&(e.buf[e.pos++]=n&127|((n>>>=7)?128:0),n&&(e.buf[e.pos++]=n&127|((n>>>=7)?128:0),n&&(e.buf[e.pos++]=n&127|((n>>>=7)?128:0),n&&(e.buf[e.pos++]=n&127|((n>>>=7)?128:0),n&&(e.buf[e.pos++]=n&127)))))}function xk(n,e,t){var i=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(Math.LN2*7));t.realloc(i);for(var r=t.pos-1;r>=n;r--)t.buf[r+i]=t.buf[r]}function Boe(n,e){for(var t=0;t<n.length;t++)e.writeVarint(n[t])}function Noe(n,e){for(var t=0;t<n.length;t++)e.writeSVarint(n[t])}function $oe(n,e){for(var t=0;t<n.length;t++)e.writeFloat(n[t])}function Voe(n,e){for(var t=0;t<n.length;t++)e.writeDouble(n[t])}function Uoe(n,e){for(var t=0;t<n.length;t++)e.writeBoolean(n[t])}function joe(n,e){for(var t=0;t<n.length;t++)e.writeFixed32(n[t])}function Goe(n,e){for(var t=0;t<n.length;t++)e.writeSFixed32(n[t])}function qoe(n,e){for(var t=0;t<n.length;t++)e.writeFixed64(n[t])}function Woe(n,e){for(var t=0;t<n.length;t++)e.writeSFixed64(n[t])}function Fx(n,e){return(n[e]|n[e+1]<<8|n[e+2]<<16)+n[e+3]*16777216}function ug(n,e,t){n[t]=e,n[t+1]=e>>>8,n[t+2]=e>>>16,n[t+3]=e>>>24}function wk(n,e){return(n[e]|n[e+1]<<8|n[e+2]<<16)+(n[e+3]<<24)}function Hoe(n,e,t){for(var i="",r=e;r<t;){var o=n[r],c=null,s=o>239?4:o>223?3:o>191?2:1;if(r+s>t)break;var d,p,g;s===1?o<128&&(c=o):s===2?(d=n[r+1],(d&192)===128&&(c=(o&31)<<6|d&63,c<=127&&(c=null))):s===3?(d=n[r+1],p=n[r+2],(d&192)===128&&(p&192)===128&&(c=(o&15)<<12|(d&63)<<6|p&63,(c<=2047||c>=55296&&c<=57343)&&(c=null))):s===4&&(d=n[r+1],p=n[r+2],g=n[r+3],(d&192)===128&&(p&192)===128&&(g&192)===128&&(c=(o&15)<<18|(d&63)<<12|(p&63)<<6|g&63,(c<=65535||c>=1114112)&&(c=null))),c===null?(c=65533,s=1):c>65535&&(c-=65536,i+=String.fromCharCode(c>>>10&1023|55296),c=56320|c&1023),i+=String.fromCharCode(c),r+=s}return i}function Zoe(n,e,t){return kN.decode(n.subarray(e,t))}function Xoe(n,e,t){for(var i=0,r,o;i<e.length;i++){if(r=e.charCodeAt(i),r>55295&&r<57344)if(o)if(r<56320){n[t++]=239,n[t++]=191,n[t++]=189,o=r;continue}else r=o-55296<<10|r-56320|65536,o=null;else{r>56319||i+1===e.length?(n[t++]=239,n[t++]=191,n[t++]=189):o=r;continue}else o&&(n[t++]=239,n[t++]=191,n[t++]=189,o=null);r<128?n[t++]=r:(r<2048?n[t++]=r>>6|192:(r<65536?n[t++]=r>>12|224:(n[t++]=r>>18|240,n[t++]=r>>12&63|128),n[t++]=r>>6&63|128),n[t++]=r&63|128)}return t}function Yoe(n){const e=Roe(n,{to:"string"});return JSON.parse(e)}function MM(n,e){return DN(n,"GET","arraybuffer",[],null,e)}function DN(n,e,t,i,r,o){const c=new XMLHttpRequest,s=new Promise((d,p)=>{c.open(e,n,!0);for(const g of i)c.setRequestHeader(g.name,g.value);c.responseType=t,c.timeout=15e3,c.onload=()=>{var g;if(c.status!==200){const _=(g=c.response)!==null&&g!==void 0?g:new ur(`Response status error: ${n}`);p(_)}c.response||p(new ur(`Response empty: ${n}`)),d(c.response)},c.onerror=()=>{p(new ur(`Request error: ${n}`))},c.ontimeout=()=>{p(new ur(`Request timeout: ${n}`))},c.onabort=()=>{p(new ur(`Request aborted: ${n}`))},c.send(e==="POST"?r:null)});return o&&o.catch(()=>{c.abort()}),s}function Koe(n){const e=new Loe(n),t={faces:[],vertices:[]};return e.readFields(Joe,t)}function Joe(n,e,t){n===1?e.vertices.push(t.readFloat()):n===2?e.faces.push(t.readVarint()):console.warn(`Unsupported pbf tag (${n})`)}class Qoe extends C1{constructor(e){super(),this._geometry=e}get geometry(){return this._geometry}fire(e,t){super.fire(e,t)}getCoreImages(e){return Promise.reject(new ur("Not implemented"))}getCluster(e,t){return Promise.reject(new ur("Not implemented"))}getSpatialImages(e){return Promise.reject(new ur("Not implemented"))}getImages(e){return Promise.reject(new ur("Not implemented"))}getImageBuffer(e,t){return Promise.reject(new ur("Not implemented"))}getImageTiles(e){return Promise.reject(new ur("Not implemented"))}getMesh(e,t){return Promise.reject(new ur("Not implemented"))}getSequence(e){return Promise.reject(new ur("Not implemented"))}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}setAccessToken(e){throw new ur("Not implemented")}}class eae{constructor(){}bboxToCellIds(e,t){throw new ur("Not implemented")}getAdjacent(e){throw new ur("Not implemented")}getVertices(e){throw new ur("Not implemented")}lngLatToCellId(e){throw new ur("Not implemented")}_approxBboxToCellIds(e,t){if(t.lat<=e.lat||t.lng<=e.lng)throw new ur("North east needs to be top right of south west");const i=(e.lat+t.lat)/2,r=(e.lng+t.lng)/2,o=ra(t.lng,t.lat,0,r,i,0),c=Math.max(o[0],o[1]);return this._lngLatToCellIds({lat:i,lng:r},c)}_enuToGeodetic(e,t){const[i,r]=vp(e[0],e[1],e[2],t.lng,t.lat,0);return{lat:r,lng:i}}_getLngLatBoundingBoxCorners(e,t){return[[-t,t,0],[t,t,0],[t,-t,0],[-t,-t,0]].map(i=>this._enuToGeodetic(i,e))}_lngLatToCellIds(e,t){const i=this.lngLatToCellId(e),r=this._getLngLatBoundingBoxCorners(e,t);for(const o of r)if(this.lngLatToCellId(o)!==i)return[i,...this.getAdjacent(i)];return[i]}}var uh={exports:{}},ew={exports:{}};(function(n){(function(e,t){typeof bee=="function"&&n&&n.exports?n.exports=t():(e.dcodeIO=e.dcodeIO||{}).Long=t()})(Hy,function(){function e(q,z,Q){this.low=q|0,this.high=z|0,this.unsigned=!!Q}e.prototype.__isLong__,Object.defineProperty(e.prototype,"__isLong__",{value:!0,enumerable:!1,configurable:!1});function t(q){return(q&&q.__isLong__)===!0}e.isLong=t;var i={},r={};function o(q,z){var Q,X,re;return z?(q>>>=0,(re=0<=q&&q<256)&&(X=r[q],X)?X:(Q=s(q,(q|0)<0?-1:0,!0),re&&(r[q]=Q),Q)):(q|=0,(re=-128<=q&&q<128)&&(X=i[q],X)?X:(Q=s(q,q<0?-1:0,!1),re&&(i[q]=Q),Q))}e.fromInt=o;function c(q,z){if(isNaN(q)||!isFinite(q))return z?C:E;if(z){if(q<0)return C;if(q>=S)return G}else{if(q<=-P)return N;if(q+1>=P)return j}return q<0?c(-q,z).neg():s(q%b|0,q/b|0,z)}e.fromNumber=c;function s(q,z,Q){return new e(q,z,Q)}e.fromBits=s;var d=Math.pow;function p(q,z,Q){if(q.length===0)throw Error("empty string");if(q==="NaN"||q==="Infinity"||q==="+Infinity"||q==="-Infinity")return E;if(typeof z=="number"?(Q=z,z=!1):z=!!z,Q=Q||10,Q<2||36<Q)throw RangeError("radix");var X;if((X=q.indexOf("-"))>0)throw Error("interior hyphen");if(X===0)return p(q.substring(1),z,Q).neg();for(var re=c(d(Q,8)),oe=E,de=0;de<q.length;de+=8){var ce=Math.min(8,q.length-de),Se=parseInt(q.substring(de,de+ce),Q);if(ce<8){var Pe=c(d(Q,ce));oe=oe.mul(Pe).add(c(Se))}else oe=oe.mul(re),oe=oe.add(c(Se))}return oe.unsigned=z,oe}e.fromString=p;function g(q){return q instanceof e?q:typeof q=="number"?c(q):typeof q=="string"?p(q):s(q.low,q.high,q.unsigned)}e.fromValue=g;var _=65536,x=1<<24,b=_*_,S=b*b,P=S/2,L=o(x),E=o(0);e.ZERO=E;var C=o(0,!0);e.UZERO=C;var D=o(1);e.ONE=D;var O=o(1,!0);e.UONE=O;var U=o(-1);e.NEG_ONE=U;var j=s(-1,2147483647,!1);e.MAX_VALUE=j;var G=s(-1,-1,!0);e.MAX_UNSIGNED_VALUE=G;var N=s(0,-2147483648,!1);e.MIN_VALUE=N;var V=e.prototype;return V.toInt=function(){return this.unsigned?this.low>>>0:this.low},V.toNumber=function(){return this.unsigned?(this.high>>>0)*b+(this.low>>>0):this.high*b+(this.low>>>0)},V.toString=function(z){if(z=z||10,z<2||36<z)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative())if(this.eq(N)){var Q=c(z),X=this.div(Q),re=X.mul(Q).sub(this);return X.toString(z)+re.toInt().toString(z)}else return"-"+this.neg().toString(z);for(var oe=c(d(z,6),this.unsigned),de=this,ce="";;){var Se=de.div(oe),Pe=de.sub(Se.mul(oe)).toInt()>>>0,je=Pe.toString(z);if(de=Se,de.isZero())return je+ce;for(;je.length<6;)je="0"+je;ce=""+je+ce}},V.getHighBits=function(){return this.high},V.getHighBitsUnsigned=function(){return this.high>>>0},V.getLowBits=function(){return this.low},V.getLowBitsUnsigned=function(){return this.low>>>0},V.getNumBitsAbs=function(){if(this.isNegative())return this.eq(N)?64:this.neg().getNumBitsAbs();for(var z=this.high!=0?this.high:this.low,Q=31;Q>0&&(z&1<<Q)==0;Q--);return this.high!=0?Q+33:Q+1},V.isZero=function(){return this.high===0&&this.low===0},V.isNegative=function(){return!this.unsigned&&this.high<0},V.isPositive=function(){return this.unsigned||this.high>=0},V.isOdd=function(){return(this.low&1)===1},V.isEven=function(){return(this.low&1)===0},V.equals=function(z){return t(z)||(z=g(z)),this.unsigned!==z.unsigned&&this.high>>>31===1&&z.high>>>31===1?!1:this.high===z.high&&this.low===z.low},V.eq=V.equals,V.notEquals=function(z){return!this.eq(z)},V.neq=V.notEquals,V.lessThan=function(z){return this.comp(z)<0},V.lt=V.lessThan,V.lessThanOrEqual=function(z){return this.comp(z)<=0},V.lte=V.lessThanOrEqual,V.greaterThan=function(z){return this.comp(z)>0},V.gt=V.greaterThan,V.greaterThanOrEqual=function(z){return this.comp(z)>=0},V.gte=V.greaterThanOrEqual,V.compare=function(z){if(t(z)||(z=g(z)),this.eq(z))return 0;var Q=this.isNegative(),X=z.isNegative();return Q&&!X?-1:!Q&&X?1:this.unsigned?z.high>>>0>this.high>>>0||z.high===this.high&&z.low>>>0>this.low>>>0?-1:1:this.sub(z).isNegative()?-1:1},V.comp=V.compare,V.negate=function(){return!this.unsigned&&this.eq(N)?N:this.not().add(D)},V.neg=V.negate,V.add=function(z){t(z)||(z=g(z));var Q=this.high>>>16,X=this.high&65535,re=this.low>>>16,oe=this.low&65535,de=z.high>>>16,ce=z.high&65535,Se=z.low>>>16,Pe=z.low&65535,je=0,Fe=0,qe=0,Ue=0;return Ue+=oe+Pe,qe+=Ue>>>16,Ue&=65535,qe+=re+Se,Fe+=qe>>>16,qe&=65535,Fe+=X+ce,je+=Fe>>>16,Fe&=65535,je+=Q+de,je&=65535,s(qe<<16|Ue,je<<16|Fe,this.unsigned)},V.subtract=function(z){return t(z)||(z=g(z)),this.add(z.neg())},V.sub=V.subtract,V.multiply=function(z){if(this.isZero()||(t(z)||(z=g(z)),z.isZero()))return E;if(this.eq(N))return z.isOdd()?N:E;if(z.eq(N))return this.isOdd()?N:E;if(this.isNegative())return z.isNegative()?this.neg().mul(z.neg()):this.neg().mul(z).neg();if(z.isNegative())return this.mul(z.neg()).neg();if(this.lt(L)&&z.lt(L))return c(this.toNumber()*z.toNumber(),this.unsigned);var Q=this.high>>>16,X=this.high&65535,re=this.low>>>16,oe=this.low&65535,de=z.high>>>16,ce=z.high&65535,Se=z.low>>>16,Pe=z.low&65535,je=0,Fe=0,qe=0,Ue=0;return Ue+=oe*Pe,qe+=Ue>>>16,Ue&=65535,qe+=re*Pe,Fe+=qe>>>16,qe&=65535,qe+=oe*Se,Fe+=qe>>>16,qe&=65535,Fe+=X*Pe,je+=Fe>>>16,Fe&=65535,Fe+=re*Se,je+=Fe>>>16,Fe&=65535,Fe+=oe*ce,je+=Fe>>>16,Fe&=65535,je+=Q*Pe+X*Se+re*ce+oe*de,je&=65535,s(qe<<16|Ue,je<<16|Fe,this.unsigned)},V.mul=V.multiply,V.divide=function(z){if(t(z)||(z=g(z)),z.isZero())throw Error("division by zero");if(this.isZero())return this.unsigned?C:E;var Q,X,re;if(this.unsigned){if(z.unsigned||(z=z.toUnsigned()),z.gt(this))return C;if(z.gt(this.shru(1)))return O;re=C}else{if(this.eq(N)){if(z.eq(D)||z.eq(U))return N;if(z.eq(N))return D;var oe=this.shr(1);return Q=oe.div(z).shl(1),Q.eq(E)?z.isNegative()?D:U:(X=this.sub(z.mul(Q)),re=Q.add(X.div(z)),re)}else if(z.eq(N))return this.unsigned?C:E;if(this.isNegative())return z.isNegative()?this.neg().div(z.neg()):this.neg().div(z).neg();if(z.isNegative())return this.div(z.neg()).neg();re=E}for(X=this;X.gte(z);){Q=Math.max(1,Math.floor(X.toNumber()/z.toNumber()));for(var de=Math.ceil(Math.log(Q)/Math.LN2),ce=de<=48?1:d(2,de-48),Se=c(Q),Pe=Se.mul(z);Pe.isNegative()||Pe.gt(X);)Q-=ce,Se=c(Q,this.unsigned),Pe=Se.mul(z);Se.isZero()&&(Se=D),re=re.add(Se),X=X.sub(Pe)}return re},V.div=V.divide,V.modulo=function(z){return t(z)||(z=g(z)),this.sub(this.div(z).mul(z))},V.mod=V.modulo,V.not=function(){return s(~this.low,~this.high,this.unsigned)},V.and=function(z){return t(z)||(z=g(z)),s(this.low&z.low,this.high&z.high,this.unsigned)},V.or=function(z){return t(z)||(z=g(z)),s(this.low|z.low,this.high|z.high,this.unsigned)},V.xor=function(z){return t(z)||(z=g(z)),s(this.low^z.low,this.high^z.high,this.unsigned)},V.shiftLeft=function(z){return t(z)&&(z=z.toInt()),(z&=63)===0?this:z<32?s(this.low<<z,this.high<<z|this.low>>>32-z,this.unsigned):s(0,this.low<<z-32,this.unsigned)},V.shl=V.shiftLeft,V.shiftRight=function(z){return t(z)&&(z=z.toInt()),(z&=63)===0?this:z<32?s(this.low>>>z|this.high<<32-z,this.high>>z,this.unsigned):s(this.high>>z-32,this.high>=0?0:-1,this.unsigned)},V.shr=V.shiftRight,V.shiftRightUnsigned=function(z){if(t(z)&&(z=z.toInt()),z&=63,z===0)return this;var Q=this.high;if(z<32){var X=this.low;return s(X>>>z|Q<<32-z,Q>>>z,this.unsigned)}else return z===32?s(Q,0,this.unsigned):s(Q>>>z-32,0,this.unsigned)},V.shru=V.shiftRightUnsigned,V.toSigned=function(){return this.unsigned?s(this.low,this.high,!1):this},V.toUnsigned=function(){return this.unsigned?this:s(this.low,this.high,!0)},V.toBytes=function(q){return q?this.toBytesLE():this.toBytesBE()},V.toBytesLE=function(){var q=this.high,z=this.low;return[z&255,z>>>8&255,z>>>16&255,z>>>24&255,q&255,q>>>8&255,q>>>16&255,q>>>24&255]},V.toBytesBE=function(){var q=this.high,z=this.low;return[q>>>24&255,q>>>16&255,q>>>8&255,q&255,z>>>24&255,z>>>16&255,z>>>8&255,z&255]},e})})(ew);(function(n){(function(e){var t=e.S2={L:{}};t.L.LatLng=function(p,g,_){var x=parseFloat(p,10),b=parseFloat(g,10);if(isNaN(x)||isNaN(b))throw new Error("Invalid LatLng object: ("+p+", "+g+")");return _!==!0&&(x=Math.max(Math.min(x,90),-90),b=(b+180)%360+(b<-180||b===180?180:-180)),{lat:x,lng:b}},t.L.LatLng.DEG_TO_RAD=Math.PI/180,t.L.LatLng.RAD_TO_DEG=180/Math.PI,t.LatLngToXYZ=function(p){var g=t.L.LatLng.DEG_TO_RAD,_=p.lat*g,x=p.lng*g,b=Math.cos(_);return[Math.cos(x)*b,Math.sin(x)*b,Math.sin(_)]},t.XYZToLatLng=function(p){var g=t.L.LatLng.RAD_TO_DEG,_=Math.atan2(p[2],Math.sqrt(p[0]*p[0]+p[1]*p[1])),x=Math.atan2(p[1],p[0]);return t.L.LatLng(_*g,x*g)};var i=function(p){var g=[Math.abs(p[0]),Math.abs(p[1]),Math.abs(p[2])];return g[0]>g[1]?g[0]>g[2]?0:2:g[1]>g[2]?1:2},r=function(p,g){var _,x;switch(p){case 0:_=g[1]/g[0],x=g[2]/g[0];break;case 1:_=-g[0]/g[1],x=g[2]/g[1];break;case 2:_=-g[0]/g[2],x=-g[1]/g[2];break;case 3:_=g[2]/g[0],x=g[1]/g[0];break;case 4:_=g[2]/g[1],x=-g[0]/g[1];break;case 5:_=-g[1]/g[2],x=-g[0]/g[2];break;default:throw{error:"Invalid face"}}return[_,x]};t.XYZToFaceUV=function(p){var g=i(p);p[g]<0&&(g+=3);var _=r(g,p);return[g,_]},t.FaceUVToXYZ=function(p,g){var _=g[0],x=g[1];switch(p){case 0:return[1,_,x];case 1:return[-_,1,x];case 2:return[-_,-x,1];case 3:return[-1,-x,-_];case 4:return[x,-1,-_];case 5:return[x,_,-1];default:throw{error:"Invalid face"}}};var o=function(p){return p>=.5?1/3*(4*p*p-1):1/3*(1-4*(1-p)*(1-p))};t.STToUV=function(p){return[o(p[0]),o(p[1])]};var c=function(p){return p>=0?.5*Math.sqrt(1+3*p):1-.5*Math.sqrt(1-3*p)};t.UVToST=function(p){return[c(p[0]),c(p[1])]},t.STToIJ=function(p,g){var _=1<<g,x=function(b){var S=Math.floor(b*_);return Math.max(0,Math.min(_-1,S))};return[x(p[0]),x(p[1])]},t.IJToST=function(p,g,_){var x=1<<g;return[(p[0]+_[0])/x,(p[1]+_[1])/x]};var s=function(p,g,_,x){if(x==0){_==1&&(g.x=p-1-g.x,g.y=p-1-g.y);var b=g.x;g.x=g.y,g.y=b}},d=function(p,g,_,x){var b={a:[[0,"d"],[1,"a"],[3,"b"],[2,"a"]],b:[[2,"b"],[1,"b"],[3,"a"],[0,"c"]],c:[[2,"c"],[3,"d"],[1,"c"],[0,"b"]],d:[[0,"a"],[3,"c"],[1,"d"],[2,"d"]]};typeof x!="number"&&console.warn(new Error("called pointToHilbertQuadList without face value, defaulting to '0'").stack);for(var S=x%2?"d":"a",P=[],L=_-1;L>=0;L--){var E=1<<L,C=p&E?1:0,D=g&E?1:0,O=b[S][C*2+D];P.push(O[0]),S=O[1]}return P};t.S2Cell=function(){},t.S2Cell.FromHilbertQuadKey=function(p){var g=p.split("/"),_=parseInt(g[0]),x=g[1],b=x.length,S={x:0,y:0},P,L,E,C,D,O;for(P=b-1;P>=0;P--)L=b-P,E=x[P],C=0,D=0,E==="1"?D=1:E==="2"?(C=1,D=1):E==="3"&&(C=1),O=Math.pow(2,L-1),s(O,S,C,D),S.x+=O*C,S.y+=O*D;if(_%2===1){var U=S.x;S.x=S.y,S.y=U}return t.S2Cell.FromFaceIJ(parseInt(_),[S.x,S.y],L)},t.S2Cell.FromLatLng=function(p,g){if(!p.lat&&p.lat!==0||!p.lng&&p.lng!==0)throw new Error("Pass { lat: lat, lng: lng } to S2.S2Cell.FromLatLng");var _=t.LatLngToXYZ(p),x=t.XYZToFaceUV(_),b=t.UVToST(x[1]),S=t.STToIJ(b,g);return t.S2Cell.FromFaceIJ(x[0],S,g)},t.S2Cell.FromFaceIJ=function(p,g,_){var x=new t.S2Cell;return x.face=p,x.ij=g,x.level=_,x},t.S2Cell.prototype.toString=function(){return"F"+this.face+"ij["+this.ij[0]+","+this.ij[1]+"]@"+this.level},t.S2Cell.prototype.getLatLng=function(){var p=t.IJToST(this.ij,this.level,[.5,.5]),g=t.STToUV(p),_=t.FaceUVToXYZ(this.face,g);return t.XYZToLatLng(_)},t.S2Cell.prototype.getCornerLatLngs=function(){for(var p=[],g=[[0,0],[0,1],[1,1],[1,0]],_=0;_<4;_++){var x=t.IJToST(this.ij,this.level,g[_]),b=t.STToUV(x),S=t.FaceUVToXYZ(this.face,b);p.push(t.XYZToLatLng(S))}return p},t.S2Cell.prototype.getFaceAndQuads=function(){var p=d(this.ij[0],this.ij[1],this.level,this.face);return[this.face,p]},t.S2Cell.prototype.toHilbertQuadkey=function(){var p=d(this.ij[0],this.ij[1],this.level,this.face);return this.face.toString(10)+"/"+p.join("")},t.latLngToNeighborKeys=t.S2Cell.latLngToNeighborKeys=function(p,g,_){return t.S2Cell.FromLatLng({lat:p,lng:g},_).getNeighbors().map(function(x){return x.toHilbertQuadkey()})},t.S2Cell.prototype.getNeighbors=function(){var p=function(S,P,L){var E=1<<L;if(P[0]>=0&&P[1]>=0&&P[0]<E&&P[1]<E)return t.S2Cell.FromFaceIJ(S,P,L);var C=t.IJToST(P,L,[.5,.5]),D=t.STToUV(C),O=t.FaceUVToXYZ(S,D),U=t.XYZToFaceUV(O);return S=U[0],D=U[1],C=t.UVToST(D),P=t.STToIJ(C,L),t.S2Cell.FromFaceIJ(S,P,L)},g=this.face,_=this.ij[0],x=this.ij[1],b=this.level;return[p(g,[_-1,x],b),p(g,[_,x-1],b),p(g,[_+1,x],b),p(g,[_,x+1],b)]},t.FACE_BITS=3,t.MAX_LEVEL=30,t.POS_BITS=2*t.MAX_LEVEL+1,t.facePosLevelToId=t.S2Cell.facePosLevelToId=t.fromFacePosLevel=function(p,g,_){var x=e.dcodeIO&&e.dcodeIO.Long||ew.exports,b,S,P;for(_||(_=g.length),g.length>_&&(g=g.substr(0,_)),b=x.fromString(p.toString(10),!0,10).toString(2);b.length<t.FACE_BITS;)b="0"+b;for(S=x.fromString(g,!0,4).toString(2);S.length<2*_;)S="0"+S;for(P=b+S,P+="1";P.length<t.FACE_BITS+t.POS_BITS;)P+="0";return x.fromString(P,!0,2).toString(10)},t.keyToId=t.S2Cell.keyToId=t.toId=t.toCellId=t.fromKey=function(p){var g=p.split("/");return t.fromFacePosLevel(g[0],g[1],g[1].length)},t.idToKey=t.S2Cell.idToKey=t.S2Cell.toKey=t.toKey=t.fromId=t.fromCellId=t.S2Cell.toHilbertQuadkey=t.toHilbertQuadkey=function(p){for(var g=e.dcodeIO&&e.dcodeIO.Long||ew.exports,_=g.fromString(p,!0,10).toString(2);_.length<t.FACE_BITS+t.POS_BITS;)_="0"+_;for(var x=_.lastIndexOf("1"),b=_.substring(0,3),S=_.substring(3,x),P=S.length/2,L=g.fromString(b,!0,2).toString(10),E=g.fromString(S,!0,2).toString(4);E.length<P;)E="0"+E;return L+"/"+E},t.keyToLatLng=t.S2Cell.keyToLatLng=function(p){var g=t.S2Cell.FromHilbertQuadKey(p);return g.getLatLng()},t.idToLatLng=t.S2Cell.idToLatLng=function(p){var g=t.idToKey(p);return t.keyToLatLng(g)},t.S2Cell.latLngToKey=t.latLngToKey=t.latLngToQuadkey=function(p,g,_){if(isNaN(_)||_<1||_>30)throw new Error("'level' is not a number between 1 and 30 (but it should be)");return t.S2Cell.FromLatLng({lat:p,lng:g},_).toHilbertQuadkey()},t.stepKey=function(p,g){var _=e.dcodeIO&&e.dcodeIO.Long||ew.exports,x=p.split("/"),b=x[0],S=x[1],P=x[1].length,L=_.fromString(S,!0,4),E;g>0?E=L.add(Math.abs(g)):g<0&&(E=L.subtract(Math.abs(g)));var C=E.toString(4);for(C==="0"&&console.warning(new Error("face/position wrapping is not yet supported"));C.length<P;)C="0"+C;return b+"/"+C},t.S2Cell.prevKey=t.prevKey=function(p){return t.stepKey(p,-1)},t.S2Cell.nextKey=t.nextKey=function(p){return t.stepKey(p,1)}})(n.exports)})(uh);class tae extends eae{constructor(e=17){super(),this._level=e}bboxToCellIds(e,t){return this._approxBboxToCellIds(e,t)}getAdjacent(e){const t=uh.exports.S2.idToKey(e),r=t.split("/")[1].length,[o,c,s,d]=this._getNeighbors(t,r),p=[t,o,c,s,d],g=Array.from(new Set([...this._getNeighbors(o,r),...this._getNeighbors(c,r),...this._getNeighbors(s,r),...this._getNeighbors(d,r)].filter(x=>!p.includes(x)))),_=[o,c,s,d];for(const x of g){let b=0;for(const S of this._getNeighbors(x,r))p.includes(S)&&b++;b===2&&_.push(x)}return _.map(x=>uh.exports.S2.keyToId(x))}getVertices(e){const t=uh.exports.S2.idToKey(e);return uh.exports.S2.S2Cell.FromHilbertQuadKey(t).getCornerLatLngs().map(r=>({lat:r.lat,lng:r.lng}))}lngLatToCellId(e){return this._lngLatToId(e,this._level)}_getNeighbors(e,t){const i=uh.exports.S2.keyToLatLng(e);return uh.exports.S2.latLngToNeighborKeys(i.lat,i.lng,t)}_lngLatToId(e,t){const i=uh.exports.S2.latLngToKey(e.lat,e.lng,t);return uh.exports.S2.keyToId(i)}}function iae(n){switch(n){case"equirectangular":case"spherical":return"spherical";case"fisheye":return"fisheye";default:return"perspective"}}class nae{clusterReconstruction(e){const i=e.points,r=1/255;for(const s in i){if(!i.hasOwnProperty(s))continue;const d=i[s].color;d[0]*=r,d[1]*=r,d[2]*=r}const o=e.reference_lla,c={alt:o.altitude,lat:o.latitude,lng:o.longitude};return{id:null,points:i,reference:c}}coreImage(e){const t=this._geometry(e.geometry),i=this._geometry(e.computed_geometry),r={id:e.sequence},o=e.id;return{computed_geometry:i,geometry:t,id:o,sequence:r}}spatialImage(e){var t,i,r,o,c;e.camera_type=iae(e.camera_type),e.merge_id=e.merge_cc?e.merge_cc.toString():null,e.private=null;const s=e.camera_type==="spherical"?e.thumb_2048_url:e.thumb_1024_url;return e.thumb=(t=e.thumb)!==null&&t!==void 0?t:{id:null,url:s},e.cluster=(i=e.sfm_cluster)!==null&&i!==void 0?i:{id:null,url:null},e.creator=(r=e.creator)!==null&&r!==void 0?r:{id:null,username:null},e.owner=(o=e.organization)!==null&&o!==void 0?o:{id:null},e.mesh=(c=e.mesh)!==null&&c!==void 0?c:{id:null,url:null},e}_geometry(e){const t=e?.coordinates;return t?{lat:t[1],lng:t[0]}:null}}class rae{constructor(){this.imagesPath="images",this.sequencePath="image_ids",this._imageTilesPath="tiles",this.coreFields=["computed_geometry","geometry","sequence"],this.idFields=["id"],this.spatialFields=["altitude","atomic_scale","camera_parameters","camera_type","captured_at","compass_angle","computed_altitude","computed_compass_angle","computed_rotation","creator","exif_orientation","height","merge_cc","mesh","organization","quality_score","sfm_cluster","thumb_1024_url","thumb_2048_url","width"],this.imageTileFields=["url","z","x","y"]}images(e,t){return`image_ids=${e.join(",")}&fields=${t.join(",")}`}imagesS2(e,t){return`s2=${e}&fields=${t.join(",")}`}imageTiles(e,t){return`z=${e}&fields=${t.join(",")}`}imageTilesPath(e){return`${e}/${this._imageTilesPath}`}sequence(e){return`sequence_id=${e}`}}class sae extends Qoe{constructor(e,t,i,r){var o;super(t??new tae),this._convert=i??new nae,this._query=r??new rae,this._method="GET";const c=e??{};this._endpoint=(o=c.endpoint)!==null&&o!==void 0?o:"https://graph.mapillary.com",this._accessToken=c.accessToken}getCluster(e,t){return MM(e,t).then(i=>{const r=Yoe(i);if(r.length<1)throw new Error("Cluster reconstruction empty");return this._convert.clusterReconstruction(r[0])})}getCoreImages(e){const t=[...this._query.idFields,...this._query.coreFields],i=this._query.imagesS2(e,t),r=new URL(this._query.imagesPath,this._endpoint).href;return this._fetchGraphContract(i,r).then(o=>{const c={cell_id:e,images:[]},s=o.data;for(const d of s){const p=this._convert.coreImage(d);c.images.push(p)}return c})}getImageBuffer(e,t){return MM(e,t)}getImages(e){const t=[...this._query.idFields,...this._query.coreFields,...this._query.spatialFields],i=this._query.images(e,t),r=new URL(this._query.imagesPath,this._endpoint).href;return this._fetchGraphContract(i,r).then(o=>{const c=[],s=o.data;for(const d of s){const p=this._convert.coreImage(d),g=this._convert.spatialImage(d),x={node:Object.assign({},g,p),node_id:d.id};c.push(x)}return c})}getImageTiles(e){const t=[...this._query.imageTileFields],i=this._query.imageTiles(e.z,t),r=new URL(this._query.imageTilesPath(e.imageId),this._endpoint).href;return this._fetchGraphContract(i,r).then(o=>({node:o.data,node_id:e.imageId}))}getMesh(e,t){return MM(e,t).then(i=>Koe(i))}getSequence(e){const t=this._query.sequence(e),i=new URL(this._query.sequencePath,this._endpoint).href;return this._fetchGraphContract(t,i).then(r=>({id:e,image_ids:r.data.map(c=>c.id)}))}getSpatialImages(e){const t=[...this._query.idFields,...this._query.coreFields,...this._query.spatialFields],i=this._query.images(e,t),r=new URL(this._query.imagesPath,this._endpoint).href;return this._fetchGraphContract(i,r).then(o=>{const c=[],s=o.data;for(const d of s){const g={node:this._convert.spatialImage(d),node_id:d.id};c.push(g)}return c})}setAccessToken(e){this._accessToken=e}_createHeaders(){const e=[{name:"Accept",value:"application/json"},{name:"Content-Type",value:"application/x-www-form-urlencoded"}];return this._accessToken&&e.push({name:"Authorization",value:`OAuth ${this._accessToken}`}),e}_fetchGraphContract(e,t){const i=this._method,r=this._createHeaders(),o=`${t}?${e}`;return DN(o,i,"json",r,null,null).catch(c=>{const s=this._makeErrorMessage(c);throw new ur(s)})}_makeErrorMessage(e){const t=e.error;return t?`${t.code} (${t.type}, ${t.fbtrace_id}): ${t.message}`:"Failed to fetch data"}}var wh;(function(n){n[n.Custom=0]="Custom",n[n.Earth=1]="Earth",n[n.Street=2]="Street"})(wh||(wh={}));var t_;(function(n){n[n.Letterbox=0]="Letterbox",n[n.Fill=1]="Fill"})(t_||(t_={}));var Sk;(function(n){n[n.Opaque=0]="Opaque"})(Sk||(Sk={}));var Gw;(function(n){n[n.Default=0]="Default",n[n.Instantaneous=1]="Instantaneous"})(Gw||(Gw={}));class oae{constructor(e,t,i,r,o,c){this._container=e,this._observer=i,this._navigator=t,this._options=o??{},this._key=r,this._navigable=r==null,this._componentService=c||new Cr(this._container,this._navigator),this._coverComponent=this._componentService.getCover(),this._initializeComponents(),r?(this._initilizeCoverComponent(),this._subscribeCoverComponent()):this._navigator.movedToId$.pipe(wi(s=>s!=null)).subscribe(s=>{this._key=s,this._componentService.deactivateCover(),this._coverComponent.configure({id:this._key,state:ia.Hidden}),this._subscribeCoverComponent(),this._navigator.stateService.start(),this._navigator.cacheService.start(),this._navigator.panService.start(),this._observer.startEmit()})}get navigable(){return this._navigable}get(e){return this._componentService.get(e)}activate(e){this._componentService.activate(e)}activateCover(){this._coverComponent.configure({state:ia.Visible})}deactivate(e){this._componentService.deactivate(e)}deactivateCover(){this._coverComponent.configure({state:ia.Loading})}remove(){this._componentService.remove(),this._configurationSubscription!=null&&this._configurationSubscription.unsubscribe()}_initializeComponents(){var e,t;const i=this._options;this._uFalse((e=i.fallback)===null||e===void 0?void 0:e.image,"imagefallback"),this._uFalse((t=i.fallback)===null||t===void 0?void 0:t.navigation,"navigationfallback"),this._uFalse(i.marker,"marker"),this._uFalse(i.popup,"popup"),this._uFalse(i.slider,"slider"),this._uFalse(i.spatial,"spatial"),this._uFalse(i.tag,"tag"),this._uTrue(i.attribution,"attribution"),this._uTrue(i.bearing,"bearing"),this._uTrue(i.cache,"cache"),this._uTrue(i.direction,"direction"),this._uTrue(i.image,"image"),this._uTrue(i.keyboard,"keyboard"),this._uTrue(i.pointer,"pointer"),this._uTrue(i.sequence,"sequence"),this._uTrue(i.zoom,"zoom")}_initilizeCoverComponent(){let e=this._options;this._coverComponent.configure({id:this._key}),e.cover===void 0||e.cover?this.activateCover():this.deactivateCover()}_setNavigable(e){this._navigable!==e&&(this._navigable=e,this._observer.navigable$.next(e))}_subscribeCoverComponent(){this._configurationSubscription=this._coverComponent.configuration$.pipe(yi(void 0,e=>e.state)).subscribe(e=>{e.state===ia.Loading?this._navigator.stateService.currentId$.pipe(wi(),ei(t=>{const i=t==null||t!==e.id;return i&&this._setNavigable(!1),i?this._navigator.moveTo$(e.id):this._navigator.stateService.currentImage$.pipe(wi())})).subscribe(()=>{this._navigator.stateService.start(),this._navigator.cacheService.start(),this._navigator.panService.start(),this._observer.startEmit(),this._coverComponent.configure({state:ia.Hidden}),this._componentService.deactivateCover(),this._setNavigable(!0)},t=>{console.error("Failed to deactivate cover.",t),this._coverComponent.configure({state:ia.Visible})}):e.state===ia.Visible&&(this._observer.stopEmit(),this._navigator.stateService.stop(),this._navigator.cacheService.stop(),this._navigator.playService.stop(),this._navigator.panService.stop(),this._componentService.activateCover(),this._setNavigable(e.id==null))})}_uFalse(e,t){if(e===void 0){this._componentService.deactivate(t);return}if(typeof e=="boolean"){e?this._componentService.activate(t):this._componentService.deactivate(t);return}this._componentService.configure(t,e),this._componentService.activate(t)}_uTrue(e,t){if(e===void 0){this._componentService.activate(t);return}if(typeof e=="boolean"){e?this._componentService.activate(t):this._componentService.deactivate(t);return}this._componentService.configure(t,e),this._componentService.activate(t)}}class aae{constructor(e,t,i){this._adaptiveOperation$=new ri,this._render$=new ri,this._renderAdaptive$=new ri,this._subscriptions=new wo,this._renderService=t,this._currentFrame$=i;const r=this._subscriptions,o=qt.create(qt.h("div.mapillary-dom-renderer",[]));e.appendChild(o),this._offset$=this._adaptiveOperation$.pipe(Vr((d,p)=>p(d),{elementHeight:e.offsetHeight,elementWidth:e.offsetWidth,imageAspect:0,renderMode:t_.Fill}),ai(d=>d.imageAspect>0&&d.elementWidth>0&&d.elementHeight>0),st(d=>{const p=d.elementWidth/d.elementHeight,g=d.imageAspect/p;let _=0,x=0;return d.renderMode===t_.Letterbox?d.imageAspect>p?_=d.elementHeight*(1-1/g)/2:x=d.elementWidth*(1-g)/2:d.imageAspect>p?x=-d.elementWidth*(g-1)/2:_=-d.elementHeight*(1/g-1)/2,{bottom:_,left:x,right:x,top:_}}));const c=this._currentFrame$.pipe(ai(d=>d.state.currentImage!=null),yi((d,p)=>d===p,d=>d.state.currentImage.id),st(d=>d.state.currentTransform.basicAspect),st(d=>p=>(p.imageAspect=d,p))).subscribe(this._adaptiveOperation$),s=Si(this._renderAdaptive$.pipe(Vr((d,p)=>(p.vNode==null?delete d[p.name]:d[p.name]=p.vNode,d),{})),this._offset$).pipe(st(d=>{const p=[],g=d[0];for(const b in g)g.hasOwnProperty(b)&&p.push(g[b]);const _=d[1],x={style:{bottom:_.bottom+"px",left:_.left+"px","pointer-events":"none",position:"absolute",right:_.right+"px",top:_.top+"px"}};return{name:"mapillary-dom-adaptive-renderer",vNode:qt.h("div.mapillary-dom-adaptive-renderer",x,p)}})).subscribe(this._render$);this._vNode$=this._render$.pipe(Vr((d,p)=>(p.vNode==null?delete d[p.name]:d[p.name]=p.vNode,d),{}),st(d=>{const p=[];for(const g in d)d.hasOwnProperty(g)&&p.push(d[g]);return qt.h("div.mapillary-dom-renderer",p)})),this._vPatch$=this._vNode$.pipe(Vr((d,p)=>(d.vpatch=qt.diff(d.vNode,p),d.vNode=p,d),{vNode:qt.h("div.mapillary-dom-renderer",[]),vpatch:null}),WW("vpatch")),this._element$=this._vPatch$.pipe(Vr((d,p)=>qt.patch(d,p),o),Ii(1),_i()),r.push(c),r.push(s),r.push(this._element$.subscribe(()=>{})),r.push(this._renderService.size$.pipe(st(d=>p=>(p.elementWidth=d.width,p.elementHeight=d.height,p))).subscribe(this._adaptiveOperation$)),r.push(this._renderService.renderMode$.pipe(st(d=>p=>(p.renderMode=d,p))).subscribe(this._adaptiveOperation$))}get element$(){return this._element$}get render$(){return this._render$}get renderAdaptive$(){return this._renderAdaptive$}clear(e){this._renderAdaptive$.next({name:e,vNode:null}),this._render$.next({name:e,vNode:null})}remove(){this._subscriptions.unsubscribe()}}class lae{constructor(e,t,i){this._renderFrame$=new ri,this._renderCameraOperation$=new ri,this._render$=new ri,this._clear$=new ri,this._renderOperation$=new ri,this._rendererOperation$=new ri,this._eraserOperation$=new ri,this._triggerOperation$=new ri,this._subscriptions=new wo,this._opaqueRender$=new ri,this._renderService=i;const r=this._subscriptions;this._renderer$=this._rendererOperation$.pipe(Vr((S,P)=>P(S),{needsRender:!1,renderer:null}),ai(S=>!!S.renderer)),this._renderCollection$=this._renderOperation$.pipe(Vr((S,P)=>P(S),{}),pn()),this._renderCamera$=this._renderCameraOperation$.pipe(Vr((S,P)=>P(S),{frameId:-1,needsRender:!1,perspective:null})),this._eraser$=this._eraserOperation$.pipe(An(S=>S),Vr((S,P)=>P(S),{needsRender:!1}));const o=this._triggerOperation$.pipe(An(S=>S),Vr((S,P)=>P(S),{needsRender:!1})),c=new $i(986895),s=Si(this._renderer$,this._renderCollection$,this._renderCamera$,this._eraser$,o).pipe(st(([S,P,L,E,C])=>{const D=Object.keys(P).map(O=>P[O]);return{camera:L,eraser:E,trigger:C,renderer:S,renders:D}}),ai(S=>{let P=S.renderer.needsRender||S.camera.needsRender||S.eraser.needsRender||S.trigger.needsRender;const L=S.camera.frameId;for(const E of S.renders){if(E.frameId!==L)return!1;P=P||E.needsRender}return P}),yi((S,P)=>S===P,S=>S.eraser.needsRender||S.trigger.needsRender?-S.camera.frameId:S.camera.frameId)).subscribe(S=>{S.renderer.needsRender=!1,S.camera.needsRender=!1,S.eraser.needsRender=!1,S.trigger.needsRender=!1;const P=S.camera.perspective,L=[],E=[];for(const D of S.renders)D.pass===Rh.Background?L.push(D.render):D.pass===Rh.Opaque&&E.push(D.render);const C=S.renderer.renderer;C.resetState(),C.setClearColor(c,1),C.clear();for(const D of L)D(P,C);C.clearDepth();for(const D of E)D(P,C);C.resetState(),this._opaqueRender$.next()});r.push(s),r.push(this._renderFrame$.pipe(st(S=>P=>(P.frameId=S.frameId,P.perspective=S.perspective,S.changed===!0&&(P.needsRender=!0),P))).subscribe(this._renderCameraOperation$)),this._renderFrameSubscribe();const d=this._render$.pipe(st(S=>P=>(P[S.name]=S.renderer,P))),p=this._clear$.pipe(st(S=>P=>(delete P[S],P)));r.push(mn(d,p).subscribe(this._renderOperation$)),this._webGLRenderer$=this._render$.pipe(wi(),st(()=>{t.appendChild(e);const S=i.element,P=new dr({canvas:e});return P.setPixelRatio(window.devicePixelRatio),P.setSize(S.offsetWidth,S.offsetHeight),P.autoClear=!1,P}),Ii(1),_i()),r.push(this._webGLRenderer$.subscribe(()=>{}));const g=this._webGLRenderer$.pipe(wi(),st(S=>P=>(P.needsRender=!0,P.renderer=S,P))),_=this._renderService.size$.pipe(st(S=>P=>(P.renderer==null||(P.renderer.setSize(S.width,S.height),P.needsRender=!0),P))),x=this._clear$.pipe(st(()=>S=>(S.renderer==null||(S.needsRender=!0),S)));r.push(mn(g,_,x).subscribe(this._rendererOperation$));const b=this._renderCollection$.pipe(ai(S=>Object.keys(S).length===0),pn());r.push(b.subscribe(()=>{this._renderFrameSubscription!=null&&(this._renderFrameSubscription.unsubscribe(),this._renderFrameSubscription=null,this._renderFrameSubscribe())})),r.push(b.pipe(st(()=>S=>(S.needsRender=!0,S))).subscribe(this._eraserOperation$))}get render$(){return this._render$}get opaqueRender$(){return this._opaqueRender$}get webGLRenderer$(){return this._webGLRenderer$}clear(e){this._clear$.next(e)}remove(){this._rendererOperation$.next(e=>{if(e.renderer!=null){const t=e.renderer.getContext().getExtension("WEBGL_lose_context");t&&t.loseContext(),e.renderer=null}return e}),this._renderFrameSubscription!=null&&this._renderFrameSubscription.unsubscribe(),this._subscriptions.unsubscribe()}triggerRerender(){this._renderService.renderCameraFrame$.pipe(Ks(1),wi()).subscribe(()=>{this._triggerOperation$.next(e=>(e.needsRender=!0,e))})}_renderFrameSubscribe(){this._render$.pipe(wi(),st(()=>e=>(e.needsRender=!0,e))).subscribe(e=>{this._renderCameraOperation$.next(e)}),this._renderFrameSubscription=this._render$.pipe(wi(),Hi(()=>this._renderService.renderCameraFrame$)).subscribe(this._renderFrame$)}}class Ed{constructor(e){e!=null?(this._position=new Ge().fromArray(e.unprojectSfM([0,0],0)),this._lookat=new Ge().fromArray(e.unprojectSfM([0,0],10)),this._up=e.upVector(),this._focal=this._getFocal(e)):(this._position=new Ge(0,0,0),this._lookat=new Ge(1,0,0),this._up=new Ge(0,0,1),this._focal=1)}get position(){return this._position}get lookat(){return this._lookat}get up(){return this._up}get focal(){return this._focal}set focal(e){this._focal=e}lerpCameras(e,t,i){this._position.subVectors(t.position,e.position).multiplyScalar(i).add(e.position),this._lookat.subVectors(t.lookat,e.lookat).multiplyScalar(i).add(e.lookat),this._up.subVectors(t.up,e.up).multiplyScalar(i).add(e.up),this._focal=(1-i)*e.focal+i*t.focal}copy(e){this._position.copy(e.position),this._lookat.copy(e.lookat),this._up.copy(e.up),this._focal=e.focal}clone(){let e=new Ed;return e.position.copy(this._position),e.lookat.copy(this._lookat),e.up.copy(this._up),e.focal=this._focal,e}diff(e){let t=this._position.distanceToSquared(e.position),i=this._lookat.distanceToSquared(e.lookat),r=this._up.distanceToSquared(e.up),o=100*Math.abs(this._focal-e.focal);return Math.max(t,i,r,o)}_getFocal(e){return Di(e.cameraType)?.5/Math.tan(Math.PI/2):e.focal}}class cae{constructor(e,t,i){this._spatial=new xo,this._viewportCoords=new $o,this._size={width:e,height:t},this._initialFov=60,this._alpha=-1,this._stateTransitionAlpha=-1,this._stateTransitionFov=-1,this._renderMode=i,this._zoom=0,this._frameId=-1,this._changed=!1,this._changedForFrame=-1,this._currentImageId=null,this._previousImageId=null,this._currentSpherical=!1,this._previousSpherical=!1,this._state=null,this._currentProjectedPoints=[],this._previousProjectedPoints=[],this._currentFov=this._initialFov,this._previousFov=this._initialFov,this._camera=new Ed,this._perspective=new na(this._initialFov,this._computeAspect(e,t),.1,1e4),this._perspective.position.copy(this._camera.position),this._perspective.up.copy(this._camera.up),this._perspective.lookAt(this._camera.lookat),this._perspective.updateMatrixWorld(!0),this._perspective.matrixAutoUpdate=!1,this._rotation={phi:0,theta:0}}get alpha(){return this._alpha}get camera(){return this._camera}get changed(){return this._frameId===this._changedForFrame}get frameId(){return this._frameId}get perspective(){return this._perspective}get renderMode(){return this._renderMode}get rotation(){return this._rotation}get zoom(){return this._zoom}get size(){return this._size}getTilt(){return 90-this._spatial.radToDeg(this._rotation.theta)}fovToZoom(e){e=Math.min(90,Math.max(0,e));const t=this._computeCurrentFov(0),i=this._alpha===1?t:this._interpolateFov(t,this._computePreviousFov(0),this._alpha),r=Math.tan(i/2*Math.PI/180),o=Math.tan(e/2*Math.PI/180);return Math.log(r/o)/Math.log(2)}setFrame(e){const t=e.state;if(t.state!==this._state){if(this._state=t.state,this._state!==Bi.Custom&&(this.setRenderMode(this._renderMode),this.setSize(this._size)),this._state===Bi.Earth){const p=this._fovToY(this._perspective.fov,this._zoom);this._stateTransitionFov=this._yToFov(p,0)}this._changed=!0}const i=t.currentImage.id,r=t.previousImage?t.previousImage.id:null;i!==this._currentImageId&&(this._currentImageId=i,this._currentSpherical=Di(t.currentTransform.cameraType),this._currentProjectedPoints=this._computeProjectedPoints(t.currentTransform),this._changed=!0),r!==this._previousImageId&&(this._previousImageId=r,this._previousSpherical=Di(t.previousTransform.cameraType),this._previousProjectedPoints=this._computeProjectedPoints(t.previousTransform),this._changed=!0);const o=t.zoom;o!==this._zoom&&(this._changed=!0),this._changed&&(this._currentFov=this._computeCurrentFov(o),this._previousFov=this._computePreviousFov(o));const c=t.alpha,s=t.stateTransitionAlpha;if(this._changed||c!==this._alpha||s!==this._stateTransitionAlpha){switch(this._alpha=c,this._stateTransitionAlpha=s,this._state){case Bi.Earth:{const p=this._stateTransitionFov,g=this._focalToFov(t.camera.focal),_=Zg.lerp(p,g,s),x=this._fovToY(_,0);this._perspective.fov=this._yToFov(x,o);break}case Bi.Custom:break;default:this._perspective.fov=this._interpolateFov(this._currentFov,this._previousFov,this._alpha),this._changed=!0;break}this._zoom=o,this._state!==Bi.Custom&&this._perspective.updateProjectionMatrix()}const d=t.camera;this._camera.diff(d)>1e-9&&(this._camera.copy(d),this._rotation=this._computeRotation(d),this._perspective.up.copy(d.up),this._perspective.position.copy(d.position),this._perspective.matrixAutoUpdate=!0,this._perspective.lookAt(d.lookat),this._perspective.matrixAutoUpdate=!1,this._perspective.updateMatrix(),this._perspective.updateMatrixWorld(!1),this._changed=!0),this._setFrameId(e.id)}setProjectionMatrix(e){this._perspective.fov=this._focalToFov(e[5]/2),this._perspective.projectionMatrix.fromArray(e),this._perspective.projectionMatrixInverse.copy(this._perspective.projectionMatrix).invert(),this._changed=!0}setRenderMode(e){this._renderMode=e,this._state!==Bi.Custom&&(this._perspective.fov=this._computeFov(),this._perspective.updateProjectionMatrix(),this._changed=!0)}setSize(e){this._size=e,this._state!==Bi.Custom&&(this._perspective.aspect=this._computeAspect(e.width,e.height),this._perspective.fov=this._computeFov(),this._perspective.updateProjectionMatrix(),this._changed=!0)}_computeAspect(e,t){return e===0?0:e/t}_computeCurrentFov(e){return this._perspective.aspect===0?0:this._currentImageId?this._currentSpherical?this._yToFov(1,e):this._computeVerticalFov(this._currentProjectedPoints,this._renderMode,e,this.perspective.aspect):this._initialFov}_computeFov(){return this._currentFov=this._computeCurrentFov(this._zoom),this._previousFov=this._computePreviousFov(this._zoom),this._interpolateFov(this._currentFov,this._previousFov,this._alpha)}_computePreviousFov(e){return this._perspective.aspect===0?0:this._currentImageId?this._previousImageId?this._previousSpherical?this._yToFov(1,e):this._computeVerticalFov(this._previousProjectedPoints,this._renderMode,e,this.perspective.aspect):this._currentFov:this._initialFov}_computeProjectedPoints(e){return tE(e,[[.5,0],[1,0]],[[.5,0],[0,.5]],100,this._viewportCoords)}_computeRequiredVerticalFov(e,t,i){const r=Math.max(e[0]/i,e[1]);return this._yToFov(r,t)}_computeRotation(e){let t=e.lookat.clone().sub(e.position),i=e.up.clone(),r=this._spatial.azimuthal(t.toArray(),i.toArray()),o=Math.PI/2-this._spatial.angleToPlane(t.toArray(),[0,0,1]);return{phi:r,theta:o}}_computeVerticalFov(e,t,i,r){const o=e.map(s=>this._computeRequiredVerticalFov(s,i,r));return t===t_.Fill?Math.min(...o)*.995:Math.max(...o)}_yToFov(e,t){return 2*Math.atan(e/Math.pow(2,t))*180/Math.PI}_focalToFov(e){return 2*Math.atan2(1,2*e)*180/Math.PI}_fovToY(e,t){return Math.pow(2,t)*Math.tan(Math.PI*e/360)}_interpolateFov(e,t,i){return i*e+(1-i)*t}_setFrameId(e){this._frameId=e,this._changed&&(this._changed=!1,this._changedForFrame=e)}}class uae{constructor(e,t,i,r){this._subscriptions=new wo,this._element=e,this._currentFrame$=t,this._spatial=new xo,i=i??t_.Fill,this._resize$=new ri,this._projectionMatrix$=new ri,this._renderCameraOperation$=new ri,this._size$=new Ph({height:this._element.offsetHeight,width:this._element.offsetWidth});const o=this._subscriptions;o.push(this._resize$.pipe(st(()=>({height:this._element.offsetHeight,width:this._element.offsetWidth}))).subscribe(this._size$)),this._renderMode$=new Ph(i),this._renderCameraHolder$=this._renderCameraOperation$.pipe(An(c=>c),Vr((c,s)=>s(c),r??new cae(this._element.offsetWidth,this._element.offsetHeight,i)),Ii(1),_i()),this._renderCameraFrame$=this._currentFrame$.pipe(Ui(this._renderCameraHolder$),Dr(([c,s])=>{s.setFrame(c)}),st(c=>c[1]),Ii(1),_i()),this._renderCamera$=this._renderCameraFrame$.pipe(ai(c=>c.changed),Ii(1),_i()),this._bearing$=this._renderCamera$.pipe(st(c=>{let s=this._spatial.radToDeg(this._spatial.azimuthalToBearing(c.rotation.phi));return this._spatial.wrap(s,0,360)}),Ii(1),_i()),o.push(this._size$.pipe(Ks(1),st(c=>s=>(s.setSize(c),s))).subscribe(this._renderCameraOperation$)),o.push(this._renderMode$.pipe(Ks(1),st(c=>s=>(s.setRenderMode(c),s))).subscribe(this._renderCameraOperation$)),o.push(this._projectionMatrix$.pipe(st(c=>s=>(s.setProjectionMatrix(c),s))).subscribe(this._renderCameraOperation$)),o.push(this._bearing$.subscribe(()=>{})),o.push(this._renderCameraHolder$.subscribe(()=>{})),o.push(this._size$.subscribe(()=>{})),o.push(this._renderMode$.subscribe(()=>{})),o.push(this._renderCamera$.subscribe(()=>{})),o.push(this._renderCameraFrame$.subscribe(()=>{}))}get bearing$(){return this._bearing$}get element(){return this._element}get projectionMatrix$(){return this._projectionMatrix$}get renderCamera$(){return this._renderCamera$}get renderCameraFrame$(){return this._renderCameraFrame$}get renderMode$(){return this._renderMode$}get resize$(){return this._resize$}get size$(){return this._size$}dispose(){this._subscriptions.unsubscribe()}}class hae{constructor(e){this._keyDown$=Mr(e,"keydown"),this._keyUp$=Mr(e,"keyup")}get keyDown$(){return this._keyDown$}get keyUp$(){return this._keyUp$}}const gg=0,ty=2,dae={[gg]:1,[ty]:2};class fae{constructor(e,t,i,r){this._subscriptions=new wo;const o=this._subscriptions;this._activeSubject$=new Ph(!1),this._active$=this._activeSubject$.pipe(yi(),Ii(1),_i()),this._claimMouse$=new ri,this._claimWheel$=new ri,this._deferPixelClaims$=new ri,this._deferPixels$=this._deferPixelClaims$.pipe(Vr((_,x)=>(x.deferPixels==null?delete _[x.name]:_[x.name]=x.deferPixels,_),{}),st(_=>{let x=-1;for(const b in _){if(!_.hasOwnProperty(b))continue;const S=_[b];S>x&&(x=S)}return x}),An(-1),Ii(1),_i()),o.push(this._deferPixels$.subscribe(()=>{})),this._documentMouseMove$=Mr(r,"pointermove").pipe(ai(this._isMousePen)),this._documentMouseUp$=Mr(r,"pointerup").pipe(ai(this._isMousePen)),this._mouseDown$=Mr(t,"pointerdown").pipe(ai(this._isMousePen)),this._mouseEnter$=Mr(t,"pointerenter").pipe(ai(this._isMousePen)),this._mouseLeave$=Mr(t,"pointerleave").pipe(ai(this._isMousePen)),this._mouseMove$=Mr(t,"pointermove").pipe(ai(this._isMousePen)),this._mouseUp$=Mr(t,"pointerup").pipe(ai(this._isMousePen)),this._mouseOut$=Mr(t,"pointerout").pipe(ai(this._isMousePen)),this._mouseOver$=Mr(t,"pointerover").pipe(ai(this._isMousePen)),this._domMouseDown$=Mr(i,"pointerdown").pipe(ai(this._isMousePen)),this._domMouseMove$=Mr(i,"pointermove").pipe(ai(this._isMousePen)),this._click$=Mr(t,"click"),this._contextMenu$=Mr(t,"contextmenu"),this._windowBlur$=Mr(window,"blur"),this._dblClick$=mn(Mr(e,"click"),Mr(t,"dblclick")).pipe(Tw(3,1),ai(_=>{const x=_[0],b=_[1],S=_[2];return x.type==="click"&&b.type==="click"&&S.type==="dblclick"&&x.target.parentNode===t&&b.target.parentNode===t}),st(_=>_[2]),pn()),o.push(mn(this._domMouseDown$,this._domMouseMove$,this._dblClick$,this._contextMenu$).subscribe(_=>{_.preventDefault()})),this._mouseWheel$=mn(Mr(t,"wheel"),Mr(i,"wheel")).pipe(pn()),this._consistentContextMenu$=mn(this._mouseDown$,this._mouseMove$,this._mouseOut$,this._mouseUp$,this._contextMenu$).pipe(Tw(3,1),ai(_=>_[0].type==="pointerdown"&&_[1].type==="contextmenu"&&_[2].type==="pointerup"),st(_=>_[1]),pn());const c=mn(this._windowBlur$,this._documentMouseMove$.pipe(ai(_=>this._buttonReleased(_,gg))),this._documentMouseUp$.pipe(ai(_=>this._mouseButton(_)===gg))).pipe(pn()),s=this._createMouseDragInitiate$(gg,this._mouseDown$,c,!0).pipe(pn());this._mouseDragStart$=this._createMouseDragStart$(s).pipe(pn()),this._mouseDrag$=this._createMouseDrag$(s,c).pipe(pn()),this._mouseDragEnd$=this._createMouseDragEnd$(this._mouseDragStart$,c).pipe(pn());const d=this._createMouseDragInitiate$(gg,this._domMouseDown$,c,!1).pipe(pn());this._domMouseDragStart$=this._createMouseDragStart$(d).pipe(pn()),this._domMouseDrag$=this._createMouseDrag$(d,c).pipe(pn()),this._domMouseDragEnd$=this._createMouseDragEnd$(this._domMouseDragStart$,c).pipe(pn());const p=mn(this._windowBlur$,this._documentMouseMove$.pipe(ai(_=>this._buttonReleased(_,ty))),this._documentMouseUp$.pipe(ai(_=>this._mouseButton(_)===ty))).pipe(pn()),g=this._createMouseDragInitiate$(ty,this._mouseDown$,p,!0).pipe(pn());this._mouseRightDragStart$=this._createMouseDragStart$(g).pipe(pn()),this._mouseRightDrag$=this._createMouseDrag$(g,p).pipe(pn()),this._mouseRightDragEnd$=this._createMouseDragEnd$(this._mouseRightDragStart$,p).pipe(pn()),this._proximateClick$=this._mouseDown$.pipe(ei(_=>this._click$.pipe(Cd(this._createDeferredMouseMove$(_,this._documentMouseMove$)),Vl(1))),pn()),this._staticClick$=this._mouseDown$.pipe(ei(()=>this._click$.pipe(Cd(this._documentMouseMove$),Vl(1))),pn()),o.push(this._mouseDragStart$.subscribe()),o.push(this._mouseDrag$.subscribe()),o.push(this._mouseDragEnd$.subscribe()),o.push(this._domMouseDragStart$.subscribe()),o.push(this._domMouseDrag$.subscribe()),o.push(this._domMouseDragEnd$.subscribe()),o.push(this._mouseRightDragStart$.subscribe()),o.push(this._mouseRightDrag$.subscribe()),o.push(this._mouseRightDragEnd$.subscribe()),o.push(this._staticClick$.subscribe()),this._mouseOwner$=this._createOwner$(this._claimMouse$).pipe(Ii(1),_i()),this._wheelOwner$=this._createOwner$(this._claimWheel$).pipe(Ii(1),_i()),o.push(this._mouseOwner$.subscribe(()=>{})),o.push(this._wheelOwner$.subscribe(()=>{}))}get active$(){return this._active$}get activate$(){return this._activeSubject$}get documentMouseMove$(){return this._documentMouseMove$}get documentMouseUp$(){return this._documentMouseUp$}get domMouseDragStart$(){return this._domMouseDragStart$}get domMouseDrag$(){return this._domMouseDrag$}get domMouseDragEnd$(){return this._domMouseDragEnd$}get domMouseDown$(){return this._domMouseDown$}get domMouseMove$(){return this._domMouseMove$}get mouseOwner$(){return this._mouseOwner$}get mouseDown$(){return this._mouseDown$}get mouseEnter$(){return this._mouseEnter$}get mouseMove$(){return this._mouseMove$}get mouseLeave$(){return this._mouseLeave$}get mouseOut$(){return this._mouseOut$}get mouseOver$(){return this._mouseOver$}get mouseUp$(){return this._mouseUp$}get click$(){return this._click$}get dblClick$(){return this._dblClick$}get contextMenu$(){return this._consistentContextMenu$}get mouseWheel$(){return this._mouseWheel$}get mouseDragStart$(){return this._mouseDragStart$}get mouseDrag$(){return this._mouseDrag$}get mouseDragEnd$(){return this._mouseDragEnd$}get mouseRightDragStart$(){return this._mouseRightDragStart$}get mouseRightDrag$(){return this._mouseRightDrag$}get mouseRightDragEnd$(){return this._mouseRightDragEnd$}get proximateClick$(){return this._proximateClick$}get staticClick$(){return this._staticClick$}get windowBlur$(){return this._windowBlur$}dispose(){this._subscriptions.unsubscribe()}claimMouse(e,t){this._claimMouse$.next({name:e,zindex:t})}unclaimMouse(e){this._claimMouse$.next({name:e,zindex:null})}deferPixels(e,t){this._deferPixelClaims$.next({name:e,deferPixels:t})}undeferPixels(e){this._deferPixelClaims$.next({name:e,deferPixels:null})}claimWheel(e,t){this._claimWheel$.next({name:e,zindex:t})}unclaimWheel(e){this._claimWheel$.next({name:e,zindex:null})}filtered$(e,t){return this._filtered(e,t,this._mouseOwner$)}filteredWheel$(e,t){return this._filtered(e,t,this._wheelOwner$)}_createDeferredMouseMove$(e,t){return t.pipe(st(i=>{const r=i.clientX-e.clientX,o=i.clientY-e.clientY;return[i,Math.sqrt(r*r+o*o)]}),Ui(this._deferPixels$),ai(([[,i],r])=>i>r),st(([[i]])=>i))}_createMouseDrag$(e,t){return e.pipe(st(([,i])=>i),ei(i=>jl(Pi(i),this._documentMouseMove$).pipe(Cd(t))))}_createMouseDragEnd$(e,t){return e.pipe(ei(()=>t.pipe(wi())))}_createMouseDragStart$(e){return e.pipe(st(([t])=>t))}_createMouseDragInitiate$(e,t,i,r){return t.pipe(ai(o=>this._mouseButton(o)===e),ei(o=>Si(Pi(o),r?this._createDeferredMouseMove$(o,this._documentMouseMove$):this._documentMouseMove$).pipe(Cd(i),Vl(1))))}_createOwner$(e){return e.pipe(Vr((t,i)=>(i.zindex==null?delete t[i.name]:t[i.name]=i.zindex,t),{}),st(t=>{let i=null,r=-1;for(const o in t)t.hasOwnProperty(o)&&t[o]>r&&(r=t[o],i=o);return i}),An(null))}_filtered(e,t,i){return t.pipe(Ui(i),ai(([,r])=>r===e),st(([r])=>r))}_mouseButton(e){const t=e.type==="pointerdown"||e.type==="pointerup",i=window.InstallTrigger;return t&&typeof i<"u"&&e.button===ty&&e.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?gg:e.button}_buttonReleased(e,t){const i=dae[t];return e.buttons===void 0||(e.buttons&i)!==i}_isMousePen(e){const t=e.pointerType;return t==="mouse"||t==="pen"}}class pae{set json(e){this._json=e}set image(e){this._image=e,this._texture=new Bs(this._image),this._texture.minFilter=Hs}get loaded(){return!!(this._image&&this._json)}getGLSprite(e){if(!this.loaded)throw new Error("Sprites cannot be retrieved before the atlas is loaded.");let t=this._json[e];if(!t)return console.warn("Sprite with key"+e+"does not exist in sprite definition."),new Ln;let i=this._texture.clone();i.needsUpdate=!0;let r=this._image.width,o=this._image.height;i.offset.x=t.x/r,i.offset.y=(o-t.y-t.height)/o,i.repeat.x=t.width/r,i.repeat.y=t.height/o;let c=new UC({map:i});return new Az(c)}getDOMSprite(e,t){if(!this.loaded)throw new Error("Sprites cannot be retrieved before the atlas is loaded.");t==null&&(t=as.Center);let i=this._json[e];if(!i)return console.warn("Sprite with key"+e+"does not exist in sprite definition."),qt.h("div",{},[]);let r=i.y,o=i.x+i.width,c=i.y+i.height,s=i.x,d=-i.x,p=-i.y,g=this._image.height,_=this._image.width;switch(t){case as.Bottom:case as.Center:case as.Top:d-=i.width/2;break;case as.BottomLeft:case as.Left:case as.TopLeft:d-=i.width;break;case as.BottomRight:case as.Right:case as.TopRight:}switch(t){case as.Center:case as.Left:case as.Right:p-=i.height/2;break;case as.Top:case as.TopLeft:case as.TopRight:p-=i.height;break;case as.Bottom:case as.BottomLeft:case as.BottomRight:}let x=1/i.pixelRatio;r*=x,o*=x,c*=x,s*=x,d*=x,p*=x,g*=x,_*=x;let b={src:this._image.src,style:{clip:`rect(${r}px, ${o}px, ${c}px, ${s}px)`,height:`${g}px`,left:`${d}px`,position:"absolute",top:`${p}px`,width:`${_}px`}};return qt.h("img",b,[])}}class mae{constructor(e){if(this._retina=window.devicePixelRatio>1,this._spriteAtlasOperation$=new ri,this._spriteAtlas$=this._spriteAtlasOperation$.pipe(An(o=>o),Vr((o,c)=>c(o),new pae),Ii(1),_i()),this._atlasSubscription=this._spriteAtlas$.subscribe(()=>{}),e==null)return;let t=this._retina?"@2x":"",i=new XMLHttpRequest;i.open("GET",e+t+".png",!0),i.responseType="arraybuffer",i.onload=()=>{let o=new Image;o.onload=()=>{this._spriteAtlasOperation$.next(s=>(s.image=o,s))};let c=new Blob([i.response]);o.src=window.URL.createObjectURL(c)},i.onerror=o=>{console.error(new Error(`Failed to fetch sprite sheet (${e}${t}.png)`))},i.send();let r=new XMLHttpRequest;r.open("GET",e+t+".json",!0),r.responseType="text",r.onload=()=>{let o=JSON.parse(r.response);this._spriteAtlasOperation$.next(c=>(c.json=o,c))},r.onerror=o=>{console.error(new Error(`Failed to fetch sheet (${e}${t}.json)`))},r.send()}get spriteAtlas$(){return this._spriteAtlas$}dispose(){this._atlasSubscription.unsubscribe()}}class gae{constructor(e,t){this._subscriptions=new wo;const i=this._subscriptions;this._activeSubject$=new Ph(!1),this._active$=this._activeSubject$.pipe(yi(),Ii(1),_i()),i.push(Mr(t,"touchmove").subscribe(g=>{g.preventDefault()})),this._touchStart$=Mr(e,"touchstart"),this._touchMove$=Mr(e,"touchmove"),this._touchEnd$=Mr(e,"touchend"),this._touchCancel$=Mr(e,"touchcancel");const r=this._touchStart$.pipe(ai(g=>g.touches.length===1&&g.targetTouches.length===1),pn());this._doubleTap$=r.pipe(VW(()=>r.pipe(wi(),ei(()=>mn(LC(300),r).pipe(Vl(1))))),ai(g=>g.length===2),st(g=>g[g.length-1]),pn()),i.push(this._doubleTap$.subscribe(g=>{g.preventDefault()})),this._singleTouchMove$=this._touchMove$.pipe(ai(g=>g.touches.length===1&&g.targetTouches.length===1),pn());let o=mn(this._touchStart$,this._touchEnd$,this._touchCancel$).pipe(ai(g=>g.touches.length===1&&g.targetTouches.length===1)),c=mn(this._touchStart$,this._touchEnd$,this._touchCancel$).pipe(ai(g=>g.touches.length>=1)),s=mn(this._touchEnd$,this._touchCancel$).pipe(ai(g=>g.touches.length===0));this._singleTouchDragStart$=o.pipe(Hi(()=>this._singleTouchMove$.pipe(Cd(mn(s,c)),Vl(1)))),this._singleTouchDragEnd$=o.pipe(Hi(()=>mn(s,c).pipe(wi()))),this._singleTouchDrag$=o.pipe(ei(()=>this._singleTouchMove$.pipe(Ks(1),Cd(mn(c,s)))));let d=mn(this._touchStart$,this._touchEnd$,this._touchCancel$);this._pinchStart$=d.pipe(ai(g=>g.touches.length===2&&g.targetTouches.length===2)),this._pinchEnd$=d.pipe(ai(g=>g.touches.length!==2||g.targetTouches.length!==2)),this._pinchOperation$=new ri,this._pinch$=this._pinchOperation$.pipe(Vr((g,_)=>_(g),{changeX:0,changeY:0,clientX:0,clientY:0,distance:0,distanceChange:0,distanceX:0,distanceY:0,originalEvent:null,pageX:0,pageY:0,screenX:0,screenY:0,touch1:null,touch2:null}));const p=this._touchMove$.pipe(ai(g=>g.touches.length===2&&g.targetTouches.length===2),st(g=>_=>{let x=g.touches[0],b=g.touches[1],S=Math.min(x.clientX,b.clientX),P=Math.max(x.clientX,b.clientX),L=Math.min(x.clientY,b.clientY),E=Math.max(x.clientY,b.clientY),C=S+(P-S)/2,D=L+(E-L)/2,O=C+x.pageX-x.clientX,U=D+x.pageY-x.clientY,j=C+x.screenX-x.clientX,G=D+x.screenY-x.clientY,N=Math.abs(x.clientX-b.clientX),V=Math.abs(x.clientY-b.clientY),q=Math.sqrt(N*N+V*V),z=q-_.distance,Q=N-_.distanceX,X=V-_.distanceY;return{changeX:Q,changeY:X,clientX:C,clientY:D,distance:q,distanceChange:z,distanceX:N,distanceY:V,originalEvent:g,pageX:O,pageY:U,screenX:j,screenY:G,touch1:x,touch2:b}})).subscribe(this._pinchOperation$);i.push(p),this._pinchChange$=this._pinchStart$.pipe(ei(()=>this._pinch$.pipe(Ks(1),Cd(this._pinchEnd$))))}get active$(){return this._active$}get activate$(){return this._activeSubject$}get doubleTap$(){return this._doubleTap$}get touchStart$(){return this._touchStart$}get touchMove$(){return this._touchMove$}get touchEnd$(){return this._touchEnd$}get touchCancel$(){return this._touchCancel$}get singleTouchDragStart$(){return this._singleTouchDragStart$}get singleTouchDrag$(){return this._singleTouchDrag$}get singleTouchDragEnd$(){return this._singleTouchDragEnd$}get pinch$(){return this._pinchChange$}get pinchStart$(){return this._pinchStart$}get pinchEnd$(){return this._pinchEnd$}dispose(){this._subscriptions.unsubscribe()}}class _ae{constructor(e){var t,i,r,o;const c=(i=(t=e?.url)===null||t===void 0?void 0:t.exploreHost)!==null&&i!==void 0?i:"www.mapillary.com",d=`${(o=(r=e?.url)===null||r===void 0?void 0:r.scheme)!==null&&o!==void 0?o:"https"}://${c}`;this._exploreUrl$=Pi(d);const p=e?.imageTiling!==!1;this._imageTiling$=Pi(p)}get exploreUrl$(){return this._exploreUrl$}get imageTiling$(){return this._imageTiling$}}class vae{constructor(e,t,i){var r;if(this._onWindowResize=()=>{this._trackResize&&this.renderService.resize$.next()},this._dom=i??new hE,typeof e.container=="string"){if(this._container=this._dom.document.getElementById(e.container),!this._container)throw new Error(`Container "${e.container}" not found.`)}else if(e.container instanceof HTMLElement)this._container=e.container;else throw new Error('Invalid type: "container" must be a String or HTMLElement.');this._trackResize=e.trackResize!==!1,this.id=(r=this._container.id)!==null&&r!==void 0?r:"mapillary-fallback-container-id",this._container.classList.add("mapillary-viewer"),this._canvasContainer=this._dom.createElement("div","mapillary-interactive",this._container),this._canvas=this._dom.createElement("canvas","mapillary-canvas"),this._canvas.style.position="absolute",this._canvas.setAttribute("tabindex","0"),this._domContainer=this._dom.createElement("div","mapillary-dom",this._container),this.configurationService=new _ae(e),this.renderService=new uae(this._container,t.currentState$,e.renderMode),this.glRenderer=new lae(this._canvas,this._canvasContainer,this.renderService),this.domRenderer=new aae(this._domContainer,this.renderService,t.currentState$),this.keyboardService=new hae(this._canvasContainer),this.mouseService=new fae(this._container,this._canvasContainer,this._domContainer,document),this.touchService=new gae(this._canvasContainer,this._domContainer),this.spriteService=new mae(e.sprite),window.addEventListener("resize",this._onWindowResize,!1)}get canvas(){return this._canvas.parentNode?this._canvas:null}get canvasContainer(){return this._canvasContainer}get container(){return this._container}get domContainer(){return this._domContainer}remove(){window.removeEventListener("resize",this._onWindowResize,!1),this.spriteService.dispose(),this.touchService.dispose(),this.mouseService.dispose(),this.glRenderer.remove(),this.domRenderer.remove(),this.renderService.dispose(),this._removeNode(this._canvasContainer),this._removeNode(this._domContainer),this._container.classList.remove("mapillary-viewer")}_removeNode(e){e.parentNode&&e.parentNode.removeChild(e)}}class yae{constructor(e,t,i){this._graphService=e,this._stateService=t,this._api=i,this._subscriptions=new wo,this._started=!1,this._cellDepth=1}get started(){return this._started}configure(e){if(!e){this._cellDepth=1;return}this._cellDepth=Math.max(1,Math.min(3,e.cellDepth))}start(){if(this._started)return;const e=this._subscriptions;e.push(this._stateService.currentState$.pipe(yi(void 0,t=>t.state.currentImage.id),st(t=>{const i=t.state,r=i.trajectory,o=r.map(s=>s.id),c=r[r.length-1].sequenceId;return[o,i.currentImage.originalLngLat,c]}),Tw(1,5),Ui(this._graphService.graphMode$),ei(([t,i])=>{const r=t[0][0],o=t[0][1],c=this._api.data.geometry,s=c.lngLatToCellId(o),d=S2(s,this._cellDepth,c),p=i===oa.Sequence?t[0][2]:void 0;return this._graphService.uncache$(r,d,p)})).subscribe(()=>{})),e.push(this._graphService.graphMode$.pipe(Ks(1),Ui(this._stateService.currentState$),ei(([t,i])=>t===oa.Sequence?this._keyToEdges(i.state.currentImage.id,r=>r.sequenceEdges$):Fr(i.state.trajectory.map(r=>r.id).slice(i.state.currentIndex)).pipe(Hi(r=>this._keyToEdges(r,o=>o.spatialEdges$),6)))).subscribe(()=>{})),e.push(this._graphService.dataAdded$.pipe(Ui(this._stateService.currentId$),ei(([t,i])=>this._graphService.cacheImage$(i))).subscribe(()=>{})),this._started=!0}stop(){this._started&&(this._subscriptions.unsubscribe(),this._started=!1)}_keyToEdges(e,t){return this._graphService.cacheImage$(e).pipe(ei(t),wi(i=>i.cached),i2(15e3),Un(i=>(console.error(`Failed to cache edges (${e}).`,i),Ni())))}}class bae{constructor(){this._loadersSubject$=new ri,this._loaders$=this._loadersSubject$.pipe(Vr((e,t)=>(t.task!==void 0&&(e[t.task]=t.loading),e),{}),An({}),Ii(1),_i())}get loading$(){return this._loaders$.pipe(st(e=>{for(const t in e)if(e.hasOwnProperty(t)&&e[t])return!0;return!1}),zy(100),yi())}taskLoading$(e){return this._loaders$.pipe(st(t=>!!t[e]),zy(100),yi())}startLoading(e){this._loadersSubject$.next({loading:!0,task:e})}stopLoading(e){this._loadersSubject$.next({loading:!1,task:e})}}var Ll;(function(n){n[n.Disabled=0]="Disabled",n[n.Enabled=1]="Enabled",n[n.Started=2]="Started"})(Ll||(Ll={}));class xae{constructor(e,t,i,r,o,c){this._subscriptions=new wo,this._graphService=e,this._stateService=t,this._graphCalculator=r??new eE,this._spatial=o??new xo,this._viewportCoords=c??new $o,this._mode=i!==!1?Ll.Enabled:Ll.Disabled,this._panImagesSubject$=new ri,this._panImages$=this._panImagesSubject$.pipe(An([]),Ii(1),_i()),this._subscriptions.push(this._panImages$.subscribe())}get panImages$(){return this._panImages$}dispose(){this.stop(),this._panImagesSubscription!=null&&this._panImagesSubscription.unsubscribe(),this._subscriptions.unsubscribe()}enable(){this._mode===Ll.Disabled&&(this._mode=Ll.Enabled,this.start())}disable(){this._mode!==Ll.Disabled&&(this.stop(),this._mode=Ll.Disabled)}start(){if(this._mode!==Ll.Enabled)return;const e=this._stateService.currentImage$.pipe(ei(t=>{if(!t.merged||Di(t.cameraType))return Pi([]);const i=Pi(t),r=this._graphCalculator.boundingBoxCorners(t.lngLat,20),o=this._graphService.cacheBoundingBox$(r[0],r[1]).pipe(Un(c=>(console.error(`Failed to cache periphery bounding box (${t.id})`,c),Ni())),st(c=>{if(Di(t.cameraType))return[];const s=[];for(const d of c)d.id!==t.id&&d.mergeId===t.mergeId&&(Di(d.cameraType)||this._distance(d,t)>4||s.push(d));return s}));return Si(i,o).pipe(Ui(this._stateService.reference$),st(([[c,s],d])=>{const p=this._spatial.viewingDirection(c.rotation),g=Dw({lat:c.lngLat.lat,lng:c.lngLat.lng,alt:c.computedAltitude},c.rotation,d),_=this._createTransform(c,g),x=this._spatial.wrap(this._spatial.azimuthal(p.toArray(),_.upVector().toArray()),0,2*Math.PI),b=this._computeProjectedPoints(_),S=this._computeHorizontalFov(b)/180*Math.PI,P=Math.PI/8;let L,E;for(const D of s){const O=Dw({lat:D.lngLat.lat,lng:D.lngLat.lng,alt:D.computedAltitude},D.rotation,d),U=this._createTransform(D,O),j=this._computeProjectedPoints(U),G=this._computeHorizontalFov(j)/180*Math.PI,N=this._spatial.viewingDirection(D.rotation),V=this._spatial.wrap(this._spatial.azimuthal(N.toArray(),U.upVector().toArray()),0,2*Math.PI),q=this._spatial.angleBetweenVector2(p.x,p.y,N.x,N.y);let z=Number.NEGATIVE_INFINITY;q>0?x>V?z=x-2*Math.PI+S/2-(V-G/2):z=x+S/2-(V-G/2):x<V?z=V+G/2-(x+2*Math.PI-S/2):z=V+G/2-(x-S/2);const Q=Math.abs(G-z),X=this._distance(D,c),re=Math.min(this._timeDifference(D,c),4),oe=20*Math.abs(z-P),de=Math.min(5,1/Math.min(G/S,1)),ce=z>0?-2*Q:0,Se=X+re+oe+de+ce;z>0&&z<.5*S&&z<.5*G&&Q>.5*S&&(q>0?L?Se<L[0]&&(L=[Se,D,U,G]):L=[Se,D,U,G]:E?Se<E[0]&&(E=[Se,D,U,G]):E=[Se,D,U,G])}const C=[];return L&&C.push([L[1],L[2],L[3]]),E&&C.push([E[1],E[2],E[3]]),C}),An([]))}));this._panImagesSubscription=this._stateService.currentState$.pipe(st(t=>t.state.imagesAhead>0),yi(),ei(t=>t?Pi([]):e)).subscribe(t=>{this._panImagesSubject$.next(t)}),this._mode=Ll.Started}stop(){this._mode===Ll.Started&&(this._panImagesSubscription.unsubscribe(),this._panImagesSubject$.next([]),this._mode=Ll.Enabled)}_distance(e,t){const[i,r,o]=ra(e.lngLat.lng,e.lngLat.lat,e.computedAltitude,t.lngLat.lng,t.lngLat.lat,t.computedAltitude);return Math.sqrt(i*i+r*r+o*o)}_timeDifference(e,t){return Math.abs(e.capturedAt-t.capturedAt)/2592e6}_createTransform(e,t){return new kg(e.exifOrientation,e.width,e.height,e.scale,e.rotation,t,e.assetsCached?e.image:void 0,void 0,e.cameraParameters,e.cameraType)}_computeProjectedPoints(e){return tE(e,[[1,0]],[[0,.5]],20,this._viewportCoords)}_computeHorizontalFov(e){const t=e.map(r=>this._coordToFov(r[0]));return Math.min(...t)}_coordToFov(e){return 2*Math.atan(e)*180/Math.PI}}class Tk{constructor(e){this._data=e}get data(){return this._data}getCoreImages$(e){return this._wrap$(this._data.getCoreImages(e))}getImages$(e){return this._wrap$(this._data.getImages(e))}getImageTiles$(e){return this._wrap$(this._data.getImageTiles(e))}getSequence$(e){return this._wrap$(this._data.getSequence(e))}getSpatialImages$(e){return this._wrap$(this._data.getSpatialImages(e))}setAccessToken(e){this._data.setAccessToken(e)}_wrap$(e){return _r.create(t=>{e.then(i=>{t.next(i),t.complete()},i=>{t.error(i)})})}}class wae{constructor(e){this._dataAdded$=new ri,this._subscriptions=new wo,this._onDataAdded=i=>{this._graph$.pipe(wi(),Hi(r=>r.updateCells$(i.cellIds).pipe(Dr(()=>{r.resetSpatialEdges()})))).subscribe(r=>{this._dataAdded$.next(r)})};const t=this._subscriptions;this._graph$=jl(Pi(e),e.changed$).pipe(Ii(1),_i()),t.push(this._graph$.subscribe(()=>{})),this._graphMode=oa.Spatial,this._graphModeSubject$=new ri,this._graphMode$=this._graphModeSubject$.pipe(An(this._graphMode),Ii(1),_i()),t.push(this._graphMode$.subscribe(()=>{})),this._firstGraphSubjects$=[],this._initializeCacheSubscriptions=[],this._sequenceSubscriptions=[],this._spatialSubscriptions=[],e.api.data.on("datacreate",this._onDataAdded)}get dataAdded$(){return this._dataAdded$}get filter$(){return this._graph$.pipe(wi(),Hi(e=>e.filter$))}get graphMode$(){return this._graphMode$}cacheBoundingBox$(e,t){return this._graph$.pipe(wi(),Hi(i=>i.cacheBoundingBox$(e,t)))}cacheCell$(e){return this._graph$.pipe(wi(),Hi(t=>t.cacheCell$(e)))}cacheImage$(e){const t=new ri;this._firstGraphSubjects$.push(t);const i=t.pipe(Ii(1),_i()),r=i.pipe(st(d=>d.getNode(e)),Hi(d=>d.assetsCached?Pi(d):d.cacheAssets$()),Ii(1),_i());r.subscribe(void 0,d=>{console.error(`Failed to cache image (${e}).`,d)});let o;o=this._graph$.pipe(wi(),Hi(d=>d.isCachingFull(e)||!d.hasNode(e)?d.cacheFull$(e):d.isCachingFill(e)||!d.getNode(e).complete?d.cacheFill$(e):Pi(d)),Dr(d=>{if(!d.hasNode(e))throw new lr(`Failed to cache image (${e})`);d.hasInitializedCache(e)||d.initializeCache(e)}),va(()=>{o!=null&&(this._removeFromArray(o,this._initializeCacheSubscriptions),this._removeFromArray(t,this._firstGraphSubjects$))})).subscribe(d=>{t.next(d),t.complete()},d=>{t.error(d)}),o.closed||this._initializeCacheSubscriptions.push(o);const c=i.pipe(Un(()=>Ni()),Hi(d=>d.isCachingNodeSequence(e)||!d.hasNodeSequence(e)?d.cacheNodeSequence$(e):Pi(d)),Ii(1),_i());let s;if(s=c.pipe(Dr(d=>{d.getNode(e).sequenceEdges.cached||d.cacheSequenceEdges(e)}),va(()=>{s!=null&&this._removeFromArray(s,this._sequenceSubscriptions)})).subscribe(()=>{},d=>{console.error(`Failed to cache sequence edges (${e}).`,d)}),s.closed||this._sequenceSubscriptions.push(s),this._graphMode===oa.Spatial){let d;d=i.pipe(Un(()=>Ni()),qO(p=>p.hasTiles(e)?Ni():Fr(p.cacheTiles$(e)).pipe(Hi(g=>g.pipe(Hi(_=>_.isCachingTiles(e)?Ni():Pi(_)),Un(_=>(console.error(`Failed to cache tile data (${e}).`,_),Ni())))))),n2(1),Hi(p=>p.hasSpatialArea(e)?Pi(p):Fr(p.cacheSpatialArea$(e)).pipe(Hi(g=>g.pipe(Un(_=>(console.error(`Failed to cache spatial images (${e}).`,_),Ni())))))),n2(1),Hi(p=>p.hasNodeSequence(e)?Pi(p):p.cacheNodeSequence$(e)),Dr(p=>{p.getNode(e).spatialEdges.cached||p.cacheSpatialEdges(e)}),va(()=>{d!=null&&this._removeFromArray(d,this._spatialSubscriptions)})).subscribe(()=>{},p=>{const g=`Failed to cache spatial edges (${e}).`;console.error(g,p)}),d.closed||this._spatialSubscriptions.push(d)}return r.pipe(wi(d=>d.assetsCached))}cacheSequence$(e){return this._graph$.pipe(wi(),Hi(t=>t.isCachingSequence(e)||!t.hasSequence(e)?t.cacheSequence$(e):Pi(t)),st(t=>t.getSequence(e)))}cacheSequenceImages$(e,t){return this._graph$.pipe(wi(),Hi(i=>i.isCachingSequence(e)||!i.hasSequence(e)?i.cacheSequence$(e):Pi(i)),Hi(i=>i.isCachingSequenceNodes(e)||!i.hasSequenceNodes(e)?i.cacheSequenceNodes$(e,t):Pi(i)),st(i=>i.getSequence(e)))}dispose(){this._graph$.pipe(wi()).subscribe(e=>{e.unsubscribe()}),this._subscriptions.unsubscribe()}setFilter$(e){return this._resetSubscriptions(this._spatialSubscriptions),this._graph$.pipe(wi(),Dr(t=>{t.resetSpatialEdges(),t.setFilter(e)}),st(()=>{}))}setGraphMode(e){this._graphMode!==e&&(e===oa.Sequence&&this._resetSubscriptions(this._spatialSubscriptions),this._graphMode=e,this._graphModeSubject$.next(this._graphMode))}reset$(e){return this._abortSubjects(this._firstGraphSubjects$),this._resetSubscriptions(this._initializeCacheSubscriptions),this._resetSubscriptions(this._sequenceSubscriptions),this._resetSubscriptions(this._spatialSubscriptions),this._graph$.pipe(wi(),Dr(t=>{t.reset(e)}),st(()=>{}))}uncache$(e,t,i){return this._graph$.pipe(wi(),Dr(r=>{r.uncache(e,t,i)}),st(()=>{}))}_abortSubjects(e){for(const t of e.slice())this._removeFromArray(t,e),t.error(new Error("Cache image request was aborted."))}_removeFromArray(e,t){const i=t.indexOf(e);i!==-1&&t.splice(i,1)}_resetSubscriptions(e){for(const t of e.slice())this._removeFromArray(t,e),t.closed||t.unsubscribe()}}class Sae{constructor(e){e.requestAnimationFrame?(this._cancelAnimationFrame=e.cancelAnimationFrame.bind(e),this._requestAnimationFrame=e.requestAnimationFrame.bind(e)):e.mozRequestAnimationFrame?(this._cancelAnimationFrame=e.mozCancelAnimationFrame.bind(e),this._requestAnimationFrame=e.mozRequestAnimationFrame.bind(e)):e.webkitRequestAnimationFrame?(this._cancelAnimationFrame=e.webkitCancelAnimationFrame.bind(e),this._requestAnimationFrame=e.webkitRequestAnimationFrame.bind(e)):e.msRequestAnimationFrame?(this._cancelAnimationFrame=e.msCancelAnimationFrame.bind(e),this._requestAnimationFrame=e.msRequestAnimationFrame.bind(e)):e.oRequestAnimationFrame?(this._cancelAnimationFrame=e.oCancelAnimationFrame.bind(e),this._requestAnimationFrame=e.oRequestAnimationFrame.bind(e)):(this._cancelAnimationFrame=e.clearTimeout.bind(e),this._requestAnimationFrame=t=>e.setTimeout(t,1e3/60))}get cancelAnimationFrame(){return this._cancelAnimationFrame}get requestAnimationFrame(){return this._requestAnimationFrame}}class I1{constructor(e){this._spatial=new xo,this._referenceThreshold=.01,this._transitionMode=e.transitionMode,this._reference=e.reference,this._alpha=e.alpha,this._stateTransitionAlpha=0,this._camera=e.camera.clone(),this._zoom=e.zoom,this._currentIndex=e.currentIndex,this._trajectory=e.trajectory.slice(),this._trajectoryTransforms=[],this._trajectoryCameras=[];for(let t of this._trajectory){let i=this._imageToTranslation(t,this._reference),r=new kg(t.exifOrientation,t.width,t.height,t.scale,t.rotation,i,t.image,void 0,t.cameraParameters,t.cameraType);this._trajectoryTransforms.push(r),this._trajectoryCameras.push(new Ed(r))}this._currentImage=this._trajectory.length>0?this._trajectory[this._currentIndex]:null,this._previousImage=this._trajectory.length>1&&this.currentIndex>0?this._trajectory[this._currentIndex-1]:null,this._currentCamera=this._trajectoryCameras.length>0?this._trajectoryCameras[this._currentIndex].clone():new Ed,this._previousCamera=this._trajectoryCameras.length>1&&this.currentIndex>0?this._trajectoryCameras[this._currentIndex-1].clone():this._currentCamera.clone()}get reference(){return this._reference}get alpha(){return this._getAlpha()}get stateTransitionAlpha(){return this._getStateTransitionAlpha()}get camera(){return this._camera}get zoom(){return this._zoom}get trajectory(){return this._trajectory}get currentIndex(){return this._currentIndex}get currentImage(){return this._currentImage}get previousImage(){return this._previousImage}get currentCamera(){return this._currentCamera}get currentTransform(){return this._trajectoryTransforms.length>0?this._trajectoryTransforms[this.currentIndex]:null}get previousTransform(){return this._trajectoryTransforms.length>1&&this.currentIndex>0?this._trajectoryTransforms[this.currentIndex-1]:null}get motionless(){return this._motionless}get transitionMode(){return this._transitionMode}move(e){}moveTo(e){}rotate(e){}rotateUnbounded(e){}rotateWithoutInertia(e){}rotateBasic(e){}rotateBasicUnbounded(e){}rotateBasicWithoutInertia(e){}rotateToBasic(e){}setSpeed(e){}zoomIn(e,t){}update(e){}setCenter(e){}setZoom(e){}dolly(e){}orbit(e){}setViewMatrix(e){}truck(e){}append(e){if(e.length<1)throw Error("Trajectory can not be empty");this._currentIndex<0?this.set(e):(this._trajectory=this._trajectory.concat(e),this._appendToTrajectories(e))}prepend(e){if(e.length<1)throw Error("Trajectory can not be empty");this._trajectory=e.slice().concat(this._trajectory),this._currentIndex+=e.length,this._setCurrentImage(),this._setReference(this._currentImage)?this._setTrajectories():this._prependToTrajectories(e),this._setCurrentCamera()}remove(e){if(e<0)throw Error("n must be a positive integer");if(this._currentIndex-1<e)throw Error("Current and previous images can not be removed");for(let t=0;t<e;t++)this._trajectory.shift(),this._trajectoryTransforms.shift(),this._trajectoryCameras.shift(),this._currentIndex--;this._setCurrentImage()}clearPrior(){this._currentIndex>0&&this.remove(this._currentIndex-1)}clear(){this.cut(),this._currentIndex>0&&this.remove(this._currentIndex-1)}cut(){for(;this._trajectory.length-1>this._currentIndex;)this._trajectory.pop(),this._trajectoryTransforms.pop(),this._trajectoryCameras.pop()}set(e){this._setTrajectory(e),this._setCurrentImage(),this._setReference(this._currentImage),this._setTrajectories(),this._setCurrentCamera()}getCenter(){return this._currentImage!=null?this.currentTransform.projectBasic(this._camera.lookat.toArray()):[.5,.5]}setTransitionMode(e){this._transitionMode=e}_getAlpha(){return 1}_getStateTransitionAlpha(){return 1}_setCurrent(){this._setCurrentImage(),this._setReference(this._currentImage)&&this._setTrajectories(),this._setCurrentCamera()}_setCurrentCamera(){this._currentCamera=this._trajectoryCameras[this._currentIndex].clone(),this._previousCamera=this._currentIndex>0?this._trajectoryCameras[this._currentIndex-1].clone():this._currentCamera.clone()}_motionlessTransition(){return this._currentImage!=null&&this._previousImage!=null&&(this._transitionMode===Gw.Instantaneous||!(this._currentImage.merged&&this._previousImage.merged&&this._withinOriginalDistance()&&this._sameConnectedComponent()))}_setReference(e){return Math.abs(e.lngLat.lat-this.reference.lat)<this._referenceThreshold&&Math.abs(e.lngLat.lng-this.reference.lng)<this._referenceThreshold||this._previousImage!=null&&!this._motionlessTransition()?!1:(this._reference.lat=e.lngLat.lat,this._reference.lng=e.lngLat.lng,this._reference.alt=e.computedAltitude,!0)}_setCurrentImage(){this._currentImage=this._trajectory.length>0?this._trajectory[this._currentIndex]:null,this._previousImage=this._currentIndex>0?this._trajectory[this._currentIndex-1]:null}_setTrajectory(e){if(e.length<1)throw new _a("Trajectory can not be empty");this._currentImage!=null?(this._trajectory=[this._currentImage].concat(e),this._currentIndex=1):(this._trajectory=e.slice(),this._currentIndex=0)}_setTrajectories(){this._trajectoryTransforms.length=0,this._trajectoryCameras.length=0,this._appendToTrajectories(this._trajectory)}_appendToTrajectories(e){for(let t of e){if(!t.assetsCached)throw new _a("Assets must be cached when image is added to trajectory");let i=this._imageToTranslation(t,this.reference),r=new kg(t.exifOrientation,t.width,t.height,t.scale,t.rotation,i,t.image,void 0,t.cameraParameters,t.cameraType);this._trajectoryTransforms.push(r),this._trajectoryCameras.push(new Ed(r))}}_prependToTrajectories(e){for(let t of e.reverse()){if(!t.assetsCached)throw new _a("Assets must be cached when added to trajectory");let i=this._imageToTranslation(t,this.reference),r=new kg(t.exifOrientation,t.width,t.height,t.scale,t.rotation,i,t.image,void 0,t.cameraParameters,t.cameraType);this._trajectoryTransforms.unshift(r),this._trajectoryCameras.unshift(new Ed(r))}}_imageToTranslation(e,t){return Dw({alt:e.computedAltitude,lat:e.lngLat.lat,lng:e.lngLat.lng},e.rotation,t)}_sameConnectedComponent(){let e=this._currentImage,t=this._previousImage;return!!e&&!!t&&e.mergeId===t.mergeId}_withinOriginalDistance(){let e=this._currentImage,t=this._previousImage;return!e||!t?!0:this._spatial.distanceFromLngLat(e.originalLngLat.lng,e.originalLngLat.lat,t.originalLngLat.lng,t.originalLngLat.lat)<25}}class Mk extends I1{constructor(e){super(e)}setViewMatrix(e){const i=new ki().fromArray(e).invert().elements,r=new Ge(i[12],i[13],i[14]),o=new Ge(-i[8],-i[9],-i[10]),c=new Ge(i[4],i[5],i[6]),s=this._camera;s.position.copy(r),s.lookat.copy(r.clone().add(o)),s.up.copy(c);const d=.5/Math.tan(Math.PI/3);s.focal=d}}class Ck extends I1{constructor(e){super(e),this._transition=0;const t=this._camera.position.clone(),i=this._camera.lookat.clone().sub(t).normalize(),r=Math.sqrt(i.x*i.x+i.y*i.y),o=Math.atan2(i.z,r),c=new Ge;if(o>-Math.PI/45)c.copy(t),t.add(new Ge(i.x,i.y,0).multiplyScalar(-50)),t.z=30;else{const D=t.clone(),O=new Ge(0,0,1),U=new Ge(0,0,-2),j=new Ge().subVectors(U,D).dot(O)/i.dot(O),N=D.clone().add(i.clone().multiplyScalar(Math.min(1e4,j)));c.copy(N);const V=t.clone().sub(N).normalize();t.copy(N.add(V.multiplyScalar(Math.max(50,V.length()))))}const s=this._camera.position.clone(),d=s.clone().add(i.clone().normalize().multiplyScalar(10)),p=this._camera.up.clone(),g=d.clone(),_=g.clone().add(i.clone().normalize().multiplyScalar(10)),x=p.clone(),b=t.clone(),S=c.clone(),P=new Ge(0,0,1),L=t.clone().add(S.clone().sub(b).normalize().multiplyScalar(-10)),E=S.clone(),C=P.clone();this._curveE=new vy([g,s,b,L]),this._curveL=new vy([_,d,S,E]),this._curveU=new vy([x,p,P,C]),this._zoom0=this._zoom,this._zoom1=0,this._camera.focal=.5/Math.tan(Math.PI/4)}get _isTransitioning(){return this._transition<1}dolly(e){if(this._isTransitioning)return;const t=this._camera,i=t.position.clone().sub(t.lookat),o=i.length()*Math.pow(2,-e),c=Math.max(1,Math.min(o,4e3));i.normalize(),i.multiplyScalar(c),t.position.copy(t.lookat).add(i)}orbit(e){if(this._isTransitioning)return;const t=this._camera,i=new yo().setFromUnitVectors(t.up,new Ge(0,0,1)),r=i.clone().invert(),o=t.position.clone().sub(t.lookat);o.applyQuaternion(i);const c=o.length();let s=Math.atan2(o.y,o.x);s+=e.phi;let d=Math.atan2(Math.sqrt(o.x*o.x+o.y*o.y),o.z);d+=e.theta;const p=Math.PI/36;d=Math.max(p,Math.min(Math.PI/2-p,d)),o.x=Math.sin(d)*Math.cos(s),o.y=Math.sin(d)*Math.sin(s),o.z=Math.cos(d),o.applyQuaternion(r),t.position.copy(t.lookat).add(o.multiplyScalar(c))}truck(e){if(this._isTransitioning)return;const t=this._camera;t.position.add(new Ge().fromArray(e)),t.lookat.add(new Ge().fromArray(e))}update(e){if(!this._isTransitioning)return;this._transition=Math.min(this._transition+2*e/3,1);const t=Zg.smootherstep(this._transition,0,1),i=(t+1)/3,r=this._curveE.getPoint(i),o=this._curveL.getPoint(i),c=this._curveU.getPoint(i);this._camera.position.copy(r),this._camera.lookat.copy(o),this._camera.up.copy(c),this._zoom=Zg.lerp(this._zoom0,this._zoom1,t),this._stateTransitionAlpha=t}_getStateTransitionAlpha(){return this._stateTransitionAlpha}}class Ek{constructor(e,t){this._phi=e,this._theta=t}get phi(){return this._phi}set phi(e){this._phi=e}get theta(){return this._theta}set theta(e){this._theta=e}get isZero(){return this._phi===0&&this._theta===0}copy(e){this._phi=e.phi,this._theta=e.theta}lerp(e,t){this._phi=(1-t)*this._phi+t*e.phi,this._theta=(1-t)*this._theta+t*e.theta}multiply(e){this._phi*=e,this._theta*=e}threshold(e){this._phi=Math.abs(this._phi)>e?this._phi:0,this._theta=Math.abs(this._theta)>e?this._theta:0}lengthSquared(){return this._phi*this._phi+this._theta*this._theta}reset(){this._phi=0,this._theta=0}}class FN extends I1{constructor(e){super(e),this._animationSpeed=1/40,this._rotationDelta=new Ek(0,0),this._requestedRotationDelta=null,this._basicRotation=[0,0],this._requestedBasicRotation=null,this._requestedBasicRotationUnbounded=null,this._rotationAcceleration=.86,this._rotationIncreaseAlpha=.97,this._rotationDecreaseAlpha=.9,this._rotationThreshold=.001,this._unboundedRotationAlpha=.8,this._desiredZoom=e.zoom,this._minZoom=0,this._maxZoom=3,this._lookatDepth=10,this._desiredLookat=null,this._desiredCenter=null}rotate(e){this._currentImage!=null&&(e.phi===0&&e.theta===0||(this._desiredZoom=this._zoom,this._desiredLookat=null,this._requestedBasicRotation=null,this._requestedRotationDelta!=null?(this._requestedRotationDelta.phi=this._requestedRotationDelta.phi+e.phi,this._requestedRotationDelta.theta=this._requestedRotationDelta.theta+e.theta):this._requestedRotationDelta=new Ek(e.phi,e.theta)))}rotateUnbounded(e){if(this._currentImage==null||(this._requestedBasicRotation=null,this._requestedRotationDelta=null,this._applyRotation(e,this._currentCamera),this._applyRotation(e,this._previousCamera),!this._desiredLookat))return;const t=new yo().setFromUnitVectors(this._currentCamera.up,new Ge(0,0,1)),i=t.clone().invert(),r=new Ge().copy(this._desiredLookat).sub(this._camera.position).applyQuaternion(t),o=r.length();let c=Math.atan2(r.y,r.x);c+=e.phi;let s=Math.atan2(Math.sqrt(r.x*r.x+r.y*r.y),r.z);s+=e.theta,s=Math.max(.1,Math.min(Math.PI-.1,s)),r.x=Math.sin(s)*Math.cos(c),r.y=Math.sin(s)*Math.sin(c),r.z=Math.cos(s),r.applyQuaternion(i),this._desiredLookat.copy(this._camera.position).add(r.multiplyScalar(o))}rotateWithoutInertia(e){if(this._currentImage==null)return;this._desiredZoom=this._zoom,this._desiredLookat=null,this._requestedBasicRotation=null,this._requestedRotationDelta=null;const t=Math.PI/(10*Math.pow(2,this._zoom)),i={phi:this._spatial.clamp(e.phi,-t,t),theta:this._spatial.clamp(e.theta,-t,t)};this._applyRotation(i,this._currentCamera),this._applyRotation(i,this._previousCamera)}rotateBasic(e){if(this._currentImage!=null)if(this._desiredZoom=this._zoom,this._desiredLookat=null,this._requestedRotationDelta=null,this._requestedBasicRotation!=null){this._requestedBasicRotation[0]+=e[0],this._requestedBasicRotation[1]+=e[1];let t=.05/Math.pow(2,this._zoom);this._requestedBasicRotation[0]=this._spatial.clamp(this._requestedBasicRotation[0],-t,t),this._requestedBasicRotation[1]=this._spatial.clamp(this._requestedBasicRotation[1],-t,t)}else this._requestedBasicRotation=e.slice()}rotateBasicUnbounded(e){this._currentImage!=null&&(this._requestedBasicRotationUnbounded!=null?(this._requestedBasicRotationUnbounded[0]+=e[0],this._requestedBasicRotationUnbounded[1]+=e[1]):this._requestedBasicRotationUnbounded=e.slice())}rotateBasicWithoutInertia(e){if(this._currentImage==null)return;this._desiredZoom=this._zoom,this._desiredLookat=null,this._requestedRotationDelta=null,this._requestedBasicRotation=null;const t=.05/Math.pow(2,this._zoom),i=e.slice();i[0]=this._spatial.clamp(i[0],-t,t),i[1]=this._spatial.clamp(i[1],-t,t),this._applyRotationBasic(i)}rotateToBasic(e){if(this._currentImage==null)return;this._desiredZoom=this._zoom,this._desiredLookat=null,e[0]=this._spatial.clamp(e[0],0,1),e[1]=this._spatial.clamp(e[1],0,1);let t=this.currentTransform.unprojectBasic(e,this._lookatDepth);this._currentCamera.lookat.fromArray(t)}zoomIn(e,t){if(this._currentImage==null)return;this._desiredZoom=Math.max(this._minZoom,Math.min(this._maxZoom,this._desiredZoom+e));let i=this.currentTransform.projectBasic(this._currentCamera.lookat.toArray()),r=i[0],o=i[1],c=Math.pow(2,this._zoom),s=Math.pow(2,this._desiredZoom),d=t[0],p=t[1];Di(this.currentTransform.cameraType)&&(d-r>.5?d=d-1:r-d>.5&&(d=1+d));let g=d-c/s*(d-r),_=p-c/s*(p-o);Di(this._currentImage.cameraType)?(g=this._spatial.wrap(g+this._basicRotation[0],0,1),_=this._spatial.clamp(_+this._basicRotation[1],.05,.95)):(g=this._spatial.clamp(g,0,1),_=this._spatial.clamp(_,0,1)),this._desiredLookat=new Ge().fromArray(this.currentTransform.unprojectBasic([g,_],this._lookatDepth))}setCenter(e){this._desiredLookat=null,this._requestedRotationDelta=null,this._requestedBasicRotation=null,this._desiredZoom=this._zoom;let t=[this._spatial.clamp(e[0],0,1),this._spatial.clamp(e[1],0,1)];if(this._currentImage==null){this._desiredCenter=t;return}this._desiredCenter=null;let i=new Ge().fromArray(this.currentTransform.unprojectBasic(t,this._lookatDepth)),r=this.previousTransform!=null?this.previousTransform:this.currentTransform,o=new Ge().fromArray(r.unprojectBasic(t,this._lookatDepth));this._currentCamera.lookat.copy(i),this._previousCamera.lookat.copy(o)}setZoom(e){this._desiredLookat=null,this._requestedRotationDelta=null,this._requestedBasicRotation=null,this._zoom=this._spatial.clamp(e,this._minZoom,this._maxZoom),this._desiredZoom=this._zoom}_applyRotation(e,t){if(t==null)return;let i=new yo().setFromUnitVectors(t.up,new Ge(0,0,1)),r=i.clone().invert(),o=new Ge;o.copy(t.lookat).sub(t.position),o.applyQuaternion(i);let c=o.length(),s=Math.atan2(o.y,o.x);s+=e.phi;let d=Math.atan2(Math.sqrt(o.x*o.x+o.y*o.y),o.z);d+=e.theta,d=Math.max(.1,Math.min(Math.PI-.1,d)),o.x=Math.sin(d)*Math.cos(s),o.y=Math.sin(d)*Math.sin(s),o.z=Math.cos(d),o.applyQuaternion(r),t.lookat.copy(t.position).add(o.multiplyScalar(c))}_applyRotationBasic(e){let t=this._currentImage,i=this._previousImage!=null?this.previousImage:this.currentImage,r=this._currentCamera,o=this._previousCamera,c=this.currentTransform,s=this.previousTransform!=null?this.previousTransform:this.currentTransform,d=c.projectBasic(r.lookat.toArray()),p=s.projectBasic(o.lookat.toArray());Di(t.cameraType)?(d[0]=this._spatial.wrap(d[0]+e[0],0,1),d[1]=this._spatial.clamp(d[1]+e[1],.05,.95)):(d[0]=this._spatial.clamp(d[0]+e[0],0,1),d[1]=this._spatial.clamp(d[1]+e[1],0,1)),Di(i.cameraType)?(p[0]=this._spatial.wrap(p[0]+e[0],0,1),p[1]=this._spatial.clamp(p[1]+e[1],.05,.95)):(p[0]=this._spatial.clamp(p[0]+e[0],0,1),p[1]=this._spatial.clamp(d[1]+e[1],0,1));let g=c.unprojectBasic(d,this._lookatDepth);r.lookat.fromArray(g);let _=s.unprojectBasic(p,this._lookatDepth);o.lookat.fromArray(_)}_updateZoom(e){let t=this._desiredZoom-this._zoom,i=t>0?1:t<0?-1:0;t!==0&&(Math.abs(t)<.002?(this._zoom=this._desiredZoom,this._desiredLookat!=null&&(this._desiredLookat=null)):this._zoom+=i*Math.max(Math.abs(5*e*t),.002))}_updateLookat(e){if(this._desiredLookat===null)return;let t=this._desiredLookat.distanceToSquared(this._currentCamera.lookat);Math.abs(t)<1e-6?(this._currentCamera.lookat.copy(this._desiredLookat),this._desiredLookat=null):this._currentCamera.lookat.lerp(this._desiredLookat,5*e)}_updateRotation(){if(this._requestedRotationDelta!=null){let t=this._rotationDelta.lengthSquared();this._requestedRotationDelta.lengthSquared()>t?this._rotationDelta.lerp(this._requestedRotationDelta,this._rotationIncreaseAlpha):this._rotationDelta.lerp(this._requestedRotationDelta,this._rotationDecreaseAlpha),this._requestedRotationDelta=null;return}if(this._rotationDelta.isZero)return;const e=Di(this.currentImage.cameraType)?1:this._alpha;this._rotationDelta.multiply(this._rotationAcceleration*e),this._rotationDelta.threshold(this._rotationThreshold)}_updateRotationBasic(){if(this._requestedBasicRotation!=null){let e=this._basicRotation[0],t=this._basicRotation[1],i=this._requestedBasicRotation[0],r=this._requestedBasicRotation[1];Math.abs(i)>Math.abs(e)?this._basicRotation[0]=(1-this._rotationIncreaseAlpha)*e+this._rotationIncreaseAlpha*i:this._basicRotation[0]=(1-this._rotationDecreaseAlpha)*e+this._rotationDecreaseAlpha*i,Math.abs(r)>Math.abs(t)?this._basicRotation[1]=(1-this._rotationIncreaseAlpha)*t+this._rotationIncreaseAlpha*r:this._basicRotation[1]=(1-this._rotationDecreaseAlpha)*t+this._rotationDecreaseAlpha*r,this._requestedBasicRotation=null;return}if(this._requestedBasicRotationUnbounded!=null){let e=this._requestedBasicRotationUnbounded[0],t=this._requestedBasicRotationUnbounded[1];if(Math.abs(e)>0&&(this._basicRotation[0]=(1-this._unboundedRotationAlpha)*this._basicRotation[0]+this._unboundedRotationAlpha*e),Math.abs(t)>0&&(this._basicRotation[1]=(1-this._unboundedRotationAlpha)*this._basicRotation[1]+this._unboundedRotationAlpha*t),this._desiredLookat!=null){let i=this.currentTransform.projectBasic(this._desiredLookat.toArray());i[0]+=e,i[1]+=t,this._desiredLookat=new Ge().fromArray(this.currentTransform.unprojectBasic(i,this._lookatDepth))}this._requestedBasicRotationUnbounded=null}this._basicRotation[0]===0&&this._basicRotation[1]===0||(this._basicRotation[0]=this._rotationAcceleration*this._basicRotation[0],this._basicRotation[1]=this._rotationAcceleration*this._basicRotation[1],Math.abs(this._basicRotation[0])<this._rotationThreshold/Math.pow(2,this._zoom)&&Math.abs(this._basicRotation[1])<this._rotationThreshold/Math.pow(2,this._zoom)&&(this._basicRotation=[0,0]))}_clearRotation(){Di(this._currentImage.cameraType)||(this._requestedRotationDelta!=null&&(this._requestedRotationDelta=null),this._rotationDelta.isZero||this._rotationDelta.reset(),this._requestedBasicRotation!=null&&(this._requestedBasicRotation=null),(this._basicRotation[0]>0||this._basicRotation[1]>0)&&(this._basicRotation=[0,0]))}_setDesiredCenter(){if(this._desiredCenter==null)return;let e=new Ge().fromArray(this.currentTransform.unprojectBasic(this._desiredCenter,this._lookatDepth)).sub(this._currentCamera.position);this._currentCamera.lookat.copy(this._currentCamera.position.clone().add(e)),this._previousCamera.lookat.copy(this._previousCamera.position.clone().add(e)),this._desiredCenter=null}_setDesiredZoom(){this._desiredZoom=Di(this._currentImage.cameraType)||this._previousImage==null?this._zoom:0}}class Ak extends FN{constructor(e){super(e),this._adjustCameras(),this._motionless=this._motionlessTransition()}prepend(e){super.prepend(e),this._motionless=this._motionlessTransition()}set(e){super.set(e),this._motionless=this._motionlessTransition()}move(e){this._alpha=Math.max(0,Math.min(1,this._alpha+e))}moveTo(e){this._alpha=Math.max(0,Math.min(1,e))}update(e){this._updateRotation(),this._rotationDelta.isZero||(this._applyRotation(this._rotationDelta,this._previousCamera),this._applyRotation(this._rotationDelta,this._currentCamera)),this._updateRotationBasic(),(this._basicRotation[0]!==0||this._basicRotation[1]!==0)&&this._applyRotationBasic(this._basicRotation);let t=this._animationSpeed*e/.1*6;this._updateZoom(t),this._updateLookat(t),this._camera.lerpCameras(this._previousCamera,this._currentCamera,this.alpha)}_getAlpha(){return this._motionless?Math.round(this._alpha):this._alpha}_setCurrentCamera(){super._setCurrentCamera(),this._adjustCameras()}_adjustCameras(){if(this._previousImage!=null){if(Di(this._currentImage.cameraType)){let e=this._camera.lookat.clone().sub(this._camera.position);this._currentCamera.lookat.copy(e.clone().add(this._currentCamera.position))}if(Di(this._previousImage.cameraType)){let e=this._currentCamera.lookat.clone().sub(this._currentCamera.position);this._previousCamera.lookat.copy(e.clone().add(this._previousCamera.position))}}}}class Pk extends FN{constructor(e){super(e),this._adjustCameras(),this._motionless=this._motionlessTransition(),this._baseAlpha=this._alpha,this._speedCoefficient=1,this._smoothing=!1}append(e){let t=this._trajectory.length===0;t&&this._resetTransition(),super.append(e),t&&(this._setDesiredCenter(),this._setDesiredZoom())}prepend(e){let t=this._trajectory.length===0;t&&this._resetTransition(),super.prepend(e),t&&(this._setDesiredCenter(),this._setDesiredZoom())}set(e){super.set(e),this._desiredLookat=null,this._resetTransition(),this._clearRotation(),this._setDesiredCenter(),this._setDesiredZoom(),this._trajectory.length<3&&(this._smoothing=!0)}setSpeed(e){this._speedCoefficient=this._spatial.clamp(e,0,10)}update(e){this._alpha===1&&this._currentIndex+this._alpha<this._trajectory.length&&(this._currentIndex+=1,this._smoothing=this._trajectory.length<3&&this._currentIndex+1===this._trajectory.length,this._setCurrent(),this._resetTransition(),this._clearRotation(),this._desiredZoom=Di(this._currentImage.cameraType)?this._zoom:0,this._desiredLookat=null);let t=this._animationSpeed*e/.1*6;this._baseAlpha=Math.min(1,this._baseAlpha+this._speedCoefficient*t),this._smoothing?this._alpha=Zg.smootherstep(this._baseAlpha,0,1):this._alpha=this._baseAlpha,this._updateRotation(),this._rotationDelta.isZero||(this._applyRotation(this._rotationDelta,this._previousCamera),this._applyRotation(this._rotationDelta,this._currentCamera)),this._updateRotationBasic(),(this._basicRotation[0]!==0||this._basicRotation[1]!==0)&&this._applyRotationBasic(this._basicRotation),this._updateZoom(t),this._updateLookat(t),this._camera.lerpCameras(this._previousCamera,this._currentCamera,this.alpha)}_getAlpha(){return this._motionless?Math.ceil(this._alpha):this._alpha}_setCurrentCamera(){super._setCurrentCamera(),this._adjustCameras()}_adjustCameras(){if(this._previousImage==null)return;let e=this._camera.lookat.clone().sub(this._camera.position);this._previousCamera.lookat.copy(e.clone().add(this._previousCamera.position)),Di(this._currentImage.cameraType)&&this._currentCamera.lookat.copy(e.clone().add(this._currentCamera.position))}_resetTransition(){this._alpha=0,this._baseAlpha=0,this._motionless=this._motionlessTransition()}}class Ik extends I1{constructor(e){super(e),this._zoom=0,this._adjustCameras(),this._motionless=this._motionlessTransition()}prepend(e){super.prepend(e),this._motionless=this._motionlessTransition()}set(e){super.set(e),this._motionless=this._motionlessTransition()}move(e){this._alpha=Math.max(0,Math.min(1,this._alpha+e))}moveTo(e){this._alpha=Math.max(0,Math.min(1,e))}update(){this._camera.lerpCameras(this._previousCamera,this._currentCamera,this.alpha)}_getAlpha(){return this._motionless?Math.round(this._alpha):this._alpha}_setCurrentCamera(){super._setCurrentCamera(),this._adjustCameras()}_adjustCameras(){if(this._previousImage!=null){if(Di(this._currentImage.cameraType)){let e=this._camera.lookat.clone().sub(this._camera.position);this._currentCamera.lookat.copy(e.clone().add(this._currentCamera.position))}if(Di(this._previousImage.cameraType)){let e=this._currentCamera.lookat.clone().sub(this._currentCamera.position);this._previousCamera.lookat.copy(e.clone().add(this._previousCamera.position))}}}}class Tae{constructor(){const e=Bi[Bi.Custom],t=Bi[Bi.Earth],i=Bi[Bi.Traversing],r=Bi[Bi.Waiting],o=Bi[Bi.WaitingInteractively];this._creators=new Map;const c=this._creators;c.set(e,Mk),c.set(t,Ck),c.set(i,Pk),c.set(r,Ik),c.set(o,Ak),this._transitions=new Map;const s=this._transitions;s.set(e,[t,i]),s.set(t,[e,i]),s.set(i,[e,t,r,o]),s.set(r,[i,o]),s.set(o,[i,r])}getState(e){if(e instanceof Mk)return Bi.Custom;if(e instanceof Ck)return Bi.Earth;if(e instanceof Pk)return Bi.Traversing;if(e instanceof Ik)return Bi.Waiting;if(e instanceof Ak)return Bi.WaitingInteractively;throw new Error("Invalid state instance")}generate(e,t){const i=this._creators.get(Bi[e]);return new i(t)}transition(e,t){if(!this.validate(e,t))throw new Error("Invalid transition");return this.generate(t,e)}validate(e,t){const i=Bi[this.getState(e)],r=Bi[t],o=this._transitions;return o.has(i)&&o.get(i).includes(r)}}class Mae{constructor(e,t){this._transitions=new Tae,this._state=this._transitions.generate(e,{alpha:1,camera:new Ed,currentIndex:-1,reference:{alt:0,lat:0,lng:0},trajectory:[],transitionMode:t??Gw.Default,zoom:0})}get state(){return this._transitions.getState(this._state)}get reference(){return this._state.reference}get alpha(){return this._state.alpha}get stateTransitionAlpha(){return this._state.stateTransitionAlpha}get camera(){return this._state.camera}get zoom(){return this._state.zoom}get currentImage(){return this._state.currentImage}get previousImage(){return this._state.previousImage}get currentCamera(){return this._state.currentCamera}get currentTransform(){return this._state.currentTransform}get previousTransform(){return this._state.previousTransform}get trajectory(){return this._state.trajectory}get currentIndex(){return this._state.currentIndex}get lastImage(){return this._state.trajectory[this._state.trajectory.length-1]}get imagesAhead(){return this._state.trajectory.length-1-this._state.currentIndex}get motionless(){return this._state.motionless}custom(){this._transition(Bi.Custom)}earth(){this._transition(Bi.Earth)}traverse(){this._transition(Bi.Traversing)}wait(){this._transition(Bi.Waiting)}waitInteractively(){this._transition(Bi.WaitingInteractively)}getCenter(){return this._state.getCenter()}setCenter(e){this._state.setCenter(e)}setZoom(e){this._state.setZoom(e)}update(e){this._state.update(e)}append(e){this._state.append(e)}prepend(e){this._state.prepend(e)}remove(e){this._state.remove(e)}clear(){this._state.clear()}clearPrior(){this._state.clearPrior()}cut(){this._state.cut()}set(e){this._state.set(e)}setViewMatrix(e){this._state.setViewMatrix(e)}rotate(e){this._state.rotate(e)}rotateUnbounded(e){this._state.rotateUnbounded(e)}rotateWithoutInertia(e){this._state.rotateWithoutInertia(e)}rotateBasic(e){this._state.rotateBasic(e)}rotateBasicUnbounded(e){this._state.rotateBasicUnbounded(e)}rotateBasicWithoutInertia(e){this._state.rotateBasicWithoutInertia(e)}rotateToBasic(e){this._state.rotateToBasic(e)}move(e){this._state.move(e)}moveTo(e){this._state.moveTo(e)}zoomIn(e,t){this._state.zoomIn(e,t)}setSpeed(e){this._state.setSpeed(e)}setTransitionMode(e){this._state.setTransitionMode(e)}dolly(e){this._state.dolly(e)}orbit(e){this._state.orbit(e)}truck(e){this._state.truck(e)}_transition(e){if(!this._transitions.validate(this._state,e)){const i=this._transitions.getState(this._state);console.warn(`Transition not valid (${Bi[i]} - ${Bi[e]})`);return}const t=this._transitions.transition(this._state,e);this._state=t}}class Cae{constructor(e,t){this._appendImage$=new ri,this._clock=new zQ,this._subscriptions=new wo;const i=this._subscriptions;this._start$=new ri,this._frame$=new ri,this._contextOperation$=new Ph(c=>c),this._context$=this._contextOperation$.pipe(Vr((c,s)=>s(c),new Mae(e,t)),Ii(1),_i()),this._state$=this._context$.pipe(st(c=>c.state),yi(),Ii(1),_i()),this._currentState$=this._frame$.pipe(Ui(this._context$,(c,s)=>[c,s]),ai(c=>c[1].currentImage!=null),Dr(c=>{c[1].update(this._clock.getDelta())}),st(c=>({fps:60,id:c[0],state:c[1]})),pn()),this._lastState$=this._currentState$.pipe(Ii(1),_i());let r=this._currentState$.pipe(yi(void 0,c=>c.state.currentImage.id),Ii(1),_i()),o=new ri;i.push(r.subscribe(o)),this._currentId$=new Ph(null),i.push(o.pipe(st(c=>c.state.currentImage.id)).subscribe(this._currentId$)),this._currentImage$=o.pipe(st(c=>c.state.currentImage),Ii(1),_i()),this._currentCamera$=o.pipe(st(c=>c.state.currentCamera),Ii(1),_i()),this._currentTransform$=o.pipe(st(c=>c.state.currentTransform),Ii(1),_i()),this._reference$=o.pipe(st(c=>c.state.reference),yi((c,s)=>c.lat===s.lat&&c.lng===s.lng,c=>({lat:c.lat,lng:c.lng})),Ii(1),_i()),this._currentImageExternal$=r.pipe(st(c=>c.state.currentImage),Ii(1),_i()),i.push(this._appendImage$.pipe(st(c=>s=>(s.append([c]),s))).subscribe(this._contextOperation$)),this._inMotionOperation$=new ri,i.push(r.pipe(st(()=>!0)).subscribe(this._inMotionOperation$)),i.push(this._inMotionOperation$.pipe(yi(),ai(c=>c),ei(()=>this._currentState$.pipe(ai(c=>c.state.imagesAhead===0),st(c=>[c.state.camera.clone(),c.state.zoom]),rl(),st(c=>{let s=c[0][0],d=c[1][0],p=c[0][1],g=c[1][1];return s.diff(d)>1e-5||Math.abs(p-g)>1e-5}),wi(c=>!c)))).subscribe(this._inMotionOperation$)),this._inMotion$=this._inMotionOperation$.pipe(yi(),Ii(1),_i()),this._inTranslationOperation$=new ri,i.push(r.pipe(st(()=>!0)).subscribe(this._inTranslationOperation$)),i.push(this._inTranslationOperation$.pipe(yi(),ai(c=>c),ei(()=>this._currentState$.pipe(ai(c=>c.state.imagesAhead===0),st(c=>c.state.camera.position.clone()),rl(),st(c=>c[0].distanceToSquared(c[1])!==0),wi(c=>!c)))).subscribe(this._inTranslationOperation$)),this._inTranslation$=this._inTranslationOperation$.pipe(yi(),Ii(1),_i()),i.push(this._state$.subscribe(()=>{})),i.push(this._currentImage$.subscribe(()=>{})),i.push(this._currentCamera$.subscribe(()=>{})),i.push(this._currentTransform$.subscribe(()=>{})),i.push(this._reference$.subscribe(()=>{})),i.push(this._currentImageExternal$.subscribe(()=>{})),i.push(this._lastState$.subscribe(()=>{})),i.push(this._inMotion$.subscribe(()=>{})),i.push(this._inTranslation$.subscribe(()=>{})),this._frameId=null,this._frameGenerator=new Sae(window)}get currentState$(){return this._currentState$}get currentImage$(){return this._currentImage$}get currentId$(){return this._currentId$}get currentImageExternal$(){return this._currentImageExternal$}get currentCamera$(){return this._currentCamera$}get currentTransform$(){return this._currentTransform$}get state$(){return this._state$}get reference$(){return this._reference$}get inMotion$(){return this._inMotion$}get inTranslation$(){return this._inTranslation$}get appendImage$(){return this._appendImage$}dispose(){this.stop(),this._subscriptions.unsubscribe()}custom(){this._inMotionOperation$.next(!0),this._invokeContextOperation(e=>{e.custom()})}earth(){this._inMotionOperation$.next(!0),this._invokeContextOperation(e=>{e.earth()})}traverse(){this._inMotionOperation$.next(!0),this._invokeContextOperation(e=>{e.traverse()})}wait(){this._invokeContextOperation(e=>{e.wait()})}waitInteractively(){this._invokeContextOperation(e=>{e.waitInteractively()})}appendImagess(e){this._invokeContextOperation(t=>{t.append(e)})}prependImages(e){this._invokeContextOperation(t=>{t.prepend(e)})}removeImages(e){this._invokeContextOperation(t=>{t.remove(e)})}clearImages(){this._invokeContextOperation(e=>{e.clear()})}clearPriorImages(){this._invokeContextOperation(e=>{e.clearPrior()})}cutImages(){this._invokeContextOperation(e=>{e.cut()})}setImages(e){this._invokeContextOperation(t=>{t.set(e)})}setViewMatrix(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.setViewMatrix(e)})}rotate(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.rotate(e)})}rotateUnbounded(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.rotateUnbounded(e)})}rotateWithoutInertia(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.rotateWithoutInertia(e)})}rotateBasic(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.rotateBasic(e)})}rotateBasicUnbounded(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.rotateBasicUnbounded(e)})}rotateBasicWithoutInertia(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.rotateBasicWithoutInertia(e)})}rotateToBasic(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.rotateToBasic(e)})}move(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.move(e)})}moveTo(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.moveTo(e)})}dolly(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.dolly(e)})}orbit(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.orbit(e)})}truck(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.truck(e)})}zoomIn(e,t){this._inMotionOperation$.next(!0),this._invokeContextOperation(i=>{i.zoomIn(e,t)})}getCenter(){return this._lastState$.pipe(wi(),st(e=>e.state.getCenter()))}getZoom(){return this._lastState$.pipe(wi(),st(e=>e.state.zoom))}setCenter(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.setCenter(e)})}setSpeed(e){this._invokeContextOperation(t=>{t.setSpeed(e)})}setTransitionMode(e){this._invokeContextOperation(t=>{t.setTransitionMode(e)})}setZoom(e){this._inMotionOperation$.next(!0),this._invokeContextOperation(t=>{t.setZoom(e)})}start(){this._clock.start(),this._frameId==null&&(this._start$.next(null),this._frameId=this._frameGenerator.requestAnimationFrame(this._frame.bind(this)),this._frame$.next(this._frameId))}stop(){this._clock.stop(),this._frameId!=null&&(this._frameGenerator.cancelAnimationFrame(this._frameId),this._frameId=null)}_invokeContextOperation(e){this._contextOperation$.next(t=>(e(t),t))}_frame(){this._frameId=this._frameGenerator.requestAnimationFrame(this._frame.bind(this)),this._frame$.next(this._frameId)}}function ON(n){switch(n){case wh.Custom:return Bi.Custom;case wh.Earth:return Bi.Earth;case wh.Street:return Bi.Traversing;default:return null}}class Eae{constructor(e,t,i,r,o,c,s,d){var p;t?this._api=t:e.dataProvider?this._api=new Tk(e.dataProvider):this._api=new Tk(new sae({accessToken:e.accessToken})),this._graphService=i??new wae(new qy(this.api)),this._loadingName="navigator",this._loadingService=r??new bae;const g=(p=e.cameraControls)!==null&&p!==void 0?p:wh.Street;this._stateService=o??new Cae(ON(g),e.transitionMode),this._cacheService=c??new yae(this._graphService,this._stateService,this._api),this._playService=s??new M0(this._graphService,this._stateService),this._panService=d??new xae(this._graphService,this._stateService,e.combinedPanning),this._idRequested$=new Ph(null),this._movedToId$=new Ph(null),this._request$=null,this._requestSubscription=null,this._imageRequestSubscription=null}get api(){return this._api}get cacheService(){return this._cacheService}get graphService(){return this._graphService}get loadingService(){return this._loadingService}get movedToId$(){return this._movedToId$}get panService(){return this._panService}get playService(){return this._playService}get stateService(){return this._stateService}dispose(){this._abortRequest("viewer removed"),this._cacheService.stop(),this._graphService.dispose(),this._panService.dispose(),this._playService.dispose(),this._stateService.dispose()}moveTo$(e){this._abortRequest(`to id ${e}`),this._loadingService.startLoading(this._loadingName);const t=this._moveTo$(e);return this._makeRequest$(t)}moveDir$(e){this._abortRequest(`in dir ${Vt[e]}`),this._loadingService.startLoading(this._loadingName);const t=this.stateService.currentImage$.pipe(wi(),Hi(i=>([Vt.Next,Vt.Prev].indexOf(e)>-1?i.sequenceEdges$:i.spatialEdges$).pipe(wi(),st(r=>{for(let o of r.edges)if(o.data.direction===e)return o.target;return null}))),Hi(i=>i==null?(this._loadingService.stopLoading(this._loadingName),Xx(new Error(`Direction (${e}) does not exist for current image.`))):this._moveTo$(i)));return this._makeRequest$(t)}setFilter$(e){return this._stateService.clearImages(),this._movedToId$.pipe(wi(),Hi(t=>t!=null?this._trajectoryIds$().pipe(Hi(i=>this._graphService.setFilter$(e).pipe(Hi(()=>this._cacheIds$(i)))),Wg()):this._idRequested$.pipe(wi(),Hi(i=>i!=null?this._graphService.setFilter$(e).pipe(Hi(()=>this._graphService.cacheImage$(i))):this._graphService.setFilter$(e).pipe(st(()=>{}))))),st(()=>{}))}setAccessToken$(e){return this._abortRequest("to set user token"),this._stateService.clearImages(),this._movedToId$.pipe(wi(),Dr(()=>{this._api.setAccessToken(e)}),Hi(t=>t==null?this._graphService.reset$([]):this._trajectoryIds$().pipe(Hi(i=>this._graphService.reset$(i).pipe(Hi(()=>this._cacheIds$(i)))),Wg(),st(()=>{}))))}_cacheIds$(e){const t=e.map(i=>this._graphService.cacheImage$(i));return Fr(t).pipe(lp())}_abortRequest(e){this._requestSubscription!=null&&(this._requestSubscription.unsubscribe(),this._requestSubscription=null),this._imageRequestSubscription!=null&&(this._imageRequestSubscription.unsubscribe(),this._imageRequestSubscription=null),this._request$!=null&&(this._request$.isStopped||this._request$.hasError||this._request$.error(new Ul(`Request aborted by a subsequent request ${e}.`)),this._request$=null)}_makeRequest$(e){const t=new wO(1);return this._requestSubscription=t.subscribe(void 0,()=>{}),this._request$=t,this._imageRequestSubscription=e.subscribe(i=>{this._request$=null,t.next(i),t.complete()},i=>{this._request$=null,t.error(i)}),t}_moveTo$(e){return this._idRequested$.next(e),this._graphService.cacheImage$(e).pipe(Dr(t=>{this._stateService.setImages([t]),this._movedToId$.next(t.id)}),va(()=>{this._loadingService.stopLoading(this._loadingName)}))}_trajectoryIds$(){return this._stateService.currentState$.pipe(wi(),st(e=>e.state.trajectory.map(t=>t.id)))}}class Aae{constructor(e,t){this._spatial=t??new xo,this._viewportCoords=e??new $o}basicToCanvas(e,t,i,r){return this._viewportCoords.basicToCanvasSafe(e[0],e[1],t,r,i.perspective)}canvasToBasic(e,t,i,r){let o=this._viewportCoords.canvasToBasic(e[0],e[1],t,r,i.perspective);return(o[0]<0||o[0]>1||o[1]<0||o[1]>1)&&(o=null),o}eventToUnprojection(e,t,i,r,o){const c=this._viewportCoords.canvasPosition(e,t);return this.canvasToUnprojection(c,t,i,r,o)}canvasToUnprojection(e,t,i,r,o){const c=e[0],s=e[1],[d,p]=this._viewportCoords.canvasToViewport(c,s,t),g=new Ge(d,p,1).unproject(i.perspective);let _=o.projectBasic(g.toArray());(_[0]<0||_[0]>1||_[1]<0||_[1]>1)&&(_=null);const x=g.clone().sub(i.camera.position).normalize(),b=-2/x.z;let S=null;if(b>0&&b<100&&_){const L=x.clone().multiplyScalar(b).add(i.camera.position),[E,C]=vp(L.x,L.y,L.z,r.lng,r.lat,r.alt);S={lat:C,lng:E}}return{basicPoint:_,lngLat:S,pixelPoint:[c,s]}}cameraToLngLat(e,t){const i=e.camera.position,[r,o]=vp(i.x,i.y,i.z,t.lng,t.lat,t.alt);return{lat:o,lng:r}}lngLatToCanvas(e,t,i,r){const o=ra(e.lng,e.lat,0,r.lng,r.lat,r.alt);return this._viewportCoords.projectToCanvasSafe(o,t,i.perspective)}distanceBetweenLngLats(e,t){return this._spatial.distanceFromLngLat(e.lng,e.lat,t.lng,t.lat)}}class Pae{constructor(e,t,i){this._subscriptions=new wo,this._emitSubscriptions=new wo,this._container=i,this._viewer=e,this._navigator=t,this._projection=new Aae,this._started=!1,this._navigable$=new ri;const r=this._subscriptions;r.push(this._navigable$.subscribe(o=>{const c="navigable",s={navigable:o,target:this._viewer,type:c};this._viewer.fire(c,s)})),r.push(this._navigator.loadingService.loading$.subscribe(o=>{const c="dataloading",s={loading:o,target:this._viewer,type:c};this._viewer.fire(c,s)})),r.push(this._container.glRenderer.opaqueRender$.pipe(wi()).subscribe(()=>{const o="load",c={target:this._viewer,type:o};this._viewer.fire(o,c)}))}get started(){return this._started}get navigable$(){return this._navigable$}get projection(){return this._projection}dispose(){this.stopEmit(),this._subscriptions.unsubscribe()}project$(e){return Si(this._container.renderService.renderCamera$,this._navigator.stateService.currentImage$,this._navigator.stateService.reference$).pipe(wi(),st(([t,i,r])=>{if(this._projection.distanceBetweenLngLats(e,i.lngLat)>1e3)return null;const o=this._projection.lngLatToCanvas(e,this._container.container,t,r);return o?[Math.round(o[0]),Math.round(o[1])]:null}))}projectBasic$(e){return Si(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$).pipe(wi(),st(([t,i])=>{const r=this._projection.basicToCanvas(e,this._container.container,t,i);return r?[Math.round(r[0]),Math.round(r[1])]:null}))}startEmit(){if(this._started)return;this._started=!0;const e=this._emitSubscriptions;e.push(this._navigator.stateService.currentImageExternal$.subscribe(i=>{const r="image",o={image:i,target:this._viewer,type:r};this._viewer.fire(r,o)})),e.push(this._navigator.stateService.currentImageExternal$.pipe(ei(i=>i.sequenceEdges$)).subscribe(i=>{const r="sequenceedges",o={status:i,target:this._viewer,type:r};this._viewer.fire(r,o)})),e.push(this._navigator.stateService.currentImageExternal$.pipe(ei(i=>i.spatialEdges$)).subscribe(i=>{const r="spatialedges",o={status:i,target:this._viewer,type:r};this._viewer.fire(r,o)})),e.push(this._navigator.stateService.reference$.subscribe(i=>{const r="reference",o={reference:i,target:this._viewer,type:r};this._viewer.fire(r,o)})),e.push(Si(this._navigator.stateService.inMotion$,this._container.mouseService.active$,this._container.touchService.active$).pipe(st(i=>i[0]||i[1]||i[2]),yi()).subscribe(i=>{const r=i?"movestart":"moveend",o={target:this._viewer,type:r};this._viewer.fire(r,o)})),e.push(this._container.renderService.bearing$.pipe($O(100),yi((i,r)=>Math.abs(r-i)<1)).subscribe(i=>{const r="bearing",o={bearing:i,target:this._viewer,type:r};this._viewer.fire(r,o)}));const t=this._container.mouseService.active$.pipe(ei(i=>i?Ni():this._container.mouseService.mouseMove$));e.push(mn(this._mapMouseEvent$("click",this._container.mouseService.staticClick$),this._mapMouseEvent$("contextmenu",this._container.mouseService.contextMenu$),this._mapMouseEvent$("dblclick",this._container.mouseService.dblClick$),this._mapMouseEvent$("mousedown",this._container.mouseService.mouseDown$),this._mapMouseEvent$("mousemove",t),this._mapMouseEvent$("mouseout",this._container.mouseService.mouseOut$),this._mapMouseEvent$("mouseover",this._container.mouseService.mouseOver$),this._mapMouseEvent$("mouseup",this._container.mouseService.mouseUp$)).pipe(Ui(this._container.renderService.renderCamera$,this._navigator.stateService.reference$,this._navigator.stateService.currentTransform$,this._navigator.stateService.state$),st(([[i,r],o,c,s,d])=>{const p=this._projection.eventToUnprojection(r,this._container.container,o,c,s);return{basicPoint:d===Bi.Traversing?p.basicPoint:null,lngLat:p.lngLat,originalEvent:r,pixelPoint:p.pixelPoint,target:this._viewer,type:i}})).subscribe(i=>{this._viewer.fire(i.type,i)})),e.push(this._container.renderService.renderCamera$.pipe(yi(([i,r],[o,c])=>this._closeTo(i,o,.01)&&this._closeTo(r,c,.01),i=>i.camera.position.toArray())).subscribe(()=>{const i="position",r={target:this._viewer,type:i};this._viewer.fire(i,r)})),e.push(this._container.renderService.renderCamera$.pipe(yi(([i,r],[o,c])=>this._closeTo(i,o,.001)&&this._closeTo(r,c,.001),i=>[i.rotation.phi,i.rotation.theta])).subscribe(()=>{const r={target:this._viewer,type:"pov"};this._viewer.fire("pov",r)})),e.push(this._container.renderService.renderCamera$.pipe(yi((i,r)=>this._closeTo(i,r,.01),i=>i.perspective.fov)).subscribe(()=>{const r={target:this._viewer,type:"fov"};this._viewer.fire("fov",r)}))}stopEmit(){this.started&&(this._emitSubscriptions.unsubscribe(),this._started=!1)}unproject$(e){return Si(this._container.renderService.renderCamera$,this._navigator.stateService.reference$,this._navigator.stateService.currentTransform$).pipe(wi(),st(([t,i,r])=>this._projection.canvasToUnprojection(e,this._container.container,t,i,r).lngLat))}unprojectBasic$(e){return Si(this._container.renderService.renderCamera$,this._navigator.stateService.currentTransform$).pipe(wi(),st(([t,i])=>this._projection.canvasToBasic(e,this._container.container,t,i)))}_closeTo(e,t,i){return Math.abs(e-t)<=i}_mapMouseEvent$(e,t){return t.pipe(st(i=>[e,i]))}}class Iae{constructor(e,t){this._container=e,this._navigator=t,this._renderers={}}add(e,t){const i=new wo;this._renderers[e.id]={subs:i,renderer:e},i.push(Si([this._container.glRenderer.webGLRenderer$,this._navigator.stateService.reference$]).pipe(Vl(1)).subscribe(([r,o])=>{e.onAdd(t,o,r.getContext())})),i.push(this._container.glRenderer.opaqueRender$.pipe(Ui(this._container.renderService.renderCamera$,this._container.glRenderer.webGLRenderer$)).subscribe(([,r,o])=>{const c=o.getContext(),s=r.perspective.matrixWorldInverse,d=r.perspective.projectionMatrix;e.render(c,s.toArray(),d.toArray())})),i.push(this._navigator.stateService.reference$.pipe(Ks(1)).subscribe(r=>{e.onReference(t,r)}))}dispose(e){for(const t of Object.keys(this._renderers))this.remove(t,e)}has(e){return e in this._renderers}remove(e,t){this._renderers[e].subs.unsubscribe();const i=this._renderers[e].renderer;delete this._renderers[e],this._container.glRenderer.webGLRenderer$.subscribe(r=>{i.onRemove(t,r.getContext())})}}class Rae{constructor(e,t){this._container=e,this._navigator=t,this._controls=null,this._subscriptions=new wo}attach(e,t){if(this._controls)throw new ur("Custom camera controls already attached");this._controls=e;const i=new ri,r=i.pipe(ei(()=>this._navigator.stateService.state$),st(c=>c===Bi.Custom),yi()),o=this._subscriptions;o.push(r.pipe(An(!1),rl(),Ui(this._navigator.stateService.reference$,this._container.renderService.renderCamera$)).subscribe(([[c,s],d,p])=>{s?e.onActivate(t,p.perspective.matrixWorldInverse.toArray(),p.perspective.projectionMatrix.toArray(),d):c&&e.onDeactivate(t)})),o.push(r.pipe(ei(c=>c?this._navigator.stateService.currentState$.pipe(Ks(1)):Ni())).subscribe(c=>{e.onAnimationFrame(t,c.id)})),o.push(r.pipe(ei(c=>c?this._navigator.stateService.reference$.pipe(Ks(1)):Ni())).subscribe(c=>e.onReference(t,c))),o.push(r.pipe(ei(c=>c?this._container.renderService.size$.pipe(Ks(1)):Ni())).subscribe(()=>e.onResize(t))),o.push(Si([this._container.glRenderer.webGLRenderer$,this._container.renderService.renderCamera$,this._navigator.stateService.reference$,this._navigator.stateService.state$]).pipe(wi()).subscribe(()=>{const c=d=>{!this._controls||e!==this._controls||this._updateProjectionMatrix(d)},s=d=>{!this._controls||e!==this._controls||this._updateViewMatrix(d)};e.onAttach(t,s,c),i.next(),i.complete()}))}detach(e){const t=this._controls;return this._controls=null,this._subscriptions.unsubscribe(),new Promise(i=>{this._navigator.stateService.state$.pipe(Vl(1)).subscribe(r=>{if(!t){i(null);return}r===Bi.Custom&&t.onDeactivate(e),t.onDetach(e),i(t)})})}dispose(e){this.detach(e)}has(e){return!!this._controls&&e===this._controls}_updateProjectionMatrix(e){this._navigator.stateService.state$.pipe(wi()).subscribe(t=>{if(t!==Bi.Custom){console.warn("Incorrect camera control mode for projection matrix update");return}this._container.renderService.projectionMatrix$.next(e)})}_updateViewMatrix(e){this._navigator.stateService.state$.pipe(wi()).subscribe(t=>{if(t!==Bi.Custom){console.warn("Incorrect camera control mode for view matrix update");return}this._navigator.stateService.setViewMatrix(e)})}}class Lae extends C1{constructor(e){super(),this._navigator=new Eae(e),this._container=new vae(e,this._navigator.stateService),this._observer=new Pae(this,this._navigator,this._container),this._componentController=new oae(this._container,this._navigator,this._observer,e.imageId,e.component),this._customRenderer=new Iae(this._container,this._navigator),this._customCameraControls=new Rae(this._container,this._navigator)}get dataProvider(){return this._navigator.api.data}get isNavigable(){return this._componentController.navigable}activateCombinedPanning(){this._navigator.panService.enable()}activateComponent(e){this._componentController.activate(e)}activateCover(){this._componentController.activateCover()}addCustomRenderer(e){this._customRenderer.add(e,this)}attachCustomCameraControls(e){this._customCameraControls.attach(e,this)}deactivateCombinedPanning(){this._navigator.panService.disable()}deactivateComponent(e){this._componentController.deactivate(e)}deactivateCover(){this._componentController.deactivateCover()}detachCustomCameraControls(){return this._customCameraControls.detach(this)}fire(e,t){super.fire(e,t)}getBearing(){return new Promise((e,t)=>{this._container.renderService.bearing$.pipe(wi()).subscribe(i=>{e(i)},i=>{t(i)})})}getCameraControls(){return new Promise((e,t)=>{this._navigator.stateService.state$.pipe(wi()).subscribe(i=>{switch(i){case Bi.Custom:e(wh.Custom);break;case Bi.Earth:e(wh.Earth);break;default:e(wh.Street);break}},i=>{t(i)})})}getCanvas(){return this._container.canvas}getCanvasContainer(){return this._container.canvasContainer}getCenter(){return new Promise((e,t)=>{this._navigator.stateService.getCenter().subscribe(i=>{e(i)},i=>{t(i)})})}getComponent(e){return this._componentController.get(e)}getContainer(){return this._container.container}getFieldOfView(){return new Promise((e,t)=>{this._container.renderService.renderCamera$.pipe(wi()).subscribe(i=>{e(i.perspective.fov)},i=>{t(i)})})}getImage(){return new Promise((e,t)=>{this._navigator.stateService.currentImage$.pipe(wi()).subscribe(i=>{e(i)},i=>{t(i)})})}getPointOfView(){return new Promise((e,t)=>{Si(this._container.renderService.renderCamera$,this._container.renderService.bearing$).pipe(wi()).subscribe(([i,r])=>{e({bearing:r,tilt:i.getTilt()})},i=>{t(i)})})}getPosition(){return new Promise((e,t)=>{Si(this._container.renderService.renderCamera$,this._navigator.stateService.reference$).pipe(wi()).subscribe(([i,r])=>{e(this._observer.projection.cameraToLngLat(i,r))},i=>{t(i)})})}getReference(){return new Promise((e,t)=>{this._navigator.stateService.reference$.pipe(wi()).subscribe(i=>{e(i)},i=>{t(i)})})}getZoom(){return new Promise((e,t)=>{this._navigator.stateService.getZoom().subscribe(i=>{e(i)},i=>{t(i)})})}hasCustomCameraControls(e){return this._customCameraControls.has(e)}hasCustomRenderer(e){return this._customRenderer.has(e)}moveDir(e){const t=this.isNavigable?this._navigator.moveDir$(e):Xx(new Error("Calling moveDir is not supported when viewer is not navigable."));return new Promise((i,r)=>{t.subscribe(o=>{i(o)},o=>{r(o)})})}moveTo(e){const t=this.isNavigable?this._navigator.moveTo$(e):Xx(new Error("Calling moveTo is not supported when viewer is not navigable."));return new Promise((i,r)=>{t.subscribe(o=>{i(o)},o=>{r(o)})})}off(e,t){super.off(e,t)}on(e,t){super.on(e,t)}project(e){return new Promise((t,i)=>{this._observer.project$(e).subscribe(r=>{t(r)},r=>{i(r)})})}projectFromBasic(e){return new Promise((t,i)=>{this._observer.projectBasic$(e).subscribe(r=>{t(r)},r=>{i(r)})})}remove(){this._customRenderer.dispose(this),this._customCameraControls.dispose(this),this._observer.dispose(),this._componentController.remove(),this._navigator.dispose(),this._container.remove();const e="remove",t={target:this,type:e};this.fire(e,t)}removeCustomRenderer(e){this._customRenderer.remove(e,this)}resize(){this._container.renderService.resize$.next()}setCameraControls(e){const t=ON(e);t===Bi.Traversing?this._navigator.stateService.traverse():t===Bi.Earth?this._navigator.stateService.earth():t===Bi.Custom?this._navigator.stateService.custom():console.warn(`Unsupported camera control transition (${e})`)}setCenter(e){this._navigator.stateService.setCenter(e)}setFieldOfView(e){this._container.renderService.renderCamera$.pipe(wi()).subscribe(t=>{const i=t.fovToZoom(e);this._navigator.stateService.setZoom(i)})}setFilter(e){return new Promise((t,i)=>{this._navigator.setFilter$(e).subscribe(()=>{t(void 0)},r=>{i(r)})})}setRenderMode(e){this._container.renderService.renderMode$.next(e)}setTransitionMode(e){this._navigator.stateService.setTransitionMode(e)}setAccessToken(e){const t=this.isNavigable?this._navigator.setAccessToken$(e):Xx(new Error("Calling setAccessToken is not supported when viewer is not navigable."));return new Promise((i,r)=>{t.subscribe(()=>{i(void 0)},o=>{r(o)})})}setZoom(e){this._navigator.stateService.setZoom(e)}triggerRerender(){this._container.glRenderer.triggerRerender()}unproject(e){return new Promise((t,i)=>{this._observer.unproject$(e).subscribe(r=>{t(r)},r=>{i(r)})})}unprojectToBasic(e){return new Promise((t,i)=>{this._observer.unprojectBasic$(e).subscribe(r=>{t(r)},r=>{i(r)})})}}qy.register(Kz);Wy.register(Kz);Cr.registerCover(PB);Cr.register(IB);Cr.register(RB);Cr.register(LB);Cr.register(kB);Cr.register(VB);Cr.register(UB);Cr.register(jB);Cr.register(qB);Cr.register(WB);Cr.register(HB);Cr.register(ZB);Cr.register(KB);Cr.register(dN);Cr.register(fN);Cr.register(pN);Cr.register(mN);const kae="data:image/svg+xml,%3c?xml%20version='1.0'%20encoding='UTF-8'?%3e%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%20height='256'%20width='256'%20version='1.1'%3e%3cpath%20d='M0,0%20h100%20v100%20h-100z'%20fill='%2335af6d'/%3e%3cpath%20d='M42.71,66.19A2.5,2.5%200,0,1%2039.32,67.2L5.08,48.69A2.5,2.5%200,0,1%205.48,44.12L33.27,34.85A2.5,2.5%200,0,0%2034.85,33.27L44.12,5.48A2.5,2.5%200,0,1%2048.69,5.08L67.2,39.32A2.5,2.5%200,0,1%2066.19,42.71L61.79,45.09A2.5,2.5%200,0,1%2058.4,44.08L50.88,30.15A2.5,2.5%200,0,0%2046.3,30.55L42.76,41.18A2.5,2.5%200,0,1%2041.18,42.76L30.55,46.3A2.5,2.5%200,0,0%2030.15,50.88L44.08,58.4A2.5,2.5%200,0,1%2045.09,61.79zM68.33,46.67A2.5,2.5%200,0,1%2071.72,47.68L96.01,92.63A2.5,2.5%200,0,1%2092.63,96.01L47.68,71.72A2.5,2.5%200,0,1%2046.67,68.33L49.05,63.93A2.5,2.5%200,0,1%2052.43,62.92L67.89,71.27A2.5,2.5%200,0,0%2071.27,67.89L62.92,52.43A2.5,2.5%200,0,1%2063.93,49.05z'%20fill='%23fff'%20transform='scale(.79)%20translate(10.5,10.5)'/%3e%3c/svg%3e";function zN(n,e,t,i={}){const r=Mg(n),o=mh(r[0]),c=mh(r[1]),s=mh(t),d=OV(e,i.units),p=Math.asin(Math.sin(c)*Math.cos(d)+Math.cos(c)*Math.sin(d)*Math.cos(s)),g=o+Math.atan2(Math.sin(s)*Math.sin(d)*Math.cos(c),Math.cos(d)-Math.sin(c)*Math.sin(p)),_=aw(g),x=aw(p);return r[2]!==void 0?Qf([_,x,r[2]],i.properties):Qf([_,x],i.properties)}function Dae(n,e,t={}){const i=t.steps||64,r=t.properties?t.properties:!Array.isArray(n)&&n.type==="Feature"&&n.properties?n.properties:{},o=[];for(let c=0;c<i;c++)o.push(zN(n,e,c*-360/i,t).geometry.coordinates);return o.push(o[0]),DV([o],r)}function Fae(n,e,t,i,r={}){const o=r.steps||64,c=Rk(t),s=Rk(i),d=!Array.isArray(n)&&n.type==="Feature"?n.properties:{};if(c===s)return iI(Dae(n,e,r).geometry.coordinates[0],d);const p=c,g=c<s?s:s+360;let _=p;const x=[];let b=0;const S=(g-p)/o;for(;_<=g;)x.push(zN(n,e,_,r).geometry.coordinates),b++,_=p+b*S;return iI(x,d)}function Rk(n){let e=n%360;return e<0&&(e+=360),e}var Oae=Fae,zae=Wt("<!> <!> <!> <!>",1),Bae=Wt("<!> <!>",1),Nae=Wt('<button class="btn btn-secondary"><img alt="Mapillary" height="30px"/></button> <!> <!> <div class="viewer-container svelte-cogdew"><button class="btn btn-primary">X</button> <div style="width: 100%; height: 100%"></div></div>',1);function $ae(n,e){en(e,!0);let t=ii(!1),i=ii(void 0),r=ii(void 0),o=ii(void 0),c=ii(0);Ta(()=>{ee(r)?.remove()}),cn(()=>{ee(i)&&bs(()=>{Et(r,new Lae({accessToken:s,container:ee(i)}),!0),ee(r).on("position",async D=>{let O=await ee(r).getPosition();Et(o,[O.lng,O.lat],!0)}),ee(r).on("bearing",D=>{Et(c,D.bearing,!0)})})});let s="MLY|25548189401504437|3c9576aa434c09888b5de1c28f13b1df";async function d(D){ee(r)?.resize(),await ee(r)?.moveTo(D)}let p=Kt(()=>{if(!ee(o))return ro();let O=Oae(Qf(ee(o)),30,ee(c)-30,ee(c)+30,{units:"meters"});return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[ee(o),...O.geometry.coordinates,ee(o)]]}}});var g=Nae(),_=ci(g);_.__click=()=>Et(t,!0);var x=Ft(_),b=gt(_,2);RU(b,{tiles:[`https://tiles.mapillary.com/maps/vtp/mly1_public/2/{z}/{x}/{y}?access_token=${s}`],maxzoom:14,children:(D,O)=>{var U=zae(),j=ci(U);{let q=Kt(()=>({visibility:ee(t)?"visible":"none"}));tl(j,{sourceLayer:"sequence",paint:{"line-width":2,"line-color":["case",["get","is_pano"],"blue","green"]},get layout(){return ee(q)}})}var G=gt(j,2);{let q=Kt(()=>({visibility:ee(t)?"visible":"none","icon-image":"chevron","icon-rotate":["get","compass_angle"],"icon-offset":[15,0]}));Uv(G,{minzoom:16,sourceLayer:"image",get layout(){return ee(q)}})}var N=gt(G,2);{let q=Kt(()=>({"circle-radius":8,"circle-color":Gg("transparent","orange"),"circle-stroke-color":"black","circle-stroke-width":Gg(0,2)})),z=Kt(()=>({visibility:ee(t)?"visible":"none"}));cu(N,{sourceLayer:"image",manageHoverState:!0,get paint(){return ee(q)},get layout(){return ee(z)},hoverCursor:"pointer",onclick:Q=>d(Q.features[0].properties.id)})}var V=gt(N,2);{let q=Kt(()=>({visibility:ee(t)?"visible":"none"}));cu(V,{sourceLayer:"image",paint:{"circle-radius":4,"circle-color":["case",["get","is_pano"],"blue","green"],"circle-stroke-color":"black","circle-stroke-width":1},get layout(){return ee(q)}})}xt(D,U)},$$slots:{default:!0}});var S=gt(b,2);Ws(S,{get data(){return ee(p)},children:(D,O)=>{var U=Bae(),j=ci(U);{let N=Kt(()=>({visibility:ee(t)?"visible":"none"}));hC(j,{paint:{"fill-color":"orange","fill-opacity":.8},get layout(){return ee(N)}})}var G=gt(j,2);{let N=Kt(()=>({visibility:ee(t)?"visible":"none"}));tl(G,{paint:{"line-width":2,"line-color":"black"},get layout(){return ee(N)}})}xt(D,U)},$$slots:{default:!0}});var P=gt(S,2);let L;var E=Ft(P);E.__click=()=>Et(t,!1);var C=gt(E,2);Sc(C,D=>Et(i,D),()=>ee(i)),Zi(()=>{_.disabled=ee(t),Nl(x,"src",kae),L=go(P,"",L,{visibility:ee(t)?"visible":"hidden"})}),xt(n,g),tn()}ds(["click"]);var Vae=Wt('<div class="action-bar svelte-1pbywzu"><!> <!> <!> <!></div>');function Uae(n,e){en(e,!0);let t=ft(e,"basemap",15),i="60px";var r=Vae();go(r,"",{},{bottom:i});var o=Ft(r);T7(o,{get basemap(){return t()},set basemap(p){t(p)}});var c=gt(o,2);k7(c,{});var s=gt(c,2);$ae(s,{});var d=gt(s,2);q7(d),xt(n,r),tn()}let hp={RoadWithSeparate:"purple",RoadWithTags:"blue",RoadWithoutSidewalksExplicit:"#8B4000",RoadWithoutSidewalksImplicit:"orange",RoadUnknown:"#ff69b4",Sidewalk:"black",Crossing:"green",Other:"grey"};const BN={left:[255,105,180],right:[32,178,170]};function Ox(n,e=1){return["rgba",...BN[n],e]}function Hf(n,e=1){const[t,i,r]=BN[n];return`rgba(${t}, ${i}, ${r}, ${e})`}let jae={RoadWithSeparate:"With separate sidewalks",RoadWithTags:"With tagged sidewalks",RoadWithoutSidewalksExplicit:"Tagged as no sidewalks",RoadWithoutSidewalksImplicit:"Assumed as no sidewalks",RoadUnknown:"Totally unknown",Sidewalk:"Separate sidewalk",Crossing:"Crossing",Other:"Other"};function Md(n){return["interpolate",["linear"],["zoom"],5,.5+n,10,1+n,12,1.5+n,14,4+n,16,Ly(["get","kind"],{Sidewalk:4+n,Crossing:5+n,Other:5+n},7+n),20,Ly(["get","kind"],{Sidewalk:7+n,Crossing:10+n,Other:10+n},24+n)]}var Gae=Wt("<!> <!> <!>",1),qae=Wt("<!> <!>",1),Wae=Wt("<!> <!> <!> <!> <!> <!> <!> <!>",1);function Hae(n,e){en(e,!0);const t=()=>Qi(Fh,"$map",c),i=()=>Qi(zs,"$backend",c),r=()=>Qi(xw,"$debugMode",c),o=()=>Qi(sa,"$mutationCounter",c),[c,s]=qr();let d=ft(e,"pinnedWay",15),p=ft(e,"drawProblemDetails",15);function g(G){d(null);for(let N of t().queryRenderedFeatures(G.point,{layers:["speedwalk-ways"]})){d(e.ways.features.find(V=>V.id==N.id));break}}let _=Kt(()=>i()&&d()?JSON.parse(i().getSideLocations(BigInt(d().properties.id))):ro());cn(()=>{let G=ro();if(d())for(let N of d().properties.problems)G.features=[...G.features,...N.details];p(G)});function x(G){let N=ro();if(G)for(let[V,q]of G.properties.node_ids.entries()){let z=e.nodes.features.find(Q=>Q.properties.id==q);N.features.push({type:"Feature",geometry:z.geometry,properties:{idx:V}})}return N}function b(G,N){if(!G||!N)return ro();let V=parseInt(G.properties.tags["tmp:closest_way"]);if(!V)return ro();for(let q of e.ways.features)if(q.properties.id==V){let z=JSON.parse(JSON.stringify(q));return z.properties.left=G.properties.tags["tmp:side"]=="Left",{type:"FeatureCollection",features:[z]}}return ro()}var S=Wae(),P=ci(S);pF(P,{onclick:g});var L=gt(P,2);{let G=Kt(()=>d()||ro());Ws(L,{get data(){return ee(G)},children:(N,V)=>{var q=Gae(),z=ci(q);{let re=Kt(()=>({"line-width":Md(50),"line-color":Ox("left",.3),"line-offset":-35}));tl(z,{beforeId:"Road labels",get paint(){return ee(re)}})}var Q=gt(z,2);{let re=Kt(()=>({"line-width":Md(50),"line-color":Ox("right",.3),"line-offset":35}));tl(Q,{beforeId:"Road labels",get paint(){return ee(re)}})}var X=gt(Q,2);Uv(X,{minzoom:12,layout:{"icon-image":"arrow","icon-size":1,"symbol-placement":"line","symbol-spacing":50,"icon-allow-overlap":!0}}),xt(N,q)},$$slots:{default:!0}})}var E=gt(L,2);{let G=Kt(()=>b(d(),r()));Ws(E,{get data(){return ee(G)},children:(N,V)=>{{let q=Kt(()=>({"line-width":Md(10),"line-color":"blue","line-opacity":.5,"line-offset":["case",["get","left"],-5,5]}));tl(N,{beforeId:"Road labels",get paint(){return ee(q)}})}},$$slots:{default:!0}})}var C=gt(E,2);Ws(C,{get data(){return e.ways},children:(G,N)=>{{let V=Kt(()=>({"line-width":Md(0),"line-color":Ly(["get","kind"],hp,"cyan")}));tl(G,{id:"speedwalk-ways",beforeId:"Road labels",manageHoverState:!0,hoverCursor:"pointer",get filter(){return e.filterWays},get paint(){return ee(V)}})}},$$slots:{default:!0}});var D=gt(C,2);a0(D,o,G=>{{let N=Kt(()=>i()?JSON.parse(i().getRoadSides()):ro());Ws(G,{get data(){return ee(N)},children:(V,q)=>{{let z=Kt(()=>({visibility:e.showRoadSides?"visible":"none","text-field":["get","sidewalks"],"text-size":15,"symbol-placement":"line","symbol-spacing":30,"text-allow-overlap":!0,"text-rotation-alignment":"viewport"}));Uv(V,{minzoom:16,paint:{"text-color":"white","text-halo-color":"black","text-halo-width":2},get layout(){return ee(z)}})}},$$slots:{default:!0}})}});var O=gt(D,2);Ws(O,{get data(){return ee(_)},children:(G,N)=>{{let V=Kt(()=>({"text-color":"black","text-halo-color":["case",["==",["get","side"],"left"],Ox("left"),Ox("right")],"text-halo-width":8,"text-halo-blur":4}));Uv(G,{get paint(){return ee(V)},layout:{"text-field":["get","label"],"text-size":16,"symbol-placement":"line"}})}},$$slots:{default:!0}});var U=gt(O,2);{let G=Kt(()=>x(d()));Ws(U,{get data(){return ee(G)},children:(N,V)=>{{let q=Kt(()=>({"text-field":["get","idx"],"text-size":16,visibility:r()?"visible":"none"}));Uv(N,{paint:{"text-color":"white","text-halo-color":"blue","text-halo-width":5},get layout(){return ee(q)}})}},$$slots:{default:!0}})}var j=gt(U,2);Ws(j,{get data(){return p()},children:(G,N)=>{var V=qae(),q=ci(V);{let Q=Kt(()=>({visibility:e.showProblemDetails?"visible":"none"}));cu(q,{get filter(){return YF},paint:{"circle-radius":20,"circle-color":["get","color"],"circle-opacity":.5},get layout(){return ee(Q)}})}var z=gt(q,2);{let Q=Kt(()=>({"line-width":Md(5),"line-color":["get","color"],"line-opacity":.5})),X=Kt(()=>({visibility:e.showProblemDetails?"visible":"none"}));tl(z,{get filter(){return YM},get paint(){return ee(Q)},get layout(){return ee(X)}})}xt(G,V)},$$slots:{default:!0}}),xt(n,S),tn(),s()}const fo=[];for(let n=0;n<256;++n)fo.push((n+256).toString(16).slice(1));function Zae(n,e=0){return(fo[n[e+0]]+fo[n[e+1]]+fo[n[e+2]]+fo[n[e+3]]+"-"+fo[n[e+4]]+fo[n[e+5]]+"-"+fo[n[e+6]]+fo[n[e+7]]+"-"+fo[n[e+8]]+fo[n[e+9]]+"-"+fo[n[e+10]]+fo[n[e+11]]+fo[n[e+12]]+fo[n[e+13]]+fo[n[e+14]]+fo[n[e+15]]).toLowerCase()}let CM;const Xae=new Uint8Array(16);function Yae(){if(!CM){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");CM=crypto.getRandomValues.bind(crypto)}return CM(Xae)}const Kae=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Lk={randomUUID:Kae};function Jae(n,e,t){n=n||{};const i=n.random??n.rng?.()??Yae();if(i.length<16)throw new Error("Random bytes length must be >= 16");return i[6]=i[6]&15|64,i[8]=i[8]&63|128,Zae(i)}function Qae(n,e,t){return Lk.randomUUID&&!n?Lk.randomUUID():Jae(n)}var ele=Wt('<div class="accordion mb-3"><div class="accordion-item"><div class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" aria-expanded="true"><!></button></div> <div><div class="accordion-body"><!></div></div></div></div>');function Hd(n,e){en(e,!0);let t=ft(e,"open",3,!0),i=Qae();var r=ele(),o=Ft(r),c=Ft(o),s=Ft(c),d=Ft(s);hs(d,()=>e.header);var p=gt(c,2);let g;var _=Ft(p),x=Ft(_);hs(x,()=>e.body),Zi(()=>{Nl(s,"data-bs-target",`#${i}`),Nl(s,"aria-controls",i),Nl(p,"id",i),g=Ds(p,1,"accordion-collapse collapse",null,g,{show:t()})}),xt(n,r),tn()}var tle=Wt("<option> </option>"),ile=Wt('<button class="btn btn-sm btn-primary">Pick next</button>'),nle=Wt('<div class="problem-header svelte-fc5ubw"><p class="problem-count svelte-fc5ubw"> </p> <!></div>'),rle=Wt(`<p>When a crossing way hits a road, the node should be tagged as a
        crossing. Instructions to fix are TODO.</p>`),sle=Wt(`<p>Here are places where part of a road has separate sidewalks tagged, but
        then the next part of the road doesn't. It's best to be consistent about
        separate sidewalks along the entire length of a road. To fix:</p> <ol><li>Go map separate sidewalks along the entire road (in another editor)</li> <li>Update the road tagging to indicate those separate sidewalks (here or
          in another editor)</li> <li>Refresh the data here to verify</li></ol> <p>(This problem is detected when the road names are the same, so there are
        some false positives you can ignore.)</p>`,1),ole=Wt(`<p>Here are footways with a crossing node, but the way needs to be split
        and tagged as <i>footway=crossing</i> .</p> <ol><li>Open in another editor</li> <li>Split the way around the crossing</li> <li>Tag <i>footway=crossing</i> on the smaller segment</li> <li>Refresh the data here to verify</li></ol>`,1),ale=Wt(`<p>These roads aren't tagged as having separate sidewalks, but it looks
        like there's a parallel separate sidewalk already mapped.</p> <ol><li>Check each segment. If separate sidewalks are already there, update
          the tagging here.</li> <li>If the separate sidewalks don't cover the entire length of the road,
          ideally go finish drawing the separate sidewalks in another tool, then
          update the tagging on the road.</li></ol> <p>There are false positives. Check the full length of the road.</p>`,1),lle=Wt(`<p><i>sidewalk=separate</i> is ambiguous. Update the tagging to specify if there are separate sidewalks
        on both sides or just one.</p>`),cle=Wt(`<p>These roads have separate sidewalks tagged on one side, but the other
        side is unspecified or not drawn separately. Be consistent on each road
        and use another editor to draw separate sidewalks on both sides.</p>`),ule=Wt('<select class="form-select"><option>Show a type of problem</option><!></select> <!> <!>',1);function hle(n,e){en(e,!0);const t=()=>Qi(Fh,"$map",i),[i,r]=qr();let o=ft(e,"drawProblems",15),c=["missing crossing node","separate sidewalks should be continued here"],s=["missing footway=crossing","possible separate sidewalk near way without it tagged","sidewalk=separate is ambiguous about the side","sidewalk:left and sidewalk:right should each be tagged as separate or no"],d=Kt(()=>{let x={};for(let b of[...c,...s])x[b]=0;for(let b of[...e.nodes.features,...e.ways.features])for(let S of b.properties.problems)x[S.note]+=1;return x}),p=ii(""),g=ii(0);cn(()=>{let x={type:"FeatureCollection",features:[]};for(let b of[...e.nodes.features,...e.ways.features])b.properties.problems.some(S=>S.note==ee(p))&&x.features.push(b);o(x)});function _(){if(!t()||!ee(p)||o().features.length===0)return;const x=o().features[ee(g)];Et(g,(ee(g)+1)%o().features.length);try{if(x.geometry.type==="Point"){const b=x.geometry.coordinates;t().flyTo({center:[b[0],b[1]],zoom:19,animate:!0})}else{const b=KF(x);t().fitBounds(b,{animate:!0,padding:50})}}catch(b){console.error("Error focusing on problem:",b)}}Hd(n,{header:S=>{var P=Vn("Problems");xt(S,P)},body:S=>{var P=ule(),L=ci(P),E=Ft(L);E.value=E.__value="";var C=gt(E);Ys(C,17,()=>Object.entries(ee(d)),Xs,(N,V)=>{var q=Kt(()=>xc(ee(V),2));let z=()=>ee(q)[0],Q=()=>ee(q)[1];var X=tle(),re=Ft(X),oe={};Zi(()=>{X.disabled=Q()==0,ln(re,`${z()??""} (${Q()??""})`),oe!==(oe=z())&&(X.value=(X.__value=z())??"")}),xt(N,X)});var D=gt(L,2);{var O=N=>{var V=nle(),q=Ft(V),z=Ft(q),Q=gt(q,2);{var X=re=>{var oe=ile();oe.__click=_,xt(re,oe)};Ki(Q,re=>{o().features.length>0&&re(X)})}Zi(()=>ln(z,`${ee(d)[ee(p)]??""} problems`)),xt(N,V)};Ki(D,N=>{ee(p)&&N(O)})}var U=gt(D,2);{var j=N=>{var V=rle();xt(N,V)},G=N=>{var V=ir(),q=ci(V);{var z=X=>{var re=sle();xt(X,re)},Q=X=>{var re=ir(),oe=ci(re);{var de=Se=>{var Pe=ole();xt(Se,Pe)},ce=Se=>{var Pe=ir(),je=ci(Pe);{var Fe=Ue=>{var ke=ale();xt(Ue,ke)},qe=Ue=>{var ke=ir(),et=ci(ke);{var ye=Je=>{var ct=lle();xt(Je,ct)},Be=Je=>{var ct=ir(),yt=ci(ct);{var we=fe=>{var Ve=cle();xt(fe,Ve)};Ki(yt,fe=>{ee(p)=="sidewalk:left and sidewalk:right should each be tagged as separate or no"&&fe(we)},!0)}xt(Je,ct)};Ki(et,Je=>{ee(p)=="sidewalk=separate is ambiguous about the side"?Je(ye):Je(Be,!1)},!0)}xt(Ue,ke)};Ki(je,Ue=>{ee(p)=="possible separate sidewalk near way without it tagged"?Ue(Fe):Ue(qe,!1)},!0)}xt(Se,Pe)};Ki(oe,Se=>{ee(p)=="missing footway=crossing"?Se(de):Se(ce,!1)},!0)}xt(X,re)};Ki(q,X=>{ee(p)=="separate sidewalks should be continued here"?X(z):X(Q,!1)},!0)}xt(N,V)};Ki(U,N=>{ee(p)=="missing crossing node"?N(j):N(G,!1)})}R6(L,()=>ee(p),N=>{Et(p,N,!0),Et(g,0)}),xt(S,P)},$$slots:{header:!0,body:!0}}),tn(),r()}ds(["click"]);var dle=Wt("<!> <!> <!>",1);function fle(n,e){en(e,!0);let t=ii(.5);function i(r){let o=2500,c=.35,s=.85,d=(Math.sin(r/o*Math.PI*2)+1)/2;Et(t,c+d*(s-c)),requestAnimationFrame(i)}requestAnimationFrame(i),Ws(n,{get data(){return e.drawProblems},children:(r,o)=>{var c=dle(),s=ci(c);cu(s,{get filter(){return YF},paint:{"circle-radius":10,"circle-color":"red","circle-opacity":.5,"circle-stroke-color":"black","circle-stroke-width":1}});var d=gt(s,2);{let g=Kt(()=>({"line-width":Md(15),"line-color":"red","line-opacity":ee(t),"line-blur":5})),_=Kt(()=>({visibility:e.pinnedWay?"none":"visible"}));tl(d,{get filter(){return YM},maxzoom:16,get paint(){return ee(g)},get layout(){return ee(_)}})}var p=gt(d,2);{let g=Kt(()=>({"line-width":Md(20),"line-color":"red","line-opacity":ee(t),"line-blur":5})),_=Kt(()=>({visibility:e.pinnedWay?"none":"visible"}));tl(p,{get filter(){return YM},beforeId:"Road labels",minzoom:16,get paint(){return ee(g)},get layout(){return ee(_)}})}xt(r,c)},$$slots:{default:!0}}),tn()}function zx(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var EM={exports:{}},kk;function ple(){return kk||(kk=1,(function(n,e){(function(t){n.exports=t()})(function(){return(function(){function t(i,r,o){function c(p,g){if(!r[p]){if(!i[p]){var _=typeof zx=="function"&&zx;if(!g&&_)return _(p,!0);if(s)return s(p,!0);var x=new Error("Cannot find module '"+p+"'");throw x.code="MODULE_NOT_FOUND",x}var b=r[p]={exports:{}};i[p][0].call(b.exports,function(S){var P=i[p][1][S];return c(P||S)},b,b.exports,t,i,r,o)}return r[p].exports}for(var s=typeof zx=="function"&&zx,d=0;d<o.length;d++)c(o[d]);return c}return t})()({1:[function(t,i,r){r.byteLength=x,r.toByteArray=S,r.fromByteArray=E;for(var o=[],c=[],s=typeof Uint8Array<"u"?Uint8Array:Array,d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",p=0,g=d.length;p<g;++p)o[p]=d[p],c[d.charCodeAt(p)]=p;c[45]=62,c[95]=63;function _(C){var D=C.length;if(D%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var O=C.indexOf("=");O===-1&&(O=D);var U=O===D?0:4-O%4;return[O,U]}function x(C){var D=_(C),O=D[0],U=D[1];return(O+U)*3/4-U}function b(C,D,O){return(D+O)*3/4-O}function S(C){var D,O=_(C),U=O[0],j=O[1],G=new s(b(C,U,j)),N=0,V=j>0?U-4:U,q;for(q=0;q<V;q+=4)D=c[C.charCodeAt(q)]<<18|c[C.charCodeAt(q+1)]<<12|c[C.charCodeAt(q+2)]<<6|c[C.charCodeAt(q+3)],G[N++]=D>>16&255,G[N++]=D>>8&255,G[N++]=D&255;return j===2&&(D=c[C.charCodeAt(q)]<<2|c[C.charCodeAt(q+1)]>>4,G[N++]=D&255),j===1&&(D=c[C.charCodeAt(q)]<<10|c[C.charCodeAt(q+1)]<<4|c[C.charCodeAt(q+2)]>>2,G[N++]=D>>8&255,G[N++]=D&255),G}function P(C){return o[C>>18&63]+o[C>>12&63]+o[C>>6&63]+o[C&63]}function L(C,D,O){for(var U,j=[],G=D;G<O;G+=3)U=(C[G]<<16&16711680)+(C[G+1]<<8&65280)+(C[G+2]&255),j.push(P(U));return j.join("")}function E(C){for(var D,O=C.length,U=O%3,j=[],G=16383,N=0,V=O-U;N<V;N+=G)j.push(L(C,N,N+G>V?V:N+G));return U===1?(D=C[O-1],j.push(o[D>>2]+o[D<<4&63]+"==")):U===2&&(D=(C[O-2]<<8)+C[O-1],j.push(o[D>>10]+o[D>>4&63]+o[D<<2&63]+"=")),j.join("")}},{}],2:[function(t,i,r){(function(o){(function(){var c=t("base64-js"),s=t("ieee754");r.Buffer=_,r.SlowBuffer=U,r.INSPECT_MAX_BYTES=50;var d=2147483647;r.kMaxLength=d,_.TYPED_ARRAY_SUPPORT=p(),!_.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function p(){try{var be=new Uint8Array(1);return be.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},be.foo()===42}catch{return!1}}Object.defineProperty(_.prototype,"parent",{enumerable:!0,get:function(){if(_.isBuffer(this))return this.buffer}}),Object.defineProperty(_.prototype,"offset",{enumerable:!0,get:function(){if(_.isBuffer(this))return this.byteOffset}});function g(be){if(be>d)throw new RangeError('The value "'+be+'" is invalid for option "size"');var ie=new Uint8Array(be);return ie.__proto__=_.prototype,ie}function _(be,ie,ae){if(typeof be=="number"){if(typeof ie=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return P(be)}return x(be,ie,ae)}typeof Symbol<"u"&&Symbol.species!=null&&_[Symbol.species]===_&&Object.defineProperty(_,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),_.poolSize=8192;function x(be,ie,ae){if(typeof be=="string")return L(be,ie);if(ArrayBuffer.isView(be))return E(be);if(be==null)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof be);if(xe(be,ArrayBuffer)||be&&xe(be.buffer,ArrayBuffer))return C(be,ie,ae);if(typeof be=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');var De=be.valueOf&&be.valueOf();if(De!=null&&De!==be)return _.from(De,ie,ae);var Xe=D(be);if(Xe)return Xe;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof be[Symbol.toPrimitive]=="function")return _.from(be[Symbol.toPrimitive]("string"),ie,ae);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof be)}_.from=function(be,ie,ae){return x(be,ie,ae)},_.prototype.__proto__=Uint8Array.prototype,_.__proto__=Uint8Array;function b(be){if(typeof be!="number")throw new TypeError('"size" argument must be of type number');if(be<0)throw new RangeError('The value "'+be+'" is invalid for option "size"')}function S(be,ie,ae){return b(be),be<=0?g(be):ie!==void 0?typeof ae=="string"?g(be).fill(ie,ae):g(be).fill(ie):g(be)}_.alloc=function(be,ie,ae){return S(be,ie,ae)};function P(be){return b(be),g(be<0?0:O(be)|0)}_.allocUnsafe=function(be){return P(be)},_.allocUnsafeSlow=function(be){return P(be)};function L(be,ie){if((typeof ie!="string"||ie==="")&&(ie="utf8"),!_.isEncoding(ie))throw new TypeError("Unknown encoding: "+ie);var ae=j(be,ie)|0,De=g(ae),Xe=De.write(be,ie);return Xe!==ae&&(De=De.slice(0,Xe)),De}function E(be){for(var ie=be.length<0?0:O(be.length)|0,ae=g(ie),De=0;De<ie;De+=1)ae[De]=be[De]&255;return ae}function C(be,ie,ae){if(ie<0||be.byteLength<ie)throw new RangeError('"offset" is outside of buffer bounds');if(be.byteLength<ie+(ae||0))throw new RangeError('"length" is outside of buffer bounds');var De;return ie===void 0&&ae===void 0?De=new Uint8Array(be):ae===void 0?De=new Uint8Array(be,ie):De=new Uint8Array(be,ie,ae),De.__proto__=_.prototype,De}function D(be){if(_.isBuffer(be)){var ie=O(be.length)|0,ae=g(ie);return ae.length===0||be.copy(ae,0,0,ie),ae}if(be.length!==void 0)return typeof be.length!="number"||vt(be.length)?g(0):E(be);if(be.type==="Buffer"&&Array.isArray(be.data))return E(be.data)}function O(be){if(be>=d)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+d.toString(16)+" bytes");return be|0}function U(be){return+be!=be&&(be=0),_.alloc(+be)}_.isBuffer=function(ie){return ie!=null&&ie._isBuffer===!0&&ie!==_.prototype},_.compare=function(ie,ae){if(xe(ie,Uint8Array)&&(ie=_.from(ie,ie.offset,ie.byteLength)),xe(ae,Uint8Array)&&(ae=_.from(ae,ae.offset,ae.byteLength)),!_.isBuffer(ie)||!_.isBuffer(ae))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(ie===ae)return 0;for(var De=ie.length,Xe=ae.length,bt=0,Te=Math.min(De,Xe);bt<Te;++bt)if(ie[bt]!==ae[bt]){De=ie[bt],Xe=ae[bt];break}return De<Xe?-1:Xe<De?1:0},_.isEncoding=function(ie){switch(String(ie).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},_.concat=function(ie,ae){if(!Array.isArray(ie))throw new TypeError('"list" argument must be an Array of Buffers');if(ie.length===0)return _.alloc(0);var De;if(ae===void 0)for(ae=0,De=0;De<ie.length;++De)ae+=ie[De].length;var Xe=_.allocUnsafe(ae),bt=0;for(De=0;De<ie.length;++De){var Te=ie[De];if(xe(Te,Uint8Array)&&(Te=_.from(Te)),!_.isBuffer(Te))throw new TypeError('"list" argument must be an Array of Buffers');Te.copy(Xe,bt),bt+=Te.length}return Xe};function j(be,ie){if(_.isBuffer(be))return be.length;if(ArrayBuffer.isView(be)||xe(be,ArrayBuffer))return be.byteLength;if(typeof be!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof be);var ae=be.length,De=arguments.length>2&&arguments[2]===!0;if(!De&&ae===0)return 0;for(var Xe=!1;;)switch(ie){case"ascii":case"latin1":case"binary":return ae;case"utf8":case"utf-8":return Ve(be).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ae*2;case"hex":return ae>>>1;case"base64":return mt(be).length;default:if(Xe)return De?-1:Ve(be).length;ie=(""+ie).toLowerCase(),Xe=!0}}_.byteLength=j;function G(be,ie,ae){var De=!1;if((ie===void 0||ie<0)&&(ie=0),ie>this.length||((ae===void 0||ae>this.length)&&(ae=this.length),ae<=0)||(ae>>>=0,ie>>>=0,ae<=ie))return"";for(be||(be="utf8");;)switch(be){case"hex":return Ue(this,ie,ae);case"utf8":case"utf-8":return Se(this,ie,ae);case"ascii":return Fe(this,ie,ae);case"latin1":case"binary":return qe(this,ie,ae);case"base64":return ce(this,ie,ae);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ke(this,ie,ae);default:if(De)throw new TypeError("Unknown encoding: "+be);be=(be+"").toLowerCase(),De=!0}}_.prototype._isBuffer=!0;function N(be,ie,ae){var De=be[ie];be[ie]=be[ae],be[ae]=De}_.prototype.swap16=function(){var ie=this.length;if(ie%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var ae=0;ae<ie;ae+=2)N(this,ae,ae+1);return this},_.prototype.swap32=function(){var ie=this.length;if(ie%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var ae=0;ae<ie;ae+=4)N(this,ae,ae+3),N(this,ae+1,ae+2);return this},_.prototype.swap64=function(){var ie=this.length;if(ie%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var ae=0;ae<ie;ae+=8)N(this,ae,ae+7),N(this,ae+1,ae+6),N(this,ae+2,ae+5),N(this,ae+3,ae+4);return this},_.prototype.toString=function(){var ie=this.length;return ie===0?"":arguments.length===0?Se(this,0,ie):G.apply(this,arguments)},_.prototype.toLocaleString=_.prototype.toString,_.prototype.equals=function(ie){if(!_.isBuffer(ie))throw new TypeError("Argument must be a Buffer");return this===ie?!0:_.compare(this,ie)===0},_.prototype.inspect=function(){var ie="",ae=r.INSPECT_MAX_BYTES;return ie=this.toString("hex",0,ae).replace(/(.{2})/g,"$1 ").trim(),this.length>ae&&(ie+=" ... "),"<Buffer "+ie+">"},_.prototype.compare=function(ie,ae,De,Xe,bt){if(xe(ie,Uint8Array)&&(ie=_.from(ie,ie.offset,ie.byteLength)),!_.isBuffer(ie))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof ie);if(ae===void 0&&(ae=0),De===void 0&&(De=ie?ie.length:0),Xe===void 0&&(Xe=0),bt===void 0&&(bt=this.length),ae<0||De>ie.length||Xe<0||bt>this.length)throw new RangeError("out of range index");if(Xe>=bt&&ae>=De)return 0;if(Xe>=bt)return-1;if(ae>=De)return 1;if(ae>>>=0,De>>>=0,Xe>>>=0,bt>>>=0,this===ie)return 0;for(var Te=bt-Xe,te=De-ae,he=Math.min(Te,te),pe=this.slice(Xe,bt),Re=ie.slice(ae,De),Oe=0;Oe<he;++Oe)if(pe[Oe]!==Re[Oe]){Te=pe[Oe],te=Re[Oe];break}return Te<te?-1:te<Te?1:0};function V(be,ie,ae,De,Xe){if(be.length===0)return-1;if(typeof ae=="string"?(De=ae,ae=0):ae>2147483647?ae=2147483647:ae<-2147483648&&(ae=-2147483648),ae=+ae,vt(ae)&&(ae=Xe?0:be.length-1),ae<0&&(ae=be.length+ae),ae>=be.length){if(Xe)return-1;ae=be.length-1}else if(ae<0)if(Xe)ae=0;else return-1;if(typeof ie=="string"&&(ie=_.from(ie,De)),_.isBuffer(ie))return ie.length===0?-1:q(be,ie,ae,De,Xe);if(typeof ie=="number")return ie=ie&255,typeof Uint8Array.prototype.indexOf=="function"?Xe?Uint8Array.prototype.indexOf.call(be,ie,ae):Uint8Array.prototype.lastIndexOf.call(be,ie,ae):q(be,[ie],ae,De,Xe);throw new TypeError("val must be string, number or Buffer")}function q(be,ie,ae,De,Xe){var bt=1,Te=be.length,te=ie.length;if(De!==void 0&&(De=String(De).toLowerCase(),De==="ucs2"||De==="ucs-2"||De==="utf16le"||De==="utf-16le")){if(be.length<2||ie.length<2)return-1;bt=2,Te/=2,te/=2,ae/=2}function he(pt,ot){return bt===1?pt[ot]:pt.readUInt16BE(ot*bt)}var pe;if(Xe){var Re=-1;for(pe=ae;pe<Te;pe++)if(he(be,pe)===he(ie,Re===-1?0:pe-Re)){if(Re===-1&&(Re=pe),pe-Re+1===te)return Re*bt}else Re!==-1&&(pe-=pe-Re),Re=-1}else for(ae+te>Te&&(ae=Te-te),pe=ae;pe>=0;pe--){for(var Oe=!0,ht=0;ht<te;ht++)if(he(be,pe+ht)!==he(ie,ht)){Oe=!1;break}if(Oe)return pe}return-1}_.prototype.includes=function(ie,ae,De){return this.indexOf(ie,ae,De)!==-1},_.prototype.indexOf=function(ie,ae,De){return V(this,ie,ae,De,!0)},_.prototype.lastIndexOf=function(ie,ae,De){return V(this,ie,ae,De,!1)};function z(be,ie,ae,De){ae=Number(ae)||0;var Xe=be.length-ae;De?(De=Number(De),De>Xe&&(De=Xe)):De=Xe;var bt=ie.length;De>bt/2&&(De=bt/2);for(var Te=0;Te<De;++Te){var te=parseInt(ie.substr(Te*2,2),16);if(vt(te))return Te;be[ae+Te]=te}return Te}function Q(be,ie,ae,De){return Ce(Ve(ie,be.length-ae),be,ae,De)}function X(be,ie,ae,De){return Ce(tt(ie),be,ae,De)}function re(be,ie,ae,De){return X(be,ie,ae,De)}function oe(be,ie,ae,De){return Ce(mt(ie),be,ae,De)}function de(be,ie,ae,De){return Ce(Mt(ie,be.length-ae),be,ae,De)}_.prototype.write=function(ie,ae,De,Xe){if(ae===void 0)Xe="utf8",De=this.length,ae=0;else if(De===void 0&&typeof ae=="string")Xe=ae,De=this.length,ae=0;else if(isFinite(ae))ae=ae>>>0,isFinite(De)?(De=De>>>0,Xe===void 0&&(Xe="utf8")):(Xe=De,De=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");var bt=this.length-ae;if((De===void 0||De>bt)&&(De=bt),ie.length>0&&(De<0||ae<0)||ae>this.length)throw new RangeError("Attempt to write outside buffer bounds");Xe||(Xe="utf8");for(var Te=!1;;)switch(Xe){case"hex":return z(this,ie,ae,De);case"utf8":case"utf-8":return Q(this,ie,ae,De);case"ascii":return X(this,ie,ae,De);case"latin1":case"binary":return re(this,ie,ae,De);case"base64":return oe(this,ie,ae,De);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return de(this,ie,ae,De);default:if(Te)throw new TypeError("Unknown encoding: "+Xe);Xe=(""+Xe).toLowerCase(),Te=!0}},_.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function ce(be,ie,ae){return ie===0&&ae===be.length?c.fromByteArray(be):c.fromByteArray(be.slice(ie,ae))}function Se(be,ie,ae){ae=Math.min(be.length,ae);for(var De=[],Xe=ie;Xe<ae;){var bt=be[Xe],Te=null,te=bt>239?4:bt>223?3:bt>191?2:1;if(Xe+te<=ae){var he,pe,Re,Oe;switch(te){case 1:bt<128&&(Te=bt);break;case 2:he=be[Xe+1],(he&192)===128&&(Oe=(bt&31)<<6|he&63,Oe>127&&(Te=Oe));break;case 3:he=be[Xe+1],pe=be[Xe+2],(he&192)===128&&(pe&192)===128&&(Oe=(bt&15)<<12|(he&63)<<6|pe&63,Oe>2047&&(Oe<55296||Oe>57343)&&(Te=Oe));break;case 4:he=be[Xe+1],pe=be[Xe+2],Re=be[Xe+3],(he&192)===128&&(pe&192)===128&&(Re&192)===128&&(Oe=(bt&15)<<18|(he&63)<<12|(pe&63)<<6|Re&63,Oe>65535&&Oe<1114112&&(Te=Oe))}}Te===null?(Te=65533,te=1):Te>65535&&(Te-=65536,De.push(Te>>>10&1023|55296),Te=56320|Te&1023),De.push(Te),Xe+=te}return je(De)}var Pe=4096;function je(be){var ie=be.length;if(ie<=Pe)return String.fromCharCode.apply(String,be);for(var ae="",De=0;De<ie;)ae+=String.fromCharCode.apply(String,be.slice(De,De+=Pe));return ae}function Fe(be,ie,ae){var De="";ae=Math.min(be.length,ae);for(var Xe=ie;Xe<ae;++Xe)De+=String.fromCharCode(be[Xe]&127);return De}function qe(be,ie,ae){var De="";ae=Math.min(be.length,ae);for(var Xe=ie;Xe<ae;++Xe)De+=String.fromCharCode(be[Xe]);return De}function Ue(be,ie,ae){var De=be.length;(!ie||ie<0)&&(ie=0),(!ae||ae<0||ae>De)&&(ae=De);for(var Xe="",bt=ie;bt<ae;++bt)Xe+=fe(be[bt]);return Xe}function ke(be,ie,ae){for(var De=be.slice(ie,ae),Xe="",bt=0;bt<De.length;bt+=2)Xe+=String.fromCharCode(De[bt]+De[bt+1]*256);return Xe}_.prototype.slice=function(ie,ae){var De=this.length;ie=~~ie,ae=ae===void 0?De:~~ae,ie<0?(ie+=De,ie<0&&(ie=0)):ie>De&&(ie=De),ae<0?(ae+=De,ae<0&&(ae=0)):ae>De&&(ae=De),ae<ie&&(ae=ie);var Xe=this.subarray(ie,ae);return Xe.__proto__=_.prototype,Xe};function et(be,ie,ae){if(be%1!==0||be<0)throw new RangeError("offset is not uint");if(be+ie>ae)throw new RangeError("Trying to access beyond buffer length")}_.prototype.readUIntLE=function(ie,ae,De){ie=ie>>>0,ae=ae>>>0,De||et(ie,ae,this.length);for(var Xe=this[ie],bt=1,Te=0;++Te<ae&&(bt*=256);)Xe+=this[ie+Te]*bt;return Xe},_.prototype.readUIntBE=function(ie,ae,De){ie=ie>>>0,ae=ae>>>0,De||et(ie,ae,this.length);for(var Xe=this[ie+--ae],bt=1;ae>0&&(bt*=256);)Xe+=this[ie+--ae]*bt;return Xe},_.prototype.readUInt8=function(ie,ae){return ie=ie>>>0,ae||et(ie,1,this.length),this[ie]},_.prototype.readUInt16LE=function(ie,ae){return ie=ie>>>0,ae||et(ie,2,this.length),this[ie]|this[ie+1]<<8},_.prototype.readUInt16BE=function(ie,ae){return ie=ie>>>0,ae||et(ie,2,this.length),this[ie]<<8|this[ie+1]},_.prototype.readUInt32LE=function(ie,ae){return ie=ie>>>0,ae||et(ie,4,this.length),(this[ie]|this[ie+1]<<8|this[ie+2]<<16)+this[ie+3]*16777216},_.prototype.readUInt32BE=function(ie,ae){return ie=ie>>>0,ae||et(ie,4,this.length),this[ie]*16777216+(this[ie+1]<<16|this[ie+2]<<8|this[ie+3])},_.prototype.readIntLE=function(ie,ae,De){ie=ie>>>0,ae=ae>>>0,De||et(ie,ae,this.length);for(var Xe=this[ie],bt=1,Te=0;++Te<ae&&(bt*=256);)Xe+=this[ie+Te]*bt;return bt*=128,Xe>=bt&&(Xe-=Math.pow(2,8*ae)),Xe},_.prototype.readIntBE=function(ie,ae,De){ie=ie>>>0,ae=ae>>>0,De||et(ie,ae,this.length);for(var Xe=ae,bt=1,Te=this[ie+--Xe];Xe>0&&(bt*=256);)Te+=this[ie+--Xe]*bt;return bt*=128,Te>=bt&&(Te-=Math.pow(2,8*ae)),Te},_.prototype.readInt8=function(ie,ae){return ie=ie>>>0,ae||et(ie,1,this.length),this[ie]&128?(255-this[ie]+1)*-1:this[ie]},_.prototype.readInt16LE=function(ie,ae){ie=ie>>>0,ae||et(ie,2,this.length);var De=this[ie]|this[ie+1]<<8;return De&32768?De|4294901760:De},_.prototype.readInt16BE=function(ie,ae){ie=ie>>>0,ae||et(ie,2,this.length);var De=this[ie+1]|this[ie]<<8;return De&32768?De|4294901760:De},_.prototype.readInt32LE=function(ie,ae){return ie=ie>>>0,ae||et(ie,4,this.length),this[ie]|this[ie+1]<<8|this[ie+2]<<16|this[ie+3]<<24},_.prototype.readInt32BE=function(ie,ae){return ie=ie>>>0,ae||et(ie,4,this.length),this[ie]<<24|this[ie+1]<<16|this[ie+2]<<8|this[ie+3]},_.prototype.readFloatLE=function(ie,ae){return ie=ie>>>0,ae||et(ie,4,this.length),s.read(this,ie,!0,23,4)},_.prototype.readFloatBE=function(ie,ae){return ie=ie>>>0,ae||et(ie,4,this.length),s.read(this,ie,!1,23,4)},_.prototype.readDoubleLE=function(ie,ae){return ie=ie>>>0,ae||et(ie,8,this.length),s.read(this,ie,!0,52,8)},_.prototype.readDoubleBE=function(ie,ae){return ie=ie>>>0,ae||et(ie,8,this.length),s.read(this,ie,!1,52,8)};function ye(be,ie,ae,De,Xe,bt){if(!_.isBuffer(be))throw new TypeError('"buffer" argument must be a Buffer instance');if(ie>Xe||ie<bt)throw new RangeError('"value" argument is out of bounds');if(ae+De>be.length)throw new RangeError("Index out of range")}_.prototype.writeUIntLE=function(ie,ae,De,Xe){if(ie=+ie,ae=ae>>>0,De=De>>>0,!Xe){var bt=Math.pow(2,8*De)-1;ye(this,ie,ae,De,bt,0)}var Te=1,te=0;for(this[ae]=ie&255;++te<De&&(Te*=256);)this[ae+te]=ie/Te&255;return ae+De},_.prototype.writeUIntBE=function(ie,ae,De,Xe){if(ie=+ie,ae=ae>>>0,De=De>>>0,!Xe){var bt=Math.pow(2,8*De)-1;ye(this,ie,ae,De,bt,0)}var Te=De-1,te=1;for(this[ae+Te]=ie&255;--Te>=0&&(te*=256);)this[ae+Te]=ie/te&255;return ae+De},_.prototype.writeUInt8=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,1,255,0),this[ae]=ie&255,ae+1},_.prototype.writeUInt16LE=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,2,65535,0),this[ae]=ie&255,this[ae+1]=ie>>>8,ae+2},_.prototype.writeUInt16BE=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,2,65535,0),this[ae]=ie>>>8,this[ae+1]=ie&255,ae+2},_.prototype.writeUInt32LE=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,4,4294967295,0),this[ae+3]=ie>>>24,this[ae+2]=ie>>>16,this[ae+1]=ie>>>8,this[ae]=ie&255,ae+4},_.prototype.writeUInt32BE=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,4,4294967295,0),this[ae]=ie>>>24,this[ae+1]=ie>>>16,this[ae+2]=ie>>>8,this[ae+3]=ie&255,ae+4},_.prototype.writeIntLE=function(ie,ae,De,Xe){if(ie=+ie,ae=ae>>>0,!Xe){var bt=Math.pow(2,8*De-1);ye(this,ie,ae,De,bt-1,-bt)}var Te=0,te=1,he=0;for(this[ae]=ie&255;++Te<De&&(te*=256);)ie<0&&he===0&&this[ae+Te-1]!==0&&(he=1),this[ae+Te]=(ie/te>>0)-he&255;return ae+De},_.prototype.writeIntBE=function(ie,ae,De,Xe){if(ie=+ie,ae=ae>>>0,!Xe){var bt=Math.pow(2,8*De-1);ye(this,ie,ae,De,bt-1,-bt)}var Te=De-1,te=1,he=0;for(this[ae+Te]=ie&255;--Te>=0&&(te*=256);)ie<0&&he===0&&this[ae+Te+1]!==0&&(he=1),this[ae+Te]=(ie/te>>0)-he&255;return ae+De},_.prototype.writeInt8=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,1,127,-128),ie<0&&(ie=255+ie+1),this[ae]=ie&255,ae+1},_.prototype.writeInt16LE=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,2,32767,-32768),this[ae]=ie&255,this[ae+1]=ie>>>8,ae+2},_.prototype.writeInt16BE=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,2,32767,-32768),this[ae]=ie>>>8,this[ae+1]=ie&255,ae+2},_.prototype.writeInt32LE=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,4,2147483647,-2147483648),this[ae]=ie&255,this[ae+1]=ie>>>8,this[ae+2]=ie>>>16,this[ae+3]=ie>>>24,ae+4},_.prototype.writeInt32BE=function(ie,ae,De){return ie=+ie,ae=ae>>>0,De||ye(this,ie,ae,4,2147483647,-2147483648),ie<0&&(ie=4294967295+ie+1),this[ae]=ie>>>24,this[ae+1]=ie>>>16,this[ae+2]=ie>>>8,this[ae+3]=ie&255,ae+4};function Be(be,ie,ae,De,Xe,bt){if(ae+De>be.length)throw new RangeError("Index out of range");if(ae<0)throw new RangeError("Index out of range")}function Je(be,ie,ae,De,Xe){return ie=+ie,ae=ae>>>0,Xe||Be(be,ie,ae,4),s.write(be,ie,ae,De,23,4),ae+4}_.prototype.writeFloatLE=function(ie,ae,De){return Je(this,ie,ae,!0,De)},_.prototype.writeFloatBE=function(ie,ae,De){return Je(this,ie,ae,!1,De)};function ct(be,ie,ae,De,Xe){return ie=+ie,ae=ae>>>0,Xe||Be(be,ie,ae,8),s.write(be,ie,ae,De,52,8),ae+8}_.prototype.writeDoubleLE=function(ie,ae,De){return ct(this,ie,ae,!0,De)},_.prototype.writeDoubleBE=function(ie,ae,De){return ct(this,ie,ae,!1,De)},_.prototype.copy=function(ie,ae,De,Xe){if(!_.isBuffer(ie))throw new TypeError("argument should be a Buffer");if(De||(De=0),!Xe&&Xe!==0&&(Xe=this.length),ae>=ie.length&&(ae=ie.length),ae||(ae=0),Xe>0&&Xe<De&&(Xe=De),Xe===De||ie.length===0||this.length===0)return 0;if(ae<0)throw new RangeError("targetStart out of bounds");if(De<0||De>=this.length)throw new RangeError("Index out of range");if(Xe<0)throw new RangeError("sourceEnd out of bounds");Xe>this.length&&(Xe=this.length),ie.length-ae<Xe-De&&(Xe=ie.length-ae+De);var bt=Xe-De;if(this===ie&&typeof Uint8Array.prototype.copyWithin=="function")this.copyWithin(ae,De,Xe);else if(this===ie&&De<ae&&ae<Xe)for(var Te=bt-1;Te>=0;--Te)ie[Te+ae]=this[Te+De];else Uint8Array.prototype.set.call(ie,this.subarray(De,Xe),ae);return bt},_.prototype.fill=function(ie,ae,De,Xe){if(typeof ie=="string"){if(typeof ae=="string"?(Xe=ae,ae=0,De=this.length):typeof De=="string"&&(Xe=De,De=this.length),Xe!==void 0&&typeof Xe!="string")throw new TypeError("encoding must be a string");if(typeof Xe=="string"&&!_.isEncoding(Xe))throw new TypeError("Unknown encoding: "+Xe);if(ie.length===1){var bt=ie.charCodeAt(0);(Xe==="utf8"&&bt<128||Xe==="latin1")&&(ie=bt)}}else typeof ie=="number"&&(ie=ie&255);if(ae<0||this.length<ae||this.length<De)throw new RangeError("Out of range index");if(De<=ae)return this;ae=ae>>>0,De=De===void 0?this.length:De>>>0,ie||(ie=0);var Te;if(typeof ie=="number")for(Te=ae;Te<De;++Te)this[Te]=ie;else{var te=_.isBuffer(ie)?ie:_.from(ie,Xe),he=te.length;if(he===0)throw new TypeError('The value "'+ie+'" is invalid for argument "value"');for(Te=0;Te<De-ae;++Te)this[Te+ae]=te[Te%he]}return this};var yt=/[^+/0-9A-Za-z-_]/g;function we(be){if(be=be.split("=")[0],be=be.trim().replace(yt,""),be.length<2)return"";for(;be.length%4!==0;)be=be+"=";return be}function fe(be){return be<16?"0"+be.toString(16):be.toString(16)}function Ve(be,ie){ie=ie||1/0;for(var ae,De=be.length,Xe=null,bt=[],Te=0;Te<De;++Te){if(ae=be.charCodeAt(Te),ae>55295&&ae<57344){if(!Xe){if(ae>56319){(ie-=3)>-1&&bt.push(239,191,189);continue}else if(Te+1===De){(ie-=3)>-1&&bt.push(239,191,189);continue}Xe=ae;continue}if(ae<56320){(ie-=3)>-1&&bt.push(239,191,189),Xe=ae;continue}ae=(Xe-55296<<10|ae-56320)+65536}else Xe&&(ie-=3)>-1&&bt.push(239,191,189);if(Xe=null,ae<128){if((ie-=1)<0)break;bt.push(ae)}else if(ae<2048){if((ie-=2)<0)break;bt.push(ae>>6|192,ae&63|128)}else if(ae<65536){if((ie-=3)<0)break;bt.push(ae>>12|224,ae>>6&63|128,ae&63|128)}else if(ae<1114112){if((ie-=4)<0)break;bt.push(ae>>18|240,ae>>12&63|128,ae>>6&63|128,ae&63|128)}else throw new Error("Invalid code point")}return bt}function tt(be){for(var ie=[],ae=0;ae<be.length;++ae)ie.push(be.charCodeAt(ae)&255);return ie}function Mt(be,ie){for(var ae,De,Xe,bt=[],Te=0;Te<be.length&&!((ie-=2)<0);++Te)ae=be.charCodeAt(Te),De=ae>>8,Xe=ae%256,bt.push(Xe),bt.push(De);return bt}function mt(be){return c.toByteArray(we(be))}function Ce(be,ie,ae,De){for(var Xe=0;Xe<De&&!(Xe+ae>=ie.length||Xe>=be.length);++Xe)ie[Xe+ae]=be[Xe];return Xe}function xe(be,ie){return be instanceof ie||be!=null&&be.constructor!=null&&be.constructor.name!=null&&be.constructor.name===ie.name}function vt(be){return be!==be}}).call(this)}).call(this,t("buffer").Buffer)},{"base64-js":1,buffer:2,ieee754:14}],3:[function(t,i,r){const o=t("./validator"),c=t("./xmlparser/XMLParser"),s=t("./xmlbuilder/json2xml");i.exports={XMLParser:c,XMLValidator:o,XMLBuilder:s}},{"./validator":5,"./xmlbuilder/json2xml":6,"./xmlparser/XMLParser":11}],4:[function(t,i,r){const o=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",c=o+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",s="["+o+"]["+c+"]*",d=new RegExp("^"+s+"$"),p=function(_,x){const b=[];let S=x.exec(_);for(;S;){const P=[];P.startIndex=x.lastIndex-S[0].length;const L=S.length;for(let E=0;E<L;E++)P.push(S[E]);b.push(P),S=x.exec(_)}return b},g=function(_){const x=d.exec(_);return!(x===null||typeof x>"u")};r.isExist=function(_){return typeof _<"u"},r.isEmptyObject=function(_){return Object.keys(_).length===0},r.merge=function(_,x,b){if(x){const S=Object.keys(x),P=S.length;for(let L=0;L<P;L++)b==="strict"?_[S[L]]=[x[S[L]]]:_[S[L]]=x[S[L]]}},r.getValue=function(_){return r.isExist(_)?_:""},r.isName=g,r.getAllMatches=p,r.nameRegexp=s},{}],5:[function(t,i,r){const o=t("./util"),c={allowBooleanAttributes:!1,unpairedTags:[]};r.validate=function(j,G){G=Object.assign({},c,G);const N=[];let V=!1,q=!1;j[0]==="\uFEFF"&&(j=j.substr(1));for(let z=0;z<j.length;z++)if(j[z]==="<"&&j[z+1]==="?"){if(z+=2,z=d(j,z),z.err)return z}else if(j[z]==="<"){let Q=z;if(z++,j[z]==="!"){z=p(j,z);continue}else{let X=!1;j[z]==="/"&&(X=!0,z++);let re="";for(;z<j.length&&j[z]!==">"&&j[z]!==" "&&j[z]!=="	"&&j[z]!==`
`&&j[z]!=="\r";z++)re+=j[z];if(re=re.trim(),re[re.length-1]==="/"&&(re=re.substring(0,re.length-1),z--),!D(re)){let ce;return re.trim().length===0?ce="Invalid space after '<'.":ce="Tag '"+re+"' is an invalid name.",E("InvalidTag",ce,O(j,z))}const oe=x(j,z);if(oe===!1)return E("InvalidAttr","Attributes for '"+re+"' have open quote.",O(j,z));let de=oe.value;if(z=oe.index,de[de.length-1]==="/"){const ce=z-de.length;de=de.substring(0,de.length-1);const Se=S(de,G);if(Se===!0)V=!0;else return E(Se.err.code,Se.err.msg,O(j,ce+Se.err.line))}else if(X)if(oe.tagClosed){if(de.trim().length>0)return E("InvalidTag","Closing tag '"+re+"' can't have attributes or invalid starting.",O(j,Q));if(N.length===0)return E("InvalidTag","Closing tag '"+re+"' has not been opened.",O(j,Q));{const ce=N.pop();if(re!==ce.tagName){let Se=O(j,ce.tagStartPos);return E("InvalidTag","Expected closing tag '"+ce.tagName+"' (opened in line "+Se.line+", col "+Se.col+") instead of closing tag '"+re+"'.",O(j,Q))}N.length==0&&(q=!0)}}else return E("InvalidTag","Closing tag '"+re+"' doesn't have proper closing.",O(j,z));else{const ce=S(de,G);if(ce!==!0)return E(ce.err.code,ce.err.msg,O(j,z-de.length+ce.err.line));if(q===!0)return E("InvalidXml","Multiple possible root nodes found.",O(j,z));G.unpairedTags.indexOf(re)!==-1||N.push({tagName:re,tagStartPos:Q}),V=!0}for(z++;z<j.length;z++)if(j[z]==="<")if(j[z+1]==="!"){z++,z=p(j,z);continue}else if(j[z+1]==="?"){if(z=d(j,++z),z.err)return z}else break;else if(j[z]==="&"){const ce=L(j,z);if(ce==-1)return E("InvalidChar","char '&' is not expected.",O(j,z));z=ce}else if(q===!0&&!s(j[z]))return E("InvalidXml","Extra text at the end",O(j,z));j[z]==="<"&&z--}}else{if(s(j[z]))continue;return E("InvalidChar","char '"+j[z]+"' is not expected.",O(j,z))}if(V){if(N.length==1)return E("InvalidTag","Unclosed tag '"+N[0].tagName+"'.",O(j,N[0].tagStartPos));if(N.length>0)return E("InvalidXml","Invalid '"+JSON.stringify(N.map(z=>z.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return E("InvalidXml","Start tag expected.",1);return!0};function s(j){return j===" "||j==="	"||j===`
`||j==="\r"}function d(j,G){const N=G;for(;G<j.length;G++)if(j[G]=="?"||j[G]==" "){const V=j.substr(N,G-N);if(G>5&&V==="xml")return E("InvalidXml","XML declaration allowed only at the start of the document.",O(j,G));if(j[G]=="?"&&j[G+1]==">"){G++;break}else continue}return G}function p(j,G){if(j.length>G+5&&j[G+1]==="-"&&j[G+2]==="-"){for(G+=3;G<j.length;G++)if(j[G]==="-"&&j[G+1]==="-"&&j[G+2]===">"){G+=2;break}}else if(j.length>G+8&&j[G+1]==="D"&&j[G+2]==="O"&&j[G+3]==="C"&&j[G+4]==="T"&&j[G+5]==="Y"&&j[G+6]==="P"&&j[G+7]==="E"){let N=1;for(G+=8;G<j.length;G++)if(j[G]==="<")N++;else if(j[G]===">"&&(N--,N===0))break}else if(j.length>G+9&&j[G+1]==="["&&j[G+2]==="C"&&j[G+3]==="D"&&j[G+4]==="A"&&j[G+5]==="T"&&j[G+6]==="A"&&j[G+7]==="["){for(G+=8;G<j.length;G++)if(j[G]==="]"&&j[G+1]==="]"&&j[G+2]===">"){G+=2;break}}return G}const g='"',_="'";function x(j,G){let N="",V="",q=!1;for(;G<j.length;G++){if(j[G]===g||j[G]===_)V===""?V=j[G]:V!==j[G]||(V="");else if(j[G]===">"&&V===""){q=!0;break}N+=j[G]}return V!==""?!1:{value:N,index:G,tagClosed:q}}const b=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function S(j,G){const N=o.getAllMatches(j,b),V={};for(let q=0;q<N.length;q++){if(N[q][1].length===0)return E("InvalidAttr","Attribute '"+N[q][2]+"' has no space in starting.",U(N[q]));if(N[q][3]!==void 0&&N[q][4]===void 0)return E("InvalidAttr","Attribute '"+N[q][2]+"' is without value.",U(N[q]));if(N[q][3]===void 0&&!G.allowBooleanAttributes)return E("InvalidAttr","boolean attribute '"+N[q][2]+"' is not allowed.",U(N[q]));const z=N[q][2];if(!C(z))return E("InvalidAttr","Attribute '"+z+"' is an invalid name.",U(N[q]));if(!V.hasOwnProperty(z))V[z]=1;else return E("InvalidAttr","Attribute '"+z+"' is repeated.",U(N[q]))}return!0}function P(j,G){let N=/\d/;for(j[G]==="x"&&(G++,N=/[\da-fA-F]/);G<j.length;G++){if(j[G]===";")return G;if(!j[G].match(N))break}return-1}function L(j,G){if(G++,j[G]===";")return-1;if(j[G]==="#")return G++,P(j,G);let N=0;for(;G<j.length;G++,N++)if(!(j[G].match(/\w/)&&N<20)){if(j[G]===";")break;return-1}return G}function E(j,G,N){return{err:{code:j,msg:G,line:N.line||N,col:N.col}}}function C(j){return o.isName(j)}function D(j){return o.isName(j)}function O(j,G){const N=j.substring(0,G).split(/\r?\n/);return{line:N.length,col:N[N.length-1].length+1}}function U(j){return j.startIndex+j[1].length}},{"./util":4}],6:[function(t,i,r){const o=t("./orderedJs2Xml"),c={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(_,x){return x},attributeValueProcessor:function(_,x){return x},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function s(_){this.options=Object.assign({},c,_),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=g),this.processTextOrObjNode=d,this.options.format?(this.indentate=p,this.tagEndChar=`>
`,this.newLine=`
`):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}s.prototype.build=function(_){return this.options.preserveOrder?o(_,this.options):(Array.isArray(_)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(_={[this.options.arrayNodeName]:_}),this.j2x(_,0).val)},s.prototype.j2x=function(_,x){let b="",S="";for(let P in _)if(Object.prototype.hasOwnProperty.call(_,P))if(typeof _[P]>"u")this.isAttribute(P)&&(S+="");else if(_[P]===null)this.isAttribute(P)?S+="":P[0]==="?"?S+=this.indentate(x)+"<"+P+"?"+this.tagEndChar:S+=this.indentate(x)+"<"+P+"/"+this.tagEndChar;else if(_[P]instanceof Date)S+=this.buildTextValNode(_[P],P,"",x);else if(typeof _[P]!="object"){const L=this.isAttribute(P);if(L)b+=this.buildAttrPairStr(L,""+_[P]);else if(P===this.options.textNodeName){let E=this.options.tagValueProcessor(P,""+_[P]);S+=this.replaceEntitiesValue(E)}else S+=this.buildTextValNode(_[P],P,"",x)}else if(Array.isArray(_[P])){const L=_[P].length;let E="",C="";for(let D=0;D<L;D++){const O=_[P][D];if(!(typeof O>"u"))if(O===null)P[0]==="?"?S+=this.indentate(x)+"<"+P+"?"+this.tagEndChar:S+=this.indentate(x)+"<"+P+"/"+this.tagEndChar;else if(typeof O=="object")if(this.options.oneListGroup){const U=this.j2x(O,x+1);E+=U.val,this.options.attributesGroupName&&O.hasOwnProperty(this.options.attributesGroupName)&&(C+=U.attrStr)}else E+=this.processTextOrObjNode(O,P,x);else if(this.options.oneListGroup){let U=this.options.tagValueProcessor(P,O);U=this.replaceEntitiesValue(U),E+=U}else E+=this.buildTextValNode(O,P,"",x)}this.options.oneListGroup&&(E=this.buildObjectNode(E,P,C,x)),S+=E}else if(this.options.attributesGroupName&&P===this.options.attributesGroupName){const L=Object.keys(_[P]),E=L.length;for(let C=0;C<E;C++)b+=this.buildAttrPairStr(L[C],""+_[P][L[C]])}else S+=this.processTextOrObjNode(_[P],P,x);return{attrStr:b,val:S}},s.prototype.buildAttrPairStr=function(_,x){return x=this.options.attributeValueProcessor(_,""+x),x=this.replaceEntitiesValue(x),this.options.suppressBooleanAttributes&&x==="true"?" "+_:" "+_+'="'+x+'"'};function d(_,x,b){const S=this.j2x(_,b+1);return _[this.options.textNodeName]!==void 0&&Object.keys(_).length===1?this.buildTextValNode(_[this.options.textNodeName],x,S.attrStr,b):this.buildObjectNode(S.val,x,S.attrStr,b)}s.prototype.buildObjectNode=function(_,x,b,S){if(_==="")return x[0]==="?"?this.indentate(S)+"<"+x+b+"?"+this.tagEndChar:this.indentate(S)+"<"+x+b+this.closeTag(x)+this.tagEndChar;{let P="</"+x+this.tagEndChar,L="";return x[0]==="?"&&(L="?",P=""),(b||b==="")&&_.indexOf("<")===-1?this.indentate(S)+"<"+x+b+L+">"+_+P:this.options.commentPropName!==!1&&x===this.options.commentPropName&&L.length===0?this.indentate(S)+`<!--${_}-->`+this.newLine:this.indentate(S)+"<"+x+b+L+this.tagEndChar+_+this.indentate(S)+P}},s.prototype.closeTag=function(_){let x="";return this.options.unpairedTags.indexOf(_)!==-1?this.options.suppressUnpairedNode||(x="/"):this.options.suppressEmptyNode?x="/":x=`></${_}`,x},s.prototype.buildTextValNode=function(_,x,b,S){if(this.options.cdataPropName!==!1&&x===this.options.cdataPropName)return this.indentate(S)+`<![CDATA[${_}]]>`+this.newLine;if(this.options.commentPropName!==!1&&x===this.options.commentPropName)return this.indentate(S)+`<!--${_}-->`+this.newLine;if(x[0]==="?")return this.indentate(S)+"<"+x+b+"?"+this.tagEndChar;{let P=this.options.tagValueProcessor(x,_);return P=this.replaceEntitiesValue(P),P===""?this.indentate(S)+"<"+x+b+this.closeTag(x)+this.tagEndChar:this.indentate(S)+"<"+x+b+">"+P+"</"+x+this.tagEndChar}},s.prototype.replaceEntitiesValue=function(_){if(_&&_.length>0&&this.options.processEntities)for(let x=0;x<this.options.entities.length;x++){const b=this.options.entities[x];_=_.replace(b.regex,b.val)}return _};function p(_){return this.options.indentBy.repeat(_)}function g(_){return _.startsWith(this.options.attributeNamePrefix)&&_!==this.options.textNodeName?_.substr(this.attrPrefixLen):!1}i.exports=s},{"./orderedJs2Xml":7}],7:[function(t,i,r){function c(x,b){let S="";return b.format&&b.indentBy.length>0&&(S=`
`),s(x,b,"",S)}function s(x,b,S,P){let L="",E=!1;for(let C=0;C<x.length;C++){const D=x[C],O=d(D);if(O===void 0)continue;let U="";if(S.length===0?U=O:U=`${S}.${O}`,O===b.textNodeName){let q=D[O];g(U,b)||(q=b.tagValueProcessor(O,q),q=_(q,b)),E&&(L+=P),L+=q,E=!1;continue}else if(O===b.cdataPropName){E&&(L+=P),L+=`<![CDATA[${D[O][0][b.textNodeName]}]]>`,E=!1;continue}else if(O===b.commentPropName){L+=P+`<!--${D[O][0][b.textNodeName]}-->`,E=!0;continue}else if(O[0]==="?"){const q=p(D[":@"],b),z=O==="?xml"?"":P;let Q=D[O][0][b.textNodeName];Q=Q.length!==0?" "+Q:"",L+=z+`<${O}${Q}${q}?>`,E=!0;continue}let j=P;j!==""&&(j+=b.indentBy);const G=p(D[":@"],b),N=P+`<${O}${G}`,V=s(D[O],b,U,j);b.unpairedTags.indexOf(O)!==-1?b.suppressUnpairedNode?L+=N+">":L+=N+"/>":(!V||V.length===0)&&b.suppressEmptyNode?L+=N+"/>":V&&V.endsWith(">")?L+=N+`>${V}${P}</${O}>`:(L+=N+">",V&&P!==""&&(V.includes("/>")||V.includes("</"))?L+=P+b.indentBy+V+P:L+=V,L+=`</${O}>`),E=!0}return L}function d(x){const b=Object.keys(x);for(let S=0;S<b.length;S++){const P=b[S];if(x.hasOwnProperty(P)&&P!==":@")return P}}function p(x,b){let S="";if(x&&!b.ignoreAttributes)for(let P in x){if(!x.hasOwnProperty(P))continue;let L=b.attributeValueProcessor(P,x[P]);L=_(L,b),L===!0&&b.suppressBooleanAttributes?S+=` ${P.substr(b.attributeNamePrefix.length)}`:S+=` ${P.substr(b.attributeNamePrefix.length)}="${L}"`}return S}function g(x,b){x=x.substr(0,x.length-b.textNodeName.length-1);let S=x.substr(x.lastIndexOf(".")+1);for(let P in b.stopNodes)if(b.stopNodes[P]===x||b.stopNodes[P]==="*."+S)return!0;return!1}function _(x,b){if(x&&x.length>0&&b.processEntities)for(let S=0;S<b.entities.length;S++){const P=b.entities[S];x=x.replace(P.regex,P.val)}return x}i.exports=c},{}],8:[function(t,i,r){const o=t("../util");function c(S,P){const L={};if(S[P+3]==="O"&&S[P+4]==="C"&&S[P+5]==="T"&&S[P+6]==="Y"&&S[P+7]==="P"&&S[P+8]==="E"){P=P+9;let E=1,C=!1,D=!1,O="";for(;P<S.length;P++)if(S[P]==="<"&&!D){if(C&&p(S,P))P+=7,[entityName,val,P]=s(S,P+1),val.indexOf("&")===-1&&(L[b(entityName)]={regx:RegExp(`&${entityName};`,"g"),val});else if(C&&g(S,P))P+=8;else if(C&&_(S,P))P+=8;else if(C&&x(S,P))P+=9;else if(d)D=!0;else throw new Error("Invalid DOCTYPE");E++,O=""}else if(S[P]===">"){if(D?S[P-1]==="-"&&S[P-2]==="-"&&(D=!1,E--):E--,E===0)break}else S[P]==="["?C=!0:O+=S[P];if(E!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:L,i:P}}function s(S,P){let L="";for(;P<S.length&&S[P]!=="'"&&S[P]!=='"';P++)L+=S[P];if(L=L.trim(),L.indexOf(" ")!==-1)throw new Error("External entites are not supported");const E=S[P++];let C="";for(;P<S.length&&S[P]!==E;P++)C+=S[P];return[L,C,P]}function d(S,P){return S[P+1]==="!"&&S[P+2]==="-"&&S[P+3]==="-"}function p(S,P){return S[P+1]==="!"&&S[P+2]==="E"&&S[P+3]==="N"&&S[P+4]==="T"&&S[P+5]==="I"&&S[P+6]==="T"&&S[P+7]==="Y"}function g(S,P){return S[P+1]==="!"&&S[P+2]==="E"&&S[P+3]==="L"&&S[P+4]==="E"&&S[P+5]==="M"&&S[P+6]==="E"&&S[P+7]==="N"&&S[P+8]==="T"}function _(S,P){return S[P+1]==="!"&&S[P+2]==="A"&&S[P+3]==="T"&&S[P+4]==="T"&&S[P+5]==="L"&&S[P+6]==="I"&&S[P+7]==="S"&&S[P+8]==="T"}function x(S,P){return S[P+1]==="!"&&S[P+2]==="N"&&S[P+3]==="O"&&S[P+4]==="T"&&S[P+5]==="A"&&S[P+6]==="T"&&S[P+7]==="I"&&S[P+8]==="O"&&S[P+9]==="N"}function b(S){if(o.isName(S))return S;throw new Error(`Invalid entity name ${S}`)}i.exports=c},{"../util":4}],9:[function(t,i,r){const o={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(s,d){return d},attributeValueProcessor:function(s,d){return d},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(s,d,p){return s}},c=function(s){return Object.assign({},o,s)};r.buildOptions=c,r.defaultOptions=o},{}],10:[function(t,i,r){const o=t("../util"),c=t("./xmlNode"),s=t("./DocTypeReader"),d=t("strnum");class p{constructor(q){this.options=q,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"Â¢"},pound:{regex:/&(pound|#163);/g,val:"Â£"},yen:{regex:/&(yen|#165);/g,val:"Â¥"},euro:{regex:/&(euro|#8364);/g,val:"â¬"},copyright:{regex:/&(copy|#169);/g,val:"Â©"},reg:{regex:/&(reg|#174);/g,val:"Â®"},inr:{regex:/&(inr|#8377);/g,val:"â¹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(z,Q)=>String.fromCharCode(Number.parseInt(Q,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(z,Q)=>String.fromCharCode(Number.parseInt(Q,16))}},this.addExternalEntities=g,this.parseXml=P,this.parseTextData=_,this.resolveNameSpace=x,this.buildAttributesMap=S,this.isItStopNode=D,this.replaceEntitiesValue=E,this.readStopNodeData=G,this.saveTextToParentTag=C,this.addChild=L}}function g(V){const q=Object.keys(V);for(let z=0;z<q.length;z++){const Q=q[z];this.lastEntities[Q]={regex:new RegExp("&"+Q+";","g"),val:V[Q]}}}function _(V,q,z,Q,X,re,oe){if(V!==void 0&&(this.options.trimValues&&!Q&&(V=V.trim()),V.length>0)){oe||(V=this.replaceEntitiesValue(V));const de=this.options.tagValueProcessor(q,V,z,X,re);return de==null?V:typeof de!=typeof V||de!==V?de:this.options.trimValues?N(V,this.options.parseTagValue,this.options.numberParseOptions):V.trim()===V?N(V,this.options.parseTagValue,this.options.numberParseOptions):V}}function x(V){if(this.options.removeNSPrefix){const q=V.split(":"),z=V.charAt(0)==="/"?"/":"";if(q[0]==="xmlns")return"";q.length===2&&(V=z+q[1])}return V}const b=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function S(V,q,z){if(!this.options.ignoreAttributes&&typeof V=="string"){const Q=o.getAllMatches(V,b),X=Q.length,re={};for(let oe=0;oe<X;oe++){const de=this.resolveNameSpace(Q[oe][1]);let ce=Q[oe][4],Se=this.options.attributeNamePrefix+de;if(de.length)if(this.options.transformAttributeName&&(Se=this.options.transformAttributeName(Se)),Se==="__proto__"&&(Se="#__proto__"),ce!==void 0){this.options.trimValues&&(ce=ce.trim()),ce=this.replaceEntitiesValue(ce);const Pe=this.options.attributeValueProcessor(de,ce,q);Pe==null?re[Se]=ce:typeof Pe!=typeof ce||Pe!==ce?re[Se]=Pe:re[Se]=N(ce,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(re[Se]=!0)}if(!Object.keys(re).length)return;if(this.options.attributesGroupName){const oe={};return oe[this.options.attributesGroupName]=re,oe}return re}}const P=function(V){V=V.replace(/\r\n?/g,`
`);const q=new c("!xml");let z=q,Q="",X="";for(let re=0;re<V.length;re++)if(V[re]==="<")if(V[re+1]==="/"){const de=U(V,">",re,"Closing Tag is not closed.");let ce=V.substring(re+2,de).trim();if(this.options.removeNSPrefix){const je=ce.indexOf(":");je!==-1&&(ce=ce.substr(je+1))}this.options.transformTagName&&(ce=this.options.transformTagName(ce)),z&&(Q=this.saveTextToParentTag(Q,z,X));const Se=X.substring(X.lastIndexOf(".")+1);if(ce&&this.options.unpairedTags.indexOf(ce)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${ce}>`);let Pe=0;Se&&this.options.unpairedTags.indexOf(Se)!==-1?(Pe=X.lastIndexOf(".",X.lastIndexOf(".")-1),this.tagsNodeStack.pop()):Pe=X.lastIndexOf("."),X=X.substring(0,Pe),z=this.tagsNodeStack.pop(),Q="",re=de}else if(V[re+1]==="?"){let de=j(V,re,!1,"?>");if(!de)throw new Error("Pi Tag is not closed.");if(Q=this.saveTextToParentTag(Q,z,X),!(this.options.ignoreDeclaration&&de.tagName==="?xml"||this.options.ignorePiTags)){const ce=new c(de.tagName);ce.add(this.options.textNodeName,""),de.tagName!==de.tagExp&&de.attrExpPresent&&(ce[":@"]=this.buildAttributesMap(de.tagExp,X,de.tagName)),this.addChild(z,ce,X)}re=de.closeIndex+1}else if(V.substr(re+1,3)==="!--"){const de=U(V,"-->",re+4,"Comment is not closed.");if(this.options.commentPropName){const ce=V.substring(re+4,de-2);Q=this.saveTextToParentTag(Q,z,X),z.add(this.options.commentPropName,[{[this.options.textNodeName]:ce}])}re=de}else if(V.substr(re+1,2)==="!D"){const de=s(V,re);this.docTypeEntities=de.entities,re=de.i}else if(V.substr(re+1,2)==="!["){const de=U(V,"]]>",re,"CDATA is not closed.")-2,ce=V.substring(re+9,de);Q=this.saveTextToParentTag(Q,z,X);let Se=this.parseTextData(ce,z.tagname,X,!0,!1,!0,!0);Se==null&&(Se=""),this.options.cdataPropName?z.add(this.options.cdataPropName,[{[this.options.textNodeName]:ce}]):z.add(this.options.textNodeName,Se),re=de+2}else{let de=j(V,re,this.options.removeNSPrefix),ce=de.tagName;const Se=de.rawTagName;let Pe=de.tagExp,je=de.attrExpPresent,Fe=de.closeIndex;this.options.transformTagName&&(ce=this.options.transformTagName(ce)),z&&Q&&z.tagname!=="!xml"&&(Q=this.saveTextToParentTag(Q,z,X,!1));const qe=z;if(qe&&this.options.unpairedTags.indexOf(qe.tagname)!==-1&&(z=this.tagsNodeStack.pop(),X=X.substring(0,X.lastIndexOf("."))),ce!==q.tagname&&(X+=X?"."+ce:ce),this.isItStopNode(this.options.stopNodes,X,ce)){let Ue="";if(Pe.length>0&&Pe.lastIndexOf("/")===Pe.length-1)ce[ce.length-1]==="/"?(ce=ce.substr(0,ce.length-1),X=X.substr(0,X.length-1),Pe=ce):Pe=Pe.substr(0,Pe.length-1),re=de.closeIndex;else if(this.options.unpairedTags.indexOf(ce)!==-1)re=de.closeIndex;else{const et=this.readStopNodeData(V,Se,Fe+1);if(!et)throw new Error(`Unexpected end of ${Se}`);re=et.i,Ue=et.tagContent}const ke=new c(ce);ce!==Pe&&je&&(ke[":@"]=this.buildAttributesMap(Pe,X,ce)),Ue&&(Ue=this.parseTextData(Ue,ce,X,!0,je,!0,!0)),X=X.substr(0,X.lastIndexOf(".")),ke.add(this.options.textNodeName,Ue),this.addChild(z,ke,X)}else{if(Pe.length>0&&Pe.lastIndexOf("/")===Pe.length-1){ce[ce.length-1]==="/"?(ce=ce.substr(0,ce.length-1),X=X.substr(0,X.length-1),Pe=ce):Pe=Pe.substr(0,Pe.length-1),this.options.transformTagName&&(ce=this.options.transformTagName(ce));const Ue=new c(ce);ce!==Pe&&je&&(Ue[":@"]=this.buildAttributesMap(Pe,X,ce)),this.addChild(z,Ue,X),X=X.substr(0,X.lastIndexOf("."))}else{const Ue=new c(ce);this.tagsNodeStack.push(z),ce!==Pe&&je&&(Ue[":@"]=this.buildAttributesMap(Pe,X,ce)),this.addChild(z,Ue,X),z=Ue}Q="",re=Fe}}else Q+=V[re];return q.child};function L(V,q,z){const Q=this.options.updateTag(q.tagname,z,q[":@"]);Q===!1||(typeof Q=="string"&&(q.tagname=Q),V.addChild(q))}const E=function(V){if(this.options.processEntities){for(let q in this.docTypeEntities){const z=this.docTypeEntities[q];V=V.replace(z.regx,z.val)}for(let q in this.lastEntities){const z=this.lastEntities[q];V=V.replace(z.regex,z.val)}if(this.options.htmlEntities)for(let q in this.htmlEntities){const z=this.htmlEntities[q];V=V.replace(z.regex,z.val)}V=V.replace(this.ampEntity.regex,this.ampEntity.val)}return V};function C(V,q,z,Q){return V&&(Q===void 0&&(Q=Object.keys(q.child).length===0),V=this.parseTextData(V,q.tagname,z,!1,q[":@"]?Object.keys(q[":@"]).length!==0:!1,Q),V!==void 0&&V!==""&&q.add(this.options.textNodeName,V),V=""),V}function D(V,q,z){const Q="*."+z;for(const X in V){const re=V[X];if(Q===re||q===re)return!0}return!1}function O(V,q,z=">"){let Q,X="";for(let re=q;re<V.length;re++){let oe=V[re];if(Q)oe===Q&&(Q="");else if(oe==='"'||oe==="'")Q=oe;else if(oe===z[0])if(z[1]){if(V[re+1]===z[1])return{data:X,index:re}}else return{data:X,index:re};else oe==="	"&&(oe=" ");X+=oe}}function U(V,q,z,Q){const X=V.indexOf(q,z);if(X===-1)throw new Error(Q);return X+q.length-1}function j(V,q,z,Q=">"){const X=O(V,q+1,Q);if(!X)return;let re=X.data;const oe=X.index,de=re.search(/\s/);let ce=re,Se=!0;de!==-1&&(ce=re.substring(0,de),re=re.substring(de+1).trimStart());const Pe=ce;if(z){const je=ce.indexOf(":");je!==-1&&(ce=ce.substr(je+1),Se=ce!==X.data.substr(je+1))}return{tagName:ce,tagExp:re,closeIndex:oe,attrExpPresent:Se,rawTagName:Pe}}function G(V,q,z){const Q=z;let X=1;for(;z<V.length;z++)if(V[z]==="<")if(V[z+1]==="/"){const re=U(V,">",z,`${q} is not closed`);if(V.substring(z+2,re).trim()===q&&(X--,X===0))return{tagContent:V.substring(Q,z),i:re};z=re}else if(V[z+1]==="?")z=U(V,"?>",z+1,"StopNode is not closed.");else if(V.substr(z+1,3)==="!--")z=U(V,"-->",z+3,"StopNode is not closed.");else if(V.substr(z+1,2)==="![")z=U(V,"]]>",z,"StopNode is not closed.")-2;else{const re=j(V,z,">");re&&((re&&re.tagName)===q&&re.tagExp[re.tagExp.length-1]!=="/"&&X++,z=re.closeIndex)}}function N(V,q,z){if(q&&typeof V=="string"){const Q=V.trim();return Q==="true"?!0:Q==="false"?!1:d(V,z)}else return o.isExist(V)?V:""}i.exports=p},{"../util":4,"./DocTypeReader":8,"./xmlNode":13,strnum:15}],11:[function(t,i,r){const{buildOptions:o}=t("./OptionsBuilder"),c=t("./OrderedObjParser"),{prettify:s}=t("./node2json"),d=t("../validator");class p{constructor(_){this.externalEntities={},this.options=o(_)}parse(_,x){if(typeof _!="string")if(_.toString)_=_.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(x){x===!0&&(x={});const P=d.validate(_,x);if(P!==!0)throw Error(`${P.err.msg}:${P.err.line}:${P.err.col}`)}const b=new c(this.options);b.addExternalEntities(this.externalEntities);const S=b.parseXml(_);return this.options.preserveOrder||S===void 0?S:s(S,this.options)}addEntity(_,x){if(x.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(_.indexOf("&")!==-1||_.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(x==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[_]=x}}i.exports=p},{"../validator":5,"./OptionsBuilder":9,"./OrderedObjParser":10,"./node2json":12}],12:[function(t,i,r){function o(g,_){return c(g,_)}function c(g,_,x){let b;const S={};for(let P=0;P<g.length;P++){const L=g[P],E=s(L);let C="";if(x===void 0?C=E:C=x+"."+E,E===_.textNodeName)b===void 0?b=L[E]:b+=""+L[E];else{if(E===void 0)continue;if(L[E]){let D=c(L[E],_,C);const O=p(D,_);L[":@"]?d(D,L[":@"],C,_):Object.keys(D).length===1&&D[_.textNodeName]!==void 0&&!_.alwaysCreateTextNode?D=D[_.textNodeName]:Object.keys(D).length===0&&(_.alwaysCreateTextNode?D[_.textNodeName]="":D=""),S[E]!==void 0&&S.hasOwnProperty(E)?(Array.isArray(S[E])||(S[E]=[S[E]]),S[E].push(D)):_.isArray(E,C,O)?S[E]=[D]:S[E]=D}}}return typeof b=="string"?b.length>0&&(S[_.textNodeName]=b):b!==void 0&&(S[_.textNodeName]=b),S}function s(g){const _=Object.keys(g);for(let x=0;x<_.length;x++){const b=_[x];if(b!==":@")return b}}function d(g,_,x,b){if(_){const S=Object.keys(_),P=S.length;for(let L=0;L<P;L++){const E=S[L];b.isArray(E,x+"."+E,!0,!0)?g[E]=[_[E]]:g[E]=_[E]}}}function p(g,_){const{textNodeName:x}=_,b=Object.keys(g).length;return!!(b===0||b===1&&(g[x]||typeof g[x]=="boolean"||g[x]===0))}r.prettify=o},{}],13:[function(t,i,r){class o{constructor(s){this.tagname=s,this.child=[],this[":@"]={}}add(s,d){s==="__proto__"&&(s="#__proto__"),this.child.push({[s]:d})}addChild(s){s.tagname==="__proto__"&&(s.tagname="#__proto__"),s[":@"]&&Object.keys(s[":@"]).length>0?this.child.push({[s.tagname]:s.child,":@":s[":@"]}):this.child.push({[s.tagname]:s.child})}}i.exports=o},{}],14:[function(t,i,r){r.read=function(o,c,s,d,p){var g,_,x=p*8-d-1,b=(1<<x)-1,S=b>>1,P=-7,L=s?p-1:0,E=s?-1:1,C=o[c+L];for(L+=E,g=C&(1<<-P)-1,C>>=-P,P+=x;P>0;g=g*256+o[c+L],L+=E,P-=8);for(_=g&(1<<-P)-1,g>>=-P,P+=d;P>0;_=_*256+o[c+L],L+=E,P-=8);if(g===0)g=1-S;else{if(g===b)return _?NaN:(C?-1:1)*(1/0);_=_+Math.pow(2,d),g=g-S}return(C?-1:1)*_*Math.pow(2,g-d)},r.write=function(o,c,s,d,p,g){var _,x,b,S=g*8-p-1,P=(1<<S)-1,L=P>>1,E=p===23?Math.pow(2,-24)-Math.pow(2,-77):0,C=d?0:g-1,D=d?1:-1,O=c<0||c===0&&1/c<0?1:0;for(c=Math.abs(c),isNaN(c)||c===1/0?(x=isNaN(c)?1:0,_=P):(_=Math.floor(Math.log(c)/Math.LN2),c*(b=Math.pow(2,-_))<1&&(_--,b*=2),_+L>=1?c+=E/b:c+=E*Math.pow(2,1-L),c*b>=2&&(_++,b/=2),_+L>=P?(x=0,_=P):_+L>=1?(x=(c*b-1)*Math.pow(2,p),_=_+L):(x=c*Math.pow(2,L-1)*Math.pow(2,p),_=0));p>=8;o[s+C]=x&255,C+=D,x/=256,p-=8);for(_=_<<p|x,S+=p;S>0;o[s+C]=_&255,C+=D,_/=256,S-=8);o[s+C-D]|=O*128}},{}],15:[function(t,i,r){const o=/^[-+]?0x[a-fA-F0-9]+$/,c=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/;!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt),!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat);const s={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function d(g,_={}){if(_=Object.assign({},s,_),!g||typeof g!="string")return g;let x=g.trim();if(_.skipLike!==void 0&&_.skipLike.test(x))return g;if(_.hex&&o.test(x))return Number.parseInt(x,16);{const b=c.exec(x);if(b){const S=b[1],P=b[2];let L=p(b[3]);const E=b[4]||b[6];if(!_.leadingZeros&&P.length>0&&S&&x[2]!==".")return g;if(!_.leadingZeros&&P.length>0&&!S&&x[1]!==".")return g;{const C=Number(x),D=""+C;return D.search(/[eE]/)!==-1||E?_.eNotation?C:g:x.indexOf(".")!==-1?D==="0"&&L===""||D===L||S&&D==="-"+L?C:g:P?L===D||S+L===D?C:g:x===D||x===S+D?C:g}}else return g}}function p(g){return g&&g.indexOf(".")!==-1&&(g=g.replace(/0+$/,""),g==="."?g="0":g[0]==="."?g="0"+g:g[g.length-1]==="."&&(g=g.substr(0,g.length-1))),g}i.exports=d},{}],16:[function(t,i,r){i.exports={name:"osm-api",version:"3.3.1",contributors:["Kyle Hensel (https://github.com/k-yle)"],description:"ðºï¸ð Javascript/Typescript wrapper around the OpenStreetMap API",main:"dist",unpkg:"dist/index.min.js",types:"dist/src/index.d.ts",license:"MIT",files:["dist"],keywords:["osm","openstreetmap","openstreetmap api"],repository:"https://github.com/osmlab/osm-api-js",scripts:{build:"rm -rf dist && tsc --emitDeclarationOnly && rm -rf dist/__tests__ && browserify -s OSM src/index.ts -p tsify > dist/index.js && uglifyjs dist/index.js > dist/index.min.js",lint:"eslint .",test:"vitest",trypublish:"npm publish --provenance || true"},engines:{node:">=18"},dependencies:{"@types/geojson":"^7946.0.13","fast-xml-parser":"^4.4.1"},devDependencies:{"@types/node":"^22.5.5",browserify:"^17.0.0",eslint:"^9.10.0","eslint-config-kyle":"^25.0.0-beta3",tsify:"^5.0.4",typescript:"^5.6.2","uglify-js":"^3.19.3",vitest:"^2.1.1"},prettier:{trailingComma:"es5"}}},{}],17:[function(t,i,r){(function(o){(function(){var c=this&&this.__awaiter||function(x,b,S,P){function L(E){return E instanceof S?E:new S(function(C){C(E)})}return new(S||(S=Promise))(function(E,C){function D(j){try{U(P.next(j))}catch(G){C(G)}}function O(j){try{U(P.throw(j))}catch(G){C(G)}}function U(j){j.done?E(j.value):L(j.value).then(D,O)}U((P=P.apply(x,b||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.osmFetch=_;const s=t("../auth"),d=t("../config"),p=t("./_xml"),g=x=>typeof btoa>"u"?o.from(x,"binary").toString("base64"):btoa(x);function _(x,b,S){return c(this,void 0,void 0,function*(){const{apiUrl:P,authHeader:L,basicAuth:E,userAgent:C}=(0,d.getConfig)(),D=E&&`Basic ${g(`${E.username}:${E.password}`)}`,O=(0,s.getAuthToken)()&&`Bearer ${(0,s.getAuthToken)()}`;let U=new URLSearchParams(b).toString();U&&(U=`?${U}`);const j=yield fetch(`${P}/api${x}${U}`,Object.assign(Object.assign({},S),{headers:Object.assign({Authorization:L||D||O||"","User-Agent":C},S?.headers)})),G=j.headers.get("Content-Type");if(G?.startsWith("application/xml")){const V=yield j.text();return yield p.xmlParser.parse(V)}if(G?.startsWith("application/json"))return j.json();if(j.ok)return yield j.text();const N=new Error(`OSM API: ${yield j.text()}`);throw N.cause=j.status,N})}}).call(this)}).call(this,t("buffer").Buffer)},{"../auth":58,"../config":60,"./_xml":18,buffer:2}],18:[function(t,i,r){Object.defineProperty(r,"__esModule",{value:!0}),r.xmlParser=void 0;const o=t("fast-xml-parser");r.xmlParser=new o.XMLParser({ignoreAttributes:!1,attributesGroupName:"$",attributeNamePrefix:"",isArray:c=>c!=="$",attributeValueProcessor(c,s){return s.replaceAll(/&#(x9|9);/g,"	").replaceAll(/&#(xA|10);/g,`
`).replaceAll(/&#(xD|13);/g,"\r")}})},{"fast-xml-parser":3}],19:[function(t,i,r){Object.defineProperty(r,"__esModule",{value:!0}),r.createChangesetMetaXml=s,r.createOsmChangeXml=p;const o=t("fast-xml-parser"),c=new o.XMLBuilder({ignoreAttributes:!1,attributeNamePrefix:"$",format:!0,suppressEmptyNode:!0,suppressBooleanAttributes:!1,entities:[{regex:/&/g,val:"&amp;"},{regex:/>/g,val:"&gt;"},{regex:/</g,val:"&lt;"},{regex:/'/g,val:"&apos;"},{regex:/"/g,val:"&quot;"},{regex:/\t/g,val:"&#9;"},{regex:/\n/g,val:"&#10;"},{regex:/\r/g,val:"&#13;"}]});function s(g){return c.build({osm:{changeset:{tag:Object.entries(g).map(([_,x])=>({$k:_,$v:x}))}}})}const d=(g,_,x)=>{const b=["node","way","relation"];return x==="delete"&&b.reverse(),_.reduce((S,P)=>{const L={$id:P.id,$version:x==="create"?0:P.version,$changeset:g,tag:Object.entries(P.tags||{}).map(([E,C])=>({$k:E,$v:C}))};switch(P.type){case"node":{const E=Object.assign(Object.assign({},L),{$lat:P.lat,$lon:P.lon});return Object.assign(Object.assign({},S),{node:[...S.node,E]})}case"way":{if(!P.nodes)throw new Error("Way has no nodes");const E=Object.assign(Object.assign({},L),{nd:P.nodes.map(C=>({$ref:C}))});return Object.assign(Object.assign({},S),{way:[...S.way,E]})}case"relation":{if(!P.members)throw new Error("Relation has no members");const E=Object.assign(Object.assign({},L),{member:P.members.map(C=>({$type:C.type,$ref:C.ref,$role:C.role}))});return Object.assign(Object.assign({},S),{relation:[...S.relation,E]})}default:return S}},Object.fromEntries(b.map(S=>[S,[]])))};function p(g,_,x){return c.build({osmChange:{$version:"0.6",$generator:"osm-api-js",changeset:x?{tag:Object.entries(x).map(([b,S])=>({$k:b,$v:S}))}:void 0,create:[d(g,_.create,"create")],modify:[d(g,_.modify,"modify")],delete:[Object.assign({"$if-unused":!0},d(g,_.delete,"delete"))]}})}},{"fast-xml-parser":3}],20:[function(t,i,r){Object.defineProperty(r,"__esModule",{value:!0}),r.parseOsmChangeJson=p,r.parseOsmChangeXml=g;const o=t("../_xml");function c(_){if(_?.tag)return Object.fromEntries(_.tag.map(x=>[x.$.k,x.$.v]))}function s(_){return{changeset:+_.$.changeset,id:+_.$.id,timestamp:_.$.timestamp,uid:+_.$.uid,user:_.$.user,version:+_.$.version,tags:c(_)}}const d=_=>{const x=[];if(_.node){const b=_.node.map(S=>Object.assign(Object.assign({type:"node"},s(S)),{lat:+S.$.lat,lon:+S.$.lon}));x.push(...b)}if(_.way){const b=_.way.map(S=>{var P;return Object.assign(Object.assign({type:"way"},s(S)),{nodes:((P=S.nd)===null||P===void 0?void 0:P.map(L=>+L.$.ref))||[]})});x.push(...b)}if(_.relation){const b=_.relation.map(S=>{var P;return Object.assign(Object.assign({type:"relation"},s(S)),{members:((P=S.member)===null||P===void 0?void 0:P.map(L=>({ref:+L.$.ref,role:L.$.role,type:L.$.type})))||[]})});x.push(...b)}return x};function p(_){var x,b,S,P;const L=c((x=_.osmChange[0].changeset)===null||x===void 0?void 0:x[0]),E={create:((b=_.osmChange[0].create)===null||b===void 0?void 0:b.flatMap(d))||[],modify:((S=_.osmChange[0].modify)===null||S===void 0?void 0:S.flatMap(d))||[],delete:((P=_.osmChange[0].delete)===null||P===void 0?void 0:P.flatMap(d))||[]};return L&&(E.changeset=L),E}function g(_){const x=o.xmlParser.parse(_);return p(x)}},{"../_xml":18}],21:[function(t,i,r){Object.defineProperty(r,"__esModule",{value:!0}),r.getOsmChangeSize=d,r.chunkOsmChange=p;const o=["create","modify","delete"],c=["create-node","create-way","create-relation","delete-relation","delete-way","delete-node","modify-node","modify-way","modify-relation"],s=()=>({create:[],modify:[],delete:[]});function d(g){return g.create.length+g.modify.length+g.delete.length}function p(g,_){var x;const b=(x=_?.api.changesets.maximum_elements)!==null&&x!==void 0?x:p.DEFAULT_LIMIT;if(d(g)<=b)return[g];const S={};for(const C of o)for(const D of g[C]){const O=`${C}-${D.type}`;S[O]||(S[O]=[]),S[O].push(D)}const P=[s()];function L(){var C;for(const D of c){const O=D.split("-")[0],U=(C=S[D])===null||C===void 0?void 0:C.pop();if(U)return{action:O,feature:U}}}let E;for(;E=L();){const C=P[0];C[E.action].push(E.feature),d(C)>=b&&P.unshift(s())}return P.reverse()}p.DEFAULT_LIMIT=1e4},{}],22:[function(t,i,r){var o=this&&this.__awaiter||function(p,g,_,x){function b(S){return S instanceof _?S:new _(function(P){P(S)})}return new(_||(_=Promise))(function(S,P){function L(D){try{C(x.next(D))}catch(O){P(O)}}function E(D){try{C(x.throw(D))}catch(O){P(O)}}function C(D){D.done?S(D.value):b(D.value).then(L,E)}C((x=x.apply(p,g||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.createChangesetComment=d;const c=t("../_osmFetch"),s=t("./getChangesets");function d(p,g,_){return o(this,void 0,void 0,function*(){const x=yield(0,c.osmFetch)(`/0.6/changeset/${p}/comment.json`,void 0,Object.assign(Object.assign({},_),{method:"POST",body:`text=${encodeURIComponent(g)}`,headers:Object.assign(Object.assign({},_?.headers),{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"})}));return(0,s.mapRawChangeset)(x.changeset)})}},{"../_osmFetch":17,"./getChangesets":24}],23:[function(t,i,r){var o=this&&this.__awaiter||function(p,g,_,x){function b(S){return S instanceof _?S:new _(function(P){P(S)})}return new(_||(_=Promise))(function(S,P){function L(D){try{C(x.next(D))}catch(O){P(O)}}function E(D){try{C(x.throw(D))}catch(O){P(O)}}function C(D){D.done?S(D.value):b(D.value).then(L,E)}C((x=x.apply(p,g||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getChangesetDiff=d;const c=t("../_osmFetch"),s=t("./_parseOsmChangeXml");function d(p,g){return o(this,void 0,void 0,function*(){const _=yield(0,c.osmFetch)(`/0.6/changeset/${p}/download`,void 0,g);return(0,s.parseOsmChangeJson)(_)})}},{"../_osmFetch":17,"./_parseOsmChangeXml":20}],24:[function(t,i,r){var o=this&&this.__awaiter||function(_,x,b,S){function P(L){return L instanceof b?L:new b(function(E){E(L)})}return new(b||(b=Promise))(function(L,E){function C(U){try{O(S.next(U))}catch(j){E(j)}}function D(U){try{O(S.throw(U))}catch(j){E(j)}}function O(U){U.done?L(U.value):P(U.value).then(C,D)}O((S=S.apply(_,x||[])).next())})},c=this&&this.__rest||function(_,x){var b={};for(var S in _)Object.prototype.hasOwnProperty.call(_,S)&&x.indexOf(S)<0&&(b[S]=_[S]);if(_!=null&&typeof Object.getOwnPropertySymbols=="function")for(var P=0,S=Object.getOwnPropertySymbols(_);P<S.length;P++)x.indexOf(S[P])<0&&Object.prototype.propertyIsEnumerable.call(_,S[P])&&(b[S[P]]=_[S[P]]);return b};Object.defineProperty(r,"__esModule",{value:!0}),r.mapRawChangeset=void 0,r.listChangesets=p,r.getChangeset=g;const s=t("../_osmFetch"),d=_=>{var{comments:x}=_,b=c(_,["comments"]);return Object.assign(Object.assign({},b),{created_at:new Date(b.created_at),closed_at:b.closed_at?new Date(b.closed_at):void 0,discussion:x?.map(S=>Object.assign(Object.assign({},S),{date:new Date(S.date),uid:`${S.uid}`}))})};r.mapRawChangeset=d;function p(_,x){return o(this,void 0,void 0,function*(){const{only:b}=_,S=c(_,["only"]);return(yield(0,s.osmFetch)("/0.6/changesets.json",Object.assign(Object.assign({},b&&{[b]:!0}),S),x)).changesets.map(r.mapRawChangeset)})}function g(_){return o(this,arguments,void 0,function*(x,b=!0,S){const P=yield(0,s.osmFetch)(`/0.6/changeset/${x}.json`,b?{include_discussion:1}:{},S);return(0,r.mapRawChangeset)(P.changeset)})}},{"../_osmFetch":17}],25:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(p,g,_,x){x===void 0&&(x=_);var b=Object.getOwnPropertyDescriptor(g,_);(!b||("get"in b?!g.__esModule:b.writable||b.configurable))&&(b={enumerable:!0,get:function(){return g[_]}}),Object.defineProperty(p,x,b)}):(function(p,g,_,x){x===void 0&&(x=_),p[x]=g[_]})),c=this&&this.__exportStar||function(p,g){for(var _ in p)_!=="default"&&!Object.prototype.hasOwnProperty.call(g,_)&&o(g,p,_)};Object.defineProperty(r,"__esModule",{value:!0}),r.createOsmChangeXml=r.parseOsmChangeXml=void 0,c(t("./chunkOsmChange"),r),c(t("./createChangesetComment"),r),c(t("./getChangesetDiff"),r),c(t("./getChangesets"),r),c(t("./subscription"),r),c(t("./uploadChangeset"),r);var s=t("./_parseOsmChangeXml");Object.defineProperty(r,"parseOsmChangeXml",{enumerable:!0,get:function(){return s.parseOsmChangeXml}});var d=t("./_createOsmChangeXml");Object.defineProperty(r,"createOsmChangeXml",{enumerable:!0,get:function(){return d.createOsmChangeXml}})},{"./_createOsmChangeXml":19,"./_parseOsmChangeXml":20,"./chunkOsmChange":21,"./createChangesetComment":22,"./getChangesetDiff":23,"./getChangesets":24,"./subscription":26,"./uploadChangeset":27}],26:[function(t,i,r){var o=this&&this.__awaiter||function(p,g,_,x){function b(S){return S instanceof _?S:new _(function(P){P(S)})}return new(_||(_=Promise))(function(S,P){function L(D){try{C(x.next(D))}catch(O){P(O)}}function E(D){try{C(x.throw(D))}catch(O){P(O)}}function C(D){D.done?S(D.value):b(D.value).then(L,E)}C((x=x.apply(p,g||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.subscribeToChangeset=s,r.unsubscribeFromChangeset=d;const c=t("../_osmFetch");function s(p,g){return o(this,void 0,void 0,function*(){yield(0,c.osmFetch)(`/0.6/changeset/${p}/subscribe`,{},Object.assign(Object.assign({},g),{method:"POST"}))})}function d(p,g){return o(this,void 0,void 0,function*(){yield(0,c.osmFetch)(`/0.6/changeset/${p}/unsubscribe`,{},Object.assign(Object.assign({},g),{method:"POST"}))})}},{"../_osmFetch":17}],27:[function(t,i,r){var o=this&&this.__awaiter||function(b,S,P,L){function E(C){return C instanceof P?C:new P(function(D){D(C)})}return new(P||(P=Promise))(function(C,D){function O(G){try{j(L.next(G))}catch(N){D(N)}}function U(G){try{j(L.throw(G))}catch(N){D(N)}}function j(G){G.done?C(G.value):E(G.value).then(O,U)}j((L=L.apply(b,S||[])).next())})},c=this&&this.__rest||function(b,S){var P={};for(var L in b)Object.prototype.hasOwnProperty.call(b,L)&&S.indexOf(L)<0&&(P[L]=b[L]);if(b!=null&&typeof Object.getOwnPropertySymbols=="function")for(var E=0,L=Object.getOwnPropertySymbols(b);E<L.length;E++)S.indexOf(L[E])<0&&Object.prototype.propertyIsEnumerable.call(b,L[E])&&(P[L[E]]=b[L[E]]);return P};Object.defineProperty(r,"__esModule",{value:!0}),r.compress=_,r.uploadChangeset=x;const s=t("../_osmFetch"),d=t("../../../package.json"),p=t("./_createOsmChangeXml"),g=t("./chunkOsmChange");function _(b){if(!globalThis.CompressionStream)return;const S=new Response(b).body.pipeThrough(new CompressionStream("gzip"));return new Response(S).blob()}function x(b,S,P){return o(this,void 0,void 0,function*(){const L=P||{},{onChunk:E,onProgress:C,disableCompression:D}=L,O=c(L,["onChunk","onProgress","disableCompression"]),U=(0,g.chunkOsmChange)(S),j=[],G=(0,g.getOsmChangeSize)(S);for(const[N,V]of U.entries()){let q=b;U.length>1&&(E?q=E({featureCount:G,changesetIndex:N,changesetTotal:U.length}):q.chunk=`${N+1}/${U.length}`),q.created_by||(q.created_by=`osm-api-js ${d.version}`),C?.({phase:"upload",step:N+1,total:U.length});const z=+(yield(0,s.osmFetch)("/0.6/changeset/create",void 0,Object.assign(Object.assign({},O),{method:"PUT",body:(0,p.createChangesetMetaXml)(q),headers:Object.assign(Object.assign({},O.headers),{"content-type":"application/xml; charset=utf-8"})}))),Q=(0,p.createOsmChangeXml)(z,V),X=!D&&(yield _(Q));yield(0,s.osmFetch)(`/0.6/changeset/${z}/upload`,void 0,Object.assign(Object.assign({},O),{method:"POST",body:X||Q,headers:Object.assign(Object.assign(Object.assign({},O.headers),X&&{"Content-Encoding":"gzip"}),{"content-type":"application/xml; charset=utf-8"})})),yield(0,s.osmFetch)(`/0.6/changeset/${z}/close`,void 0,Object.assign(Object.assign({},O),{method:"PUT"})),j.push(z)}return j[0]})}},{"../../../package.json":16,"../_osmFetch":17,"./_createOsmChangeXml":19,"./chunkOsmChange":21}],28:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.createUserBlock=s;const c=t("../_osmFetch");function s(d,p){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)("/0.6/user_blocks.json",d,Object.assign(Object.assign({},p),{method:"POST"}))).user_block})}},{"../_osmFetch":17}],29:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getUserBlock=s;const c=t("../_osmFetch");function s(d,p){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/user_blocks/${d}.json`,{},p)).user_block})}},{"../_osmFetch":17}],30:[function(t,i,r){var o=this&&this.__awaiter||function(p,g,_,x){function b(S){return S instanceof _?S:new _(function(P){P(S)})}return new(_||(_=Promise))(function(S,P){function L(D){try{C(x.next(D))}catch(O){P(O)}}function E(D){try{C(x.throw(D))}catch(O){P(O)}}function C(D){D.done?S(D.value):b(D.value).then(L,E)}C((x=x.apply(p,g||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.hideChangesetComment=d;const c=t("../_osmFetch"),s=t("../changesets");function d(p,g,_){return o(this,void 0,void 0,function*(){const x=yield(0,c.osmFetch)(`/0.6/changeset_comments/${p}/visibility.json`,{},Object.assign(Object.assign({},_),{method:g==="unhide"?"POST":"DELETE"}));return(0,s.mapRawChangeset)(x.changeset)})}},{"../_osmFetch":17,"../changesets":25}],31:[function(t,i,r){var o=this&&this.__awaiter||function(p,g,_,x){function b(S){return S instanceof _?S:new _(function(P){P(S)})}return new(_||(_=Promise))(function(S,P){function L(D){try{C(x.next(D))}catch(O){P(O)}}function E(D){try{C(x.throw(D))}catch(O){P(O)}}function C(D){D.done?S(D.value):b(D.value).then(L,E)}C((x=x.apply(p,g||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.hideNote=d;const c=t("../_osmFetch"),s=t("../notes");function d(p,g,_){return o(this,void 0,void 0,function*(){const x=yield(0,c.osmFetch)(`/0.6/notes/${p}.json`,g?{text:g}:{},Object.assign(Object.assign({},_),{method:"DELETE"}));return(0,s.featureToNote)(x)})}},{"../_osmFetch":17,"../notes":48}],32:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(s,d,p,g){g===void 0&&(g=p);var _=Object.getOwnPropertyDescriptor(d,p);(!_||("get"in _?!d.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return d[p]}}),Object.defineProperty(s,g,_)}):(function(s,d,p,g){g===void 0&&(g=p),s[g]=d[p]})),c=this&&this.__exportStar||function(s,d){for(var p in s)p!=="default"&&!Object.prototype.hasOwnProperty.call(d,p)&&o(d,s,p)};Object.defineProperty(r,"__esModule",{value:!0}),c(t("./createUserBlock"),r),c(t("./getUserBlock"),r),c(t("./hideChangesetComment"),r),c(t("./hideNote"),r),c(t("./redactFeature"),r)},{"./createUserBlock":28,"./getUserBlock":29,"./hideChangesetComment":30,"./hideNote":31,"./redactFeature":33}],33:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.redactFeature=s;const c=t("../_osmFetch");function s(d,p){return o(this,arguments,void 0,function*({featureType:g,featureId:_,featureVersion:x,redactionId:b},S){yield(0,c.osmFetch)(`/0.6/${g}/${_}/${x}/redact`,b?{redaction:b}:{},Object.assign(Object.assign({},S),{method:"POST"}))})}},{"../_osmFetch":17}],34:[function(t,i,r){var o=this&&this.__awaiter||function(p,g,_,x){function b(S){return S instanceof _?S:new _(function(P){P(S)})}return new(_||(_=Promise))(function(S,P){function L(D){try{C(x.next(D))}catch(O){P(O)}}function E(D){try{C(x.throw(D))}catch(O){P(O)}}function C(D){D.done?S(D.value):b(D.value).then(L,E)}C((x=x.apply(p,g||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getApiCapabilities=s,r.getCapabilities=d;const c=t("./_osmFetch");function s(p){return o(this,void 0,void 0,function*(){return(0,c.osmFetch)("/capabilities.json",void 0,p)})}function d(){return o(this,void 0,void 0,function*(){const p=yield s();return{limits:{maxArea:p.api.area.maximum,maxNoteArea:p.api.note_area.maximum,maxTracepointPerPage:p.api.tracepoints.per_page,maxWayNodes:p.api.waynodes.maximum,maxChangesetElements:p.api.changesets.maximum_elements,maxTimeout:p.api.timeout.seconds},policy:{imageryBlacklist:p.policy.imagery.blacklist.map(_=>_.regex)}}})}},{"./_osmFetch":17}],35:[function(t,i,r){var o=this&&this.__awaiter||function(b,S,P,L){function E(C){return C instanceof P?C:new P(function(D){D(C)})}return new(P||(P=Promise))(function(C,D){function O(G){try{j(L.next(G))}catch(N){D(N)}}function U(G){try{j(L.throw(G))}catch(N){D(N)}}function j(G){G.done?C(G.value):E(G.value).then(O,U)}j((L=L.apply(b,S||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getFeature=s,r.getFeatures=d,r.getFeatureAtVersion=p,r.getFeatureHistory=g,r.getWaysForNode=_,r.getRelationsForElement=x;const c=t("./_osmFetch");function s(b,S,P,L){return o(this,void 0,void 0,function*(){const E=P&&b!=="node"?"/full":"";return(yield(0,c.osmFetch)(`/0.6/${b}/${S}${E}.json`,void 0,L)).elements})}function d(b,S,P){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/${b}s.json?${b}s=${S.join(",")}`,void 0,P)).elements})}function p(b,S,P,L){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/${b}/${S}/${P}.json`,void 0,L)).elements[0]})}function g(b,S,P){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/${b}/${S}/history.json`,void 0,P)).elements})}function _(b,S){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/node/${b}/ways.json`,void 0,S)).elements})}function x(b,S,P){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/${b}/${S}/relations.json`,void 0,P)).elements})}},{"./_osmFetch":17}],36:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getMapData=s;const c=t("./_osmFetch");function s(d,p){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)("/0.6/map.json",{bbox:d},p)).elements})}},{"./_osmFetch":17}],37:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getPermissions=s;const c=t("./_osmFetch");function s(d){return o(this,void 0,void 0,function*(){return(0,c.osmFetch)("/0.6/permissions.json",void 0,d)})}},{"./_osmFetch":17}],38:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getUIdFromDisplayName=s;const c=t("./changesets");function s(d){return o(this,void 0,void 0,function*(){const p=yield(0,c.listChangesets)({display_name:d});if(!p.length)throw new Error("Could not get uid because the user has never edited the map");return p[0].uid})}},{"./changesets":25}],39:[function(t,i,r){var o=this&&this.__awaiter||function(_,x,b,S){function P(L){return L instanceof b?L:new b(function(E){E(L)})}return new(b||(b=Promise))(function(L,E){function C(U){try{O(S.next(U))}catch(j){E(j)}}function D(U){try{O(S.throw(U))}catch(j){E(j)}}function O(U){U.done?L(U.value):P(U.value).then(C,D)}O((S=S.apply(_,x||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getUser=s,r.getUsers=d,r.getUserBlockById=p,r.getOwnUserBlocks=g;const c=t("./_osmFetch");function s(_,x){return o(this,void 0,void 0,function*(){const b=yield(0,c.osmFetch)(`/0.6/user/${_==="me"?"details":_}.json`,void 0,x);return Object.assign(Object.assign({},b.user),{account_created:new Date(b.user.account_created)})})}function d(_,x){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)("/0.6/users",{users:_},x)).users.map(S=>Object.assign(Object.assign({},S),{account_created:new Date(S.account_created)}))})}function p(_,x){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/user_blocks/${_}.json`,void 0,x)).user_block})}function g(_){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)("/0.6/user/blocks/active",void 0,_)).user_blocks})}},{"./_osmFetch":17}],40:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(s,d,p,g){g===void 0&&(g=p);var _=Object.getOwnPropertyDescriptor(d,p);(!_||("get"in _?!d.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return d[p]}}),Object.defineProperty(s,g,_)}):(function(s,d,p,g){g===void 0&&(g=p),s[g]=d[p]})),c=this&&this.__exportStar||function(s,d){for(var p in s)p!=="default"&&!Object.prototype.hasOwnProperty.call(d,p)&&o(d,s,p)};Object.defineProperty(r,"__esModule",{value:!0}),c(t("./changesets"),r),c(t("./dwg"),r),c(t("./messages"),r),c(t("./notes"),r),c(t("./preferences"),r),c(t("./getCapabilities"),r),c(t("./getFeature"),r),c(t("./getMapData"),r),c(t("./getPermissions"),r),c(t("./getUIdFromDisplayName"),r),c(t("./getUser"),r)},{"./changesets":25,"./dwg":32,"./getCapabilities":34,"./getFeature":35,"./getMapData":36,"./getPermissions":37,"./getUIdFromDisplayName":38,"./getUser":39,"./messages":43,"./notes":48,"./preferences":53}],41:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.deleteMessage=s;const c=t("../_osmFetch");function s(d,p){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/user/messages/${d}.json`,{},Object.assign(Object.assign({},p),{method:"DELETE"}))).message})}},{"../_osmFetch":17}],42:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getMessage=s;const c=t("../_osmFetch");function s(d,p){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/user/messages/${d}.json`,void 0,p)).message})}},{"../_osmFetch":17}],43:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(s,d,p,g){g===void 0&&(g=p);var _=Object.getOwnPropertyDescriptor(d,p);(!_||("get"in _?!d.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return d[p]}}),Object.defineProperty(s,g,_)}):(function(s,d,p,g){g===void 0&&(g=p),s[g]=d[p]})),c=this&&this.__exportStar||function(s,d){for(var p in s)p!=="default"&&!Object.prototype.hasOwnProperty.call(d,p)&&o(d,s,p)};Object.defineProperty(r,"__esModule",{value:!0}),c(t("./deleteMessage"),r),c(t("./getMessage"),r),c(t("./listMessages"),r),c(t("./sendMessage"),r),c(t("./updateMessageReadStatus"),r)},{"./deleteMessage":41,"./getMessage":42,"./listMessages":44,"./sendMessage":45,"./updateMessageReadStatus":46}],44:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.listMessages=s;const c=t("../_osmFetch");function s(d,p){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/user/messages/${d}.json`,void 0,p)).messages})}},{"../_osmFetch":17}],45:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.sendMessage=s;const c=t("../_osmFetch");function s(d,p){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)("/0.6/user/messages.json",d,Object.assign(Object.assign({},p),{method:"POST"}))).message})}},{"../_osmFetch":17}],46:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.updateMessageReadStatus=s;const c=t("../_osmFetch");function s(d,p,g){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/user/messages/${d}.json`,{read_status:p},Object.assign(Object.assign({},g),{method:"POST"}))).message})}},{"../_osmFetch":17}],47:[function(t,i,r){var o=this&&this.__awaiter||function(x,b,S,P){function L(E){return E instanceof S?E:new S(function(C){C(E)})}return new(S||(S=Promise))(function(E,C){function D(j){try{U(P.next(j))}catch(G){C(G)}}function O(j){try{U(P.throw(j))}catch(G){C(G)}}function U(j){j.done?E(j.value):L(j.value).then(D,O)}U((P=P.apply(x,b||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.featureToNote=void 0,r.getNotesForQuery=p,r.getNotesForArea=g,r.getNote=_;const c=t("../_osmFetch"),s=x=>{const[b,S]=x.geometry.coordinates;return Object.assign(Object.assign({},x.properties),{location:{lat:S,lng:b}})};r.featureToNote=s;function d(x,b,S){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)(`/0.6/notes${b?"/search":""}.json`,x,S)).features.map(r.featureToNote)})}function p(x,b){return d(x,!0,b)}function g(x,b){return d({bbox:x},!1,b)}function _(x,b){return o(this,void 0,void 0,function*(){const S=yield(0,c.osmFetch)(`/0.6/notes/${x}.json`,void 0,b);return(0,r.featureToNote)(S)})}},{"../_osmFetch":17}],48:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(s,d,p,g){g===void 0&&(g=p);var _=Object.getOwnPropertyDescriptor(d,p);(!_||("get"in _?!d.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return d[p]}}),Object.defineProperty(s,g,_)}):(function(s,d,p,g){g===void 0&&(g=p),s[g]=d[p]})),c=this&&this.__exportStar||function(s,d){for(var p in s)p!=="default"&&!Object.prototype.hasOwnProperty.call(d,p)&&o(d,s,p)};Object.defineProperty(r,"__esModule",{value:!0}),c(t("./getNotes"),r),c(t("./noteActions"),r),c(t("./subscription"),r)},{"./getNotes":47,"./noteActions":49,"./subscription":50}],49:[function(t,i,r){var o=this&&this.__awaiter||function(x,b,S,P){function L(E){return E instanceof S?E:new S(function(C){C(E)})}return new(S||(S=Promise))(function(E,C){function D(j){try{U(P.next(j))}catch(G){C(G)}}function O(j){try{U(P.throw(j))}catch(G){C(G)}}function U(j){j.done?E(j.value):L(j.value).then(D,O)}U((P=P.apply(x,b||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.createNote=d,r.commentOnNote=p,r.closeNote=g,r.reopenNote=_;const c=t("../_osmFetch"),s=t("./getNotes");function d(x,b,S,P){return o(this,void 0,void 0,function*(){const L=yield(0,c.osmFetch)("/0.6/notes.json",{lat:x,lon:b,text:S},Object.assign(Object.assign({},P),{method:"POST"}));return(0,s.featureToNote)(L)})}function p(x,b,S){return o(this,void 0,void 0,function*(){const P=yield(0,c.osmFetch)(`/0.6/notes/${x}/comment.json`,b?{text:b}:{},Object.assign(Object.assign({},S),{method:"POST"}));return(0,s.featureToNote)(P)})}function g(x,b,S){return o(this,void 0,void 0,function*(){const P=yield(0,c.osmFetch)(`/0.6/notes/${x}/close.json`,b?{text:b}:{},Object.assign(Object.assign({},S),{method:"POST"}));return(0,s.featureToNote)(P)})}function _(x,b,S){return o(this,void 0,void 0,function*(){const P=yield(0,c.osmFetch)(`/0.6/notes/${x}/reopen.json`,b?{text:b}:{},Object.assign(Object.assign({},S),{method:"POST"}));return(0,s.featureToNote)(P)})}},{"../_osmFetch":17,"./getNotes":47}],50:[function(t,i,r){var o=this&&this.__awaiter||function(p,g,_,x){function b(S){return S instanceof _?S:new _(function(P){P(S)})}return new(_||(_=Promise))(function(S,P){function L(D){try{C(x.next(D))}catch(O){P(O)}}function E(D){try{C(x.throw(D))}catch(O){P(O)}}function C(D){D.done?S(D.value):b(D.value).then(L,E)}C((x=x.apply(p,g||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.subscribeToNote=s,r.unsubscribeFromNote=d;const c=t("../_osmFetch");function s(p,g){return o(this,void 0,void 0,function*(){yield(0,c.osmFetch)(`/0.6/notes/${p}/subscription`,{},Object.assign(Object.assign({},g),{method:"POST"}))})}function d(p,g){return o(this,void 0,void 0,function*(){yield(0,c.osmFetch)(`/0.6/notes/${p}/subscription`,{},Object.assign(Object.assign({},g),{method:"DELETE"}))})}},{"../_osmFetch":17}],51:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.deletePreferences=s;const c=t("../_osmFetch");function s(d,p){return o(this,void 0,void 0,function*(){yield(0,c.osmFetch)(`/0.6/user/preferences/${d}.json`,{},Object.assign(Object.assign({},p),{method:"DELETE"}))})}},{"../_osmFetch":17}],52:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.getPreferences=s;const c=t("../_osmFetch");function s(d){return o(this,void 0,void 0,function*(){return(yield(0,c.osmFetch)("/0.6/user/preferences.json",void 0,d)).preferences})}},{"../_osmFetch":17}],53:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(s,d,p,g){g===void 0&&(g=p);var _=Object.getOwnPropertyDescriptor(d,p);(!_||("get"in _?!d.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return d[p]}}),Object.defineProperty(s,g,_)}):(function(s,d,p,g){g===void 0&&(g=p),s[g]=d[p]})),c=this&&this.__exportStar||function(s,d){for(var p in s)p!=="default"&&!Object.prototype.hasOwnProperty.call(d,p)&&o(d,s,p)};Object.defineProperty(r,"__esModule",{value:!0}),c(t("./deletePreferences"),r),c(t("./getPreferences"),r),c(t("./updatePreferences"),r)},{"./deletePreferences":51,"./getPreferences":52,"./updatePreferences":54}],54:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.updatePreferences=s;const c=t("../_osmFetch");function s(d,p,g){return o(this,void 0,void 0,function*(){yield(0,c.osmFetch)(`/0.6/user/preferences/${d}.json`,{},Object.assign(Object.assign({},g),{method:"PUT",body:p}))})}},{"../_osmFetch":17}],55:[function(t,i,r){Object.defineProperty(r,"__esModule",{value:!0}),r.createPopup=c;const o="osm-api-auth-complete";function c(s){let d=!1;return new Promise(p=>{const[g,_]=[600,550],x=Object.entries({width:g,height:_,left:window.screen.width/2-g/2,top:window.screen.height/2-_/2}).map(([L,E])=>`${L}=${E}`).join(","),b=window.open("about:blank","oauth_window",x);if(!b)throw new Error("Popup was blocked");b.location=s;const S=new BroadcastChannel(o),P=L=>{d||(p(L.data),d=!0,S.removeEventListener("message",P),S.close())};S.addEventListener("message",P)})}},{}],56:[function(t,i,r){var o=this&&this.__awaiter||function(d,p,g,_){function x(b){return b instanceof g?b:new g(function(S){S(b)})}return new(g||(g=Promise))(function(b,S){function P(C){try{E(_.next(C))}catch(D){S(D)}}function L(C){try{E(_.throw(C))}catch(D){S(D)}}function E(C){C.done?b(C.value):x(C.value).then(P,L)}E((_=_.apply(d,p||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.exchangeCode=s;const c=t("./helpers");function s(d,p){return o(this,arguments,void 0,function*(g,{options:_,pkceVerifier:x,state:b}){const S=new URL(g).searchParams,P=S.get("error_description"),L=S.get("code"),E=S.get("state");if(P)throw new Error(P);if(!L)throw new Error("No code in OAuth response");if(!x||!b)throw new Error("No login in progress");if(b!==E)throw new Error("State Mismatch");const C={grant_type:"authorization_code",code:L,redirect_uri:_.redirectUrl,client_id:_.clientId,code_verifier:x},D=`${(0,c.getOAuthBaseUrl)()}/oauth2/token?${new URLSearchParams(C).toString()}`,U=yield(yield fetch(D,{method:"POST",body:"",headers:{"Content-Type":"application/x-www-form-urlencoded"}})).json();if("error_description"in U)throw new Error(U.error_description);const j={issuedAt:new Date(U.created_at*1e3).toISOString(),accessToken:U.access_token,scopes:U.scope.split(" ")};return localStorage.setItem("__osmAuth",JSON.stringify(j)),j})}},{"./helpers":57}],57:[function(t,i,r){var o=this&&this.__awaiter||function(g,_,x,b){function S(P){return P instanceof x?P:new x(function(L){L(P)})}return new(x||(x=Promise))(function(P,L){function E(O){try{D(b.next(O))}catch(U){L(U)}}function C(O){try{D(b.throw(O))}catch(U){L(U)}}function D(O){O.done?P(O.value):S(O.value).then(E,C)}D((b=b.apply(g,_||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.sha256=s,r.getRandomString=d,r.getOAuthBaseUrl=p;const c=t("../config");function s(g){return o(this,void 0,void 0,function*(){const _=new TextEncoder().encode(g),x=yield window.crypto.subtle.digest("SHA-256",_);return btoa(String.fromCharCode(...new Uint8Array(x))).replaceAll("+","-").replaceAll("/","_").replaceAll("=","")})}function d(){return[...window.crypto.getRandomValues(new Uint32Array(32))].map(g=>`0${g.toString(16)}`.slice(-2)).join("")}function p(){let g=(0,c.getConfig)().apiUrl;return g==="https://api.openstreetmap.org"&&(g="https://www.openstreetmap.org"),g}},{"../config":60}],58:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(s,d,p,g){g===void 0&&(g=p);var _=Object.getOwnPropertyDescriptor(d,p);(!_||("get"in _?!d.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return d[p]}}),Object.defineProperty(s,g,_)}):(function(s,d,p,g){g===void 0&&(g=p),s[g]=d[p]})),c=this&&this.__exportStar||function(s,d){for(var p in s)p!=="default"&&!Object.prototype.hasOwnProperty.call(d,p)&&o(d,s,p)};Object.defineProperty(r,"__esModule",{value:!0}),c(t("./oauth2"),r)},{"./oauth2":59}],59:[function(t,i,r){var o=this&&this.__awaiter||function(b,S,P,L){function E(C){return C instanceof P?C:new P(function(D){D(C)})}return new(P||(P=Promise))(function(C,D){function O(G){try{j(L.next(G))}catch(N){D(N)}}function U(G){try{j(L.throw(G))}catch(N){D(N)}}function j(G){G.done?C(G.value):E(G.value).then(O,U)}j((L=L.apply(b,S||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0}),r.isLoggedIn=r.getAuthToken=r.authReady=void 0,r.login=p,r.logout=x;const c=t("./createPopup"),s=t("./exchangeCode"),d=t("./helpers");function p(b){return o(this,void 0,void 0,function*(){if(!b.redirectUrl)throw new Error("You must include the 'redirectUrl' option");if(!b.clientId)throw new Error("You must include the 'clientId' option");if(!b.scopes)throw new Error("You must include the 'scopes' option");const S=(0,d.getRandomString)(),P=(0,d.getRandomString)(),L=yield(0,d.sha256)(P),E={scope:b.scopes.join(" "),include_granted_scopes:"true",response_type:"code",state:S,redirect_uri:b.redirectUrl,client_id:b.clientId,code_challenge_method:"S256",code_challenge:L},C=`/oauth2/authorize?${new URLSearchParams(E).toString()}`,D=b.switchUser?`/logout?referer=${encodeURIComponent(`/login?referer=${encodeURIComponent(C)}`)}`:C,O=(0,d.getOAuthBaseUrl)()+D,U={state:S,pkceVerifier:P,options:b};if(b.mode==="popup"){const j=yield(0,c.createPopup)(O);return(0,s.exchangeCode)(j,U)}if(b.mode==="redirect"){localStorage.setItem("__osmAuthTemp",JSON.stringify(U)),window.location.replace(O);return}throw new Error("options.mode must be 'popup' or 'redirect'")})}r.authReady=o(void 0,void 0,void 0,function*(){if(typeof window>"u")return;const b=window.location.href,S=localStorage.getItem("__osmAuthTemp");if(new URL(b).searchParams.get("code")&&S)try{const P=JSON.parse(S);yield(0,s.exchangeCode)(b,P),localStorage.removeItem("__osmAuthTemp")}catch(P){console.error("OSM Auth Error",P)}});const g=()=>{try{const b=localStorage.getItem("__osmAuth");return b?JSON.parse(b).accessToken:void 0}catch{return}};r.getAuthToken=g;const _=()=>!!(0,r.getAuthToken)();r.isLoggedIn=_;function x(){localStorage.removeItem("__osmAuth")}},{"./createPopup":55,"./exchangeCode":56,"./helpers":57}],60:[function(t,i,r){Object.defineProperty(r,"__esModule",{value:!0}),r.getConfig=void 0,r.configure=s;const o={apiUrl:"https://api.openstreetmap.org",userAgent:"https://github.com/osmlab/osm-api-js"},c=()=>o;r.getConfig=c;function s(d){Object.assign(o,d)}},{}],61:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(s,d,p,g){g===void 0&&(g=p);var _=Object.getOwnPropertyDescriptor(d,p);(!_||("get"in _?!d.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return d[p]}}),Object.defineProperty(s,g,_)}):(function(s,d,p,g){g===void 0&&(g=p),s[g]=d[p]})),c=this&&this.__exportStar||function(s,d){for(var p in s)p!=="default"&&!Object.prototype.hasOwnProperty.call(d,p)&&o(d,s,p)};Object.defineProperty(r,"__esModule",{value:!0}),c(t("./api"),r),c(t("./auth"),r),c(t("./config"),r),c(t("./types"),r)},{"./api":40,"./auth":58,"./config":60,"./types":65}],62:[function(t,i,r){Object.defineProperty(r,"__esModule",{value:!0})},{}],63:[function(t,i,r){arguments[4][62][0].apply(r,arguments)},{dup:62}],64:[function(t,i,r){arguments[4][62][0].apply(r,arguments)},{dup:62}],65:[function(t,i,r){var o=this&&this.__createBinding||(Object.create?(function(s,d,p,g){g===void 0&&(g=p);var _=Object.getOwnPropertyDescriptor(d,p);(!_||("get"in _?!d.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return d[p]}}),Object.defineProperty(s,g,_)}):(function(s,d,p,g){g===void 0&&(g=p),s[g]=d[p]})),c=this&&this.__exportStar||function(s,d){for(var p in s)p!=="default"&&!Object.prototype.hasOwnProperty.call(d,p)&&o(d,s,p)};Object.defineProperty(r,"__esModule",{value:!0}),c(t("./changesets"),r),c(t("./features"),r),c(t("./general"),r),c(t("./messages"),r),c(t("./notes"),r),c(t("./osmPatch"),r),c(t("./user"),r)},{"./changesets":62,"./features":63,"./general":64,"./messages":66,"./notes":67,"./osmPatch":68,"./user":69}],66:[function(t,i,r){arguments[4][62][0].apply(r,arguments)},{dup:62}],67:[function(t,i,r){arguments[4][62][0].apply(r,arguments)},{dup:62}],68:[function(t,i,r){arguments[4][62][0].apply(r,arguments)},{dup:62}],69:[function(t,i,r){arguments[4][62][0].apply(r,arguments)},{dup:62}]},{},[61])(61)})})(EM)),EM.exports}var iy=ple(),mle=Wt('<div class="mb-1"><button class="btn btn-danger">Clear edits</button> <button class="btn btn-danger"> </button></div> <div class="mb-1"><button class="btn btn-secondary">Download .osc</button> <button class="btn btn-secondary">Upload changeset</button></div>',1),gle=Wt("<!> <!>",1);function _le(n,e){en(e,!0);const t=()=>Qi(sa,"$mutationCounter",o),i=()=>Qi(zs,"$backend",o),r=()=>Qi(fy,"$loggedInUser",o),[o,c]=qr();let s=ii(xs([])),d=ii("");cn(()=>{t(),bs(()=>{Et(s,i()?JSON.parse(i().getEdits()):[],!0),Do(yw,ee(s).length>0)})});async function p(){if(window.confirm("Do you really want to clear your edits?")){Et(d,"Clearing edits"),await al();try{i().editClear(),rp(sa,t())}finally{Et(d,"")}}}async function g(){Et(d,"Undoing last edit"),await al();try{i().editUndo(),rp(sa,t())}finally{Et(d,"")}}function _(){h0("changes.osc",i().toOsc())}async function x(){if(!r()){window.alert("You have to log in first");return}if(ee(s).some(C=>!("SetTags"in C))){window.alert("You've done a bulk operation. You should NOT upload this to OSM -- it's only for testing or usage in you own tool that consumes OSM data.");return}if(!window.confirm("Do you really know what you're doing and want to upload this?"))return;let E=window.prompt("Please describe this changeset");if(E)try{let C=await iy.uploadChangeset({created_by:"Speedwalk",comment:E},JSON.parse(i().toOsmChangeJson()));window.open(`https://www.openstreetmap.org/changeset/${C}`,"_blank"),Do(zs,null),Do(yw,!1)}catch(C){window.alert(`Upload failed: ${C}`)}}async function b(E){E.key=="z"&&E.ctrlKey&&ee(s).length>0&&await g()}var S=gle();Kw("keydown",wy,b);var P=ci(S);Jd(P,{get loading(){return ee(d)}});var L=gt(P,2);Hd(L,{header:D=>{var O=Vn();Zi(()=>ln(O,`${ee(s).length??""}
    ${ee(s).length==1?"edit":"edits"}`)),xt(D,O)},body:D=>{var O=ir(),U=ci(O);{var j=G=>{var N=mle(),V=ci(N),q=Ft(V);q.__click=p;var z=gt(q,2);z.__click=g;var Q=Ft(z),X=gt(V,2),re=Ft(X);re.__click=_;var oe=gt(re,2);oe.__click=x,Zi(()=>{z.disabled=ee(s).length==0,ln(Q,`Undo (${ee(s).length??""})`)}),xt(G,N)};Ki(U,G=>{ee(s).length>0&&G(j)})}xt(D,O)},$$slots:{header:!0,body:!0}}),xt(n,S),tn(),c()}ds(["click"]);var vle=Wt('<div class="card mb-3"><div class="card-header">Assume old-style tags on one-ways</div> <div class="card-body"><!> <button class="btn btn-secondary">Autoset tags on one-ways</button></div></div> <div class="card mb-3"><div class="card-header">Make all sidewalks</div> <div class="card-body"><!> <button class="btn btn-secondary">Make sidewalks</button></div></div> <div class="card"><div class="card-header">Connect all crossing nodes</div> <div class="card-body"><!> <button class="btn btn-secondary">Create a way for every crossing node</button></div></div>',1),yle=Wt('<button class="btn btn-secondary">Bulk operations</button>'),ble=Wt("<h2>Bulk operations</h2>"),xle=Wt(`<!> <p>Speedwalk has some experimental features that can automatically generate
    separate sidewalks on roads tagged with <i>sidewalk = left,right,both</i> . This is intended for use in routers and other tools that require separate sidewalks.
    This generation is very error-prone and not meant to ever replace mapping sidewalks
    properly, just as a stop-gap for areas with low coverage. Feel free to test it
    out, but do not ever upload the results to OSM.</p> <button class="btn btn-primary">I understand</button> <button class="btn btn-secondary">Cancel</button>`,1),wle=Wt("<!> <!> <!>",1);function Sle(n,e){en(e,!0);const t=()=>Qi(bw,"$enabledBulkOps",o),i=()=>Qi(zs,"$backend",o),r=()=>Qi(sa,"$mutationCounter",o),[o,c]=qr();let s=ii(!1);function d(){Do(bw,!0),Et(s,!1)}let p=ii(""),g=ii(!0),_=ii(!0),x=ii(!1);async function b(){Et(p,"Generating sidewalks"),await al();try{i().editMakeAllSidewalks(ee(_)),rp(sa,r())}catch(j){window.alert(`Error: ${j}`)}finally{Et(p,"")}}async function S(){Et(p,"Connecting crossings"),await al();try{i().editConnectAllCrossings(ee(x)),rp(sa,r())}catch(j){window.alert(`Error: ${j}`)}finally{Et(p,"")}}async function P(){Et(p,"Inferring sidewalks around one-ways"),await al();try{i().editAssumeTags(ee(g)),rp(sa,r())}catch(j){window.alert(`Error: ${j}`)}finally{Et(p,"")}}var L=wle(),E=ci(L);Jd(E,{get loading(){return ee(p)}});var C=gt(E,2);{var D=j=>{Hd(j,{header:V=>{var q=Vn("Bulk operations");xt(V,q)},body:V=>{var q=vle(),z=ci(q),Q=gt(Ft(z),2),X=Ft(Q);ls(X,{get checked(){return ee(g)},set checked(Ue){Et(g,Ue,!0)},children:(Ue,ke)=>{var et=Vn("Drive on the left");xt(Ue,et)},$$slots:{default:!0}});var re=gt(X,2);re.__click=P;var oe=gt(z,2),de=gt(Ft(oe),2),ce=Ft(de);ls(ce,{get checked(){return ee(_)},set checked(Ue){Et(_,Ue,!0)},children:(Ue,ke)=>{var et=Vn("Only for major roads");xt(Ue,et)},$$slots:{default:!0}});var Se=gt(ce,2);Se.__click=b;var Pe=gt(oe,2),je=gt(Ft(Pe),2),Fe=Ft(je);ls(Fe,{get checked(){return ee(x)},set checked(Ue){Et(x,Ue,!0)},children:(Ue,ke)=>{var et=Vn("Include crossing=no");xt(Ue,et)},$$slots:{default:!0}});var qe=gt(Fe,2);qe.__click=S,xt(V,q)},$$slots:{header:!0,body:!0}})},O=j=>{var G=yle();G.__click=()=>Et(s,!0),xt(j,G)};Ki(C,j=>{t()?j(D):j(O,!1)})}var U=gt(C,2);_p(U,{get show(){return ee(s)},set show(j){Et(s,j,!0)},children:(j,G)=>{var N=xle(),V=ci(N);n1(V,{children:(Q,X)=>{var re=ble();xt(Q,re)}});var q=gt(V,4);q.__click=d;var z=gt(q,2);z.__click=()=>Et(s,!1),xt(j,N)},$$slots:{default:!0}}),xt(n,L),tn(),c()}ds(["click"]);var Tle=Wt('<span class="svelte-1jjc18c"></span>'),Mle=Wt('<span class="color-swatch svelte-1jjc18c"></span> ',1),Cle=Wt('<div style="display: flex; align-items: center; gap: 6px;"><!></div>'),Ele=Wt('<span class="color-swatch svelte-1jjc18c"></span> ',1),Ale=Wt('<div style="display: flex; align-items: center; gap: 6px;"><!></div>'),Ple=Wt('<div class="card mb-3"><div class="card-header">Roads</div> <div class="card-body"><div class="row mb-1 svelte-1jjc18c"></div> <!> <div class="mb-3"></div> <!></div></div> <!>',1);function Ile(n,e){en(e,!0);const t=()=>Qi(sa,"$mutationCounter",r),i=()=>Qi(zs,"$backend",r),[r,o]=qr();let c=ft(e,"showKinds",15),s=[["RoadWithSeparate","With separate sidewalks"],["RoadWithTags","With tagged sidewalks"],["RoadWithoutSidewalksExplicit","Tagged as no sidewalks"],["RoadWithoutSidewalksImplicit","Assumed as no sidewalks"],["RoadUnknown","Totally unknown"]],d=[["Sidewalk","Sidewalks"],["Crossing","Crossings"],["Other","Other"]],p=Kt(()=>(t(),JSON.parse(i().getMetrics()))),g=Kt(()=>JG(s.map(([D,O])=>ee(p).total_length_meters[D])));function _(D){return D}var x=Ple(),b=ci(x),S=gt(Ft(b),2),P=Ft(S);Ys(P,21,()=>s,Xs,(D,O)=>{var U=Kt(()=>xc(ee(O),2));let j=()=>ee(U)[0];const G=Kt(()=>ee(p).total_length_meters[j()]);var N=Tle();let V;Zi(q=>V=go(N,"",V,q),[()=>({width:`${100*ee(G)/ee(g)}%`,height:"100%","background-color":hp[j()]})]),xt(D,N)});var L=gt(P,2);Ys(L,17,()=>s,Xs,(D,O)=>{var U=Kt(()=>xc(ee(O),2));let j=()=>ee(U)[0],G=()=>ee(U)[1];var N=Cle(),V=Ft(N);ls(V,{get checked(){return c()[j()]},set checked(q){c(c()[j()]=q,!0)},children:(q,z)=>{var Q=Mle(),X=ci(Q);let re;var oe=gt(X);Zi((de,ce)=>{re=go(X,"",re,de),ln(oe,` ${G()??""}: ${ce??""}`)},[()=>({background:hp[j()]}),()=>ww(ee(p).total_length_meters[j()])]),xt(q,Q)},$$slots:{default:!0}}),xt(D,N)});var E=gt(L,4);hs(E,()=>e.extraControls);var C=gt(b,2);Ys(C,17,()=>d,Xs,(D,O)=>{var U=Kt(()=>xc(ee(O),2));let j=()=>ee(U)[0],G=()=>ee(U)[1];var N=Ale(),V=Ft(N);ls(V,{get checked(){return c()[j()]},set checked(q){c(c()[j()]=q,!0)},children:(q,z)=>{var Q=Ele(),X=ci(Q);let re;var oe=gt(X);Zi((de,ce)=>{re=go(X,"",re,de),ln(oe,` ${G()??""}: ${ce??""}`)},[()=>({background:hp[j()]}),()=>ww(ee(p).total_length_meters[j()])]),xt(q,Q)},$$slots:{default:!0}}),xt(D,N)}),xt(n,x),tn(),o()}var Rle=Wt('<p class="mb-0"> </p>'),Lle=Wt("<!> <!>",1),kle=Wt('<div class="alert alert-warning"><h5 class="alert-heading d-flex align-items-center"><div class="flex-shrink-0 me-2"><i class="fa-solid fa-triangle-exclamation"></i></div> <div class="flex-grow-1"> </div></h5> <!> <!></div>'),Dle=Wt('<table class="table table-bordered"><thead><tr><th>Left</th><th>Right</th></tr></thead><tbody><tr><td><button>Yes <kbd>q</kbd></button></td><td><button>Yes <kbd>w</kbd></button></td></tr><tr><td><button>No <kbd>a</kbd></button></td><td><button>No <kbd>s</kbd></button></td></tr><tr><td><button>Separate <kbd>y</kbd></button></td><td><button>Separate <kbd>x</kbd></button></td></tr></tbody></table>'),Fle=Wt('<div><button class="btn btn-secondary mb-1"><kbd> </kbd> </button></div>'),Ole=Wt("<u>Set these tags</u> <!>",1),zle=Wt("<tr><td> </td><td> </td></tr>"),Ble=Wt("<p> </p>"),Nle=Wt('<!> <div class="card mb-5"><div class="card-header"><a target="_blank"> </a> ( <a target="_blank" title="Edit way"><i class="fa-solid fa-pencil"></i></a> </div> <div class="card-body"><!> <!> <table class="table table-bordered"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody></tbody></table> <!></div></div>',1);function $le(n,e){en(e,!0);const t=()=>Qi(zs,"$backend",o),i=()=>Qi(sa,"$mutationCounter",o),r=()=>Qi(xw,"$debugMode",o),[o,c]=qr();let s=ft(e,"showProblemDetails",15),d=ii("");function p(Fe){return Object.entries(Fe).filter(([qe])=>qe.startsWith("sidewalk")).map(([qe,Ue])=>[qe,Ue])}function g(Fe,qe,Ue){qe?(Fe.delete("sidewalk:left"),Fe.delete("sidewalk:right"),Fe.delete("sidewalk")):Ue&&(Fe.delete("sidewalk:both"),Fe.delete("sidewalk"))}function _(Fe,qe,Ue,ke,et){if(!(!ke&&!et)){if(qe)ke?Fe.set("sidewalk:right",qe):et&&Fe.set("sidewalk:left",qe);else if(Ue){if(ke){const ye=Fe.get("sidewalk:left");ye&&Fe.set("sidewalk:right",ye)}else if(et){const ye=Fe.get("sidewalk:right");ye&&Fe.set("sidewalk:left",ye)}}}}function x(Fe,qe){const Ue=p(Fe),ke=Fe["sidewalk:both"],et=Fe.sidewalk==="separate",ye=new Map;for(const[tt,Mt]of Ue)ye.set(tt,Mt);const Be=new Set(qe.map(([tt])=>tt)),Je=Be.has("sidewalk:both"),ct=Be.has("sidewalk:left"),yt=Be.has("sidewalk:right");g(ye,Je,ct||yt);for(const[tt,Mt]of qe)ye.set(tt,Mt);_(ye,ke,et,ct,yt);const fe=ye.get("sidewalk:left"),Ve=ye.get("sidewalk:right");return fe&&Ve&&fe===Ve&&(ye.set("sidewalk:both",fe),ye.delete("sidewalk:left"),ye.delete("sidewalk:right")),Array.from(ye.entries())}async function b(Fe){const qe=x(e.pinnedWay.properties.tags,Fe);Et(d,"Setting tags"),await al();try{t().editSetTags(BigInt(e.pinnedWay.properties.id),qe),rp(sa,i())}finally{Et(d,"")}}function S(Fe,qe,Ue){return Fe[qe]===Ue?"active":Fe.both&&Fe.both===Ue?"both-highlight":null}let P=[[["footway","sidewalk"]],[["footway","crossing"]]];function L(Fe){const qe=Object.entries(Fe),Ue=qe.filter(([et])=>et.toLowerCase().startsWith("sidewalk")),ke=qe.filter(([et])=>!et.toLowerCase().startsWith("sidewalk"));return Ue.sort(([et],[ye])=>et.localeCompare(ye)),ke.sort(([et],[ye])=>et.localeCompare(ye)),[...Ue,...ke]}function E(Fe){return{q:[["sidewalk:left","yes"]],a:[["sidewalk:left","no"]],y:[["sidewalk:left","separate"]],w:[["sidewalk:right","yes"]],s:[["sidewalk:right","no"]],x:[["sidewalk:right","separate"]]}[Fe]||null}async function C(Fe){if(!e.pinnedWay.properties.kind.startsWith("Road")){if(e.pinnedWay.properties.tags.highway=="footway"){let Ue=parseInt(Fe.key);Number.isInteger(Ue)&&Ue<=P.length&&await b(P[Ue-1])}return}const qe=E(Fe.key.toLowerCase());qe&&await b(qe)}var D=Nle();Kw("keydown",wy,C);var O=ci(D);Jd(O,{get loading(){return ee(d)}});var U=gt(O,2),j=Ft(U),G=Ft(j),N=Ft(G),V=gt(G,2),q=gt(V),z=gt(j,2),Q=Ft(z);{var X=Fe=>{const qe=Kt(()=>e.pinnedWay.properties.problems.find(fe=>fe.note==="possible separate sidewalk near way without it tagged")||e.pinnedWay.properties.problems[0]),Ue=Kt(()=>e.pinnedWay.properties.problems.filter(fe=>fe.note!==ee(qe).note));var ke=kle(),et=Ft(ke),ye=gt(Ft(et),2),Be=Ft(ye),Je=gt(et,2);{var ct=fe=>{var Ve=ir(),tt=ci(Ve);Ys(tt,17,()=>ee(Ue),Xs,(Mt,mt)=>{var Ce=Rle(),xe=Ft(Ce);Zi(()=>ln(xe,ee(mt).note)),xt(Mt,Ce)}),xt(fe,Ve)};Ki(Je,fe=>{ee(Ue).length&&fe(ct)})}var yt=gt(Je,2);{var we=fe=>{var Ve=Lle(),tt=ci(Ve);ls(tt,{get checked(){return s()},set checked(Ce){s(Ce)},children:(Ce,xe)=>{var vt=Vn("Highlight problem on map");xt(Ce,vt)},$$slots:{default:!0}});var Mt=gt(tt,2);{var mt=Ce=>{{let xe=Kt(()=>Object.fromEntries(e.drawProblemDetails.features.map(vt=>[vt.properties.label,vt.properties.color])));vC(Ce,{get labelColors(){return ee(xe)},itemsPerRow:1})}};Ki(Mt,Ce=>{s()&&Ce(mt)})}xt(fe,Ve)};Ki(yt,fe=>{e.drawProblemDetails.features.length&&fe(we)})}Zi(()=>ln(Be,ee(qe).note)),xt(Fe,ke)};Ki(Q,Fe=>{e.pinnedWay.properties.problems.length&&Fe(X)})}var re=gt(Q,2);{var oe=Fe=>{const qe=Kt(()=>t()?JSON.parse(t().normalizeSidewalkTags(BigInt(e.pinnedWay.properties.id))):{left:void 0,right:void 0,both:void 0});var Ue=Dle(),ke=Ft(Ue),et=Ft(ke),ye=Ft(et),Be=gt(ye),Je=gt(ke),ct=Ft(Je),yt=Ft(ct);let we,fe;var Ve=Ft(yt);let tt;Ve.__click=()=>b([["sidewalk:left","yes"]]);var Mt=gt(yt);let mt,Ce;var xe=Ft(Mt);let vt;xe.__click=()=>b([["sidewalk:right","yes"]]);var be=gt(ct),ie=Ft(be);let ae,De;var Xe=Ft(ie);let bt;Xe.__click=()=>b([["sidewalk:left","no"]]);var Te=gt(ie);let te,he;var pe=Ft(Te);let Re;pe.__click=()=>b([["sidewalk:right","no"]]);var Oe=gt(be),ht=Ft(Oe);let pt,ot;var St=Ft(ht);let Lt;St.__click=()=>b([["sidewalk:left","separate"]]);var zt=gt(ht);let Jt,gi;var Fi=Ft(zt);let un;Fi.__click=()=>b([["sidewalk:right","separate"]]),Zi((nn,Tt,hn,fr,Li,gn,zn,wn,kn,Sn,Kn,Ye,kt,at,Ot,Gt,Gi,Ci,Nt,si)=>{go(ye,`background-color: ${nn??""};`),go(Be,`background-color: ${Tt??""};`),we=Ds(yt,1,"",null,we,hn),fe=go(yt,"",fe,fr),tt=Ds(Ve,1,"btn btn-sm btn-secondary w-100",null,tt,Li),mt=Ds(Mt,1,"",null,mt,gn),Ce=go(Mt,"",Ce,zn),vt=Ds(xe,1,"btn btn-sm btn-secondary w-100",null,vt,wn),ae=Ds(ie,1,"",null,ae,kn),De=go(ie,"",De,Sn),bt=Ds(Xe,1,"btn btn-sm btn-secondary w-100",null,bt,Kn),te=Ds(Te,1,"",null,te,Ye),he=go(Te,"",he,kt),Re=Ds(pe,1,"btn btn-sm btn-secondary w-100",null,Re,at),pt=Ds(ht,1,"",null,pt,Ot),ot=go(ht,"",ot,Gt),Lt=Ds(St,1,"btn btn-sm btn-secondary w-100",null,Lt,Gi),Jt=Ds(zt,1,"",null,Jt,Ci),gi=go(zt,"",gi,Nt),un=Ds(Fi,1,"btn btn-sm btn-secondary w-100",null,un,si)},[()=>Hf("left",.3),()=>Hf("right",.3),()=>({"table-active":S(ee(qe),"left","yes")==="active"}),()=>({"background-color":S(ee(qe),"left","yes")==="both-highlight"?Hf("left",.15):""}),()=>({disabled:S(ee(qe),"left","yes")==="active"}),()=>({"table-active":S(ee(qe),"right","yes")==="active"}),()=>({"background-color":S(ee(qe),"right","yes")==="both-highlight"?Hf("right",.15):""}),()=>({disabled:S(ee(qe),"right","yes")==="active"}),()=>({"table-active":S(ee(qe),"left","no")==="active"}),()=>({"background-color":S(ee(qe),"left","no")==="both-highlight"?Hf("left",.15):""}),()=>({disabled:S(ee(qe),"left","no")==="active"}),()=>({"table-active":S(ee(qe),"right","no")==="active"}),()=>({"background-color":S(ee(qe),"right","no")==="both-highlight"?Hf("right",.15):""}),()=>({disabled:S(ee(qe),"right","no")==="active"}),()=>({"table-active":S(ee(qe),"left","separate")==="active"}),()=>({"background-color":S(ee(qe),"left","separate")==="both-highlight"?"rgba(255, 105, 180, 0.15)":""}),()=>({disabled:S(ee(qe),"left","separate")==="active"}),()=>({"table-active":S(ee(qe),"right","separate")==="active"}),()=>({"background-color":S(ee(qe),"right","separate")==="both-highlight"?Hf("right",.15):""}),()=>({disabled:S(ee(qe),"right","separate")==="active"})]),xt(Fe,Ue)},de=Fe=>{var qe=ir(),Ue=ci(qe);{var ke=et=>{var ye=Ole(),Be=gt(ci(ye),2);Ys(Be,17,()=>P.entries(),Xs,(Je,ct)=>{var yt=Kt(()=>xc(ee(ct),2));let we=()=>ee(yt)[0],fe=()=>ee(yt)[1];var Ve=Fle(),tt=Ft(Ve);tt.__click=()=>b(fe());var Mt=Ft(tt),mt=Ft(Mt),Ce=gt(Mt);Zi(xe=>{ln(mt,we()+1),ln(Ce,` ${xe??""}`)},[()=>fe().map(xe=>`${xe[0]} = ${xe[1]}`).join(", ")]),xt(Je,Ve)}),xt(et,ye)};Ki(Ue,et=>{e.pinnedWay.properties.tags.highway=="footway"&&et(ke)},!0)}xt(Fe,qe)};Ki(re,Fe=>{e.pinnedWay.properties.kind.startsWith("Road")?Fe(oe):Fe(de,!1)})}var ce=gt(re,2),Se=gt(Ft(ce));Ys(Se,21,()=>L(e.pinnedWay.properties.tags),Xs,(Fe,qe)=>{var Ue=Kt(()=>xc(ee(qe),2));let ke=()=>ee(Ue)[0],et=()=>ee(Ue)[1];var ye=zle();let Be;var Je=Ft(ye),ct=Ft(Je),yt=gt(Je),we=Ft(yt);Zi(fe=>{Be=Ds(ye,1,"",null,Be,fe),ln(ct,ke()),ln(we,et())},[()=>({"table-active":ke().toLowerCase().includes("sidewalk")})]),xt(Fe,ye)});var Pe=gt(ce,2);{var je=Fe=>{var qe=Ble(),Ue=Ft(qe);Zi(ke=>ln(Ue,`Nodes: ${ke??""}`),[()=>e.pinnedWay.properties.node_ids.join(", ")]),xt(Fe,qe)};Ki(Pe,Fe=>{r()&&Fe(je)})}Zi(()=>{Nl(G,"href",`https://www.openstreetmap.org/way/${e.pinnedWay.properties.id??""}`),ln(N,`Way ${e.pinnedWay.properties.id??""}`),Nl(V,"href",`https://www.openstreetmap.org/edit?way=${e.pinnedWay.properties.id??""}`),ln(q,` ) : ${jae[e.pinnedWay.properties.kind]??""}`)}),xt(n,D),tn(),c()}ds(["click"]);var Vle=Wt("<!> <!> <!> <!>",1),Ule=Wt("<tr><td> </td><td> </td></tr>"),jle=Wt("<p> </p>"),Gle=Wt("<u>Problems:</u> <!>",1),qle=Wt('<h4> </h4> <p> </p> <table class="table table-bordered"><tbody></tbody></table> <!>',1),Wle=Wt("<!> <!> <!>",1),Hle=Wt("<!> <!> <!> <!>",1),Zle=Wt("<!> <!> <!> <!>",1),Xle=Wt("<!> <!>",1);function Yle(n,e){en(e,!0);const t=()=>Qi(sa,"$mutationCounter",o),i=()=>Qi(zs,"$backend",o),r=()=>Qi(xw,"$debugMode",o),[o,c]=qr();let s=ii({type:"FeatureCollection",features:[]}),d=ii({type:"FeatureCollection",features:[]}),p=ii(null),g=ii(!1),_=ii(!1),x=ii(!1),b=ii(!0),S=ii(xs(Object.fromEntries(Object.keys(hp).map(N=>[N,!0])))),P=ii(!0),L=ii(xs(ro())),E=ii(!1),C=ii(""),D=ii(xs(ro()));cn(()=>{t(),Et(C,"Recalculating model"),al().then(()=>{try{Et(s,JSON.parse(i().getNodes())),Et(d,JSON.parse(i().getWays()))}finally{Et(C,"")}if(ee(p)){let N=ee(p).id;Et(p,ee(d).features.find(V=>V.id==N),!0)}})});function O(){let N=[];return ee(x)&&N.push(["any",["in",["get","kind"],["literal",["Sidewalk","Crossing","Other"]]],["get","is_severance"]]),ee(b)||N.push(["!",["get","is_service"]]),ee(_)&&N.push(["get","modified"]),N.push(["in",["get","kind"],["literal",Object.entries(ee(S)).filter(V=>V[1]).map(V=>V[0])]]),["all",...N]}var U=Xle(),j=ci(U);Jd(j,{get loading(){return ee(C)}});var G=gt(j,2);u0(G,{left:q=>{var z=Vle(),Q=ci(z);_le(Q,{});var X=gt(Q,2);hle(X,{get nodes(){return ee(s)},get ways(){return ee(d)},get drawProblems(){return ee(D)},set drawProblems(ce){Et(D,ce,!0)}});var re=gt(X,2);{var oe=ce=>{$le(ce,{get pinnedWay(){return ee(p)},get drawProblemDetails(){return ee(L)},get showProblemDetails(){return ee(P)},set showProblemDetails(Se){Et(P,Se,!0)}})};Ki(re,ce=>{ee(p)&&ce(oe)})}var de=gt(re,2);Sle(de,{}),xt(q,z)},main:q=>{var z=Zle(),Q=ci(z);{let de=Kt(O);Hae(Q,{get showProblemDetails(){return ee(P)},get nodes(){return ee(s)},get ways(){return ee(d)},get showRoadSides(){return ee(E)},get filterWays(){return ee(de)},get pinnedWay(){return ee(p)},set pinnedWay(ce){Et(p,ce,!0)},get drawProblemDetails(){return ee(L)},set drawProblemDetails(ce){Et(L,ce,!0)}})}var X=gt(Q,2);fle(X,{get drawProblems(){return ee(D)},get pinnedWay(){return ee(p)}});var re=gt(X,2);Ws(re,{get data(){return ee(s)},children:(de,ce)=>{{let Se=Kt(()=>({"circle-radius":7,"circle-color":["case",["any",["get","is_crossing"],["get","is_explicit_crossing_no"]],"yellow","grey"],"circle-opacity":["case",["any",["get","is_crossing"],["get","is_explicit_crossing_no"]],ee(_)?["case",["get","modified"],1,.5]:1,0],"circle-stroke-color":["case",["has","tags"],"black","grey"],"circle-stroke-width":1})),Pe=Kt(()=>({visibility:ee(g)?"visible":"none"}));cu(de,{beforeId:"Road labels",manageHoverState:!0,get paint(){return ee(Se)},get layout(){return ee(Pe)},children:(je,Fe)=>{fC(je,{openOn:"hover",children:(Ue,ke)=>{let et=()=>ke?.().data;const ye=Kt(()=>et()?.properties??{}),Be=Kt(()=>JSON.parse(ee(ye).problems));var Je=qle(),ct=ci(Je),yt=Ft(ct),we=gt(ct,2),fe=Ft(we),Ve=gt(we,2),tt=Ft(Ve);Ys(tt,21,()=>Object.entries(JSON.parse(ee(ye).tags||"{}")),Xs,(Ce,xe)=>{var vt=Kt(()=>xc(ee(xe),2));let be=()=>ee(vt)[0],ie=()=>ee(vt)[1];var ae=Ule(),De=Ft(ae),Xe=Ft(De),bt=gt(De),Te=Ft(bt);Zi(()=>{ln(Xe,be()),ln(Te,ie())}),xt(Ce,ae)});var Mt=gt(Ve,2);{var mt=Ce=>{var xe=Gle(),vt=gt(ci(xe),2);Ys(vt,17,()=>ee(Be),Xs,(be,ie)=>{var ae=jle(),De=Ft(ae);Zi(()=>ln(De,ee(ie).note)),xt(be,ae)}),xt(Ce,xe)};Ki(Mt,Ce=>{ee(Be).length&&Ce(mt)})}Zi(()=>{ln(yt,`Node ${ee(ye).id??""}`),ln(fe,`Ways: ${ee(ye).way_ids??""}`)}),xt(Ue,Je)},$$slots:{default:!0}})},$$slots:{default:!0}})}},$$slots:{default:!0}});var oe=gt(re,2);hF(oe,{position:"top-right",children:(de,ce)=>{Hd(de,{header:je=>{var Fe=Vn("Layers");xt(je,Fe)},body:je=>{var Fe=Hle(),qe=ci(Fe);ls(qe,{get checked(){return X2(),r()},set checked(ye){Do(xw,ye)},children:(ye,Be)=>{var Je=Vn("Debug mode");xt(ye,Je)},$$slots:{default:!0}});var Ue=gt(qe,2);ls(Ue,{get checked(){return ee(g)},set checked(ye){Et(g,ye,!0)},children:(ye,Be)=>{var Je=Vn("Nodes");xt(ye,Je)},$$slots:{default:!0}});var ke=gt(Ue,2);ls(ke,{get checked(){return ee(_)},set checked(ye){Et(_,ye,!0)},children:(ye,Be)=>{var Je=Vn("Only modified objects");xt(ye,Je)},$$slots:{default:!0}});var et=gt(ke,2);Ile(et,{get showKinds(){return ee(S)},set showKinds(Be){Et(S,Be,!0)},extraControls:Be=>{var Je=Wle(),ct=ci(Je);ls(ct,{get checked(){return ee(x)},set checked(fe){Et(x,fe,!0)},children:(fe,Ve)=>{var tt=Vn("Only show major roads");xt(fe,tt)},$$slots:{default:!0}});var yt=gt(ct,2);ls(yt,{get checked(){return ee(b)},set checked(fe){Et(b,fe,!0)},children:(fe,Ve)=>{var tt=Vn("Show service roads");xt(fe,tt)},$$slots:{default:!0}});var we=gt(yt,2);ls(we,{get checked(){return ee(E)},set checked(fe){Et(E,fe,!0)},children:(fe,Ve)=>{var tt=Vn("Show each side with sidewalks â or not â");xt(fe,tt)},$$slots:{default:!0}}),xt(Be,Je)},$$slots:{extraControls:!0}}),xt(je,Fe)},$$slots:{header:!0,body:!0}})},$$slots:{default:!0}}),xt(q,z)},$$slots:{left:!0,main:!0}}),xt(n,U),tn(),c()}var Kle=Wt(`<button class="btn btn-secondary">Generate imaginary crossings where they're missing</button>`),Jle=Wt('<button class="btn btn-secondary">Bulk operations</button>'),Qle=Wt("<h2>Bulk operations</h2>"),ece=Wt(`<!> <p>Speedwalk has some experimental features that can automatically generate
    crossing nodes on every arm of a junction where they're expected. This is
    intended <b>only</b> for use in other projects to study the potential benefits of having more crossings.
    Do not ever upload the results of this to OSM.</p> <button class="btn btn-primary">I understand</button> <button class="btn btn-secondary">Cancel</button>`,1),tce=Wt("<!> <!> <!>",1);function ice(n,e){en(e,!0);const t=()=>Qi(bw,"$enabledBulkOps",o),i=()=>Qi(zs,"$backend",o),r=()=>Qi(sa,"$mutationCounter",o),[o,c]=qr();let s=ii(!1);function d(){Do(bw,!0),Et(s,!1)}let p=ii("");async function g(){Et(p,"Generating missing crossings"),await al();try{i().editGenerateMissingCrossings(e.options),rp(sa,r())}catch(E){window.alert(`Error: ${E}`)}finally{Et(p,"")}}var _=tce(),x=ci(_);Jd(x,{get loading(){return ee(p)}});var b=gt(x,2);{var S=E=>{Hd(E,{header:O=>{var U=Vn("Bulk operations");xt(O,U)},body:O=>{var U=Kle();U.__click=g,xt(O,U)},$$slots:{header:!0,body:!0}})},P=E=>{var C=Jle();C.__click=()=>Et(s,!0),xt(E,C)};Ki(b,E=>{t()?E(S):E(P,!1)})}var L=gt(b,2);_p(L,{get show(){return ee(s)},set show(E){Et(s,E,!0)},children:(E,C)=>{var D=ece(),O=ci(D);n1(O,{children:(G,N)=>{var V=Qle();xt(G,V)}});var U=gt(O,4);U.__click=d;var j=gt(U,2);j.__click=()=>Et(s,!1),xt(E,D)},$$slots:{default:!0}}),xt(n,_),tn(),c()}ds(["click"]);var nce=Wt('<p> <!> <!>.</p> <p class="mb-3"><i> </i></p>',1),rce=Wt(`<h4>Crossings audit</h4> <p> </p> <!> <hr/> <p>For each junction shown, this tool looks for crossing nodes on each arm
      (road) of the junction. Please map a crossing node on each arm by clicking
      to open in iD, then refreshing data here to check. If there's no way to
      cross an arm, use <a href="https://wiki.openstreetmap.org/wiki/Tag:crossing=no" target="_blank">crossing=no</a> to indicate a lack of a crossing. Please ignore cases where you would not expect
      any crossing to be (and report a bug to improve this tool). And note that there
      might be mid-block crossings anywhere along a road; this tool only audits junctions.</p> <!>`,1),sce=Wt("<tr><td> </td><td> </td></tr>"),oce=Wt('<h4> </h4> <table class="table table-bordered"><tbody></tbody></table>',1),ace=Wt("Ignore <code>service</code> , <code>track</code> roads",1),lce=Wt("Ignore <code>footway</code> and <code>path</code>",1),cce=Wt('<!> <!> <!> <!> <!> <!> <div><label class="form-label">How far away can a crossing be? (m): <input class="form-control" type="number" min="1" max="100"/></label></div> <div class="card card-body mt-3"><!></div>',1),uce=Wt("<!> <!> <!> <!> <!> <!>",1);function hce(n,e){en(e,!0);const t=()=>Qi(zs,"$backend",o),i=()=>Qi(sa,"$mutationCounter",o),r=()=>Qi(Fh,"$map",o),[o,c]=qr();let s=xs({only_major_roads:!0,ignore_utility_roads:!0,ignore_cycleways:!0,ignore_footways:!0,ignore_roundabouts:!0,ignore_motorways:!0,max_distance:40}),d=Kt(()=>t()&&s.max_distance&&i()>=0?JSON.parse(t().auditCrossings(s)):ro()),p=Kt(()=>ee(d).features.filter(O=>O.properties.complete).length),g=ii(void 0),_=Kt(()=>ee(g)?JSON.parse(ee(g).properties.arms):ro()),x=Kt(()=>ee(g)?JSON.parse(ee(g).properties.crossings):ro()),b=Kt(()=>ee(g)?JSON.parse(ee(g).properties.explicit_non_crossings):ro()),S=Kt(()=>ee(x).features.length),P=Kt(()=>ee(b).features.length),L=Kt(()=>ee(g)?ee(g).properties.number_ignored_arms:0),E=Kt(()=>{if(i(),!t())return ro();let O=JSON.parse(t().getNodes());return O.features=O.features.filter(U=>U.properties.is_crossing||U.properties.is_explicit_crossing_no),O});function C(){let O=pO(r());if(O){let U=mO(O.zoom,O.lat,O.lng);window.open(U,"_blank","noopener,noreferrer")}}let D={"Junction to audit":"black","Fully mapped junction":"green",Crossing:"yellow","crossing=no":"purple","crossing=generated":"cyan"};u0(n,{left:j=>{var G=rce(),N=gt(ci(G),2),V=Ft(N),q=gt(N,2);{var z=X=>{var re=nce(),oe=ci(re),de=Ft(oe),ce=gt(de);{var Se=et=>{var ye=Vn();Zi(()=>ln(ye,`(plus ${ee(L)??""}
          ${ee(L)==1?"arm":"arms"} not expected to have crossings)`)),xt(et,ye)};Ki(ce,et=>{ee(L)>0&&et(Se)})}var Pe=gt(ce),je=gt(Pe);{var Fe=et=>{var ye=Vn();Zi(()=>ln(ye,`, ${ee(P)??""} explicit ${ee(P)==1?"non-crossing":"non-crossings"}`)),xt(et,ye)};Ki(je,et=>{ee(P)>0&&et(Fe)})}var qe=gt(oe,2),Ue=Ft(qe),ke=Ft(Ue);Zi(()=>{ln(de,`Junction has ${ee(_).features.length-ee(L)} arms `),ln(Pe,`,
        ${ee(S)??""}
        ${ee(S)==1?"crossing":"crossings"} `),ln(ke,`Arms are up to ${s.max_distance??""}m away from the junction along
          the same OSM way. If the way is split before a crossing, the crossing
          won't be counted. Only the first crossing is counted per arm.`)}),xt(X,re)};Ki(q,X=>{ee(g)&&X(z)})}var Q=gt(q,6);ice(Q,{get options(){return s}}),Zi((X,re)=>ln(V,`${X??""} / ${re??""}
      junctions have all possible crossings mapped`),[()=>ee(p).toLocaleString(),()=>ee(d).features.length.toLocaleString()]),xt(j,G)},main:j=>{var G=uce(),N=ci(G);Ws(N,{get data(){return ee(d)},generateId:!0,children:(re,oe)=>{{let de=Kt(()=>({"circle-radius":15,"circle-color":["case",["get","complete"],D["Fully mapped junction"],D["Junction to audit"]],"circle-opacity":Gg(.5,1),"circle-stroke-color":"black","circle-stroke-width":3}));cu(re,{manageHoverState:!0,get paint(){return ee(de)},hoverCursor:"pointer",onclick:C,get hovered(){return ee(g)},set hovered(ce){Et(g,ce,!0)}})}},$$slots:{default:!0}});var V=gt(N,2);Ws(V,{get data(){return ee(_)},children:(re,oe)=>{tl(re,{paint:{"line-width":6,"line-color":["case",["get","has_crossing"],"blue","red"]}})},$$slots:{default:!0}});var q=gt(V,2);Ws(q,{get data(){return ee(E)},generateId:!0,children:(re,oe)=>{{let de=Kt(()=>({"circle-radius":7,"circle-color":["case",["get","is_explicit_crossing_no"],D["crossing=no"],["get","is_generated_crossing"],D["crossing=generated"],D.Crossing],"circle-opacity":Gg(.3,1),"circle-stroke-color":"black","circle-stroke-width":1}));cu(re,{manageHoverState:!0,get paint(){return ee(de)},children:(ce,Se)=>{fC(ce,{openOn:"hover",children:(je,Fe)=>{let qe=()=>Fe?.().data;const Ue=Kt(()=>qe()?.properties??{});var ke=oce(),et=ci(ke),ye=Ft(et),Be=gt(et,2),Je=Ft(Be);Ys(Je,21,()=>Object.entries(JSON.parse(ee(Ue).tags||"{}")),Xs,(ct,yt)=>{var we=Kt(()=>xc(ee(yt),2));let fe=()=>ee(we)[0],Ve=()=>ee(we)[1];var tt=sce(),Mt=Ft(tt),mt=Ft(Mt),Ce=gt(Mt),xe=Ft(Ce);Zi(()=>{ln(mt,fe()),ln(xe,Ve())}),xt(ct,tt)}),Zi(()=>ln(ye,`Node ${ee(Ue).id??""}`)),xt(je,ke)},$$slots:{default:!0}})},$$slots:{default:!0}})}},$$slots:{default:!0}});var z=gt(q,2);Ws(z,{get data(){return ee(x)},children:(re,oe)=>{cu(re,{paint:{"circle-radius":10,"circle-opacity":0,"circle-stroke-color":"black","circle-stroke-width":3}})},$$slots:{default:!0}});var Q=gt(z,2);Ws(Q,{get data(){return ee(b)},children:(re,oe)=>{cu(re,{paint:{"circle-radius":10,"circle-opacity":0,"circle-stroke-color":"purple","circle-stroke-width":3}})},$$slots:{default:!0}});var X=gt(Q,2);hF(X,{position:"top-right",children:(re,oe)=>{Hd(re,{header:Se=>{var Pe=Vn("Settings");xt(Se,Pe)},body:Se=>{var Pe=cce(),je=ci(Pe);ls(je,{get checked(){return s.only_major_roads},set checked(we){s.only_major_roads=we},children:(we,fe)=>{var Ve=Vn("Only junctions on major roads");xt(we,Ve)},$$slots:{default:!0}});var Fe=gt(je,2);ls(Fe,{get checked(){return s.ignore_utility_roads},set checked(we){s.ignore_utility_roads=we},children:(we,fe)=>{var Ve=ace();xt(we,Ve)},$$slots:{default:!0}});var qe=gt(Fe,2);ls(qe,{get checked(){return s.ignore_cycleways},set checked(we){s.ignore_cycleways=we},children:(we,fe)=>{var Ve=Vn("Ignore cycleways");xt(we,Ve)},$$slots:{default:!0}});var Ue=gt(qe,2);ls(Ue,{get checked(){return s.ignore_footways},set checked(we){s.ignore_footways=we},children:(we,fe)=>{var Ve=lce();xt(we,Ve)},$$slots:{default:!0}});var ke=gt(Ue,2);ls(ke,{get checked(){return s.ignore_roundabouts},set checked(we){s.ignore_roundabouts=we},children:(we,fe)=>{var Ve=Vn("Don't expect crossings on roundabouts");xt(we,Ve)},$$slots:{default:!0}});var et=gt(ke,2);ls(et,{get checked(){return s.ignore_motorways},set checked(we){s.ignore_motorways=we},children:(we,fe)=>{var Ve=Vn("Don't expect crossings on motorways");xt(we,Ve)},$$slots:{default:!0}});var ye=gt(et,2),Be=Ft(ye),Je=gt(Ft(Be)),ct=gt(ye,2),yt=Ft(ct);vC(yt,{get labelColors(){return D},itemsPerRow:1,swatchClass:"circle"}),Tg(Je,()=>s.max_distance,we=>s.max_distance=we),xt(Se,Pe)},$$slots:{header:!0,body:!0}})},$$slots:{default:!0}}),xt(j,G)},$$slots:{left:!0,main:!0}}),tn(),c()}var dce=Wt('<div class="card"><div class="card-body"><div class="form-check"><label class="form-check-label"><input class="form-check-input" type="radio"/> Everything</label></div> <div class="form-check"><label class="form-check-label"><input class="form-check-input" type="radio"/> Only footways</label></div> <div class="form-check mb-3"><label class="form-check-label"><input class="form-check-input" type="radio"/> Anything routeable for walking</label></div> <!></div></div>');function NN(n,e){en(e,!1);const t=()=>Qi(Yf,"$networkFilter",i),[i,r]=qr(),o=[];Jw();var c=dce(),s=Ft(c),d=Ft(s),p=Ft(d),g=Ft(p);g.value=g.__value="Everything";var _=gt(d,2),x=Ft(_),b=Ft(x);b.value=b.__value="OnlyExplicitFootways";var S=gt(_,2),P=Ft(S),L=Ft(P);L.value=L.__value="RouteableNetwork";var E=gt(S,2);ls(E,{get checked(){return t().ignore_deadends},set checked(C){Cb(Yf,bs(t).ignore_deadends=C,bs(t))},children:(C,D)=>{var O=Vn("Ignore dead ends under 10m and disconnected segments under 100m");xt(C,O)},$$slots:{default:!0},$$legacy:!0}),Bx(o,[],g,()=>t().include,C=>Cb(Yf,bs(t).include=C,bs(t))),Bx(o,[],b,()=>t().include,C=>Cb(Yf,bs(t).include=C,bs(t))),Bx(o,[],L,()=>t().include,C=>Cb(Yf,bs(t).include=C,bs(t))),xt(n,c),tn(),r()}var fce=Wt('<li><a href="#"> </a></li>'),pce=Wt("<h4>Network disconnections</h4> <p>This shows where the network is disconnected. Click a piece to see it.</p> <!> <ul></ul>",1),mce=Wt("<!> <!>",1);function gce(n,e){en(e,!0);const t=()=>Qi(zs,"$backend",o),i=()=>Qi(Yf,"$networkFilter",o),r=()=>Qi(Fh,"$map",o),[o,c]=qr();let s=Kt(()=>t()?JSON.parse(t().findConnectedComponents(i())):{...ro(),component_lengths:[]}),d=["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e"],p=Ly(["to-string",["%",["get","component"],d.length]],Object.fromEntries(d.map((S,P)=>[P.toString(),S])),"black"),g=ii(null);function _(S){return S==null?p:["case",["==",["get","component"],S],p,"black"]}function x(S){Et(g,S.features[0].properties.component,!0)}function b(S){r().queryRenderedFeatures(S.point,{layers:["speedwalk-disconnections"]}).length==0&&Et(g,null)}u0(n,{left:L=>{var E=pce(),C=gt(ci(E),4);NN(C,{});var D=gt(C,2);Ys(D,21,()=>ee(s).component_lengths,Xs,(O,U,j)=>{var G=fce(),N=Ft(G);N.__click=z=>{z.preventDefault(),r()?.fitBounds(ee(s).component_bboxes[j]),Et(g,j,!0)};let V;var q=Ft(N);Zi(z=>{V=go(N,"",V,{color:d[j%d.length]}),ln(q,z)},[()=>ww(ee(U))]),xt(O,G)}),xt(L,E)},main:L=>{var E=mce(),C=ci(E);pF(C,{onclick:b});var D=gt(C,2);Ws(D,{get data(){return ee(s)},generateId:!0,children:(O,U)=>{{let j=Kt(()=>({"line-width":Gg(5,10),"line-color":_(ee(g))}));tl(O,{id:"speedwalk-disconnections",get paint(){return ee(j)},manageHoverState:!0,hoverCursor:"pointer",onclick:x})}},$$slots:{default:!0}}),xt(L,E)},$$slots:{left:!0,main:!0}}),tn(),c()}ds(["click"]);var _ce=Wt(`<p>The output will have a LineString for each edge in the network. An
          edge goes between exactly two graph nodes, so one OSM way usually
          becomes many edges. Each LineString will have these properties:</p> <ul><li><b>node1</b> : The OSM node ID of the beginning of the edge. This is safer to use to
            form a graph than the first coordinate.</li> <li><b>node2</b> : The OSM node ID of the end of the edge. This is safer to use to form
            a graph than the last coordinate.</li> <li><b>way</b> : The OSM way ID where this edge comes from.</li> <li><b>osm_id</b> : For bulk generated crossing ways, this will be <i>node/123</i> pointing to the crossing node. For bulk generated sidewalks, this will
            be <i>way/123</i> of the road that the sidewalk is parallel to. For regular existing ways,
            this will be <i>way/123</i> matching the <b>way</b> property.</li> <li><b>kind</b> : Speedwalk's classification of this edge</li> <li>Each tag from the OSM way will appear as a key and value</li></ul> <p>Note that OSM IDs <b>node1</b> , <b>node2</b> , and <b>way</b> will be negative if you have run bulk operations and generated synthetic
          sidewalks or crossings.</p>`,1),vce=Wt('<h4>Export network</h4> <p>You can export the routeable walking network as a GeoJSON file.</p> <!> <button class="btn btn-primary mt-3 mb-3">Download GeoJSON</button> <!> <!>',1),yce=Wt("<tr><td> </td><td> </td></tr>"),bce=Wt('<table class="table table-bordered"><tbody></tbody></table> <div style="margin-top: 8px;"><strong>Length:</strong> </div>',1);function xce(n,e){en(e,!0);const t=()=>Qi(zs,"$backend",r),i=()=>Qi(Yf,"$networkFilter",r),[r,o]=qr();let c=Kt(()=>t()?JSON.parse(t().exportNetwork(i())):ro());function s(){h0("network.geojson",JSON.stringify(ee(c)))}u0(n,{left:g=>{var _=vce(),x=gt(ci(_),4);NN(x,{});var b=gt(x,2);b.__click=s;var S=gt(b,2);Hd(S,{open:!1,header:C=>{var D=Vn("Details");xt(C,D)},body:C=>{var D=_ce();xt(C,D)},$$slots:{header:!0,body:!0}});var P=gt(S,2);Hd(P,{header:C=>{var D=Vn("Legend");xt(C,D)},body:C=>{vC(C,{get labelColors(){return hp},itemsPerRow:1})},$$slots:{header:!0,body:!0}}),xt(g,_)},main:g=>{Ws(g,{get data(){return ee(c)},generateId:!0,children:(_,x)=>{{let b=Kt(()=>({"line-width":Md(0),"line-color":Ly(["get","kind"],hp,"cyan"),"line-opacity":Gg(1,.5)}));tl(_,{manageHoverState:!0,get paint(){return ee(b)},children:(S,P)=>{fC(S,{openOn:"hover",children:(E,C)=>{let D=()=>C?.().data;var O=bce(),U=ci(O),j=Ft(U);Ys(j,21,()=>Object.entries(D().properties),Xs,(V,q)=>{var z=Kt(()=>xc(ee(q),2));let Q=()=>ee(z)[0],X=()=>ee(z)[1];var re=yce(),oe=Ft(re),de=Ft(oe),ce=gt(oe),Se=Ft(ce);Zi(()=>{ln(de,Q()),ln(Se,X())}),xt(V,re)});var G=gt(U,2),N=gt(Ft(G));Zi(V=>ln(N,` ${V??""}`),[()=>D().properties.length!=null?ww(D().properties.length):"-"]),xt(E,O)},$$slots:{default:!0}})},$$slots:{default:!0}})}},$$slots:{default:!0}})},$$slots:{left:!0,main:!0}}),tn(),o()}ds(["click"]);function wce(n,e){en(e,!1);const t=()=>Qi(zs,"$backend",i),[i,r]=qr();let o=JSON.parse(t().getBoundary()),c={type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[180,90],[-180,90],[-180,-90],[180,-90],[180,90]],o.geometry.coordinates[0]]}};Jw(),Ws(n,{get data(){return c},children:(s,d)=>{hC(s,{paint:{"fill-color":"black","fill-opacity":.3}})},$$slots:{default:!0}}),tn(),r()}var Sce=Wt('<img alt="OSM avatar" height="30"/>'),Tce=Wt('<div class="nav-item dropdown"><button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><!> </button> <ul class="dropdown-menu"><li><a class="dropdown-item" href="#">Logout</a></li></ul></div>'),Mce=Wt('<button class="btn btn-primary">Login to OSM</button>');function Cce(n,e){en(e,!1);const t=()=>Qi(fy,"$loggedInUser",i),[i,r]=qr();Y2(o);async function o(){if(iy.isLoggedIn()){let x=await iy.getUser("me");Do(fy,{name:x.display_name,uid:x.id,avatarUrl:x.img?.href||""})}}async function c(){try{await iy.login({mode:"popup",clientId:"vyCV0t-IiskqNBgpiHvuSAmf2nC8K-zfByeFL6XtAzc",redirectUrl:`${window.location.origin}/speedwalk/land.html`,scopes:["read_prefs","write_api"]}),await o()}catch(x){window.alert(`Login failed: ${x}`)}}async function s(){Do(fy,void 0),await iy.logout()}Jw();var d=ir(),p=ci(d);{var g=x=>{var b=Tce(),S=Ft(b),P=Ft(S);{var L=U=>{var j=Sce();Zi(()=>Nl(j,"src",t().avatarUrl)),xt(U,j)};Ki(P,U=>{t().avatarUrl&&U(L)})}var E=gt(P),C=gt(S,2),D=Ft(C),O=Ft(D);O.__click=s,Zi(()=>ln(E,` ${t().name??""}`)),xt(x,b)},_=x=>{var b=Mce();b.__click=c,xt(x,b)};Ki(p,x=>{t()?x(g):x(_,!1)})}xt(n,d),tn(),r()}ds(["click"]);const Ece="/speedwalk/assets/logo-3MjkCCFo.svg";var Ace=Wt('<h1>Choose an area to work on</h1> <div class="mb-3"><button class="btn btn-secondary">Import a new area</button></div> <div class="card card-body mb-3"><p> </p> <button class="btn btn-secondary">Refresh OSM data</button> <!> <!></div> <button class="btn btn-primary">Cancel</button>',1),Pce=Wt('<!> <!> <button class="btn btn-outline-secondary">&larr; Load another area</button>',1);function Ice(n,e){en(e,!0);const t=()=>Qi(yw,"$anyEdits",o),i=()=>Qi(zs,"$backend",o),r=()=>Qi(ky,"$saveCopy",o),[o,c]=qr();let s=ii(!1),d=ii("");function p(E){if(E){let C=new Date(1e3*Number(E));return`${C.toLocaleString()} (${g(C)} ago)`}return"unknown"}function g(E){let C=Date.now()-E.getTime(),D=Math.floor(C/1e3),O=Math.floor(D/60),U=Math.floor(O/60),j=Math.floor(U/24);return j?j==1?"1 day":`${j} days`:U?U==1?"1 hour":`${U} hours`:O?O==1?"1 minute":`${O} minutes`:"a few seconds"}function _(){t()&&!window.confirm("Changing areas will discard your current edits. Do you want to clear the edits?")||(Do(zs,null),Do(yw,!1))}async function x(){if(!(t()&&!window.confirm("Refreshing OSM data will discard your current edits. Do you want to clear the edits?"))){Et(s,!1);try{Et(d,"Grabbing new OSM data from Overpass");let E=JSON.parse(i().getBoundary()),D=await(await r1(bC(E))).bytes();if(r()){let O=new TextDecoder().decode(D);h0("refreshed_import.osm.xml",O)}Et(d,"Processing Overpass data"),await al(),Do(zs,new Dy(new Uint8Array(D),E))}catch(E){window.alert(`Couldn't import from Overpass: ${E}`)}finally{Et(d,"")}}}var b=Pce(),S=ci(b);Jd(S,{get loading(){return ee(d)}});var P=gt(S,2);_p(P,{get show(){return ee(s)},set show(E){Et(s,E,!0)},children:(E,C)=>{var D=Ace(),O=gt(ci(D),2),U=Ft(O);U.__click=_;var j=gt(O,2),G=Ft(j),N=Ft(G),V=gt(G,2);V.__click=x;var q=gt(V,2);n1(q,{children:(X,re)=>{ls(X,{get checked(){return X2(),r()},set checked(oe){Do(ky,oe)},children:(oe,de)=>{var ce=Vn("Save a copy of the latest osm.xml after refreshing");xt(oe,ce)},$$slots:{default:!0}})}});var z=gt(q,2);JF(z);var Q=gt(j,2);Q.__click=()=>Et(s,!1),Zi(X=>ln(N,`OSM data is from ${X??""}`),[()=>p(i()?.getOsmTimestamp())]),xt(E,D)},$$slots:{default:!0}});var L=gt(P,2);L.__click=()=>Et(s,!0),xt(n,b),tn(),c()}ds(["click"]);var Rce=Wt('<li class="nav-item"><a href="#"> </a></li>'),Lce=Wt("<!> <!>",1),kce=Wt(`<h1>Welcome to Speedwalk</h1> <p>This tool helps you quickly assess how sidewalks are mapped in OSM. You can
    find and fix common tagging problems. The tool assumes you understand the
    correct <a href="https://wiki.openstreetmap.org/wiki/Sidewalks" target="_blank">sidewalk mapping conventions</a> . If you are unsure about some edits you make, you can download the changeset
    file and check in JOSM, rather than uploading directly.</p> <p>This is an <a href="https://github.com/a-b-street/speedwalk" target="_blank">open source project</a> developed by <a href="https://abstreet.uk" target="_blank">A/B Street Ltd</a> and <a href="https://fixmycity.de/" target="_blank">FixMyCity GmbH</a> , partly funded by FixMyCity. Please <a href="https://github.com/a-b-street/speedwalk/issues/" target="_blank">file a Github issue</a> or contact <a href="mailto:dustin@abstreet.uk" target="_blank">dustin@abstreet.uk</a> with feedback. <b>This is an alpha tool; there will be problems!</b></p> <button class="btn btn-primary">Start</button>`,1),Dce=Wt('<ul class="nav nav-underline"><img style="height: 30px" alt="A/B Street logo"/> <h3>Speedwalk</h3> <!> <li class="nav-item ms-auto"><a class="nav-link" href="#"><i class="fa-solid fa-circle-info"></i> About</a></li> <!></ul> <!>',1);function Fce(n){const e=()=>Qi(zs,"$backend",i),t=()=>Qi(QM,"$mode",i),[i,r]=qr();let o=ii(!1),c=[[{kind:"sidewalks"},"Sidewalks"],[{kind:"crossings"},"Crossings"],[{kind:"disconnections"},"Network disconnections"],[{kind:"export"},"Export"]];var s=Dce(),d=ci(s),p=Ft(d),g=gt(p,4);{var _=L=>{var E=Lce(),C=ci(E);Ice(C,{});var D=gt(C,2);Ys(D,17,()=>c,Xs,(O,U)=>{var j=Kt(()=>xc(ee(U),2));let G=()=>ee(j)[0],N=()=>ee(j)[1];var V=Rce(),q=Ft(V);let z;q.__click=()=>Do(QM,G());var Q=Ft(q);Zi(X=>{z=Ds(q,1,"nav-link",null,z,X),ln(Q,N())},[()=>({active:JSON.stringify(t())==JSON.stringify(G())})]),xt(O,V)}),xt(L,E)};Ki(g,L=>{e()&&L(_)})}var x=gt(g,2),b=Ft(x);b.__click=()=>Et(o,!0);var S=gt(x,2);Cce(S,{});var P=gt(d,2);_p(P,{get show(){return ee(o)},set show(L){Et(o,L,!0)},children:(L,E)=>{var C=kce(),D=gt(ci(C),6);D.__click=()=>Et(o,!1),xt(L,C)},$$slots:{default:!0}}),Zi(()=>Nl(p,"src",Ece)),xt(n,s),r()}ds(["click"]);var Oce=Wt('<link rel="icon" type="image/x-icon"/>'),zce=Wt("<div></div>"),Bce=Wt('<div class="p-3"><!></div>'),Nce=Wt("<!> <!>",1),$ce=Wt("<!> <!> <!> <!>",1),Vce=Wt('<div style="position:relative; width: 100%; height: 100vh;"><!></div>');function Uce(n,e){en(e,!0);const t=()=>Qi(zs,"$backend",r),i=()=>Qi(QM,"$mode",r),[r,o]=qr();Y2(async()=>{await QF()});let c=ii(void 0),s=ii(!1);cn(()=>{ee(c)&&Fh.set(ee(c))});let d=ii("Maptiler OpenStreetMap"),p=op.get(ee(d));cn(()=>{ee(d)&&bs(()=>{ee(c)?.setStyle(op.get(ee(d)),{transformStyle:(g,_)=>{if(!g)return _;let x=g.layers.filter(P=>["circle-","line-","fill-","heatmap-","symbol-","speedwalk-","edit-polygon-"].some(L=>P.id.startsWith(L))),b=_.layers.concat(x),S=_.sources;for(let[P,L]of Object.entries(g.sources||{}))(P.startsWith("geojson-")||P.startsWith("heatmap")||P.startsWith("vector-"))&&(S[P]=L);return{..._,sources:S,layers:b}}})})}),M6("1n46o8q",g=>{var _=Oce();Zi(()=>Nl(_,"href",p7)),xt(g,_)}),FU(n,{top:b=>{Fce(b)},left:b=>{var S=Bce(),P=Ft(S);{var L=E=>{var C=zce();Sc(C,D=>uy.value=D,()=>uy?.value),xt(E,C)};Ki(P,E=>{ee(c)&&E(L)})}xt(b,S)},main:b=>{var S=Vce(),P=Ft(S);{let L=Kt(()=>[{id:"arrow",url:m7},{id:"chevron",url:g7}]);U8(P,{get style(){return p},hash:!0,onerror:E=>{console.log(E.error)},get images(){return ee(L)},get map(){return ee(c)},set map(E){Et(c,E,!0)},get loaded(){return ee(s)},set loaded(E){Et(s,E,!0)},children:(E,C)=>{var D=$ce(),O=ci(D);AG(O,{get map(){return ee(c)}});var U=gt(O,2);CG(U,{get map(){return ee(c)},get loaded(){return ee(s)}});var j=gt(U,2);Uae(j,{get basemap(){return ee(d)},set basemap(V){Et(d,V,!0)}});var G=gt(j,2);{var N=V=>{var q=ir(),z=ci(q);{var Q=re=>{var oe=Nce(),de=ci(oe);wce(de,{});var ce=gt(de,2);a0(ce,i,Se=>{var Pe=ir(),je=ci(Pe);{var Fe=Ue=>{Yle(Ue,{})},qe=Ue=>{var ke=ir(),et=ci(ke);{var ye=Je=>{hce(Je,{})},Be=Je=>{var ct=ir(),yt=ci(ct);{var we=Ve=>{gce(Ve,{})},fe=Ve=>{var tt=ir(),Mt=ci(tt);{var mt=Ce=>{xce(Ce,{})};Ki(Mt,Ce=>{i().kind=="export"&&Ce(mt)},!0)}xt(Ve,tt)};Ki(yt,Ve=>{i().kind=="disconnections"?Ve(we):Ve(fe,!1)},!0)}xt(Je,ct)};Ki(et,Je=>{i().kind=="crossings"?Je(ye):Je(Be,!1)},!0)}xt(Ue,ke)};Ki(je,Ue=>{i().kind=="sidewalks"?Ue(Fe):Ue(qe,!1)})}xt(Se,Pe)}),xt(re,oe)},X=re=>{f7(re,{})};Ki(z,re=>{t()?re(Q):re(X,!1)})}xt(V,q)};Ki(G,V=>{ee(c)&&V(N)})}xt(E,D)},$$slots:{default:!0}})}xt(b,S)},$$slots:{top:!0,left:!0,main:!0}}),tn(),o()}y6(Uce,{target:document.getElementById("app")});
